### 要件定義書

#### 1. 概要

本ドキュメントは、トレイアプリケーションの要件を定義するものです。本アプリケーションは、Windowsのシステムトレイに常駐し、設定されたスケジュールに従ってSQLクエリを実行し、その結果をログファイルに記録する機能を提供します。また、簡易Webサーバーを利用してファイルの管理や表示を行います。

#### 2. 目的

このアプリケーションの目的は、以下の通りです。
1. 定期的なデータベース操作の自動化
2. SQLクエリの実行結果のログ記録
3. システムトレイからの簡単な操作
4. 簡易Webサーバーによるファイル管理と表示

#### 3. 用語の定義

- **システムトレイ**: Windowsのタスクバーに常駐するアプリケーションの領域
- **SQLクエリ**: データベースに対する操作を指示する文
- **スケジューラ**: 定期的な操作を自動的に実行する機能
- **Webサーバー**: HTTPプロトコルを使用してクライアントのリクエストに応答するサーバー

#### 4. 機能要件

##### 4.1 トレイアイコンの表示

- **要件ID**: FR001
- **説明**: システムトレイにアイコンを表示し、ユーザーが操作できるようにする。
- **詳細**:
  - アイコンは `icon.ico` を使用する
  - コンテキストメニューを提供する

##### 4.2 コンテキストメニューの提供

- **要件ID**: FR002
- **説明**: トレイアイコンの右クリックで表示されるメニューを提供する。
- **詳細**:
  - メニュー項目:
    - 設定
    - Webサーバーの開始
    - Webサーバーの停止
    - 終了

##### 4.3 スケジューラの管理

- **要件ID**: FR003
- **説明**: スケジュールに従ってSQLクエリを定期的に実行する。
- **詳細**:
  - スケジュールはcron形式で指定
  - SQLファイルを実行し、結果をログに記録
  - エラー発生時のリトライ機能

##### 4.4 ログ管理機能

- **要件ID**: FR004
- **説明**: SQLクエリの実行結果をログファイルに記録し、古いログを定期的に削除する。
- **詳細**:
  - ログの保持期間を設定ファイルで指定
  - エラーログの記録と管理

##### 4.5 簡易Webサーバー機能

- **要件ID**: FR005
- **説明**: 簡易Webサーバーを提供し、ファイルの管理や表示を行う。
- **詳細**:
  - 指定されたディレクトリから静的ファイルを提供
  - Webサーバーの開始/停止機能

##### 4.6 設定ファイルの管理

- **要件ID**: FR006
- **説明**: アプリケーションの動作に必要な設定をファイルで管理する。
- **詳細**:
  - `settings.config`: アプリケーションの基本設定
  - `schedules.csv`: スケジュール設定
  - `log.csv`: ログファイル
  - `SQL/`: SQLファイルを格納するディレクトリ

#### 5. 非機能要件

##### 5.1 パフォーマンス

- **要件ID**: NFR001
- **説明**: アプリケーションは、システムリソースを効率的に使用し、ユーザー操作やSQLクエリの実行において遅延を最小限に抑える。

##### 5.2 セキュリティ

- **要件ID**: NFR002
- **説明**: データベース接続情報やログファイルの内容を保護するための適切なセキュリティ対策を講じる。
- **詳細**:
  - データベース接続情報は暗号化する
  - ログファイルは適切なアクセス権を設定する

##### 5.3 可用性

- **要件ID**: NFR003
- **説明**: アプリケーションは、必要な時に常に利用可能であること。
- **詳細**:
  - スケジューラとWebサーバーの安定した動作
  - アプリケーションの自動再起動機能

#### 6. システム要件

##### 6.1 ハードウェア要件

- CPU: 2.0 GHz以上
- メモリ: 4 GB以上
- ディスク容量: 500 MB以上の空き容量

##### 6.2 ソフトウェア要件

- OS: Windows 7以降
- .NET Framework: 4.6以上
- ODBCドライバー: データベースに応じたODBCドライバー

#### 7. データ要件

##### 7.1 設定ファイル

- `settings.config`
  ```
  LogRetentionDays=7
  SchedulerEnabled=true
  WebServerIPAddress=*
  WebServerPort=8080
  WebServerAutoStart=false
  ```

##### 7.2 スケジュールファイル

- `schedules.csv`
  ```
  Enabled,Name,CronExpression,SqlFile,RetryEnabled,RetryInterval,Description
  true,SampleJob,"0 0 * * *","SQL/sample.sql",true,5,Sample job description
  ```

##### 7.3 ログファイル

- `log.csv`
  ```
  Timestamp,Status,SQLFile,Message
  ```

#### 8. 制約事項

- データベースの接続情報は適切に管理し、漏洩しないようにすること。
- スケジュールの設定はcron形式で指定し、適切に動作するようにすること。

#### 9. 依存関係

- データベースサーバー
- ネットワーク環境

#### 10. テスト要件

##### 10.1 ユニットテスト

- 各クラスとメソッドに対するユニットテストを実施すること。

##### 10.2 結合テスト

- システム全体の動作確認を行う結合テストを実施すること。

##### 10.3 システムテスト

- 実際の運用環境を想定したシステムテストを実施すること。

この要件定義書を基に、詳細な設計と実装を進めます。質問や追加要件があればお知らせください。