<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>A-Frame 物理＋爆発＋モダンUIフルデモ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- ライブラリ -->
  <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-physics-system@v4.2.2/dist/aframe-physics-system.min.js"></script>
  <script src="https://unpkg.com/aframe-particle-system-component@1.1.3/dist/aframe-particle-system-component.min.js"></script>

  <style>
    body { margin: 0; overflow: hidden; background: linear-gradient(135deg, #667eea, #764ba2); }
    a-scene { width: 100vw; height: 100vh; }

    .panel {
      position: fixed; z-index: 10; background: rgba(30,35,50,0.82); border-radius: 14px;
      color: #fff; font-size: 14px; padding: 14px; box-shadow: 0 2px 12px rgba(0,0,0,0.16);
      font-family: 'Segoe UI', 'Inter', sans-serif; user-select: none;
      backdrop-filter: blur(14px);
    }
    .panel .title { color: #f093fb; font-weight: 600; font-size: 15px; }
    .panel .sub { color: #a6b4ee; font-size: 12px; margin-bottom: 8px; }

    .ctrl-panel { left: 16px; top: 18px; width: 250px; display: flex; flex-direction: column; gap: 10px; }
    .ctrl-btn {
      background: linear-gradient(120deg, #667eea, #764ba2);
      border: none; color: #fff; border-radius: 10px;
      padding: 10px 0; font-size: 15px; font-weight: 600; margin-bottom: 4px;
      cursor: pointer; transition: 0.18s; outline: none;
    }
    .ctrl-btn:hover { filter: brightness(1.12); }
    .ctrl-btn.active { background: linear-gradient(90deg,#4ade80,#10b981 90%); color: #222; }
    .ctrl-btn.danger { background: linear-gradient(90deg,#ef4444,#dc2626 90%); }
    .ctrl-btn.warn { background: linear-gradient(90deg,#fbbf24,#f59e0b 90%); color: #222; }

    .perf-panel { right: 22px; top: 22px; min-width: 80px; text-align: right; font-family: monospace; font-size: 13px; }
    .help-panel { right: 20px; bottom: 18px; max-width: 240px; }
    .help-panel .title { color: #f093fb; }
    @media (max-width: 600px) {
      .ctrl-panel, .help-panel { width: 90vw; max-width: 96vw; left: 5vw; }
      .ctrl-panel { top: 7vw; }
      .perf-panel { right: 7vw; top: 3vw; }
      .help-panel { right: 7vw; bottom: 6vw; }
      .ctrl-btn { font-size: 13px; padding: 8px 0; }
    }
  </style>
</head>
<body>

  <!-- コントロールパネル -->
  <div class="panel ctrl-panel" id="ctrl-panel">
    <div class="title">🧊 Playground Controls</div>
    <button class="ctrl-btn" id="snap-btn">Grid Snap: ON</button>
    <button class="ctrl-btn" id="destruct-btn">High Drop: Conditional</button>
    <button class="ctrl-btn" id="fragment-btn">Fragments: Fade</button>
    <button class="ctrl-btn" id="gen-btn">🎲 Random Cube</button>
    <button class="ctrl-btn" id="grid-btn">📋 Grid 25 Cubes</button>
    <button class="ctrl-btn danger" id="destroy-btn">💥 Destroy All</button>
    <button class="ctrl-btn warn" id="reset-btn">🔄 Reset</button>
  </div>

  <!-- パフォーマンス -->
  <div class="panel perf-panel" id="perf-panel">FPS: --<br>Objs: --</div>

  <!-- 操作ヘルプ -->
  <div class="panel help-panel">
    <div class="title">🎮 Controls</div>
    ・ダブルクリック：キューブを掴んでドラッグ<br>
    ・Shift押し：当たり判定無効&キネマティック<br>
    ・グリッドスナップ：ONで1マス単位吸着<br>
    ・高所から落とすと自動破壊<br>
    <div class="sub">
      <b>Tips:</b><br>
      爆発粒子・Fade/残存切替も可能。<br>
      スマホ横向きもOK！
    </div>
  </div>

  <!-- 物理A-Frameシーン -->
  <a-scene
    physics="debug: false; gravity: -9.8"
    state-manager
    double-click-drag
    background="color: #667eea"
    vr-mode-ui="enabled: false"
  >
    <!-- 地面・スロープ・壁 -->
    <a-plane position="0 0 0" rotation="-90 0 0" width="30" height="30" color="#2d3748" static-body></a-plane>
    <a-box position="8 0.25 0" rotation="0 0 -15" width="6" height="0.5" depth="4" color="#4a5568" static-body></a-box>
    <a-box position="-8 0.25 5" rotation="0 45 10" width="4" height="0.5" depth="6" color="#2d3748" static-body></a-box>
    <a-box position="15 2 0" width="0.5" height="4" depth="30" color="#1a202c" static-body></a-box>
    <a-box position="-15 2 0" width="0.5" height="4" depth="30" color="#1a202c" static-body></a-box>
    <a-box position="0 2 15" width="30" height="4" depth="0.5" color="#1a202c" static-body></a-box>
    <a-box position="0 2 -15" width="30" height="4" depth="0.5" color="#1a202c" static-body></a-box>

    <!-- カメラ -->
    <a-entity position="0 8 12">
      <a-camera></a-camera>
    </a-entity>

    <!-- 照明 -->
    <a-light type="ambient" color="#404040" intensity="0.4"></a-light>
    <a-light type="directional" color="#fff" intensity="0.8" position="5 10 2"></a-light>
    <a-light type="point" color="#667eea" intensity="0.5" position="-5 5 5"></a-light>
    <a-light type="point" color="#764ba2" intensity="0.3" position="5 3 -5"></a-light>
  </a-scene>

  <script>
    // ========== 状態管理 ==========  
    AFRAME.registerComponent('state-manager', {
      schema: {
        snap: { default: true },
        destructMode: { default: 1 }, // 0: Always, 1: Conditional, 2: Never
        fragment: { default: 0 }      // 0: Fade, 1: Remain
      },
      init: function () {
        const el = this.el;
        this.snap = true;
        this.destructMode = 1;
        this.fragment = 0;
        el.sceneEl.addEventListener('snap-toggle', (e) => { this.snap = e.detail.snap; });
        el.sceneEl.addEventListener('destruct-toggle', (e) => { this.destructMode = e.detail.mode; });
        el.sceneEl.addEventListener('fragment-toggle', (e) => { this.fragment = e.detail.fragment; });
        el.sceneEl.addEventListener('reset-all', () => {
          this.snap = true; this.destructMode = 1; this.fragment = 0;
        });
      }
    });

    // ========== 爆発＋フラグメント生成 ==========
    function createExplosion(scene, pos, color, fragmentFade) {
      // 爆発粒子
      const explosion = document.createElement('a-entity');
      explosion.setAttribute('position', `${pos.x} ${pos.y} ${pos.z}`);
      explosion.setAttribute('particle-system', `
        preset: dust; color: #FF4500,#FFD700,#FF6347;
        size: 0.13; particleCount: 80; opacity: 0.85;
        velocityValue: 0 6 0; velocitySpread: 3.8 5 3.8
      `);
      scene.appendChild(explosion);
      setTimeout(() => { explosion.remove(); }, 1200);

      // フラグメント
      for(let i=0; i<9; i++) {
        const frag = document.createElement('a-box');
        const ox = (Math.random()-0.5)*0.28, oy = (Math.random()-0.5)*0.28, oz = (Math.random()-0.5)*0.28;
        frag.setAttribute('position', `${pos.x+ox} ${pos.y+oy} ${pos.z+oz}`);
        frag.setAttribute('width', '0.17'); frag.setAttribute('height', '0.17'); frag.setAttribute('depth', '0.17');
        frag.setAttribute('color', color);
        frag.setAttribute('material', 'transparent:true; opacity:1');
        frag.setAttribute('dynamic-body', 'mass:0.1');
        frag.classList.add('fragment');
        frag.addEventListener('body-loaded', () => {
          frag.body.velocity.set(
            (Math.random()-0.5)*3.8, Math.random()*4.8, (Math.random()-0.5)*3.8
          );
          frag.body.angularVelocity.set(
            (Math.random()-0.5)*7, (Math.random()-0.5)*7, (Math.random()-0.5)*7
          );
        });
        if(fragmentFade){
          frag.setAttribute('animation__fade', {
            property: 'material.opacity',
            to: 0, dur: 2200, easing: 'easeOutQuad'
          });
          frag.addEventListener('animationcomplete__fade',()=>frag.remove());
        }
        scene.appendChild(frag);
      }
    }

    // ========== 物理キューブ破壊（落下/衝突） ==========
    AFRAME.registerComponent('breakable', {
      schema: { threshold: { default: 5 } },
      init: function() {
        const el = this.el, scene = el.sceneEl;
        function handleCollide(e) {
          const contact = e.contact;
          const vel = contact.getImpactVelocityAlongNormal ? contact.getImpactVelocityAlongNormal() : 0;
          const st = scene.components['state-manager'];
          const mode = st ? st.destructMode : 1;
          const fade = st ? (st.fragment === 0) : true;
          const high = el.getAttribute('data-high-drop') === 'true';

          if(mode===0 || (mode===1&&(vel>el.components.breakable.data.threshold||high))){
            createExplosion(scene, el.object3D.position, el.getAttribute('color'), fade);
            setTimeout(()=>el.remove(),0);
          }
        }
        if(el.body) el.body.addEventListener('collide', handleCollide);
        else el.addEventListener('body-loaded', ()=>el.body.addEventListener('collide', handleCollide));
      }
    });

    // ========== 高所落下検出 ==========
    AFRAME.registerComponent('free-fall-monitor', {
      schema: { heightThreshold: { default: 4 }, minVelocity: { default: 0.1 } },
      init: function() {
        this.initialY = this.el.object3D.position.y; this.falling = false;
      },
      tick: function() {
        const el = this.el, body = el.body, y = el.object3D.position.y;
        if(!body) return;
        const st = el.sceneEl.components['state-manager'];
        const mode = st ? st.destructMode : 1;
        const vy = body.velocity.y;

        if(mode===0){
          if(!this.falling){ this.falling=true; el.setAttribute('data-high-drop','true'); }
        }else if(mode===1){
          if(y < this.initialY - this.data.heightThreshold && vy < -this.data.minVelocity){
            if(!this.falling){ this.falling=true; el.setAttribute('data-high-drop','true'); }
          }else if(this.falling){
            this.falling=false; el.removeAttribute('data-high-drop');
          }
        }else{
          if(this.falling){ this.falling=false; el.removeAttribute('data-high-drop'); }
        }
      }
    });

    // ========== ダブルクリックドラッグ（スナップ, シフトでノークリップ） ==========
    AFRAME.registerComponent('double-click-drag', {
      init: function() {
        this.dragEl = null;
        this.ray = new THREE.Raycaster(); this.mouse = new THREE.Vector2();
        this.camera = null; this.canvas = null; this.isDragging = false;
        this.shiftPressed = false; this.startY = 0; this.origColor = null;
        this.ind = document.createElement('a-ring');
        this.ind.setAttribute('geometry','radiusInner:0.5;radiusOuter:0.6');
        this.ind.setAttribute('material','color:#4ade80;opacity:0.5;transparent:true');
        this.ind.setAttribute('visible',false);
        this.el.sceneEl.appendChild(this.ind);

        const keyD = e=>{if(e.key==='Shift')this.shiftPressed=true;};
        const keyU = e=>{if(e.key==='Shift')this.shiftPressed=false;};
        document.addEventListener('keydown',keyD); document.addEventListener('keyup',keyU);

        this.el.sceneEl.addEventListener('loaded',()=>{
          this.camera = this.el.sceneEl.camera;
          this.canvas = this.el.sceneEl.canvas;
          this.canvas.addEventListener('dblclick',this.onDblClick.bind(this));
          this.canvas.addEventListener('mousemove',this.onMouseMove.bind(this));
          this.canvas.addEventListener('mouseup',this.onMouseUp.bind(this));
        });
      },
      onDblClick: function(e){
        const rect=this.canvas.getBoundingClientRect();
        this.mouse.x=((e.clientX-rect.left)/rect.width)*2-1;
        this.mouse.y=-((e.clientY-rect.top)/rect.height)*2+1;
        this.ray.setFromCamera(this.mouse,this.camera);

        const targets=[];
        this.el.sceneEl.object3D.traverse(obj=>{
          if(obj.el && obj.el.components['dynamic-body']) targets.push(obj);
        });
        const inters=this.ray.intersectObjects(targets,true);
        if(!inters.length)return;
        const el=inters[0].object.el;
        if(!el||!el.components['dynamic-body'])return;
        this.dragEl=el; this.isDragging=true; this.startY=el.object3D.position.y;
        this.origColor=el.getAttribute('color');
        el.setAttribute('color','#fbbf24');
        if(el.body) el.body.sleep();
      },
      onMouseMove:function(e){
        if(!this.isDragging||!this.dragEl)return;
        const rect=this.canvas.getBoundingClientRect();
        this.mouse.x=((e.clientX-rect.left)/rect.width)*2-1;
        this.mouse.y=-((e.clientY-rect.top)/rect.height)*2+1;
        this.ray.setFromCamera(this.mouse,this.camera);
        const pos=this.dragEl.object3D.position.clone();
        const plane=new THREE.Plane(new THREE.Vector3(0,1,0),-pos.y);
        const pnt=new THREE.Vector3();
        if(this.ray.ray.intersectPlane(plane,pnt)){
          const st = this.el.sceneEl.components['state-manager'];
          if(st && st.snap){ pnt.x=Math.round(pnt.x); pnt.z=Math.round(pnt.z); }
          if(this.dragEl.body){
            this.dragEl.body.position.set(pnt.x,pos.y,pnt.z);
            this.dragEl.body.velocity.set(0,0,0); this.dragEl.body.angularVelocity.set(0,0,0);
          }
          this.ind.setAttribute('position',`${pnt.x} ${pos.y} ${pnt.z}`); this.ind.setAttribute('visible',true);
        }
      },
      onMouseUp:function(){
        if(!this.isDragging||!this.dragEl)return;
        if(this.dragEl.body) this.dragEl.body.wakeUp();
        this.dragEl.setAttribute('color',this.origColor||'#4CC3D9');
        this.ind.setAttribute('visible',false);
        this.dragEl = null; this.isDragging = false;
      }
    });

    // ========== UIバインド & 各種アクション ==========
    window.addEventListener('DOMContentLoaded',()=>{
      const scene=document.querySelector('a-scene');
      let snap=true, destructMode=1, fragmentMode=0;

      // ---- UI参照
      const snapBtn = document.getElementById('snap-btn');
      const destructBtn = document.getElementById('destruct-btn');
      const fragmentBtn = document.getElementById('fragment-btn');
      const genBtn = document.getElementById('gen-btn');
      const gridBtn = document.getElementById('grid-btn');
      const destroyBtn = document.getElementById('destroy-btn');
      const resetBtn = document.getElementById('reset-btn');
      const perfPanel = document.getElementById('perf-panel');

      // ---- モード切替
      snapBtn.onclick = ()=>{
        snap = !snap;
        snapBtn.textContent = 'Grid Snap: ' + (snap?'ON':'OFF');
        scene.emit('snap-toggle',{snap});
      };
      destructBtn.onclick=()=>{
        destructMode = (destructMode+1)%3;
        destructBtn.textContent = 'High Drop: ' +
          (destructMode===0?'Always':destructMode===1?'Conditional':'Never');
        scene.emit('destruct-toggle',{mode:destructMode});
      };
      fragmentBtn.onclick=()=>{
        fragmentMode=(fragmentMode+1)%2;
        fragmentBtn.textContent = 'Fragments: ' + (fragmentMode===0?'Fade':'Remain');
        scene.emit('fragment-toggle',{fragment:fragmentMode});
      };

      // ---- ランダム生成
      genBtn.onclick=()=>{ spawnCube(Math.random()*14-7,Math.random()*6+4,Math.random()*10-5); };

      // ---- グリッド生成
      gridBtn.onclick=()=>{ clearCubes(); genGrid(5,5,2); };

      // ---- 全破壊
      destroyBtn.onclick=()=>{
        document.querySelectorAll('.cube').forEach(cube=>{
          createExplosion(scene,cube.object3D.position,cube.getAttribute('color'),fragmentMode===0);
          setTimeout(()=>cube.remove(),0);
        });
      };

      // ---- リセット
      resetBtn.onclick=()=>{
        clearCubes();
        document.querySelectorAll('.fragment').forEach(f=>f.remove());
        snapBtn.textContent='Grid Snap: ON'; destructBtn.textContent='High Drop: Conditional';
        fragmentBtn.textContent='Fragments: Fade';
        snap=true;destructMode=1;fragmentMode=0;
        scene.emit('reset-all');
        genGrid(5,5,2);
      };

      // ---- 初回グリッド
      genGrid(5,5,2);

      // ---- パフォーマンス表示
      let fps=0,last=performance.now(),frames=0;
      setInterval(()=>{
        const now=performance.now();
        frames++; if(now-last>=700){
          fps=Math.round(frames*1000/(now-last));
          last=now;frames=0;
          const cubes=document.querySelectorAll('.cube').length;
          const frags=document.querySelectorAll('.fragment').length;
          perfPanel.innerHTML=`FPS: ${fps}<br>Objs: ${cubes}c / ${frags}f`;
        }
      },200);

      // ========== キューブ生成 ==========
      function spawnCube(x,y,z){
        const colors = ['#4CC3D9','#EF2D5E','#7BC8A4','#FFC65D','#FF6347','#32CD32','#8A2BE2','#FFD700','#00CED1'];
        const box = document.createElement('a-box');
        box.setAttribute('position',`${x} ${y} ${z}`);
        box.setAttribute('depth','1');box.setAttribute('height','1');box.setAttribute('width','1');
        box.setAttribute('color',colors[Math.floor(Math.random()*colors.length)]);
        box.setAttribute('dynamic-body','');
        box.setAttribute('breakable','threshold:5');
        box.setAttribute('free-fall-monitor','heightThreshold:4;minVelocity:0.1');
        box.classList.add('cube');
        box.setAttribute('id',`cube-${Date.now()}-${Math.floor(Math.random()*10000)}`);
        scene.appendChild(box);
      }

      // ========== グリッド生成 ==========
      function genGrid(w,h,sp){
        for(let i=0;i<w;i++)for(let j=0;j<h;j++)
          spawnCube((i-w/2+0.5)*sp+Math.random()*0.03,(j-h/2+1.5)*sp,Math.random()*0.03);
      }
      // ========== キューブ消去 ==========
      function clearCubes(){
        document.querySelectorAll('.cube').forEach(cube=>cube.remove());
      }
    });
  </script>
</body>
</html>
