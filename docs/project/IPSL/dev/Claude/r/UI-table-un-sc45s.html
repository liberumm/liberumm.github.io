<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover"/>
<title>Simple Data Table (Demo)</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap"/>
<link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons"/>
<style>
  html,body,#root{height:100%;margin:0}
  .d3-chart text { font-size: 10px; }
  @media print {
    body * { visibility: hidden !important; }
    .print-area, .print-area * { visibility: visible !important; }
    .print-area { position: absolute; left: 0; top: 0; width: 100%; }
  }
</style>
</head>
<body>
  <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.development.js" crossorigin></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.development.js" crossorigin></script>
  <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.23.8/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mui/material@5.15.3/umd/material-ui.production.min.js" crossorigin></script>
  <script src="https://cdn.jsdelivr.net/npm/d3@7.9.0/dist/d3.min.js"></script>

  <div id="root"></div>

  <script type="text/babel">
    const {
      AppBar,Toolbar,Typography,Box,Container,TextField,InputAdornment,Button,Stack,
      Paper,createTheme,ThemeProvider,CssBaseline,Table,TableHead,TableRow,TableCell,
      TableBody,TableContainer,TableSortLabel,Checkbox,Dialog,DialogTitle,DialogContent,
      DialogActions,Chip,Alert,Snackbar,List,ListItem,Divider,IconButton,
      Radio,RadioGroup,FormControlLabel,Badge,Tab,Tabs,Select,MenuItem,
      Accordion,AccordionSummary,AccordionDetails,Popover,Tooltip
    } = MaterialUI;

    // ---------- 共通定義 ----------
    const COLUMNS = [
      { key:'select', label:'', kind:'checkbox', width:44 },
      { key:'no', label:'No', kind:'number', width:72, numeric:true },
      { key:'yearWeek', label:'年度週', kind:'text', width:100 },
      { key:'store', label:'店舗', kind:'text', width:120 },
      { key:'dept', label:'部門', kind:'text', width:120 },
      { key:'name', label:'品名', kind:'text', width:220 },
      { key:'code', label:'コード', kind:'text', width:120 },
      { key:'corner', label:'コーナー', kind:'text', width:120 },
      { key:'line', label:'ライン', kind:'text', width:120 },
      { key:'category', label:'カテゴリ', kind:'text', width:120 },
      { key:'partner', label:'取引先', kind:'text', width:140 },
      { key:'sellPrice', label:'売価', kind:'number', width:110, numeric:true },
      { key:'costPrice', label:'原価', kind:'number', width:110, numeric:true },
      { key:'totalSales', label:'累計販売数', kind:'number', width:120, numeric:true },
      { key:'sales28d', label:'販売数(28日)', kind:'number', width:120, numeric:true },
      { key:'sales7d', label:'販売数(7日)', kind:'number', width:120, numeric:true },
      { key:'stockQty', label:'在庫数', kind:'number', width:110, numeric:true },
      { key:'stockQty7d', label:'在庫数(7日前)', kind:'number', width:120, numeric:true },
      { key:'stockQty28d', label:'在庫数(28日前)', kind:'number', width:130, numeric:true },
      { key:'totalStockValue', label:'合計在庫金額', kind:'number', width:140, numeric:true, calc:r=>(r.sellPrice??0)*(r.stockQty??0) },
      { key:'saleStartDate', label:'販売開始日', kind:'date', width:120 },
      { key:'saleEndDate', label:'販売終了日', kind:'date', width:120 }
    ];

    const createMockData = (n=20000) => {
      const stores = Array.from({ length: 40 }, (_, i) => `店舗${String(i + 1).padStart(2, '0')}`);
      const depts = ['食品','日用品','衣料','家電','雑貨'];
      const corners = ['菓子','飲料','惣菜','精肉','鮮魚','日配','日用品'];
      const lines = ['和菓子','洋菓子','スナック','コーヒー','お茶','弁当','サラダ'];
      const categories = ['食品','日用品','衣料','家電'];
      const partners = ['Acme商事','Globex物産','Soylent食品','Initech','Umbrella','Stark'];
      const pick = arr => arr[Math.floor(Math.random()*arr.length)];
      const toDateStr = d => d.toISOString().slice(0,10);
      const productCount = Math.floor(n / stores.length);

      const products = Array.from({length: productCount}, (_, i) => {
        const id = i + 1;
        const sellPrice = Math.floor(Math.random()*2500)+100;
        const costPrice = Math.floor(sellPrice*(0.5+Math.random()*0.3));
        return {
          productId: id,
          name: `品名${id}`,
          code: `P${String(id).padStart(6,'0')}`,
          dept: pick(depts),
          corner: pick(corners),
          line: pick(lines),
          category: pick(categories),
          partner: pick(partners),
          sellPrice,
          costPrice,
          saleStartDate: toDateStr(new Date(Date.now()-Math.random()*400*864e5)),
          saleEndDate: Math.random()>0.3 ? toDateStr(new Date(Date.now()+Math.random()*200*864e5)) : ''
        };
      });

      const data = [];
      let rowId = 1;
      products.forEach(product => {
        const weekCount = 5;
        const weekIndex = Math.floor((rowId-1) / (n/weekCount));
        const targetWeek = 40 + weekIndex;
        stores.forEach(store => {
          const stockQty = Math.floor(Math.random()*500);
          const sales7d = Math.floor(Math.random()*120);
          const sales28d = sales7d + Math.floor(Math.random()*300);
          const totalSales = sales28d + Math.floor(Math.random()*5000);
          data.push({
            id: rowId++,
            no: rowId - 1,
            yearWeek: `2025-W${String(targetWeek).padStart(2,'0')}`,
            store,
            ...product,
            totalSales,
            sales28d,
            sales7d,
            stockQty,
            stockQty7d: stockQty + Math.floor(Math.random()*100)-50,
            stockQty28d: stockQty + Math.floor(Math.random()*150)-75
          });
        });
      });
      return data;
    };

    // ---------- ユーティリティ ----------
    const useWindowSize = () => {
      const [size, setSize] = React.useState({w: window.innerWidth, h: window.innerHeight});
      React.useEffect(() => {
        const onResize = () => setSize({w: window.innerWidth, h: window.innerHeight});
        window.addEventListener('resize', onResize);
        return () => window.removeEventListener('resize', onResize);
      }, []);
      return size;
    };
    const plusDaysStr = (d=3) => { const t = new Date(); t.setDate(t.getDate()+d); return t.toISOString().slice(0,10); };

    // ========= D3 グループ棒（キー可変 / 販売xx日昇順 & クリックでポップアップ） =========
    const D3GroupedBar = ({ data, selectedStore, height=240, margin={top:24,right:12,bottom:46,left:40}, title, onBarClick, seriesKeys=['sales28d','stockQty'], seriesLabels={sales28d:'販売28日', stockQty:'在庫数'} }) => {
      const ref = React.useRef(null);
      React.useEffect(() => {
        const el = ref.current;
        if (!el) return;
        el.innerHTML = '';

        // 並べ替え基準：seriesKeysのうち「sales28d」または「sales7d」があればそれで昇順
        const sortKey = seriesKeys.includes('sales28d') ? 'sales28d' : (seriesKeys.includes('sales7d') ? 'sales7d' : seriesKeys[0]);
        const ordered = [...data].sort((a,b)=> (a[sortKey]||0)-(b[sortKey]||0));

        const width = el.clientWidth || 800;

        const x0 = d3.scaleBand().domain(ordered.map(d=>d.store)).range([margin.left, width - margin.right]).paddingInner(0.2);
        const x1 = d3.scaleBand().domain(seriesKeys).range([0, x0.bandwidth()]).padding(0.1);
        const y = d3.scaleLinear()
          .domain([0, d3.max(ordered, d => d3.max(seriesKeys, k => d[k]||0)) || 1]).nice()
          .range([height - margin.bottom, margin.top]);

        const baseColors = d3.schemeTableau10;
        const color = d3.scaleOrdinal().domain(seriesKeys).range(baseColors);

        const svg = d3.select(el).append('svg').attr('width', width).attr('height', height).classed('d3-chart', true);

        if (title) {
          svg.append('text').attr('x', margin.left).attr('y', 16).attr('fill', 'currentColor').attr('font-weight', 600).text(title);
        }

        const xAxis = g => g
          .attr('transform', `translate(0,${height - margin.bottom})`)
          .call(d3.axisBottom(x0).tickSizeOuter(0))
          .selectAll("text").attr("transform","rotate(-45)").style("text-anchor","end");

        const yAxis = g => g
          .attr('transform', `translate(${margin.left},0)`)
          .call(d3.axisLeft(y).ticks(5))
          .call(g=>g.selectAll(".domain").remove())
          .call(g=>g.append('text').attr('x', 0).attr('y', margin.top - 12).attr('fill','currentColor').attr('text-anchor','start').text('数量'));

        svg.append('g').call(xAxis);
        svg.append('g').call(yAxis);

        const storesG = svg.append('g').selectAll('g.store')
          .data(ordered).enter().append('g')
          .attr('class','store')
          .attr('transform', d => `translate(${x0(d.store)},0)`);

        storesG.selectAll('rect')
          .data(d => seriesKeys.map(key => ({key, store:d.store, values:d, value:d[key]||0})))
          .enter().append('rect')
          .attr('x', d => x1(d.key))
          .attr('y', d => y(d.value))
          .attr('width', x1.bandwidth())
          .attr('height', d => Math.max(0, y(0) - y(d.value)))
          .attr('fill', d => {
            const c = color(d.key);
            const isSel = d.store === selectedStore;
            return isSel ? c : d3.color(c).copy({opacity:0.35});
          })
          .attr('stroke', d => d.store === selectedStore ? '#333' : 'none')
          .attr('stroke-width', d => d.store === selectedStore ? 1.5 : 0)
          .style('cursor','pointer')
          .on('click', function(evt, d) {
            if (onBarClick) {
              const bbox = this.getBoundingClientRect();
              onBarClick({
                store: d.store,
                sales28d: d.values.sales28d || 0,
                sales7d: d.values.sales7d || 0,
                stockQty: d.values.stockQty || 0,
                metric: d.key,
                anchor: { x: bbox.x + bbox.width/2, y: bbox.y }
              });
            }
          });

        const selIdx = ordered.findIndex(d=>d.store===selectedStore);
        if (selIdx >= 0) {
          const selX = x0(ordered[selIdx].store) + x0.bandwidth()/2;
          svg.append('line').attr('x1', selX).attr('x2', selX)
            .attr('y1', margin.top).attr('y2', height - margin.bottom)
            .attr('stroke','#666').attr('stroke-dasharray','3,3').attr('opacity',0.6);
        }

        const legend = svg.append('g').attr('transform', `translate(${width - margin.right - 180}, ${margin.top})`);
        seriesKeys.forEach((k,i)=>{
          const row = legend.append('g').attr('transform',`translate(0, ${i*16})`);
          row.append('rect').attr('x',0).attr('y',-9).attr('width',12).attr('height',12).attr('fill',color(k));
          row.append('text').attr('x',16).attr('y',0).attr('dominant-baseline','central').text(seriesLabels[k] || k);
        });
      }, [data, selectedStore, height, JSON.stringify(margin), title, onBarClick, JSON.stringify(seriesKeys), JSON.stringify(seriesLabels)]);

      return <Box ref={ref} sx={{width:'100%'}} />;
    };

    function App() {
      const [dark, setDark] = React.useState(false);
      const theme = React.useMemo(() => createTheme({palette:{mode:dark?'dark':'light'}}), [dark]);

      // 上位タブ: 0=商品リスト（店舗）, 1=要望リスト（店舗）, 2=商品リスト（商品部）, 3=要望リスト（商品部）
      const [page, setPage] = React.useState(0);

      // データ & 表示
      const [rows, setRows] = React.useState(() => createMockData(20000));
      const [search, setSearch] = React.useState('');
      const [orderBy, setOrderBy] = React.useState('no');
      const [order, setOrder] = React.useState('asc');
      const [selected, setSelected] = React.useState(new Set());
      const [settingsOpen, setSettingsOpen] = React.useState(false);
      const [dataCount, setDataCount] = React.useState(20000);

      // 単店/自店
      const [currentStore, setCurrentStore] = React.useState('店舗01');

      // サブタブ（商品リスト）
      const [storeListTab, setStoreListTab] = React.useState(0);
      const [mdListTab, setMdListTab] = React.useState(2);

      // 要望/依頼（共通）
      const [orderModalOpen, setOrderModalOpen] = React.useState(false);
      const [orderNote, setOrderNote] = React.useState('');
      const [snackbar, setSnackbar] = React.useState({open: false, message: '', severity: 'success'});
      const [orderActions, setOrderActions] = React.useState({});
      const [requestList, setRequestList] = React.useState([]);
      const [rejectDialogState, setRejectDialogState] = React.useState({open:false, id:null, comment:''});
      const [orderMode, setOrderMode] = React.useState('store_to_md');
      const [modalTab, setModalTab] = React.useState(0);

      // 要望リストの表示タブ（フィルタ）
      const [reqFilterStore, setReqFilterStore] = React.useState(0);
      const [reqFilterMd, setReqFilterMd] = React.useState(0);

      // グラフのポップアップ
      const [graphPopup, setGraphPopup] = React.useState({open:false, anchor:{x:0,y:0}, data:null});

      // テーブル高さ
      const win = useWindowSize();
      const tableHeight = React.useMemo(() => {
        const searchBarHeight = (page===1 || page===3) ? 0 : 92;
        const paddingEtc = 48 + 32 + 16;
        return Math.max(300, win.h - (searchBarHeight + paddingEtc));
      }, [win.h, page]);

      // 仮想スクロール
      const containerRef = React.useRef(null);
      const [scrollTop, setScrollTop] = React.useState(0);
      const rowHeight = 33; const overscan = 10;

      const toggleRow = (id) => {
        setSelected(s => {
          const n = new Set(s);
          if (n.has(id)) n.delete(id); else n.add(id);
          return n;
        });
      };
      const toggleAll = (list) => {
        setSelected(s => {
          const n = new Set(s);
          const ids = list.map(r=>r.id).filter(id => typeof id === 'number'); // 集計行は除外
          const allOn = ids.every(id => n.has(id));
          ids.forEach(id => { if (allOn) n.delete(id); else n.add(id); });
          return n;
        });
      };

      // データ再生成
      const regenerateData = () => {
        setRows(createMockData(dataCount));
        setSelected(new Set());
        setSettingsOpen(false);
      };

      // ====== モーダル ======
      const openOrderModal = (mode) => {
        // 選択された「実体行（数値id）」のみを対象にする
        const hasRealSelection = rows.some(r => selected.has(r.id));
        if (!hasRealSelection) {
          setSnackbar({open: true, message: '商品（店舗別行）を選択してください（集計行は選択不可）', severity: 'warning'});
          return;
        }
        setOrderMode(mode);
        setOrderActions({});
        setOrderNote('');
        setModalTab(0);
        setOrderModalOpen(true);
      };
      const setAction = (productId, store, action, details = {}) => {
        const key = `${productId}_${store}`;
        setOrderActions(prev => ({
          ...prev,
          [key]: { action, productId: Number(productId), store, date: details.date || prev[key]?.date || plusDaysStr(3), ...details }
        }));
      };
      const submitOrder = () => {
        const requests = Object.values(orderActions).map(action => {
          const product = rows.find(r => r.productId === Number(action.productId) && r.store === action.store);
          return {
            id: `REQ_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
            timestamp: new Date().toISOString(),
            status: 'pending',
            direction: orderMode,
            product,
            action: action.action,
            quantity: action.quantity || 0,
            fromStore: action.fromStore,
            toStore: action.toStore,
            discountRate: action.discountRate,
            date: action.date || plusDaysStr(3),
            note: action.note || orderNote,
            decisionComment: ''
          };
        });

        setRequestList(prev => [...prev, ...requests]);
        setSnackbar({ open: true, message: (orderMode==='store_to_md' ? '要望を送信しました（店舗→商品部）' : '依頼を送信しました（商品部→店舗）'), severity: 'success' });
        setOrderModalOpen(false);
        setSelected(new Set());
        setPage(orderMode==='store_to_md' ? 3 : 1);
      };

      const approveRequest = (requestId) => {
        setRequestList(prev => prev.map(req => req.id === requestId ? { ...req, status: 'approved' } : req));
        setSnackbar({open: true, message: '処理しました', severity: 'success'});
      };
      const openReject = (id) => setRejectDialogState({open:true, id, comment:''});
      const doReject = () => {
        const {id, comment} = rejectDialogState;
        setRequestList(prev => prev.map(req => req.id === id ? { ...req, status: 'rejected', decisionComment: comment || '(コメントなし)'} : req));
        setRejectDialogState({open:false, id:null, comment:''});
        setSnackbar({open: true, message: '差戻しました', severity: 'warning'});
      };

      // 選択商品の全店舗
      const selectedProductsAllStores = React.useMemo(() => {
        const productIds = new Set();
        rows.filter(r => selected.has(r.id)).forEach(r => productIds.add(r.productId));
        const grouped = {};
        productIds.forEach(productId => {
          const allStores = rows.filter(r => r.productId === productId);
          if (allStores.length > 0) grouped[productId] = { product: allStores[0], stores: allStores };
        });
        return grouped;
      }, [rows, selected]);

      // 推奨アクション
      const getRecommendedAction = (currentStoreRow, allStores) => {
        const current = allStores.find(s => s.store === currentStoreRow.store);
        if (!current) return null;
        const weeklyDemand = current.sales7d || 0;
        const currentStock = current.stockQty || 0;
        const daysOfStock = weeklyDemand > 0 ? (currentStock / weeklyDemand) * 7 : 999;

        if (daysOfStock < 14) {
          const surplus = allStores.filter(s => {
            const otherDemand = s.sales7d || 0;
            const otherStock = s.stockQty || 0;
            const otherDays = otherDemand > 0 ? (otherStock / otherDemand) * 7 : 999;
            return s.store !== currentStoreRow.store && otherDays > 21 && otherStock > 50;
          });
          if (surplus.length > 0) return { action: 'transfer_in', from: surplus[0].store, reason: '他店に余剰在庫あり' };
          return { action: 'order', quantity: Math.ceil(weeklyDemand * 2 - currentStock), reason: '在庫不足' };
        }

        if (daysOfStock > 28 && weeklyDemand < 5) {
          const needStores = allStores.filter(s => {
            const otherDemand = s.sales7d || 0;
            const otherStock = s.stockQty || 0;
            const otherDays = otherDemand > 0 ? (otherStock / otherDemand) * 7 : 999;
            return s.store !== currentStoreRow.store && otherDays < 14 && otherDemand > 10;
          });
          if (needStores.length > 0) return { action: 'transfer_out', to: needStores[0].store, reason: '他店で需要あり' };
          return { action: 'discount', rate: 20, reason: '販売鈍化・在庫過多' };
        }
        return null;
      };

      // ====== フィルタ & ソート ======
      const baseFiltered = React.useMemo(() => {
        if (!search) return rows;
        const s = search.toLowerCase();
        return rows.filter(r =>
          [r.name, r.code, r.partner, r.store, r.dept, r.corner, r.line, r.category]
            .some(v => String(v||'').toLowerCase().includes(s))
        );
      }, [rows, search]);

      const aggregateByProduct = (list) => {
        const map = new Map();
        for (const r of list) {
          const key = r.productId;
          const agg = map.get(key) || { ...r, store: '全店合計', id:`agg_${key}`, no:r.no };
          agg.totalSales = (agg.totalSales||0) + (r.totalSales||0);
          agg.sales28d   = (agg.sales28d||0)   + (r.sales28d||0);
          agg.sales7d    = (agg.sales7d||0)    + (r.sales7d||0);
          agg.stockQty   = (agg.stockQty||0)   + (r.stockQty||0);
          agg.stockQty7d = (agg.stockQty7d||0) + (r.stockQty7d||0);
          agg.stockQty28d= (agg.stockQty28d||0)+ (r.stockQty28d||0);
          map.set(key, agg);
        }
        return Array.from(map.values());
      };

      const pageScopedRows = React.useMemo(() => {
        if (page === 0) { // 商品リスト（店舗）
          if (storeListTab === 0) return baseFiltered.filter(r => r.store === currentStore);
          if (storeListTab === 1) return baseFiltered;
          if (storeListTab === 2) return aggregateByProduct(baseFiltered);
        }
        if (page === 2) { // 商品リスト（商品部）
          if (mdListTab === 0) return baseFiltered.filter(r => r.store === currentStore);
          if (mdListTab === 1) return baseFiltered;
          if (mdListTab === 2) return aggregateByProduct(baseFiltered);
        }
        return baseFiltered;
      }, [baseFiltered, page, storeListTab, mdListTab, currentStore]);

      const sorted = React.useMemo(() => {
        const col = COLUMNS.find(c => c.key === orderBy);
        if (!col) return pageScopedRows;
        return [...pageScopedRows].sort((a, b) => {
          let va, vb;
          if (col.calc) { va = col.calc(a); vb = col.calc(b); }
          else { va = a[col.key]; vb = b[col.key]; }
          if (va == null && vb == null) return 0;
          if (va == null) return order === 'asc' ? -1 : 1;
          if (vb == null) return order === 'asc' ? 1 : -1;
          if (col.numeric) return (Number(va) - Number(vb)) * (order === 'asc' ? 1 : -1);
          return String(va).localeCompare(String(vb), 'ja') * (order === 'asc' ? 1 : -1);
        });
      }, [pageScopedRows, orderBy, order]);

      // 仮想スクロール
      const [startIndex, endIndex, topPad, bottomPad] = React.useMemo(() => {
        const startIndex = Math.max(0, Math.floor(scrollTop / rowHeight) - overscan);
        const endIndex = Math.min(sorted.length, Math.ceil((scrollTop + tableHeight) / rowHeight) + overscan);
        const topPad = startIndex * rowHeight;
        const bottomPad = (sorted.length - endIndex) * rowHeight;
        return [startIndex, endIndex, topPad, bottomPad];
      }, [scrollTop, sorted.length, tableHeight]);
      const displayData = React.useMemo(() => sorted.slice(startIndex, endIndex), [sorted, startIndex, endIndex]);
      const handleScroll = (e) => setScrollTop(e.target.scrollTop);
      const handleSort = (key) => { if (orderBy === key) setOrder(order === 'asc' ? 'desc' : 'asc'); else { setOrderBy(key); setOrder('asc'); } };

      // ====== 要望テーブル ======
      const DirectionChip = ({dir}) => (
        <Chip label={dir==='store_to_md' ? '店舗→商品部' : '商品部→店舗'} size="small"
          color={dir==='store_to_md' ? 'info' : 'secondary'} sx={{height:18,fontSize:'0.7rem'}} />
      );

      const RequestTable = ({ list, viewer, className }) => {
        const renderActionChip = (req) => (
          <Chip
            label={
              req.action === 'order' ? (req.direction==='md_to_store' ? '発注指示' : '発注') :
              req.action === 'transfer_in' ? (req.direction==='md_to_store' ? '移管受入指示' : '移管受入') :
              req.action === 'transfer_out' ? (req.direction==='md_to_store' ? '移管払出指示' : '移管払出') :
              (req.direction==='md_to_store' ? '値下げ指示' : '値下げ')
            }
            size="small"
            color={req.action === 'order' ? 'info' : (req.action === 'discount' ? 'error' : 'warning')}
            sx={{height:18,fontSize:'0.7rem'}}
          />
        );
        const renderStatusChip = (req) => (
          <Chip
            label={req.status === 'pending' ? '未対応' : (req.status === 'approved' ? '完了/承認' : '差戻')}
            size="small"
            color={req.status === 'pending' ? 'warning' : (req.status === 'approved' ? 'success' : 'error')}
            sx={{height:18,fontSize:'0.7rem'}}
          />
        );

        const canOperate = (req) => {
          if (req.status !== 'pending') return false;
          if (viewer === 'store' && req.direction === 'md_to_store') return true;
          if (viewer === 'md' && req.direction === 'store_to_md') return true;
          return false;
        };

        return (
          <Table size="small" stickyHeader className={className}>
            <TableHead>
              <TableRow sx={{'& th':{bgcolor:'action.hover',fontWeight:600,fontSize:'0.8rem'}}}>
                <TableCell>方向</TableCell>
                <TableCell>日時</TableCell>
                <TableCell>日付</TableCell>
                <TableCell>商品</TableCell>
                <TableCell>店舗</TableCell>
                <TableCell>内容</TableCell>
                <TableCell align="right">数量/率</TableCell>
                <TableCell>ステータス</TableCell>
                <TableCell>備考 / 差戻コメント</TableCell>
                <TableCell width="200">操作</TableCell>
              </TableRow>
            </TableHead>
            <TableBody>
              {list.map(req => (
                <TableRow key={req.id}
                  sx={{bgcolor: req.status==='approved'?'success.light':(req.status==='rejected'?'error.light':'inherit')}}>
                  <TableCell><DirectionChip dir={req.direction || 'store_to_md'} /></TableCell>
                  <TableCell>{new Date(req.timestamp).toLocaleString('ja-JP')}</TableCell>
                  <TableCell>{req.date || '-'}</TableCell>
                  <TableCell>
                    <Stack spacing={0.5}>
                      <Typography variant="body2" sx={{fontWeight:600}}>{req.product?.name ?? '-'}</Typography>
                      <Typography variant="caption" color="text.secondary">{req.product?.code ?? '-'}</Typography>
                    </Stack>
                  </TableCell>
                  <TableCell>{req.product?.store ?? '-'}</TableCell>
                  <TableCell>{renderActionChip(req)}</TableCell>
                  <TableCell align="right">
                    {req.action === 'order' && `${req.quantity} 個`}
                    {req.action === 'transfer_in' && `${req.fromStore || '-'} → ${req.product?.store || '-'} : ${req.quantity} 個`}
                    {req.action === 'transfer_out' && `${req.product?.store || '-'} → ${req.toStore || '-'} : ${req.quantity} 個`}
                    {req.action === 'discount' && `${req.discountRate ?? 0} %`}
                  </TableCell>
                  <TableCell>{renderStatusChip(req)}</TableCell>
                  <TableCell>
                    {req.note || '-'}
                    {req.status==='rejected' && req.decisionComment && (
                      <Typography variant="caption" sx={{display:'block', mt:0.5, fontStyle:'italic'}}>差戻コメント: {req.decisionComment}</Typography>
                    )}
                  </TableCell>
                  <TableCell>
                    {canOperate(req) ? (
                      <Stack direction="row" spacing={1}>
                        <Button size="small" variant="contained" color="success"
                          onClick={() => approveRequest(req.id)}
                          startIcon={<span className="material-icons" style={{fontSize:16}}>check</span>}>
                          完了
                        </Button>
                        <Button size="small" variant="outlined" color="error"
                          onClick={() => openReject(req.id)}
                          startIcon={<span className="material-icons" style={{fontSize:16}}>close</span>}>
                          差戻
                        </Button>
                      </Stack>
                    ) : <Typography variant="caption" color="text.secondary">—</Typography>}
                  </TableCell>
                </TableRow>
              ))}
              {list.length === 0 && (
                <TableRow>
                  <TableCell colSpan={10} align="center">
                    <Typography variant="body2" color="text.secondary">対象の要望／依頼はありません</Typography>
                  </TableCell>
                </TableRow>
              )}
            </TableBody>
          </Table>
        );
      };

      // ====== レイアウト ======
      return (
        <ThemeProvider theme={theme}>
          <CssBaseline/>

          <AppBar position="sticky" elevation={1}>
            <Toolbar variant="dense" sx={{minHeight:48}}>
              <Typography variant="h6" sx={{fontSize:16, mr:2}}>シンプルデータテーブル（デモ）</Typography>
              <Tabs value={page} onChange={(_,v)=>setPage(v)} textColor="inherit" indicatorColor="secondary" sx={{flex:1}}>
                <Tab label="商品リスト（店舗）" />
                <Tab label={
                  <Stack direction="row" spacing={1} alignItems="center">
                    <span>要望リスト（店舗）</span>
                    <Badge badgeContent={requestList.filter(r=>r.status==='pending' && (r.direction==='md_to_store' || r.direction==='store_to_md')).length} color="error" />
                  </Stack>
                } />
                <Tab label="商品リスト（商品部）" />
                <Tab label={
                  <Stack direction="row" spacing={1} alignItems="center">
                    <span>要望リスト（商品部）</span>
                    <Badge badgeContent={requestList.filter(r=>r.status==='pending' && r.direction==='store_to_md').length} color="error" />
                  </Stack>
                } />
              </Tabs>
              <Button color="inherit" size="small" onClick={() => setSettingsOpen(true)}
                startIcon={<span className="material-icons">settings</span>} sx={{ml:1}}>設定</Button>
              <Button color="inherit" size="small" onClick={() => setDark(v => !v)}
                startIcon={<span className="material-icons">{dark?'light_mode':'dark_mode'}</span>} sx={{ml:1}}>テーマ</Button>
            </Toolbar>
          </AppBar>

          <Container maxWidth="xl" sx={{py:2}}>
            {/* 商品リスト（店舗） */}
            {page === 0 && (
              <>
                <Paper sx={{p:2, mb:2}}>
                  <Stack direction="row" spacing={2} alignItems="center" flexWrap="wrap">
                    <TextField size="small" sx={{flex:1,minWidth:300}} placeholder="品名・コード・取引先などで検索..."
                      value={search} onChange={(e) => setSearch(e.target.value)}
                      InputProps={{ startAdornment: <InputAdornment position="start"><span className="material-icons">search</span></InputAdornment> }}
                    />
                    <Stack direction="row" spacing={1} alignItems="center">
                      <Typography variant="body2">単店</Typography>
                      <Select size="small" value={currentStore} onChange={(e)=>setCurrentStore(e.target.value)} sx={{minWidth:120}}>
                        {Array.from({ length: 40 }, (_, i) => `店舗${String(i + 1).padStart(2, '0')}`).map(s => (
                          <MenuItem key={s} value={s}>{s}</MenuItem>
                        ))}
                      </Select>
                    </Stack>
                    <Tabs value={storeListTab} onChange={(_,v)=>setStoreListTab(v)} sx={{ml:2}}>
                      <Tab label="単店" />
                      <Tab label="全店（店舗別）" />
                      <Tab label="全店（店舗合計）" />
                    </Tabs>
                    <Typography variant="body2" sx={{whiteSpace:'nowrap'}}>
                      {sorted.length.toLocaleString()} 件{selected.size > 0 && ` / 選択: ${selected.size.toLocaleString()} 件`}
                    </Typography>
                    {selected.size > 0 && (
                      <Button variant="contained" color="primary" size="small"
                        startIcon={<span className="material-icons">shopping_cart</span>}
                        onClick={()=>openOrderModal('store_to_md')}>
                        要望作成（店舗→商品部）
                      </Button>
                    )}
                    <Button size="small" onClick={()=>setPage(1)} startIcon={<span className="material-icons">list_alt</span>}>
                      要望リスト（店舗）
                    </Button>
                  </Stack>
                </Paper>

                <Paper variant="outlined">
                  <TableContainer ref={containerRef} onScroll={handleScroll} sx={{height: tableHeight}}>
                    <Table size="small" stickyHeader>
                      <TableHead>
                        <TableRow>
                          {COLUMNS.map(col => col.kind==='checkbox'
                            ? (
                              <TableCell key={col.key} sx={{ fontWeight:600, bgcolor:'action.hover', width:col.width, padding:'4px 6px' }}>
                                <Checkbox size="small"
                                  indeterminate={selected.size > 0 && selected.size < sorted.filter(r=>typeof r.id==='number').length}
                                  checked={sorted.filter(r=>typeof r.id==='number').length > 0 && selected.size === sorted.filter(r=>typeof r.id==='number').length}
                                  onChange={() => toggleAll(sorted)} />
                              </TableCell>
                            ) : (
                              <TableCell key={col.key} align={col.numeric ? 'right' : 'left'}
                                sx={{ fontWeight:600, bgcolor:'action.hover', minWidth:col.width, cursor:'pointer' }}>
                                <TableSortLabel active={orderBy === col.key} direction={orderBy === col.key ? order : 'asc'} onClick={() => handleSort(col.key)}>
                                  {col.label}
                                </TableSortLabel>
                              </TableCell>
                            )
                          )}
                        </TableRow>
                      </TableHead>
                      <TableBody>
                        {topPad > 0 && <TableRow><TableCell colSpan={COLUMNS.length} style={{height: topPad, padding:0, border:0}} /></TableRow>}
                        {displayData.map(row => (
                          <TableRow key={row.id} hover>
                            {COLUMNS.map(col => {
                              if (col.kind==='checkbox') {
                                const isAgg = typeof row.id !== 'number';
                                return (
                                  <TableCell key={col.key} sx={{padding:'4px 6px'}}>
                                    <Tooltip title={isAgg ? '全店合計は選択できません' : ''}>
                                      <span>
                                        <Checkbox size="small" disabled={isAgg}
                                          checked={!isAgg && selected.has(row.id)}
                                          onChange={() => !isAgg && toggleRow(row.id)} />
                                      </span>
                                    </Tooltip>
                                  </TableCell>
                                );
                              }
                              const value = col.calc ? col.calc(row) : row[col.key];
                              return (
                                <TableCell key={col.key} align={col.numeric ? 'right' : 'left'}>
                                  {col.numeric ? Number(value||0).toLocaleString() : (value || '-')}
                                </TableCell>
                              );
                            })}
                          </TableRow>
                        ))}
                        {bottomPad > 0 && <TableRow><TableCell colSpan={COLUMNS.length} style={{height: bottomPad, padding:0, border:0}} /></TableRow>}
                      </TableBody>
                    </Table>
                  </TableContainer>
                </Paper>
              </>
            )}

            {/* 要望リスト（店舗）：両方向を表示 + 印刷 */}
            {page === 1 && (
              <Paper sx={{p:2}}>
                <Stack direction="row" spacing={1} alignItems="center" sx={{mb:2}}>
                  <Tabs value={reqFilterStore} onChange={(_,v)=>setReqFilterStore(v)} sx={{flex:1}}>
                    <Tab label={`すべて (${requestList.filter(r=>r.direction==='md_to_store' || r.direction==='store_to_md').length})`} />
                    <Tab label={`未対応 (${requestList.filter(r=>(r.direction==='md_to_store' || r.direction==='store_to_md') && r.status==='pending').length})`} />
                    <Tab label={`対応済 (${requestList.filter(r=>(r.direction==='md_to_store' || r.direction==='store_to_md') && r.status!=='pending').length})`} />
                  </Tabs>
                  <Button variant="outlined" startIcon={<span className="material-icons">print</span>} onClick={()=>window.print()}>
                    印刷
                  </Button>
                </Stack>
                <TableContainer sx={{height: tableHeight}}>
                  <RequestTable
                    className="print-area"
                    viewer="store"
                    list={
                      reqFilterStore===0 ? requestList.filter(r=>r.direction==='md_to_store' || r.direction==='store_to_md') :
                      reqFilterStore===1 ? requestList.filter(r=>(r.direction==='md_to_store' || r.direction==='store_to_md') && r.status==='pending') :
                                           requestList.filter(r=>(r.direction==='md_to_store' || r.direction==='store_to_md') && r.status!=='pending')
                    }
                  />
                </TableContainer>
              </Paper>
            )}

            {/* 商品リスト（商品部） */}
            {page === 2 && (
              <>
                <Paper sx={{p:2, mb:2}}>
                  <Stack direction="row" spacing={2} alignItems="center" flexWrap="wrap">
                    <TextField size="small" sx={{flex:1,minWidth:300}} placeholder="品名・コード・取引先などで検索..."
                      value={search} onChange={(e) => setSearch(e.target.value)}
                      InputProps={{ startAdornment: <InputAdornment position="start"><span className="material-icons">search</span></InputAdornment> }}
                    />
                    <Stack direction="row" spacing={1} alignItems="center">
                      <Typography variant="body2">自店</Typography>
                      <Select size="small" value={currentStore} onChange={(e)=>setCurrentStore(e.target.value)} sx={{minWidth:120}}>
                        {Array.from({ length: 40 }, (_, i) => `店舗${String(i + 1).padStart(2, '0')}`).map(s => (
                          <MenuItem key={s} value={s}>{s}</MenuItem>
                        ))}
                      </Select>
                    </Stack>
                    <Tabs value={mdListTab} onChange={(_,v)=>setMdListTab(v)} sx={{ml:2}}>
                      <Tab label="自店" />
                      <Tab label="全店（店舗別）" />
                      <Tab label="全店（店舗合計）" />
                    </Tabs>
                    <Typography variant="body2" sx={{whiteSpace:'nowrap'}}>
                      {sorted.length.toLocaleString()} 件{selected.size > 0 && ` / 選択: ${selected.size.toLocaleString()} 件`}
                    </Typography>
                    {selected.size > 0 && (
                      <Button variant="contained" color="secondary" size="small"
                        startIcon={<span className="material-icons">outgoing_mail</span>}
                        onClick={()=>openOrderModal('md_to_store')}>
                        依頼作成（商品部→店舗）
                      </Button>
                    )}
                    <Button size="small" onClick={()=>setPage(3)} startIcon={<span className="material-icons">list_alt</span>}>
                      要望リスト（商品部）
                    </Button>
                  </Stack>
                </Paper>

                <Paper variant="outlined">
                  <TableContainer ref={containerRef} onScroll={handleScroll} sx={{height: tableHeight}}>
                    <Table size="small" stickyHeader>
                      <TableHead>
                        <TableRow>
                          {COLUMNS.map(col => col.kind==='checkbox'
                            ? (
                              <TableCell key={col.key} sx={{ fontWeight:600, bgcolor:'action.hover', width:col.width, padding:'4px 6px' }}>
                                <Checkbox size="small"
                                  indeterminate={selected.size > 0 && selected.size < sorted.filter(r=>typeof r.id==='number').length}
                                  checked={sorted.filter(r=>typeof r.id==='number').length > 0 && selected.size === sorted.filter(r=>typeof r.id==='number').length}
                                  onChange={() => toggleAll(sorted)} />
                              </TableCell>
                            ) : (
                              <TableCell key={col.key} align={col.numeric ? 'right' : 'left'}
                                sx={{ fontWeight:600, bgcolor:'action.hover', minWidth:col.width, cursor:'pointer' }}>
                                <TableSortLabel active={orderBy === col.key} direction={orderBy === col.key ? order : 'asc'} onClick={() => handleSort(col.key)}>
                                  {col.label}
                                </TableSortLabel>
                              </TableCell>
                            )
                          )}
                        </TableRow>
                      </TableHead>
                      <TableBody>
                        {topPad > 0 && <TableRow><TableCell colSpan={COLUMNS.length} style={{height: topPad, padding:0, border:0}} /></TableRow>}
                        {displayData.map(row => (
                          <TableRow key={row.id} hover>
                            {COLUMNS.map(col => {
                              if (col.kind==='checkbox') {
                                const isAgg = typeof row.id !== 'number';
                                return (
                                  <TableCell key={col.key} sx={{padding:'4px 6px'}}>
                                    <Tooltip title={isAgg ? '全店合計は選択できません' : ''}>
                                      <span>
                                        <Checkbox size="small" disabled={isAgg}
                                          checked={!isAgg && selected.has(row.id)}
                                          onChange={() => !isAgg && toggleRow(row.id)} />
                                      </span>
                                    </Tooltip>
                                  </TableCell>
                                );
                              }
                              const value = col.calc ? col.calc(row) : row[col.key];
                              return (
                                <TableCell key={col.key} align={col.numeric ? 'right' : 'left'}>
                                  {col.numeric ? Number(value||0).toLocaleString() : (value || '-')}
                                </TableCell>
                              );
                            })}
                          </TableRow>
                        ))}
                        {bottomPad > 0 && <TableRow><TableCell colSpan={COLUMNS.length} style={{height: bottomPad, padding:0, border:0}} /></TableRow>}
                      </TableBody>
                    </Table>
                  </TableContainer>
                </Paper>
              </>
            )}

            {/* 要望リスト（商品部）：店舗→商品部のみ + 印刷 */}
            {page === 3 && (
              <Paper sx={{p:2}}>
                <Stack direction="row" spacing={1} alignItems="center" sx={{mb:2}}>
                  <Tabs value={reqFilterMd} onChange={(_,v)=>setReqFilterMd(v)} sx={{flex:1}}>
                    <Tab label={`すべて (${requestList.filter(r=>r.direction==='store_to_md').length})`} />
                    <Tab label={`未対応 (${requestList.filter(r=>r.direction==='store_to_md' && r.status==='pending').length})`} />
                    <Tab label={`対応済 (${requestList.filter(r=>r.direction==='store_to_md' && r.status!=='pending').length})`} />
                  </Tabs>
                  <Button variant="outlined" startIcon={<span className="material-icons">print</span>} onClick={()=>window.print()}>
                    印刷
                  </Button>
                </Stack>
                <TableContainer sx={{height: tableHeight}}>
                  <RequestTable
                    className="print-area"
                    viewer="md"
                    list={
                      reqFilterMd===0 ? requestList.filter(r=>r.direction==='store_to_md') :
                      reqFilterMd===1 ? requestList.filter(r=>r.direction==='store_to_md' && r.status==='pending') :
                                        requestList.filter(r=>r.direction==='store_to_md' && r.status!=='pending')
                    }
                  />
                </TableContainer>
              </Paper>
            )}
          </Container>

          {/* 設定 */}
          <Dialog open={settingsOpen} onClose={() => setSettingsOpen(false)} maxWidth="sm" fullWidth>
            <DialogTitle>設定</DialogTitle>
            <DialogContent>
              <Stack spacing={2} sx={{pt:1}}>
                <Box>
                  <Typography variant="body2" sx={{mb:1}}>サンプルデータ生成件数</Typography>
                  <Stack direction="row" spacing={1} alignItems="center">
                    <TextField size="small" type="number" value={dataCount}
                      onChange={(e) => setDataCount(Math.max(1, parseInt(e.target.value) || 1))}
                      inputProps={{min:1, max:100000}} sx={{width:150}} />
                    <Button variant="contained" startIcon={<span className="material-icons">refresh</span>} onClick={regenerateData}>再生成</Button>
                  </Stack>
                  <Typography variant="caption" color="text.secondary" sx={{display:'block',mt:1}}>
                    現在: {rows.length.toLocaleString()} 件
                  </Typography>
                </Box>
              </Stack>
            </DialogContent>
            <DialogActions><Button onClick={() => setSettingsOpen(false)}>閉じる</Button></DialogActions>
          </Dialog>

          {/* 依頼/要望モーダル（AsIs28d / AsIs7d / ToBe28d の順） */}
          <Dialog open={orderModalOpen} onClose={() => setOrderModalOpen(false)} maxWidth="xl" fullWidth>
            <DialogTitle sx={{pb:1}}>
              <Stack direction="row" alignItems="center" justifyContent="space-between">
                <Stack direction="row" alignItems="center" spacing={1}>
                  <span className="material-icons" style={{color: orderMode==='md_to_store' ? '#9c27b0' : '#1976d2'}}>
                    {orderMode==='md_to_store' ? 'outgoing_mail' : 'shopping_cart'}
                  </span>
                  <Typography variant="h6" component="span">
                    {orderMode==='md_to_store' ? '商品部 → 店舗 依頼' : '店舗 → 商品部 要望'}
                  </Typography>
                </Stack>
                <Chip label={`${Object.keys(selectedProductsAllStores).length} 商品`} color={orderMode==='md_to_store'?'secondary':'primary'}/>
              </Stack>
            </DialogTitle>
            <Tabs value={modalTab} onChange={(_, v) => setModalTab(v)} sx={{borderBottom:1,borderColor:'divider',px:3}}>
              <Tab label={orderMode==='md_to_store' ? '店舗別 指示選択' : '店舗別 アクション選択'} />
              <Tab label={`内容確認 (${Object.keys(orderActions).length}件)`} disabled={Object.keys(orderActions).length === 0} />
            </Tabs>

            <DialogContent sx={{p:0}}>
              {modalTab === 0 && (
                <Box sx={{maxHeight: 'calc(100vh - 280px)', overflow:'auto'}}>
                  {Object.entries(selectedProductsAllStores).map(([productId, {product, stores}]) => {
                    const selectedStoreRow = rows.find(r => selected.has(r.id) && r.productId === Number(productId));
                    const selectedStoreName = selectedStoreRow?.store;

                    // 1行目に来る店舗（店舗画面=自店 / 商品部画面=商品リストの該当店舗）
                    const primaryStore = (orderMode === 'store_to_md') ? currentStore : (selectedStoreName || stores[0]?.store);

                    // テーブル表示順（1行目=primary）
                    const storesForTable = (() => {
                      const arr = [...stores];
                      const idx = arr.findIndex(s => s.store === primaryStore);
                      if (idx > 0) { const [sp] = arr.splice(idx,1); arr.unshift(sp); }
                      return arr;
                    })();

                    // ToBe在庫（数量系のみ反映）
                    const calcToBe = () => {
                      const baseMap = new Map(stores.map(s => [s.store, { sales28d: s.sales28d||0, sales7d: s.sales7d||0, stockQty: s.stockQty||0 }]));
                      Object.values(orderActions).forEach(a => {
                        if (a.productId !== Number(productId)) return;
                        const rec = baseMap.get(a.store);
                        if (!rec) return;
                        if (a.action === 'order') rec.stockQty += (a.quantity||0);
                        if (a.action === 'transfer_in') rec.stockQty += (a.quantity||0);
                        if (a.action === 'transfer_out') rec.stockQty -= (a.quantity||0);
                        // discount は在庫は変更しない
                      });
                      return Array.from(baseMap.entries()).map(([store, v]) => ({ store, ...v }));
                    };

                    const asisData = stores.map(s => ({ store:s.store, sales28d:s.sales28d||0, sales7d:s.sales7d||0, stockQty:s.stockQty||0 }));
                    const tobeData = calcToBe();

                    const handleBarClick = ({store, sales28d, sales7d, stockQty, metric, anchor}) => {
                      setGraphPopup({ open:true, anchor, data: {title: (metric==='sales28d'?'販売28日': metric==='sales7d'?'販売7日':'在庫数'), store, sales28d, sales7d, stockQty} });
                    };

                    return (
                      <Box key={productId} sx={{borderBottom:2,borderColor:'divider'}}>
                        {/* 商品ヘッダー */}
                        <Box sx={{px:3,pt:2,position:'sticky',top:0,zIndex:2, bgcolor:(t)=>t.palette.mode==='dark'?'#111':'#fafafa', borderBottom:1, borderColor:'divider'}}>
                          <Stack direction="row" spacing={2} alignItems="center" justifyContent="space-between">
                            <Box sx={{flex:1}}>
                              <Typography variant="h6" sx={{fontWeight:600,mb:0.5}}>{product.name}</Typography>
                              <Typography variant="body2" color="text.secondary">
                                コード: {product.code} | 部門: {product.dept} | 取引先: {product.partner}
                              </Typography>
                              <Stack direction="row" spacing={0.5} sx={{mt:0.5}}>
                                <Chip label={product.corner} size="small" sx={{height:20,fontSize:'0.7rem'}}/>
                                <Chip label={product.line} size="small" sx={{height:20,fontSize:'0.7rem'}}/>
                                <Chip label={product.category} size="small" sx={{height:20,fontSize:'0.7rem'}}/>
                              </Stack>
                            </Box>
                            <Box sx={{textAlign:'right'}}>
                              <Typography variant="caption" color="text.secondary">原価</Typography>
                              <Typography variant="h6" color={orderMode==='md_to_store'?'secondary':'primary'}>
                                ¥{product.costPrice?.toLocaleString()}
                              </Typography>
                            </Box>
                          </Stack>

                          {/* グラフ：順番＝ AsIs28d → AsIs7d → ToBe28d */}
                          <Box sx={{mt:1, pb:1}}>
                            <Accordion defaultExpanded>
                              <AccordionSummary expandIcon={<span className="material-icons">expand_more</span>}>
                                <Typography variant="subtitle2">AsIs：現状（販売28日・在庫数）</Typography>
                              </AccordionSummary>
                              <AccordionDetails>
                                <D3GroupedBar
                                  title="AsIs（28日）"
                                  data={asisData}
                                  selectedStore={primaryStore}
                                  height={240}
                                  onBarClick={handleBarClick}
                                  seriesKeys={['sales28d','stockQty']}
                                  seriesLabels={{sales28d:'販売28日', stockQty:'在庫数'}}
                                />
                              </AccordionDetails>
                            </Accordion>

                            <Accordion>
                              <AccordionSummary expandIcon={<span className="material-icons">expand_more</span>}>
                                <Typography variant="subtitle2">AsIs：現状（販売7日・在庫数）</Typography>
                              </AccordionSummary>
                              <AccordionDetails>
                                <D3GroupedBar
                                  title="AsIs（7日）"
                                  data={asisData}
                                  selectedStore={primaryStore}
                                  height={240}
                                  onBarClick={handleBarClick}
                                  seriesKeys={['sales7d','stockQty']}
                                  seriesLabels={{sales7d:'販売7日', stockQty:'在庫数'}}
                                />
                              </AccordionDetails>
                            </Accordion>

                            <Accordion>
                              <AccordionSummary expandIcon={<span className="material-icons">expand_more</span>}>
                                <Typography variant="subtitle2">ToBe：指示反映後（販売28日・在庫数）</Typography>
                              </AccordionSummary>
                              <AccordionDetails>
                                <D3GroupedBar
                                  title="ToBe（28日）"
                                  data={tobeData}
                                  selectedStore={primaryStore}
                                  height={240}
                                  onBarClick={handleBarClick}
                                  seriesKeys={['sales28d','stockQty']}
                                  seriesLabels={{sales28d:'販売28日', stockQty:'在庫数'}}
                                />
                              </AccordionDetails>
                            </Accordion>
                          </Box>
                        </Box>

                        {/* 店舗別テーブル（強調：1行目=primary、アクション選択の店舗は追加強調） */}
                        <Table size="small">
                          <TableHead>
                            <TableRow sx={{'& th':{bgcolor:'action.hover',fontWeight:600,fontSize:'0.75rem'}}}>
                              <TableCell>店舗</TableCell>
                              <TableCell align="right">在庫数</TableCell>
                              <TableCell align="right">7日販売</TableCell>
                              <TableCell align="right">28日販売</TableCell>
                              <TableCell align="right">在庫日数</TableCell>
                              <TableCell>{orderMode==='md_to_store'?'指示候補':'推奨'}</TableCell>
                              <TableCell width="40%">{orderMode==='md_to_store'?'指示内容':'アクション'} / 日付</TableCell>
                            </TableRow>
                          </TableHead>
                          <TableBody>
                            {storesForTable.map(store => {
                              const key = `${productId}_${store.store}`;
                              const action = orderActions[key];
                              const daysOfStock = store.sales7d > 0 ? ((store.stockQty / store.sales7d) * 7).toFixed(1) : '999+';
                              const recommended = getRecommendedAction(store, stores);

                              const isPrimary = store.store === primaryStore;
                              const isSecondary = !!action && !isPrimary;

                              return (
                                <TableRow key={store.id}
                                  sx={{
                                    bgcolor: isPrimary ? (orderMode==='md_to_store'?'secondary.light':'primary.light')
                                      : isSecondary ? 'action.hover' : 'inherit',
                                    '&:hover': {bgcolor: isPrimary ? (orderMode==='md_to_store'?'secondary.light':'primary.light') : 'action.selected'}
                                  }}
                                >
                                  <TableCell>
                                    <Stack direction="row" spacing={0.5} alignItems="center">
                                      {isPrimary && <Chip label={orderMode==='md_to_store'?'対象店舗':'自店'} size="small" color={orderMode==='md_to_store'?'secondary':'primary'} sx={{height:18,fontSize:'0.65rem'}}/>}
                                      {isSecondary && <Chip label="選択中" size="small" color="warning" sx={{height:18,fontSize:'0.65rem'}}/>}
                                      <Typography variant="body2" sx={{fontWeight: isPrimary ? 700 : 400}}>
                                        {store.store}
                                      </Typography>
                                    </Stack>
                                  </TableCell>
                                  <TableCell align="right">
                                    <Typography variant="body2" sx={{color: store.stockQty < store.sales7d ? 'error.main' : 'inherit'}}>
                                      {store.stockQty}
                                    </Typography>
                                  </TableCell>
                                  <TableCell align="right">{store.sales7d}</TableCell>
                                  <TableCell align="right">{store.sales28d}</TableCell>
                                  <TableCell align="right">
                                    <Chip label={`${daysOfStock}日`} size="small"
                                      color={parseFloat(daysOfStock) < 14 ? 'error' : (parseFloat(daysOfStock) > 28 ? 'warning' : 'success')}
                                      sx={{height:20,fontSize:'0.7rem'}} />
                                  </TableCell>
                                  <TableCell>
                                    {recommended && (
                                      <Chip
                                        label={
                                          recommended.action === 'order' ? (orderMode==='md_to_store'?'発注指示':'発注') :
                                          recommended.action === 'transfer_in' ? (orderMode==='md_to_store'?'移管受入指示':'移管受入') :
                                          recommended.action === 'transfer_out' ? (orderMode==='md_to_store'?'移管払出指示':'移管払出') :
                                          (orderMode==='md_to_store'?'値下げ指示':'値下げ')
                                        }
                                        size="small"
                                        color={recommended.action === 'order' ? 'info' : recommended.action === 'discount' ? 'error' : 'warning'}
                                        sx={{height:20,fontSize:'0.65rem'}}
                                      />
                                    )}
                                  </TableCell>
                                  <TableCell>
                                    <Stack spacing={1}>
                                      <RadioGroup row value={action?.action || ''}
                                        onChange={(e) => {
                                          const val = e.target.value;
                                          if (val === 'order') {
                                            setAction(productId, store.store, 'order', {
                                              quantity: recommended?.quantity || Math.ceil((store.sales7d || 1) * 2),
                                              date: plusDaysStr(3)
                                            });
                                          } else if (val === 'transfer_in') {
                                            setAction(productId, store.store, 'transfer_in', {
                                              fromStore: recommended?.from || stores.find(s => s.store !== store.store)?.store,
                                              quantity: Math.ceil((store.sales7d || 1) * 2),
                                              date: plusDaysStr(3)
                                            });
                                          } else if (val === 'transfer_out') {
                                            setAction(productId, store.store, 'transfer_out', {
                                              toStore: recommended?.to || stores.find(s => s.store !== store.store)?.store,
                                              quantity: Math.floor(store.stockQty * 0.5),
                                              date: plusDaysStr(3)
                                            });
                                          } else if (val === 'discount') {
                                            setAction(productId, store.store, 'discount', {
                                              discountRate: recommended?.rate || 20,
                                              date: plusDaysStr(3)
                                            });
                                          }
                                        }}
                                        sx={{'& .MuiFormControlLabel-root':{mr:1}}}
                                      >
                                        <FormControlLabel value="order" control={<Radio size="small"/>} label={<Typography variant="caption">{orderMode==='md_to_store'?'発注指示':'発注'}</Typography>} />
                                        <FormControlLabel value="transfer_in" control={<Radio size="small"/>} label={<Typography variant="caption">移管受</Typography>} />
                                        <FormControlLabel value="transfer_out" control={<Radio size="small"/>} label={<Typography variant="caption">移管払</Typography>} />
                                        <FormControlLabel value="discount" control={<Radio size="small"/>} label={<Typography variant="caption">{orderMode==='md_to_store'?'値下指':'値下'}</Typography>} />
                                      </RadioGroup>

                                      {action && (
                                        <Stack direction="row" spacing={1} alignItems="center" flexWrap="wrap">
                                          {(action.action === 'order' || action.action === 'transfer_in' || action.action === 'transfer_out') && (
                                            <TextField size="small" type="number" label="数量"
                                              value={action.quantity || 0}
                                              onChange={(e) => setAction(productId, store.store, action.action, {...action, quantity: parseInt(e.target.value) || 0})}
                                              inputProps={{min:1}}
                                              sx={{width:90,'& .MuiInputBase-input':{fontSize:'0.8rem',p:'4px 8px'}}}
                                            />
                                          )}
                                          {action.action === 'transfer_in' && (
                                            <TextField size="small" select label="移管元" value={action.fromStore || ''}
                                              onChange={(e) => setAction(productId, store.store, 'transfer_in', {...action, fromStore: e.target.value})}
                                              SelectProps={{native: true}} sx={{width:120,'& .MuiInputBase-input':{fontSize:'0.8rem',p:'4px 8px'}}}>
                                              <option value="">-</option>
                                              {stores.filter(s => s.store !== store.store).map(s => (<option key={s.store} value={s.store}>{s.store}</option>))}
                                            </TextField>
                                          )}
                                          {action.action === 'transfer_out' && (
                                            <TextField size="small" select label="移管先" value={action.toStore || ''}
                                              onChange={(e) => setAction(productId, store.store, 'transfer_out', {...action, toStore: e.target.value})}
                                              SelectProps={{native: true}} sx={{width:120,'& .MuiInputBase-input':{fontSize:'0.8rem',p:'4px 8px'}}}>
                                              <option value="">-</option>
                                              {stores.filter(s => s.store !== store.store).map(s => (<option key={s.store} value={s.store}>{s.store}</option>))}
                                            </TextField>
                                          )}
                                          <TextField size="small" type="date" label="日付" value={action.date || plusDaysStr(3)}
                                            onChange={(e) => setAction(productId, store.store, action.action, {...action, date: e.target.value})}
                                            sx={{width:160,'& .MuiInputBase-input':{fontSize:'0.8rem',p:'4px 8px'}}} />
                                          {action.action === 'discount' && (
                                            <TextField size="small" type="number" label="値引率(%)" value={action.discountRate || 0}
                                              onChange={(e) => setAction(productId, store.store, 'discount', {...action, discountRate: parseInt(e.target.value) || 0})}
                                              inputProps={{min:0, max:50}} sx={{width:120,'& .MuiInputBase-input':{fontSize:'0.8rem',p:'4px 8px'}}} />
                                          )}
                                          <IconButton size="small" onClick={() => {
                                            setOrderActions(prev => { const na = {...prev}; delete na[key]; return na; });
                                          }}><span className="material-icons" style={{fontSize:16}}>close</span></IconButton>
                                        </Stack>
                                      )}
                                    </Stack>
                                  </TableCell>
                                </TableRow>
                              );
                            })}
                          </TableBody>
                        </Table>
                      </Box>
                    );
                  })}
                </Box>
              )}

              {modalTab === 1 && (
                <Box sx={{p:3}}>
                  <Alert severity="info" sx={{mb:2}}>
                    {orderMode==='md_to_store' ? '以下の依頼内容を確認して送信してください（商品部→店舗）' : '以下の要望内容を確認して送信してください（店舗→商品部）'}
                  </Alert>
                  <List>
                    {Object.values(orderActions).map((action, idx) => {
                      const product = rows.find(r => r.productId === Number(action.productId) && r.store === action.store);
                      return (
                        <React.Fragment key={idx}>
                          {idx > 0 && <Divider />}
                          <ListItem sx={{py:2}}>
                            <Box sx={{width:'100%'}}>
                              <Stack direction="row" spacing={2} alignItems="center" justifyContent="space-between" flexWrap="wrap">
                                <Box sx={{minWidth:240, mr:2}}>
                                  <Typography variant="subtitle2" sx={{fontWeight:600}}>
                                    {product?.name ?? '(商品不明)'} / {product?.store ?? '-'}
                                  </Typography>
                                  <Typography variant="caption" color="text.secondary">{product?.code ?? '-'}</Typography>
                                </Box>
                                <Stack direction="row" spacing={1} alignItems="center">
                                  <Chip
                                    label={
                                      action.action === 'order' ? `${orderMode==='md_to_store'?'発注指示':'発注'} ${action.quantity}個` :
                                      action.action === 'transfer_in' ? `${action.fromStore}から移管 ${action.quantity}個` :
                                      action.action === 'transfer_out' ? `${action.toStore}へ移管 ${action.quantity}個` :
                                      `${orderMode==='md_to_store'?'値下げ指示':'値下げ'} ${action.discountRate}%`
                                    }
                                    color={action.action === 'order' ? 'info' : (action.action === 'discount' ? 'error' : 'warning')}
                                  />
                                  <Chip label={`日付: ${action.date || plusDaysStr(3)}`} />
                                </Stack>
                              </Stack>
                            </Box>
                          </ListItem>
                        </React.Fragment>
                      );
                    })}
                  </List>
                  <TextField fullWidth multiline rows={3} label="備考" placeholder="補足事項があれば記入してください"
                    value={orderNote} onChange={(e) => setOrderNote(e.target.value)} sx={{mt:2}} />
                </Box>
              )}
            </DialogContent>

            <DialogActions sx={{px:3,py:2,justifyContent:'space-between'}}>
              <Button onClick={() => setOrderModalOpen(false)} color="inherit">キャンセル</Button>
              <Stack direction="row" spacing={1}>
                {modalTab === 0 && (
                  <Button variant="contained" color={orderMode==='md_to_store'?'secondary':'primary'}
                    disabled={Object.keys(orderActions).length === 0}
                    onClick={() => setModalTab(1)}
                    endIcon={<span className="material-icons">arrow_forward</span>}>
                    次へ（確認）
                  </Button>
                )}
                {modalTab === 1 && (
                  <>
                    <Button onClick={() => setModalTab(0)} startIcon={<span className="material-icons">arrow_back</span>}>戻る</Button>
                    <Button variant="contained" color={orderMode==='md_to_store'?'secondary':'primary'}
                      onClick={submitOrder} startIcon={<span className="material-icons">send</span>}>
                      {orderMode==='md_to_store'?'依頼を送信':'要望を送信'}
                    </Button>
                  </>
                )}
              </Stack>
            </DialogActions>
          </Dialog>

          {/* 差戻コメントダイアログ */}
          <Dialog open={rejectDialogState.open} onClose={()=>setRejectDialogState({open:false,id:null,comment:''})} maxWidth="sm" fullWidth>
            <DialogTitle>差戻コメント</DialogTitle>
            <DialogContent>
              <TextField autoFocus fullWidth multiline rows={4} placeholder="差戻しの理由・対応方針を入力"
                value={rejectDialogState.comment} onChange={(e)=>setRejectDialogState({...rejectDialogState, comment:e.target.value})} />
            </DialogContent>
            <DialogActions>
              <Button onClick={()=>setRejectDialogState({open:false,id:null,comment:''})}>キャンセル</Button>
              <Button variant="contained" color="error" onClick={doReject} disabled={!rejectDialogState.comment?.trim()}>差戻を確定</Button>
            </DialogActions>
          </Dialog>

          {/* グラフ クリックポップアップ（上表） */}
          <Popover
            open={graphPopup.open}
            onClose={()=>setGraphPopup({open:false, anchor:{x:0,y:0}, data:null})}
            anchorReference="anchorPosition"
            anchorPosition={{ top: graphPopup.anchor.y, left: graphPopup.anchor.x }}
          >
            <Box sx={{p:2, minWidth:220}}>
              <Typography variant="subtitle2" sx={{mb:1}}>上表</Typography>
              {graphPopup.data ? (
                <>
                  <Stack direction="row" justifyContent="space-between"><Typography variant="body2">店舗</Typography><Typography variant="body2" sx={{fontWeight:600}}>{graphPopup.data.store}</Typography></Stack>
                  <Stack direction="row" justifyContent="space-between"><Typography variant="body2">販売28日</Typography><Typography variant="body2" sx={{fontWeight:600}}>{graphPopup.data.sales28d?.toLocaleString?.() ?? graphPopup.data.sales28d}</Typography></Stack>
                  <Stack direction="row" justifyContent="space-between"><Typography variant="body2">販売7日</Typography><Typography variant="body2" sx={{fontWeight:600}}>{graphPopup.data.sales7d?.toLocaleString?.() ?? graphPopup.data.sales7d}</Typography></Stack>
                  <Stack direction="row" justifyContent="space-between"><Typography variant="body2">在庫数</Typography><Typography variant="body2" sx={{fontWeight:600}}>{graphPopup.data.stockQty?.toLocaleString?.() ?? graphPopup.data.stockQty}</Typography></Stack>
                </>
              ) : <Typography variant="body2" color="text.secondary">データなし</Typography>}
            </Box>
          </Popover>

          <Snackbar open={snackbar.open} autoHideDuration={4000} onClose={() => setSnackbar({...snackbar, open: false})}
            anchorOrigin={{vertical: 'bottom', horizontal: 'right'}}>
            <Alert severity={snackbar.severity} variant="filled" sx={{width: '100%'}}
              onClose={() => setSnackbar({...snackbar, open: false})}>
              {snackbar.message}
            </Alert>
          </Snackbar>
        </ThemeProvider>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
  </script>
</body>
</html>
