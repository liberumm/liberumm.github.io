<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>Need Fit Balancer ‚Äì Complete SPA</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Fonts / Icons / React / MUI / Babel -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;600;700&display=swap"/>
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons"/>
  <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mui/material@5.15.14/umd/material-ui.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.25.6/babel.min.js"></script>

  <!-- D3ÔºàÂõ≥ÂºèÔºâ -->
  <script src="https://cdn.jsdelivr.net/npm/d3@7/dist/d3.min.js"></script>

  <!-- LeafletÔºàÂú∞Âõ≥Ôºâ -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    :root{ --bg:#f7faf9; --border:#e5eeeb; --lane:#f3f6fb; }
    *{ box-sizing:border-box; }
    html{ scroll-behavior:smooth; }
    body{ margin:0; font-family: Roboto, system-ui, -apple-system, "Segoe UI", sans-serif; background:var(--bg); color:#1d2939; }
    .mono{ font-variant-numeric:tabular-nums; font-feature-settings:"tnum"; }
    .pill{ font-size:11px; padding:2px 8px; border-radius:999px; border:1px solid #e0e3ea; background:#fff; }
    .card { border:1px solid var(--border); border-radius:12px; background:#fff; width:100%; }
    .rotate-90{ transform: rotate(90deg); transition: transform .2s ease; }
    .rotate-0{ transform: rotate(0deg); transition: transform .2s ease; }
    .leaflet-container{ border-radius:10px; }
    .balance-icon{ font-size:22px; color:#1f3aa5; vertical-align:-4px; margin-right:8px; }

    /* Âõ≥Âºè„Ç®„É™„Ç¢ÔºàÂàùÊúü35vh / „É™„Çµ„Ç§„Ç∫ÂèØÔºâ */
    .diagram-wrap{ position: relative; width: 100%; }
    .diagram-shell{
      border-radius:12px; border:1px solid var(--border); background:#fff;
      width:100%; height:35vh; resize: vertical; overflow: auto; position: relative;
    }
    /* Âõ≥Âºè„Ç∫„Éº„É†UIÔºàÂè≥‰∏ãÂõ∫ÂÆöÔºâ */
    .zoom-ui{
      position: absolute; right: 12px; bottom: 12px;
      display: flex; gap: 6px; padding: 6px; border-radius: 10px;
      background: #ffffff; border: 1px solid var(--border);
      box-shadow: 0 6px 20px rgba(0,0,0,.08); z-index: 2;
    }

    .lane-label{ font-weight:700; font-size:12px; fill:#1d2939; }
    .node-card{ cursor:grab; }
    .node-card:active{ cursor:grabbing; }
    .node-title{ font-weight:600; font-size:13px; fill:#1d2939; }
    .node-sub{ font-size:11px; fill:#667085; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const {useState, useEffect, useRef} = React;
    const {
      AppBar, Toolbar, Typography, Container, Box, Paper, Stack, Button, Divider, Collapse, IconButton,
      Select, MenuItem, TextField, Slider, ToggleButton, ToggleButtonGroup,
      Table, TableHead, TableRow, TableCell, TableBody, TableContainer, Checkbox, Chip, Tooltip, Snackbar, Alert,
      FormGroup, FormControlLabel, Switch, ThemeProvider, createTheme, Avatar, Tabs, Tab, LinearProgress, Drawer
    } = MaterialUI;

    // ===== Theme =====
    const theme = createTheme({
      palette:{ mode:'light', primary:{main:'#1f3aa5'}, secondary:{main:'#0b8b86'}, background:{default:'#f5f7fb'} },
      shape:{ borderRadius:10 }, typography:{ button:{ textTransform:'none', fontWeight:600 } }
    });

    // ===== Data =====
    const COLORS = { Raw:'#8b5cf6', Factory:'#2563eb', MfrWH:'#0ea5e9', OwnDC:'#22c55e', Store:'#6cc24a', Customer:'#f59e0b' };
    const ICONS  = { Raw:'üß™', Factory:'üè≠', MfrWH:'üè¨', OwnDC:'üöö', Store:'üè™', Customer:'üë§' };
    const STAGES = ['Raw','Factory','MfrWH','OwnDC','Store','Customer'];

    // Â∫óËàó„ÅØ11Â∫óËàó
    const NODES = {
      Raw: [
        { id:'RAW-01', name:'ÂéüÊñôA(ÂüºÁéâ)', lat:35.97, lng:139.65 },
        { id:'RAW-02', name:'ÂéüÊñôB(ÂçÉËëâ)', lat:35.61, lng:140.13 },
        { id:'RAW-03', name:'ÂéüÊñôC(Ëå®Âüé)', lat:36.34, lng:140.43 },
      ],
      Factory: [
        { id:'FCT-01', name:'„É°„Éº„Ç´„ÉºÂ∑•Â†¥(Â∑ùÂ¥é)', lat:35.53, lng:139.70 },
        { id:'FCT-02', name:'„É°„Éº„Ç´„ÉºÂ∑•Â†¥(Â†∫)',   lat:34.57, lng:135.48 },
      ],
      MfrWH: [
        { id:'MWH-01', name:'„É°„Éº„Ç´„ÉºÂÄâÂ∫´(ÂçÉËëâÂåó)', lat:35.69, lng:140.10 },
        { id:'MWH-02', name:'„É°„Éº„Ç´„ÉºÂÄâÂ∫´(Á•ûÊà∏)',   lat:34.68, lng:135.18 },
      ],
      OwnDC: [
        { id:'ODC-01', name:'Ëá™Á§æÂÄâÂ∫´(Ë∂≥Á´ã)', lat:35.78, lng:139.80 },
        { id:'ODC-02', name:'Ëá™Á§æÂÄâÂ∫´(Â∞ºÂ¥é)', lat:34.73, lng:135.42 },
      ],
      Store: [
        { id:'STR-01', name:'Â∫óËàó(Êñ∞ÂÆøË•øÂè£)',   lat:35.69, lng:139.70 },
        { id:'STR-02', name:'Â∫óËàó(Ê¢ÖÁî∞)',       lat:34.70, lng:135.50 },
        { id:'STR-03', name:'Â∫óËàó(Ê∏ãË∞∑)',       lat:35.66, lng:139.70 },
        { id:'STR-04', name:'Â∫óËàó(Ê±†Ë¢ã)',       lat:35.73, lng:139.71 },
        { id:'STR-05', name:'Â∫óËàó(ÂìÅÂ∑ù)',       lat:35.62, lng:139.74 },
        { id:'STR-06', name:'Â∫óËàó(Ê®™ÊµúË•øÂè£)',   lat:35.47, lng:139.62 },
        { id:'STR-07', name:'Â∫óËàó(Â§ßÂÆÆ)',       lat:35.91, lng:139.62 },
        { id:'STR-08', name:'Â∫óËàó(Á´ãÂ∑ù)',       lat:35.70, lng:139.41 },
        { id:'STR-09', name:'Â∫óËàó(ÂçÉËëâ„Åù„Åî„ÅÜ)', lat:35.61, lng:140.11 },
        { id:'STR-10', name:'Â∫óËàó(Á•ûÊà∏‰∏âÂÆÆ)',   lat:34.69, lng:135.19 },
        { id:'STR-11', name:'Â∫óËàó(ÂêçÂè§Â±ãÊ†Ñ)',   lat:35.17, lng:136.91 },
      ],
      Customer: [
        { id:'CUS-01', name:'È°ßÂÆ¢(‰∏ñÁî∞Ë∞∑)',   lat:35.64, lng:139.65 },
        { id:'CUS-02', name:'È°ßÂÆ¢(Ê≠§Ëä±Âå∫)',   lat:34.68, lng:135.45 },
      ],
    };

    const SCENARIOS = [
      { id:'SC-001', sku:'„Çπ„Éù„Éº„ÉÑ„Éâ„É™„É≥„ÇØ 500ml', qty:240,
        path:{ Raw:'RAW-01', Factory:'FCT-01', MfrWH:'MWH-01', OwnDC:'ODC-01', Store:'STR-01', Customer:'CUS-01' },
        status:'in_transit', progress:0.42, eta:'2025-10-12' },
      { id:'SC-002', sku:'„Ç´„ÉÉ„ÉóÈ∫∫ ÈÜ§Ê≤π', qty:180,
        path:{ Raw:'RAW-03', Factory:'FCT-02', MfrWH:'MWH-02', OwnDC:'ODC-02', Store:'STR-10', Customer:'CUS-02' },
        status:'planned', progress:0.0, eta:'2025-10-15' },
      { id:'SC-003', sku:'„ÉÅ„Éß„Ç≥„Éê„Éº', qty:320,
        path:{ Raw:'RAW-02', Factory:'FCT-01', MfrWH:'MWH-01', OwnDC:'ODC-01', Store:'STR-11', Customer:'CUS-01' },
        status:'in_transit', progress:0.7, eta:'2025-10-11' }
    ];

    const currency = n => "¬•" + n.toLocaleString();

    // ===== Êäò„ÇäÁï≥„Åø„Ç´„Éº„Éâ =====
    function Panel({title, subtitle, right, defaultOpen=true, id, children}){
      const [open,setOpen] = useState(defaultOpen);
      return (
        <Paper id={id} className="card" elevation={0} sx={{mb:2}}>
          <Stack direction="row" alignItems="center" sx={{px:2, py:1}}>
            <IconButton onClick={()=>setOpen(o=>!o)} size="small" aria-label="toggle">
              <span className={`material-icons ${open?'rotate-90':'rotate-0'}`}>chevron_right</span>
            </IconButton>
            <Box sx={{flex:1, ml:0.5}}>
              <Typography variant="subtitle1" sx={{fontWeight:700}}>{title}</Typography>
              {subtitle && <Typography variant="caption" sx={{color:'#667085'}}>{subtitle}</Typography>}
            </Box>
            {right}
          </Stack>
          <Divider/>
          <Collapse in={open} timeout="auto">
            <Box sx={{p:2}}>{children}</Box>
          </Collapse>
        </Paper>
      );
    }

    // ===== D3 Âõ≥ÂºèÔºà35vh„Å´Ëá™Âãï„Éï„Ç£„ÉÉ„Éà & „É™„Çµ„Ç§„Ç∫ÂØæÂøú & „Éú„Çø„É≥ÈÄ£Âãï„Ç∫„Éº„É†Ôºâ =====
    function SupplyDiagramD3({highlightId='SC-001', density='standard', otherAlpha=0.28, query='', stageFilter}){
      const wrapRef = React.useRef(null);

      const colW = 260;
      const rowH = density==='comfortable'? 78 : density==='compact'? 56 : 64;
      const rowGap = 10;
      const topPad = 48;
      const sidePad = 32;

      // Ë´ñÁêÜ„É¨„Ç§„Ç¢„Ç¶„Éà
      const positions = {};
      let maxRows = 0;
      STAGES.forEach((st, ci)=>{
        maxRows = Math.max(maxRows, (NODES[st]||[]).length);
        (NODES[st]||[]).forEach((n, ri)=>{
          positions[n.id] = { x: sidePad + ci*colW + 28, y: topPad + ri*(rowH+rowGap) };
        });
      });
      const contentW  = sidePad*2 + STAGES.length*colW;
      const contentH  = topPad + maxRows*(rowH+rowGap) + 32;

      React.useEffect(()=>{
        const wrapEl = wrapRef.current;
        wrapEl.innerHTML = '';

        const vw = wrapEl.clientWidth || contentW;
        const vh = wrapEl.clientHeight || contentH;

        const svg = d3.select(wrapEl).append('svg')
          .attr('width', vw)
          .attr('height', vh)
          .style('display','block');

        const defs = svg.append('defs');
        defs.append('filter').attr('id','cardShadow').attr('height','130%')
          .append('feDropShadow').attr('dx',0).attr('dy',2).attr('stdDeviation',1.2).attr('flood-opacity',0.10);

        const g = svg.append('g');

        const zoom = d3.zoom().scaleExtent([0.5, 3]).on('zoom', (ev)=> g.attr('transform', ev.transform));
        svg.call(zoom).on('dblclick.zoom', null);

        // „É¨„Éº„É≥
        const lanes = g.append('g');
        STAGES.forEach((st,idx)=>{
          lanes.append('rect')
            .attr('x', sidePad + idx*colW).attr('y', 0).attr('width', colW).attr('height', contentH)
            .attr('fill', idx%2? 'var(--lane)' : '#fff').attr('stroke','var(--border)')
            .style('opacity', stageFilter[st] ? 1 : 0.25);
          lanes.append('text').attr('x', sidePad + idx*colW + 10).attr('y', 24).attr('class','lane-label').text(st);
          lanes.append('text').attr('x', sidePad + (idx+1)*colW - 10).attr('y', 24).attr('font-size', 11).attr('fill', '#667085').attr('text-anchor','end')
            .text(`${(NODES[st]||[]).length} nodes`);
        });

        const bezierC = (a,b,k=0.5)=>[{x:a.x+(b.x-a.x)*k, y:a.y},{x:b.x-(b.x-a.x)*k, y:b.y}];

        // „Ç®„ÉÉ„Ç∏
        const edgesG = g.append('g');
        const edges = SCENARIOS.flatMap(s=>{
          const pts = STAGES.map(st=>({ stage:st, nid:s.path[st], p: positions[s.path[st]] }));
          const segs = [];
          for(let i=0;i<pts.length-1;i++){
            const a = pts[i].p, b = pts[i+1].p;
            const [c1,c2] = bezierC(a,b,0.5);
            segs.push({ key:`${s.id}-${i}`, sId:s.id, from:a, to:b, c1, c2, toStage:pts[i+1].stage });
          }
          return segs;
        });

        edgesG.selectAll('path').data(edges).enter().append('path')
          .attr('d', d=> `M ${d.from.x+100},${d.from.y+14} C ${d.c1.x+100},${d.c1.y+14} ${d.c2.x-100},${d.c2.y+14} ${d.to.x+10},${d.to.y+14}`)
          .attr('fill','none')
          .attr('stroke', d=> d.sId===highlightId ? '#111' : '#98a2b3')
          .attr('stroke-width', d=> d.sId===highlightId ? 4 : 2)
          .attr('stroke-opacity', d=> d.sId===highlightId ? 0.95 : otherAlpha)
          .attr('stroke-dasharray', d=> d.toStage==='Customer' ? '6 7' : '0')
          .style('cursor','pointer')
          .on('click', (ev, d)=>{
            window.dispatchEvent(new CustomEvent('nf-select', { detail:{type:'scenario', id:d.sId} }));
          });

        // „Éé„Éº„Éâ
        const nodesG = g.append('g');
        const allNodes = STAGES.flatMap(st=> (NODES[st]||[]).map(n=> ({...n, stage:st})));
        const matchQuery = n=>{
          if(!query.trim()) return true;
          const q = query.toLowerCase();
          return n.name.toLowerCase().includes(q) || n.id.toLowerCase().includes(q);
        };

        const cellW = 210, cellH = 40;
        const nd = nodesG.selectAll('g.node').data(allNodes, d=>d.id).enter().append('g')
          .attr('transform', d=> `translate(${positions[d.id].x},${positions[d.id].y})`)
          .style('opacity', d=>(matchQuery(d) && stageFilter[d.stage]) ? 1 : 0.2)
          .style('cursor','pointer')
          .on('click', (ev, d)=>{
            window.dispatchEvent(new CustomEvent('nf-select', { detail:{type:'node', id:d.id, stage:d.stage} }));
          })
          .call(d3.drag()
            .on('start', function(){ d3.select(this).raise(); })
            .on('drag', function(event, d){
              const pos = positions[d.id];
              pos.y = Math.max(topPad, Math.min(contentH- cellH - 10, pos.y + event.dy));
              d3.select(this).attr('transform', `translate(${pos.x},${pos.y})`);
              edgesG.selectAll('path').attr('d', function(ed){
                if(ed.from===pos || ed.to===pos){
                  const a = ed.from===pos ? pos : ed.from;
                  const b = ed.to===pos   ? pos : ed.to;
                  const [c1,c2] = bezierC(a,b,0.5);
                  return `M ${a.x+100},${a.y+14} C ${c1.x+100},${c1.y+14} ${c2.x-100},${c2.y+14} ${b.x+10},${b.y+14}`;
                }
                return d3.select(this).attr('d');
              });
            })
          );

        nd.append('rect').attr('x', -6).attr('y', -6).attr('rx', 10).attr('ry', 10)
          .attr('width', cellW).attr('height', cellH).attr('fill', '#fff').attr('stroke', '#e6e8ef').attr('filter', 'url(#cardShadow)');
        nd.append('text').attr('x', 10).attr('y', 15).attr('font-size', 16).text(d=> ICONS[d.stage] || '‚Ä¢');
        nd.append('text').attr('x', 32).attr('y', 15).attr('class','node-title').text(d=> d.name);
        nd.append('text').attr('x', 32).attr('y', 30).attr('class','node-sub').text(d=> d.id);
        nd.append('circle').attr('cx', cellW-14).attr('cy', 16).attr('r', 5).attr('fill', d=> COLORS[d.stage]).attr('opacity', 0.9);
        nd.append('title').text(d=> `${d.stage}\n${d.name}\n${d.id}`);

        // --- „Ç™„Éº„Éà„Éï„Ç£„ÉÉ„ÉàÔºàÂàùÊúü/„É™„Çµ„Ç§„Ç∫ÊôÇÔºâ ---
        const fitAll = ()=>{
          const bbox = g.node().getBBox();
          const pad = 24;
          const vw2 = +svg.attr('width'), vh2 = +svg.attr('height');
          const scale = Math.max(0.5, Math.min(3, Math.min(
            (vw2 - pad*2) / bbox.width,
            (vh2 - pad*2) / bbox.height
          )));
          const translateX = (vw2 - bbox.width*scale)/2 - bbox.x*scale;
          const translateY = (vh2 - bbox.height*scale)/2 - bbox.y*scale;
          const next = d3.zoomIdentity.translate(translateX, translateY).scale(scale);
          svg.call(zoom.transform, next);
        };
        fitAll();

        // „É™„Çµ„Ç§„Ç∫„ÅßÂÜç„Éï„Ç£„ÉÉ„ÉàÔºàÊû†„ÅÆ‰∏ãËæ∫„Éâ„É©„ÉÉ„Ç∞„Å´ËøΩÂæìÔºâ
        const ro = new ResizeObserver(entries=>{
          for(const entry of entries){
            const nw = entry.contentRect.width;
            const nh = entry.contentRect.height;
            if(nw && nh){
              svg.attr('width', nw).attr('height', nh);
              fitAll();
            }
          }
        });
        ro.observe(wrapEl);

        // Â§ñÈÉ®„Ç∫„Éº„É†„Éú„Çø„É≥
        const handleZoomCmd = (e)=>{
          const action = e.detail?.action;
          if(!action) return;
          if(action==='in') svg.transition().duration(200).call(zoom.scaleBy, 1.2);
          else if(action==='out') svg.transition().duration(200).call(zoom.scaleBy, 1/1.2);
          else if(action==='reset') svg.transition().duration(200).call(zoom.transform, d3.zoomIdentity);
          else if(action==='fit') fitAll();
        };
        window.addEventListener('nf-diagram-zoom', handleZoomCmd);

        return ()=>{
          window.removeEventListener('nf-diagram-zoom', handleZoomCmd);
          ro.disconnect();
        };
      }, [highlightId, density, otherAlpha, query, stageFilter]);

      return <div className="diagram-shell" ref={wrapRef}></div>;
    }

    // ===== Leaflet Âú∞Âõ≥ =====
    function SCMap({highlightId='SC-001', showAllNodes, showAllPaths}){
      const mapRef = useRef(null);
      const layerRefs = useRef([]); const moversRef = useRef([]);
      const [animating, setAnimating] = useState(true);

      useEffect(()=>{ if(!mapRef.current){
        const map = L.map('sc-map', { zoomControl:true }).setView([35.6, 139.7], 6);
        L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png', {
          attribution: '&copy; <a href="https://www.gsi.go.jp/" target="_blank">ÂõΩÂúüÂú∞ÁêÜÈô¢</a>'
        }).addTo(map);
        mapRef.current = map;
      } },[]);

      const lerp=(a,b,t)=>a+(b-a)*t;
      const interp=(p1,p2,t)=>[lerp(p1[0],p2[0],t), lerp(p1[1],p2[1],t)];

      const clearLayers = ()=>{
        const map = mapRef.current; if(!map) return;
        layerRefs.current.forEach(l => map.removeLayer(l));
        moversRef.current.forEach(m => { if(m.timer) clearInterval(m.timer); if(m.marker) map.removeLayer(m.marker); });
        layerRefs.current = []; moversRef.current = [];
      };

      useEffect(()=>{
        const map = mapRef.current; if(!map) return;
        clearLayers();
        const bounds = L.latLngBounds([]);

        if(showAllNodes){
          Object.entries(NODES).forEach(([stage, list])=>{
            list.forEach(n=>{
              const marker = L.circleMarker([n.lat, n.lng], {
                radius:5, weight:1.5, color:COLORS[stage], fillColor:COLORS[stage], fillOpacity:0.9, opacity:0.7
              }).addTo(map).bindPopup(`<b>${stage}</b><br/>${n.name}<br/>${n.id}`);
              marker.on('click', ()=> window.dispatchEvent(new CustomEvent('nf-select', { detail:{type:'node', id:n.id, stage:stage} })));
              layerRefs.current.push(marker); bounds.extend([n.lat, n.lng]);
            });
          });
        }

        const drawPath = (s, thick=false)=>{
          const pts = STAGES.map(st=>{
            const id = s.path[st]; const node = NODES[st].find(n=> n.id===id);
            return [node.lat, node.lng];
          });

          // Âå∫ÈñìÁ∑ö
          for (let i = 0; i < pts.length - 1; i++) {
            const color = COLORS[STAGES[i+1]];
            const pl = L.polyline([pts[i], pts[i+1]], {
              color, weight: thick?5:2, opacity: thick?0.95:0.5, dashArray: i===4 ? '6 8' : null
            }).addTo(map).on('click', ()=> window.dispatchEvent(new CustomEvent('nf-select', { detail:{type:'scenario', id:s.id} })));
            layerRefs.current.push(pl);
          }

          // ÈÄ≤Êçó„Ç§„É≥„Ç∏„Ç±„Éº„ÇøÔºàÈÖçÈÄÅ‰∏≠„ÅÆ„ÅøÔºâ
          if(s.status!=='delivered'){
            const segs = [];
            for (let i = 0; i < pts.length - 1; i++) segs.push([pts[i], pts[i + 1]]);

            let p = Math.max(0, Math.min(0.999, s.progress ?? 0));
            let idx = Math.min(segs.length-1, Math.floor(p * segs.length));
            let t0 = (p * segs.length) - Math.floor(p * segs.length);

            const mover = L.marker(interp(segs[idx][0], segs[idx][1], t0), {
              icon: L.divIcon({ className:'', iconAnchor:[8,8], html:`<div style="width:14px;height:14px;border-radius:50%;background:#111;box-shadow:0 0 0 3px rgba(0,0,0,.15);"></div>` })
            }).addTo(map);
            mover.bindTooltip(`ÈÖçÈÄÅ‰∏≠: ${s.id} / ${s.sku} / ${s.qty}ÂÄã`);
            mover.on('click', ()=> window.dispatchEvent(new CustomEvent('nf-select', { detail:{type:'scenario', id:s.id} })));
            layerRefs.current.push(mover);

            const totalMs = 20000, stepMs = 60;
            const timer = setInterval(()=>{
              if(!animating) return;
              t0 += stepMs / (totalMs / segs.length);
              if(t0 >= 1){
                idx += 1; t0 = 0;
                if(idx >= segs.length){ mover.setLatLng(pts[pts.length-1]); return; }
              }
              const [A,B] = segs[idx];
              mover.setLatLng(interp(A,B,t0));
            }, stepMs);
            moversRef.current.push({ marker:mover, timer });
          }
        };

        if(showAllPaths){ SCENARIOS.forEach(s=> drawPath(s, false)); }
        const hl = SCENARIOS.find(s=> s.id===highlightId) || SCENARIOS[0];
        drawPath(hl, true);

        if(bounds.isValid()) map.fitBounds(bounds.pad(0.25));
        return ()=> clearLayers();
      }, [highlightId, animating, showAllNodes, showAllPaths]);

      return (
        <Box>
          <Stack direction="row" spacing={2} alignItems="center" sx={{mb:1}}>
            <FormControlLabel control={<Switch checked={animating} onChange={e=>setAnimating(e.target.checked)} />} label="ËøΩË∑°(ÂÜçÁîü/ÂÅúÊ≠¢)"/>
          </Stack>
          <div id="sc-map" style={{width:'100%', height:'70vh'}}></div>
        </Box>
      );
    }

    // ===== Êé®Â•®„ÉÜ„Éº„Éñ„É´ =====
    const RECO = [
      {id:1, sku:"SKU-1001", name:"„Çπ„Éù„Éº„ÉÑ„Éâ„É™„É≥„ÇØ 500ml", from:"MfrWH(ÂçÉËëâÂåó)", to:"OwnDC(Ë∂≥Á´ã)", qty:240, gross:320000, cost:38000, reason:"‰∫àÊ∏¨+42% / Âú®Â∫´Êó•Êï∞1.8‚ÜíÁõÆÊ®ô7", conf:"High", deadline:"2025-10-12"},
      {id:2, sku:"SKU-2002", name:"„Ç´„ÉÉ„ÉóÈ∫∫ ÈÜ§Ê≤π", from:"OwnDC(Â∞ºÂ¥é)", to:"Â∫óËàó(Á•ûÊà∏‰∏âÂÆÆ)", qty:180, gross:210000, cost:62000, reason:"„Éó„É≠„É¢Ââç / Ê¨†ÂìÅ„É™„Çπ„ÇØ34%", conf:"Med", deadline:"2025-10-11"},
      {id:3, sku:"SKU-3003", name:"„ÉÅ„Éß„Ç≥„Éê„Éº", from:"Factory(Â∑ùÂ¥é)", to:"MfrWH(ÂçÉËëâÂåó)", qty:400, gross:270000, cost:42000, reason:"ÈÉΩÂøÉÂÇ¨‰∫ã / ÂºæÂäõÈ´ò", conf:"High", deadline:"2025-10-13"},
    ];
    function Recommendations(){
      const [rows,setRows] = useState(RECO);
      const [sel,setSel] = useState([]);
      const [toast,setToast] = useState(null);
      const all = sel.length===rows.length && rows.length>0;
      const qty = sel.reduce((a,id)=> a + (rows.find(r=>r.id===id)?.qty||0), 0);
      const net = sel.reduce((a,id)=> { const r=rows.find(x=>x.id===id); return a + ((r?.gross||0)-(r?.cost||0)); }, 0);
      const approve = ()=>{ setRows(p=> p.map(r=> sel.includes(r.id)? {...r, status:"ÊâøË™ç"}:r)); setSel([]); setToast({type:'success',msg:'ÈÅ∏Êäû„Åó„ÅüÊèêÊ°à„ÇíÊâøË™ç„Åó„Åæ„Åó„Åü„ÄÇ'}); };
      const reject = ()=>{ setRows(p=> p.filter(r=> !sel.includes(r.id))); setSel([]); setToast({type:'info',msg:'ÈÅ∏Êäû„Åó„ÅüÊèêÊ°à„ÇíÂç¥‰∏ã„Åó„Åæ„Åó„Åü„ÄÇ'}); };
      const Conf = ({c})=> <Chip size="small" variant="outlined" color={c==="High"?"success":c==="Med"?"warning":"default"} label={c}/>;
      return (
        <TableContainer component={Paper} className="card" elevation={0}>
          <Table size="small">
            <TableHead>
              <TableRow>
                <TableCell padding="checkbox">
                  <Checkbox checked={all} indeterminate={!!sel.length && !all} onChange={e=> setSel(e.target.checked? rows.map(r=>r.id): [])}/>
                </TableCell>
                <TableCell>SKU / ÂïÜÂìÅÂêç</TableCell>
                <TableCell>ÁßªÂãïÔºàÈúÄË¶Å ‚Üê ‰æõÁµ¶Ôºâ</TableCell>
                <TableCell align="right">Êï∞Èáè</TableCell>
                <TableCell>Ê†πÊã†</TableCell>
                <TableCell>‰ø°È†ºÂ∫¶</TableCell>
                <TableCell align="right">Â£≤‰∏ä/„Ç≥„Çπ„Éà/Á¥îÂäπÊûú</TableCell>
                <TableCell>ÊúüÈôê</TableCell>
                <TableCell>„Çπ„ÉÜ„Éº„Çø„Çπ</TableCell>
              </TableRow>
            </TableHead>
            <TableBody>
              {rows.map(r=>(
                <TableRow key={r.id} hover>
                  <TableCell padding="checkbox">
                    <Checkbox checked={sel.includes(r.id)} onChange={()=> setSel(p=> p.includes(r.id)? p.filter(x=>x!==r.id): [...p, r.id])}/>
                  </TableCell>
                  <TableCell><b>{r.sku}</b><div style={{fontSize:12,color:'#667085'}}>{r.name}</div></TableCell>
                  <TableCell><span className="pill">{r.to}</span> ‚Üê <span className="pill">{r.from}</span></TableCell>
                  <TableCell align="right" className="mono">{r.qty.toLocaleString()}</TableCell>
                  <TableCell><Tooltip title={r.reason}><span>{r.reason}</span></Tooltip></TableCell>
                  <TableCell><Conf c={r.conf}/></TableCell>
                  <TableCell align="right" className="mono">{currency(r.gross)} / {currency(r.cost)} / <b>{currency(r.gross-r.cost)}</b></TableCell>
                  <TableCell className="mono">{r.deadline}</TableCell>
                  <TableCell>
                    {r.status
                      ? <Chip size="small" color="success" label={r.status}/>
                      : <Chip size="small" variant="outlined" label="ÊèêÊ°à"/>}
                  </TableCell>
                </TableRow>
              ))}
            </TableBody>
          </Table>
          <Box sx={{px:2, py:1.2, display:'flex', justifyContent:'space-between', alignItems:'center', borderTop:'1px solid var(--border)'}}>
            <Typography variant="body2" color="text.secondary">
              ÈÅ∏ÊäûÔºö<b>{sel.length}</b>‰ª∂ / Êï∞ÈáèÂêàË®àÔºö<b className="mono">{qty.toLocaleString()}</b> / Á¥îÂäπÊûúÔºö<b className="mono">{currency(net)}</b>
            </Typography>
            <Stack direction="row" spacing={1}>
              <Button size="small" variant="contained" disabled={!sel.length} onClick={approve}>
                <span className="material-icons" style={{fontSize:18, verticalAlign:'-4px', marginRight:4}}>done_all</span>ÊâøË™ç
              </Button>
              <Button size="small" color="error" disabled={!sel.length} onClick={reject}>
                <span className="material-icons" style={{fontSize:18, verticalAlign:'-4px', marginRight:4}}>block</span>Âç¥‰∏ã
              </Button>
            </Stack>
          </Box>
          <Snackbar open={!!toast} autoHideDuration={2200} onClose={()=>setToast(null)}>
            {toast && <Alert severity={toast.type} onClose={()=>setToast(null)}>{toast.msg}</Alert>}
          </Snackbar>
        </TableContainer>
      );
    }

    // ===== Âè≥Ë©≥Á¥∞„Éë„Éç„É´ =====
    function RightDetails({open, onClose, selection}){
      const [tab, setTab] = useState(0);
      const scenario = selection?.type==='scenario'
        ? SCENARIOS.find(s=> s.id===selection.id) : (selection?.scenarioId ? SCENARIOS.find(s=> s.id===selection.scenarioId) : null);
      const node = selection?.type==='node'
        ? (selection.stage ? (NODES[selection.stage]||[]).find(n=> n.id===selection.id) : null) : null;

      const title = selection
        ? selection.type==='node' ? `${selection.stage} / ${node?.name||selection.id}` : `„Ç∑„Éä„É™„Ç™ ${scenario?.id||selection.id}`
        : 'Ë©≥Á¥∞';
      const subtitle = selection
        ? selection.type==='node' ? node?.id : `${scenario?.sku||''} / Êï∞Èáè ${scenario?.qty||''}`
        : 'Âõ≥Âºè/Âú∞Âõ≥„ÅÆË¶ÅÁ¥†„Çí„ÇØ„É™„ÉÉ„ÇØ„Åô„Çã„Åã„ÄÅÂè≥‰∏ä„ÅÆ ‚ìò „Åã„ÇâÈñã„Åç„Åæ„Åô';

      return (
        <Drawer anchor="right" variant="temporary" open={open} onClose={onClose}
          sx={{ '& .MuiDrawer-paper':{ width:'360px' } }}>
          <Box sx={{width:360, p:2}}>
            <Typography variant="subtitle1" sx={{fontWeight:700, mb:0.5}}>{title}</Typography>
            <Typography variant="caption" sx={{color:'#667085'}}>{subtitle}</Typography>
            <Divider sx={{my:1.5}}/>
            <Tabs value={tab} onChange={(_,v)=>setTab(v)} size="small">
              <Tab label="Ê¶ÇË¶Å" />
              <Tab label="„Éà„É¨„Éº„Çπ" />
            </Tabs>

            {tab===0 && (
              <Box sx={{mt:2}}>
                {scenario && (
                  <>
                    <Stack direction="row" spacing={1} alignItems="center">
                      <Avatar sx={{width:28, height:28, fontSize:14, bgcolor:'#1f3aa5'}}>SC</Avatar>
                      <Typography variant="body2"><b>{scenario.id}</b> / {scenario.sku}</Typography>
                    </Stack>
                    <Stack sx={{mt:1}} spacing={1}>
                      <Typography variant="caption">ÈÄ≤Êçó</Typography>
                      <LinearProgress variant="determinate" value={(scenario.progress||0)*100}/>
                      <Typography variant="caption" className="mono">{Math.round((scenario.progress||0)*100)}% / ETA {scenario.eta}</Typography>
                    </Stack>
                    <Divider sx={{my:1.5}}/>
                    <Typography variant="caption">„É´„Éº„Éà</Typography>
                    <Stack direction="row" sx={{flexWrap:'wrap', gap:0.5, mt:1}}>
                      {STAGES.map(st=>{
                        const nid = scenario.path[st];
                        const n = (NODES[st]||[]).find(x=> x.id===nid);
                        return <span key={st} className="pill">{st}: {n?.name||nid}</span>;
                      })}
                    </Stack>
                  </>
                )}
                {node && (
                  <>
                    <Divider sx={{my:1.5}}/>
                    <Typography variant="caption">„Éé„Éº„ÉâÊÉÖÂ†±</Typography>
                    <Stack spacing={0.5} sx={{mt:1}}>
                      <Typography variant="body2"><b>{node.name}</b></Typography>
                      <Typography variant="caption" className="mono">{node.id}</Typography>
                      <Typography variant="caption">Á∑ØÂ∫¶ÁµåÂ∫¶: {node.lat}, {node.lng}</Typography>
                    </Stack>
                  </>
                )}
              </Box>
            )}

            {tab===1 && scenario && (
              <Box sx={{mt:2}}>
                {STAGES.map((st)=> {
                  const nid = scenario.path[st];
                  const n = (NODES[st]||[]).find(x=> x.id===nid);
                  return (
                    <Stack key={st} direction="row" spacing={1} alignItems="center" sx={{mb:1}}>
                      <Avatar sx={{width:24, height:24, fontSize:14, bgcolor:COLORS[st]}}>{ICONS[st]}</Avatar>
                      <Typography variant="body2" sx={{flex:1}}>{st}</Typography>
                      <Typography variant="caption" sx={{color:'#667085'}}>{n?.name||nid}</Typography>
                    </Stack>
                  );
                })}
              </Box>
            )}
          </Box>
        </Drawer>
      );
    }

    // ===== „ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„ÉâÔºàÂèØË¶ñÂåñ+Êé®Â•® „Çí1„Éö„Éº„Ç∏SPAÔºâ =====
    function Dashboard(){
      const [viz, setViz] = useState('diagram');
      const [highlightId, setHighlightId] = useState('SC-001');

      // „Éï„Ç£„É´„Çø„ÉºÁä∂ÊÖã
      const [showFilters, setShowFilters] = useState(true);
      const [stageFilter, setStageFilter] = useState(Object.fromEntries(STAGES.map(s=>[s,true])));
      const [search, setSearch] = useState('');
      const [otherAlpha, setOtherAlpha] = useState(0.28);
      const [density, setDensity] = useState('standard');
      const [showMapNodes, setShowMapNodes] = useState(true);
      const [showMapPaths, setShowMapPaths] = useState(true);

      // Âè≥Ë©≥Á¥∞
      const [detailOpen, setDetailOpen] = useState(false);
      const [selection, setSelection] = useState(null);
      useEffect(()=>{
        const onSel = (e)=>{ setSelection(e.detail); setDetailOpen(true); };
        window.addEventListener('nf-select', onSel);
        return ()=> window.removeEventListener('nf-select', onSel);
      },[]);

      const openDetails = ()=> setDetailOpen(true);

      const topRight = (
        <Stack direction="row" spacing={1} alignItems="center">
          <Select size="small" value={highlightId} onChange={e=>setHighlightId(e.target.value)} sx={{minWidth:120}}>
            {SCENARIOS.map(s=> <MenuItem key={s.id} value={s.id}>{s.id}</MenuItem>)}
          </Select>
          <ToggleButtonGroup value={viz} exclusive onChange={(_,v)=> v && setViz(v)} size="small">
            <ToggleButton value="diagram">Âõ≥Âºè</ToggleButton>
            <ToggleButton value="map">Âú∞Âõ≥</ToggleButton>
          </ToggleButtonGroup>
          <Button size="small" onClick={()=>setShowFilters(f=>!f)} startIcon={<span className="material-icons">tune</span>}>
            {showFilters?'„Éï„Ç£„É´„Çø„Éº„ÇíÈö†„Åô':'„Éï„Ç£„É´„Çø„Éº„ÇíË°®Á§∫'}
          </Button>
          <IconButton title="Ë©≥Á¥∞„Éë„Éç„É´„ÇíÈñã„Åè" onClick={openDetails} aria-label="open details">
            <span className="material-icons">info</span>
          </IconButton>
          <Button size="small" href="#section-reco">Êé®Â•®„Å∏</Button>
        </Stack>
      );

      return (
        <Container maxWidth={false} sx={{py:2, px:2}}>
          <Panel
            id="section-top"
            title={`„Çµ„Éó„É©„Ç§„ÉÅ„Çß„Éº„É≥„ÅÆÂÖ®‰ΩìÂÉèÔºà${viz==='diagram'?'Á∞°ÊòìÂõ≥Âºè':'Âú∞Âõ≥'}Ôºâ`}
            subtitle="Raw ‚Üí Factory ‚Üí MfrWH ‚Üí OwnDC ‚Üí Store ‚Üí Customer"
            defaultOpen={true}
            right={topRight}
          >
            {/* Êäò„ÇäÁï≥„Åø„Éï„Ç£„É´„Çø„Éº */}
            <Collapse in={showFilters} timeout="auto">
              <Paper variant="outlined" sx={{p:1.5, mb:1.5, borderRadius:2}}>
                <Stack direction={{xs:'column', lg:'row'}} spacing={2} alignItems={{xs:'stretch', lg:'center'}}>
                  <TextField size="small" placeholder="„Éé„Éº„ÉâÊ§úÁ¥¢ÔºàÂêçÁß∞/IDÔºâ" value={search} onChange={e=>setSearch(e.target.value)} sx={{minWidth:280}}/>
                  <Stack direction="row" spacing={1} flexWrap="wrap" alignItems="center">
                    {STAGES.map(st=>(
                      <FormControlLabel key={st}
                        control={<Checkbox checked={stageFilter[st]} onChange={e=>setStageFilter(p=>({...p,[st]:e.target.checked}))} />}
                        label={st}/>
                    ))}
                  </Stack>
                  {viz==='diagram' && (
                    <Stack direction={{xs:'column', sm:'row'}} spacing={2} alignItems="center">
                      <Stack direction="row" spacing={1.25} alignItems="center">
                        <span className="material-icons">density_medium</span>
                        <Typography variant="body2" sx={{minWidth:64}}>Ë°®Á§∫ÂØÜÂ∫¶</Typography>
                        <ToggleButtonGroup size="small" exclusive value={density} onChange={(_,v)=> v && setDensity(v)}>
                          <ToggleButton value="comfortable">Âø´ÈÅ©</ToggleButton>
                          <ToggleButton value="standard">Ê®ôÊ∫ñ</ToggleButton>
                          <ToggleButton value="compact">ÂØÜ</ToggleButton>
                        </ToggleButtonGroup>
                      </Stack>
                      <Stack direction="row" spacing={1.25} alignItems="center">
                        <span className="material-icons">opacity</span>
                        <Typography variant="body2" sx={{minWidth:86}}>‰ªñ„Ç∑„Éä„É™„Ç™</Typography>
                        <Slider size="small" min={0.1} max={0.6} step={0.02} value={otherAlpha} onChange={(_,v)=>setOtherAlpha(v)} sx={{width:200}}/>
                        <Typography variant="body2" className="mono">{Math.round(otherAlpha*100)}%</Typography>
                      </Stack>
                    </Stack>
                  )}
                  {viz==='map' && (
                    <Stack direction={{xs:'column', sm:'row'}} spacing={2} alignItems="center">
                      <FormGroup row>
                        <FormControlLabel control={<Switch checked={showMapNodes} onChange={e=>setShowMapNodes(e.target.checked)} />} label="ÂÖ®„Éé„Éº„Éâ"/>
                        <FormControlLabel control={<Switch checked={showMapPaths} onChange={e=>setShowMapPaths(e.target.checked)} />} label="ÂÖ®„Ç∑„Éä„É™„Ç™Á∑ö"/>
                      </FormGroup>
                    </Stack>
                  )}
                </Stack>
              </Paper>
            </Collapse>

            {/* ÂèØË¶ñÂåñÊú¨‰ΩìÔºöÂõ≥Âºè or Âú∞Âõ≥ */}
            {viz==='diagram' ? (
              <div className="diagram-wrap">
                <SupplyDiagramD3
                  highlightId={highlightId}
                  density={density}
                  otherAlpha={otherAlpha}
                  query={search}
                  stageFilter={stageFilter}
                />
                {/* Âõ≥Âºè„Ç®„É™„Ç¢Ëøë„Åè„ÅÆ„Ç∫„Éº„É†UIÔºàÂè≥‰∏ãÔºâ */}
                <div className="zoom-ui" aria-label="diagram zoom controls">
                  <IconButton size="small" title="Êã°Â§ß" onClick={()=>window.dispatchEvent(new CustomEvent('nf-diagram-zoom',{detail:{action:'in'}}))}>
                    <span className="material-icons">zoom_in</span>
                  </IconButton>
                  <IconButton size="small" title="Á∏ÆÂ∞è" onClick={()=>window.dispatchEvent(new CustomEvent('nf-diagram-zoom',{detail:{action:'out'}}))}>
                    <span className="material-icons">zoom_out</span>
                  </IconButton>
                  <IconButton size="small" title="ÂÖ®‰ΩìË°®Á§∫" onClick={()=>window.dispatchEvent(new CustomEvent('nf-diagram-zoom',{detail:{action:'fit'}}))}>
                    <span className="material-icons">fullscreen</span>
                  </IconButton>
                  <IconButton size="small" title="„É™„Çª„ÉÉ„Éà" onClick={()=>window.dispatchEvent(new CustomEvent('nf-diagram-zoom',{detail:{action:'reset'}}))}>
                    <span className="material-icons">restart_alt</span>
                  </IconButton>
                </div>
              </div>
            ) : (
              <SCMap highlightId={highlightId} showAllNodes={showMapNodes} showAllPaths={showMapPaths}/>
            )}
          </Panel>

          <Panel id="section-reco" title="Need Fit Balancer ‚Äî Êé®Â•®Ë™øÊï¥" subtitle="ÈúÄË¶Å‚Üê‰æõÁµ¶„ÅÆÂÜçÈÖçÁΩÆÊèêÊ°à‰∏ÄË¶ß" defaultOpen={true}>
            <Recommendations/>
          </Panel>

          {/* Âè≥Ë©≥Á¥∞Ôºà„Ç¢„Ç§„Ç≥„É≥„Åß„ÇÇÈñã„ÅèÔºâ */}
          <RightDetails open={detailOpen} onClose={()=>setDetailOpen(false)} selection={selection}/>
        </Container>
      );
    }

    // ===== App =====
    function App(){
      const [detailOpen, setDetailOpen] = useState(false);
      const [selection, setSelection] = useState(null);

      return (
        <ThemeProvider theme={theme}>
          <Box>
            <AppBar position="sticky" elevation={0} sx={{borderBottom:"1px solid var(--border)", background:"#fff", color:"inherit"}}>
              <Toolbar>
                <Typography variant="h6" sx={{flex:1, fontWeight:700}}>
                  <span className="material-icons balance-icon">balance</span>
                  Need Fit Balancer
                </Typography>
                <Button size="small" href="#section-top">ÂèØË¶ñÂåñ</Button>
                <Button size="small" href="#section-reco">Êé®Â•®</Button>
                <IconButton title="Ë©≥Á¥∞„Éë„Éç„É´„ÇíÈñã„Åè" onClick={()=>setDetailOpen(true)} aria-label="open details">
                  <span className="material-icons">info</span>
                </IconButton>
              </Toolbar>
            </AppBar>

            <Dashboard/>

            {/* AppBar„Åã„ÇâÈñã„ÅÑ„ÅüÂ†¥Âêà„ÅÆÁ©∫„ÅÆË©≥Á¥∞Ôºà„Éí„É≥„ÉàË°®Á§∫Áî®Ôºâ */}
            <RightDetails open={detailOpen} onClose={()=>setDetailOpen(false)} selection={selection}/>
          </Box>
        </ThemeProvider>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
  </script>
</body>
</html>
