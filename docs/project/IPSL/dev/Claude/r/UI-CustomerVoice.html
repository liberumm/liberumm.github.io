<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>スーパー商品レビュー（MUI×React×Babel / Feed + Share + Review Upload + Floating Menu）</title>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700;900&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons" />

  <style>
    html, body { height: 100%; }
    body { margin: 0; }

    /* Backgrounds: switched by body class */
    body.bg-standard{
      background: linear-gradient(180deg, #f4fff5 0%, #f7fbff 100%);
      background-attachment: fixed;
    }
    body.bg-dark{
      background:
        radial-gradient(circle at 15% 20%, rgba(0,200,83,.20) 0 120px, transparent 200px),
        radial-gradient(circle at 82% 70%, rgba(255,77,166,.14) 0 140px, transparent 230px),
        linear-gradient(135deg, #0b1020 0%, #0a1a12 50%, #111827 100%);
      background-attachment: fixed;
    }
    body.bg-minimal{
      background: linear-gradient(180deg, #ffffff 0%, #fbfbfd 100%);
      background-attachment: fixed;
    }
    body.bg-sakura{
      background:
        radial-gradient(circle at 18% 18%, rgba(255,183,197,.30) 0 12px, transparent 13px),
        radial-gradient(circle at 62% 28%, rgba(255,140,168,.20) 0 10px, transparent 11px),
        radial-gradient(circle at 38% 74%, rgba(255,220,232,.45) 0 14px, transparent 15px),
        linear-gradient(135deg, #fff7fa 0%, #fff 45%, #f7fbff 100%);
      background-attachment: fixed;
    }

    .appRoot { min-height: 100vh; padding-bottom: 92px; } /* space for bottom floating menu */

    /* Card hover */
    .glowCard{
      transition: transform .18s ease, box-shadow .18s ease;
      will-change: transform, box-shadow;
    }
    .glowCard:hover{
      transform: translateY(-5px) rotate(-.18deg);
      box-shadow: 0 18px 45px rgba(0,0,0,.10);
    }
    body.bg-dark .glowCard:hover{
      box-shadow: 0 22px 60px rgba(0,0,0,.55);
    }

    /* ===== Feed layout helpers ===== */
    .feedWrap{
      display: grid;
      gap: 14px;
    }

    /* ===== Bottom Floating Menu ===== */
    .bottomDock{
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      display: flex;
      justify-content: center;
      pointer-events: none;
      padding: 10px 10px 16px;
      z-index: 1400;
    }
    .bottomDockInner{
      pointer-events: auto;
      width: min(920px, calc(100% - 12px));
      border-radius: 999px;
      padding: 8px 10px;
      backdrop-filter: blur(14px);
      background: rgba(255,255,255,.72);
      border: 1px solid rgba(15,23,42,.10);
      box-shadow: 0 20px 55px rgba(0,0,0,.16);
      display: flex;
      gap: 10px;
      align-items: center;
      justify-content: space-between;
    }
    body.bg-dark .bottomDockInner{
      background: rgba(17,24,39,.62);
      border-color: rgba(255,255,255,.10);
      box-shadow: 0 24px 70px rgba(0,0,0,.45);
    }
    .dockGroup{
      display:flex;
      gap: 10px;
      align-items:center;
      flex-wrap: wrap;
    }
  </style>
</head>

<body class="bg-standard">
  <div id="root"></div>

  <!-- React 18 UMD -->
  <script crossorigin src="https://unpkg.com/react@18.3.1/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18.3.1/umd/react-dom.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-is@18.3.1/umd/react-is.development.js"></script>

  <!-- Emotion (MUI default styling engine) -->
  <script crossorigin src="https://unpkg.com/@emotion/react@11.11.4/dist/emotion-react.umd.min.js"></script>
  <script crossorigin src="https://unpkg.com/@emotion/styled@11.14.1/dist/emotion-styled.umd.min.js"></script>

  <!-- MUI v5 UMD -->
  <script crossorigin src="https://unpkg.com/@mui/material@5.18.0/umd/material-ui.development.js"></script>

  <!-- Babel -->
  <script src="https://unpkg.com/@babel/standalone@7.24.7/babel.min.js"></script>

  <script type="text/babel">
    const {
      AppBar, Toolbar, Typography, Container, Box, Grid, Card, CardActionArea, CardMedia, CardContent,
      Chip, Stack, TextField, InputAdornment, Icon, Rating, Select, MenuItem, FormControl, InputLabel,
      Drawer, Divider, Button, Dialog, DialogTitle, DialogContent, DialogActions, List, ListItem, ListItemText,
      useMediaQuery, CssBaseline, Badge, Tooltip, ListItemIcon, Alert, Snackbar
    } = MaterialUI;

    const { createTheme, ThemeProvider } = MaterialUI;

    // ---- Mock supermarket products ----
    const PRODUCTS = [
      {
        id: "m1",
        name: "北海道牛乳 1L",
        brand: "北の牧場",
        category: "乳製品",
        price: 258,
        rating: 4.6,
        reviewCount: 512,
        tags: ["定番", "濃厚"],
        img: "https://images.unsplash.com/photo-1563636619-e9143da7973b?auto=format&fit=crop&w=1200&q=80",
        summary: "コクがあって飲みやすい。シリアルにも合う。",
        highlights: ["コクが強い", "後味すっきり", "料理にも使いやすい"],
        reviews: [
          { user: "ゆい", stars: 5, text: "毎週買う。コーヒーが美味しくなる。", date: "2026-01-20" },
          { user: "k", stars: 4, text: "濃いめで好み。価格も許容。", date: "2026-01-12" },
        ],
      },
      {
        id: "m2",
        name: "食パン 6枚切",
        brand: "ベーカリー日和",
        category: "ベーカリー",
        price: 168,
        rating: 4.2,
        reviewCount: 203,
        tags: ["ふわふわ", "朝食"],
        img: "https://images.unsplash.com/photo-1549931319-a545dcf3bc73?auto=format&fit=crop&w=1200&q=80",
        summary: "トーストで外カリ中ふわ。コスパ良。",
        highlights: ["トースト相性◎", "そのままでも柔らかい", "価格が手頃"],
        reviews: [
          { user: "miki", stars: 4, text: "ジャムと合う。よく買う。", date: "2026-01-18" },
          { user: "tomo", stars: 5, text: "トーストしたときの香りが良い。", date: "2026-01-05" },
        ],
      },
      {
        id: "m3",
        name: "熟成バナナ 1房",
        brand: "フルーツ市場",
        category: "青果",
        price: 198,
        rating: 4.0,
        reviewCount: 144,
        tags: ["甘い", "おやつ"],
        img: "https://images.unsplash.com/photo-1571771894821-ce9b6c11b08e?auto=format&fit=crop&w=1200&q=80",
        summary: "甘さ安定。朝食にも間食にも。",
        highlights: ["甘さが安定", "コスパ良", "持ち運びやすい"],
        reviews: [
          { user: "nao", stars: 4, text: "当たり外れ少ない印象。", date: "2026-01-09" },
          { user: "hiro", stars: 3, text: "たまに熟しすぎがある。", date: "2025-12-29" },
        ],
      },
      {
        id: "m4",
        name: "冷凍餃子 12個",
        brand: "町中華ラボ",
        category: "冷凍食品",
        price: 298,
        rating: 4.4,
        reviewCount: 388,
        tags: ["時短", "夕食"],
        img: "https://images.unsplash.com/photo-1626196340077-94c2e56db9d9?auto=format&fit=crop&w=1200&q=80",
        summary: "パリッと焼けて中ジューシー。忙しい日に最強。",
        highlights: ["焼きやすい", "皮がパリッと", "味がしっかり"],
        reviews: [
          { user: "rin", stars: 5, text: "冷凍餃子の中で一番好き。", date: "2026-01-22" },
          { user: "sora", stars: 4, text: "少し塩気強めだけどご飯が進む。", date: "2026-01-03" },
        ],
      },
      {
        id: "m5",
        name: "国産鶏むね肉 2枚",
        brand: "精肉コーナー",
        category: "精肉",
        price: 498,
        rating: 3.9,
        reviewCount: 92,
        tags: ["高たんぱく", "節約"],
        img: "https://images.unsplash.com/photo-1604908176997-125f25cc500f?auto=format&fit=crop&w=1200&q=80",
        summary: "コスパ良。下処理でしっとり仕上がる。",
        highlights: ["安定価格", "調理の自由度高い", "まとめ買い向き"],
        reviews: [
          { user: "kei", stars: 4, text: "サラダチキン作る用。", date: "2026-01-10" },
          { user: "mari", stars: 3, text: "時々個体差あるが許容。", date: "2025-12-27" },
        ],
      },
      {
        id: "m6",
        name: "レモン炭酸水 500ml",
        brand: "Spark+",
        category: "飲料",
        price: 88,
        rating: 4.3,
        reviewCount: 271,
        tags: ["無糖", "爽快"],
        img: "https://images.unsplash.com/photo-1544145945-f90425340c7e?auto=format&fit=crop&w=1200&q=80",
        summary: "強炭酸でスッキリ。食事にも合う。",
        highlights: ["炭酸強め", "香りが自然", "低価格"],
        reviews: [
          { user: "yuri", stars: 4, text: "箱買いする。飽きない。", date: "2026-01-16" },
          { user: "shun", stars: 5, text: "炭酸が強くて最高。", date: "2026-01-02" },
        ],
      },
      {
        id: "m7",
        name: "板チョコ 1枚",
        brand: "Cacao Works",
        category: "菓子",
        price: 108,
        rating: 3.7,
        reviewCount: 63,
        tags: ["おやつ", "定番"],
        img: "https://images.unsplash.com/photo-1511381939415-c1c5d8e3a59f?auto=format&fit=crop&w=1200&q=80",
        summary: "甘さしっかり。製菓にも使える。",
        highlights: ["甘さ強め", "溶けやすい", "価格が手頃"],
        reviews: [
          { user: "a", stars: 3, text: "甘め。ビター派には物足りない。", date: "2026-01-06" },
          { user: "mio", stars: 4, text: "お菓子作りに使いやすい。", date: "2025-12-25" },
        ],
      },
      {
        id: "m8",
        name: "洗濯洗剤 詰替 900g",
        brand: "CleanDay",
        category: "日用品",
        price: 398,
        rating: 4.1,
        reviewCount: 117,
        tags: ["大容量", "コスパ"],
        img: "https://images.unsplash.com/photo-1583947581924-860bda3b1b0d?auto=format&fit=crop&w=1200&q=80",
        summary: "無難に使える。香り控えめで万人向け。",
        highlights: ["香り控えめ", "汚れ落ち安定", "詰替が楽"],
        reviews: [
          { user: "t", stars: 4, text: "家族用にちょうどいい。", date: "2026-01-14" },
          { user: "nana", stars: 4, text: "セール時にまとめ買い。", date: "2026-01-01" },
        ],
      },
    ];

    const yen = (n) => new Intl.NumberFormat("ja-JP").format(n);
    const recommendScore = (p) => p.rating * Math.log10(p.reviewCount + 10);

    // ---- localStorage keys ----
    const LS_PURCHASED = "demo_super_review_purchased_v1";
    const LS_USERREV  = "demo_super_review_user_reviews_v1";

    function safeJsonParse(s, fallback){
      try { return JSON.parse(s); } catch { return fallback; }
    }

    function setBodyThemeClass(mode){
      const all = ["standard","dark","minimal","sakura"];
      all.forEach(m => document.body.classList.remove("bg-" + m));
      document.body.classList.add("bg-" + mode);
    }

    function makeTheme(mode){
      const baseTypography = {
        fontFamily:
          'Roboto, "Noto Sans JP", "Hiragino Kaku Gothic ProN", Meiryo, system-ui, -apple-system, "Segoe UI", Arial, sans-serif',
        h6: { fontWeight: 900 },
        button: { fontWeight: 900, textTransform: "none" },
      };

      const common = {
        typography: baseTypography,
        components: {
          MuiChip: { styleOverrides: { root: { borderRadius: 999 } } },
          MuiButton: { styleOverrides: { root: { borderRadius: 999, paddingLeft: 16, paddingRight: 16 } } },
        }
      };

      if (mode === "dark"){
        return createTheme({
          ...common,
          palette: {
            mode: "dark",
            primary: { main: "#00E676" },
            secondary: { main: "#FF4DA6" },
            warning: { main: "#FFD600" },
            info: { main: "#40C4FF" },
            background: { default: "transparent", paper: "rgba(17,24,39,.82)" },
          },
          shape: { borderRadius: 16 },
          components: {
            ...common.components,
            MuiAppBar: { styleOverrides: { root: { background: "linear-gradient(90deg, rgba(0,230,118,.85) 0%, rgba(255,77,166,.70) 100%)" } } },
            MuiPaper: { styleOverrides: { root: { backdropFilter: "blur(12px)", border: "1px solid rgba(255,255,255,.10)" } } },
            MuiCard: { styleOverrides: { root: { borderRadius: 16, backgroundImage: "linear-gradient(180deg, rgba(17,24,39,.92) 0%, rgba(17,24,39,.75) 100%)" } } },
          },
        });
      }

      if (mode === "minimal"){
        return createTheme({
          ...common,
          palette: {
            mode: "light",
            primary: { main: "#1b5e20" },
            secondary: { main: "#2e7d32" },
            background: { default: "transparent", paper: "#ffffff" },
            text: { primary: "#0f172a" },
          },
          shape: { borderRadius: 10 },
          typography: {
            ...baseTypography,
            h6: { fontWeight: 800 },
            body2: { color: "#334155" },
          },
          components: {
            ...common.components,
            MuiAppBar: { styleOverrides: { root: { background: "#ffffff", color: "#0f172a", borderBottom: "1px solid rgba(15,23,42,.08)" } } },
            MuiPaper: { styleOverrides: { root: { boxShadow: "none", border: "1px solid rgba(15,23,42,.08)" } } },
            MuiCard: { styleOverrides: { root: { borderRadius: 10 } } },
            MuiButton: { styleOverrides: { root: { borderRadius: 10, paddingLeft: 14, paddingRight: 14 } } },
          },
        });
      }

      if (mode === "sakura"){
        return createTheme({
          ...common,
          palette: {
            mode: "light",
            primary: { main: "#e91e63" },
            secondary: { main: "#2e7d32" },
            warning: { main: "#ffb300" },
            info: { main: "#6a5acd" },
            background: { default: "transparent", paper: "rgba(255,255,255,.90)" },
            text: { primary: "#2b1020" },
          },
          shape: { borderRadius: 18 },
          components: {
            ...common.components,
            MuiAppBar: { styleOverrides: { root: { background: "linear-gradient(90deg, #e91e63 0%, #ff8fb1 55%, #2e7d32 100%)" } } },
            MuiPaper: { styleOverrides: { root: { backdropFilter: "blur(10px)" } } },
            MuiCard: { styleOverrides: { root: { borderRadius: 18, backgroundImage: "linear-gradient(180deg, rgba(255,255,255,.93) 0%, rgba(255,255,255,.80) 100%)" } } },
          },
        });
      }

      return createTheme({
        ...common,
        palette: {
          mode: "light",
          primary: { main: "#2e7d32" },
          secondary: { main: "#1b5e20" },
          background: { default: "transparent", paper: "rgba(255,255,255,.92)" },
          text: { primary: "#102018" },
        },
        shape: { borderRadius: 14 },
        components: {
          ...common.components,
          MuiAppBar: { styleOverrides: { root: { background: "linear-gradient(90deg, #2e7d32 0%, #43a047 100%)" } } },
          MuiPaper: { styleOverrides: { root: { backdropFilter: "blur(8px)" } } },
          MuiCard: { styleOverrides: { root: { borderRadius: 14 } } },
        },
      });
    }

    const THEME_OPTIONS = [
      { value: "standard", label: "標準", icon: "forest" },
      { value: "dark",     label: "ダーク", icon: "dark_mode" },
      { value: "minimal",  label: "ミニマル", icon: "crop_free" },
      { value: "sakura",   label: "さくら", icon: "local_florist" },
    ];

    function parseDateYMD(s){
      if (!s) return null;
      const m = String(s).match(/^(\d{4})-(\d{2})-(\d{2})$/);
      if (!m) return null;
      const d = new Date(Number(m[1]), Number(m[2])-1, Number(m[3]));
      return isNaN(d.getTime()) ? null : d;
    }

    function fmtDateJP(ymd){
      if (!ymd) return "-";
      const d = parseDateYMD(ymd);
      if (!d) return ymd;
      return `${d.getFullYear()}/${String(d.getMonth()+1).padStart(2,"0")}/${String(d.getDate()).padStart(2,"0")}`;
    }

    function makeShareText({product, review}){
      const title = `【レビュー】${product.name}（${product.brand}）`;
      const stars = review?.stars ? `★${Number(review.stars).toFixed(0)}` : "";
      const body = review?.text ? review.text : product.summary;
      const price = `¥${yen(product.price)}`;
      return `${title}\n${stars} ${price}\n${body}\n#スーパー商品レビュー`;
    }

    function App(){
      const isMobile = useMediaQuery("(max-width:900px)");

      const [themeMode, setThemeMode] = React.useState("standard");
      const theme = React.useMemo(() => makeTheme(themeMode), [themeMode]);
      React.useEffect(() => { setBodyThemeClass(themeMode); }, [themeMode]);

      // View mode: grid | feed
      const [viewMode, setViewMode] = React.useState("feed"); // default feed

      // --- purchased & user reviews (persisted) ---
      const [purchasedIds, setPurchasedIds] = React.useState(() => {
        const saved = safeJsonParse(localStorage.getItem(LS_PURCHASED), null);
        return Array.isArray(saved) ? saved : ["m1", "m4"];
      });

      const [userReviewsByProduct, setUserReviewsByProduct] = React.useState(() => {
        const saved = safeJsonParse(localStorage.getItem(LS_USERREV), null);
        return (saved && typeof saved === "object") ? saved : {};
      });

      React.useEffect(() => {
        localStorage.setItem(LS_PURCHASED, JSON.stringify(purchasedIds));
      }, [purchasedIds]);

      React.useEffect(() => {
        localStorage.setItem(LS_USERREV, JSON.stringify(userReviewsByProduct));
      }, [userReviewsByProduct]);

      const categories = React.useMemo(() => {
        return ["ALL", ...Array.from(new Set(PRODUCTS.map(p => p.category)))];
      }, []);

      const [q, setQ] = React.useState("");
      const [category, setCategory] = React.useState("ALL");
      const [minRating, setMinRating] = React.useState(0);
      const [sort, setSort] = React.useState("RECOMMEND");
      const [drawerOpen, setDrawerOpen] = React.useState(false);

      const [detailId, setDetailId] = React.useState(null);
      const [snack, setSnack] = React.useState({open:false, msg:""});

      const isPurchased = React.useCallback((pid) => purchasedIds.includes(pid), [purchasedIds]);

      const togglePurchased = React.useCallback((pid) => {
        setPurchasedIds(prev => {
          const s = new Set(prev);
          if (s.has(pid)) s.delete(pid); else s.add(pid);
          return Array.from(s);
        });
      }, []);

      // Build merged product view (base reviews + user reviews)
      const productView = React.useMemo(() => {
        const byId = {};
        PRODUCTS.forEach(p => {
          const extra = Array.isArray(userReviewsByProduct[p.id]) ? userReviewsByProduct[p.id] : [];
          const merged = p.reviews.concat(extra);

          const ratingAvg = merged.length
            ? merged.reduce((a, r) => a + Number(r.stars || 0), 0) / merged.length
            : p.rating;

          const latest = merged
            .map(r => parseDateYMD(r.date))
            .filter(Boolean)
            .sort((a,b)=>b-a)[0] || null;

          byId[p.id] = {
            ...p,
            reviewsAll: merged,
            ratingShown: Math.max(0, Math.min(5, ratingAvg)),
            reviewCountShown: merged.length,
            latestDateObj: latest,
            latestDateYMD: latest ? `${latest.getFullYear()}-${String(latest.getMonth()+1).padStart(2,"0")}-${String(latest.getDate()).padStart(2,"0")}` : null,
          };
        });
        return byId;
      }, [userReviewsByProduct]);

      const filtered = React.useMemo(() => {
        let list = PRODUCTS.map(p => productView[p.id]);

        if (q.trim()){
          const t = q.trim().toLowerCase();
          list = list.filter(p => p.name.toLowerCase().includes(t) || p.brand.toLowerCase().includes(t));
        }
        if (category !== "ALL"){
          list = list.filter(p => p.category === category);
        }
        if (minRating > 0){
          list = list.filter(p => p.ratingShown >= minRating);
        }

        if (sort === "RECOMMEND"){
          list.sort((a,b) => recommendScore({rating: b.ratingShown, reviewCount: b.reviewCountShown}) - recommendScore({rating: a.ratingShown, reviewCount: a.reviewCountShown}));
        } else if (sort === "RATING_DESC"){
          list.sort((a,b) => b.ratingShown - a.ratingShown);
        } else if (sort === "REVIEWS_DESC"){
          list.sort((a,b) => b.reviewCountShown - a.reviewCountShown);
        } else if (sort === "PRICE_ASC"){
          list.sort((a,b) => a.price - b.price);
        } else if (sort === "PRICE_DESC"){
          list.sort((a,b) => b.price - a.price);
        }

        return list;
      }, [q, category, minRating, sort, productView]);

      const avg = React.useMemo(() => {
        if (!filtered.length) return 0;
        return filtered.reduce((a,p)=>a+p.ratingShown,0) / filtered.length;
      }, [filtered]);

      // Feed = "latest activity desc" (regardless of sort UI) to feel like SNS
      const feedList = React.useMemo(() => {
        const list = filtered.slice();
        list.sort((a,b) => {
          const ta = a.latestDateObj ? a.latestDateObj.getTime() : 0;
          const tb = b.latestDateObj ? b.latestDateObj.getTime() : 0;
          if (tb !== ta) return tb - ta;
          const ra = recommendScore({rating: a.ratingShown, reviewCount: a.reviewCountShown});
          const rb = recommendScore({rating: b.ratingShown, reviewCount: b.reviewCountShown});
          return rb - ra;
        });
        return list;
      }, [filtered]);

      const Filters = ({ dense=false }) => (
        <Stack spacing={2} sx={{ p: dense ? 2 : 0, width: dense ? 340 : "auto" }}>
          <Typography variant="h6" sx={{ fontWeight: 900 }}>絞り込み</Typography>

          <TextField
            size="small"
            label="商品名・ブランドで検索"
            value={q}
            onChange={(e)=>setQ(e.target.value)}
            InputProps={{
              startAdornment: (
                <InputAdornment position="start">
                  <Icon fontSize="small">search</Icon>
                </InputAdornment>
              )
            }}
          />

          <FormControl size="small" fullWidth>
            <InputLabel>カテゴリ</InputLabel>
            <Select label="カテゴリ" value={category} onChange={(e)=>setCategory(e.target.value)}>
              {categories.map(c => <MenuItem key={c} value={c}>{c === "ALL" ? "すべて" : c}</MenuItem>)}
            </Select>
          </FormControl>

          <FormControl size="small" fullWidth>
            <InputLabel>最低評価</InputLabel>
            <Select
              label="最低評価"
              value={String(minRating)}
              onChange={(e)=>setMinRating(Number(e.target.value))}
            >
              <MenuItem value="0">指定なし</MenuItem>
              <MenuItem value="3">★3.0以上</MenuItem>
              <MenuItem value="3.5">★3.5以上</MenuItem>
              <MenuItem value="4">★4.0以上</MenuItem>
              <MenuItem value="4.5">★4.5以上</MenuItem>
            </Select>
          </FormControl>

          <FormControl size="small" fullWidth>
            <InputLabel>並び替え</InputLabel>
            <Select label="並び替え" value={sort} onChange={(e)=>setSort(e.target.value)}>
              <MenuItem value="RECOMMEND">おすすめ（擬似）</MenuItem>
              <MenuItem value="RATING_DESC">評価が高い順</MenuItem>
              <MenuItem value="REVIEWS_DESC">レビュー数が多い順</MenuItem>
              <MenuItem value="PRICE_ASC">価格が安い順</MenuItem>
              <MenuItem value="PRICE_DESC">価格が高い順</MenuItem>
            </Select>
          </FormControl>

          <Stack direction="row" spacing={1}>
            <Button
              variant="contained"
              fullWidth
              color="primary"
              onClick={()=>{ if (isMobile) setDrawerOpen(false); }}
              startIcon={<Icon>tune</Icon>}
            >
              適用
            </Button>
            <Button
              variant="text"
              fullWidth
              onClick={()=>{
                setQ(""); setCategory("ALL"); setMinRating(0); setSort("RECOMMEND");
                if (isMobile) setDrawerOpen(false);
              }}
            >
              リセット
            </Button>
          </Stack>
        </Stack>
      );

      const BadgeRow = ({ p }) => (
        <Stack direction="row" spacing={1} sx={{ mt: 1, flexWrap: "wrap" }}>
          {isPurchased(p.id) && (
            <Chip size="small" color="primary" label="購入済み" icon={<Icon>verified</Icon>} />
          )}
          {p.ratingShown >= 4.4 && <Chip size="small" color="primary" label="話題" />}
          {p.price <= 198 && <Chip size="small" color="primary" label="お買い得" />}
          {p.reviewCountShown >= 6 && <Chip size="small" color="primary" label="定番" />}
          {themeMode === "dark" && p.ratingShown >= 4.5 && <Chip size="small" color="secondary" label="夜の推し" />}
        </Stack>
      );

      // --- Theme switch (menu, responsive-safe) ---
      const ThemeSwitch = () => (
        <FormControl
          size="small"
          variant="outlined"
          sx={{
            minWidth: isMobile ? 126 : 190,
            "& .MuiOutlinedInput-root": {
              borderRadius: themeMode === "minimal" ? 2 : 999,
              bgcolor: themeMode === "minimal" ? "rgba(15,23,42,.04)" : "rgba(255,255,255,.16)",
              color: themeMode === "minimal" ? "rgba(15,23,42,.92)" : "rgba(255,255,255,.95)",
              "& fieldset": {
                borderColor: themeMode === "minimal" ? "rgba(15,23,42,.18)" : "rgba(255,255,255,.28)",
              },
            },
            "& .MuiSvgIcon-root": {
              color: themeMode === "minimal" ? "rgba(15,23,42,.7)" : "rgba(255,255,255,.9)",
            },
          }}
        >
          <Select
            value={themeMode}
            onChange={(e) => setThemeMode(e.target.value)}
            renderValue={(v) => {
              const opt = THEME_OPTIONS.find(o => o.value === v);
              return (
                <Stack direction="row" spacing={1} alignItems="center" sx={{ minHeight: 24 }}>
                  <Icon sx={{ fontSize: 18 }}>{opt.icon}</Icon>
                  <Typography variant="body2" sx={{ fontWeight: 900, lineHeight: 1 }}>
                    {isMobile ? "テーマ" : `テーマ：${opt.label}`}
                  </Typography>
                </Stack>
              );
            }}
            MenuProps={{ PaperProps: { sx: { borderRadius: 2 } } }}
          >
            {THEME_OPTIONS.map(opt => (
              <MenuItem key={opt.value} value={opt.value}>
                <ListItemIcon sx={{ minWidth: 34 }}>
                  <Icon sx={{ fontSize: 20 }}>{opt.icon}</Icon>
                </ListItemIcon>
                <ListItemText primary={opt.label} />
              </MenuItem>
            ))}
          </Select>
        </FormControl>
      );

      // --- Bottom dock: view switch ---
      const DockViewSwitch = () => (
        <FormControl
          size="small"
          variant="outlined"
          sx={{
            minWidth: isMobile ? 116 : 170,
            "& .MuiOutlinedInput-root": {
              borderRadius: 999,
              bgcolor: "rgba(255,255,255,.72)",
              "& fieldset": { borderColor: "rgba(15,23,42,.12)" },
            },
            ...(themeMode === "dark" ? {
              "& .MuiOutlinedInput-root": {
                bgcolor: "rgba(17,24,39,.50)",
                "& fieldset": { borderColor: "rgba(255,255,255,.14)" },
              },
              "& .MuiSvgIcon-root": { color: "rgba(255,255,255,.86)" },
              "& .MuiInputBase-input": { color: "rgba(255,255,255,.92)" },
            } : {})
          }}
        >
          <Select
            value={viewMode}
            onChange={(e) => setViewMode(e.target.value)}
            renderValue={(v) => (
              <Stack direction="row" spacing={1} alignItems="center">
                <Icon sx={{ fontSize: 18 }}>{v === "feed" ? "rss_feed" : "grid_view"}</Icon>
                <Typography variant="body2" sx={{ fontWeight: 900, lineHeight: 1 }}>
                  {isMobile ? "表示" : (v === "feed" ? "表示：フィード" : "表示：グリッド")}
                </Typography>
              </Stack>
            )}
            MenuProps={{ PaperProps: { sx: { borderRadius: 2 } } }}
          >
            <MenuItem value="feed">
              <ListItemIcon sx={{ minWidth: 34 }}><Icon>rss_feed</Icon></ListItemIcon>
              <ListItemText primary="フィード" />
            </MenuItem>
            <MenuItem value="grid">
              <ListItemIcon sx={{ minWidth: 34 }}><Icon>grid_view</Icon></ListItemIcon>
              <ListItemText primary="グリッド" />
            </MenuItem>
          </Select>
        </FormControl>
      );

      const shareToSNS = async ({ product, review }) => {
        const text = makeShareText({ product, review });
        try {
          if (navigator.share){
            await navigator.share({
              title: `レビュー: ${product.name}`,
              text,
            });
            setSnack({open:true, msg:"共有しました（または共有画面を開きました）"});
            return;
          }
        } catch (e) {
          // user cancelled etc.
        }
        // fallback: copy to clipboard
        try {
          await navigator.clipboard.writeText(text);
          setSnack({open:true, msg:"共有文をコピーしました"});
        } catch {
          // last fallback: prompt
          window.prompt("このテキストをコピーして共有してください", text);
        }
      };

      // ---- Detail & review add ----
      const detail = detailId ? productView[detailId] : null;
      const purchased = detail ? isPurchased(detail.id) : false;

      const [addStars, setAddStars] = React.useState(5);
      const [addText, setAddText] = React.useState("");
      const [addPhotos, setAddPhotos] = React.useState([]); // dataURL[]
      const [addErr, setAddErr] = React.useState("");

      React.useEffect(() => {
        if (detailId){
          setAddStars(5);
          setAddText("");
          setAddPhotos([]);
          setAddErr("");
        }
      }, [detailId]);

      const onPickPhotos = async (files) => {
        const list = Array.from(files || []);
        if (!list.length) return;

        const maxCount = 4;
        const remain = Math.max(0, maxCount - addPhotos.length);
        const useFiles = list.slice(0, remain);

        const readOne = (file) => new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => resolve(String(reader.result || ""));
          reader.onerror = reject;
          reader.readAsDataURL(file);
        });

        try {
          const urls = [];
          for (const f of useFiles){
            if (!String(f.type || "").startsWith("image/")) continue;
            if (f.size > 1_200_000) continue;
            urls.push(await readOne(f));
          }
          setAddPhotos(prev => prev.concat(urls));
        } catch {
          setAddErr("画像の読み込みに失敗しました。");
        }
      };

      const removePhotoAt = (i) => setAddPhotos(prev => prev.filter((_, idx) => idx !== i));

      const submitReview = () => {
        if (!detail) return;
        if (!purchased){
          setAddErr("購入済みのときだけレビュー・写真を追加できます。");
          return;
        }
        if (!addText.trim()){
          setAddErr("レビュー本文を入力してください。");
          return;
        }
        if (addStars <= 0){
          setAddErr("評価（★）を選択してください。");
          return;
        }

        const now = new Date();
        const stamp = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,"0")}-${String(now.getDate()).padStart(2,"0")}`;

        const newReview = {
          user: "あなた",
          stars: Number(addStars),
          text: addText.trim(),
          photos: addPhotos.slice(0, 4),
          date: stamp,
          mine: true,
        };

        setUserReviewsByProduct(prev => {
          const next = { ...prev };
          const arr = Array.isArray(next[detail.id]) ? next[detail.id].slice() : [];
          arr.unshift(newReview);
          next[detail.id] = arr;
          return next;
        });

        setAddStars(5);
        setAddText("");
        setAddPhotos([]);
        setAddErr("");
        setSnack({open:true, msg:"レビューを投稿しました（モック）"});
      };

      const clearMyReviews = (pid) => {
        setUserReviewsByProduct(prev => {
          const next = { ...prev };
          const arr = Array.isArray(next[pid]) ? next[pid] : [];
          next[pid] = arr.filter(r => !r.mine);
          return next;
        });
        setSnack({open:true, msg:"自分のレビューを削除しました（モック）"});
      };

      const FeedView = () => (
        <Box className="feedWrap">
          {feedList.map(p => {
            const top = p.reviewsAll[0] || null; // most recent in data (user reviews are unshifted)
            return (
              <Card key={p.id} className="glowCard" sx={{ overflow: "hidden" }}>
                <CardActionArea onClick={() => setDetailId(p.id)}>
                  <Grid container>
                    <Grid item xs={12} sm={4}>
                      <CardMedia component="img" height="190" image={p.img} alt={p.name} />
                    </Grid>
                    <Grid item xs={12} sm={8}>
                      <CardContent>
                        <Stack direction="row" justifyContent="space-between" alignItems="center" spacing={1}>
                          <Stack sx={{ minWidth: 0 }}>
                            <Typography sx={{ fontWeight: 900 }} noWrap>{p.name}</Typography>
                            <Typography variant="body2" color="text.secondary" sx={{ mt: .3 }}>
                              {p.brand} ・ {p.category}
                            </Typography>
                          </Stack>
                          <Stack direction="row" spacing={1} alignItems="center">
                            {p.latestDateYMD && <Chip size="small" icon={<Icon>schedule</Icon>} label={fmtDateJP(p.latestDateYMD)} />}
                            {isPurchased(p.id) && <Chip size="small" icon={<Icon>verified</Icon>} label="購入済" color="primary" />}
                          </Stack>
                        </Stack>

                        <Stack direction="row" justifyContent="space-between" alignItems="center" sx={{ mt: 1 }}>
                          <Typography sx={{ fontWeight: 900 }}>¥{yen(p.price)}</Typography>
                          <Stack direction="row" spacing={1} alignItems="center">
                            <Rating value={p.ratingShown} precision={0.1} readOnly size="small" />
                            <Typography variant="body2" color="text.secondary">{p.ratingShown.toFixed(1)}</Typography>
                          </Stack>
                        </Stack>

                        <Typography variant="body2" color="text.secondary" sx={{ mt: .6 }}>
                          レビュー {p.reviewCountShown} 件
                        </Typography>

                        <BadgeRow p={p} />

                        <Divider sx={{ my: 1 }} />

                        {/* Top review preview */}
                        {top ? (
                          <Box sx={{ display: "grid", gap: .6 }}>
                            <Stack direction="row" justifyContent="space-between" alignItems="center">
                              <Stack direction="row" spacing={1} alignItems="center">
                                <Typography variant="body2" sx={{ fontWeight: 900 }}>{top.user}</Typography>
                                {top.mine && <Chip size="small" label="自分" icon={<Icon>person</Icon>} />}
                                {top.date && <Typography variant="caption" color="text.secondary">{fmtDateJP(top.date)}</Typography>}
                              </Stack>
                              <Rating value={Number(top.stars)} readOnly size="small" />
                            </Stack>

                            <Typography variant="body2" color="text.secondary" sx={{
                              display: "-webkit-box",
                              WebkitLineClamp: 2,
                              WebkitBoxOrient: "vertical",
                              overflow: "hidden",
                            }}>
                              {top.text}
                            </Typography>

                            {Array.isArray(top.photos) && top.photos.length > 0 && (
                              <Stack direction="row" spacing={1} sx={{ flexWrap: "wrap" }}>
                                {top.photos.slice(0,3).map((src, idx) => (
                                  <Box
                                    key={idx}
                                    component="img"
                                    src={src}
                                    alt={"feed-photo-" + idx}
                                    sx={{
                                      width: 84, height: 84, objectFit: "cover",
                                      borderRadius: 2, border: "1px solid rgba(0,0,0,.12)"
                                    }}
                                  />
                                ))}
                                {top.photos.length > 3 && (
                                  <Box sx={{
                                    width: 84, height: 84, borderRadius: 2,
                                    display:"grid", placeItems:"center",
                                    border:"1px solid rgba(0,0,0,.12)",
                                    bgcolor:"rgba(0,0,0,.04)"
                                  }}>
                                    <Typography sx={{ fontWeight: 900 }}>+{top.photos.length - 3}</Typography>
                                  </Box>
                                )}
                              </Stack>
                            )}

                            {/* Share row (doesn't open detail; stop propagation) */}
                            <Stack direction="row" spacing={1} justifyContent="flex-end" sx={{ mt: .4 }}>
                              <Button
                                variant="outlined"
                                size="small"
                                startIcon={<Icon>share</Icon>}
                                onClick={(e)=>{ e.preventDefault(); e.stopPropagation(); shareToSNS({product:p, review:top}); }}
                              >
                                共有
                              </Button>
                            </Stack>
                          </Box>
                        ) : (
                          <Stack direction="row" justifyContent="space-between" alignItems="center">
                            <Typography variant="body2" color="text.secondary">レビューなし</Typography>
                            <Button
                              variant="outlined"
                              size="small"
                              startIcon={<Icon>share</Icon>}
                              onClick={(e)=>{ e.preventDefault(); e.stopPropagation(); shareToSNS({product:p, review:null}); }}
                            >
                              共有
                            </Button>
                          </Stack>
                        )}
                      </CardContent>
                    </Grid>
                  </Grid>
                </CardActionArea>
              </Card>
            );
          })}
        </Box>
      );

      const GridView = () => (
        <Grid container spacing={2}>
          {filtered.map(p => (
            <Grid item xs={12} sm={6} key={p.id}>
              <Card className="glowCard" sx={{ overflow: "hidden" }}>
                <CardActionArea onClick={()=>setDetailId(p.id)}>
                  <CardMedia component="img" height="170" image={p.img} alt={p.name} />
                  <CardContent>
                    <Stack direction="row" justifyContent="space-between" alignItems="center" spacing={1}>
                      <Typography sx={{ fontWeight: 900 }} noWrap>{p.name}</Typography>
                      {isPurchased(p.id) && (
                        <Chip size="small" label="購入済" icon={<Icon>verified</Icon>} sx={{ height: 24 }} />
                      )}
                    </Stack>

                    <Typography variant="body2" color="text.secondary" sx={{ mt: .3 }}>
                      {p.brand} ・ {p.category}
                    </Typography>

                    <Stack direction="row" justifyContent="space-between" alignItems="center" sx={{ mt: 1 }}>
                      <Typography sx={{ fontWeight: 900 }}>¥{yen(p.price)}</Typography>
                      <Stack direction="row" spacing={1} alignItems="center">
                        <Rating value={p.ratingShown} precision={0.1} readOnly size="small" />
                        <Typography variant="body2" color="text.secondary">
                          {p.ratingShown.toFixed(1)}
                        </Typography>
                      </Stack>
                    </Stack>

                    <Typography variant="body2" color="text.secondary" sx={{ mt: .6 }}>
                      レビュー {p.reviewCountShown} 件
                    </Typography>

                    <BadgeRow p={p} />

                    <Stack direction="row" spacing={.8} flexWrap="wrap" sx={{ mt: 1 }}>
                      {p.tags.map(t => <Chip key={t} size="small" label={t} />)}
                    </Stack>

                    <Stack direction="row" justifyContent="flex-end" sx={{ mt: 1 }}>
                      <Button
                        variant="outlined"
                        size="small"
                        startIcon={<Icon>share</Icon>}
                        onClick={(e)=>{ e.preventDefault(); e.stopPropagation(); shareToSNS({product:p, review:p.reviewsAll[0] || null}); }}
                      >
                        共有
                      </Button>
                    </Stack>
                  </CardContent>
                </CardActionArea>
              </Card>
            </Grid>
          ))}
        </Grid>
      );



      React.useEffect(() => {
        if (detailId){
          setAddStars(5);
          setAddText("");
          setAddPhotos([]);
          setAddErr("");
        }
      }, [detailId]);



        const now = new Date();
        const stamp = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,"0")}-${String(now.getDate()).padStart(2,"0")}`;

        const newReview = {
          user: "あなた",
          stars: Number(addStars),
          text: addText.trim(),
          photos: addPhotos.slice(0, 4),
          date: stamp,
          mine: true,
        };

        setUserReviewsByProduct(prev => {
          const next = { ...prev };
          const arr = Array.isArray(next[detail.id]) ? next[detail.id].slice() : [];
          arr.unshift(newReview);
          next[detail.id] = arr;
          return next;
        });

        setAddStars(5);
        setAddText("");
        setAddPhotos([]);
        setAddErr("");
        setSnack({open:true, msg:"レビューを投稿しました（モック）"});
      };



      return (
        <ThemeProvider theme={theme}>
          <CssBaseline />
          <Box className="appRoot">
            <AppBar position="sticky" elevation={0}>
              <Toolbar sx={{ gap: 1 }}>
                <Stack direction="row" spacing={1} alignItems="center" sx={{ flex: 1, minWidth: 0 }}>
                  <Badge
                    badgeContent={themeMode === "sakura" ? "❀" : " "}
                    color="warning"
                    overlap="circular"
                    anchorOrigin={{ vertical: "top", horizontal: "left" }}
                  >
                    <Icon>store</Icon>
                  </Badge>
                  <Typography variant="h6" sx={{ fontWeight: 900 }} noWrap>
                    スーパー商品レビュー
                  </Typography>
                </Stack>

                <Tooltip title="テーマ切替">
                  <Box><ThemeSwitch /></Box>
                </Tooltip>

                {isMobile && (
                  <Button color="inherit" onClick={()=>setDrawerOpen(true)} startIcon={<Icon>tune</Icon>}>
                    フィルタ
                  </Button>
                )}
              </Toolbar>
            </AppBar>

            <Container maxWidth="lg" sx={{ py: 2.5 }}>
              {/* KPI */}
              <Stack direction={{ xs: "column", sm: "row" }} spacing={1.2} sx={{ mb: 2 }}>
                <Chip icon={<Icon>inventory_2</Icon>} label={`掲載 ${filtered.length} 件`} />
                <Chip icon={<Icon>star</Icon>} label={filtered.length ? `平均 ${avg.toFixed(2)}` : "平均 -"} />
                <Chip icon={<Icon>category</Icon>} label={`カテゴリ ${categories.length - 1} 種`} />
                <Chip icon={<Icon>verified</Icon>} label={`購入済み ${purchasedIds.length} 件（モック）`} />
                {viewMode === "feed" && <Chip icon={<Icon>rss_feed</Icon>} label="フィード：最新アクティビティ順" />}
              </Stack>

              <Grid container spacing={2}>
                {/* Desktop filters */}
                {!isMobile && (
                  <Grid item xs={12} md={4}>
                    <Card sx={{ position: "sticky", top: 88 }}>
                      <CardContent>
                        <Filters />
                      </CardContent>
                    </Card>
                  </Grid>
                )}

                {/* Content */}
                <Grid item xs={12} md={8}>
                  <Card sx={{ mb: 2 }}>
                    <CardContent>
                      <Stack direction="row" alignItems="center" spacing={1}>
                        <Icon color="primary">{viewMode === "feed" ? "rss_feed" : "shopping_basket"}</Icon>
                        <Typography variant="h6" sx={{ fontWeight: 900 }}>
                          {viewMode === "feed" ? "フィード" : "商品一覧"}
                        </Typography>
                      </Stack>
                      <Typography variant="body2" color="text.secondary" sx={{ mt: .6 }}>
                        ※モック：共有ボタンは Web Share API 対応端末では共有シートを開きます（非対応はコピー）
                      </Typography>
                    </CardContent>
                  </Card>

                  {filtered.length === 0 ? (
                    <Card>
                      <CardContent>
                        <Typography sx={{ fontWeight: 900 }}>該当なし</Typography>
                        <Typography variant="body2" color="text.secondary" sx={{ mt: .5 }}>
                          条件をゆるめて再検索してください。
                        </Typography>
                      </CardContent>
                    </Card>
                  ) : viewMode === "feed" ? (
                    <FeedView />
                  ) : (
                    <GridView />
                  )}
                </Grid>
              </Grid>

              {/* Mobile Drawer */}
              <Drawer anchor="right" open={drawerOpen} onClose={()=>setDrawerOpen(false)}>
                <Box sx={{ width: 360, maxWidth: "92vw" }}>
                  <Box sx={{ p: 2, display: "flex", alignItems: "center", justifyContent: "space-between" }}>
                    <Stack direction="row" spacing={1} alignItems="center">
                      <Icon color="primary">tune</Icon>
                      <Typography sx={{ fontWeight: 900 }}>絞り込み</Typography>
                    </Stack>
                    <Button onClick={()=>setDrawerOpen(false)} startIcon={<Icon>close</Icon>}>閉じる</Button>
                  </Box>
                  <Divider />
                  <Filters dense />
                </Box>
              </Drawer>

              {/* Detail Dialog */}
              <Dialog open={!!detailId} onClose={()=>setDetailId(null)} fullWidth maxWidth="md">
                {detail && (
                  <>
                    <DialogTitle sx={{ fontWeight: 900 }}>
                      <Stack direction="row" spacing={1} alignItems="center" sx={{ justifyContent: "space-between" }}>
                        <Stack direction="row" spacing={1} alignItems="center" sx={{ minWidth: 0 }}>
                          <Icon color="primary">
                            {themeMode === "sakura" ? "local_florist"
                              : themeMode === "dark" ? "dark_mode"
                              : themeMode === "minimal" ? "crop_free"
                              : "info"}
                          </Icon>
                          <span style={{ whiteSpace: "nowrap", overflow: "hidden", textOverflow: "ellipsis" }}>
                            {detail.name}
                          </span>
                        </Stack>

                        <Button
                          variant="outlined"
                          size="small"
                          startIcon={<Icon>share</Icon>}
                          onClick={() => shareToSNS({ product: detail, review: detail.reviewsAll[0] || null })}
                        >
                          共有
                        </Button>
                      </Stack>
                    </DialogTitle>

                    <DialogContent dividers>
                      <Grid container spacing={2}>
                        <Grid item xs={12} md={6}>
                          <Box
                            component="img"
                            src={detail.img}
                            alt={detail.name}
                            sx={{ width: "100%", height: 260, objectFit: "cover", borderRadius: 3 }}
                          />
                        </Grid>

                        <Grid item xs={12} md={6}>
                          <Typography variant="body2" color="text.secondary">
                            {detail.brand} ・ {detail.category} ・ レビュー {detail.reviewCountShown} 件
                          </Typography>

                          <Stack direction="row" justifyContent="space-between" alignItems="center" sx={{ mt: 1 }}>
                            <Typography sx={{ fontWeight: 900, fontSize: 20 }}>¥{yen(detail.price)}</Typography>
                            <Stack direction="row" spacing={1} alignItems="center">
                              <Rating value={detail.ratingShown} precision={0.1} readOnly />
                              <Typography variant="body2" color="text.secondary">
                                {detail.ratingShown.toFixed(1)}
                              </Typography>
                            </Stack>
                          </Stack>

                          <Typography sx={{ mt: 1.2 }}>{detail.summary}</Typography>

                          <Typography sx={{ mt: 2, fontWeight: 900 }}>ポイント</Typography>
                          <List dense>
                            {detail.highlights.map((h, i) => (
                              <ListItem key={i} disableGutters>
                                <Icon sx={{ mr: 1, color: "primary.main" }}>check_circle</Icon>
                                <ListItemText primary={h} />
                              </ListItem>
                            ))}
                          </List>

                          <Stack direction="row" spacing={1} flexWrap="wrap" sx={{ mt: .5 }}>
                            {detail.tags.map(t => <Chip key={t} label={t} size="small" />)}
                          </Stack>

                          <Divider sx={{ my: 2 }} />

                          {/* Purchase toggle (mock) */}
                          <Stack direction={{ xs: "column", sm: "row" }} spacing={1} alignItems={{ xs: "stretch", sm: "center" }}>
                            <Chip
                              icon={<Icon>{purchased ? "verified" : "shopping_cart"}</Icon>}
                              label={purchased ? "購入済み" : "未購入（モック）"}
                              color={purchased ? "primary" : "default"}
                              variant={purchased ? "filled" : "outlined"}
                              sx={{ fontWeight: 900 }}
                            />
                            <Button
                              variant={purchased ? "outlined" : "contained"}
                              startIcon={<Icon>{purchased ? "remove_shopping_cart" : "add_shopping_cart"}</Icon>}
                              onClick={() => togglePurchased(detail.id)}
                            >
                              {purchased ? "購入済みを解除" : "購入済みにする（モック）"}
                            </Button>

                            <Button
                              variant="text"
                              color="inherit"
                              startIcon={<Icon>delete_sweep</Icon>}
                              onClick={() => clearMyReviews(detail.id)}
                            >
                              自分のレビューを削除（モック）
                            </Button>
                          </Stack>

                          {!purchased && (
                            <Alert severity="info" sx={{ mt: 1.2 }}>
                              購入済みにすると「自分のレビュー・写真追加」が使えます（モック）
                            </Alert>
                          )}
                        </Grid>

                        {/* Add Review (only when purchased) */}
                        <Grid item xs={12}>
                          <Card sx={{ mt: 1 }}>
                            <CardContent>
                              <Stack direction="row" spacing={1} alignItems="center">
                                <Icon color="primary">rate_review</Icon>
                                <Typography sx={{ fontWeight: 900 }}>自分のレビューを追加</Typography>
                                {purchased && <Chip size="small" icon={<Icon>verified</Icon>} label="購入済み限定" color="primary" />}
                              </Stack>

                              {addErr && <Alert severity="warning" sx={{ mt: 1 }}>{addErr}</Alert>}

                              <Stack spacing={1.4} sx={{ mt: 1.2 }}>
                                <Stack direction="row" spacing={1} alignItems="center">
                                  <Typography sx={{ fontWeight: 900, minWidth: 72 }}>評価</Typography>
                                  <Rating value={addStars} onChange={(e, v) => setAddStars(v || 0)} />
                                  <Typography variant="body2" color="text.secondary">
                                    {addStars ? addStars.toFixed(0) : "-"}
                                  </Typography>
                                </Stack>

                                <TextField
                                  label="レビュー本文"
                                  placeholder="良かった点・気になった点など"
                                  multiline
                                  minRows={3}
                                  value={addText}
                                  onChange={(e) => setAddText(e.target.value)}
                                  fullWidth
                                />

                                <Stack spacing={1}>
                                  <Stack direction="row" spacing={1} alignItems="center" justifyContent="space-between">
                                    <Stack direction="row" spacing={1} alignItems="center">
                                      <Icon color="primary">photo_camera</Icon>
                                      <Typography sx={{ fontWeight: 900 }}>写真（最大4枚）</Typography>
                                      <Typography variant="body2" color="text.secondary">
                                        ※1枚あたり約1.2MBまで（モック）
                                      </Typography>
                                    </Stack>
                                    <Button
                                      variant="outlined"
                                      component="label"
                                      startIcon={<Icon>upload</Icon>}
                                      disabled={!purchased || addPhotos.length >= 4}
                                    >
                                      追加
                                      <input
                                        hidden
                                        type="file"
                                        accept="image/*"
                                        multiple
                                        onChange={(e) => (async()=>{ await onPickPhotos(e.target.files); })()}
                                      />
                                    </Button>
                                  </Stack>

                                  {addPhotos.length > 0 && (
                                    <Stack direction="row" spacing={1} sx={{ flexWrap: "wrap" }}>
                                      {addPhotos.map((src, i) => (
                                        <Box key={i} sx={{ position: "relative" }}>
                                          <Box
                                            component="img"
                                            src={src}
                                            alt={"photo-" + i}
                                            sx={{
                                              width: 92,
                                              height: 92,
                                              objectFit: "cover",
                                              borderRadius: 2,
                                              border: "1px solid rgba(0,0,0,.12)",
                                            }}
                                          />
                                          <Button
                                            size="small"
                                            onClick={() => removePhotoAt(i)}
                                            sx={{
                                              position: "absolute",
                                              top: -8,
                                              right: -8,
                                              minWidth: 32,
                                              width: 32,
                                              height: 32,
                                              borderRadius: 999,
                                              bgcolor: "rgba(0,0,0,.65)",
                                              color: "#fff",
                                              "&:hover": { bgcolor: "rgba(0,0,0,.78)" },
                                            }}
                                          >
                                            <Icon sx={{ fontSize: 18 }}>close</Icon>
                                          </Button>
                                        </Box>
                                      ))}
                                    </Stack>
                                  )}
                                </Stack>

                                <Stack direction={{ xs: "column", sm: "row" }} spacing={1} justifyContent="flex-end">
                                  <Button
                                    variant="contained"
                                    startIcon={<Icon>send</Icon>}
                                    disabled={!purchased}
                                    onClick={submitReview}
                                  >
                                    投稿（モック）
                                  </Button>
                                </Stack>
                              </Stack>
                            </CardContent>
                          </Card>
                        </Grid>

                        {/* Reviews list */}
                        <Grid item xs={12}>
                          <Typography sx={{ fontWeight: 900, mt: 1 }}>レビュー</Typography>
                          <Divider sx={{ my: 1 }} />

                          <Stack spacing={1.2}>
                            {detail.reviewsAll.map((r, i) => (
                              <Box
                                key={i}
                                sx={{
                                  p: 1.2,
                                  borderRadius: 2,
                                  ...(themeMode === "sakura"
                                    ? { backgroundImage: "linear-gradient(135deg, rgba(233,30,99,.10) 0%, rgba(255,183,197,.15) 55%, rgba(46,125,50,.08) 100%)" }
                                    : themeMode === "dark"
                                    ? { bgcolor: "rgba(255,255,255,0.06)", border: "1px solid rgba(255,255,255,0.08)" }
                                    : { bgcolor: "rgba(46,125,50,0.06)" })
                                }}
                              >
                                <Stack direction="row" justifyContent="space-between" alignItems="center">
                                  <Stack direction="row" spacing={1} alignItems="center">
                                    <Typography sx={{ fontWeight: 900 }}>{r.user}</Typography>
                                    {r.mine && <Chip size="small" icon={<Icon>person</Icon>} label="自分" />}
                                    {r.date && <Typography variant="body2" color="text.secondary">{fmtDateJP(r.date)}</Typography>}
                                  </Stack>
                                  <Rating value={Number(r.stars)} readOnly size="small" />
                                </Stack>

                                <Typography variant="body2" color="text.secondary" sx={{ mt: .6 }}>
                                  {r.text}
                                </Typography>

                                {Array.isArray(r.photos) && r.photos.length > 0 && (
                                  <Stack direction="row" spacing={1} sx={{ mt: 1, flexWrap: "wrap" }}>
                                    {r.photos.slice(0,4).map((src, idx) => (
                                      <Box
                                        key={idx}
                                        component="img"
                                        src={src}
                                        alt={"review-photo-" + idx}
                                        sx={{
                                          width: 96,
                                          height: 96,
                                          objectFit: "cover",
                                          borderRadius: 2,
                                          border: "1px solid rgba(0,0,0,.12)",
                                        }}
                                      />
                                    ))}
                                  </Stack>
                                )}

                                <Stack direction="row" justifyContent="flex-end" sx={{ mt: 1 }}>
                                  <Button
                                    variant="text"
                                    size="small"
                                    startIcon={<Icon>share</Icon>}
                                    onClick={() => shareToSNS({ product: detail, review: r })}
                                  >
                                    このレビューを共有
                                  </Button>
                                </Stack>
                              </Box>
                            ))}
                          </Stack>
                        </Grid>
                      </Grid>
                    </DialogContent>

                    <DialogActions>
                      <Button onClick={()=>setDetailId(null)}>閉じる</Button>
                      <Button variant="contained" disabled startIcon={<Icon>payment</Icon>}>
                        購入へ（モック）
                      </Button>
                    </DialogActions>
                  </>
                )}
              </Dialog>

              {/* Bottom Floating Menu */}
              <div className="bottomDock">
                <div className="bottomDockInner">
                  <div className="dockGroup">
                    <Button
                      variant="text"
                      startIcon={<Icon>tune</Icon>}
                      onClick={()=>setDrawerOpen(true)}
                    >
                      フィルタ
                    </Button>
                    <DockViewSwitch />
                  </div>
                  <div className="dockGroup">
                    <ThemeSwitch />
                    <Button
                      variant="outlined"
                      startIcon={<Icon>arrow_upward</Icon>}
                      onClick={()=>window.scrollTo({top:0, behavior:"smooth"})}
                    >
                      上へ
                    </Button>
                  </div>
                </div>
              </div>

              <Snackbar
                open={snack.open}
                autoHideDuration={2200}
                onClose={()=>setSnack({open:false, msg:""})}
                message={snack.msg}
              />
            </Container>
          </Box>
        </ThemeProvider>
      );
    };

    ReactDOM.createRoot(document.getElementById("root")).render(<App />);
  </script>
</body>
</html>
