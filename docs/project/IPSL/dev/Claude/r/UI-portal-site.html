<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>統合ダッシュボード（ドメイン拡張しやすい構成）</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <!-- Fonts / Icons -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap"/>
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons"/>

  <!-- React / Babel / MUI -->
  <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js" crossorigin></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.23.8/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mui/material@5.15.3/umd/material-ui.production.min.js" crossorigin></script>

  <style>
    :root{
      --gap-xxs:4px; --gap-xs:6px; --gap-s:8px; --gap:10px; --gap-l:12px; --gap-xl:14px;
      --muted:#6b7280; --paper:#fff; --bg:#fafafa; --primary:#1976d2;
      --bar1:#64b5f6; --bar2:#42a5f5; --cmpbg:#e8eef5; --cmpbd:#d5e2f1;
    }
    html,body{ height:100% }
    body{ margin:0; font-family: Roboto, "Noto Sans JP", system-ui, -apple-system, Segoe UI, "Helvetica Neue", Arial, "Noto Sans";
      background:var(--bg); color:#1f2937; font-size:13px; }
    a, a:visited{ color:var(--primary); text-decoration:none }
    .mono{ font-variant-numeric: tabular-nums; font-feature-settings: "tnum" 1; }
    .zero-row{ background:#f5f7fa; }
    .muted{ color:var(--muted) }
    .nowrap{ white-space:nowrap; overflow:hidden; text-overflow:ellipsis }

    .domain-grid{ display:grid; grid-template-columns:1fr; gap:var(--gap) }
    .panel-grid{ display:grid; grid-template-columns:1.3fr 1fr; gap:var(--gap) }
    .kpi-grid{ display:grid; grid-template-columns:repeat(2,1fr); gap:var(--gap-xs) }
    @media(min-width:1200px){ .kpi-grid{ grid-template-columns:repeat(5,1fr) } }

    .bar{ background: linear-gradient(180deg,#90caf9,var(--bar1)); border-radius:6px 6px 0 0; }
    .bar.zero{ outline:2px dashed #9aa1a9; outline-offset:-2px; background:transparent }
    .cmp-bar{ height:10px; background:var(--cmpbg); border-radius:999px; position:relative; overflow:hidden; border:1px solid var(--cmpbd) }
    .cmp-fill{ height:100%; background: linear-gradient(90deg,var(--bar1),var(--bar2)) }
    .cmp-line{ position:absolute; right:0; top:0; bottom:0; width:2px; background: rgba(0,0,0,.35) }

    .cover { width:100%; aspect-ratio:16/9; border-radius:10px; background:linear-gradient(135deg,#eef5ff,#f7fbff); border:1px solid #e3edf9; display:flex; align-items:center; justify-content:center; color:#1f5fbf; }
    .sticky-actions{ position:sticky; top:-1px; z-index:2; background:var(--paper); padding-bottom:6px }
    .table-toolbar{ display:flex; gap:6px; align-items:center; flex-wrap:wrap; margin-bottom:6px }

    .pdf-links{ white-space:pre-wrap; word-break:break-all; max-height:100px; overflow:auto; font-size:12px }
  </style>
</head>
<body>
  <div id="app"></div>

  <script type="text/babel">
    const {
      Box, Container, Typography, Stack, Chip, Divider, Button,
      FormControl, InputLabel, Select, MenuItem, OutlinedInput,
      Checkbox, ListItemText, TextField, Card, CardContent,
      Table, TableBody, TableCell, TableContainer, TableHead, TableRow,
      Paper, Grid, Tooltip, ThemeProvider, createTheme, IconButton,
      Dialog, DialogTitle, DialogContent, DialogActions, Snackbar, Alert, Menu, Collapse,
      Accordion, AccordionSummary, AccordionDetails, Switch, FormControlLabel
    } = MaterialUI;

    /* ========== テーマ ========== */
    const theme = createTheme({
      palette:{ mode:'light', primary:{ main:'#1976d2' }, background:{ default:'#fafafa', paper:'#ffffff' } },
      shape:{ borderRadius:10 },
      typography:{ fontSize:13 },
      components:{
        MuiCard:{ styleOverrides:{ root:{ border:'1px solid #e5e7eb' } } },
        MuiCardContent:{ styleOverrides:{ root:{ padding:8, '&:last-child':{ paddingBottom:8 } } } },
        MuiContainer:{ defaultProps:{ disableGutters:true } },
        MuiTextField:{ defaultProps:{ size:'small', margin:'dense' } },
        MuiFormControl:{ defaultProps:{ size:'small', margin:'dense' } },
        MuiSelect:{ defaultProps:{ size:'small' } },
        MuiInputLabel:{ defaultProps:{ size:'small' } },
        MuiOutlinedInput:{ defaultProps:{ margin:'dense' } },
        MuiButton:{ defaultProps:{ size:'small' } },
        MuiIconButton:{ defaultProps:{ size:'small' } },
        MuiChip:{ defaultProps:{ size:'small' } },
        MuiSwitch:{ defaultProps:{ size:'small' } },
        MuiTableHead:{ styleOverrides:{ root:{ background:'#f3f6fb' } } },
        MuiTableCell:{
          styleOverrides:{
            root:{ paddingTop:4, paddingBottom:4, paddingLeft:8, paddingRight:8, fontSize:12, lineHeight:1.4 },
            sizeSmall:{ paddingTop:2, paddingBottom:2 }
          }
        },
        MuiTableRow:{ styleOverrides:{ root:{ height:28 } } },
        MuiMenuItem:{ styleOverrides:{ root:{ minHeight:28, paddingTop:4, paddingBottom:4 } } },
        MuiListItem:{ defaultProps:{ dense:true } },
        MuiAccordionSummary:{ styleOverrides:{ root:{ minHeight:32, padding:0 }, content:{ margin:'6px 0' } } },
        MuiAccordionDetails:{ styleOverrides:{ root:{ padding:8 } } },
        MuiTooltip:{ defaultProps:{ arrow:true } }
      }
    });

    /* ========== マスタ ========== */
    const FACILITY_MASTER = [
      { id:'HQ', name:'本社', type:'管理拠点', address:'東京都千代田区1-1-1', openHours:'平日 9:00-18:00', manager:'田中', phone:'03-0000-0000', floorArea:1200, pos:8,  parking:20, lastRenovation:'2023-10-01', tenantCount:0 },
      { id:'S1', name:'店舗A（工場A 併設）', type:'店舗', address:'神奈川県川崎市川崎区2-3-4', openHours:'年中無休 10:00-21:00', manager:'佐藤', phone:'044-000-0000', floorArea:1800, pos:14, parking:60, lastRenovation:'2024-04-12', tenantCount:4 },
      { id:'S2', name:'店舗B', type:'店舗', address:'埼玉県さいたま市大宮区5-6-7', openHours:'年中無休 9:00-22:00', manager:'鈴木', phone:'048-000-0000', floorArea:1500, pos:12, parking:35, lastRenovation:'2022-11-20', tenantCount:6 },
      { id:'DC', name:'物流センター', type:'物流', address:'千葉県市川市8-9-10', openHours:'24H/365D', manager:'高橋', phone:'047-000-0000', floorArea:5000, pos:4,  parking:30, lastRenovation:'2021-08-01', tenantCount:0 },
      { id:'R1', name:'研究棟', type:'研究', address:'神奈川県横浜市港北区11-12-13', openHours:'平日 9:00-18:00', manager:'伊藤', phone:'045-000-0000', floorArea:900,  pos:2,  parking:10, lastRenovation:'2024-07-15', tenantCount:0 }
    ];
    const FACILITIES = FACILITY_MASTER.map(f=>({id:f.id, label:f.name}));
    const labelOfFacility = (id)=> FACILITIES.find(f=>f.id===id)?.label || id;

    // ドメイン分離：契約と法令を独立
    const DOMAINS = [
      { id:'client',  name:'取引先管理' },
      { id:'store',   name:'店舗管理' },
      { id:'equip',   name:'設備管理' },
      { id:'tenant',  name:'テナント管理' },
      { id:'neighbor',name:'近隣管理' },
      { id:'history', name:'履歴管理' },
      { id:'sales',   name:'売上管理' },
      { id:'building',name:'建物情報管理' },
      { id:'land',    name:'土地情報管理' },
      { id:'ops',     name:'店舗営業管理' },
      { id:'contract',name:'契約管理' },     // ← 旧「契約・法令管理」から分離
      { id:'law',     name:'法令対応管理' }  // ← 新設
    ];

    const CATEGORY_MASTER = {
      client:{ main:[{id:'client-supplier',name:'仕入先'},{id:'client-customer',name:'販売先'},{id:'client-outsourcing',name:'委託'}], sub:{ 'client-supplier':[ {id:'client-supplier-major',name:'大手'},{id:'client-supplier-local',name:'地域'},{id:'client-supplier-new',name:'新規'} ], 'client-customer':[ {id:'client-customer-major',name:'大手'},{id:'client-customer-local',name:'地域'},{id:'client-customer-warning',name:'要注意'},{id:'client-customer-stop',name:'停止'} ], 'client-outsourcing':[ {id:'client-outsourcing-system',name:'システム'},{id:'client-outsourcing-logi',name:'物流'} ] } },
      store:{ main:[{id:'store-direct',name:'直営'},{id:'store-fc',name:'FC'},{id:'store-coop',name:'共同運営'}], sub:{ 'store-direct':[ {id:'store-direct-large',name:'大型'},{id:'store-direct-mid',name:'中型'},{id:'store-direct-small',name:'小型'} ], 'store-fc':[ {id:'store-fc-station',name:'駅前'},{id:'store-fc-suburb',name:'郊外'} ], 'store-coop':[ {id:'store-coop-temp',name:'期間限定'} ] } },
      equip:{ main:[{id:'equip-plant',name:'機械設備'},{id:'equip-facility',name:'店舗施設'},{id:'equip-gear',name:'装備'},{id:'equip-fixture',name:'備品'},{id:'equip-vehicle',name:'車両'}], sub:{ 'equip-plant':[ {id:'equip-plant-ac',name:'空調'},{id:'equip-plant-power',name:'電源'},{id:'equip-plant-camera',name:'監視'} ], 'equip-facility':[ {id:'equip-facility-doors',name:'自動ドア'},{id:'equip-facility-pos',name:'POS'},{id:'equip-facility-shelf',name:'什器'} ], 'equip-gear':[ {id:'equip-gear-tools',name:'工具'},{id:'equip-gear-esl',name:'電子棚札GW'} ], 'equip-fixture':[ {id:'equip-fixture-rack',name:'ラック'} ], 'equip-vehicle':[ {id:'equip-vehicle-car',name:'車両'} ] } },
      tenant:{ main:[{id:'tenant-direct',name:'本社直営'},{id:'tenant-leasing',name:'リーシング'},{id:'tenant-event',name:'短期催事'}], sub:{ 'tenant-direct':[ {id:'tenant-direct-food',name:'飲食'},{id:'tenant-direct-goods',name:'物販'},{id:'tenant-direct-service',name:'サービス'} ], 'tenant-leasing':[ {id:'tenant-leasing-limited',name:'期間限定'} ], 'tenant-event':[ {id:'tenant-event-weekend',name:'週末'} ] } },
      neighbor:{ main:[{id:'neighbor-competitor',name:'競合'},{id:'neighbor-public',name:'公共施設'},{id:'neighbor-transport',name:'交通拠点'}], sub:{ 'neighbor-competitor':[ {id:'neighbor-competitor-large',name:'大型SC'},{id:'neighbor-competitor-gms',name:'GMS'},{id:'neighbor-competitor-cvs',name:'コンビニ'} ], 'neighbor-public':[ {id:'neighbor-public-school',name:'学校'},{id:'neighbor-public-hospital',name:'病院'} ], 'neighbor-transport':[ {id:'neighbor-transport-station',name:'駅'} ] } },
      history:{ main:[{id:'history-inspection',name:'点検'},{id:'history-repair',name:'修繕'},{id:'history-accident',name:'事故'},{id:'history-claim',name:'クレーム'},{id:'history-audit',name:'監査'}], sub:{ 'history-inspection':[ {id:'history-inspection-done',name:'是正済'},{id:'history-inspection-pending',name:'未是正'} ], 'history-repair':[ {id:'history-repair-minor',name:'軽微'},{id:'history-repair-major',name:'重大'} ], 'history-accident':[ {id:'history-accident-mid',name:'中'},{id:'history-accident-major',name:'重大'} ], 'history-claim':[ {id:'history-claim-open',name:'未解決'},{id:'history-claim-closed',name:'解決'} ], 'history-audit':[ {id:'history-audit-done',name:'実施済'},{id:'history-audit-nd',name:'未実施'} ] } },
      sales:{ main:[{id:'sales-total',name:'総売上'},{id:'sales-dept',name:'部門売上'},{id:'sales-channel',name:'チャネル'}], sub:{ 'sales-total':[ {id:'sales-total-store',name:'店舗'},{id:'sales-total-ec',name:'EC'} ], 'sales-dept':[ {id:'sales-dept-food',name:'食品'},{id:'sales-dept-daily',name:'日用品'},{id:'sales-dept-elec',name:'家電'} ], 'sales-channel':[ {id:'sales-channel-to',name:'テイクアウト'},{id:'sales-channel-dine',name:'イートイン'} ] } },
      building:{ main:[{id:'bld-structure',name:'構造'},{id:'bld-use',name:'用途'},{id:'bld-seismic',name:'耐震'},{id:'bld-fire',name:'消防'}], sub:{ 'bld-structure':[ {id:'bld-structure-s',name:'S造'},{id:'bld-structure-rc',name:'RC造'} ], 'bld-use':[ {id:'bld-use-retail',name:'商業施設'},{id:'bld-use-office',name:'オフィス'} ], 'bld-seismic':[ {id:'bld-seismic-ok',name:'適合'},{id:'bld-seismic-need',name:'要改善'} ], 'bld-fire':[ {id:'bld-fire-ok',name:'適合'},{id:'bld-fire-need',name:'要改善'} ] } },
      land:{ main:[{id:'land-own',name:'所有'},{id:'land-lease',name:'賃借'},{id:'land-easement',name:'地役権'}], sub:{ 'land-own':[ {id:'land-own-long',name:'長期'},{id:'land-own-mid',name:'中期'} ], 'land-lease':[ {id:'land-lease-short',name:'短期'},{id:'land-lease-undec',name:'更新未定'} ], 'land-easement':[ {id:'land-easement-road',name:'通路'} ] } },
      ops:{ main:[{id:'ops-hours',name:'営業時間'},{id:'ops-staff',name:'人員配置'},{id:'ops-promo',name:'販促'}], sub:{ 'ops-hours':[ {id:'ops-hours-normal',name:'通常'},{id:'ops-hours-extended',name:'延長'},{id:'ops-hours-short',name:'短縮'} ], 'ops-staff':[ {id:'ops-staff-more',name:'増員'},{id:'ops-staff-less',name:'削減'} ], 'ops-promo':[ {id:'ops-promo-campaign',name:'キャンペーン'} ] } },
      contract:{ main:[{id:'ctr-rent',name:'賃貸'},{id:'ctr-maint',name:'保守'},{id:'ctr-outs',name:'委託'}],
        sub:{ 'ctr-rent':[ {id:'ctr-rent-new',name:'新規'},{id:'ctr-rent-renew',name:'更新'},{id:'ctr-rent-close',name:'解約予定'} ],
              'ctr-maint':[ {id:'ctr-maint-active',name:'稼働'},{id:'ctr-maint-exp',name:'期限切れ'} ],
              'ctr-outs':[ {id:'ctr-outs-active',name:'稼働'},{id:'ctr-outs-exp',name:'期限切れ'} ] } },
      // 追加：法令対応（テーブル構造に対応）
      law:{ main:[{id:'law-status',name:'遵守状況'},{id:'law-parking',name:'駐車'},{id:'law-bicycle',name:'駐輪'},{id:'law-barrier',name:'バリアフリー'},{id:'law-waste',name:'廃棄物'},{id:'law-application',name:'申請/届出'}],
        sub:{ 'law-status':[ {id:'law-comply',name:'遵守'},{id:'law-pending',name:'未対応'} ],
              'law-parking':[ {id:'law-park-req',name:'必要台数'},{id:'law-park-rep',name:'報告台数'} ],
              'law-bicycle':[ {id:'law-bike-req',name:'必要台数'},{id:'law-bike-rep',name:'報告台数'} ],
              'law-barrier':[ {id:'law-heart',name:'ハートビル'},{id:'law-bfree',name:'新バリアフリー'} ],
              'law-waste':[ {id:'law-waste-loc',name:'保管場所'},{id:'law-waste-pdf',name:'PDF'} ],
              'law-application':[ {id:'law-app-location',name:'立地条例'},{id:'law-app-city',name:'市条例'} ] } }
    };

    /* ========== ユーティリティ / モック生成 ========== */
    function seededRandom(seed){ let t = seed + 0x6D2B79F5; return () => { t = Math.imul(t ^ t >>> 15, t | 1); t ^= t + Math.imul(t ^ t >>> 7, t | 61); return ((t ^ t >>> 14) >>> 0) / 4294967296; }; }
    const pick = (rnd, arr) => arr[Math.floor(rnd()*arr.length)];
    const randDate = (rnd, start, end) => new Date(start.getTime() + rnd()*(end.getTime()-start.getTime()));
    const asISO = (d)=> d instanceof Date ? d.toISOString().slice(0,10) : d;

    function filterRecords(list, {facilities, q, statuses}){
      return list.filter(a=>{
        if(facilities.length && !facilities.includes(a.facility)) return false;
        const st = a.status ?? a.status2; // tenant/law互換
        if(statuses.length && st && !statuses.includes(st)) return false;
        if(q){
          const s = (a.id+' '+a.name+' '+a.facility+' '+a.owner+' '+(a.partner||'')+' '+(a.period||'')+' '+Object.values(a).join(' ')).toLowerCase();
          if(!s.includes(q.toLowerCase())) return false;
        }
        return true;
      });
    }

    function summarizeByCategory(domainId, records, level){
      const dom = CATEGORY_MASTER[domainId];
      const total = records.length;
      if(level==='main'){
        const base = dom.main.map(m=>({ id:m.id, name:m.name, count:0, run:0, alerts:0 }));
        const map = new Map(base.map(x=>[x.id,x]));
        records.forEach(r=>{
          const o = map.get(r.main); if(!o) return;
          o.count++; if((r.status??r.status2)==='稼働' || (r.status2==='遵守')) o.run++;
          if(r.date2 && new Date(r.date2)<new Date()) o.alerts++;
        });
        const rows = dom.main.map(m=>{
          const o = map.get(m.id); const runrate = o.count? (o.run/o.count*100) : null;
          return { id:m.id, name:m.name, count:o.count, ratio: total? (o.count/total*100) : null, runrate, alerts:o.alerts, muted:o.count===0 };
        });
        return { rows, total };
      } else {
        const baseRows=[]; dom.main.forEach(m=> (dom.sub[m.id]||[]).forEach(s=> baseRows.push({ id:s.id, name:`${m.name} / ${s.name}`, count:0, run:0, alerts:0 })));
        const map = new Map(baseRows.map(x=>[x.id,x]));
        records.forEach(r=>{
          const o = map.get(r.sub); if(!o) return;
          o.count++; if((r.status??r.status2)==='稼働' || (r.status2==='遵守')) o.run++;
          if(r.date2 && new Date(r.date2)<new Date()) o.alerts++;
        });
        const rows=[]; dom.main.forEach(m=> (dom.sub[m.id]||[]).forEach(s=>{
          const o = map.get(s.id); const runrate = o.count? (o.run/o.count*100) : null;
          rows.push({ id:s.id, name:`${m.name} / ${s.name}`, count:o.count, ratio: total? (o.count/total*100) : null, runrate, alerts:o.alerts, muted:o.count===0 });
        }));
        return { rows, total };
      }
    }

    function buildCompareMetrics(domainId, all, filtered){
      const make = (label, sn, sd, an, ad, noteSel, noteAll) => {
        const aR = ad? (an/ad*100) : 0;
        const sR = sd? (sn/sd*100) : 0;
        return { label, sel: aR? (sR/aR*100) : 0, detail:`選択:${sd? sR.toFixed(1)+'%':'—'} / 全体:${ad? aR.toFixed(1)+'%':'—'}${noteSel||noteAll?`（${noteSel||''}${noteSel&&noteAll?' / ':''}${noteAll||''}）`:''}` };
      };
      const totalAll = all.length, totalSel = filtered.length;
      const arr = [ make('件数構成比', totalSel, totalSel, totalAll, totalAll) ];
      if(domainId==='sales'){
        const amtAll = all.reduce((s,a)=>s+(a.amount||0),0);
        const amtSel = filtered.reduce((s,a)=>s+(a.amount||0),0);
        arr.push( make('売上構成比', amtSel, amtSel, amtAll, amtAll, `選択=${amtSel.toLocaleString()}千円`, `全体=${amtAll.toLocaleString()}千円`) );
        const qtyAll = all.reduce((s,a)=>s+(a.qty||0),0);
        const qtySel = filtered.reduce((s,a)=>s+(a.qty||0),0);
        arr.push( make('客数構成比', qtySel, qtySel, qtyAll, qtyAll, `選択=${qtySel.toLocaleString()}`, `全体=${qtyAll.toLocaleString()}`) );
        return arr;
      }
      if(domainId==='contract'){
        const expAll = all.filter(a=>a.status==='期限切れ').length;
        const expSel = filtered.filter(a=>a.status==='期限切れ').length;
        const dueAll = all.filter(a=>a.due && (new Date(a.due)-new Date())/(1000*60*60*24)<=30 && (new Date(a.due)>=new Date())).length;
        const dueSel = filtered.filter(a=>a.due && (new Date(a.due)-new Date())/(1000*60*60*24)<=30 && (new Date(a.due)>=new Date())).length;
        arr.push( make('期限切れ率', expSel, totalSel, expAll, totalAll) );
        arr.push( make('到来(30日)率', dueSel, totalSel, dueAll, totalAll) );
        return arr;
      }
      if(domainId==='law'){
        const okAll = all.filter(a=>a.status===true || a.status2==='遵守').length;
        const okSel = filtered.filter(a=>a.status===true || a.status2==='遵守').length;
        arr.push( make('遵守率', okSel, totalSel, okAll, totalAll) );
        return arr;
      }
      const faultAll = all.filter(a=>a.status==='故障').length;
      const faultSel = filtered.filter(a=>a.status==='故障').length;
      const chkAll = all.filter(a=>a.date2 && new Date(a.date2)>=new Date()).length;
      const chkSel = filtered.filter(a=>a.date2 && new Date(a.date2)>=new Date()).length;
      arr.push( make('故障率', faultSel, totalSel, faultAll, totalAll) );
      arr.push( make('点検遵守率', chkSel, totalSel, chkAll, totalAll) );
      return arr;
    }

    function downloadCSV(filename, rows){
      const csv = rows.map(r=> r.map(v=>{
        if(v==null) return '';
        const s = String(v).replace(/"/g,'""');
        return /[",\n]/.test(s) ? `"${s}"` : s;
      }).join(',')).join('\n');
      const blob = new Blob(["\ufeff"+csv], {type:'text/csv;charset=utf-8;'});
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = filename; a.click();
      URL.revokeObjectURL(a.href);
    }

    /* ========== モックデータ ========== */
    function generateMock(domainId, {seed=11, count=220}={}){
      const rnd = seededRandom(seed);
      const facilityIds = FACILITIES.map(f=>f.id);
      const commonNames = ['案件','記録','項目','タスク','対象','エントリ','申請','通知','検収','レポート'];
      const mains = CATEGORY_MASTER[domainId]?.main?.map(m=>m.id)||[];
      const arr=[]; let seq=1000;

      if(domainId==='tenant'){
        const statuses = ['有効','無効','解約予定','退去済'];
        const industries = ['飲食','物販','サービス','医療','その他'];
        for(let i=0;i<count;i++){
          const storeId = pick(rnd, facilityIds);
          const start = randDate(rnd, new Date(2023,0,1), new Date(2025,11,31));
          const end = randDate(rnd, new Date(2025,6,1), new Date(2028,11,31));
          const fixedRent = Math.round((rnd()*220+80) * 10000);
          const deposit = Math.round(fixedRent*(2+rnd()*4));
          const consPdf = rnd()>0.6 ? [] : Array.from({length:Math.floor(rnd()*3)+1}, (_,k)=>`https://example.com/c${i}-${k}.pdf`);
          const keyPdf  = rnd()>0.7 ? [] : Array.from({length:Math.floor(rnd()*2)+1}, (_,k)=>`https://example.com/k${i}-${k}.pdf`);
          arr.push({
            no:i+1, tenantId:`T-${(20250900000000+i).toString()}`, storeId, storeName:labelOfFacility(storeId),
            status: pick(rnd,statuses), category: pick(rnd,mains), name:`テナント${String(i+1).padStart(3,'0')}`,
            partnerId:'', brand: pick(rnd,['〇〇カフェ','◇◇ベーカリー','△△モバイル','□□リペア','◎◎ドラッグ','']),
            industry: pick(rnd,industries), location: pick(rnd,['1F-101','1F-115','2F-205','2F-220','3F-301','']),
            ownerId:`USR-${Math.floor(rnd()*900+100)}`, fireManager: rnd()>0.25 ? '有' : '無',
            pdfConstruction: consPdf, fixedRent, contractType: pick(rnd,['賃貸借','定期建物賃貸借','施設使用許可','']),
            contractId:`CTR-${Math.floor(rnd()*90000+10000)}`,
            contractStart: asISO(start), contractEnd: asISO(end), renewalTerms: pick(rnd,['自動更新','協議','更新無し','']),
            billingMethod: pick(rnd,['月次請求','四半期','年次','実費請求','']),
            deposit, pdfKeyHandover: keyPdf, note: rnd()>0.85?'夜間搬入制限あり':'',
            createdAt: asISO(randDate(rnd, new Date(2024,0,1), new Date(2025,5,30))),
            createdBy:'PlatForm Root', updatedAt: asISO(randDate(rnd, new Date(2025,6,1), new Date(2025,8,30))),
            updatedBy:'PlatForm Root',
            id:`TENANT-${seq++}`, main: pick(rnd,mains), sub:undefined, facility:storeId, status2:'稼働', date1:asISO(start), date2:asISO(end)
          });
        }
        return arr;
      }

      if(domainId==='sales'){
        for(let i=0;i<count;i++){
          const main = pick(rnd, mains);
          const subs = CATEGORY_MASTER[domainId].sub[main]||[];
          const sub = pick(rnd, subs.map(s=>s.id));
          const amount = Math.round(((main==='sales-dept-elec'?22:(main==='sales-dept-food'?9:12)) + rnd()*10)*100); // 千円
          const qty = Math.round(((main==='sales-dept-food'?200:70) + rnd()*140));
          const period = `2025-${String(1+Math.floor(rnd()*9)).padStart(2,'0')}`;
          arr.push({
            id:`${domainId.toUpperCase()}-${seq++}`,
            name: pick(rnd, commonNames)+'-'+Math.floor(rnd()*900+100),
            main, sub, facility: pick(rnd, facilityIds), status:'稼働',
            date1: asISO(randDate(rnd, new Date(2021,0,1), new Date(2025,5,1))),
            date2: asISO(randDate(rnd, new Date(2025,6,1), new Date(2026,3,1))),
            amount, qty, unitPrice: qty? Math.round((amount*1000)/qty): 0, period
          });
        }
        return arr;
      }

      if(domainId==='contract'){
        const cStatuses = ['稼働','期限切れ','解約予定'];
        for(let i=0;i<count;i++){
          const main = pick(rnd, mains);
          const subs = CATEGORY_MASTER[domainId].sub[main]||[];
          const sub = pick(rnd, subs.map(s=>s.id));
          const due = asISO(randDate(rnd, new Date(2025,6,1), new Date(2026,5,30)));
          arr.push({
            id:`${domainId.toUpperCase()}-${seq++}`, name: pick(rnd, commonNames)+'-'+Math.floor(rnd()*900+100),
            main, sub, facility: pick(rnd, facilityIds), status: pick(rnd, cStatuses),
            date1: asISO(randDate(rnd, new Date(2021,0,1), new Date(2025,5,1))),
            date2: asISO(randDate(rnd, new Date(2025,6,1), new Date(2026,3,1))),
            due, partner: pick(rnd,['A商事','Bサービス','C建設','D保守'])
          });
        }
        return arr;
      }

      if(domainId==='law'){
        const owners = ['PlatForm Root','法務部','店舗運営','設備管理'];
        const cats   = ['適用条例','駐車/駐輪','バリアフリー','廃棄物','営業'];
        const locLaws = ['用途地域/商業','準工業','第一種住居','近隣商業','防火/準防火'];
        const cityLaws= ['景観条例','騒音/振動','自転車放置','ごみ処理','福祉のまちづくり'];
        let seqL=6000;
        for(let i=0;i<count;i++){
          const facility = pick(rnd, facilityIds);
          const requiredParking  = Math.round(rnd()*50);
          const reportedParking  = Math.max(0, requiredParking + Math.round((rnd()-.2)*15));
          const requiredBicycle  = Math.round(rnd()*120);
          const reportedBicycle  = Math.max(0, requiredBicycle + Math.round((rnd()-.15)*40));
          const statusBool = rnd()>0.35; // 遵守=真
          const heart  = rnd()>0.65;
          const bfree  = rnd()>0.55;
          const subm   = randDate(rnd, new Date(2023,0,1), new Date(2025,8,20));
          const up     = randDate(rnd, new Date(2025,6,1), new Date(2025,8,30));
          const wasteP = rnd()>0.7 ? [] : Array.from({length:Math.floor(rnd()*2)+1}, (_,k)=>`https://example.com/w${i}-${k}.pdf`);
          const mainPick = pick(rnd, mains);
          const subs = CATEGORY_MASTER.law.sub[mainPick]||[];
          const subPick = subs.length ? pick(rnd, subs.map(s=>s.id)) : undefined;

          arr.push({
            id: seqL++, legal_id:`LG-${202500000+i}`, store_id_key: facility, status: statusBool,
            category: pick(rnd, cats), location_law: pick(rnd, locLaws), city_law: pick(rnd, cityLaws),
            submission_date: asISO(subm), business_hours: pick(rnd, ['9-21','10-22','24H','短縮','—']),
            required_parking_spots: requiredParking, reported_parking_spots: reportedParking,
            required_bicycle_spots: requiredBicycle, reported_bicycle_spots: reportedBicycle,
            delivery_time: pick(rnd, ['日中','夜間','早朝','—']),
            old_heart_building_compliance: heart, new_barrier_free_compliance: bfree,
            waste_location: pick(rnd, ['北側ヤード','地下ピット','バックヤード','—']),
            waste_capacity: pick(rnd, ['1.5m³','3.0m³','5.0m³','—']),
            waste_pdf: wasteP,
            building_owner_type: pick(rnd, ['法人','個人','区分所有']),
            building_owner_representative: pick(rnd, ['田中','佐藤','鈴木','—']),
            store_operator_type: pick(rnd, ['直営','FC','協業']),
            store_operator_representative: pick(rnd, ['店長','副店長','統括','—']),
            notes: rnd()>0.85 ? '夜間搬入制限あり' : '',
            created_at: asISO(randDate(rnd, new Date(2024,0,1), new Date(2025,5,30))),
            created_by: pick(rnd, owners),
            updated_at: asISO(up),
            updated_by: pick(rnd, owners),
            is_deleted: false,
            name:`法令対応-${i+1}`, main: mainPick, sub: subPick, facility, status2: statusBool ? '遵守' : '未対応',
            date1: asISO(subm), date2: asISO(up)
          });
        }
        return arr;
      }

      // その他は汎用
      const base = (rec)=>({
        id: rec.id || `${domainId.toUpperCase()}-${seq++}`,
        name: rec.name || (pick(rnd, commonNames)+'-'+Math.floor(rnd()*900+100)),
        main: rec.main || pick(rnd, mains),
        sub:  rec.sub  || (CATEGORY_MASTER[domainId]?.sub?.[rec.main]||[])[0]?.id,
        facility: rec.facility || pick(rnd, facilityIds),
        status: rec.status || pick(rnd, ['稼働','点検中','故障']),
        date1: rec.date1 || asISO(randDate(rnd, new Date(2021,0,1), new Date(2025,5,1))),
        date2: rec.date2 || asISO(randDate(rnd, new Date(2025,6,1), new Date(2026,3,1))),
        owner: rec.owner || pick(rnd, ['店長','副店長','担当']),
        ...rec.extra
      });
      for(let i=0;i<count;i++){
        const main = pick(rnd, mains);
        const subs = CATEGORY_MASTER[domainId]?.sub?.[main]||[];
        const sub = subs.length? pick(rnd, subs.map(s=>s.id)) : undefined;
        arr.push(base({main, sub}));
      }
      return arr;
    }

    /* ========== ミニ部品 ========== */
    const Spark = ({points=24})=>{
      const ys = Array.from({length:points},()=> 6 + Math.round(Math.random()*18));
      const path = ys.map((y,i)=> `${i===0?'M':'L'} ${i*6} ${30-y}`).join(' ');
      return (<svg width={6*(points-1)} height="30" viewBox={`0 0 ${6*(points-1)} 30`} className="mono"><path d={path} fill="none" stroke="currentColor" opacity="0.6"/></svg>);
    };
    const MicroBar = ({value, max, label})=>(
      <Tooltip title={`${label}: ${value}件`}>
        <Box sx={{display:'flex', flexDirection:'column', alignItems:'center', minWidth:48}}>
          <Box className={value===0?'bar zero':'bar'} sx={{width:24, height:(value/Math.max(1,max)*150)+10}}/>
          <Typography variant="caption" color="text.secondary" className="nowrap" sx={{maxWidth:72, mt:.75}}>{label}</Typography>
        </Box>
      </Tooltip>
    );
    const Progress = ({pct, detail})=>(
      <Box sx={{mb:.75}}>
        <Box className="cmp-bar"><Box className="cmp-fill" style={{width:`${Math.min(100,Math.max(0,pct)).toFixed(1)}%`}}/><Box className="cmp-line"/></Box>
        <Stack direction="row" justifyContent="space-between">
          <Chip size="small" label="全体=100%" />
          <Tooltip title={detail}><Chip size="small" color="primary" variant="outlined" label={`選択=${Math.min(100,Math.max(0,pct)).toFixed(1)}%`} /></Tooltip>
        </Stack>
      </Box>
    );

    /* ========== 汎用ダイアログ ========== */
    function EditDialog({open, onClose, record, onSave}){
      const [form, setForm] = React.useState(record||{});
      React.useEffect(()=>setForm(record||{}),[record]);
      const set = (k)=>(e)=> setForm(s=>({...s,[k]:e.target.value}));
      return (
        <Dialog open={open} onClose={onClose} fullWidth maxWidth="sm">
          <DialogTitle>レコード編集（デモ）</DialogTitle>
          <DialogContent dividers sx={{display:'grid', gap:1.0, pt:1.0}}>
            <TextField label="ID" value={form.id||''} onChange={set('id')} />
            <TextField label="名称" value={form.name||''} onChange={set('name')} />
            <TextField label="主カテゴリ" value={form.main||''} onChange={set('main')} />
            <TextField label="サブカテゴリ" value={form.sub||''} onChange={set('sub')} />
            <TextField label="施設" value={form.facility||''} onChange={set('facility')} />
            <TextField label="状態" value={form.status||''} onChange={set('status')} />
            <TextField label="基準日1" value={form.date1||''} onChange={set('date1')} />
            <TextField label="基準日2/期限" value={form.date2||form.due||''} onChange={set('date2')} />
            <TextField label="担当" value={form.owner||''} onChange={set('owner')} />
          </DialogContent>
          <DialogActions sx={{px:1, py:1}}>
            <Button onClick={onClose}>キャンセル</Button>
            <Button variant="contained" onClick={()=>onSave(form)}>保存（ダミー）</Button>
          </DialogActions>
        </Dialog>
      );
    }

    /* ========== 施設概要（単一施設選択時） ========== */
    function FacilityOverview({facilityId, allRecords}){
      const f = FACILITY_MASTER.find(x=>x.id===facilityId);
      if(!f) return null;
      const assets = allRecords.filter(a=>a.facility===facilityId);
      const total = assets.length;
      const faults = assets.filter(a=> (a.status??a.status2)==='故障' || (a.status??a.status2)==='期限切れ').length;
      const running = assets.filter(a=> (a.status??a.status2)==='稼働').length;
      const coming30 = assets.filter(a=>{
        const d = a.date2 || a.due; if(!d) return false;
        const dd = new Date(d); const diff=(dd - new Date())/(1000*60*60*24);
        return diff>=0 && diff<=30;
      }).length;
      const chain = {
        floorAreaAvg: Math.round(FACILITY_MASTER.reduce((s,x)=>s+x.floorArea,0)/FACILITY_MASTER.length),
        posAvg: Math.round(FACILITY_MASTER.reduce((s,x)=>s+x.pos,0)/FACILITY_MASTER.length)
      };
      return (
        <Card sx={{mb:2}}>
          <CardContent>
            <Stack direction={{xs:'column', md:'row'}} spacing={2}>
              <Box sx={{minWidth:280, maxWidth:420, flex:1}}>
                <Box className="cover"><span className="material-icons" style={{marginRight:8}}>storefront</span>{f.name}（{f.type}）</Box>
                <Box sx={{mt:1}}>
                  <Typography variant="body2" color="text.secondary"><span className="material-icons" style={{fontSize:16,verticalAlign:'-3px',marginRight:4}}>place</span>{f.address}</Typography>
                  <Typography variant="body2" color="text.secondary"><span className="material-icons" style={{fontSize:16,verticalAlign:'-3px',marginRight:4}}>schedule</span>{f.openHours}</Typography>
                  <Typography variant="body2" color="text.secondary"><span className="material-icons" style={{fontSize:16,verticalAlign:'-3px',marginRight:4}}>call</span>{f.phone}</Typography>
                </Box>
              </Box>
              <Box sx={{flex:2}}>
                <Typography variant="h6" gutterBottom>施設概要</Typography>
                <Grid container spacing={1}>
                  <Grid item xs={6} md={3}><Card variant="outlined"><CardContent>
                    <Typography color="text.secondary" variant="body2">売場面積</Typography>
                    <Typography variant="h5" className="mono">{f.floorArea.toLocaleString()} ㎡</Typography>
                    <Typography variant="caption" color="text.secondary">チェーン平均 {chain.floorAreaAvg} ㎡</Typography>
                  </CardContent></Card></Grid>
                  <Grid item xs={6} md={3}><Card variant="outlined"><CardContent>
                    <Typography color="text.secondary" variant="body2">POS台数</Typography>
                    <Typography variant="h5" className="mono">{f.pos}</Typography>
                    <Typography variant="caption" color="text.secondary">チェーン平均 {chain.posAvg}</Typography>
                  </CardContent></Card></Grid>
                  <Grid item xs={6} md={3}><Card variant="outlined"><CardContent>
                    <Typography color="text.secondary" variant="body2">テナント数</Typography>
                    <Typography variant="h5" className="mono">{f.tenantCount}</Typography>
                    <Typography variant="caption" color="text.secondary">最終改装 {f.lastRenovation}</Typography>
                  </CardContent></Card></Grid>
                  <Grid item xs={6} md={3}><Card variant="outlined"><CardContent>
                    <Typography color="text.secondary" variant="body2">駐車台数</Typography>
                    <Typography variant="h5" className="mono">{f.parking}</Typography>
                    <Typography variant="caption" color="text.secondary">責任者 {f.manager}</Typography>
                  </CardContent></Card></Grid>
                </Grid>

                <Divider sx={{my:2}} />

                <Grid container spacing={1}>
                  <Grid item xs={6} md={3}><Card variant="outlined"><CardContent>
                    <Typography color="text.secondary" variant="body2">関連レコード数</Typography>
                    <Typography variant="h5" className="mono">{total}</Typography>
                  </CardContent></Card></Grid>
                  <Grid item xs={6} md={3}><Card variant="outlined"><CardContent>
                    <Typography color="text.secondary" variant="body2">稼働率（参考）</Typography>
                    <Typography variant="h5" className="mono">{total? Math.round(running/total*100):'—'}%</Typography>
                    <Typography variant="caption" color="text.secondary">稼働 {running}/{total}</Typography>
                  </CardContent></Card></Grid>
                  <Grid item xs={6} md={3}><Card variant="outlined"><CardContent>
                    <Typography color="text.secondary" variant="body2">故障/期限切れ</Typography>
                    <Typography variant="h5" className="mono">{faults}</Typography>
                  </CardContent></Card></Grid>
                  <Grid item xs={6} md={3}><Card variant="outlined"><CardContent>
                    <Typography color="text.secondary" variant="body2">30日以内到来</Typography>
                    <Typography variant="h5" className="mono">{coming30}</Typography>
                  </CardContent></Card></Grid>
                </Grid>
              </Box>
            </Stack>
          </CardContent>
        </Card>
      );
    }

    /* ========== パネル：テナント専用 ========== */
    function TenantSummaryPanel({records}){
      const toNum = v=> typeof v==='number'? v : Number(v||0);
      const total = records.length;
      const sum = (fn)=> records.reduce((s,r)=> s + toNum(fn(r)||0), 0);
      const avg = (fn)=> total? Math.round(sum(fn)/total) : 0;
      const uniq = (fn)=> new Set(records.map(fn).filter(Boolean)).size;
      const cntIf = (fn)=> records.filter(fn).length;
      const minDate = (fn)=> records.map(fn).filter(Boolean).sort()[0] || '—';
      const maxDate = (fn)=> records.map(fn).filter(Boolean).sort().slice(-1)[0] || '—';

      const kpis = [
        {label:'テナント数', val: total.toLocaleString()},
        {label:'平均 定額賃料(円)', val: avg(r=>r.fixedRent).toLocaleString()},
        {label:'保証金 合計(円)', val: sum(r=>r.deposit).toLocaleString()},
        {label:'契約形態 数', val: uniq(r=>r.contractType)},
        {label:'請求方法 数', val: uniq(r=>r.billingMethod)}
      ];

      const chips = {
        status: [...records.reduce((m,r)=>{ const k=r.status; if(k) m.set(k,(m.get(k)||0)+1); return m; }, new Map())]
                  .map(([k,v])=> ({k, v})),
        renewal: [...records.reduce((m,r)=>{ const k=r.renewalTerms; if(k) m.set(k,(m.get(k)||0)+1); return m; }, new Map())]
                  .map(([k,v])=> ({k, v})),
      };

      return (
        <Card sx={{mb:2}}>
          <CardContent>
            <Stack direction="row" justifyContent="space-between" alignItems="center" sx={{mb:1}}>
              <Typography variant="h6">テナント管理 — 列情報サマリ</Typography>
              <Stack direction="row" gap={1} alignItems="center">
                <Typography color="text.secondary" variant="body2">対象 {total} 件</Typography>
                <Spark />
              </Stack>
            </Stack>

            <Grid container spacing={0.75} sx={{mb:1}}>
              {kpis.map(k=>(
                <Grid item xs={6} md={2.4} key={k.label}>
                  <Card variant="outlined" sx={{p:1}}>
                    <Typography variant="body2" color="text.secondary">{k.label}</Typography>
                    <Typography variant="h6" className="mono">{k.val}</Typography>
                  </Card>
                </Grid>
              ))}
              <Grid item xs={12} md={7.2}>
                <Card variant="outlined" sx={{p:1}}>
                  <Stack direction="row" alignItems="center" justifyContent="space-between">
                    <Typography variant="body2" color="text.secondary">ステータス内訳</Typography>
                    <Spark points={18}/>
                  </Stack>
                  <Stack direction="row" gap={0.75} flexWrap="wrap" sx={{mt:0.5}}>
                    {chips.status.map(c=> <Chip key={c.k} label={`${c.k}:${c.v}`} />)}
                  </Stack>
                </Card>
              </Grid>
              <Grid item xs={12} md={4.8}>
                <Card variant="outlined" sx={{p:1}}>
                  <Typography variant="body2" color="text.secondary">更新条件 内訳</Typography>
                  <Stack direction="row" gap={0.75} flexWrap="wrap" sx={{mt:0.5}}>
                    {chips.renewal.map(c=> <Chip key={c.k} label={`${c.k}:${c.v}`} />)}
                  </Stack>
                </Card>
              </Grid>
              <Grid item xs={12} md={6}>
                <Card variant="outlined" sx={{p:1}}>
                  <Typography variant="body2" color="text.secondary">契約期間</Typography>
                  <Typography className="mono" sx={{mt:0.5}}>開始 最小: {minDate(r=>r.contractStart)} ／ 最大: {maxDate(r=>r.contractStart)}</Typography>
                  <Typography className="mono">終了 最小: {minDate(r=>r.contractEnd)} ／ 最大: {maxDate(r=>r.contractEnd)}</Typography>
                </Card>
              </Grid>
              <Grid item xs={12} md={6}>
                <Card variant="outlined" sx={{p:1}}>
                  <Typography variant="body2" color="text.secondary">PDF / 担当者</Typography>
                  <Stack direction="row" gap={0.75} flexWrap="wrap" sx={{mt:0.5}}>
                    <Chip label={`工事区分表PDF: ${cntIf(r=>(r.pdfConstruction||[]).length>0).toLocaleString()}件`} />
                    <Chip label={`鍵引渡書PDF: ${cntIf(r=>(r.pdfKeyHandover||[]).length>0).toLocaleString()}件`} />
                    <Chip label={`担当者数: ${uniq(r=>r.ownerId)}名`} />
                    <Chip label={`防火管理者「有」: ${cntIf(r=>r.fireManager==='有')}件`} />
                  </Stack>
                </Card>
              </Grid>
            </Grid>

            <Typography variant="subtitle2" sx={{mt:1, mb:0.5}}>列構成プレビュー（先頭10件）</Typography>
            {(() => {
              const previewCols = [
                { key: "no", label: "No." },
                { key: "tenantId", label: "テナントID", mono: true },
                { key: "storeName", label: "店舗名" },
                { key: "status", label: "ステータス" },
                { key: "name", label: "名称" },
                { key: "fixedRentFmt", label: "定額賃料", mono: true, align: "right" },
                { key: "contractSpan", label: "契約期間", mono: true },
                { key: "pdfCounts", label: "PDF", mono: true },
              ];
              const rows = records.slice(0, 10).map((r) => ({
                ...r,
                fixedRentFmt: (r.fixedRent || 0).toLocaleString(),
                contractSpan: [r.contractStart, r.contractEnd].filter(Boolean).join(" ~ "),
                pdfCounts: `工事:${(r.pdfConstruction || []).length} / 鍵:${(r.pdfKeyHandover || []).length}`,
              }));
              return (
                <TableContainer component={Paper} variant="outlined" sx={{ borderRadius: 1.5 }}>
                  <Table stickyHeader size="small" sx={{"& th, & td": { py: 0.25, px: 1 }, "& thead th": { backgroundColor: "#f3f6fb" }}}>
                    <TableHead><TableRow>{previewCols.map(c=> <TableCell key={c.key} align={c.align||'left'}>{c.label}</TableCell>)}</TableRow></TableHead>
                    <TableBody>
                      {rows.map((r, idx) => (
                        <TableRow key={r.tenantId || idx} hover>
                          {previewCols.map((c) => (
                            <TableCell key={c.key} align={c.align || "left"} className={(c.mono ? "mono " : "") + "nowrap"} sx={{ maxWidth: 220 }} title={String(r[c.key] ?? "")}>
                              {String(r[c.key] ?? "")}
                            </TableCell>
                          ))}
                        </TableRow>
                      ))}
                    </TableBody>
                  </Table>
                </TableContainer>
              );
            })()}
          </CardContent>
        </Card>
      );
    }

    /* ========== パネル：汎用（他ドメインのデフォルト） ========== */
    function GenericPanel({domainId, title, list, filters, allForCompare, demoMode}){
      const [localQ, setLocalQ] = React.useState('');
      const [sortKey, setSortKey] = React.useState('count');
      const [sortAsc, setSortAsc] = React.useState(false);
      const [anchorEl, setAnchorEl] = React.useState(null);
      const [editTarget, setEditTarget] = React.useState(null);
      const [snack, setSnack] = React.useState({open:false, msg:''});

      const filteredBase = React.useMemo(()=>filterRecords(list, filters), [list, filters.facilities, filters.q, filters.statuses]);
      const filtered = React.useMemo(()=>{
        if(!localQ) return filteredBase;
        const q = localQ.toLowerCase();
        return filteredBase.filter(a=>{
          const s = (a.id+' '+a.name+' '+a.main+' '+a.sub+' '+Object.values(a).join(' ')).toLowerCase();
          return s.includes(q);
        });
      }, [filteredBase, localQ]);

      const sMainRaw = React.useMemo(()=>summarizeByCategory(domainId, filtered, 'main'), [domainId, filtered]);
      const sMain = React.useMemo(()=>{
        const rows = [...sMainRaw.rows];
        rows.sort((a,b)=>{
          const A = a[sortKey]==null?-Infinity:a[sortKey];
          const B = b[sortKey]==null?-Infinity:b[sortKey];
          const cmp = A<B ? -1 : A>B ? 1 : 0;
          return sortAsc? cmp : -cmp;
        });
        return { ...sMainRaw, rows };
      }, [sMainRaw, sortKey, sortAsc]);

      const total = filtered.length;
      const running = filtered.filter(a=>a.status==='稼働').length;
      const alerts  = filtered.filter(a=>a.date2 && new Date(a.date2) < new Date()).length;
      const facilityCount = new Set(filtered.map(a=>a.facility)).size;

      const kpis = [
        {label:'総件数', val: total},
        {label:'稼働率', val: total? Math.round(running/total*100)+'%':'—', sub:`稼働 ${running}/${total}`},
        {label:'アラート件数', val: alerts},
        {label:'施設数', val: facilityCount},
        {label:'主分類数', val: sMain.rows.length}
      ];

      const compare = React.useMemo(()=>buildCompareMetrics(domainId, allForCompare, filtered),
        [domainId, allForCompare, filtered]);

      const barMax = Math.max(1, ...sMain.rows.map(r=>r.count));

      const exportCSV = ()=>{
        const rows = [["カテゴリ","件数","全体比(%)","稼働率/遵守率(%)","アラート件数"]];
        sMain.rows.forEach(r=> rows.push([r.name, r.count, sMain.total? (r.ratio?.toFixed(1)) : '—', r.runrate==null?'—':r.runrate.toFixed(1), r.alerts]));
        downloadCSV(`${title}_主分類サマリ.csv`, rows);
      };

      const handleSave = (form)=>{
        setSnack({open:true, msg:`${title}: ${form.id || '(新規)'} を保存しました（ダミー）`});
        setEditTarget(null);
      };

      return (
        <Card>
          <CardContent>
            <Stack direction="row" justifyContent="space-between" alignItems="center" sx={{mb:1}}>
              <Typography variant="h6">{title}</Typography>
              <Typography color="text.secondary" variant="body2">対象 {filtered.length} 件</Typography>
            </Stack>

            <Collapse in={demoMode} unmountOnExit>
              <Box className="sticky-actions">
                <Box className="table-toolbar">
                  <TextField size="small" label="このドメイン内検索（主・サブ・名称）" value={localQ} onChange={(e)=>setLocalQ(e.target.value)} sx={{minWidth:320}} />
                  <Button size="small" variant="outlined" onClick={exportCSV} startIcon={<span className="material-icons">download</span>}>CSV</Button>
                  <Button size="small" onClick={(e)=>setAnchorEl(e.currentTarget)} startIcon={<span className="material-icons">sort</span>}>並び替え</Button>
                  <Menu anchorEl={anchorEl} open={Boolean(anchorEl)} onClose={()=>setAnchorEl(null)}>
                    {[{k:'count',label:'件数'},{k:'name',label:'名称'},{k:'ratio',label:'全体比'},{k:'runrate',label:'稼働/遵守率'}].map(opt=>(
                      <MenuItem key={opt.k} onClick={()=>{ setSortKey(opt.k); setAnchorEl(null); }}>
                        {sortKey===opt.k ? <span className="material-icons" style={{fontSize:18,marginRight:6}}>check</span> : null}
                        {opt.label}
                      </MenuItem>
                    ))}
                    <Divider />
                    <MenuItem onClick={()=>{ setSortAsc(a=>!a); setAnchorEl(null); }}>
                      <span className="material-icons" style={{fontSize:18,marginRight:6}}>{sortAsc?'arrow_upward':'arrow_downward'}</span>
                      {sortAsc?'昇順':'降順'}
                    </MenuItem>
                  </Menu>
                  <Button size="small" variant="contained" onClick={()=>setEditTarget({})} startIcon={<span className="material-icons">add</span>}>新規（ダミー）</Button>
                </Box>
              </Box>
            </Collapse>

            {/* KPI */}
            <Box className="kpi-grid" style={{marginBottom:12}}>
              {kpis.map(k=>(
                <Card key={k.label} variant="outlined" sx={{p:1.25}}>
                  <Typography color="text.secondary" variant="body2">{k.label}</Typography>
                  <Typography variant="h5" className="mono">{k.val}</Typography>
                  {k.sub && <Typography color="text.secondary" variant="caption">{k.sub}</Typography>}
                </Card>
              ))}
            </Box>

            {/* 主分類サマリ + 比較 */}
            <Box className="panel-grid">
              <Box>
                <Typography variant="subtitle2" gutterBottom>分類別サマリー（主カテゴリ）</Typography>
                <Box sx={{overflowX:'auto', mb:1.0}}>
                  <Box sx={{display:'flex', alignItems:'end', gap:1, height:180, p:1}}>
                    {sMain.rows.map(r=>(<MicroBar key={r.id} value={r.count} max={barMax} label={r.name}/>))}
                  </Box>
                </Box>
                <TableContainer component={Paper} variant="outlined">
                  <Table size="small" stickyHeader>
                    <TableHead>
                      <TableRow>
                        <TableCell>カテゴリ</TableCell>
                        <TableCell align="right">件数</TableCell>
                        <TableCell align="right">全体比(%)</TableCell>
                        <TableCell align="right">稼働率/遵守率(%)</TableCell>
                        <TableCell align="right">アラート件数</TableCell>
                        {demoMode && <TableCell align="center">操作</TableCell>}
                      </TableRow>
                    </TableHead>
                    <TableBody>
                      {sMain.rows.map(r=>(
                        <TableRow key={r.id} className={r.muted?'zero-row':''} hover>
                          <TableCell>{r.name}</TableCell>
                          <TableCell align="right" className="mono">{r.count}</TableCell>
                          <TableCell align="right" className="mono">{sMain.total? (r.ratio?.toFixed(1)) : '—'}</TableCell>
                          <TableCell align="right" className="mono">{r.runrate==null? '—' : r.runrate.toFixed(1)}</TableCell>
                          <TableCell align="right" className="mono">{r.alerts}</TableCell>
                          {demoMode && (
                            <TableCell align="center">
                              <Tooltip title="編集（ダミー）">
                                <IconButton size="small" onClick={()=>setEditTarget({
                                  id: `${domainId.toUpperCase()}-${r.id}`,
                                  name: `${title}:${r.name}`,
                                  main: r.id, sub:'', facility: '', status: '稼働',
                                  date1: '', date2: '', owner:'担当'
                                })}>
                                  <span className="material-icons" style={{fontSize:18}}>edit</span>
                                </IconButton>
                              </Tooltip>
                            </TableCell>
                          )}
                        </TableRow>
                      ))}
                    </TableBody>
                  </Table>
                </TableContainer>
              </Box>

              <Box>
                <Typography variant="subtitle2" gutterBottom>比較パネル（全体＝100%基準）</Typography>
                <Typography variant="body2" color="text.secondary" sx={{mb:1}}>
                  全体を常に<b>100%</b>とし、選択対象の相対値（%）を表示。ツールチップに実比率を表記します。
                </Typography>
                <Stack gap={1.0}>
                  {compare.map((m,i)=>(
                    <Box key={m.label}>
                      <Stack direction="row" justifyContent="space-between" sx={{mb:.25}}>
                        <Stack direction="row" gap={.5} alignItems="center">
                          <span className="material-icons" style={{fontSize:16,opacity:.6}}>
                            {i===0?'widgets': i===1?'trending_up': 'insights'}
                          </span>
                          <Typography>{m.label}</Typography>
                        </Stack>
                        <Typography color="text.secondary">{m.detail}</Typography>
                      </Stack>
                      <Progress pct={m.sel} detail={m.detail}/>
                    </Box>
                  ))}
                </Stack>
              </Box>
            </Box>

            {demoMode && (
              <>
                <EditDialog open={!!editTarget} record={editTarget} onClose={()=>setEditTarget(null)} onSave={handleSave}/>
                <Snackbar open={snack.open} autoHideDuration={2200} onClose={()=>setSnack({open:false,msg:''})}>
                  <Alert severity="success" variant="filled">{snack.msg}</Alert>
                </Snackbar>
              </>
            )}
          </CardContent>
        </Card>
      );
    }

    /* ========== パネル：契約専用（contract） ========== */
    function ContractPanel(props){
      // contract固有ロジックはGenericPanelのKPI/比較で既に特例化しているので、
      // まずは GenericPanel をそのまま委譲（必要ならここでKPI差し替え可能）
      return <GenericPanel {...props} />;
    }

    /* ========== パネル：法令対応専用（law） ========== */
    function LawDomainPanel({title, records, localQ, setLocalQ, demoMode, anchorEl, setAnchorEl}){
      const total = records.length;
      const toNum = v=> typeof v==='number'? v : Number(v||0);
      const sum = (fn)=> records.reduce((s,r)=> s + toNum(fn(r)||0), 0);
      const minDate = (fn)=> records.map(fn).filter(Boolean).sort()[0] || '—';
      const maxDate = (fn)=> records.map(fn).filter(Boolean).sort().slice(-1)[0] || '—';

      const comply = records.filter(r=>r.status===true || r.status2==='遵守').length;
      const pending = total - comply;
      const complyRate = total? Math.round(comply/total*100) : 0;

      const parkReq = sum(r=>r.required_parking_spots);
      const parkRep = sum(r=>r.reported_parking_spots);
      const bikeReq = sum(r=>r.required_bicycle_spots);
      const bikeRep = sum(r=>r.reported_bicycle_spots);

      const bfreeOK = records.filter(r=>r.new_barrier_free_compliance).length;
      const heartOK = records.filter(r=>r.old_heart_building_compliance).length;
      const wastePDF = records.filter(r=>(r.waste_pdf||[]).length>0).length;

      const chipCount = (key)=> [...records.reduce((m,r)=>{ const k=r[key]; if(k) m.set(k,(m.get(k)||0)+1); return m; }, new Map())]
        .map(([k,v])=>({k,v}));

      const locChips = chipCount('location_law');
      const cityChips= chipCount('city_law');

      const exportCSV = ()=>{
        const head = ["法令ID","施設","遵守","カテゴリ","立地条例","市条例","提出日","営業","配達","駐車 必要/報告","駐輪 必要/報告","ハートビル","新バリア","廃棄容量","廃棄PDF件数","更新日","メモ"];
        const rows = records.slice(0,2000).map(r=>[
          r.legal_id, r.facility, (r.status||r.status2==='遵守')?'遵守':'未対応', r.category, r.location_law, r.city_law,
          r.submission_date, r.business_hours, r.delivery_time,
          `${r.required_parking_spots||0}/${r.reported_parking_spots||0}`,
          `${r.required_bicycle_spots||0}/${r.reported_bicycle_spots||0}`,
          r.old_heart_building_compliance?'○':'—',
          r.new_barrier_free_compliance?'○':'—',
          r.waste_capacity||'—',
          (r.waste_pdf||[]).length,
          r.updated_at, r.notes||''
        ]);
        downloadCSV(`${title}_一覧.csv`, [head, ...rows]);
      };

      return (
        <Card>
          <CardContent>
            <Stack direction="row" justifyContent="space-between" alignItems="center" sx={{mb:1}}>
              <Typography variant="h6">{title}</Typography>
              <Typography color="text.secondary" variant="body2">対象 {total} 件</Typography>
            </Stack>

            <Collapse in={demoMode} unmountOnExit>
              <Box className="sticky-actions">
                <Box className="table-toolbar">
                  <TextField size="small" label="このドメイン内検索（全列）" value={localQ} onChange={(e)=>setLocalQ(e.target.value)} sx={{minWidth:320}} />
                  <Button size="small" variant="outlined" onClick={exportCSV} startIcon={<span className="material-icons">download</span>}>CSV</Button>
                  <Button size="small" onClick={(e)=>setAnchorEl(e.currentTarget)} startIcon={<span className="material-icons">info</span>}>デモ</Button>
                  <Menu anchorEl={anchorEl} open={Boolean(anchorEl)} onClose={()=>setAnchorEl(null)}>
                    <MenuItem disabled>ここはデモ用操作です</MenuItem>
                  </Menu>
                </Box>
              </Box>
            </Collapse>

            <Box className="kpi-grid" style={{marginBottom:12}}>
              <Card variant="outlined" sx={{p:1.25}}>
                <Typography color="text.secondary" variant="body2">遵守率</Typography>
                <Typography variant="h5" className="mono">{total? `${complyRate}%`:'—'}</Typography>
                <Typography color="text.secondary" variant="caption">遵守 {comply}/{total} ・ 未対応 {pending}</Typography>
              </Card>
              <Card variant="outlined" sx={{p:1.25}}>
                <Typography color="text.secondary" variant="body2">駐車 充足率</Typography>
                <Box className="cmp-bar" style={{marginTop:6}}>
                  <Box className="cmp-fill" style={{width:`${parkReq? Math.min(100, parkRep/parkReq*100):0}%`}}/>
                  <Box className="cmp-line"/>
                </Box>
                <Typography color="text.secondary" variant="caption" className="mono">
                  必要 {parkReq.toLocaleString()} ／ 報告 {parkRep.toLocaleString()}
                </Typography>
              </Card>
              <Card variant="outlined" sx={{p:1.25}}>
                <Typography color="text.secondary" variant="body2">駐輪 充足率</Typography>
                <Box className="cmp-bar" style={{marginTop:6}}>
                  <Box className="cmp-fill" style={{width:`${bikeReq? Math.min(100, bikeRep/bikeReq*100):0}%`}}/>
                  <Box className="cmp-line"/>
                </Box>
                <Typography color="text.secondary" variant="caption" className="mono">
                  必要 {bikeReq.toLocaleString()} ／ 報告 {bikeRep.toLocaleString()}
                </Typography>
              </Card>
              <Card variant="outlined" sx={{p:1.25}}>
                <Typography color="text.secondary" variant="body2">バリアフリー適合</Typography>
                <Typography variant="h5" className="mono">{bfreeOK}</Typography>
                <Typography color="text.secondary" variant="caption">新バリアフリー「適合」件数</Typography>
              </Card>
              <Card variant="outlined" sx={{p:1.25}}>
                <Typography color="text.secondary" variant="body2">ハートビル適合</Typography>
                <Typography variant="h5" className="mono">{heartOK}</Typography>
                <Typography color="text.secondary" variant="caption">旧ハートビル「適合」件数</Typography>
              </Card>
            </Box>

            <Grid container spacing={1} sx={{mb:1}}>
              <Grid item xs={12} md={7}>
                <Card variant="outlined" sx={{p:1}}>
                  <Typography variant="body2" color="text.secondary">適用（立地）条例 内訳</Typography>
                  <Stack direction="row" gap={0.6} flexWrap="wrap" sx={{mt:0.5}}>
                    {locChips.map(c=> <Chip key={c.k} label={`${c.k}:${c.v}`} />)}
                  </Stack>
                </Card>
              </Grid>
              <Grid item xs={12} md={5}>
                <Card variant="outlined" sx={{p:1}}>
                  <Typography variant="body2" color="text.secondary">適用（市）条例 内訳</Typography>
                  <Stack direction="row" gap={0.6} flexWrap="wrap" sx={{mt:0.5}}>
                    {cityChips.map(c=> <Chip key={c.k} label={`${c.k}:${c.v}`} />)}
                  </Stack>
                </Card>
              </Grid>
            </Grid>

            <Grid container spacing={1} sx={{mb:1}}>
              <Grid item xs={12} md={6}>
                <Card variant="outlined" sx={{p:1}}>
                  <Typography variant="body2" color="text.secondary">申請/届出 期間</Typography>
                  <Typography className="mono" sx={{mt:0.5}}>
                    提出日 最小: {minDate(r=>r.submission_date)} ／ 最大: {maxDate(r=>r.submission_date)}
                  </Typography>
                  <Typography className="mono">
                    更新日 最小: {minDate(r=>r.updated_at)} ／ 最大: {maxDate(r=>r.updated_at)}
                  </Typography>
                </Card>
              </Grid>
              <Grid item xs={12} md={6}>
                <Card variant="outlined" sx={{p:1}}>
                  <Typography variant="body2" color="text.secondary">廃棄物関連</Typography>
                  <Stack direction="row" gap={0.75} flexWrap="wrap" sx={{mt:0.5}}>
                    <Chip label={`保管場所 設定: ${records.filter(r=>(r.waste_location&&r.waste_location!=='—')).length}件`} />
                    <Chip label={`容量 情報: ${records.filter(r=>(r.waste_capacity&&r.waste_capacity!=='—')).length}件`} />
                    <Chip label={`PDF 添付: ${wastePDF}件`} />
                  </Stack>
                </Card>
              </Grid>
            </Grid>

            <Typography variant="subtitle2" sx={{mt:.5, mb:.5}}>法令対応プレビュー（先頭10件）</Typography>
            {(() => {
              const cols = [
                {key:'legal_id', label:'法令ID', mono:true},
                {key:'facility', label:'施設'},
                {key:'status2',  label:'遵守'},
                {key:'category', label:'カテゴリ'},
                {key:'location_law', label:'立地条例'},
                {key:'city_law', label:'市条例'},
                {key:'park', label:'駐車 必要/報告', mono:true, align:'right'},
                {key:'bike', label:'駐輪 必要/報告', mono:true, align:'right'},
                {key:'bf',   label:'バリア', mono:true},
                {key:'wcap', label:'廃棄容量', mono:true},
                {key:'wpdf', label:'PDF件数', mono:true, align:'right'},
                {key:'submission_date', label:'提出日', mono:true},
                {key:'updated_at', label:'更新日', mono:true}
              ];
              const rows = records.slice(0,10).map(r=>({
                ...r,
                status2: (r.status||r.status2==='遵守')?'遵守':'未対応',
                park: `${r.required_parking_spots||0}/${r.reported_parking_spots||0}`,
                bike: `${r.required_bicycle_spots||0}/${r.reported_bicycle_spots||0}`,
                bf: `${r.old_heart_building_compliance?'H○':'H—'}/${r.new_barrier_free_compliance?'B○':'B—'}`,
                wcap: r.waste_capacity||'—',
                wpdf: (r.waste_pdf||[]).length
              }));
              return (
                <TableContainer component={Paper} variant="outlined">
                  <Table size="small" stickyHeader>
                    <TableHead><TableRow>{cols.map(c=> <TableCell key={c.key} align={c.align||'left'}>{c.label}</TableCell>)}</TableRow></TableHead>
                    <TableBody>
                      {rows.map((r,idx)=>(
                        <TableRow key={r.legal_id||idx} hover>
                          {cols.map(c=>(
                            <TableCell key={c.key} align={c.align||'left'} className={(c.mono?'mono ':'')+'nowrap'} sx={{maxWidth:200}} title={String(r[c.key]??'')}>
                              {String(r[c.key]??'')}
                            </TableCell>
                          ))}
                        </TableRow>
                      ))}
                    </TableBody>
                  </Table>
                </TableContainer>
              );
            })()}
          </CardContent>
        </Card>
      );
    }

    /* ========== パネル：テナントラッパ（Domain用） ========== */
    function TenantPanelInDomain({title, list, filters, demoMode}){
      const [localQ, setLocalQ] = React.useState('');
      const [anchorEl, setAnchorEl] = React.useState(null);
      const filteredBase = React.useMemo(()=>filterRecords(list, filters), [list, filters.facilities, filters.q, filters.statuses]);
      const filtered = React.useMemo(()=>{
        if(!localQ) return filteredBase;
        const q = localQ.toLowerCase();
        return filteredBase.filter(a=>{
          const s = (a.id+' '+a.name+' '+a.main+' '+a.sub+' '+Object.values(a).join(' ')).toLowerCase();
          return s.includes(q);
        });
      }, [filteredBase, localQ]);

      return (
        <Card>
          <CardContent>
            <Stack direction="row" justifyContent="space-between" alignItems="center" sx={{mb:1}}>
              <Typography variant="h6">{title}</Typography>
              <Typography color="text.secondary" variant="body2">対象 {filtered.length} 件</Typography>
            </Stack>
            <Collapse in={demoMode} unmountOnExit>
              <Box className="sticky-actions">
                <Box className="table-toolbar">
                  <TextField size="small" label="このドメイン内検索（全列）" value={localQ} onChange={(e)=>setLocalQ(e.target.value)} sx={{minWidth:320}} />
                  <Button size="small" onClick={(e)=>setAnchorEl(e.currentTarget)} startIcon={<span className="material-icons">info</span>}>デモ</Button>
                  <Menu anchorEl={anchorEl} open={Boolean(anchorEl)} onClose={()=>setAnchorEl(null)}>
                    <MenuItem disabled>ここはデモ用操作です</MenuItem>
                  </Menu>
                </Box>
              </Box>
            </Collapse>
            <TenantSummaryPanel records={filtered} />
          </CardContent>
        </Card>
      );
    }

    /* ========== パネルレジストリ（ここに追加するだけで拡張） ========== */
    const PANELS = {
      tenant: (props)=> <TenantPanelInDomain {...props} />,
      contract: (props)=> <ContractPanel {...props} />,
      law: (props)=> {
        // Lawは専用API: Genericの props から必要を抽出して渡す
        const {title, list, filters, demoMode} = props;
        const [localQ, setLocalQ] = React.useState('');
        const [anchorEl, setAnchorEl] = React.useState(null);
        const filteredBase = React.useMemo(()=>filterRecords(list, filters), [list, filters.facilities, filters.q, filters.statuses]);
        const records = React.useMemo(()=>{
          if(!localQ) return filteredBase;
          const q = localQ.toLowerCase();
          return filteredBase.filter(a=>{
            const s = (a.legal_id+' '+a.name+' '+a.category+' '+a.location_law+' '+a.city_law+' '+Object.values(a).join(' ')).toLowerCase();
            return s.includes(q);
          });
        }, [filteredBase, localQ]);
        return <LawDomainPanel title={title} records={records} localQ={localQ} setLocalQ={setLocalQ} demoMode={demoMode} anchorEl={anchorEl} setAnchorEl={setAnchorEl} />;
      },
      // 既定：その他はGenericPanel
      default: (props)=> <GenericPanel {...props} />
    };

    /* ========== レンダラ（レジストリを使って描画） ========== */
    function DomainRenderer({domainId, title, list, filters, allForCompare, demoMode}){
      const Comp = PANELS[domainId] || PANELS.default;
      return <Comp domainId={domainId} title={title} list={list} filters={filters} allForCompare={allForCompare} demoMode={demoMode} />;
    }

    /* ========== メイン ========== */
    function App(){
      const [seed, setSeed]   = React.useState(11);
      const [count, setCount] = React.useState(220);
      const [demoMode, setDemoMode] = React.useState(true);

      const [recordsByDomain, setRecordsByDomain] = React.useState(()=>{
        const m={}; DOMAINS.forEach(d=> m[d.id]=generateMock(d.id,{seed, count})); return m;
      });

      const [facSel, setFacSel] = React.useState([]);
      const [q, setQ]           = React.useState('');
      const [sts, setSts]       = React.useState(['稼働','点検中','故障','期限切れ','解約予定','有効','無効','退去済','遵守','未対応']);

      const regen = ()=>{
        const m={}; DOMAINS.forEach(d=> m[d.id]=generateMock(d.id,{seed, count}));
        setRecordsByDomain(m);
      };

      const allRecordsFlat = React.useMemo(()=> Object.values(recordsByDomain).flat(), [recordsByDomain]);
      const filters = { facilities: facSel, q, statuses: sts };

      return (
        <ThemeProvider theme={theme}>
          <Container maxWidth={false} sx={{py:1, px:{xs:1, sm:1.5, md:2, lg:2}}}>
            {/* ヘッダー */}
            <Card sx={{mb:2}}>
              <CardContent>
                <Stack direction={{xs:'column', md:'row'}} alignItems={{xs:'start', md:'center'}} justifyContent="space-between" spacing={1.25}>
                  <Typography variant="h5">統合ダッシュボード（拡張容易なドメインパネル構成）</Typography>
                  <FormControlLabel control={<Switch checked={demoMode} onChange={(e)=>setDemoMode(e.target.checked)} />} label="デモ機能・説明を表示" />
                </Stack>

                <Collapse in={demoMode} unmountOnExit>
                  <Accordion defaultExpanded sx={{mt:1}}>
                    <AccordionSummary expandIcon={<span className="material-icons">expand_more</span>}>
                      <Stack direction="row" gap={0.75} alignItems="center" flexWrap="wrap">
                        <Chip label="パネルレジストリで差し替え" color="primary" variant="outlined" />
                        <Chip label="汎用パネル=既定" variant="outlined" />
                        <Chip label="契約/法令/テナント=専用" variant="outlined" />
                        <Typography className="muted" sx={{ml:1}}>（デモ向け機能／説明は折り畳み可）</Typography>
                      </Stack>
                    </AccordionSummary>
                    <AccordionDetails>
                      <Typography variant="body2" color="text.secondary" sx={{mb:1}}>
                        新しいドメインを足す時は <code>PANELS</code> にエントリを登録し、必要なら専用パネルを実装して返すだけ。
                        既存の <code>GenericPanel</code> をベースにコピペ改造すれば最小差分で拡張できます。
                      </Typography>
                    </AccordionDetails>
                  </Accordion>
                </Collapse>

                <Divider sx={{my:1.25}} />

                {/* 共通フィルタ */}
                <Stack direction="row" gap={1} flexWrap="wrap" alignItems="center">
                  <FormControl sx={{minWidth:240}}>
                    <InputLabel id="fac-label">施設（複数選択可）</InputLabel>
                    <Select labelId="fac-label" multiple value={facSel}
                      onChange={(e)=>setFacSel(e.target.value)} input={<OutlinedInput label="施設（複数選択可）" />}
                      renderValue={(selected)=>selected.map(labelOfFacility).join(', ')}>
                      {FACILITIES.map(f=>(
                        <MenuItem key={f.id} value={f.id}>
                          <Checkbox checked={facSel.indexOf(f.id) > -1} />
                          <ListItemText primary={f.label} />
                        </MenuItem>
                      ))}
                    </Select>
                  </FormControl>

                  <FormControl sx={{minWidth:300}}>
                    <InputLabel id="st-label">状態</InputLabel>
                    <Select labelId="st-label" multiple value={sts} onChange={(e)=>setSts(e.target.value)}
                      input={<OutlinedInput label="状態" />} renderValue={(selected)=>selected.join(', ')}>
                      {['稼働','点検中','故障','期限切れ','解約予定','有効','無効','退去済','遵守','未対応'].map(s=>(
                        <MenuItem key={s} value={s}>
                          <Checkbox checked={sts.indexOf(s) > -1} />
                          <ListItemText primary={s} />
                        </MenuItem>
                      ))}
                    </Select>
                  </FormControl>

                  <TextField label="検索（ID/名称/相手先/期間など）" value={q} onChange={(e)=>setQ(e.target.value)} sx={{minWidth:260}} />
                  <TextField type="number" label="乱数シード" value={seed} onChange={e=>setSeed(Number(e.target.value)||0)} sx={{maxWidth:128}} />
                  <TextField type="number" label="件数/ドメイン" value={count} onChange={e=>setCount(Math.max(80, Number(e.target.value)||80))} sx={{maxWidth:140}} />
                  <Button variant="contained" onClick={regen} startIcon={<span className="material-icons">refresh</span>}>データ再生成</Button>
                </Stack>
              </CardContent>
            </Card>

            {/* 単一施設選択時：概要 */}
            {facSel.length===1 && (<FacilityOverview facilityId={facSel[0]} allRecords={allRecordsFlat} />)}

            {/* レジストリ経由で各ドメインを描画 */}
            <Box className="domain-grid">
              {DOMAINS.map(d=>(
                <DomainRenderer key={d.id} domainId={d.id} title={d.name}
                  list={recordsByDomain[d.id]||[]} filters={filters}
                  allForCompare={recordsByDomain[d.id]||[]} demoMode={demoMode}/>
              ))}
            </Box>

            <Collapse in={demoMode} unmountOnExit>
              <Box sx={{textAlign:'right', my:2}}>
                <Typography color="text.secondary" variant="caption">
                  ※デモUI（ブラウザ内でモック生成）。主/サブカテゴリはマスタ基準でゼロも可視化。比較は全体=100%基準の相対表示です。
                </Typography>
              </Box>
            </Collapse>
          </Container>
        </ThemeProvider>
      );
    }

    ReactDOM.createRoot(document.getElementById('app')).render(<App />);
  </script>
</body>
</html>
