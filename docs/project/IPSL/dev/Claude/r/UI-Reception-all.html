<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>申込管理システム - ガラス調統合版</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;600;700&display=swap"/>
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons"/>
  <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.23.8/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@emotion/react@11.11.3/dist/emotion-react.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@emotion/styled@11.11.0/dist/emotion-styled.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mui/material@5.15.3/umd/material-ui.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mui/lab@5.0.0-alpha.148/umd/material-ui-lab.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>
  <style>
    body {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      font-family: 'Noto Sans JP', 'Roboto', sans-serif;
      margin: 0;
      padding: 0;
      min-height: 100vh;
    }
    .glass-effect {
      background: rgba(255, 255, 255, 0.97);
      backdrop-filter: blur(18px);
      border: 1.5px solid rgba(255, 255, 255, 0.18);
      box-shadow: 0 8px 32px rgba(30, 60, 130, 0.09);
    }
    .form-section {
      background: rgba(255,255,255,0.99);
      border-radius: 16px;
      margin-bottom: 36px;
      box-shadow: 0 2px 12px 0 rgba(25,118,210,0.07);
      overflow: hidden;
      border: 1.5px solid #e3e6ef;
    }
    .section-header {
      background: linear-gradient(90deg, #2196f3 10%, #1565c0 100%);
      color: white;
      padding: 18px 28px 14px 22px;
      font-weight: 600;
      font-size: 1.13rem;
      display: flex;
      align-items: center;
      gap: 10px;
      letter-spacing: 1px;
      border-bottom: 1px solid #e3e6ef;
    }
    .req-bg .MuiInputBase-input {
      background: #fffde7 !important;
    }
    .MuiChip-root {
      font-weight: 600;
      letter-spacing:1px;
    }
    .drag-handle {
      cursor: grab;
      color: #1976d2;
      margin-right: 8px;
      margin-top: 12px;
      font-size: 30px;
    }
    .sortable-chosen { background: #e3f2fd !important; }
    .sortable-drag { background: #bbdefb !important; }
    .add-btn {
      font-weight: 700 !important;
      min-width: 120px;
      box-shadow: 0 1px 4px 0 rgba(25,118,210,0.10);
      margin-right: 8px;
    }
    .del-btn {
      min-width: 38px !important;
      min-height: 38px !important;
      border-radius: 50%;
      margin-top: 6px;
      margin-left: 4px;
      font-size: 1.3rem !important;
    }
    .status-card {
      border-radius: 16px;
      padding: 24px;
      margin: 20px 0;
      animation: slideIn 0.5s ease;
      background: linear-gradient(145deg, #f3e5f5 0%, #e1bee7 100%);
      border: 2px solid #9c27b0;
    }
    .reference-card {
      background: linear-gradient(145deg, #f3e5f5 0%, #e1bee7 100%);
      border: 2px solid #9c27b0;
      border-radius: 16px;
      padding: 24px;
      margin: 20px 0;
    }
    .action-button {
      background: linear-gradient(145deg, #2196f3 0%, #1976d2 100%);
      border: none;
      border-radius: 12px;
      color: white;
      padding: 14px 28px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(33, 150, 243, 0.3);
    }
    .action-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(33, 150, 243, 0.4);
    }
    .floating-label {
      position: absolute;
      top: -12px;
      left: 16px;
      background: white;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 600;
      color: #1976d2;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    .error-details {
      background: linear-gradient(145deg, #ffebee 0%, #ffcdd2 100%);
      border: 2px solid #f44336;
      border-radius: 12px;
      padding: 20px;
      margin-top: 16px;
    }
    @media (max-width: 600px) {
      .section-header {
        padding: 12px 8px 8px 12px;
        font-size: 1rem;
      }
      .form-section { border-radius: 10px; }
      .glass-effect { border-radius: 10px !important; }
    }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const {
      Box, Button, Dialog, DialogTitle, DialogContent, DialogActions,
      TextField, Checkbox, FormControlLabel, Typography, Grid, Paper,
      Tabs, Tab, Chip, Radio, RadioGroup, FormLabel, FormControl, Snackbar, Alert,
      Table, TableBody, TableCell, TableContainer, TableHead, TableRow,
      ToggleButton, ToggleButtonGroup, Card, CardContent, Divider, IconButton, Collapse, List, ListItem, ListItemText, ListItemIcon
    } = MaterialUI;

    // --- ファイル添付ドラッグ＆ドロップ
    function FileDropZone({ file, onFile }) {
      const [dragOver, setDragOver] = React.useState(false);
      const inputRef = React.useRef();
      const handleDrop = (e) => {
        e.preventDefault();
        setDragOver(false);
        if (e.dataTransfer.files && e.dataTransfer.files[0]) {
          onFile({ target: { files: [e.dataTransfer.files[0]] } });
        }
      };
      const handleBoxClick = () => inputRef.current.click();
      return (
        <Box
          onDrop={handleDrop}
          onDragOver={e => { e.preventDefault(); setDragOver(true); }}
          onDragLeave={() => setDragOver(false)}
          sx={{
            border: dragOver ? '2.5px solid #1976d2' : '2px dashed #b0bec5',
            borderRadius: 3,
            bgcolor: dragOver ? '#e3f2fd' : '#f8fafc',
            textAlign: 'center',
            p: 3,
            cursor: 'pointer',
            transition: 'all 0.16s',
            outline: dragOver ? '2px solid #1976d2' : 'none'
          }}
          onClick={handleBoxClick}
          tabIndex={0}
          role="button"
          aria-label="ファイルを選択またはドロップ"
        >
          <input
            ref={inputRef}
            type="file"
            accept=".pdf,.xlsx,.doc,.docx,image/*"
            style={{ display: 'none' }}
            onChange={onFile}
          />
          <span className="material-icons" style={{ fontSize: 32, color: '#1976d2', marginBottom: 6 }}>upload_file</span>
          <Typography sx={{ fontWeight: 600, color: '#1976d2', mb: 1.5 }}>
            ここにファイルをドラッグ＆ドロップ<br />またはクリックで選択
          </Typography>
          {file
            ? <Typography sx={{ color: '#37474f', fontWeight: 500, mt: 1 }}>選択中: {file.name}</Typography>
            : <Typography sx={{ color: 'text.secondary', fontSize: '0.99em' }}>
                （PDF、xlsx、word、画像ファイルなど添付できます）
              </Typography>
          }
        </Box>
      );
    }

    // --- 希望内容ドラッグ＆カード表示
    function getPrefItem() {
      return {
        id: Date.now() + Math.random(),
        store:'', altApplicable:'なし', altStore:'',
        date:'', start:'', end:'',
        count:'', classCount:'', escortCount:'',
        preVisit:'なし', preVisitDate:'', preVisitTime:''
      }
    }
    function PreferencesSortable({ prefs, setPrefs }) {
      const listRef = React.useRef(null);
      React.useEffect(() => {
        if (!listRef.current) return;
        const sortable = Sortable.create(listRef.current, {
          animation: 160,
          handle: ".drag-handle",
          ghostClass: "sortable-drag",
          chosenClass: "sortable-chosen",
          onEnd: function (evt) {
            if (evt.oldIndex === evt.newIndex) return;
            const newPrefs = [...prefs];
            const [moved] = newPrefs.splice(evt.oldIndex, 1);
            newPrefs.splice(evt.newIndex, 0, moved);
            setPrefs([...newPrefs]);
          }
        });
        return () => sortable.destroy();
      }, [prefs, setPrefs]);
      return (
        <div ref={listRef}>
          {prefs.map((pref, idx) => (
            <Paper key={pref.id} sx={{
              p: { xs: 2, sm: 3 }, mb: 3, borderRadius: 3, boxShadow: '0 2px 10px 0 rgba(25,118,210,0.09)',
              borderLeft: '7px solid #1976d2', position: 'relative', overflow: 'visible',
              background: '#f9fbff'
            }}>
            <Box sx={{
              display: 'flex', alignItems: 'center', mb: 2, pl: 1, pb: 0.5, borderBottom: '1.5px dashed #90caf9'
            }}>
              <span className="material-icons drag-handle" style={{ color: '#1565c0', fontSize: 30, marginRight: 8 }}>drag_indicator</span>
              <Chip
                icon={<span className="material-icons" style={{ fontSize: 19, verticalAlign: '-4px' }}>star</span>}
                label={`第${idx + 1}希望`}
                color="primary"
                size="small"
                sx={{
                  fontWeight: 800, fontSize: '1.07rem', background: '#1976d2', color: '#fff', px: 1.5, py: 0.4, letterSpacing: 1
                }}
              />
              <Box sx={{ flexGrow: 1 }} />
              {prefs.length > 1 && (
                <Button
                  size="small"
                  color="error"
                  className="del-btn"
                  variant="contained"
                  sx={{
                    minWidth: 40, minHeight: 40, borderRadius: '50%',
                    ml: 1, bgcolor: '#fff0f0', color: '#d32f2f', '&:hover': { bgcolor: '#ffeaea' }
                  }}
                  onClick={() => setPrefs(prefs.filter((_, i) => i !== idx))}
                >
                  <span className="material-icons">delete</span>
                </Button>
              )}
            </Box>
            <Grid container spacing={2.2} alignItems="center" sx={{ mt: 0 }}>
              <Grid item xs={12} sm={3}>
                <TextField
                  required fullWidth label="店舗名"
                  value={pref.store}
                  onChange={e => {
                    const arr = [...prefs];
                    arr[idx].store = e.target.value;
                    setPrefs(arr);
                  }}
                  className="req-bg"
                  InputProps={{
                    startAdornment: (
                      <span className="material-icons" style={{ color: '#90caf9', marginRight: 8, fontSize: 20 }}>store</span>
                    )
                  }}
                />
              </Grid>
              <Grid item xs={6} sm={2.2}>
                <TextField required fullWidth type="date" label="日付"
                  InputLabelProps={{ shrink: true }}
                  value={pref.date}
                  onChange={e => {
                    const arr = [...prefs];
                    arr[idx].date = e.target.value;
                    setPrefs(arr);
                  }}
                  className="req-bg"
                />
              </Grid>
              <Grid item xs={6} sm={1.6}>
                <TextField required fullWidth type="time" label="開始"
                  InputLabelProps={{ shrink: true }}
                  value={pref.start}
                  onChange={e => {
                    const arr = [...prefs];
                    arr[idx].start = e.target.value;
                    setPrefs(arr);
                  }}
                  className="req-bg"
                />
              </Grid>
              <Grid item xs={6} sm={1.6}>
                <TextField required fullWidth type="time" label="終了"
                  InputLabelProps={{ shrink: true }}
                  value={pref.end}
                  onChange={e => {
                    const arr = [...prefs];
                    arr[idx].end = e.target.value;
                    setPrefs(arr);
                  }}
                  className="req-bg"
                />
              </Grid>
              <Grid item xs={6} sm={1.2}>
                <TextField required fullWidth type="number" label="人数"
                  value={pref.count}
                  onChange={e => {
                    const arr = [...prefs];
                    arr[idx].count = e.target.value;
                    setPrefs(arr);
                  }}
                  className="req-bg"
                />
              </Grid>
              <Grid item xs={6} sm={1.2}>
                <TextField fullWidth type="number" label="クラス数"
                  value={pref.classCount}
                  onChange={e => {
                    const arr = [...prefs];
                    arr[idx].classCount = e.target.value;
                    setPrefs(arr);
                  }}
                  className="req-bg"
                />
              </Grid>
              <Grid item xs={6} sm={1.2}>
                <TextField fullWidth type="number" label="付き添い"
                  value={pref.escortCount}
                  onChange={e => {
                    const arr = [...prefs];
                    arr[idx].escortCount = e.target.value;
                    setPrefs(arr);
                  }}
                  className="req-bg"
                />
              </Grid>
            </Grid>
            {/* サブオプション：振替・事前訪問 */}
            <Grid container spacing={2} alignItems="center" sx={{ mt: 1.5 }}>
              <Grid item xs={12} sm={4.5}>
                <FormControl component="fieldset" fullWidth>
                  <FormLabel component="legend" sx={{ fontWeight: 500, fontSize: '1.05em' }}>振替可能店舗</FormLabel>
                  <RadioGroup
                    row value={pref.altApplicable}
                    onChange={e => {
                      const arr = [...prefs];
                      arr[idx].altApplicable = e.target.value;
                      if (e.target.value === 'なし') arr[idx].altStore = '';
                      setPrefs(arr);
                    }}
                  >
                    <FormControlLabel value="なし" control={<Radio />} label="なし" />
                    <FormControlLabel value="あり" control={<Radio />} label="あり" />
                  </RadioGroup>
                </FormControl>
              </Grid>
              {pref.altApplicable === 'あり' && (
                <Grid item xs={12} sm={4}>
                  <TextField
                    fullWidth label="振替店舗名"
                    value={pref.altStore}
                    onChange={e => {
                      const arr = [...prefs];
                      arr[idx].altStore = e.target.value;
                      setPrefs(arr);
                    }}
                    InputProps={{
                      startAdornment: (
                        <span className="material-icons" style={{ color: '#90caf9', marginRight: 8, fontSize: 19 }}>storefront</span>
                      )
                    }}
                  />
                </Grid>
              )}
            </Grid>
            <Grid container spacing={2} alignItems="center" sx={{ mt: 0.7 }}>
              <Grid item xs={12} sm={4.5}>
                <FormControl component="fieldset" fullWidth>
                  <FormLabel component="legend" sx={{ fontWeight: 500, fontSize: '1.05em' }}>事前訪問希望</FormLabel>
                  <RadioGroup
                    row value={pref.preVisit}
                    onChange={e => {
                      const arr = [...prefs];
                      arr[idx].preVisit = e.target.value;
                      if (e.target.value === 'なし') {
                        arr[idx].preVisitDate = '';
                        arr[idx].preVisitTime = '';
                      }
                      setPrefs(arr);
                    }}
                  >
                    <FormControlLabel value="なし" control={<Radio />} label="なし" />
                    <FormControlLabel value="あり" control={<Radio />} label="あり" />
                  </RadioGroup>
                </FormControl>
              </Grid>
              {pref.preVisit === 'あり' && (
                <>
                  <Grid item xs={6} sm={4}>
                    <TextField
                      fullWidth type="date" label="訪問日"
                      InputLabelProps={{ shrink: true }}
                      value={pref.preVisitDate}
                      onChange={e => {
                        const arr = [...prefs];
                        arr[idx].preVisitDate = e.target.value;
                        setPrefs(arr);
                      }}
                    />
                  </Grid>
                  <Grid item xs={6} sm={4}>
                    <TextField
                      fullWidth type="time" label="訪問時間"
                      InputLabelProps={{ shrink: true }}
                      value={pref.preVisitTime}
                      onChange={e => {
                        const arr = [...prefs];
                        arr[idx].preVisitTime = e.target.value;
                        setPrefs(arr);
                      }}
                    />
                  </Grid>
                </>
              )}
            </Grid>
          </Paper>
          ))}
          <Box textAlign="right" sx={{ mt: 2, mb: 1 }}>
            <Button
              variant="contained"
              color="primary"
              className="add-btn"
              size="medium"
              startIcon={<span className="material-icons">add_circle</span>}
              onClick={() => {
                if (prefs.length >= 5) return;
                setPrefs([...prefs, getPrefItem()]);
              }}
              disabled={prefs.length >= 5}
              sx={{ fontWeight: 700, minWidth: 120 }}
            >
              希望を追加
            </Button>
            <Typography variant="caption" sx={{ mt: 1, color: 'text.secondary', ml: 1 }}>※最大5件まで追加できます</Typography>
          </Box>
        </div>
      );
    }

    // --- 希望内容テーブル表示（編集・削除可）
    function PreferencesTable({ prefs, setPrefs }) {
      return (
        <TableContainer component={Paper} sx={{ mb: 2, bgcolor: "#f9fbff" }}>
          <Table size="small">
            <TableHead>
              <TableRow>
                <TableCell>並び</TableCell>
                <TableCell>店舗名</TableCell>
                <TableCell>日付</TableCell>
                <TableCell>開始</TableCell>
                <TableCell>終了</TableCell>
                <TableCell>人数</TableCell>
                <TableCell>クラス数</TableCell>
                <TableCell>付き添い</TableCell>
                <TableCell>振替店舗</TableCell>
                <TableCell>事前訪問</TableCell>
                <TableCell>操作</TableCell>
              </TableRow>
            </TableHead>
            <TableBody>
              {prefs.map((pref, idx) => (
                <TableRow key={pref.id}>
                  <TableCell>{idx + 1}</TableCell>
                  <TableCell>
                    <TextField size="small" variant="standard" value={pref.store}
                      onChange={e => {
                        const arr = [...prefs];
                        arr[idx].store = e.target.value;
                        setPrefs(arr);
                      }} required />
                  </TableCell>
                  <TableCell>
                    <TextField size="small" variant="standard" type="date" value={pref.date}
                      onChange={e => {
                        const arr = [...prefs];
                        arr[idx].date = e.target.value;
                        setPrefs(arr);
                      }} required InputLabelProps={{shrink:true}} />
                  </TableCell>
                  <TableCell>
                    <TextField size="small" variant="standard" type="time" value={pref.start}
                      onChange={e => {
                        const arr = [...prefs];
                        arr[idx].start = e.target.value;
                        setPrefs(arr);
                      }} required InputLabelProps={{shrink:true}} />
                  </TableCell>
                  <TableCell>
                    <TextField size="small" variant="standard" type="time" value={pref.end}
                      onChange={e => {
                        const arr = [...prefs];
                        arr[idx].end = e.target.value;
                        setPrefs(arr);
                      }} required InputLabelProps={{shrink:true}} />
                  </TableCell>
                  <TableCell>
                    <TextField size="small" variant="standard" type="number" value={pref.count}
                      onChange={e => {
                        const arr = [...prefs];
                        arr[idx].count = e.target.value;
                        setPrefs(arr);
                      }} required />
                  </TableCell>
                  <TableCell>
                    <TextField size="small" variant="standard" type="number" value={pref.classCount}
                      onChange={e => {
                        const arr = [...prefs];
                        arr[idx].classCount = e.target.value;
                        setPrefs(arr);
                      }} />
                  </TableCell>
                  <TableCell>
                    <TextField size="small" variant="standard" type="number" value={pref.escortCount}
                      onChange={e => {
                        const arr = [...prefs];
                        arr[idx].escortCount = e.target.value;
                        setPrefs(arr);
                      }} />
                  </TableCell>
                  <TableCell>
                    {pref.altApplicable === "あり"
                      ? <TextField size="small" variant="standard" value={pref.altStore}
                        onChange={e => {
                          const arr = [...prefs];
                          arr[idx].altStore = e.target.value;
                          setPrefs(arr);
                        }} placeholder="振替店舗名" />
                      : (
                        <Button size="small" color="primary" onClick={() => {
                          const arr = [...prefs];
                          arr[idx].altApplicable = "あり";
                          setPrefs(arr);
                        }}>追加</Button>
                      )
                    }
                  </TableCell>
                  <TableCell>
                    {pref.preVisit === "あり"
                      ? (
                        <Box>
                          <TextField size="small" variant="standard" type="date" value={pref.preVisitDate}
                            onChange={e => {
                              const arr = [...prefs];
                              arr[idx].preVisitDate = e.target.value;
                              setPrefs(arr);
                            }} sx={{mb:0.3}} />
                          <TextField size="small" variant="standard" type="time" value={pref.preVisitTime}
                            onChange={e => {
                              const arr = [...prefs];
                              arr[idx].preVisitTime = e.target.value;
                              setPrefs(arr);
                            }} />
                          <Button size="small" color="secondary" onClick={() => {
                            const arr = [...prefs];
                            arr[idx].preVisit = "なし";
                            arr[idx].preVisitDate = "";
                            arr[idx].preVisitTime = "";
                            setPrefs(arr);
                          }}>解除</Button>
                        </Box>
                      )
                      : (
                        <Button size="small" color="primary" onClick={() => {
                          const arr = [...prefs];
                          arr[idx].preVisit = "あり";
                          setPrefs(arr);
                        }}>追加</Button>
                      )
                    }
                  </TableCell>
                  <TableCell>
                    {prefs.length > 1 &&
                      <Button size="small" color="error"
                        onClick={() => setPrefs(prefs.filter((_, i) => i !== idx))}
                      >
                        <span className="material-icons" style={{ fontSize: 20 }}>delete</span>
                      </Button>
                    }
                  </TableCell>
                </TableRow>
              ))}
              <TableRow>
                <TableCell colSpan={11} align="right">
                  <Button
                    variant="contained"
                    size="small"
                    color="primary"
                    startIcon={<span className="material-icons">add_circle</span>}
                    onClick={() => {
                      if (prefs.length >= 5) return;
                      setPrefs([...prefs, getPrefItem()]);
                    }}
                    disabled={prefs.length >= 5}
                  >
                    希望を追加
                  </Button>
                  <Typography variant="caption" sx={{ ml: 2 }}>※最大5件まで</Typography>
                </TableCell>
              </TableRow>
            </TableBody>
          </Table>
        </TableContainer>
      );
    }

    // --- 申込フォーム本体
    function getInitialForm() {
      return {
        schoolName: '', grade: '', contactName: '', tel1:'', tel2:'', tel3:'', fax1:'', fax2:'', fax3:'',
        email: '', sendMethod: 'メール', remarks: '', preferences: [getPrefItem()],
        contactNotes: '', file: null, ack: false
      };
    }
    function VisitFormBody({ form, setForm, onChange, onNum, onFile, type }) {
      const [prefView, setPrefView] = React.useState("card");
      const setPrefs = (prefs) => setForm(f => ({ ...f, preferences: prefs }));
      return (
        <Box>
          <div className="form-section">
            <div className="section-header">
              <span className="material-icons">person</span>
              ご担当者情報 <Typography component="span" color="error" sx={{ ml: 1, fontWeight: 700, fontSize: '1.1em' }}>＊必須</Typography>
            </div>
            <Box sx={{ p: { xs: 2, sm: 3 } }}>
              <Grid container spacing={2}>
                <Grid item xs={12}>
                  <TextField required fullWidth label="学校名" value={form.schoolName} onChange={onChange('schoolName')} className="req-bg" />
                </Grid>
                <Grid item xs={12}>
                  <TextField required fullWidth label="学年（年生）" value={form.grade} onChange={onChange('grade')} className="req-bg" />
                </Grid>
                <Grid item xs={12}>
                  <TextField required fullWidth label="ご担当者名" value={form.contactName} onChange={onChange('contactName')} className="req-bg" />
                </Grid>
                <Grid item xs={12}>
                  <FormLabel component="legend">電話番号</FormLabel>
                  <Box sx={{ display: 'flex', gap: 1 }}>
                    {['tel1', 'tel2', 'tel3'].map((k, i) => (
                      <TextField key={k} size="small" sx={{ flex: 1 }} placeholder={i === 0 ? '000' : '0000'}
                        value={form[k]} onChange={onNum(k)}
                        inputProps={{ maxLength: i === 0 ? 5 : 4 }} className="req-bg"
                      />
                    ))}
                  </Box>
                </Grid>
                <Grid item xs={12}>
                  <FormLabel component="legend">FAX番号</FormLabel>
                  <Box sx={{ display: 'flex', gap: 1 }}>
                    {['fax1', 'fax2', 'fax3'].map((k, i) => (
                      <TextField key={k} size="small" sx={{ flex: 1 }} placeholder={i === 0 ? '000' : '0000'}
                        value={form[k]} onChange={onNum(k)}
                        inputProps={{ maxLength: i === 0 ? 5 : 4 }}
                      />
                    ))}
                  </Box>
                </Grid>
                <Grid item xs={12}>
                  <TextField required fullWidth type="email" label="連絡可能なメールアドレス" value={form.email} onChange={onChange('email')} className="req-bg" />
                </Grid>
                <Grid item xs={12}>
                  <FormLabel component="legend">ご希望の返信方法</FormLabel>
                  <RadioGroup row value={form.sendMethod} onChange={onChange('sendMethod')}>
                    <FormControlLabel value="メール" control={<Radio />} label="メール" />
                    <FormControlLabel value="FAX" control={<Radio />} label="FAX" />
                  </RadioGroup>
                  <Typography variant="body2" sx={{ mt: 1 }}>
                    <span className="material-icons" style={{ verticalAlign: 'middle', fontSize: 16, marginRight: 2, color: '#ffb300' }}>info</span>
                    記録を残すため、電話での連絡はしていません。（緊急の場合は除く）
                  </Typography>
                </Grid>
                <Grid item xs={12}>
                  <TextField fullWidth multiline rows={2} label="備考" value={form.remarks} onChange={onChange('remarks')} />
                </Grid>
              </Grid>
            </Box>
          </div>
          {/* 希望内容 */}
          <div className="form-section">
            <div className="section-header">
              <span className="material-icons">list_alt</span>
              希望内容
            </div>
            <Box sx={{ p: { xs: 2, sm: 3 } }}>
              {/* カード／テーブル表示切り替えボタン */}
              <ToggleButtonGroup
                value={prefView}
                exclusive
                onChange={(_, v) => v && setPrefView(v)}
                size="small"
                color="primary"
                sx={{ mb: 2 }}
              >
                <ToggleButton value="card"><span className="material-icons" style={{verticalAlign:'middle'}}>view_module</span> カード表示</ToggleButton>
                <ToggleButton value="table"><span className="material-icons" style={{verticalAlign:'middle'}}>table_view</span> テーブル表示</ToggleButton>
              </ToggleButtonGroup>
              {type === "exp" && (
                <Box sx={{ mb: 2 }}>
                  <Alert severity="info" icon={<span className="material-icons" style={{ verticalAlign: 'middle' }}>info</span>} sx={{ mb: 1, fontWeight: 500 }}>
                    <strong>※1学校の同日程でのお申し込み可能店舗数は3店舗までです。</strong>
                  </Alert>
                  <Alert severity="warning" icon={<span className="material-icons" style={{ verticalAlign: 'middle' }}>schedule</span>} sx={{ fontWeight: 500 }}>
                    <strong>※10:30~15:00（休憩1時間含）の受け入れが基本です。<br />その他の体験時間でも可能な場合がありますのでご相談下さい。</strong>
                  </Alert>
                </Box>
              )}
              {prefView === "card"
                ? <PreferencesSortable prefs={form.preferences} setPrefs={setPrefs} />
                : <PreferencesTable prefs={form.preferences} setPrefs={setPrefs} />
              }
            </Box>
          </div>
          <div className="form-section">
            <div className="section-header">
              <span className="material-icons">chat_bubble_outline</span>
              連絡事項
            </div>
            <Box sx={{ p: { xs: 2, sm: 3 } }}>
              <TextField fullWidth multiline rows={3} label={type === "exp" ? "見学希望内容など" : "見学の目的・見学方法など"} value={form.contactNotes} onChange={onChange('contactNotes')} />
            </Box>
          </div>
          <div className="form-section">
            <div className="section-header">
              <span className="material-icons">attach_file</span>
              ファイル添付
            </div>
            <Box sx={{ p: { xs: 2, sm: 3 } }}>
              <strong>※学校で作成した資料などお持ちでしたら添付してください。</strong>
              <FileDropZone file={form.file} onFile={onFile} />
            </Box>
          </div>
          <div className="form-section" style={{ background: '#fffde7', border: '2px solid #ffe082', marginBottom: 32 }}>
            <div className="section-header" style={{
              background: 'linear-gradient(90deg,#ffe082,#fff176 90%)',
              color: '#795548',
              fontWeight: 700,
              fontSize: '1.13rem',
              letterSpacing: '0.04em',
              borderBottom: 'none',
              boxShadow: '0 1px 6px 0 #ffe08240',
              alignItems: 'center'
            }}>
              <span className="material-icons" style={{ fontSize: 30, marginRight: 10, color: '#ff9800' }}>warning_amber</span>
              <span style={{ fontWeight: 800, fontSize: '1.2em' }}>注意事項</span>
            </div>
            <Box sx={{ p: { xs: 2, sm: 3 } }}>
              {type === "exp"
                ? <>
                  <Typography sx={{ fontWeight: 700, color: '#bf360c', mb: 1.3, fontSize: '1.09em' }}>
                    お申し込み前に必ずご確認ください
                  </Typography>
                  <ul style={{ paddingLeft: 18, marginBottom: 8, color: '#795548', fontSize: '1.07em' }}>
                    <li><b>学年でまとめて</b>お申込みくださいますようお願いいたします。</li>
                    <li>店舗と打ち合わせ後、<b>折り返しご連絡</b>いたします。</li>
                    <li><b>見学希望の決定には、店舗側の事情等で希望に添えない場合があります</b>。ご容赦ください。</li>
                  </ul>
                </>
                : <>
                  <Typography sx={{ fontWeight: 700, color: '#bf360c', mb: 1.3, fontSize: '1.09em' }}>
                    <b>ご注意</b>
                  </Typography>
                  <ul style={{ paddingLeft: 18, marginBottom: 8, color: '#795548', fontSize: '1.07em' }}>
                    <li>訪問前にご一報いただきますようお願いいたします。</li>
                    <li>施設によっては入場制限がございます。</li>
                  </ul>
                </>
              }
              <FormControlLabel
                required
                control={<Checkbox checked={form.ack} onChange={e => setForm(f => ({ ...f, ack: e.target.checked }))} />}
                label={<Typography sx={{ color: '#bf360c', fontWeight: 700, fontSize: '1.06em' }}>
                  注意事項を確認し同意します
                </Typography>}
              />
            </Box>
          </div>
        </Box>
      );
    }

    // --- 申込フォームモーダル
    function VisitFormModal({ open, onClose, onSubmit, type }) {
      const [form, setForm] = React.useState(getInitialForm());
      const [error, setError] = React.useState("");
      // 入力補助
      const onChange = (key) => e => setForm(f => ({ ...f, [key]: e.target.value }));
      const onNum = (key) => e => {
        let v = e.target.value.replace(/[^\d]/g, '').slice(0, key.endsWith('1') ? 5 : 4);
        setForm(f => ({ ...f, [key]: v }));
      };
      const onFile = (e) => {
        if (e.target.files && e.target.files[0]) {
          setForm(f => ({ ...f, file: e.target.files[0] }));
        }
      };

      // バリデーション
      const validate = () => {
        if (!form.schoolName || !form.grade || !form.contactName || !form.email) return "必須項目が未入力です";
        if (!form.preferences.length || form.preferences.some(p => !p.store || !p.date || !p.start || !p.end || !p.count)) return "希望内容を正しく入力してください";
        if (!form.ack) return "注意事項への同意が必要です";
        if (!form.email.match(/^[^@\s]+@[^@\s]+\.[^@\s]+$/)) return "正しいメールアドレスを入力してください";
        return "";
      };

      const handleSubmit = () => {
        const err = validate();
        if (err) {
          setError(err);
          return;
        }
        onSubmit(form);
        setForm(getInitialForm());
        setError("");
      };

      return (
        <Dialog open={open} onClose={onClose} maxWidth="md" fullWidth scroll="body" PaperProps={{ className: 'glass-effect', sx: { p: 0 } }}>
          <DialogTitle sx={{ bgcolor: 'rgba(33,150,243,0.93)', color: '#fff', fontWeight: 700, borderTopLeftRadius: 12, borderTopRightRadius: 12, pb: 1.2 }}>
            <span className="material-icons" style={{ verticalAlign: 'middle', marginRight: 8, fontSize: 30 }}>edit_note</span>
            {type === "exp" ? "見学体験申込フォーム" : "通常見学申込フォーム"}
          </DialogTitle>
          <DialogContent sx={{ pt: 2, pb: 0, bgcolor: 'rgba(255,255,255,0.98)' }}>
            <VisitFormBody form={form} setForm={setForm} onChange={onChange} onNum={onNum} onFile={onFile} type={type} />
            {error && (
              <Box className="error-details" sx={{ mt: 2 }}>
                <Alert severity="error" icon={<span className="material-icons">error</span>} sx={{ fontWeight: 600, fontSize: '1.08em' }}>
                  {error}
                </Alert>
              </Box>
            )}
          </DialogContent>
          <DialogActions sx={{ justifyContent: 'flex-end', bgcolor: 'rgba(250,250,250,0.97)' }}>
            <Button onClick={onClose} sx={{ fontWeight: 700, color: '#1565c0' }}>キャンセル</Button>
            <Button variant="contained" onClick={handleSubmit} className="action-button">
              申込を送信
            </Button>
          </DialogActions>
        </Dialog>
      );
    }

    // --- 申込状況確認（豊かなUI）
    function EntryLookup({ open, onClose }) {
      const [input, setInput] = React.useState('');
      const [result, setResult] = React.useState(null);
      const [error, setError] = React.useState('');
      const [detailOpen, setDetailOpen] = React.useState(false);

      // デモ用ダミー
      const demoData = {
        "ABC12345": {
          name: "田中 太郎",
          school: "Noto小学校",
          status: "審査中",
          detail: {
            entryDate: "2025-05-26",
            items: [
              { store: "サミット杉並店", date: "2025-06-21", time: "10:30-12:00", class: "2年1組", cnt: 35, status: "受付" },
              { store: "サミット練馬店", date: "2025-06-23", time: "10:30-12:00", class: "2年2組", cnt: 33, status: "仮予約" }
            ],
            notes: "店舗との調整中です。ご連絡までしばらくお待ちください。"
          }
        }
      };

      const lookup = () => {
        if (!input.trim()) {
          setError('申込番号を入力してください');
          setResult(null);
          return;
        }
        const res = demoData[input.trim()];
        if (res) {
          setResult(res);
          setError('');
        } else {
          setResult(null);
          setError('申込番号が見つかりません。入力をお確かめください。');
        }
      };

      return (
        <Dialog open={open} onClose={onClose} maxWidth="sm" fullWidth PaperProps={{ className: 'glass-effect', sx: { p: 0 } }}>
          <DialogTitle sx={{
            bgcolor: 'rgba(21,101,192,0.96)', color: '#fff', fontWeight: 700,
            borderTopLeftRadius: 14, borderTopRightRadius: 14, pb: 1.2, fontSize: '1.2rem'
          }}>
            <span className="material-icons" style={{ verticalAlign: 'middle', marginRight: 8, fontSize: 28 }}>find_in_page</span>
            申込状況確認
          </DialogTitle>
          <DialogContent sx={{ pt: 2, pb: 1.5, bgcolor: 'rgba(255,255,255,0.98)' }}>
            <Box sx={{ mb: 2, textAlign: 'center' }}>
              <TextField
                label="申込番号を入力"
                value={input}
                onChange={e => setInput(e.target.value)}
                onKeyDown={e => e.key === 'Enter' && lookup()}
                fullWidth
                variant="outlined"
                sx={{ maxWidth: 340, mb: 1.5 }}
              />
              <Button variant="contained" onClick={lookup} className="action-button" sx={{ ml: 1 }}>
                確認
              </Button>
            </Box>
            {error && <Box className="error-details"><Alert severity="error">{error}</Alert></Box>}
            {result && (
              <Box className="status-card">
                <Typography variant="h6" sx={{ mb: 1.2, fontWeight: 700 }}>
                  申込者: {result.name} ({result.school})
                </Typography>
                <Typography variant="body1" sx={{ mb: 1.2 }}>
                  <b>申込状況: </b>
                  <Chip label={result.status} color="info" sx={{ fontWeight: 700, fontSize: '1.1em' }} />
                  <Button size="small" sx={{ ml: 2, fontWeight: 600 }} onClick={() => setDetailOpen(x => !x)}>
                    詳細 {detailOpen ? <span className="material-icons" style={{ fontSize: 17 }}>expand_less</span> : <span className="material-icons" style={{ fontSize: 17 }}>expand_more</span>}
                  </Button>
                </Typography>
                <Collapse in={detailOpen}>
                  <Divider sx={{ mb: 1, mt: 0.5 }} />
                  <Box>
                    <Typography sx={{ fontWeight: 700, mb: 0.7 }}>申込内容</Typography>
                    <TableContainer>
                      <Table size="small">
                        <TableHead>
                          <TableRow>
                            <TableCell>店舗名</TableCell>
                            <TableCell>日付</TableCell>
                            <TableCell>時間</TableCell>
                            <TableCell>クラス</TableCell>
                            <TableCell>人数</TableCell>
                            <TableCell>状態</TableCell>
                          </TableRow>
                        </TableHead>
                        <TableBody>
                          {result.detail.items.map((item, i) => (
                            <TableRow key={i}>
                              <TableCell>{item.store}</TableCell>
                              <TableCell>{item.date}</TableCell>
                              <TableCell>{item.time}</TableCell>
                              <TableCell>{item.class}</TableCell>
                              <TableCell>{item.cnt}</TableCell>
                              <TableCell>
                                <Chip label={item.status} color={item.status === "受付" ? "success" : "warning"} />
                              </TableCell>
                            </TableRow>
                          ))}
                        </TableBody>
                      </Table>
                    </TableContainer>
                    <Box sx={{ mt: 1 }}>
                      <Alert severity="info" icon={<span className="material-icons" style={{ verticalAlign: 'middle' }}>info</span>}>
                        {result.detail.notes}
                      </Alert>
                    </Box>
                  </Box>
                </Collapse>
              </Box>
            )}
          </DialogContent>
          <DialogActions>
            <Button onClick={onClose} sx={{ fontWeight: 700, color: '#1565c0' }}>閉じる</Button>
          </DialogActions>
        </Dialog>
      );
    }

    // --- メイン画面
    function App() {
      const [openType, setOpenType] = React.useState(null);
      const [snackbar, setSnackbar] = React.useState({ open: false, message: "" });

      const handleSubmit = (form) => {
        setOpenType(null);
        setSnackbar({ open: true, message: "申込が送信されました！ (デモ)" });
      };

      return (
        <Box sx={{
          minHeight: '100vh',
          bgcolor: 'rgba(255,255,255,0.06)',
          pt: { xs: 3, md: 8 },
          pb: { xs: 3, md: 8 }
        }}>
          <Box sx={{
            maxWidth: 800, mx: 'auto', px: { xs: 1, sm: 2 }, py: 0, mb: 6,
            borderRadius: 5, boxShadow: '0 8px 40px rgba(70, 110, 190, 0.08)',
            border: '1.5px solid #e3e6ef', background: 'rgba(255,255,255,0.95)', position: 'relative'
          }} className="glass-effect">
            <Box sx={{ textAlign: 'center', mt: 2, mb: 2 }}>
              <span className="material-icons" style={{ fontSize: 44, color: "#2196f3", verticalAlign: "middle" }}>edit_calendar</span>
              <Typography variant="h5" sx={{
                fontWeight: 800, mb: 1, letterSpacing: 1,
                background: 'linear-gradient(90deg,#2196f3 20%,#7c4dff 100%)',
                WebkitBackgroundClip: 'text', color: 'transparent', display: 'inline-block'
              }}>
                サミット 見学・体験申込管理システム
              </Typography>
              <Typography variant="body1" sx={{ color: '#607d8b', fontWeight: 600 }}>
                学校向け<br />店舗見学・体験の申込受付／申込状況のオンライン確認ができます
              </Typography>
            </Box>
            <Divider sx={{ my: 2, bgcolor: '#90caf9', opacity: 0.6 }} />
            <Grid container spacing={3} justifyContent="center" sx={{ mb: 1 }}>
              <Grid item xs={12} md={4}>
                <Card className="glass-effect" sx={{
                  textAlign: 'center', borderRadius: 4, boxShadow: '0 2px 16px #b0bec320',
                  border: '1.5px solid #e3e6ef', py: 3, px: 2
                }}>
                  <CardContent>
                    <span className="material-icons" style={{ fontSize: 38, color: '#1976d2', marginBottom: 8 }}>explore</span>
                    <Typography variant="h6" sx={{ fontWeight: 700, mb: 1 }}>見学体験申込</Typography>
                    <Typography sx={{ mb: 2, color: '#6d4c41' }}>学校・クラス単位での店舗体験申込はこちら</Typography>
                    <Button
                      className="action-button"
                      variant="contained"
                      size="large"
                      startIcon={<span className="material-icons">school</span>}
                      onClick={() => setOpenType("exp")}
                      sx={{ minWidth: 180 }}
                    >
                      体験申込
                    </Button>
                  </CardContent>
                </Card>
              </Grid>
              <Grid item xs={12} md={4}>
                <Card className="glass-effect" sx={{
                  textAlign: 'center', borderRadius: 4, boxShadow: '0 2px 16px #b0bec320',
                  border: '1.5px solid #e3e6ef', py: 3, px: 2
                }}>
                  <CardContent>
                    <span className="material-icons" style={{ fontSize: 38, color: '#7b1fa2', marginBottom: 8 }}>meeting_room</span>
                    <Typography variant="h6" sx={{ fontWeight: 700, mb: 1 }}>通常見学申込</Typography>
                    <Typography sx={{ mb: 2, color: '#6d4c41' }}>一般的な見学申込はこちら</Typography>
                    <Button
                      className="action-button"
                      variant="contained"
                      size="large"
                      startIcon={<span className="material-icons">storefront</span>}
                      onClick={() => setOpenType("visit")}
                      sx={{ minWidth: 180 }}
                    >
                      見学申込
                    </Button>
                  </CardContent>
                </Card>
              </Grid>
              <Grid item xs={12} md={4}>
                <Card className="glass-effect" sx={{
                  textAlign: 'center', borderRadius: 4, boxShadow: '0 2px 16px #b0bec320',
                  border: '1.5px solid #e3e6ef', py: 3, px: 2
                }}>
                  <CardContent>
                    <span className="material-icons" style={{ fontSize: 38, color: '#1565c0', marginBottom: 8 }}>find_in_page</span>
                    <Typography variant="h6" sx={{ fontWeight: 700, mb: 1 }}>申込状況確認</Typography>
                    <Typography sx={{ mb: 2, color: '#6d4c41' }}>ご自身の申込状況はこちらで確認</Typography>
                    <Button
                      className="action-button"
                      variant="contained"
                      size="large"
                      startIcon={<span className="material-icons">search</span>}
                      onClick={() => setOpenType("lookup")}
                      sx={{ minWidth: 180 }}
                    >
                      状況確認
                    </Button>
                  </CardContent>
                </Card>
              </Grid>
            </Grid>
          </Box>
          {/* 各モーダル */}
          <VisitFormModal
            open={openType === "exp" || openType === "visit"}
            onClose={() => setOpenType(null)}
            onSubmit={handleSubmit}
            type={openType}
          />
          <EntryLookup
            open={openType === "lookup"}
            onClose={() => setOpenType(null)}
          />
          <Snackbar
            open={snackbar.open}
            autoHideDuration={3500}
            onClose={() => setSnackbar(s => ({ ...s, open: false }))}
            anchorOrigin={{ vertical: 'top', horizontal: 'center' }}
          >
            <Alert severity="success" sx={{ fontWeight: 700, fontSize: '1.08em' }}>{snackbar.message}</Alert>
          </Snackbar>
        </Box>
      );
    }

    // --- render
    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
