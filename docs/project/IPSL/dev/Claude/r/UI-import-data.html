<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>見積＆スケジュール 取込システム（完全版・D&D統合UI）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Roboto & MUI Icons -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap"/>
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">

  <!-- React, ReactDOM, Babel -->
  <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js" crossorigin></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.23.8/babel.min.js"></script>

  <!-- Emotion (MUI依存) -->
  <script src="https://cdn.jsdelivr.net/npm/@emotion/react@11.11.3/dist/emotion-react.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@emotion/styled@11.11.0/dist/emotion-styled.umd.min.js"></script>

  <!-- MUI Core -->
  <script src="https://cdn.jsdelivr.net/npm/@mui/material@5.15.3/umd/material-ui.production.min.js" crossorigin></script>

  <style>
    html,body { height:100%; font-family: 'Roboto', 'Noto Sans JP', sans-serif; }
    body { margin:0; background: #fafafa; min-height:100vh; }
    .main-container { background: #ffffff; min-height:100vh; }
    .tableWrap { overflow:auto; max-height:400px; }
    .muted { color:#64748b; font-size:.875rem; }
    .mono { font-family: 'Roboto Mono', monospace; font-size:.8125rem; }
    .dropzone {
      border: 2px dashed #cbd5e1; border-radius: 8px; padding: 24px; text-align:center;
      transition: all 0.2s ease-in-out;
      background: #f8fafc; cursor: pointer;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .dropzone:hover {
      border-color:#2c5aa0; background: #f1f5f9;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    .dropzone.dragover {
      border-color:#2c5aa0; background: #e0e7ff;
      box-shadow: 0 0 0 2px rgba(44,90,160,0.2);
    }
    .k { background: #e0e7ff; border:1px solid #c7d2fe; padding:.25em .5em; border-radius:4px; font-weight:500; color:#3730a3; }
    .business-card { background: #ffffff; border: 1px solid #e2e8f0; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .data-table { border-radius: 4px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
  </style>
</head>
<body>
  <div id="root"></div>

<script type="text/babel">
const {
  AppBar, Toolbar, Typography, Tabs, Tab, Container, Box, Paper,
  Button, Table, TableHead, TableRow, TableCell, TableBody,
  Stack, Snackbar, Alert, Divider, RadioGroup, FormControlLabel, Radio,
  Chip, TextField, Dialog, DialogTitle, DialogContent, DialogActions,
  ThemeProvider, createTheme, CssBaseline
} = MaterialUI;

/* =========================
   業務向けテーマ
========================= */
const theme = createTheme({
  palette: {
    mode: 'light',
    primary: { main: '#2c5aa0', light: '#5472d3', dark: '#1e3a8a' },
    secondary: { main: '#64748b', light: '#94a3b8', dark: '#475569' },
    background: { default: '#f8fafc', paper: '#ffffff' },
    success: { main: '#059669', light: '#10b981', dark: '#047857' },
    warning: { main: '#d97706', light: '#f59e0b', dark: '#b45309' },
    error: { main: '#dc2626', light: '#ef4444', dark: '#b91c1c' },
    info: { main: '#0369a1', light: '#0284c7', dark: '#075985' },
    text: { primary: '#1e293b', secondary: '#64748b' },
    divider: '#e2e8f0'
  },
  typography: {
    fontFamily: '"Roboto", "Noto Sans JP", sans-serif',
    h6: { fontWeight: 500, fontSize: '1.25rem' },
    subtitle1: { fontWeight: 500, fontSize: '1rem' },
    subtitle2: { fontWeight: 500, fontSize: '0.875rem', color: '#424242' },
    body1: { fontSize: '1rem', lineHeight: 1.5 },
    body2: { fontSize: '0.875rem', lineHeight: 1.43 },
    button: { fontWeight: 500, textTransform: 'none' }
  },
  shape: { borderRadius: 4 },
  components: {
    MuiCssBaseline: {
      styleOverrides: {
        body: {
          background: '#f8fafc'
        }
      }
    },
    MuiTable: { defaultProps: { size: 'small' } },
    MuiButton: {
      styleOverrides: {
        root: {
          textTransform: 'none',
          fontWeight: 500,
          borderRadius: 4,
          padding: '8px 16px',
          boxShadow: 'none',
          '&:hover': {
            boxShadow: '0 2px 4px rgba(0,0,0,0.2)'
          }
        },
        contained: {
          boxShadow: '0 2px 4px rgba(0,0,0,0.2)',
          '&:hover': {
            boxShadow: '0 4px 8px rgba(0,0,0,0.3)'
          }
        }
      }
    },
    MuiPaper: {
      styleOverrides: {
        root: {
          borderRadius: 4,
          boxShadow: '0 2px 4px rgba(0,0,0,0.1), 0 8px 16px rgba(0,0,0,0.1)'
        },
        elevation1: {
          boxShadow: '0 2px 1px -1px rgba(0,0,0,0.2), 0 1px 1px 0 rgba(0,0,0,0.14), 0 1px 3px 0 rgba(0,0,0,0.12)'
        }
      }
    },
    MuiChip: {
      styleOverrides: {
        root: {
          fontWeight: 500,
          borderRadius: 16
        }
      }
    },
    MuiAppBar: {
      styleOverrides: {
        root: {
          boxShadow: '0 2px 4px rgba(0,0,0,0.1)'
        }
      }
    },
    MuiTabs: {
      styleOverrides: {
        root: {
          '& .MuiTab-root': {
            fontWeight: 500,
            textTransform: 'none',
            minHeight: 48
          }
        }
      }
    },
    MuiAlert: {
      styleOverrides: {
        root: {
          borderRadius: 4,
          '&.MuiAlert-standardInfo': {
            backgroundColor: '#eff6ff',
            color: '#1e40af',
            border: '1px solid #bfdbfe'
          }
        }
      }
    },
    MuiTextField: {
      styleOverrides: {
        root: {
          '& .MuiOutlinedInput-root': {
            borderRadius: 4
          }
        }
      }
    }
  }
});

/* =========================
   共通ユーティリティ
========================= */
// CSVダウンロード
const toCSV = (filename, rows)=>{
  const csv=rows.map(r=>r.map(v=>{
    const s = v==null ? "" : String(v);
    return /[",\n]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s;
  }).join(",")).join("\n");
  const blob=new Blob([csv],{type:"text/csv;charset=utf-8"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a"); a.href=url; a.download=filename; a.click();
  URL.revokeObjectURL(url);
};

// 引用対応のCSVパーサ（簡易）
const parseCSV = (text)=>{
  const rows=[]; let i=0, field="", row=[], inQuotes=false;
  while(i<text.length){
    const c=text[i];
    if(inQuotes){
      if(c==='"'){ if(text[i+1]==='"'){ field+='"'; i++; } else { inQuotes=false; } }
      else field+=c;
    }else{
      if(c==='"') inQuotes=true;
      else if(c===','){ row.push(field); field=""; }
      else if(c==='\n'){ row.push(field); rows.push(row); row=[]; field=""; }
      else if(c==='\r'){ /* ignore */ }
      else field+=c;
    }
    i++;
  }
  if(field.length>0 || row.length>0){ row.push(field); rows.push(row); }
  if(!rows.length) return [];
  const headers = rows[0].map(h=>h.trim());
  return rows.slice(1).filter(r=>r.some(x=>String(x||"").trim()!==""))
    .map(r=>Object.fromEntries(headers.map((h,idx)=>[h, r[idx]??""])));
};

const fmtDateTime = (d)=> new Date(d).toLocaleString();

/* =========================
   サンプル & テンプレ
========================= */
const sampleEstCSV=`項目,数量,単価,小計,メモ
開発一式,1,100000,,一括見積`;
const sampleSchCSV=`日付,開始,終了,場所,作業内容,担当,メモ
2025-09-01,09:00,18:00,本社,設計,山田,基本設計
2025-09-03,09:00,18:00,現場X,実装A,田中,モジュールA
2025-09-04,09:00,18:00,現場X,実装B,田中,モジュールB
2025-09-10,13:00,17:00,本社,テスト,佐藤,総合テスト`;
const sampleOneCSV=`種別,見積ID,項目,数量,単価,小計,メモ,日付,開始,終了,場所,作業内容,担当
見積,EST001,開発一式,1,100000,,一括見積,,,,,,,
見積,EST002,保守,12,5000,,月次対応,,,,,,,
スケジュール,EST001,,,,,,2025-09-01,09:00,18:00,本社,設計,山田
スケジュール,EST001,,,,,,2025-09-03,09:00,18:00,現場X,実装A,田中
スケジュール,EST002,,,,,,2025-09-20,10:00,12:00,リモート,月次対応,佐藤`;

/* =========================
   小さなUI部品
========================= */
function CsvPreview({rows, max=8}){
  if(!rows?.length) return (
    <Box sx={{p:3, textAlign:'center', background:'#f1f5f9', borderRadius:1, border:'1px dashed #cbd5e1'}}>
      <Typography className="muted">データが読み込まれていません</Typography>
    </Box>
  );
  const headers = Object.keys(rows[0]);
  return (
    <Box className="tableWrap data-table" sx={{border:'1px solid #e2e8f0', borderRadius:1, background:'#ffffff'}}>
      <Table stickyHeader>
        <TableHead>
          <TableRow sx={{background:'#f8fafc'}}>
            {headers.map(h=><TableCell key={h} className="mono" sx={{fontWeight:500, color:'#475569'}}>{h}</TableCell>)}
          </TableRow>
        </TableHead>
        <TableBody>
          {rows.slice(0,max).map((r,idx)=>(
            <TableRow key={idx} sx={{'&:nth-of-type(even)': {background:'#f8fafc'}, '&:hover': {background:'#f1f5f9'}}}>
              {headers.map(h=><TableCell key={h}>{r[h]}</TableCell>)}
            </TableRow>
          ))}
        </TableBody>
      </Table>
    </Box>
  );
}

/* =========================================
   FileImport（D&Dとクリックを統合した単一UI）
   - props:
     label, hint, rows（プレビュー用）, onRows(mergedRows)
========================================= */
function FileImport({label, hint, rows, onRows}){
  const [over, setOver] = React.useState(false);
  const inputRef = React.useRef(null);

  const readFiles = async (files)=>{
    const readText = (file)=> new Promise((res,rej)=>{
      const fr=new FileReader(); fr.onload=()=>res(fr.result); fr.onerror=rej; fr.readAsText(file,"utf-8");
    });
    const texts = await Promise.all(files.map(readText));
    const merged = texts.flatMap(t=>parseCSV(t));
    onRows(merged);
  };

  const onDrop = (e)=>{
    e.preventDefault(); setOver(false);
    const files = Array.from(e.dataTransfer.files || []).filter(f=>f.name.toLowerCase().endsWith(".csv"));
    if(files.length) readFiles(files);
  };

  return (
    <Paper className="business-card" sx={{p:3, flex:1}}>
      <Stack direction="row" justifyContent="space-between" alignItems="center" sx={{mb:2}}>
        <Typography variant="subtitle2" sx={{color:'#1e293b', fontWeight:500}}>{label}</Typography>
        {rows?.length ? 
          <Chip size="small" color="primary" variant="filled" label={`${rows.length} 行`} /> : 
          <Chip size="small" variant="outlined" label="未読込" />
        }
      </Stack>
      {hint && <Typography className="muted" sx={{mb:2, fontSize:'0.875rem', lineHeight:1.5}}>{hint}</Typography>}

      {/* 統合ドロップ/クリック領域 */}
      <Box
        className={`dropzone ${over?'dragover':''}`}
        onClick={()=>inputRef.current?.click()}
        onDragOver={e=>{ e.preventDefault(); setOver(true); }}
        onDragLeave={()=>setOver(false)}
        onDrop={onDrop}
      >
        <Stack alignItems="center" spacing={1}>
          <span className="material-icons" style={{fontSize:'2rem', color:'#64748b'}}>cloud_upload</span>
          <Typography variant="body1" sx={{fontWeight:500, color:'#475569'}}>
            CSVファイルをドラッグ＆ドロップ
          </Typography>
          <Typography variant="body2" className="muted">
            またはクリックして選択
          </Typography>
        </Stack>
        <input type="file" ref={inputRef} hidden accept=".csv" multiple
          onChange={e=>{
            const files = Array.from(e.target.files||[]);
            if(files.length) readFiles(files);
            e.target.value="";
          }}
        />
      </Box>

      <Box sx={{mt:3}}>
        <CsvPreview rows={rows}/>
      </Box>
    </Paper>
  );
}

/* =========================
   マージ表示（見積セット配列）
   set = { id?:string, est:[], sch:[] }
========================= */
function MergeView({sets}){
  if(!sets?.length) return (
    <Box sx={{p:4, textAlign:'center', background:'#f1f5f9', borderRadius:1, border:'1px dashed #cbd5e1'}}>
      <Typography className="muted">マージ結果がありません</Typography>
      <Typography className="muted" sx={{mt:1}}>データを取り込んでください</Typography>
    </Box>
  );
  return (
    <Stack spacing={4}>
      {sets.map((s,idx)=>{
        const est = s.est||[], sch=s.sch||[];
        const idLabel = s.id || `SET${String(idx+1).padStart(3,'0')}`;
        const estHeaders = est[0] ? Object.keys(est[0]) : ["項目","数量","単価","小計","メモ"];
        const schHeaders = sch[0] ? Object.keys(sch[0]) : ["日付","開始","終了","場所","作業内容","担当","メモ"];
        const estTotal = est.reduce((sum,r)=>{
          const qty = Number(r["数量"]||0), unit=Number(r["単価"]||0);
          const sub = Number(r["小計"]) || (qty*unit);
          return sum + (Number.isFinite(sub)?sub:0);
        },0);
        return (
          <Paper key={idx} className="business-card" sx={{p:3, mb:2}}>
            <Stack direction={{xs:'column', md:'row'}} alignItems={{xs:'flex-start', md:'center'}} spacing={2} sx={{mb:2}}>
              <Typography variant="h6" sx={{color:'#1976d2', fontWeight:500}}>
                見積ID: {idLabel}
              </Typography>
              <Stack direction="row" spacing={1} flexWrap="wrap">
                <Chip size="small" color="primary" label={`見積 ${est.length}件`} />
                <Chip size="small" color="secondary" label={`スケジュール ${sch.length}件`} />
                <Chip size="small" color="success" variant="outlined" label={`合計 ¥${estTotal.toLocaleString()}`} />
              </Stack>
            </Stack>

            <Stack direction="row" alignItems="center" spacing={1} sx={{mb:1}}>
              <Typography variant="subtitle2" sx={{color:'#475569', fontWeight:500}}>見積明細</Typography>
              {est.length > 0 && <Chip size="small" color="info" variant="outlined" label={`${est.length}項目`} />}
            </Stack>
            <Box className="tableWrap data-table" sx={{mb:2, border:'1px solid #e2e8f0', borderRadius:1, background:'#ffffff'}}>
              <Table stickyHeader>
                <TableHead>
                  <TableRow sx={{background:'#fef3c7'}}>
                    {estHeaders.map(h=><TableCell key={h} className="mono" sx={{fontWeight:500, color:'#92400e'}}>{h}</TableCell>)}
                  </TableRow>
                </TableHead>
                <TableBody>
                  {est.map((r,i)=>(
                    <TableRow key={i} sx={{'&:nth-of-type(even)': {background:'#fffbeb'}, '&:hover': {background:'#fef3c7'}}}>
                      {estHeaders.map(h=><TableCell key={h}>{r[h]}</TableCell>)}
                    </TableRow>
                  ))}
                </TableBody>
              </Table>
            </Box>

            <Stack direction="row" alignItems="center" spacing={1} sx={{mb:1}}>
              <Typography variant="subtitle2" sx={{color:'#475569', fontWeight:500}}>作業スケジュール</Typography>
              {sch.length > 0 && <Chip size="small" color="info" variant="outlined" label={`${sch.length}件`} />}
            </Stack>
            <Box className="tableWrap data-table" sx={{border:'1px solid #e2e8f0', borderRadius:1, background:'#ffffff'}}>
              <Table stickyHeader>
                <TableHead>
                  <TableRow sx={{background:'#dbeafe'}}>
                    {schHeaders.map(h=><TableCell key={h} className="mono" sx={{fontWeight:500, color:'#1e40af'}}>{h}</TableCell>)}
                  </TableRow>
                </TableHead>
                <TableBody>
                  {sch.map((r,i)=>(
                    <TableRow key={i} sx={{'&:nth-of-type(even)': {background:'#f0f9ff'}, '&:hover': {background:'#dbeafe'}}}>
                      {schHeaders.map(h=><TableCell key={h}>{r[h]}</TableCell>)}
                    </TableRow>
                  ))}
                </TableBody>
              </Table>
            </Box>
          </Paper>
        );
      })}
    </Stack>
  );
}

/* =========================
   メインアプリ
========================= */
function App(){
  const [tab, setTab] = React.useState(0);
  const [mode, setMode] = React.useState("two"); // 'two' | 'one'
  const [twoSets, setTwoSets] = React.useState([{ id:"SET001", est:[], sch:[] }]);
  const [oneRawRows, setOneRawRows] = React.useState([]);  // 1ファイル: 取り込み元の生行プレビュー用
  const [oneSets, setOneSets] = React.useState([]);        // 1ファイル: 見積IDごとにグループ化したセット
  const [activeImport, setActiveImport] = React.useState(false);
  const [editTargetId, setEditTargetId] = React.useState(null);
  const [snack, setSnack] = React.useState("");

  // 履歴（localStorage）
  const HISTORY_KEY = "estimate_schedule_history_v3";
  const [history, setHistory] = React.useState(()=>{
    try{ const raw=localStorage.getItem(HISTORY_KEY); return raw?JSON.parse(raw):[]; }catch(e){ return []; }
  });
  React.useEffect(()=>{ try{ localStorage.setItem(HISTORY_KEY, JSON.stringify(history)); }catch(e){} }, [history]);

  // 1ファイルの行 → セット化
  const groupOneRows = (rows)=>{
    const grouped = {};
    rows.forEach(r=>{
      const id = r["見積ID"];
      if(!id) return;
      if(!grouped[id]) grouped[id] = { id, est:[], sch:[] };
      if(r["種別"]==="見積"){
        grouped[id].est.push({ 項目:r["項目"], 数量:r["数量"], 単価:r["単価"], 小計:r["小計"], メモ:r["メモ"] });
      }else if(r["種別"]==="スケジュール"){
        grouped[id].sch.push({ 日付:r["日付"], 開始:r["開始"], 終了:r["終了"], 場所:r["場所"], 作業内容:r["作業内容"], 担当:r["担当"], メモ:r["メモ"] });
      }
    });
    setOneSets(Object.values(grouped));
  };

  const handleImport = ()=>{
    const activeSets = (mode==="two" ? twoSets.filter(s=>s.est.length&&s.sch.length) : oneSets);
    if(!activeSets.length){ setSnack("取り込むセットがありません"); return; }

    if(editTargetId){
      setHistory(prev=>prev.map(rec=>{
        if(rec.id===editTargetId){
          return { ...rec, updatedAt: Date.now(), status:"Active", mode, sets: activeSets };
        }
        return rec;
      }));
      setSnack("履歴を更新しました");
    }else{
      setHistory(prev=>[
        { id: Date.now(), createdAt: Date.now(), updatedAt: null, status:"Active", mode, sets: activeSets },
        ...prev
      ]);
      setSnack("取り込み完了（履歴に追加）");
    }

    setActiveImport(false);
    setEditTargetId(null);
    setTab(1);
  };

  const startNewImport = ()=>{
    setActiveImport(true);
    setEditTargetId(null);
    setMode("two");
    setTwoSets([{ id:"SET001", est:[], sch:[] }]);
    setOneRawRows([]); setOneSets([]);
    setSnack("新規取り込みを開始しました（現在の入力はリセットされます）");
  };

  // 履歴操作
  const [detail, setDetail] = React.useState(null);
  const cancelHistory = (id)=>{ setHistory(prev=>prev.map(r=>r.id===id?{...r,status:"Canceled",updatedAt:Date.now()}:r)); setSnack("取り込みを取消しました"); };
  const restoreHistory = (id)=>{ setHistory(prev=>prev.map(r=>r.id===id?{...r,status:"Active",updatedAt:Date.now()}:r)); setSnack("取消を復元しました"); };
  const deleteHistory = (id)=>{ setHistory(prev=>prev.filter(r=>r.id!==id)); setSnack("履歴を削除しました"); };
  const editHistory = (rec)=>{
    setMode(rec.mode);
    if(rec.mode==="two"){
      setTwoSets(rec.sets.map((s,idx)=>({ id:s.id||`SET${String(idx+1).padStart(3,'0')}`, est:s.est||[], sch:s.sch||[] })));
      setOneRawRows([]); setOneSets([]);
    }else{
      setOneRawRows([]); setOneSets(rec.sets.map(s=>({ id:s.id, est:s.est||[], sch:s.sch||[] })));
    }
    setActiveImport(true);
    setEditTargetId(rec.id);
    setTab(0);
    setSnack("履歴を編集モードで読み込みました");
  };

  // テンプレDL
  const dlEstimateTpl = ()=> toCSV("estimate_template.csv", [["項目","数量","単価","小計","メモ"],["開発一式",1,100000,"","一括見積"]]);
  const dlScheduleTpl = ()=> toCSV("schedule_template.csv", [["日付","開始","終了","場所","作業内容","担当","メモ"],["2025-01-01","09:00","12:00","会議室","作業A","山田",""]]);
  const dlOneFileTpl = ()=> toCSV("onefile_template.csv", [
    ["種別","見積ID","項目","数量","単価","小計","メモ","日付","開始","終了","場所","作業内容","担当"],
    ["見積","EST001","開発一式",1,100000,"","一括見積","","","","","",""],
    ["見積","EST002","保守",12,5000,"","月次対応","","","","","",""],
    ["スケジュール","EST001","","","","","","2025-01-01","09:00","12:00","会議室","設計","山田"],
    ["スケジュール","EST002","","","","","","2025-01-05","10:00","12:00","リモート","月次対応","佐藤"]
  ]);

  return (
    <ThemeProvider theme={theme}>
      <CssBaseline />
      <AppBar position="sticky" color="primary">
        <Toolbar>
          <Typography variant="h6" sx={{flexGrow:1, fontWeight:500}}>
            見積＆スケジュール 取込システム
          </Typography>
          {editTargetId && <Chip color="warning" label="編集中" sx={{mr:2, color:'white'}} />}
          <Button 
            color="inherit" 
            variant="outlined"
            startIcon={<span className="material-icons">add</span>} 
            onClick={startNewImport}
            sx={{borderColor:'white', color:'white'}}
          >
            新規取り込み
          </Button>
        </Toolbar>
      </AppBar>

      <Tabs 
        value={tab} 
        onChange={(e,v)=>setTab(v)} 
        variant="fullWidth"
        sx={{
          background:'#ffffff',
          borderBottom:'1px solid #e0e0e0'
        }}
      >
        <Tab label="データ取り込み" />
        <Tab label="取り込み履歴" />
      </Tabs>

      <Container className="main-container" maxWidth="lg" sx={{py:3}}>
        {tab===0 && (
          <Box>
            <Alert severity="info" sx={{mb:3}}>
              <Typography variant="body1" sx={{fontWeight:500, mb:1}}>
                クイックスタートガイド
              </Typography>
              <Typography variant="body2">
                • まずは <span class="k">サンプル反映</span> で操作を体験してください<br/>
                • CSVファイルは <span class="k">UTF-8</span> で保存（Excel: 「CSV UTF-8」形式を選択）<br/>
                • <span class="k">2ファイル方式</span> または <span class="k">1ファイル方式</span> から選択可能
              </Typography>
            </Alert>

            <Paper className="business-card" sx={{p:3, mb:3}}>
              <Stack direction={{xs:'column', md:'row'}} alignItems={{xs:'flex-start', md:'center'}} spacing={2}>
                <Typography variant="subtitle2" sx={{color:'#475569', fontWeight:500, minWidth:'120px'}}>
                  取り込み方式
                </Typography>
                <RadioGroup row value={mode} onChange={e=>setMode(e.target.value)} sx={{flexGrow:1}}>
                  <FormControlLabel 
                    value="two" 
                    control={<Radio />} 
                    label="2ファイル方式" 
                  />
                  <FormControlLabel 
                    value="one" 
                    control={<Radio />} 
                    label="1ファイル方式" 
                  />
                </RadioGroup>
                {activeImport ? 
                  <Chip color="success" label="作業中" /> : 
                  <Chip variant="outlined" label="未開始" />
                }
              </Stack>
            </Paper>

            {/* 2ファイル方式（複数セット） */}
            {mode==="two" && (
              <Box>
                <Alert severity="info" sx={{mb:3}}>
                  <Typography variant="body2">
                    複数の見積セットを作成可能。各セットに <span class="k">見積CSV</span> と <span class="k">スケジュールCSV</span> をドラッグ＆ドロップで簡単取り込み
                  </Typography>
                </Alert>

                {twoSets.map((s,idx)=>(
                  <Paper key={idx} sx={{p:2, mb:2}}>
                    <Stack direction={{xs:"column",md:"row"}} justifyContent="space-between" spacing={2}>
                      <Stack direction="row" alignItems="center" spacing={1}>
                        <Typography variant="subtitle1">見積セット {idx+1}</Typography>
                        <TextField size="small" label="見積ID（任意）" value={s.id||""}
                          onChange={(e)=>{
                            const v=e.target.value;
                            setTwoSets(prev=>{ const cp=[...prev]; cp[idx]={...cp[idx], id:v}; return cp; });
                          }}/>
                      </Stack>
                      <Stack direction="row" spacing={1}>
                        <Button size="small" variant="outlined" onClick={()=>{
                          setTwoSets(prev=>{
                            const cp=[...prev];
                            cp[idx]={...cp[idx], est:parseCSV(sampleEstCSV), sch:parseCSV(sampleSchCSV)};
                            return cp;
                          });
                          setActiveImport(true);
                          setSnack(`セット${idx+1} にサンプルを反映しました`);
                        }}>サンプル反映</Button>
                        <Button size="small" color="error" variant="text" onClick={()=>{
                          setTwoSets(prev=> prev.length>1 ? prev.filter((_,i)=>i!==idx) : [{id:"SET001", est:[], sch:[]}]);
                        }}>セット削除</Button>
                      </Stack>
                    </Stack>

                    <Stack direction={{xs:"column",md:"row"}} spacing={2} sx={{mt:1}}>
                      <FileImport
                        label="見積CSV（D&D またはクリック）"
                        hint="列：項目,数量,単価,小計,メモ / 複数CSVを重ねて読み込むと結合されます"
                        rows={s.est}
                        onRows={(rows)=>{ setActiveImport(true); setTwoSets(prev=>{ const cp=[...prev]; cp[idx]={...cp[idx], est:rows}; return cp; }); }}
                      />
                      <FileImport
                        label="スケジュールCSV（D&D またはクリック）"
                        hint="列：日付,開始,終了,場所,作業内容,担当,メモ / 複数CSVを重ねて読み込むと結合されます"
                        rows={s.sch}
                        onRows={(rows)=>{ setActiveImport(true); setTwoSets(prev=>{ const cp=[...prev]; cp[idx]={...cp[idx], sch:rows}; return cp; }); }}
                      />
                    </Stack>
                  </Paper>
                ))}

                <Stack direction="row" spacing={1} sx={{mb:2}}>
                  <Button variant="outlined" startIcon={<span className="material-icons">playlist_add</span>}
                    onClick={()=>setTwoSets(prev=>[...prev, {id:`SET${String(prev.length+1).padStart(3,'0')}`, est:[], sch:[]}])}>
                    見積セットを追加
                  </Button>
                  <Button onClick={dlEstimateTpl}>見積テンプレDL</Button>
                  <Button onClick={dlScheduleTpl}>スケジュールテンプレDL</Button>
                </Stack>
              </Box>
            )}

            {/* 1ファイル方式 */}
            {mode==="one" && (
              <Box>
                <Alert severity="info" sx={{mb:3}}>
                  <Typography variant="body2">
                    1つのCSVに <span class="k">種別</span> と <span class="k">見積ID</span> を含めると自動紐づけ。複数ファイルのドラッグ＆ドロップに対応
                  </Typography>
                </Alert>

                <Paper sx={{p:2, mb:2}}>
                  <Typography variant="subtitle1" gutterBottom>1ファイルCSV（見積+スケジュール）</Typography>
                  <FileImport
                    label="1ファイルCSV（D&D またはクリック）"
                    hint="列例：種別,見積ID,項目,数量,単価,小計,メモ,日付,開始,終了,場所,作業内容,担当"
                    rows={oneRawRows}
                    onRows={(rows)=>{ setActiveImport(true); setOneRawRows(rows); groupOneRows(rows); }}
                  />
                  <Stack direction="row" spacing={1} sx={{mt:1}}>
                    <Button variant="outlined" onClick={()=>{ const rows=parseCSV(sampleOneCSV); setActiveImport(true); setOneRawRows(rows); groupOneRows(rows); setSnack("1ファイルのサンプルを反映しました"); }}>
                      サンプル反映
                    </Button>
                    <Button onClick={dlOneFileTpl}>1ファイルテンプレDL</Button>
                  </Stack>
                </Paper>
              </Box>
            )}

            <Divider sx={{my:2}} />
            <Typography variant="h6" sx={{mb:1}}>確認用マージ結果</Typography>
            <MergeView sets={mode==="two" ? twoSets.filter(s=>s.est.length||s.sch.length) : oneSets} />

            <Stack direction="row" spacing={2} sx={{mt:2}}>
              <Button variant="contained" onClick={handleImport} disabled={!activeImport}>
                取り込み実行
              </Button>
              <Button variant="text" onClick={startNewImport}>
                やり直す（新規取り込み開始）
              </Button>
              <Button variant="text" onClick={()=>{ dlEstimateTpl(); dlScheduleTpl(); }}>
                テンプレまとめDL（見積/スケジュール）
              </Button>
            </Stack>

            {editTargetId && (
              <Typography className="muted" sx={{mt:1}}>
                ※ 履歴の編集中です。<b>取り込み実行</b>で上書き保存します。新規として保存したい場合は「新規取り込み開始」を押してください。
              </Typography>
            )}
          </Box>
        )}

        {tab===1 && (
          <Box>
            <Typography variant="h6" sx={{mb:1}}>取り込み履歴</Typography>
            <Paper>
              <Box className="tableWrap">
                <Table stickyHeader>
                  <TableHead>
                    <TableRow>
                      <TableCell>状態</TableCell>
                      <TableCell>作成</TableCell>
                      <TableCell>更新</TableCell>
                      <TableCell>方式</TableCell>
                      <TableCell>見積数</TableCell>
                      <TableCell align="right">操作</TableCell>
                    </TableRow>
                  </TableHead>
                  <TableBody>
                    {history.map(rec=>{
                      const sets = rec.sets||[];
                      return (
                        <TableRow key={rec.id} hover onClick={e=>{ if(e.target.tagName!=="BUTTON" && e.target.tagName!=="SPAN") setDetail(rec); }}>
                          <TableCell><Chip size="small" color={rec.status==="Active"?"success":"default"} variant={rec.status==="Active"?"filled":"outlined"} label={rec.status}/></TableCell>
                          <TableCell>{fmtDateTime(rec.createdAt)}</TableCell>
                          <TableCell>{rec.updatedAt ? fmtDateTime(rec.updatedAt) : "-"}</TableCell>
                          <TableCell>{rec.mode==="two"?"2ファイル":"1ファイル"}</TableCell>
                          <TableCell>{sets.length}</TableCell>
                          <TableCell align="right">
                            <Stack direction="row" spacing={1} justifyContent="flex-end">
                              <Button size="small" onClick={()=>editHistory(rec)}>修正</Button>
                              {rec.status==="Active"
                                ? <Button size="small" color="warning" onClick={()=>cancelHistory(rec.id)}>取消</Button>
                                : <Button size="small" onClick={()=>restoreHistory(rec.id)}>復元</Button>}
                              <Button size="small" color="error" onClick={()=>deleteHistory(rec.id)}>削除</Button>
                            </Stack>
                          </TableCell>
                        </TableRow>
                      );
                    })}
                    {history.length===0 && <TableRow><TableCell colSpan={6} className="muted">履歴はまだありません。</TableCell></TableRow>}
                  </TableBody>
                </Table>
              </Box>
            </Paper>

            <Dialog open={!!detail} onClose={()=>setDetail(null)} fullWidth maxWidth="lg">
              <DialogTitle>取り込み詳細</DialogTitle>
              <DialogContent dividers sx={{pb:0}}>
                {detail && (
                  <Box>
                    <Stack direction={{xs:"column", md:"row"}} spacing={2} sx={{mb:2}}>
                      <Chip label={`状態: ${detail.status}`} color={detail.status==="Active"?"success":"default"} />
                      <Chip label={`方式: ${detail.mode==="two"?"2ファイル":"1ファイル"}`} />
                      <Chip label={`見積数: ${detail.sets?.length || 0}`} />
                      <Chip label={`作成: ${fmtDateTime(detail.createdAt)}`} variant="outlined" />
                      <Chip label={`更新: ${detail.updatedAt ? fmtDateTime(detail.updatedAt) : "-"}`} variant="outlined" />
                    </Stack>
                    <MergeView sets={detail.sets} />
                  </Box>
                )}
              </DialogContent>
              <DialogActions>
                <Button onClick={()=>setDetail(null)}>閉じる</Button>
              </DialogActions>
            </Dialog>
          </Box>
        )}
      </Container>

      <Snackbar open={!!snack} autoHideDuration={2600} onClose={()=>setSnack("")} message={snack} />
    </ThemeProvider>
  );
}

ReactDOM.createRoot(document.getElementById("root")).render(<App/>);
</script>
</body>
</html>
