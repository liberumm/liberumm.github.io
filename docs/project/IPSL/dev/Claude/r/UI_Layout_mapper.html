<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>CSV ÁÆ°ÁêÜ„ÉÑ„Éº„É´ÔºàÂ±•Ê≠¥„É™„Çπ„ÉàÂØæÂøú„Éª„Éï„É´Ê©üËÉΩÁâàÔºâ</title>

  <!-- ====== CDN Ë™≠„ÅøËæº„Åø ====== -->
  <script src="https://cdn.jsdelivr.net/npm/react@18/umd/react.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mui/material@5.15.14/umd/material-ui.production.min.js"></script>
  <script src="https://unpkg.com/react-beautiful-dnd@13.1.0/dist/react-beautiful-dnd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.2/babel.min.js"></script>
  <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>

  <!-- Roboto / Icons -->
  <link rel="stylesheet"
        href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap" />
  <link rel="stylesheet"
        href="https://fonts.googleapis.com/icon?family=Material+Icons" />

  <style>
    body { margin: 0; padding: 16px; font-family: Roboto, sans-serif; }
    #root { max-width: 1200px; margin: auto; }
    .MuiDialog-root { z-index: 1300; }
    .droppableBox {
      position: unset !important;
      margin: 8px 0;
      min-height: 44px;
      padding: 8px;
      border: 1px dashed #ccc;
      border-radius: 4px;
      background: #fafafa;
    }
    .draggableItem {
      position: relative;
      z-index: 2;
      padding: 4px 8px;
      margin-bottom: 4px;
      background: #e0e0e0;
      border-radius: 4px;
      cursor: grab;
      user-select: none;
    }
    .draggingItem {
      z-index: 1400 !important;
      position: fixed !important;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
  const {
    Container, Box, Button, Typography,
    Table, TableHead, TableRow, TableCell, TableBody,
    TableContainer, Paper,
    Dialog, DialogTitle, DialogContent, DialogActions,
    Grid, TextField, FormControl, InputLabel, Select, MenuItem,
    useTheme, useMediaQuery
  } = MaterialUI;
  const { DragDropContext, Droppable, Draggable } = ReactBeautifulDnd;

  // ÂÖ±ÈÄöÂÆöÊï∞
  const BASE_FIELDS   = ["ÂïÜÂìÅ„Ç≥„Éº„Éâ","ÂïÜÂìÅÂêç","Êï∞Èáè","‰æ°Ê†º","Êó•‰ªò"];
  const STORAGE_KEY   = "csvMappingTemplates_v1_demo";
  const SAMPLE_CSV    = {
    "Êó•Êú¨Ë™û„Éò„ÉÉ„ÉÄ„Éº": `ÂïÜÂìÅ„Ç≥„Éº„Éâ,ÂïÜÂìÅÂêç,Êï∞Èáè,‰æ°Ê†º,Êó•‰ªò
A001,„Çä„Çì„Åî,10,120,2025-05-01
A002,„Åø„Åã„Çì,15,100,2025-05-02
A003,„Éê„Éä„Éä,8,150,2025-05-03`,
    "English„Éò„ÉÉ„ÉÄ„Éº": `code,name,qty,price,date
B001,Apple,15,110,2025-05-03
B002,Orange,20,90,2025-05-04
B003,Banana,12,140,2025-05-05`,
    "„É©„É≥„ÉÄ„É†È†Ü": `price,date,itemCode,itemName,quantity
200,2025-05-05,C001,„Ç™„É¨„É≥„Ç∏,12
180,2025-05-06,C002,„Çä„Çì„Åî,8
220,2025-05-07,C003,„Éê„Éä„Éä,15`,
    "ÁâπÊÆäÊñáÂ≠óÂÖ•„Çä": `ÂïÜÂìÅCD,ÂïÜÂìÅ Âêç,ÂÄãÊï∞,Âçò‰æ°(ÂÜÜ),Âá¶ÁêÜÊó•
D001,„Çä„Çì„Åî (Ëµ§),5,200,2025/05/08
D002,„Ç™„É¨„É≥„Ç∏(Ëº∏ÂÖ•),10,180,2025/05/09
D003,„Éê„Éä„ÉäÔºàÂ§ßÔºâ,6,250,2025/05/10`
  };
  const DEFAULT_TEMPLATES = [
    { name: "JapaneseHeader",
      mapping: { "ÂïÜÂìÅ„Ç≥„Éº„Éâ":"ÂïÜÂìÅ„Ç≥„Éº„Éâ","ÂïÜÂìÅÂêç":"ÂïÜÂìÅÂêç","Êï∞Èáè":"Êï∞Èáè","‰æ°Ê†º":"‰æ°Ê†º","Êó•‰ªò":"Êó•‰ªò" } },
    { name: "EnglishHeader",
      mapping: { "ÂïÜÂìÅ„Ç≥„Éº„Éâ":"code","ÂïÜÂìÅÂêç":"name","Êï∞Èáè":"qty","‰æ°Ê†º":"price","Êó•‰ªò":"date" } },
    { name: "ShuffledHeader",
      mapping: { "ÂïÜÂìÅ„Ç≥„Éº„Éâ":"itemCode","ÂïÜÂìÅÂêç":"itemName","Êï∞Èáè":"quantity","‰æ°Ê†º":"price","Êó•‰ªò":"date" } }
  ];
  if (!localStorage.getItem(STORAGE_KEY)) {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(DEFAULT_TEMPLATES));
  }

  // CSV‚Üí2Ê¨°ÂÖÉÈÖçÂàóÂ§âÊèõ„É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£
  function csvTo2D(text) {
    const wb = XLSX.read(text, { type: "string" });
    const ws = wb.Sheets[wb.SheetNames[0]];
    return XLSX.utils.sheet_to_json(ws, { header: 1, defval: "" });
  }

  // „É°„Ç§„É≥ App
  function App() {
    const [mainData,    setMainData]    = React.useState([]);
    const [historyList, setHistoryList] = React.useState([]); // Â±•Ê≠¥„É™„Çπ„Éà
    const [openMapping, setOpenMapping] = React.useState(false);
    const [openImport,  setOpenImport]  = React.useState(false);
    const [openExport,  setOpenExport]  = React.useState(false);
    const [openHistory, setOpenHistory] = React.useState(false);
    const [previewRows, setPreviewRows] = React.useState(null); // Â±•Ê≠¥„Éó„É¨„Éì„É•„ÉºÁî®
    const [message, setMessage] = React.useState(""); // ÈÄöÁü•Áî®
    const [confirm, setConfirm] = React.useState(null); // Á¢∫Ë™çÁî® {msg, onOk}

    // --- Êó¢Â≠ò„ÅÆalert/confirm„ÇíÁΩÆÊèõ ---
    // „Ç§„É≥„Éù„Éº„ÉàÁ¢∫ÂÆöÊôÇ
    const handleImported = rows => {
      if (!rows?.length) return;
      const snapshot = {
        id: Date.now(),
        timestamp: new Date(),
        prevData: JSON.parse(JSON.stringify(mainData)),
        importedData: JSON.parse(JSON.stringify(rows)),
        deleted: false
      };
      setHistoryList(prev => [...prev, snapshot]);
      setMainData(prev => [...prev, ...JSON.parse(JSON.stringify(rows))]);
      setOpenImport(false);
      setMessage("„Ç§„É≥„Éù„Éº„Éà„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„Åü");
    };

    // „Ç®„ÇØ„Çπ„Éù„Éº„ÉàÁ¢∫ÂÆö
    const handleExportConfirm = () => {
      if (!mainData.length) {
        setMessage("„Ç®„ÇØ„Çπ„Éù„Éº„ÉàÂØæË±°„Åå„ÅÇ„Çä„Åæ„Åõ„Çì");
        return;
      }
      const ws  = XLSX.utils.json_to_sheet(mainData, { header: BASE_FIELDS });
      const csv = XLSX.utils.sheet_to_csv(ws);
      const blob= new Blob([csv], { type:"text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a   = document.createElement("a");
      a.href = url; a.download = "base_table.csv"; a.click();
      URL.revokeObjectURL(url);
      setOpenExport(false);
      setMessage("„Ç®„ÇØ„Çπ„Éù„Éº„Éà„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„Åü");
    };

    // Â±•Ê≠¥„Åã„ÇâÂæ©Ê¥ª
    const handleRestore = id => {
      const entry = historyList.find(e => e.id === id);
      if (!entry || !entry.deleted) return;
      setMainData(prev => [...prev, ...JSON.parse(JSON.stringify(entry.importedData))]);
      setHistoryList(prev => prev.map(e =>
        e.id === id ? { ...e, deleted: false } : e
      ));
      setOpenHistory(false);
      setMessage("„Éá„Éº„Çø„ÇíÂæ©Ê¥ª„Åó„Åæ„Åó„Åü");
    };

    // Â±•Ê≠¥ÂâäÈô§
    const handleDeleteHistory = id => {
      const entry = historyList.find(e => e.id === id);
      if (!entry || entry.deleted) return;
      setConfirm({
        msg: "„Åì„ÅÆÂ±•Ê≠¥„ÅßËøΩÂä†„Åï„Çå„Åü„Éá„Éº„Çø„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü",
        onOk: () => {
          setMainData(prev => {
            let result = [...prev];
            entry.importedData.forEach(imp => {
              const idx = result.findIndex(row =>
                BASE_FIELDS.every(f => row[f] === imp[f])
              );
              if (idx !== -1) result.splice(idx, 1);
            });
            return result;
          });
          setHistoryList(prev => prev.map(e =>
            e.id === id ? { ...e, deleted: true } : e
          ));
          setConfirm(null);
          setMessage("„Éá„Éº„Çø„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü");
        }
      });
    };

    return (
      <Container maxWidth="lg">
        <Box mb={2} display="flex" flexWrap="wrap" gap={1}>
          <Button variant="outlined" onClick={()=>setOpenMapping(true)}>
            „Éû„ÉÉ„Éî„É≥„Ç∞ÂÆöÁæ©
          </Button>
          <Button variant="outlined" onClick={()=>setOpenImport(true)}>
            „Ç§„É≥„Éù„Éº„Éà
          </Button>
          <Button variant="outlined" onClick={()=>setOpenExport(true)}>
            „Ç®„ÇØ„Çπ„Éù„Éº„Éà
          </Button>
          <Button variant="outlined" onClick={()=>setOpenHistory(true)}>
            Â±•Ê≠¥‰∏ÄË¶ß
          </Button>
        </Box>

        <TableContainer component={Paper} sx={{ overflowX:'auto' }}>
          <Table size="small">
            <TableHead>
              <TableRow>
                {BASE_FIELDS.map(f => <TableCell key={f}>{f}</TableCell>)}
              </TableRow>
            </TableHead>
            <TableBody>
              {mainData.length > 0 ? mainData.map((row,i)=>(
                <TableRow key={i}>
                  {BASE_FIELDS.map(f=> <TableCell key={f}>{row[f]}</TableCell>)}
                </TableRow>
              )) : (
                <TableRow>
                  <TableCell colSpan={BASE_FIELDS.length} align="center">
                    „Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì
                  </TableCell>
                </TableRow>
              )}
            </TableBody>
          </Table>
        </TableContainer>

        <MappingDialog
          open={openMapping}
          onClose={()=>setOpenMapping(false)}
        />
        <ImportDialog
          open={openImport}
          onClose={()=>setOpenImport(false)}
          onConfirm={handleImported}
        />
        <ExportDialog
          open={openExport}
          onClose={()=>setOpenExport(false)}
          onConfirm={handleExportConfirm}
          rowCount={mainData.length}
        />
        <HistoryDialog
          open={openHistory}
          onClose={()=>setOpenHistory(false)}
          historyList={historyList}
          onRestore={handleRestore}
          onDelete={handleDeleteHistory}
          onPreview={setPreviewRows}
        />
        {previewRows && (
          <Dialog open onClose={()=>setPreviewRows(null)} maxWidth="md" fullWidth>
            <DialogTitle>ËøΩÂä†„Éá„Éº„Çø„Éó„É¨„Éì„É•„Éº</DialogTitle>
            <DialogContent dividers>
              <TableContainer component={Paper} sx={{ maxHeight:300, overflow:"auto" }}>
                <Table size="small" stickyHeader>
                  <TableHead>
                    <TableRow>
                      {BASE_FIELDS.map(f=> <TableCell key={f}>{f}</TableCell>)}
                    </TableRow>
                  </TableHead>
                  <TableBody>
                    {previewRows.map((r,i)=>(
                      <TableRow key={i}>
                        {BASE_FIELDS.map(f=> <TableCell key={f}>{r[f]}</TableCell>)}
                      </TableRow>
                    ))}
                  </TableBody>
                </Table>
              </TableContainer>
            </DialogContent>
            <DialogActions>
              <Button onClick={()=>setPreviewRows(null)}>Èñâ„Åò„Çã</Button>
            </DialogActions>
          </Dialog>
        )}
        {/* „É°„ÉÉ„Çª„Éº„Ç∏Ë°®Á§∫ */}
        <Dialog open={!!message} onClose={()=>setMessage("")}>
          <DialogTitle>„ÅäÁü•„Çâ„Åõ</DialogTitle>
          <DialogContent>
            <Typography>{message}</Typography>
          </DialogContent>
          <DialogActions>
            <Button onClick={()=>setMessage("")}>OK</Button>
          </DialogActions>
        </Dialog>
        {/* Á¢∫Ë™ç„ÉÄ„Ç§„Ç¢„É≠„Ç∞ */}
        <Dialog open={!!confirm} onClose={()=>setConfirm(null)}>
          <DialogTitle>Á¢∫Ë™ç</DialogTitle>
          <DialogContent>
            <Typography>{confirm?.msg}</Typography>
          </DialogContent>
          <DialogActions>
            <Button onClick={()=>setConfirm(null)}>„Ç≠„É£„É≥„Çª„É´</Button>
            <Button variant="contained" color="primary" onClick={()=>{
              confirm.onOk();
            }}>OK</Button>
          </DialogActions>
        </Dialog>
      </Container>
    );
  }

  // MappingDialogÔºàÂÆåÂÖ®ÁâàÔºâ
  function MappingDialog({ open, onClose }) {
    const theme      = useTheme();
    const fullScreen = useMediaQuery(theme.breakpoints.down('sm'));

    const [templates, setTemplates] = React.useState(
      () => JSON.parse(localStorage.getItem(STORAGE_KEY))
    );
    const [tplName,   setTplName]   = React.useState("");
    const [csvHeaders, setCsvHeaders] = React.useState([]);
    const [csvSample,  setCsvSample]  = React.useState({});
    const [mapping,    setMapping]    = React.useState({});
    const [unassigned, setUnassigned] = React.useState([]);
    const [sampleKey,  setSampleKey]  = React.useState("");
    const [message, setMessage] = React.useState("");
    const [confirm, setConfirm] = React.useState(null);

    // „Éó„É¨„Éì„É•„ÉºÂàùÊúüÂåñ
    const initPreview = arr => {
      const hdr = arr[0] || [];
      const sample = {};
      hdr.forEach((h,i)=> sample[h] = (arr[1]||[])[i] || "");
      setCsvHeaders(hdr);
      setCsvSample(sample);
      const initMap = {};
      BASE_FIELDS.forEach(f=> initMap[f] = null);
      setMapping(initMap);
      setUnassigned(hdr);
    };

    // „Éá„É¢„Çµ„É≥„Éó„É´ÈÅ∏Êäû
    const handleSample = key => {
      setSampleKey(key);
      setCsvHeaders([]); setMapping({}); setUnassigned([]);
      if (key) initPreview(csvTo2D(SAMPLE_CSV[key]));
    };
    // „Éï„Ç°„Ç§„É´„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ
    const handleFile = e => {
      const f = e.target.files[0];
      if (!f) return;
      setSampleKey("");
      const reader = new FileReader();
      reader.onload = ev => initPreview(csvTo2D(ev.target.result));
      reader.readAsText(f,"utf-8");
    };

    // DnD ÂÆå‰∫ÜÊôÇ
    const onDragEnd = res => {
      const { source, destination, draggableId } = res;
      if (!destination) return;
      const src = source.droppableId, dst = destination.droppableId;

      // Êú™Ââ≤ÂΩì ‚Üí Êú™Ââ≤ÂΩìÔºà‰∏¶„Å≥Êõø„ÅàÔºâ
      if (src==="unassigned" && dst==="unassigned") {
        const items=[...unassigned];
        items.splice(source.index,1);
        items.splice(destination.index,0,draggableId);
        setUnassigned(items);
        return;
      }
      // Êú™Ââ≤ÂΩì ‚Üí „Éï„Ç£„Éº„É´„ÉâÔºàÂâ≤ÂΩìÔºâ
      if (src==="unassigned" && BASE_FIELDS.includes(dst)) {
        const prev = mapping[dst];
        const nextUn = unassigned.filter(h=>h!==draggableId);
        if (prev) nextUn.push(prev);
        setUnassigned(nextUn);
        setMapping({...mapping, [dst]:draggableId});
        return;
      }
      // „Éï„Ç£„Éº„É´„Éâ ‚Üí Êú™Ââ≤ÂΩìÔºàËß£Èô§Ôºâ
      if (BASE_FIELDS.includes(src) && dst==="unassigned") {
        const hdr = mapping[src];
        if (!hdr) return;
        const nextUn=[...unassigned];
        nextUn.splice(destination.index,0,hdr);
        setUnassigned(nextUn);
        setMapping({...mapping, [src]:null});
        return;
      }
      // „Éï„Ç£„Éº„É´„Éâ ‚Üî „Éï„Ç£„Éº„É´„ÉâÔºàÂÖ•„ÇåÊõø„ÅàÔºâ
      if (BASE_FIELDS.includes(src) && BASE_FIELDS.includes(dst)) {
        const a = mapping[src], b = mapping[dst];
        setMapping({...mapping, [src]:b, [dst]:a});
      }
    };

    // ‰øùÂ≠ò„ÉªÂâäÈô§
    const saveTpl = () => {
      if (!tplName) {
        setMessage("„ÉÜ„É≥„Éó„É¨„Éº„ÉàÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ");
        return;
      }
      const next = templates.filter(t=>t.name!==tplName)
                            .concat({ name:tplName, mapping });
      setTemplates(next);
      localStorage.setItem(STORAGE_KEY, JSON.stringify(next));
      setMessage("‰øùÂ≠ò„Åó„Åæ„Åó„Åü");
    };
    const deleteTpl = () => {
      if (!tplName) return;
      setConfirm({
        msg: "ÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü",
        onOk: () => {
          const next = templates.filter(t=>t.name!==tplName);
          setTemplates(next);
          localStorage.setItem(STORAGE_KEY, JSON.stringify(next));
          setTplName("");
          setCsvHeaders([]); setMapping({}); setUnassigned([]); setSampleKey("");
          setConfirm(null);
          setMessage("ÂâäÈô§„Åó„Åæ„Åó„Åü");
        }
      });
    };

    return (
      <Dialog
        fullScreen={fullScreen}
        fullWidth maxWidth="lg"
        open={open} onClose={onClose}
      >
        <DialogTitle>„Éû„ÉÉ„Éî„É≥„Ç∞ÂÆöÁæ©</DialogTitle>
        <DialogContent
          dividers
          sx={{ overflow:"visible", position:"relative", zIndex:1 }}
        >
          <Grid container spacing={2}>
            <Grid item xs={12} md={5}>
              <TextField
                label="„ÉÜ„É≥„Éó„É¨„Éº„ÉàÂêç"
                value={tplName}
                onChange={e=>setTplName(e.target.value)}
                fullWidth
              />
            </Grid>
            <Grid item xs={12} md={7} container alignItems="center" spacing={1}>
              <Grid item>
                <Button onClick={()=>{
                  const n = prompt("Êñ∞„Åó„ÅÑ„ÉÜ„É≥„Éó„É¨„Éº„ÉàÂêç");
                  if (n) setTplName(n);
                }}>Ôºã Êñ∞Ë¶è</Button>
              </Grid>
              <Grid item>
                <Button color="error" onClick={deleteTpl}>üóëÔ∏è ÂâäÈô§</Button>
              </Grid>
              <Grid item>
                <Button variant="contained" onClick={saveTpl}>‰øùÂ≠ò</Button>
              </Grid>
            </Grid>
          </Grid>

          <Box mt={3}>
            <FormControl fullWidth>
              <InputLabel>„Éá„É¢„Çµ„É≥„Éó„É´</InputLabel>
              <Select
                value={sampleKey}
                label="„Éá„É¢„Çµ„É≥„Éó„É´"
                onChange={e=>handleSample(e.target.value)}
              >
                <MenuItem value="">Ôºà„Éï„Ç°„Ç§„É´„Çí‰ΩøÁî®Ôºâ</MenuItem>
                {Object.keys(SAMPLE_CSV).map(k=>
                  <MenuItem key={k} value={k}>{k}</MenuItem>
                )}
              </Select>
            </FormControl>
            <Box mt={2}>
              <input type="file" accept=".csv" onChange={handleFile} />
            </Box>
          </Box>

          {csvHeaders.length > 0 && (
            <Box mt={3}>
              <Typography variant="subtitle1">„Éò„ÉÉ„ÉÄ„Éº & „Çµ„É≥„Éó„É´</Typography>
              <TableContainer component={Paper} sx={{ overflowX:'auto', mb:2 }}>
                <Table size="small">
                  <TableHead>
                    <TableRow>
                      {csvHeaders.map(h=> <TableCell key={h}>{h}</TableCell>)}
                    </TableRow>
                  </TableHead>
                  <TableBody>
                    <TableRow>
                      {csvHeaders.map(h=><TableCell key={h}>{csvSample[h]}</TableCell>)}
                    </TableRow>
                  </TableBody>
                </Table>
              </TableContainer>

              <Typography variant="subtitle1">Â§âÊèõ„Éá„Éº„Çø</Typography>
              <TableContainer component={Paper} sx={{ overflowX:'auto', mb:2 }}>
                <Table size="small">
                  <TableHead>
                    <TableRow>
                      {BASE_FIELDS.map(f=> <TableCell key={f}>{f}</TableCell>)}
                    </TableRow>
                  </TableHead>
                  <TableBody>
                    <TableRow>
                      {BASE_FIELDS.map(f=>{
                        const k = mapping[f];
                        return <TableCell key={f}>{k ? csvSample[k] : ""}</TableCell>;
                      })}
                    </TableRow>
                  </TableBody>
                </Table>
              </TableContainer>

              <Typography variant="subtitle1">„Éâ„É©„ÉÉ„Ç∞ & „Éâ„É≠„ÉÉ„Éó„Åß„Éû„ÉÉ„Éî„É≥„Ç∞</Typography>
              <DragDropContext onDragEnd={onDragEnd}>
                <Grid container spacing={2}>
                  <Grid item xs={12} md={4}>
                    <Typography>Êú™Ââ≤ÂΩì„Éò„ÉÉ„ÉÄ„Éº</Typography>
                    <Droppable droppableId="unassigned">
                      {prov=>(
                        <Box ref={prov.innerRef} {...prov.droppableProps} className="droppableBox">
                          {unassigned.map((h,i)=>(
                            <Draggable key={h} draggableId={h} index={i}>
                              {(provDr,snapshot)=>(
                                <Box
                                  ref={provDr.innerRef}
                                  {...provDr.draggableProps}
                                  {...provDr.dragHandleProps}
                                  className={`draggableItem ${snapshot.isDragging?'draggingItem':''}`}
                                  style={provDr.draggableProps.style}
                                >
                                  {h}
                                </Box>
                              )}
                            </Draggable>
                          ))}
                          {prov.placeholder}
                        </Box>
                      )}
                    </Droppable>
                  </Grid>
                  <Grid item xs={12} md={8}>
                    <Typography>Âü∫Êú¨„É¨„Ç§„Ç¢„Ç¶„Éà</Typography>
                    <Grid container spacing={1}>
                      {BASE_FIELDS.map(fld=>(
                        <Grid item xs={6} key={fld}>
                          <Typography variant="body2">{fld}</Typography>
                          <Droppable droppableId={fld}>
                            {prov=>(
                              <Box ref={prov.innerRef} {...prov.droppableProps} className="droppableBox">
                                {mapping[fld] && (
                                  <Draggable key={mapping[fld]} draggableId={mapping[fld]} index={0}>
                                    {(provDr,snapshot)=>(
                                      <Box
                                        ref={provDr.innerRef}
                                        {...provDr.draggableProps}
                                        {...provDr.dragHandleProps}
                                        className={`draggableItem ${snapshot.isDragging?'draggingItem':''}`}
                                        style={provDr.draggableProps.style}
                                      >
                                        {mapping[fld]}
                                      </Box>
                                    )}
                                  </Draggable>
                                )}
                                {prov.placeholder}
                              </Box>
                            )}
                          </Droppable>
                          <Typography variant="caption">
                            „Çµ„É≥„Éó„É´: {mapping[fld] ? csvSample[mapping[fld]] : "‚Äî"}
                          </Typography>
                        </Grid>
                      ))}
                    </Grid>
                  </Grid>
                </Grid>
              </DragDropContext>
            </Box>
          )}
        </DialogContent>
        <DialogActions>
          <Button onClick={onClose}>Èñâ„Åò„Çã</Button>
        </DialogActions>
        {/* „É°„ÉÉ„Çª„Éº„Ç∏Ë°®Á§∫ */}
        <Dialog open={!!message} onClose={()=>setMessage("")}>
          <DialogTitle>„ÅäÁü•„Çâ„Åõ</DialogTitle>
          <DialogContent>
            <Typography>{message}</Typography>
          </DialogContent>
          <DialogActions>
            <Button onClick={()=>setMessage("")}>OK</Button>
          </DialogActions>
        </Dialog>
        {/* Á¢∫Ë™ç„ÉÄ„Ç§„Ç¢„É≠„Ç∞ */}
        <Dialog open={!!confirm} onClose={()=>setConfirm(null)}>
          <DialogTitle>Á¢∫Ë™ç</DialogTitle>
          <DialogContent>
            <Typography>{confirm?.msg}</Typography>
          </DialogContent>
          <DialogActions>
            <Button onClick={()=>setConfirm(null)}>„Ç≠„É£„É≥„Çª„É´</Button>
            <Button variant="contained" color="primary" onClick={()=>{
              confirm.onOk();
            }}>OK</Button>
          </DialogActions>
        </Dialog>
      </Dialog>
    );
  }

  // ImportDialogÔºàÂÆåÂÖ®ÁâàÔºâ
  function ImportDialog({ open, onClose, onConfirm }) {
    const theme      = useTheme();
    const fullScreen = useMediaQuery(theme.breakpoints.down('sm'));

    const [templates] = React.useState(
      () => JSON.parse(localStorage.getItem(STORAGE_KEY))
    );
    const [tplName,    setTplName]   = React.useState("");
    const [sampleKey,  setSampleKey] = React.useState("");
    const [file,       setFile]      = React.useState(null);
    const [preview,    setPreview]   = React.useState(null);
    const [message, setMessage] = React.useState("");

    // CSV ‚Üí ÂÜÖÈÉ®ÂΩ¢Âºè
    const loadRows = text => {
      const arr = csvTo2D(text);
      const hdr = arr[0] || [];
      const idx = {}; hdr.forEach((h,i)=> idx[h] = i);
      const tpl = templates.find(t=> t.name === tplName);
      if (!tpl) return [];
      return arr.slice(1).map(r=>{
        const obj = {};
        BASE_FIELDS.forEach(f=>{
          const src = tpl.mapping[f];
          obj[f] = (src && idx[src] != null) ? r[idx[src]] : "";
        });
        return obj;
      });
    };

    const handleSample = e => {
      const key = e.target.value;
      setSampleKey(key);
      setFile(null);
      if (!key) return setPreview(null);
      setPreview(loadRows(SAMPLE_CSV[key]));
    };
    const handleFile = e => {
      const f = e.target.files[0];
      if (!f) return;
      setSampleKey(""); setPreview(null); setFile(f);
    };
    const doPreview = () => {
      if (!tplName) {
        setMessage("„Éû„ÉÉ„Éî„É≥„Ç∞„Çø„Ç§„Éó„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ");
        return;
      }
      if (sampleKey) return setPreview(loadRows(SAMPLE_CSV[sampleKey]));
      if (!file) {
        setMessage("„Éï„Ç°„Ç§„É´„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ");
        return;
      }
      const reader = new FileReader();
      reader.onload = ev => setPreview(loadRows(ev.target.result));
      reader.readAsText(file,"utf-8");
    };
    const handleConfirm = () => {
      onConfirm(preview);
    };

    return (
      <Dialog
        fullScreen={fullScreen}
        fullWidth maxWidth="md"
        open={open} onClose={onClose}
      >
        <DialogTitle>„Ç§„É≥„Éù„Éº„Éà</DialogTitle>
        <DialogContent dividers>
          <FormControl fullWidth sx={{ mb:2 }}>
            <InputLabel>„Éû„ÉÉ„Éî„É≥„Ç∞„Çø„Ç§„Éó</InputLabel>
            <Select
              value={tplName}
              label="„Éû„ÉÉ„Éî„É≥„Ç∞„Çø„Ç§„Éó"
              onChange={e=>setTplName(e.target.value)}
            >
              {templates.map(t=>(
                <MenuItem key={t.name} value={t.name}>{t.name}</MenuItem>
              ))}
            </Select>
          </FormControl>
          <FormControl fullWidth sx={{ mb:2 }}>
            <InputLabel>„Éá„É¢„Çµ„É≥„Éó„É´</InputLabel>
            <Select
              value={sampleKey}
              label="„Éá„É¢„Çµ„É≥„Éó„É´"
              onChange={handleSample}
            >
              <MenuItem value="">Ôºà„Éï„Ç°„Ç§„É´„Çí‰Ωø„ÅÜÔºâ</MenuItem>
              {Object.keys(SAMPLE_CSV).map(k=>(
                <MenuItem key={k} value={k}>{k}</MenuItem>
              ))}
            </Select>
          </FormControl>
          <Box mb={2}>
            <input type="file" accept=".csv" onChange={handleFile} />
          </Box>
          <Button variant="contained" onClick={doPreview}>
            „Éó„É¨„Éì„É•„Éº
          </Button>
          <Box mt={3}>
            <Typography variant="subtitle1" gutterBottom>
              ÂèñËæº„Åø„Éó„É¨„Éì„É•„Éº
            </Typography>
            {preview ? (
              <TableContainer component={Paper}
                              sx={{ maxHeight:300, overflow:"auto" }}>
                <Table size="small" stickyHeader>
                  <TableHead>
                    <TableRow>
                      {BASE_FIELDS.map(f=> <TableCell key={f}>{f}</TableCell>)}
                    </TableRow>
                  </TableHead>
                  <TableBody>
                    {preview.map((r,i)=>(
                      <TableRow key={i}>
                        {BASE_FIELDS.map(f=> <TableCell key={f}>{r[f]}</TableCell>)}
                      </TableRow>
                    ))}
                  </TableBody>
                </Table>
              </TableContainer>
            ) : (
              <Typography variant="body2" color="textSecondary">
                „Éó„É¨„Éì„É•„ÉºÁµêÊûú„Åå„Åì„Åì„Å´Ë°®Á§∫„Åï„Çå„Åæ„Åô
              </Typography>
            )}
          </Box>
        </DialogContent>
        <DialogActions>
          {preview && <Button onClick={()=>setPreview(null)}>ÂèñÊ∂à</Button>}
          {preview && <Button variant="contained" onClick={handleConfirm}>Êú¨ÂèñËæº„Åø</Button>}
          <Button onClick={onClose}>Èñâ„Åò„Çã</Button>
        </DialogActions>
        {/* „É°„ÉÉ„Çª„Éº„Ç∏Ë°®Á§∫ */}
        <Dialog open={!!message} onClose={()=>setMessage("")}>
          <DialogTitle>„ÅäÁü•„Çâ„Åõ</DialogTitle>
          <DialogContent>
            <Typography>{message}</Typography>
          </DialogContent>
          <DialogActions>
            <Button onClick={()=>setMessage("")}>OK</Button>
          </DialogActions>
        </Dialog>
      </Dialog>
    );
  }

  // ExportDialog
  function ExportDialog({ open, onClose, onConfirm, rowCount }) {
    const theme      = useTheme();
    const fullScreen = useMediaQuery(theme.breakpoints.down('sm'));
    return (
      <Dialog fullScreen={fullScreen} open={open} onClose={onClose}>
        <DialogTitle>„Ç®„ÇØ„Çπ„Éù„Éº„Éà</DialogTitle>
        <DialogContent dividers>
          <Typography>
            ÁèæÂú®„ÅÆÂü∫Êú¨„ÉÜ„Éº„Éñ„É´„Å´„ÅØ <strong>{rowCount}</strong> Ë°å„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ
          </Typography>
          <Typography>
            CSV „Éï„Ç°„Ç§„É´„Å®„Åó„Å¶„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Åó„Åæ„Åô„ÅãÔºü
          </Typography>
        </DialogContent>
        <DialogActions>
          <Button onClick={onClose}>„Ç≠„É£„É≥„Çª„É´</Button>
          <Button variant="contained" onClick={onConfirm}>„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ</Button>
        </DialogActions>
      </Dialog>
    );
  }

  // HistoryDialog
  function HistoryDialog({ open, onClose, historyList, onRestore, onDelete, onPreview }) {
    const theme      = useTheme();
    const fullScreen = useMediaQuery(theme.breakpoints.down('sm'));
    return (
      <Dialog fullScreen={fullScreen} open={open} onClose={onClose}>
        <DialogTitle>„Ç§„É≥„Éù„Éº„ÉàÂ±•Ê≠¥‰∏ÄË¶ß</DialogTitle>
        <DialogContent dividers>
          {historyList.length === 0 ? (
            <Typography>Â±•Ê≠¥„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ</Typography>
          ) : (
            <TableContainer component={Paper}>
              <Table size="small">
                <TableHead>
                  <TableRow>
                    <TableCell>No.</TableCell>
                    <TableCell>Êó•ÊôÇ</TableCell>
                    <TableCell>ËøΩÂä†Ë°åÊï∞</TableCell>
                    <TableCell align="center">Êìç‰Ωú</TableCell>
                  </TableRow>
                </TableHead>
                <TableBody>
                  {historyList.map((e, idx) => (
                    <TableRow
                      key={e.id}
                      sx={{
                        opacity: e.deleted ? 0.5 : 1,
                        textDecoration: e.deleted ? 'line-through' : 'none',
                        cursor: 'pointer'
                      }}
                      onClick={() => onPreview && onPreview(e.importedData)}
                    >
                      <TableCell>{idx + 1}</TableCell>
                      <TableCell>{e.timestamp.toLocaleString()}</TableCell>
                      <TableCell>{e.importedData ? e.importedData.length : 0}</TableCell>
                      <TableCell align="center" onClick={ev => ev.stopPropagation()}>
                        <Button
                          size="small"
                          disabled={!e.deleted}
                          onClick={()=>onRestore(e.id)}
                        >
                          Âæ©Ê¥ª
                        </Button>
                        <Button
                          size="small"
                          color="error"
                          disabled={e.deleted}
                          onClick={()=>onDelete(e.id)}
                        >
                          ÂâäÈô§
                        </Button>
                      </TableCell>
                    </TableRow>
                  ))}
                </TableBody>
              </Table>
            </TableContainer>
          )}
        </DialogContent>
        <DialogActions>
          <Button onClick={onClose}>Èñâ„Åò„Çã</Button>
        </DialogActions>
      </Dialog>
    );
  }

  ReactDOM.createRoot(document.getElementById("root")).render(<App />);
  </script>
</body>
</html>
