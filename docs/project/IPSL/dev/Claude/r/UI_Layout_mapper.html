<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>CSV マッピング定義・インポート・エクスポート</title>

  <!-- CDN -->
  <script src="https://cdn.jsdelivr.net/npm/react@18/umd/react.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mui/material@5.15.14/umd/material-ui.production.min.js"></script>
  <script src="https://unpkg.com/react-beautiful-dnd@13.1.0/dist/react-beautiful-dnd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.2/babel.min.js"></script>
  <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>

  <!-- Roboto / Icons -->
  <link
    rel="stylesheet"
    href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap"
  />
  <link
    rel="stylesheet"
    href="https://fonts.googleapis.com/icon?family=Material+Icons"
  />

  <style>
    body { margin: 0; padding: 20px; font-family: Roboto, sans-serif; }
    #root { max-width: 1200px; margin: auto; }
    .droppableBox {
      min-height: 40px;
      padding: 8px;
      border: 1px dashed #ccc;
      border-radius: 4px;
      background: #fafafa;
      overflow-x: auto;
    }
    .draggableItem {
      padding: 4px 8px;
      margin-bottom: 4px;
      background: #e0e0e0;
      border-radius: 4px;
      cursor: grab;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const {
      Container, Tabs, Tab, Box, Button, Typography,
      Table, TableHead, TableRow, TableCell, TableBody, TableContainer, Paper,
      useMediaQuery, useTheme, Select, MenuItem, InputLabel, FormControl
    } = MaterialUI;
    const { DragDropContext, Droppable, Draggable } = ReactBeautifulDnd;

    const baseFields = ["商品コード","商品名","数量","価格","日付"];
    const STORAGE_KEY = "csvMappingTemplates";

    function App() {
      const [tab, setTab] = React.useState(0);
      const [mainData, setMainData] = React.useState([]);

      const handleImport = rows => setMainData(prev => [...prev, ...rows]);
      const handleExport = () => {
        if (!mainData.length) {
          alert("エクスポートするデータがありません");
          return;
        }
        const ws = XLSX.utils.json_to_sheet(mainData, { header: baseFields });
        const csv = XLSX.utils.sheet_to_csv(ws);
        const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url; a.download = "base_table.csv"; a.click();
        URL.revokeObjectURL(url);
      };

      return (
        <Container>
          <Tabs
            value={tab}
            onChange={(e, v)=>setTab(v)}
            indicatorColor="primary"
            textColor="primary"
            variant="fullWidth"
            sx={{ mb: 2 }}
          >
            <Tab label="マッピング定義" />
            <Tab label="インポート" />
            <Tab label="エクスポート" />
          </Tabs>

          {tab === 0 && <MappingDefinition />}
          {tab === 1 && <ImportPanel onImport={handleImport} />}
          {tab === 2 && (
            <Box textAlign="center" mt={4}>
              <Button variant="contained" onClick={handleExport}>
                エクスポート
              </Button>
            </Box>
          )}

          {tab !== 2 && mainData.length > 0 && (
            <Box mt={4}>
              <Typography variant="h6" gutterBottom>取り込まれたデータプレビュー</Typography>
              <TableContainer component={Paper} sx={{ overflowX: 'auto' }}>
                <Table size="small">
                  <TableHead>
                    <TableRow>
                      {baseFields.map(f => <TableCell key={f}>{f}</TableCell>)}
                    </TableRow>
                  </TableHead>
                  <TableBody>
                    {mainData.slice(-5).map((row, idx) => (
                      <TableRow key={idx}>
                        {baseFields.map(f => <TableCell key={f}>{row[f]}</TableCell>)}
                      </TableRow>
                    ))}
                  </TableBody>
                </Table>
              </TableContainer>
              <Typography variant="caption">（最新5行を表示）</Typography>
            </Box>
          )}
        </Container>
      );
    }

    function MappingDefinition() {
      const theme = useTheme();
      const fullScreen = useMediaQuery(theme.breakpoints.down('sm'));

      const [templates, setTemplates] = React.useState(() => {
        const data = localStorage.getItem(STORAGE_KEY);
        return data ? JSON.parse(data) : [];
      });
      const [selected, setSelected] = React.useState("");
      const [file, setFile] = React.useState(null);
      const [csvHeaders, setCsvHeaders] = React.useState([]);
      const [csvSample, setCsvSample] = React.useState({});
      const [mapping, setMapping] = React.useState({});
      const [unassigned, setUnassigned] = React.useState([]);

      // 選択テンプレートを変更
      React.useEffect(() => {
        if (!selected) return;
        const tpl = templates.find(t => t.name === selected);
        if (tpl) {
          setMapping(tpl.mapping);
          setUnassigned([]); // CSV読み込み後再設定
        }
      }, [selected]);

      // テンプレート保存
      const saveTemplate = () => {
        if (!selected) return alert("テンプレート名を入力してください");
        const newList = templates.filter(t => t.name !== selected)
          .concat({ name: selected, mapping });
        setTemplates(newList);
        localStorage.setItem(STORAGE_KEY, JSON.stringify(newList));
        alert("テンプレートを保存しました");
      };

      // CSVサンプルロード
      const handleFile = e => {
        const f = e.target.files[0];
        if (!f) return;
        setFile(f);
        const reader = new FileReader();
        reader.onload = ev => {
          const wb = XLSX.read(ev.target.result, { type: 'binary' });
          const ws = wb.Sheets[wb.SheetNames[0]];
          const arr = XLSX.utils.sheet_to_json(ws, { header: 1, defval: "" });
          const [hdr, sample] = arr;
          setCsvHeaders(hdr);
          const sampleObj = {};
          hdr.forEach((h,i) => sampleObj[h] = sample[i]);
          setCsvSample(sampleObj);
          // 初期マッピング
          const init = {};
          baseFields.forEach(f => init[f] = null);
          setMapping(init);
          setUnassigned([...hdr]);
        };
        reader.readAsBinaryString(f);
      };

      const onDragEnd = result => {
        const { source, destination, draggableId } = result;
        if (!destination) return;
        const src = source.droppableId, dst = destination.droppableId;
        // アンアサイン間移動
        if (src==='unassigned' && dst==='unassigned') {
          const items = Array.from(unassigned);
          items.splice(source.index,1);
          items.splice(destination.index,0,draggableId);
          setUnassigned(items);
          return;
        }
        // 割当
        if (src==='unassigned' && baseFields.includes(dst)) {
          const prev = mapping[dst];
          const newUn = unassigned.filter(h=>h!==draggableId);
          if (prev) newUn.push(prev);
          setUnassigned(newUn);
          setMapping({...mapping,[dst]:draggableId});
          return;
        }
        // 解除
        if (baseFields.includes(src) && dst==='unassigned') {
          const hdr = mapping[src];
          if (!hdr) return;
          const newUn2 = Array.from(unassigned);
          newUn2.splice(destination.index,0,hdr);
          setUnassigned(newUn2);
          setMapping({...mapping,[src]:null});
          return;
        }
        // 交換
        if (baseFields.includes(src) && baseFields.includes(dst)) {
          const a = mapping[src], b = mapping[dst];
          setMapping({...mapping,[src]:b,[dst]:a});
        }
      };

      return (
        <Box>
          <Box mb={2}>
            <FormControl fullWidth>
              <InputLabel>テンプレート名</InputLabel>
              <Select
                value={selected}
                onChange={e=> setSelected(e.target.value)}
                label="テンプレート名"
                freeSolo
              >
                {templates.map(t => (
                  <MenuItem key={t.name} value={t.name}>{t.name}</MenuItem>
                ))}
              </Select>
            </FormControl>
            <Button sx={{ mt:1 }} onClick={() => {
              const n = prompt("新しいテンプレート名を入力");
              if (n) setSelected(n);
            }}>＋ 新規</Button>
            <Button sx={{ mt:1, ml:1 }} color="error"
              onClick={() => {
                if (!selected) return;
                if (confirm("削除しますか？")) {
                  const list = templates.filter(t=>t.name!==selected);
                  setTemplates(list);
                  localStorage.setItem(STORAGE_KEY, JSON.stringify(list));
                  setSelected("");
                }
              }}
            >🗑️ 削除</Button>
          </Box>

          <Box mb={2}>
            <Typography variant="subtitle1"><strong>サンプルCSVを選択し、マッピングを定義</strong></Typography>
            <input type="file" accept=".csv" onChange={handleFile} />
          </Box>

          {csvHeaders.length > 0 && (
            <DragDropContext onDragEnd={onDragEnd}>
              <Grid container spacing={2}>
                <Grid item xs={12} sm={4}>
                  <Typography>未割当ヘッダー</Typography>
                  <Droppable droppableId="unassigned">
                    {prov=>(
                      <Box ref={prov.innerRef} {...prov.droppableProps} className="droppableBox">
                        {unassigned.map((h,i)=>(
                          <Draggable key={h} draggableId={h} index={i}>
                            {p=>(
                              <Box
                                ref={p.innerRef}
                                {...p.draggableProps}
                                {...p.dragHandleProps}
                                className="draggableItem"
                              >{h}</Box>
                            )}
                          </Draggable>
                        ))}
                        {prov.placeholder}
                      </Box>
                    )}
                  </Droppable>
                </Grid>
                <Grid item xs={12} sm={8}>
                  <Typography>基本フィールド割当先</Typography>
                  <Grid container spacing={1}>
                    {baseFields.map(fld=>(
                      <Grid item xs={6} key={fld}>
                        <Typography variant="body2">{fld}</Typography>
                        <Droppable droppableId={fld}>
                          {prov=>(
                            <Box ref={prov.innerRef} {...prov.droppableProps} className="droppableBox">
                              {mapping[fld] && (
                                <Draggable draggableId={mapping[fld]} index={0} key={mapping[fld]}>
                                  {p=>(
                                    <Box
                                      ref={p.innerRef}
                                      {...p.draggableProps}
                                      {...p.dragHandleProps}
                                      className="draggableItem"
                                    >{mapping[fld]}</Box>
                                  )}
                                </Draggable>
                              )}
                              {prov.placeholder}
                            </Box>
                          )}
                        </Droppable>
                        <Typography variant="caption">
                          サンプル: {mapping[fld] ? csvSample[mapping[fld]] : '—'}
                        </Typography>
                      </Grid>
                    ))}
                  </Grid>
                </Grid>
              </Grid>
              <Box mt={2}>
                <Button variant="contained" onClick={saveTemplate}>マッピング保存</Button>
              </Box>
            </DragDropContext>
          )}
        </Box>
      );
    }

    function ImportPanel({ onImport }) {
      const [templates, setTemplates] = React.useState(() => {
        const data = localStorage.getItem(STORAGE_KEY);
        return data ? JSON.parse(data) : [];
      });
      const [selectedTpl, setSelectedTpl] = React.useState("");
      const [file, setFile] = React.useState(null);
      const [staging, setStaging] = React.useState(null);

      const handleFile = e => {
        const f = e.target.files[0];
        if (!f) return setFile(null);
        setFile(f);
      };

      const handlePreview = () => {
        if (!selectedTpl) return alert("マッピングタイプを選択してください");
        if (!file) return alert("ファイルを選択してください");
        const tpl = templates.find(t=>t.name===selectedTpl);
        const reader = new FileReader();
        reader.onload = ev => {
          const wb = XLSX.read(ev.target.result, { type:'binary' });
          const ws = wb.Sheets[wb.SheetNames[0]];
          const json = XLSX.utils.sheet_to_json(ws, { header: tpl.mapping, range:1, defval:"" });
          const conv = json.map(row => {
            const out = {};
            baseFields.forEach(f => out[f] = row[f] || "");
            return out;
          });
          setStaging(conv);
        };
        reader.readAsBinaryString(file);
      };

      const handleConfirm = () => {
        onImport(staging);
        setStaging(null);
        setFile(null);
      };

      return (
        <Box>
          <Box mb={2}>
            <FormControl fullWidth>
              <InputLabel>マッピングタイプ</InputLabel>
              <Select
                value={selectedTpl}
                onChange={e=>setSelectedTpl(e.target.value)}
                label="マッピングタイプ"
              >
                {templates.map(t=>(
                  <MenuItem key={t.name} value={t.name}>{t.name}</MenuItem>
                ))}
              </Select>
            </FormControl>
          </Box>
          <Box mb={2}>
            <input type="file" accept=".csv" onChange={handleFile} />
          </Box>
          <Box mb={2}>
            <Button variant="contained" onClick={handlePreview}>プレビュー</Button>
          </Box>
          {staging && (
            <Box>
              <Typography variant="subtitle1" gutterBottom>取込みプレビュー</Typography>
              <TableContainer component={Paper} sx={{ maxHeight:300, overflow:'auto' }}>
                <Table size="small" stickyHeader>
                  <TableHead>
                    <TableRow>
                      {baseFields.map(f=> <TableCell key={f}>{f}</TableCell>)}
                    </TableRow>
                  </TableHead>
                  <TableBody>
                    {staging.map((row,i)=>(
                      <TableRow key={i}>
                        {baseFields.map(f=> <TableCell key={f}>{row[f]}</TableCell>)}
                      </TableRow>
                    ))}
                  </TableBody>
                </Table>
              </TableContainer>
              <Box mt={2}>
                <Button onClick={()=>setStaging(null)}>取消</Button>
                <Button variant="contained" onClick={handleConfirm} sx={{ ml:1 }}>
                  本取込み
                </Button>
              </Box>
            </Box>
          )}
        </Box>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>