<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>CSV 管理ツール</title>
  <!-- React / MUI / DnD / XLSX CDN -->
  <script src="https://cdn.jsdelivr.net/npm/react@18/umd/react.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mui/material@5.15.14/umd/material-ui.production.min.js"></script>
  <script src="https://unpkg.com/react-beautiful-dnd@13.1.0/dist/react-beautiful-dnd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.2/babel.min.js"></script>
  <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
  <!-- Roboto / Icons -->
  <link rel="stylesheet"
        href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap" />
  <link rel="stylesheet"
        href="https://fonts.googleapis.com/icon?family=Material+Icons" />
  <style>
    body { margin: 0; padding: 16px; font-family: Roboto, sans-serif; }
    #root { max-width: 1200px; margin: auto; }
    .droppableBox {
      min-height: 44px; padding: 8px;
      border: 1px dashed #ccc; border-radius: 4px;
      background: #fafafa; overflow-x: auto;
    }
    .draggableItem {
      padding: 4px 8px; margin-bottom: 4px;
      background: #e0e0e0; border-radius: 4px;
      cursor: grab; user-select: none;
    }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
  const {
    Container, Box, Button, Typography, Table, TableHead,
    TableRow, TableCell, TableBody, TableContainer, Paper,
    Dialog, DialogTitle, DialogContent, DialogActions,
    Grid, TextField, FormControl, InputLabel, Select, MenuItem,
    useTheme, useMediaQuery
  } = MaterialUI;
  const { DragDropContext, Droppable, Draggable } = ReactBeautifulDnd;

  const BASE_FIELDS = ["商品コード","商品名","数量","価格","日付"];
  const STORAGE_KEY = "csvMappingTemplates_v1_demo";
  const SAMPLE_CSV = {
    "日本語ヘッダー": `商品コード,商品名,数量,価格,日付
A001,りんご,10,120,2025-05-01`,
    "Englishヘッダー": `code,name,qty,price,date
B001,Apple,15,110,2025-05-03`,
    "ランダム順": `price,date,itemCode,itemName,quantity
200,2025-05-05,C001,オレンジ,12`
  };
  const DEFAULT_TEMPLATES = [
    { name: "JapaneseHeader", mapping: {
      "商品コード":"商品コード","商品名":"商品名","数量":"数量","価格":"価格","日付":"日付" } },
    { name: "EnglishHeader", mapping: {
      "商品コード":"code","商品名":"name","数量":"qty","価格":"price","日付":"date" } },
    { name: "ShuffledHeader", mapping: {
      "商品コード":"itemCode","商品名":"itemName","数量":"quantity","価格":"price","日付":"date" } }
  ];
  if (!localStorage.getItem(STORAGE_KEY)) {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(DEFAULT_TEMPLATES));
  }
  function csvTo2D(text) {
    const wb = XLSX.read(text, { type: "string" });
    const ws = wb.Sheets[wb.SheetNames[0]];
    return XLSX.utils.sheet_to_json(ws, { header:1, defval:"" });
  }

  function App() {
    const [mainData, setMainData] = React.useState([]);
    const [openMapping, setOpenMapping] = React.useState(false);
    const [openImport, setOpenImport] = React.useState(false);
    const [openExport, setOpenExport] = React.useState(false);

    const handleImported = rows => {
      setMainData(prev => [...prev, ...rows]);
      setOpenImport(false);
    };
    const handleExportConfirm = () => {
      if (!mainData.length) { alert("エクスポート対象がありません"); return; }
      const ws  = XLSX.utils.json_to_sheet(mainData, { header: BASE_FIELDS });
      const csv = XLSX.utils.sheet_to_csv(ws);
      const blob= new Blob([csv], { type:"text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a   = document.createElement("a");
      a.href = url; a.download = "base_table.csv"; a.click();
      URL.revokeObjectURL(url);
      setOpenExport(false);
    };

    return (
      <Container maxWidth="lg">
        <Box mb={2} display="flex" flexWrap="wrap" gap={1}>
          <Button variant="outlined" onClick={()=>setOpenMapping(true)}>
            マッピング定義
          </Button>
          <Button variant="outlined" onClick={()=>setOpenImport(true)}>
            インポート
          </Button>
          <Button variant="outlined" onClick={()=>setOpenExport(true)}>
            エクスポート
          </Button>
        </Box>

        <TableContainer component={Paper} sx={{ overflowX:'auto' }}>
          <Table size="small">
            <TableHead>
              <TableRow>
                {BASE_FIELDS.map(f => <TableCell key={f}>{f}</TableCell>)}
              </TableRow>
            </TableHead>
            <TableBody>
              {mainData.length > 0 ? mainData.map((row,i)=>(
                <TableRow key={i}>
                  {BASE_FIELDS.map(f=> <TableCell key={f}>{row[f]}</TableCell>)}
                </TableRow>
              )) : (
                <TableRow>
                  <TableCell colSpan={BASE_FIELDS.length} align="center">
                    データがありません
                  </TableCell>
                </TableRow>
              )}
            </TableBody>
          </Table>
        </TableContainer>

        <MappingDialog
          open={openMapping}
          onClose={()=>setOpenMapping(false)}
        />
        <ImportDialog
          open={openImport}
          onClose={()=>setOpenImport(false)}
          onConfirm={handleImported}
        />
        <ExportDialog
          open={openExport}
          onClose={()=>setOpenExport(false)}
          onConfirm={handleExportConfirm}
          rowCount={mainData.length}
        />
      </Container>
    );
  }

  function MappingDialog({ open, onClose }) {
    const theme = useTheme();
    const fullScreen = useMediaQuery(theme.breakpoints.down('sm'));

    const [templates, setTemplates] = React.useState(
      () => JSON.parse(localStorage.getItem(STORAGE_KEY))
    );
    const [tplName, setTplName] = React.useState("");
    const [csvHeaders, setCsvHeaders] = React.useState([]);
    const [csvSample, setCsvSample] = React.useState({});
    const [mapping, setMapping] = React.useState({});
    const [unassigned, setUnassigned] = React.useState([]);
    const [sampleKey, setSampleKey] = React.useState("");

    const initPreview = arr => {
      const hdr = arr[0]||[];
      const sample = {}; hdr.forEach((h,i)=> sample[h] = (arr[1]||[])[i]||"");
      setCsvHeaders(hdr); setCsvSample(sample);
      const init = {}; BASE_FIELDS.forEach(f=> init[f]=null);
      setMapping(init); setUnassigned(hdr);
    };

    const handleSample = key => {
      setSampleKey(key); setCsvHeaders([]); setMapping({}); setUnassigned([]);
      if (!key) return;
      initPreview(csvTo2D(SAMPLE_CSV[key]));
    };
    const handleFile = e => {
      const f = e.target.files[0]; if(!f) return;
      setSampleKey("");
      const reader = new FileReader();
      reader.onload = ev => initPreview(csvTo2D(ev.target.result));
      reader.readAsText(f,"utf-8");
    };

    const onDragEnd = res => {
      const { source, destination, draggableId } = res;
      if (!destination) return;
      const src = source.droppableId, dst = destination.droppableId;
      if (src==="unassigned" && dst==="unassigned") {
        const items=[...unassigned];
        items.splice(source.index,1); items.splice(destination.index,0,draggableId);
        setUnassigned(items); return;
      }
      if (src==="unassigned" && BASE_FIELDS.includes(dst)) {
        const prev = mapping[dst];
        const nextUn = unassigned.filter(h=>h!==draggableId);
        if (prev) nextUn.push(prev);
        setUnassigned(nextUn);
        setMapping({...mapping,[dst]:draggableId});
        return;
      }
      if (BASE_FIELDS.includes(src) && dst==="unassigned") {
        const hdr = mapping[src]; if(!hdr) return;
        const nextUn=[...unassigned];
        nextUn.splice(destination.index,0,hdr);
        setUnassigned(nextUn);
        setMapping({...mapping,[src]:null});
        return;
      }
      if (BASE_FIELDS.includes(src) && BASE_FIELDS.includes(dst)) {
        const a = mapping[src], b = mapping[dst];
        setMapping({...mapping,[src]:b,[dst]:a});
      }
    };

    const saveTpl = () => {
      if (!tplName) { alert("テンプレート名を入力してください"); return; }
      const next = templates.filter(t=>t.name!==tplName)
        .concat({ name:tplName, mapping });
      setTemplates(next);
      localStorage.setItem(STORAGE_KEY, JSON.stringify(next));
      alert("保存しました");
    };
    const deleteTpl = () => {
      if (!tplName) return;
      if (!confirm("削除しますか？")) return;
      const next = templates.filter(t=>t.name!==tplName);
      setTemplates(next);
      localStorage.setItem(STORAGE_KEY, JSON.stringify(next));
      setTplName(""); setCsvHeaders([]); setMapping({}); setUnassigned([]); setSampleKey("");
    };

    return (
      <Dialog
        fullScreen={fullScreen}
        fullWidth
        maxWidth="lg"
        open={open}
        onClose={onClose}
      >
        <DialogTitle>マッピング定義</DialogTitle>
        <DialogContent dividers>
          <Grid container spacing={2}>
            <Grid item xs={12} md={5}>
              <TextField
                label="テンプレート名"
                value={tplName}
                onChange={e=>setTplName(e.target.value)}
                fullWidth
              />
            </Grid>
            <Grid item xs={12} md={7} container alignItems="center" spacing={1}>
              <Grid item><Button onClick={()=>{
                const n=prompt("新しいテンプレート名"); if(n) setTplName(n);
              }}>＋ 新規</Button></Grid>
              <Grid item><Button color="error" onClick={deleteTpl}>🗑️ 削除</Button></Grid>
              <Grid item><Button variant="contained" onClick={saveTpl}>保存</Button></Grid>
            </Grid>
          </Grid>

          <Box mt={3}>
            <FormControl fullWidth>
              <InputLabel>デモサンプル</InputLabel>
              <Select
                value={sampleKey}
                label="デモサンプル"
                onChange={e=>handleSample(e.target.value)}
              >
                <MenuItem value="">（ファイルを使用）</MenuItem>
                {Object.keys(SAMPLE_CSV).map(k=>
                  <MenuItem key={k} value={k}>{k}</MenuItem>
                )}
              </Select>
            </FormControl>
            <Box mt={2}>
              <input type="file" accept=".csv" onChange={handleFile} />
            </Box>
          </Box>

          {csvHeaders.length > 0 && (
            <Box mt={3}>
              <Typography variant="subtitle1">ヘッダー & サンプル</Typography>
              <TableContainer component={Paper} sx={{ overflowX:'auto', mb:2 }}>
                <Table size="small">
                  <TableHead>
                    <TableRow>
                      {csvHeaders.map(h=> <TableCell key={h}>{h}</TableCell>)}
                    </TableRow>
                  </TableHead>
                  <TableBody>
                    <TableRow>
                      {csvHeaders.map(h=> <TableCell key={h}>{csvSample[h]}</TableCell>)}
                    </TableRow>
                  </TableBody>
                </Table>
              </TableContainer>

              <Typography variant="subtitle1">変換データ</Typography>
              <TableContainer component={Paper} sx={{ overflowX:'auto', mb:2 }}>
                <Table size="small">
                  <TableHead>
                    <TableRow>
                      {BASE_FIELDS.map(f=> <TableCell key={f}>{f}</TableCell>)}
                    </TableRow>
                  </TableHead>
                  <TableBody>
                    <TableRow>
                      {BASE_FIELDS.map(f=> {
                        const k = mapping[f];
                        return <TableCell key={f}>{k ? csvSample[k] : ""}</TableCell>;
                      })}
                    </TableRow>
                  </TableBody>
                </Table>
              </TableContainer>

              <Typography variant="subtitle1">ドラッグ & ドロップでマッピング</Typography>
              <DragDropContext onDragEnd={onDragEnd}>
                <Grid container spacing={2}>
                  <Grid item xs={12} md={4}>
                    <Typography>未割当ヘッダー</Typography>
                    <Droppable droppableId="unassigned">
                      {prov=>(
                        <Box ref={prov.innerRef} {...prov.droppableProps} className="droppableBox">
                          {unassigned.map((h,i)=>(
                            <Draggable key={h} draggableId={h} index={i}>
                              {p=>(
                                <Box
                                  ref={p.innerRef}
                                  {...p.draggableProps}
                                  {...p.dragHandleProps}
                                  className="draggableItem"
                                >{h}</Box>
                              )}
                            </Draggable>
                          ))}
                          {prov.placeholder}
                        </Box>
                      )}
                    </Droppable>
                  </Grid>
                  <Grid item xs={12} md={8}>
                    <Typography>基本レイアウト</Typography>
                    <Grid container spacing={1}>
                      {BASE_FIELDS.map(fld=>(
                        <Grid item xs={6} key={fld}>
                          <Typography variant="body2">{fld}</Typography>
                          <Droppable droppableId={fld}>
                            {prov=>(
                              <Box ref={prov.innerRef} {...prov.droppableProps} className="droppableBox">
                                {mapping[fld] && (
                                  <Draggable
                                    key={mapping[fld]}
                                    draggableId={mapping[fld]}
                                    index={0}
                                  >
                                    {p=>(
                                      <Box
                                        ref={p.innerRef}
                                        {...p.draggableProps}
                                        {...p.dragHandleProps}
                                        className="draggableItem"
                                      >{mapping[fld]}</Box>
                                    )}
                                  </Draggable>
                                )}
                                {prov.placeholder}
                              </Box>
                            )}
                          </Droppable>
                          <Typography variant="caption">
                            サンプル: {mapping[fld] ? csvSample[mapping[fld]] : "—"}
                          </Typography>
                        </Grid>
                      ))}
                    </Grid>
                  </Grid>
                </Grid>
              </DragDropContext>
            </Box>
          )}
        </DialogContent>
        <DialogActions>
          <Button onClick={onClose}>閉じる</Button>
        </DialogActions>
      </Dialog>
    );
  }

  function ImportDialog({ open, onClose, onConfirm }) {
    const theme = useTheme();
    const fullScreen = useMediaQuery(theme.breakpoints.down('sm'));

    const [templates] = React.useState(
      () => JSON.parse(localStorage.getItem(STORAGE_KEY))
    );
    const [tplName, setTplName] = React.useState("");
    const [sampleKey, setSampleKey] = React.useState("");
    const [file, setFile] = React.useState(null);
    const [preview, setPreview] = React.useState(null);

    const loadRows = text => {
      const arr = csvTo2D(text);
      const hdr = arr[0]||[], idx = {};
      hdr.forEach((h,i)=>idx[h]=i);
      const tpl = templates.find(t=>t.name===tplName);
      if(!tpl) return [];
      return arr.slice(1).map(r=>{
        const out = {};
        BASE_FIELDS.forEach(f=>{
          const src = tpl.mapping[f];
          out[f] = src && idx[src]!=null ? r[idx[src]] : "";
        });
        return out;
      });
    };

    const handleSample = e => {
      const key = e.target.value;
      setSampleKey(key); setFile(null);
      if(!key) return setPreview(null);
      setPreview(loadRows(SAMPLE_CSV[key]));
    };
    const handleFile = e => {
      const f = e.target.files[0];
      if(!f) return;
      setSampleKey(""); setPreview(null); setFile(f);
    };
    const doPreview = () => {
      if(!tplName) { alert("マッピングタイプを選択してください"); return; }
      if(sampleKey) return setPreview(loadRows(SAMPLE_CSV[sampleKey]));
      if(!file) { alert("ファイルを選択してください"); return; }
      const reader = new FileReader();
      reader.onload = ev => setPreview(loadRows(ev.target.result));
      reader.readAsText(file,"utf-8");
    };
    const handleConfirm = () => {
      onConfirm(preview);
    };

    return (
      <Dialog
        fullScreen={fullScreen}
        fullWidth
        maxWidth="md"
        open={open}
        onClose={onClose}
      >
        <DialogTitle>インポート</DialogTitle>
        <DialogContent dividers>
          <FormControl fullWidth sx={{ mb:2 }}>
            <InputLabel>マッピングタイプ</InputLabel>
            <Select
              value={tplName}
              label="マッピングタイプ"
              onChange={e=>setTplName(e.target.value)}
            >
              {templates.map(t=>(
                <MenuItem key={t.name} value={t.name}>{t.name}</MenuItem>
              ))}
            </Select>
          </FormControl>

          <FormControl fullWidth sx={{ mb:2 }}>
            <InputLabel>デモサンプル</InputLabel>
            <Select
              value={sampleKey}
              label="デモサンプル"
              onChange={handleSample}
            >
              <MenuItem value="">（ファイルを使う）</MenuItem>
              {Object.keys(SAMPLE_CSV).map(k=>(
                <MenuItem key={k} value={k}>{k}</MenuItem>
              ))}
            </Select>
          </FormControl>

          <Box mb={2}>
            <input type="file" accept=".csv" onChange={handleFile} />
          </Box>

          <Button variant="contained" onClick={doPreview}>
            プレビュー
          </Button>

          <Box mt={3}>
            <Typography variant="subtitle1" gutterBottom>
              取込みプレビュー
            </Typography>
            {preview ? (
              <TableContainer component={Paper} sx={{ maxHeight:300, overflow:"auto" }}>
                <Table size="small" stickyHeader>
                  <TableHead>
                    <TableRow>
                      {BASE_FIELDS.map(f=> <TableCell key={f}>{f}</TableCell>)}
                    </TableRow>
                  </TableHead>
                  <TableBody>
                    {preview.map((r,i)=>(
                      <TableRow key={i}>
                        {BASE_FIELDS.map(f=> <TableCell key={f}>{r[f]}</TableCell>)}
                      </TableRow>
                    ))}
                  </TableBody>
                </Table>
              </TableContainer>
            ) : (
              <Typography variant="body2" color="textSecondary">
                プレビュー結果がここに表示されます
              </Typography>
            )}
          </Box>
        </DialogContent>
        <DialogActions>
          {preview && (
            <Button onClick={()=>{ setPreview(null); }}>取消</Button>
          )}
          {preview && (
            <Button variant="contained" onClick={handleConfirm}>
              本取込み
            </Button>
          )}
          <Button onClick={onClose}>閉じる</Button>
        </DialogActions>
      </Dialog>
    );
  }

  function ExportDialog({ open, onClose, onConfirm, rowCount }) {
    const theme = useTheme();
    const fullScreen = useMediaQuery(theme.breakpoints.down('sm'));
    return (
      <Dialog
        fullScreen={fullScreen}
        open={open}
        onClose={onClose}
      >
        <DialogTitle>エクスポート</DialogTitle>
        <DialogContent dividers>
          <Typography>
            現在の基本テーブルには <strong>{rowCount}</strong> 行があります。
          </Typography>
          <Typography>CSV ファイルとしてダウンロードしますか？</Typography>
        </DialogContent>
        <DialogActions>
          <Button onClick={onClose}>キャンセル</Button>
          <Button variant="contained" onClick={onConfirm}>ダウンロード</Button>
        </DialogActions>
      </Dialog>
    );
  }

  ReactDOM.createRoot(document.getElementById("root")).render(<App />);
  </script>
</body>
</html>