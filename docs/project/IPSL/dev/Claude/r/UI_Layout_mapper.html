<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<title>ãƒãƒƒãƒ”ãƒ³ã‚°å®šç¾©ãƒ»ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ»ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼ˆãƒ‡ãƒ¢ç”¨ã‚µãƒ³ãƒ—ãƒ«ä»˜ãï¼‰</title>

<!-- ===== CDN ===== -->
<script src="https://cdn.jsdelivr.net/npm/react@18/umd/react.production.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mui/material@5.15.14/umd/material-ui.production.min.js"></script>
<script src="https://unpkg.com/react-beautiful-dnd@13.1.0/dist/react-beautiful-dnd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.2/babel.min.js"></script>
<script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>

<!-- Roboto / Icons -->
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap"/>
<link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons"/>

<style>
body{margin:0;padding:16px;font-family:Roboto,sans-serif}
#root{max-width:1200px;margin:auto}
.droppableBox{min-height:44px;padding:8px;border:1px dashed #ccc;border-radius:4px;background:#fafafa;overflow-x:auto}
.draggableItem{padding:4px 8px;margin-bottom:4px;background:#e0e0e0;border-radius:4px;cursor:grab;user-select:none}
</style>
</head>
<body>
<div id="root"></div>

<script type="text/babel">
const {
  Container,Tabs,Tab,Box,Button,Typography,Grid,TextField,
  Table,TableHead,TableRow,TableCell,TableBody,TableContainer,Paper,
  useTheme,useMediaQuery,MenuItem,Select,FormControl,InputLabel
}=MaterialUI;
const {DragDropContext,Droppable,Draggable}=ReactBeautifulDnd;

/* ---------- å®šæ•° ---------- */
const BASE_FIELDS=["å•†å“ã‚³ãƒ¼ãƒ‰","å•†å“å","æ•°é‡","ä¾¡æ ¼","æ—¥ä»˜"];
const STORAGE_KEY="csvMappingTemplates_v1_demo";

/* ãƒ‡ãƒ¢ç”¨ã‚µãƒ³ãƒ—ãƒ« CSV ------------- */
const SAMPLE_CSV={
  "æ—¥æœ¬èªãƒ˜ãƒƒãƒ€ãƒ¼":`å•†å“ã‚³ãƒ¼ãƒ‰,å•†å“å,æ•°é‡,ä¾¡æ ¼,æ—¥ä»˜
A001,ã‚Šã‚“ã”,10,120,2025-05-01
A002,ãƒãƒŠãƒŠ,5,80,2025-05-02`,
  "Englishãƒ˜ãƒƒãƒ€ãƒ¼":`code,name,qty,price,date
B001,Apple,15,110,2025-05-03
B002,Banana,8,90,2025-05-04`,
  "ãƒ©ãƒ³ãƒ€ãƒ é †":`price,date,itemCode,itemName,quantity
200,2025-05-05,C001,ã‚ªãƒ¬ãƒ³ã‚¸,12
250,2025-05-06,C002,ãƒ¡ãƒ­ãƒ³,4`
};

/* ã‚µãƒ³ãƒ—ãƒ«ã«å¯¾å¿œã™ã‚‹æ—¢å®šãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ ----- */
const DEFAULT_TEMPLATES=[
  {name:"JapaneseHeader",mapping:{
    "å•†å“ã‚³ãƒ¼ãƒ‰":"å•†å“ã‚³ãƒ¼ãƒ‰","å•†å“å":"å•†å“å","æ•°é‡":"æ•°é‡","ä¾¡æ ¼":"ä¾¡æ ¼","æ—¥ä»˜":"æ—¥ä»˜"}},
  {name:"EnglishHeader",mapping:{
    "å•†å“ã‚³ãƒ¼ãƒ‰":"code","å•†å“å":"name","æ•°é‡":"qty","ä¾¡æ ¼":"price","æ—¥ä»˜":"date"}},
  {name:"ShuffledHeader",mapping:{
    "å•†å“ã‚³ãƒ¼ãƒ‰":"itemCode","å•†å“å":"itemName","æ•°é‡":"quantity","ä¾¡æ ¼":"price","æ—¥ä»˜":"date"}}
];

/* åˆå›ãƒ­ãƒ¼ãƒ‰æ™‚ã«æ—¢å®šãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ä¿å­˜ */
if(!localStorage.getItem(STORAGE_KEY)){
  localStorage.setItem(STORAGE_KEY,JSON.stringify(DEFAULT_TEMPLATES));
}

/* ---------- ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ï¼šCSVæ–‡å­—åˆ—â†’2Dé…åˆ— ---------- */
function csvTo2D(csvText){
  const wb=XLSX.read(csvText,{type:"string"});
  const ws=wb.Sheets[wb.SheetNames[0]];
  return XLSX.utils.sheet_to_json(ws,{header:1,defval:""});
}

/* ---------- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ ---------- */
function App(){
  const [tab,setTab]=React.useState(0);
  const [mainData,setMainData]=React.useState([]);

  const handleImport=rows=>setMainData(prev=>[...prev,...rows]);
  const handleExport=()=>{
    if(!mainData.length){alert("ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå¯¾è±¡ãŒã‚ã‚Šã¾ã›ã‚“");return;}
    const ws=XLSX.utils.json_to_sheet(mainData,{header:BASE_FIELDS});
    const csv=XLSX.utils.sheet_to_csv(ws);
    const blob=new Blob([csv],{type:"text/csv;charset=utf-8;"});
    const url=URL.createObjectURL(blob);
    const a=document.createElement("a");a.href=url;a.download="base_table.csv";a.click();
    URL.revokeObjectURL(url);
  };

  return(
    <Container maxWidth="lg">
      <Tabs value={tab} onChange={(e,v)=>setTab(v)} variant="fullWidth" sx={{mb:2}}>
        <Tab label="ãƒãƒƒãƒ”ãƒ³ã‚°å®šç¾©"/>
        <Tab label="ã‚¤ãƒ³ãƒãƒ¼ãƒˆ"/>
        <Tab label="ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ"/>
      </Tabs>

      {tab===0&&<MappingDefinition/>}
      {tab===1&&<ImportPanel onImport={handleImport}/>}
      {tab===2&&(
        <Box textAlign="center" mt={4}>
          <Button variant="contained" onClick={handleExport}>CSV ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</Button>
        </Box>
      )}

      {mainData.length>0&&tab!==2&&(
        <Box mt={4}>
          <Typography variant="h6" gutterBottom>æœ€æ–° 5 è¡Œãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</Typography>
          <TableContainer component={Paper} sx={{overflowX:"auto"}}>
            <Table size="small">
              <TableHead><TableRow>{BASE_FIELDS.map(f=><TableCell key={f}>{f}</TableCell>)}</TableRow></TableHead>
              <TableBody>
                {mainData.slice(-5).map((r,i)=>(
                  <TableRow key={i}>
                    {BASE_FIELDS.map(f=><TableCell key={f}>{r[f]}</TableCell>)}
                  </TableRow>
                ))}
              </TableBody>
            </Table>
          </TableContainer>
        </Box>
      )}
    </Container>
  );
}

/* ---------- 1. ãƒãƒƒãƒ”ãƒ³ã‚°å®šç¾©ã‚¿ãƒ– ---------- */
function MappingDefinition(){
  const [templates,setTemplates]=React.useState(()=>JSON.parse(localStorage.getItem(STORAGE_KEY)));
  const [tplName,setTplName]=React.useState("");
  const [csvHeaders,setCsvHeaders]=React.useState([]);
  const [csvSample,setCsvSample]=React.useState({});
  const [mapping,setMapping]=React.useState({});
  const [unassigned,setUnassigned]=React.useState([]);
  const [sampleKey,setSampleKey]=React.useState("");

  const createNew=()=>{
    const n=prompt("ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå");
    if(n) setTplName(n);
  };
  const saveTpl=()=>{
    if(!tplName){alert("ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆåã‚’å…¥åŠ›");return;}
    const next=templates.filter(t=>t.name!==tplName).concat({name:tplName,mapping});
    setTemplates(next);localStorage.setItem(STORAGE_KEY,JSON.stringify(next));
    alert("ä¿å­˜ã—ã¾ã—ãŸ");
  };
  const delTpl=()=>{
    if(!tplName)return;
    if(!confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ"))return;
    const next=templates.filter(t=>t.name!==tplName);
    setTemplates(next);localStorage.setItem(STORAGE_KEY,JSON.stringify(next));
    setTplName("");setMapping({});setCsvHeaders([]);setUnassigned([]);setSampleKey("");
  };

  /* ã‚µãƒ³ãƒ—ãƒ«èª­ã¿è¾¼ã¿ã¾ãŸã¯ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿å…±é€š */
  const loadPreview=(arr)=>{
    const headers=arr[0]||[];
    const sample={};headers.forEach((h,i)=>sample[h]=(arr[1]||[])[i]||"");
    setCsvHeaders(headers);setCsvSample(sample);
    const baseInit={};BASE_FIELDS.forEach(f=>baseInit[f]=null);
    const used=[]; // none initially
    setMapping(baseInit);
    setUnassigned(headers.filter(h=>!used.includes(h)));
  };

  const handleSampleChange=(key)=>{
    setSampleKey(key);
    if(!key){setCsvHeaders([]);return;}
    const arr=csvTo2D(SAMPLE_CSV[key]);
    loadPreview(arr);
  };
  const handleFile=e=>{
    const f=e.target.files[0];if(!f)return;
    setSampleKey("");
    const reader=new FileReader();
    reader.onload=ev=>loadPreview(csvTo2D(ev.target.result));
    reader.readAsText(f,"utf-8");
  };

  /* DnD */
  const onDragEnd=res=>{
    const {source,destination,draggableId}=res;if(!destination)return;
    const src=source.droppableId,dst=destination.droppableId;
    if(src==="unassigned"&&dst==="unassigned"){
      const items=[...unassigned];items.splice(source.index,1);items.splice(destination.index,0,draggableId);
      setUnassigned(items);return;
    }
    if(src==="unassigned"&&BASE_FIELDS.includes(dst)){
      const prev=mapping[dst];
      const nextUn=unassigned.filter(h=>h!==draggableId);
      if(prev)nextUn.push(prev);
      setUnassigned(nextUn);setMapping({...mapping,[dst]:draggableId});return;
    }
    if(BASE_FIELDS.includes(src)&&dst==="unassigned"){
      const hdr=mapping[src];if(!hdr)return;
      const nextUn=[...unassigned];nextUn.splice(destination.index,0,hdr);
      setUnassigned(nextUn);setMapping({...mapping,[src]:null});return;
    }
    if(BASE_FIELDS.includes(src)&&BASE_FIELDS.includes(dst)){
      const a=mapping[src],b=mapping[dst];
      setMapping({...mapping,[src]:b,[dst]:a});
    }
  };

  return(
    <Box>
      <Grid container spacing={2}>
        <Grid item xs={12} md={5}>
          <TextField label="ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå" value={tplName} onChange={e=>setTplName(e.target.value)} fullWidth/>
        </Grid>
        <Grid item xs={12} md={7} display="flex" alignItems="center" flexWrap="wrap">
          <Button onClick={createNew} sx={{mr:1,mt:1}}>ï¼‹ æ–°è¦</Button>
          <Button onClick={delTpl} color="error" sx={{mr:1,mt:1}}>ğŸ—‘ï¸ å‰Šé™¤</Button>
          <Button variant="contained" onClick={saveTpl} sx={{mt:1}}>ä¿å­˜</Button>
        </Grid>
      </Grid>

      {/* ã‚µãƒ³ãƒ—ãƒ«é¸æŠ */}
      <Box mt={3}>
        <FormControl fullWidth>
          <InputLabel>ãƒ‡ãƒ¢ã‚µãƒ³ãƒ—ãƒ«ã‚’é¸æŠ</InputLabel>
          <Select
            value={sampleKey}
            label="ãƒ‡ãƒ¢ã‚µãƒ³ãƒ—ãƒ«ã‚’é¸æŠ"
            onChange={e=>handleSampleChange(e.target.value)}
          >
            <MenuItem value="">ï¼ˆé¸æŠã—ãªã„ï¼‰</MenuItem>
            {Object.keys(SAMPLE_CSV).map(k=><MenuItem key={k} value={k}>{k}</MenuItem>)}
          </Select>
        </FormControl>
        <Box mt={2}><input type="file" accept=".csv" onChange={handleFile}/></Box>
      </Box>

      {/* ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ & ãƒãƒƒãƒ”ãƒ³ã‚° */}
      {csvHeaders.length>0&&(
        <Box mt={3}>
          <Typography variant="subtitle1">ãƒ˜ãƒƒãƒ€ãƒ¼ & ã‚µãƒ³ãƒ—ãƒ«</Typography>
          <TableContainer component={Paper} sx={{overflowX:"auto",mb:2}}>
            <Table size="small">
              <TableHead><TableRow>{csvHeaders.map(h=><TableCell key={h}>{h}</TableCell>)}</TableRow></TableHead>
              <TableBody><TableRow>{csvHeaders.map(h=><TableCell key={h}>{csvSample[h]}</TableCell>)}</TableRow></TableBody>
            </Table>
          </TableContainer>

          <Typography variant="subtitle1">ãƒ‰ãƒ©ãƒƒã‚° & ãƒ‰ãƒ­ãƒƒãƒ—ã§ãƒãƒƒãƒ”ãƒ³ã‚°</Typography>
          <DragDropContext onDragEnd={onDragEnd}>
            <Grid container spacing={2}>
              <Grid item xs={12} md={4}>
                <Typography>æœªå‰²å½“ãƒ˜ãƒƒãƒ€ãƒ¼</Typography>
                <Droppable droppableId="unassigned">
                  {p=>(
                    <Box ref={p.innerRef}{...p.droppableProps} className="droppableBox">
                      {unassigned.map((h,i)=>(
                        <Draggable key={h} draggableId={h} index={i}>
                          {prov=>(
                            <Box ref={prov.innerRef}{...prov.draggableProps}{...prov.dragHandleProps}
                                 className="draggableItem">{h}</Box>)}
                        </Draggable>
                      ))}
                      {p.placeholder}
                    </Box>
                  )}
                </Droppable>
              </Grid>
              <Grid item xs={12} md={8}>
                <Typography>åŸºæœ¬ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ</Typography>
                <Grid container spacing={1}>
                  {BASE_FIELDS.map(fld=>(
                    <Grid item xs={6} key={fld}>
                      <Typography variant="body2">{fld}</Typography>
                      <Droppable droppableId={fld}>
                        {p=>(
                          <Box ref={p.innerRef}{...p.droppableProps} className="droppableBox">
                            {mapping[fld]&&(
                              <Draggable draggableId={mapping[fld]} index={0}>
                                {prov=>(
                                  <Box ref={prov.innerRef}{...prov.draggableProps}{...prov.dragHandleProps}
                                       className="draggableItem">{mapping[fld]}</Box>)}
                              </Draggable>)}
                            {p.placeholder}
                          </Box>
                        )}
                      </Droppable>
                      <Typography variant="caption">ã‚µãƒ³ãƒ—ãƒ«: {mapping[fld]?csvSample[mapping[fld]]:"â€”"}</Typography>
                    </Grid>
                  ))}
                </Grid>
              </Grid>
            </Grid>
          </DragDropContext>
        </Box>
      )}
    </Box>
  );
}

/* ---------- 2. ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚¿ãƒ– ---------- */
function ImportPanel({onImport}){
  const [templates]=React.useState(()=>JSON.parse(localStorage.getItem(STORAGE_KEY)));
  const [tplName,setTplName]=React.useState("");
  const [sampleKey,setSampleKey]=React.useState("");
  const [file,setFile]=React.useState(null);
  const [preview,setPreview]=React.useState(null);

  const loadCsvRows=text=>{
    const arr=csvTo2D(text);const headers=arr[0]||[];const idx={};
    headers.forEach((h,i)=>idx[h]=i);
    const tpl=templates.find(t=>t.name===tplName);
    if(!tpl)return [];
    return arr.slice(1).map(r=>{
      const out={};BASE_FIELDS.forEach(f=>{
        const src=tpl.mapping[f];
        out[f]=src&&idx[src]!=null?r[idx[src]]:"";
      });
      return out;
    });
  };

  const handleSample=e=>{
    const key=e.target.value;setSampleKey(key);setFile(null);setPreview(null);
    if(!key)return;
    const rows=loadCsvRows(SAMPLE_CSV[key]);
    setPreview(rows);
  };
  const handleFile=e=>{
    const f=e.target.files[0];if(!f)return;
    setFile(f);setSampleKey("");setPreview(null);
  };
  const generatePreview=()=>{
    if(!tplName)return alert("ãƒãƒƒãƒ”ãƒ³ã‚°ã‚¿ã‚¤ãƒ—ã‚’é¸æŠ");
    if(sampleKey){
      setPreview(loadCsvRows(SAMPLE_CSV[sampleKey]));return;
    }
    if(!file)return alert("CSVã‚’é¸æŠã¾ãŸã¯ã‚µãƒ³ãƒ—ãƒ«ã‚’é¸æŠ");
    const reader=new FileReader();
    reader.onload=ev=>setPreview(loadCsvRows(ev.target.result));
    reader.readAsText(file,"utf-8");
  };
  const confirm=()=>{onImport(preview);setPreview(null);setFile(null);setSampleKey("");};

  return(
    <Box>
      <FormControl fullWidth sx={{mb:2}}>
        <InputLabel>ãƒãƒƒãƒ”ãƒ³ã‚°ã‚¿ã‚¤ãƒ—</InputLabel>
        <Select value={tplName} label="ãƒãƒƒãƒ”ãƒ³ã‚°ã‚¿ã‚¤ãƒ—" onChange={e=>setTplName(e.target.value)}>
          {templates.map(t=><MenuItem key={t.name} value={t.name}>{t.name}</MenuItem>)}
        </Select>
      </FormControl>

      <FormControl fullWidth sx={{mb:2}}>
        <InputLabel>ãƒ‡ãƒ¢ã‚µãƒ³ãƒ—ãƒ«</InputLabel>
        <Select value={sampleKey} label="ãƒ‡ãƒ¢ã‚µãƒ³ãƒ—ãƒ«" onChange={handleSample}>
          <MenuItem value="">ï¼ˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½¿ã†ï¼‰</MenuItem>
          {Object.keys(SAMPLE_CSV).map(k=><MenuItem key={k} value={k}>{k}</MenuItem>)}
        </Select>
      </FormControl>

      <Box mb={2}><input type="file" accept=".csv" onChange={handleFile}/></Box>

      <Button variant="contained" onClick={generatePreview}>ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</Button>

      {preview&&(
        <Box mt={3}>
          <Typography variant="subtitle1" gutterBottom>å–è¾¼ã¿ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</Typography>
          <TableContainer component={Paper} sx={{maxHeight:300,overflow:"auto"}}>
            <Table size="small" stickyHeader>
              <TableHead><TableRow>{BASE_FIELDS.map(f=><TableCell key={f}>{f}</TableCell>)}</TableRow></TableHead>
              <TableBody>
                {preview.map((r,i)=>(
                  <TableRow key={i}>{BASE_FIELDS.map(f=><TableCell key={f}>{r[f]}</TableCell>)}</TableRow>
                ))}
              </TableBody>
            </Table>
          </TableContainer>
          <Box mt={2}>
            <Button onClick={()=>setPreview(null)}>å–æ¶ˆ</Button>
            <Button variant="contained" sx={{ml:1}} onClick={confirm}>æœ¬å–è¾¼ã¿</Button>
          </Box>
        </Box>
      )}
    </Box>
  );
}

ReactDOM.createRoot(document.getElementById("root")).render(<App/>);
</script>
</body>
</html>