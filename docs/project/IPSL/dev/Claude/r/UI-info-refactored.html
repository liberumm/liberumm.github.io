<!DOCTYPE html><html lang="ja"><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/> 
<title>電子メールシステム（TipTap統合版／A4固定＋自動改ページ＋表分割防止＋見出し先頭＋改行記号＋フォント操作）</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap"/>
<link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons"/>
<script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js" crossorigin></script>
<script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js" crossorigin></script>
<script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.23.8/babel.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mui/material@5.15.3/umd/material-ui.production.min.js" crossorigin></script>

<!-- TipTap を ESM で読み込み、window へ公開 -->
<script type="module">
import { Editor } from "https://esm.sh/@tiptap/core@2.6.4";
import StarterKit from "https://esm.sh/@tiptap/starter-kit@2.6.4";
import Image from "https://esm.sh/@tiptap/extension-image@2.6.4";
import Underline from "https://esm.sh/@tiptap/extension-underline@2.6.4";
import Link from "https://esm.sh/@tiptap/extension-link@2.6.4";
import TextAlign from "https://esm.sh/@tiptap/extension-text-align@2.6.4";
import Color from "https://esm.sh/@tiptap/extension-color@2.6.4";
import TextStyle from "https://esm.sh/@tiptap/extension-text-style@2.6.4";
import Table from "https://esm.sh/@tiptap/extension-table@2.6.4";
import TableRow from "https://esm.sh/@tiptap/extension-table-row@2.6.4";
import TableCell from "https://esm.sh/@tiptap/extension-table-cell@2.6.4";
import TableHeader from "https://esm.sh/@tiptap/extension-table-header@2.6.4";

window.TipTap = {
  Editor, StarterKit, Image, Underline, Link, TextAlign, Color, TextStyle,
  Table, TableRow, TableCell, TableHeader
};
</script>

<style>
  :root{
    --text-900:#111827;--text-800:#1f2937;--text-700:#374151;--text-600:#4b5563;--text-500:#6b7280;
    --text-400:#9ca3af;--text-300:#d1d5db;--text-200:#e5e7eb;--text-100:#f3f4f6;
    --border:#e5e7eb;--border-light:#f3f4f6;--border-dark:#d1d5db;--background:#ffffff;--background-alt:#f9fafb;
  }
  html,body,#root{height:100%}
  body{margin:0;background:#f6f7fb}
  .scroll{overflow:auto;-webkit-overflow-scrolling:touch}
  .stickyTop{position:sticky;top:0;background:#fff;z-index:2;border-bottom:1px solid #eee}
  .stickyBottom{position:sticky;bottom:0;background:#fff;z-index:1;border-top:1px solid #eee}
  .navPane{width:280px;border-right:1px solid #eee;background:#fff}
  .paper{border-radius:12px}
  .twocol{height:calc(100dvh - 150px)}
  .touchy .MuiButton-root,.touchy .MuiListItemButton-root{min-height:44px}
  @media (max-width:980px){.navPane{display:none}.twocol{height:auto}}

  .rte-attachment{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border:1px solid #e0e0e0;border-radius:8px;background:#fafafa}
  .rte-attachment .material-icons{font-size:16px}
  .rte-img{max-width:100%;height:auto;border-radius:8px}

  /* ====== A4 プレビュー（画面） ====== */
  .pageWrap{background:#e9ebf0;padding:16px}
  .a4{
    width:210mm;
    height:297mm;              /* ★枠の高さ固定 */
    margin:16px auto;
    background:#fff;
    box-shadow:0 2px 12px rgba(0,0,0,.12);
    position:relative;
    overflow:hidden;           /* 視覚的に伸びない */
    --content-top: 15mm;
    --content-bottom: 18mm;
    --header-h: 0px;
  }
  .a4 .content{
    padding:15mm 15mm 18mm 15mm;
    box-sizing:border-box;
    height:calc(297mm - var(--content-top) - var(--content-bottom) - var(--header-h));
    overflow:visible;
    word-break:break-word;
  }
  .a4-guides::before{content:"";position:absolute;inset:12mm;border:1px dashed rgba(0,0,0,.12);pointer-events:none}

  /* ====== 1ページ目ヘッダー ====== */
  .doc-header{padding:8mm 15mm 0 15mm;font-size:12px}
  .doc-header-row{display:flex;gap:12px;align-items:flex-start;margin-bottom:6px;flex-wrap:wrap}
  .doc-header-col{flex:1 1 200px;min-width:200px}
  .doc-header-label{min-width:80px;color:#64748b;font-weight:600;font-size:11px}
  .doc-header-value{flex:1;border-bottom:1px solid #e2e8f0;padding:2px 0 4px;word-break:break-all}
  .doc-header-sep{border:none;border-top:2px solid #0ea5e9;margin:10px 0 8px}

  /* === リッチツールバー & 書式（プレビュー側の装飾は既存のまま） === */
  .rte-toolbar{display:flex;flex-wrap:wrap;gap:6px;padding:8px;border-bottom:1px solid #e5e7eb;background:#fff;position:sticky;top:0;z-index:3}
  .rte-toolbar .MuiButton-root,.rte-toolbar .MuiIconButton-root{min-width:36px}
  .rte-toolbar .MUI-Sep{width:1px;background:#e5e7eb;margin:0 4px}

  .rte-hr{border:none;border-top:2px dashed #cbd5e1;margin:14px 0}
  @media print{ .rte-hr{border:none;page-break-after:always} }

  .a4 .content p{margin:8px 0;line-height:1.7}
  .a4 blockquote{border-left:3px solid #94a3b8;padding:4px 10px;margin:8px 0;background:#f8fafc}
  .a4 pre{background:#f1f5f9;padding:8px;border-radius:6px;overflow:auto}

  /* === 改行記号の可視化（プレビューに適用） === */
  .content.show-breaks{ position:relative; }
  .content.show-breaks p,
  .content.show-breaks li,
  .content.show-breaks pre,
  .content.show-breaks blockquote{ position:relative; min-height:1.2em; }
  .content.show-breaks p::after,
  .content.show-breaks li::after,
  .content.show-breaks pre::after,
  .content.show-breaks blockquote::after{
    content:"¶";
    position:absolute; right:-0.8em; top:50%; transform:translateY(-50%);
    font-size:0.85em; color:#94a3b8; opacity:.8; pointer-events:none; z-index:1;
  }
  .content.show-breaks p:empty::after,
  .content.show-breaks li:empty::after{ content:"¶"; position:absolute; right:-0.8em; top:0; font-size:0.85em; color:#94a3b8; opacity:.8; pointer-events:none; z-index:1; }
  .content.show-breaks br::before{
    content:"↵";
    position:absolute; left:0; top:-1em; font-size:0.8em; color:#94a3b8; opacity:.8; pointer-events:none; z-index:1;
  }
  .content.breaks-hidden p::after,
  .content.breaks-hidden li::after,
  .content.breaks-hidden pre::after,
  .content.breaks-hidden blockquote::after,
  .content.breaks-hidden br::before{ display:none !important; }

  /* TipTap エディタ見た目 */
  .tiptap{min-height:280px;padding:12px;outline:none;background:#fff}
  .tiptap p{margin:8px 0;line-height:1.7}
  .tiptap blockquote{border-left:3px solid #94a3b8;padding:4px 10px;margin:8px 0;background:#f8fafc}
  .tiptap pre{background:#f1f5f9;padding:8px;border-radius:6px;overflow:auto}
  .tiptap table{border-collapse:collapse;width:100%}
  .tiptap td,.tiptap th{border:1px solid #cbd5e1;padding:6px}
</style>
</head>
<body>
<div id="root"></div>

<script type="text/babel">
const {useMemo,useState,useEffect,useRef} = React;
const M = MaterialUI;
const {
  ThemeProvider,createTheme,AppBar,Toolbar,Tooltip,IconButton,Button,Divider,Box,Paper,Grid,Stack,
  Typography,TextField,InputAdornment,Chip,Badge,List,ListItemButton,ListItemIcon,ListItemText,Checkbox,
  Dialog,DialogTitle,DialogContent,DialogActions,Select,MenuItem,Table,TableHead,TableBody,TableRow,TableCell,
  Switch,FormControlLabel,useMediaQuery,RadioGroup,Radio, Tabs, Tab, Popover, Slider
} = M;

/* ========= 定数 ========= （元のまま） */
const GROUPS=[{id:'sales',name:'営業部',members:[
  {id:'u1',name:'田中 太郎',email:'taro.tanaka@example.com'},
  {id:'u2',name:'山田 花子',email:'hanako.yamada@example.com'},
  {id:'u3',name:'佐藤 健',email:'ken.sato@example.com'},
  {id:'u4',name:'高橋 茜',email:'akane.takahashi@example.com'}]},
{id:'dev',name:'開発部',members:[
  {id:'u5',name:'小林 翔',email:'sho.kobayashi@example.com'},
  {id:'u6',name:'鈴木 直子',email:'naoko.suzuki@example.com'},
  {id:'u7',name:'伊藤 誠',email:'makoto.ito@example.com'},
  {id:'u8',name:'渡辺 沙織',email:'saori.watanabe@example.com'},
  {id:'u9',name:'中村 悠',email:'haruka.nakamura@example.com'}]},
{id:'hr',name:'人事・総務',members:[
  {id:'u10',name:'加藤 翔子',email:'shoko.kato@example.com'},
  {id:'u11',name:'松本 大',email:'dai.matsumoto@example.com'},
  {id:'u12',name:'石井 未来',email:'miki.ishii@example.com'}]}];

const PATTERNS=[
  {id:'all',name:'全社',groups:['sales','dev','hr']},
  {id:'store',name:'店舗連絡',groups:['sales']},
  {id:'hq',name:'本部連絡',groups:['dev','hr']},
  {id:'plan',name:'企画書',groups:['dev'],members:['u6']},
  {id:'asset',name:'資産購入',groups:['hr'],members:['u11']},
  {id:'trip',name:'出張申請',groups:['sales','hr']}
];

const FORMS_MASTER=['お知らせ','修繕','修繕依頼','作業依頼','配車','請求','回覧','企画書'];
const NAV_ITEMS=[{key:'01',label:'01.日別発信'},{key:'02',label:'02.○○他発信別'},{key:'03',label:'03.処理待ち'},{key:'04',label:'04.発信済み'},{key:'05',label:'05.返信文書'},{key:'06',label:'06.伝達対象別'},{key:'07',label:'07.下書き'}];
const STATUSES=['発信','発信待ち','返却','下書き'];
const BASE_LIST=[
  {id:'m1',date:'2025-08-21',time:'11:50',dept:'神谷商店',form:'修繕',title:'セルフ精算レジ端末修繕',status:'発信',deadline:''},
  {id:'m2',date:'2025-08-21',time:'12:45',dept:'システム部',form:'作業依頼',title:'インカム備品発送',status:'発信',deadline:''},
  {id:'m3',date:'2025-08-21',time:'07:34',dept:'総務部',form:'配車',title:'誤配達対応のお願い',status:'発信',deadline:'2025/08/31'},
  {id:'m4',date:'2025-08-20',time:'16:03',dept:'能代店',form:'修繕依頼',title:'床補修の件',status:'発信',deadline:''},
  {id:'m5',date:'2025-08-20',time:'14:22',dept:'経理部',form:'請求',title:'精算の件',status:'返却',deadline:''},
  {id:'m6',date:'2025-08-19',time:'09:10',dept:'営業企画',form:'お知らせ',title:'棚卸のお願い',status:'発信待ち',deadline:''},
];

/* ========= ユーティリティ ========= */
const pad2=n=>String(n).padStart(2,'0');
const today=()=>{const d=new Date();return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;}
const nowJST=()=>{const d=new Date();return {date:`${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`,time:`${pad2(d.getHours())}:${pad2(d.getMinutes())}`}};
const fmtJP=d=>new Date(d).toLocaleDateString('ja-JP',{year:'numeric',month:'2-digit',day:'2-digit',weekday:'short'});
const idgen=()=> 'm'+Math.random().toString(36).slice(2,9);
const memberById=Object.fromEntries(GROUPS.flatMap(g=>g.members.map(m=>[m.id,{...m,groupId:g.id,groupName:g.name}])));

const blankSel=()=>Object.fromEntries(GROUPS.map(g=>[g.id,new Set()]));
const cloneSel=sel=>Object.fromEntries(Object.entries(sel).map(([k,v])=>[k,new Set([...v])]));
const allIds=sel=>Object.values(sel).reduce((a,s)=>(s.forEach(id=>a.push(id)),a),[]);
const toggle=(set,id)=>{set.has(id)?set.delete(id):set.add(id);return set}
const Icon=({name,style})=><span className="material-icons" style={style}>{name}</span>;
const ChipStatus=({s})=> s==='発信'? <Chip label="発信" size="small" color="success" variant="outlined"/>:
  s==='返却'? <Chip label="返却" size="small" color="error" variant="outlined"/>:
  s==='発信待ち'? <Chip label="発信待ち" size="small" color="warning" variant="outlined"/>:
  s==='下書き'? <Chip label="下書き" size="small" variant="outlined"/>:<Chip size="small" label={s}/>;
const ChipApproval=({a})=>!a?null: a==='承認済'?<Chip size="small" color="success" label="承認済"/>:
  a==='差戻し'?<Chip size="small" color="error" label="差戻し"/>:<Chip size="small" color="warning" variant="outlined" label="未承認"/>;

/* ========= 印刷ヘルパー ========= */
function printA4() {
  const src = document.querySelector('.pageWrap.print-area');
  if (!src) { alert('印刷対象（A4プレビュー）が見つかりません。作成画面またはプレビューダイアログを開いてください。'); return; }
  const win = window.open('', '_blank');
  const html = `
<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8"/>
<title>印刷</title>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap"/>
<link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons"/>
<style>
  @page { size: A4 portrait; margin: 12mm; }
  html,body{height:auto}
  body{margin:0;background:#fff;-webkit-print-color-adjust:exact;print-color-adjust:exact;font-family:Roboto,"Noto Sans JP",system-ui,-apple-system,Segoe UI,sans-serif}
  .pageWrap{background:#fff;padding:0}
  .a4{width:210mm;min-height:297mm;margin:0 auto;box-shadow:none;page-break-after:always;position:relative}
  .a4:last-child{page-break-after:auto}
  .a4 .content{padding:15mm 15mm 18mm 15mm}
  .a4-guides::before{content:none !important}
  .doc-header{padding:0 15mm 0 15mm;font-size:12px}
  .doc-header-row{display:flex;gap:12px;align-items:flex-start;margin-bottom:6px;flex-wrap:wrap}
  .doc-header-col{flex:1 1 200px;min-width:200px}
  .doc-header-label{min-width:80px;color:#64748b;font-weight:600;font-size:11px}
  .doc-header-value{flex:1;border-bottom:1px solid #e2e8f0;padding:2px 0 4px;word-break:break-all}
  .doc-header-sep{border:none;border-top:2px solid #0ea5e9;margin:10px 0 8px}
  .a4 .content p{margin:8px 0;line-height:1.7}
  blockquote{border-left:3px solid #94a3b8;padding:4px 10px;margin:8px 0;background:#f8fafc}
  pre{background:#f1f5f9;padding:8px;border-radius:6px;overflow:auto}
  .rte-img{max-width:100%;height:auto;border-radius:8px}
  .rte-attachment{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border:1px solid #e0e0e0;border-radius:8px;background:#fafafa}
  .rte-hr{border:none;page-break-after:always}
  table{border-collapse:collapse;width:100%}
  td,th{border:1px solid #cbd5e1;padding:6px}
</style>
</head>
<body>
${src.innerHTML}
<script>
  window.onload = function(){ try{ window.print(); } finally { window.close(); } };
<\/script>
</body>
</html>`;
  win.document.open(); win.document.write(html); win.document.close();
}

/* ========= 宛先ピッカー（元のまま） ========= */
function PatternDialog({open,onClose,onApply}){ /* …中略（元のまま）… */ }
function PickerBody({sel,setSel,activeGroupId,setActiveGroupId}){ /* …中略（元のまま）… */ }
function PickerDialog({open,onClose,onConfirm,initial}){ /* …中略（元のまま）… */ }

/* ========= TipTapを使ったリッチエディタ＋A4プレビュー ========= */
function RichEditor({headerData}) {
  const editorRef = useRef(null);
  const hostRef = useRef(null);          // TipTap をマウントする div
  const [html, setHtml] = useState('<p>本文を入力してください。</p>');
  const [showBreaks, setShowBreaks] = useState(true);

  // 画像選択用
  const imgInputRef=useRef(null), fileInputRef=useRef(null);

  // A4プレビューのページ DOM を保持（再描画コスト抑制のため html から都度生成）
  const previewWrapRef = useRef(null);

  // === TipTap 初期化 ===
  useEffect(()=>{
    const T = window.TipTap;
    if(!T || editorRef.current) return;

    const editor = new T.Editor({
      element: hostRef.current,
      extensions: [
        T.StarterKit.configure({
          heading: { levels:[1,2,3,4] },
          bulletList: { keepMarks: true },
          orderedList: { keepMarks: true },
        }),
        T.Image.configure({ inline:false, allowBase64:true }),
        T.Underline,
        T.Link.configure({ openOnClick: true, autolink: true }),
        T.TextStyle, T.Color,                       // 文字色用
        T.TextAlign.configure({ types: ['heading','paragraph'] }), // 揃え
        T.Table.configure({ resizable:true }),
        T.TableRow, T.TableHeader, T.TableCell
      ],
      content: html,
      editorProps: { attributes:{ class:'tiptap', spellcheck:'false' } },
      onUpdate({editor}){ setHtml(editor.getHTML()); },
    });

    editorRef.current = editor;
    return () => { editor.destroy(); editorRef.current = null; };
  },[]);

  // === A4プレビュー生成（自動改ページ/見出し先頭/表分割防止/巨大画像縮小） ===
  useEffect(()=>{
    const root = previewWrapRef.current;
    if(!root) return;
    root.innerHTML = ''; // クリア

    // ページ生成
    const createPage = ()=>{
      const page = document.createElement('div');
      page.className = 'a4 a4-guides';
      const header = document.createElement('div');
      header.className = 'doc-header';
      header.innerHTML = `
        <div class="doc-header-row"><div class="doc-header-label">発信件名</div><div class="doc-header-value">${headerData?.subject||'（未入力）'}</div></div>
        <div class="doc-header-row">
          <div class="doc-header-col"><div class="doc-header-label">フォーム</div><div class="doc-header-value">${headerData?.form||'—'}</div></div>
          <div class="doc-header-col"><div class="doc-header-label">発信日</div><div class="doc-header-value">${headerData?.sendDate||'yyyy/mm/dd'}</div></div>
        </div>
        <div class="doc-header-row"><div class="doc-header-label">宛先</div><div class="doc-header-value">${headerData?.toText||'宛先は未選択です。'}</div></div>
        <div class="doc-header-row">
          <div class="doc-header-col"><div class="doc-header-label">伝達対象</div><div class="doc-header-value">${headerData?.target||'例：全社員 / 取締役会'}</div></div>
          <div class="doc-header-col"><div class="doc-header-label">発信部署</div><div class="doc-header-value">${headerData?.originator||'所属名'}</div></div>
        </div>
        <div class="doc-header-row">
          <div class="doc-header-col"><div class="doc-header-label">返信期限</div><div class="doc-header-value">${headerData?.deadline||'yyyy/mm/dd'}</div></div>
          <div class="doc-header-col"><div class="doc-header-label">担当者</div><div class="doc-header-value">${headerData?.assignee||'担当者名'}</div></div>
        </div>
        <hr class="doc-header-sep"/>
      `;
      const content = document.createElement('div');
      content.className = 'content';
      if(showBreaks) content.classList.add('show-breaks');

      page.appendChild(header);
      page.appendChild(content);
      root.appendChild(page);
      // header 高さを CSS 変数に反映
      requestAnimationFrame(()=>{
        page.style.setProperty('--header-h', `${header.getBoundingClientRect().height||0}px`);
      });
      return content;
    };

    // 最初のページ
    let cur = createPage();
    cur.innerHTML = html || '<p></p>';

    const getBlocks = (el)=> Array.from(el.childNodes).filter(n => n.nodeType===1 || (n.nodeType===3 && n.textContent.trim()));
    const isHeading = el => el?.nodeType===1 && /H[1-3]/.test(el.tagName);
    const nearestTableUnit = (node)=> node?.closest ? (node.closest('tr')||node.closest('thead,tbody,tfoot')||node.closest('table')||node) : node;
    const ensureNext = ()=> createPage();
    const shrinkImageIfHuge = (node, height)=>{
      if(node?.tagName!=='IMG') return false;
      const curPct = parseInt(String(node.style.width||'').replace('%','')) || 100;
      if(node.offsetHeight > height*0.8 && curPct>40){
        node.style.width = `${Math.max(40, curPct-15)}%`;
        return true;
      }
      return false;
    };
    const moveToNext = (from, to, nodes)=> nodes.slice().reverse().forEach(n=> to.insertBefore(n, to.firstChild));
    const overflow = (el)=> (el.scrollHeight - el.clientHeight) > Math.max(8, el.clientHeight*0.015);

    // 再流し込みループ
    let changed = true;
    while(changed){
      changed = false;
      const contents = Array.from(root.querySelectorAll('.content'));
      for(let i=0;i<contents.length;i++){
        const c = contents[i];
        if(!overflow(c)) continue;
        if(i===contents.length-1){
          ensureNext();
        }
        const next = Array.from(root.querySelectorAll('.content'))[i+1];
        const blocks = getBlocks(c); if(!blocks.length) continue;
        let last = nearestTableUnit(blocks[blocks.length-1]);

        // 大画像はまず縮小
        if(last?.tagName==='IMG'){
          if(shrinkImageIfHuge(last, c.clientHeight)){ changed = true; continue; }
        }

        // 見出しは次ノードとセットで送る
        const moves = isHeading(last) && last.nextSibling ? [last.nextSibling,last] : [last];

        // 表は table 丸ごと送る
        if(last && last.closest && last.closest('table')){
          const tbl = last.closest('table');
          moveToNext(c, next, [tbl]);
        }else{
          moveToNext(c, next, moves);
        }
        changed = true;
      }

      // ページ途中の見出しを次ページ先頭へ
      const contents2 = Array.from(root.querySelectorAll('.content'));
      for(let i=0;i<contents2.length-1;i++){
        const a = contents2[i], b = contents2[i+1];
        const kids = getBlocks(a);
        if(kids.length<=1) continue;
        for(let k=1;k<kids.length;k++){
          const node = kids[k];
          if(isHeading(node)){
            const pack = node.nextSibling ? [node.nextSibling,node] : [node];
            moveToNext(a, b, pack);
            changed = true;
          }
        }
      }
    }
  },[html, headerData, showBreaks]);

  // === ツールバー操作 ===
  const T = window.TipTap;
  const chain = () => editorRef.current?.chain().focus();
  const setColor = (hex)=> chain()?.setColor(hex).run();
  const setBg = (hex)=> {
    // 背景色は span style で簡易対応
    editorRef.current?.commands.insertContent(`<span style="background:${hex}">\u200b</span>`);
    editorRef.current?.commands.deleteRange({ from: editorRef.current.state.selection.from, to: editorRef.current.state.selection.from });
  };
  const insertHR = ()=> editorRef.current?.commands.setHorizontalRule();
  const insertTable = ()=> editorRef.current?.commands.insertTable({rows:3, cols:3, withHeaderRow:true});
  const insertLink = ()=>{
    const url = prompt('リンクURL（https://…）'); if(!url) return;
    chain()?.extendMarkRange('link').setLink({ href:url }).run();
  };
  const unlink = ()=> chain()?.unsetLink().run();

  const onPick = (e, type)=>{
    const files = [...e.target.files||[]];
    files.forEach(f=>{
      if(type==='img'){
        const r = new FileReader();
        r.onload = ()=> chain()?.setImage({src:r.result}).run();
        r.readAsDataURL(f);
      }else{
        const url = URL.createObjectURL(f);
        const kb = Math.max(1, Math.round(f.size/1024));
        editorRef.current?.commands.insertContent(`<span class="rte-attachment"><span class="material-icons">attach_file</span><a href="${url}" download="${f.name}">${f.name}</a><span>（${kb}KB）</span></span>&nbsp;`);
      }
    });
    e.target.value='';
  };

  // 画像幅のクイック変更（選択中の image ノードに style を付与）
  const setImageWidthPct = (pct)=>{
    const { state } = editorRef.current;
    const { from, to } = state.selection;
    let updated = false;
    state.doc.nodesBetween(from, to, (node,pos)=>{
      if(node.type.name==='image'){
        editorRef.current.commands.updateAttributes('image', { style:`width:${pct}%` });
        updated = true;
      }
    });
    if(!updated){
      alert('画像を選択してから実行してください（画像をクリック）');
    }
  };

  const ToolbarBtn = ({icon,label,onClick,active}) => (
    <Tooltip title={label}><IconButton size="small" onClick={onClick} color={active?'primary':'default'}>
      <span className="material-icons">{icon}</span>
    </IconButton></Tooltip>
  );

  return (
    <Paper variant="outlined" className="paper">
      {/* 上部バー：ファイル挿入 */}
      <Stack direction="row" spacing={0.5} sx={{p:1,borderBottom:'1px solid #e5e7eb',flexWrap:'wrap'}} alignItems="center">
        <Tooltip title="画像を挿入"><IconButton size="small" onClick={()=>imgInputRef.current.click()}><span className="material-icons">image</span></IconButton></Tooltip>
        <input ref={imgInputRef} type="file" accept="image/*" multiple hidden onChange={e=>onPick(e,'img')}/>
        <Tooltip title="添付バッジを挿入"><IconButton size="small" onClick={()=>fileInputRef.current.click()}><span className="material-icons">attach_file</span></IconButton></Tooltip>
        <input ref={fileInputRef} type="file" multiple hidden onChange={e=>onPick(e,'file')}/>
        <Box sx={{flex:1}}/><Typography variant="caption" color="text.secondary" sx={{px:1}}>エディタ（TipTap）</Typography>
      </Stack>

      {/* 書式ツールバー（TipTapコマンドに置換） */}
      <div className="rte-toolbar">
        <ToolbarBtn icon="undo" label="取り消し" onClick={()=>chain()?.undo().run()}/>
        <ToolbarBtn icon="redo" label="やり直し" onClick={()=>chain()?.redo().run()}/>
        <div className="MUI-Sep"></div>

        <ToolbarBtn icon="format_bold" label="太字" onClick={()=>chain()?.toggleBold().run()} active={editorRef.current?.isActive('bold')}/>
        <ToolbarBtn icon="format_italic" label="斜体" onClick={()=>chain()?.toggleItalic().run()} active={editorRef.current?.isActive('italic')}/>
        <ToolbarBtn icon="format_underline" label="下線" onClick={()=>chain()?.toggleUnderline().run()} active={editorRef.current?.isActive('underline')}/>
        <ToolbarBtn icon="strikethrough_s" label="取消線" onClick={()=>chain()?.toggleStrike().run()} active={editorRef.current?.isActive('strike')}/>
        <ToolbarBtn icon="format_clear" label="書式クリア" onClick={()=>chain()?.unsetAllMarks().clearNodes().run()}/>
        <div className="MUI-Sep"></div>

        <Select size="small" defaultValue="P" onChange={(e)=>{
          const v=e.target.value;
          if(v==='P') chain()?.setParagraph().run();
          else chain()?.toggleHeading({level: Number(v.replace('H',''))}).run();
        }} sx={{minWidth:120}}>
          <MenuItem value="P">段落</MenuItem>
          <MenuItem value="H1">見出しH1</MenuItem>
          <MenuItem value="H2">見出しH2</MenuItem>
          <MenuItem value="H3">見出しH3</MenuItem>
        </Select>

        <div className="MUI-Sep"></div>
        <ToolbarBtn icon="format_list_bulleted" label="箇条書き" onClick={()=>chain()?.toggleBulletList().run()}/>
        <ToolbarBtn icon="format_list_numbered" label="番号付き" onClick={()=>chain()?.toggleOrderedList().run()}/>
        <ToolbarBtn icon="format_quote" label="引用" onClick={()=>chain()?.toggleBlockquote().run()}/>
        <ToolbarBtn icon="code" label="コード" onClick={()=>chain()?.toggleCodeBlock().run()}/>
        <div className="MUI-Sep"></div>

        <ToolbarBtn icon="format_align_left" label="左揃え" onClick={()=>chain()?.setTextAlign('left').run()}/>
        <ToolbarBtn icon="format_align_center" label="中央揃え" onClick={()=>chain()?.setTextAlign('center').run()}/>
        <ToolbarBtn icon="format_align_right" label="右揃え" onClick={()=>chain()?.setTextAlign('right').run()}/>
        <ToolbarBtn icon="format_align_justify" label="両端揃え" onClick={()=>chain()?.setTextAlign('justify').run()}/>
        <div className="MUI-Sep"></div>

        <ToolbarBtn icon="link" label="リンク" onClick={insertLink}/>
        <ToolbarBtn icon="link_off" label="リンク解除" onClick={unlink}/>
        <div className="MUI-Sep"></div>

        <ToolbarBtn icon="horizontal_rule" label="区切り線" onClick={insertHR}/>
        <ToolbarBtn icon="table_chart" label="テーブル（3×3）" onClick={insertTable}/>
        <div className="MUI-Sep"></div>

        {/* 文字色／背景色 */}
        <Tooltip title="文字色">
          <IconButton size="small" onClick={()=>{
            const c = prompt('文字色（例: #ff0000）'); if(c) setColor(c);
          }}><span className="material-icons">format_color_text</span></IconButton>
        </Tooltip>
        <Tooltip title="背景色（ハイライト）">
          <IconButton size="small" onClick={()=>{
            const c = prompt('背景色（例: #ffff00）'); if(c) setBg(c);
          }}><span className="material-icons">format_color_fill</span></IconButton>
        </Tooltip>

        <div className="MUI-Sep"></div>
        {/* 画像幅（選択中の画像に適用） */}
        {[25,50,75,100].map(pct=>(
          <Button key={pct} size="small" onClick={()=>setImageWidthPct(pct)}>{pct}%</Button>
        ))}

        <div className="MUI-Sep"></div>
        {/* 改行記号可視化（プレビューに反映） */}
        <Tooltip title={showBreaks?'改行記号を非表示':'改行記号を表示'}>
          <IconButton size="small" color={showBreaks?'primary':'default'} onClick={()=>setShowBreaks(v=>!v)}>
            <span className="material-icons">visibility</span>
          </IconButton>
        </Tooltip>
      </div>

      {/* TipTap 本体 */}
      <Box sx={{borderTop:'1px solid #e5e7eb',borderBottom:'1px solid #e5e7eb', background:'#fff'}}>
        <div ref={hostRef} />
      </Box>

      {/* A4 プレビュー（印刷対象） */}
      <Box className="pageWrap print-area">
        <div ref={previewWrapRef} />
      </Box>
    </Paper>
  );
}

/* ========= 一覧（元のまま） ========= */
function InboxList({rows,setRows,onEditDraft,onApprove,onReject}){ /* …中略（元のまま）… */ }

/* ========= 作成/編集（RichEditor の呼び出しだけ変更） ========= */
function ComposeView({rows,setRows,initialDoc,onClose,fixedForm,allowedForms}){
  const editing=!!initialDoc;
  const [subject,setSubject]=useState(initialDoc?.title||'');
  const [originator,setOriginator]=useState(initialDoc?.dept||'');
  const [assignee,setAssignee]=useState(''),[target,setTarget]=useState('');
  const [sendDate,setSendDate]=useState(initialDoc?.date||'');
  const [deadline,setDeadline]=useState(initialDoc?.deadline?.replaceAll('-','/')||'');
  const [form,setForm]=useState(initialDoc?.form|| (fixedForm || (allowedForms?.[0] || 'お知らせ')));
  const [toSel,setToSel]=useState(blankSel()), [ccSel,setCcSel]=useState(blankSel());
  const [openPicker,setOpenPicker]=useState(false), [pickerKind,setPickerKind]=useState('to');

  const ids=a=>allIds(a), toIds=ids(toSel), ccIds=ids(ccSel);
  const rm=(kind,id)=>{const gid=memberById[id].groupId; const up=p=>{const n={...p},s=new Set(p[gid]); s.delete(id); n[gid]=s; return n}; (kind==='to'?setToSel:setCcSel)(up);};

  // 送信・保存はデモ: TipTap版はプレビュー DOM から取得も可能だが、ここではダミーでメッセージのみにしています
  const saveDraft=()=>{ alert('一時保管（デモ）'); onClose(); };
  const send=()=>{ alert('発信（デモ）'); onClose(); };

  const CountBadge=({n})=><Badge badgeContent={n} color={n?'secondary':'default'}><Icon name="groups"/></Badge>;
  const toText = toIds.length ? toIds.map(id => memberById[id].name).join('、') : '宛先は未選択です。';

  return (<Box sx={{width:'100%',mx:'auto',p:2}}>
    <Paper className="paper" sx={{p:2}}>
      <Grid container spacing={2} alignItems="center">
        <Grid item xs={12} md={6}>
          <Typography variant="subtitle2" color="text.secondary" sx={{mb:.5}}>発信件名</Typography>
          <TextField fullWidth value={subject} onChange={e=>setSubject(e.target.value)} placeholder="件名を入力"/>
        </Grid>
        <Grid item xs={6} md={3}>
          <Typography variant="subtitle2" color="text.secondary" sx={{mb:.5}}>フォーム</Typography>
          {fixedForm
            ? <TextField fullWidth value={fixedForm} disabled/>
            : <TextField select fullWidth value={form} onChange={e=>setForm(e.target.value)}>
                {(allowedForms||FORMS_MASTER).map(f=><MenuItem key={f} value={f}>{f}</MenuItem>)}
              </TextField>}
        </Grid>
        <Grid item xs={6} md={3}>
          <Typography variant="subtitle2" color="text.secondary" sx={{mb:.5}}>発信日</Typography>
          <TextField type="date" fullWidth value={sendDate} onChange={e=>setSendDate(e.target.value)}/>
        </Grid>
      </Grid>

      <Divider sx={{my:2,borderStyle:'dashed'}}/>

      <Grid container spacing={2}>
        <Grid item xs={12} md={6}>
          <Typography variant="subtitle2" color="text.secondary" sx={{mb:.5}}>宛先</Typography>
          <Stack direction="row" spacing={1} alignItems="center" sx={{mb:1}}>
            <Tooltip title="宛先を選択"><Button variant="outlined" onClick={()=>{setPickerKind('to');setOpenPicker(true);}} startIcon={<Icon name="group_add"/>} endIcon={<CountBadge n={toIds.length}/>}>宛先</Button></Tooltip>
            <Tooltip title="（写）を選択"><Button variant="outlined" onClick={()=>{setPickerKind('cc');setOpenPicker(true);}} startIcon={<Icon name="group"/>} endIcon={<CountBadge n={ccIds.length}/>}>（写）</Button></Tooltip>
          </Stack>
          {toIds.length===0? <Typography variant="body2" color="text.secondary">宛先は未選択です。</Typography>:
            <Box sx={{display:'flex',gap:.75,flexWrap:'wrap',mb:1}}>
              {toIds.map(id=><Chip key={id} size="small" onDelete={()=>rm('to',id)} label={`${memberById[id].name}（${memberById[id].groupName}）`} icon={<Icon name="person" style={{fontSize:18}}/>}/>)}
            </Box>}
          {ccIds.length>0 && <Box sx={{display:'flex',gap:.75,flexWrap:'wrap'}}>
            {ccIds.map(id=><Chip key={id} size="small" onDelete={()=>rm('cc',id)} label={`(写) ${memberById[id].name}（${memberById[id].groupName}）`} icon={<Icon name="person" style={{fontSize:18}}/>}/>)}
          </Box>}
        </Grid>
        <Grid item xs={12} md={3}>
          <Typography variant="subtitle2" color="text.secondary" sx={{mb:.5}}>伝達対象</Typography>
          <TextField fullWidth placeholder="例：全社員 / 取締役会" value={target} onChange={e=>setTarget(e.target.value)}/>
        </Grid>
        <Grid item xs={12} md={3}>
          <Typography variant="subtitle2" color="text.secondary" sx={{mb:.5}}>発信部署</Typography>
          <TextField fullWidth placeholder="所属名" value={originator} onChange={e=>setOriginator(e.target.value)}/>
        </Grid>
      </Grid>

      <Grid container spacing={2} sx={{mt:1}}>
        <Grid item xs={12} md={3}>
          <Typography variant="subtitle2" color="text.secondary" sx={{mb:.5}}>返信期限</Typography>
          <TextField type="date" fullWidth value={deadline.replaceAll('/','-')} onChange={e=>setDeadline(e.target.value.replaceAll('-','/'))}/>
        </Grid>
        <Grid item xs={12} md={3}>
          <Typography variant="subtitle2" color="text.secondary" sx={{mb:.5}}>担当者</Typography>
          <TextField fullWidth placeholder="担当者名" value={assignee} onChange={e=>setAssignee(e.target.value)}/>
        </Grid>
      </Grid>

      <Divider sx={{my:2,borderStyle:'dashed'}}/>
      <Typography variant="subtitle2" color="text.secondary" sx={{mb:.5}}>本文（TipTap リッチ書式 / A4プレビュー / 自動改ページ）</Typography>
      <RichEditor
        headerData={{
          subject,
          form,
          sendDate: (sendDate || '').replaceAll('-','/'),
          toText: (allIds(toSel).length ? allIds(toSel).map(id => memberById[id].name).join('、') : '宛先は未選択です。'),
          target,
          originator,
          deadline,
          assignee
        }}
      />
    </Paper>

    <Box mt={2} display="flex" justifyContent="flex-end" gap={1}>
      <Button startIcon={<Icon name="close"/>} onClick={onClose}>キャンセル</Button>
      <Button startIcon={<Icon name="print"/>} onClick={printA4}>プレビュー/印刷</Button>
      <Button onClick={saveDraft}>{editing?'下書き保存':'一時保管'}</Button>
      <Button variant="contained" startIcon={<Icon name="send"/>} onClick={send}>{editing?(fixedForm==='企画書'?'更新して発信（企画書）':'更新して発信'):(fixedForm==='企画書'?'発信（企画書）':'発信')}</Button>
    </Box>

    <PickerDialog open={openPicker} onClose={()=>setOpenPicker(false)} onConfirm={s=>{(pickerKind==='to'?setToSel:setCcSel)(s); setOpenPicker(false);}} initial={pickerKind==='to'?toSel:ccSel}/>
  </Box>);
}

/* ========= メイン ========= */
function App(){
  const theme=useMemo(()=>createTheme({
    palette:{primary:{main:'#6366F1'},secondary:{main:'#14B8A6'},background:{default:'#f6f7fb'}},
    shape:{borderRadius:12},
    components:{MuiPaper:{styleOverrides:{root:{borderRadius:12}}},MuiTableHead:{styleOverrides:{root:{backgroundColor:'rgba(0,0,0,0.02)'}}}},
    typography:{fontFamily:['Roboto','system-ui','-apple-system','BlinkMacSystemFont','Segoe UI','"Noto Sans JP"','sans-serif'].join(',')}
  }),[]);
  const [rows,setRows]=useState(()=>[...BASE_LIST]); // デモ簡略
  const [page,setPage]=useState('composeNotice'); // デモでは作成画面を開いておく
  const [editingDoc,setEditingDoc]=useState(null);

  const handleEditDraft=doc=>{setEditingDoc(doc); setPage(doc.form==='企画書'?'composeProposal':'composeNotice');};
  const closeCompose=()=>{setEditingDoc(null); setPage('composeNotice');};
  const approve=id=>setRows(p=>p.map(r=>r.id===id?{...r,approval:'承認済'}:r));
  const reject=id=>setRows(p=>p.map(r=>r.id===id?{...r,approval:'差戻し'}:r));

  const title =
    page==='list' ? '一覧（発信文書 / 企画書）'
    : page==='composeProposal' ? (editingDoc?'企画書を編集':'企画書作成')
    : (editingDoc?'下書き編集':'発信文書作成');

  return (<ThemeProvider theme={theme}>
    <AppBar elevation={0} position="sticky" sx={{background:'#fff',borderBottom:'1px solid #e5e7eb',color:'inherit'}}>
      <Toolbar variant="dense" sx={{gap:1,flexWrap:'wrap'}}>
        <Button variant={page==='list'?'contained':'text'} onClick={()=>{setPage('list');setEditingDoc(null);}} startIcon={<Icon name="inbox"/>}>一覧</Button>
        <Button variant={page==='composeNotice'?'contained':'text'} onClick={()=>{setEditingDoc(null);setPage('composeNotice');}} startIcon={<Icon name="edit"/>}>発信文書作成</Button>
        <Button variant={page==='composeProposal'?'contained':'text'} onClick={()=>{setEditingDoc(null);setPage('composeProposal');}} startIcon={<Icon name="description"/>}>企画書作成</Button>
        <Divider orientation="vertical" flexItem sx={{mx:1}}/>
        <Stack direction="row" alignItems="center" spacing={1}>
          <Icon name="dashboard"/><Typography variant="h6" sx={{fontWeight:700}}>{title}</Typography>
        </Stack>
        <Box sx={{flex:1}}/>
        <Tooltip title="A4プレビューを印刷"><IconButton onClick={printA4}><Icon name="print"/></IconButton></Tooltip>
      </Toolbar>
    </AppBar>

    {page==='list'
      ? <InboxList rows={rows} setRows={setRows} onEditDraft={handleEditDraft} onApprove={approve} onReject={reject}/>
      : page==='composeProposal'
        ? <ComposeView rows={rows} setRows={setRows} initialDoc={editingDoc} onClose={closeCompose} fixedForm="企画書" allowedForms={['企画書']}/>
        : <ComposeView rows={rows} setRows={setRows} initialDoc={editingDoc} onClose={closeCompose} allowedForms={FORMS_MASTER.filter(f=>f!=='企画書')}/>
    }
  </ThemeProvider>);
}
ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
</script>
</body></html>
