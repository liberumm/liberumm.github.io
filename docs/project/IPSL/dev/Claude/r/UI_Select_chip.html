<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tabs (部門/コーナー/ライン/カテゴリ/アイテム/SKU) × Chips</title>

  <!-- Roboto & MUI -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" />
  <!-- React, ReactDOM, Babel -->
  <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js" crossorigin></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.23.8/babel.min.js"></script>
  <!-- Emotion (MUI依存) -->
  <script src="https://cdn.jsdelivr.net/npm/@emotion/react@11.11.3/dist/emotion-react.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@emotion/styled@11.11.0/dist/emotion-styled.umd.min.js"></script>
  <!-- MUI Core -->
  <script src="https://cdn.jsdelivr.net/npm/@mui/material@5.15.3/umd/material-ui.production.min.js" crossorigin></script>
  <!-- MUI Icons -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">

  <style>
    body { margin: 24px; background: #fafafa; }
    .panel { border: 1px solid #e0e0e0; border-radius: 12px; padding: 12px; background: #fff; }
    .ctx { border: 1px dashed #e0e0e0; border-radius: 10px; padding: 8px; background: #fcfcfc; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useMemo, useState } = React;
    const {
      Box, Chip, Stack, Typography, Tabs, Tab,
      Dialog, DialogTitle, DialogContent, DialogActions,
      TextField, Button, List, ListItem, ListItemIcon, ListItemText,
      Checkbox, ToggleButton, ToggleButtonGroup, Divider
    } = MaterialUI;

    // ====== サンプルデータ（6粒度） ======
    const DATA = {
      departments: [
        { id: "dep_el", name: "エレクトロニクス" },
        { id: "dep_hk", name: "ホーム＆キッチン" }
      ],
      corners: [
        { id: "cor_mobile", name: "モバイル",  departmentId: "dep_el" },
        { id: "cor_pc",     name: "PC",       departmentId: "dep_el" },
        { id: "cor_cook",   name: "調理家電", departmentId: "dep_hk" },
        { id: "cor_clean",  name: "清掃家電", departmentId: "dep_hk" }
      ],
      lines: [
        { id: "lin_pixel",  name: "Pixel ライン",    cornerId: "cor_mobile" },
        { id: "lin_galaxy", name: "Galaxy ライン",   cornerId: "cor_mobile" },
        { id: "lin_think",  name: "ThinkPad ライン", cornerId: "cor_pc" },
        { id: "lin_mac",    name: "MacBook ライン",  cornerId: "cor_pc" },
        { id: "lin_ih",     name: "IH 調理ライン",   cornerId: "cor_cook" },
        { id: "lin_robot",  name: "ロボット掃除機",   cornerId: "cor_clean" }
      ],
      categories: [
        { id: "cat_phone", name: "スマートフォン",   lineId: "lin_pixel" },
        { id: "cat_phone2",name: "スマートフォン",   lineId: "lin_galaxy" },
        { id: "cat_nb",    name: "ノートPC",         lineId: "lin_think" },
        { id: "cat_nb2",   name: "ノートPC",         lineId: "lin_mac" },
        { id: "cat_rice",  name: "炊飯器",           lineId: "lin_ih" },
        { id: "cat_vac",   name: "ロボット掃除機",   lineId: "lin_robot" }
      ],
      items: [
        { id: "itm_px8",    name: "Pixel 8",            categoryId: "cat_phone",  tags: ["popular","新着"] },
        { id: "itm_px8pro", name: "Pixel 8 Pro",        categoryId: "cat_phone",  tags: ["人気"] },
        { id: "itm_s24",    name: "Galaxy S24",         categoryId: "cat_phone2", tags: ["新着"] },
        { id: "itm_t14",    name: "ThinkPad T14",       categoryId: "cat_nb",     tags: ["人気"] },
        { id: "itm_mb_air", name: "MacBook Air 13",     categoryId: "cat_nb2",    tags: ["popular"] },
        { id: "itm_ih5",    name: "IHジャー炊飯器 5.5合", categoryId: "cat_rice",   tags: [] },
        { id: "itm_robo1",  name: "RoboClean X1",       categoryId: "cat_vac",    tags: ["popular"] }
      ],
      skus: [
        { id: "sku_px8_bk_128",   itemId: "itm_px8",    name: "Pixel 8 — 黒/128GB" },
        { id: "sku_px8_gr_256",   itemId: "itm_px8",    name: "Pixel 8 — 緑/256GB" },
        { id: "sku_px8p_bk_256",  itemId: "itm_px8pro", name: "Pixel 8 Pro — 黒/256GB" },
        { id: "sku_s24_wh_256",   itemId: "itm_s24",    name: "Galaxy S24 — 白/256GB" },
        { id: "sku_mb_air_8_256", itemId: "itm_mb_air", name: "MBA 13 — 8GB/256GB" },
        { id: "sku_t14_16_512",   itemId: "itm_t14",    name: "T14 — 16GB/512GB" },
        { id: "sku_ih5_wh",       itemId: "itm_ih5",    name: "IH炊飯器 — 白" },
        { id: "sku_robo1_std",    itemId: "itm_robo1",  name: "RoboClean X1 — 標準" }
      ]
    };

    // ====== ユーティリティ ======
    const sortWithSelectedFirst = (arr, selected) =>
      [...arr].sort((a,b) => {
        const sa = selected.has(a.id) ? 0 : 1;
        const sb = selected.has(b.id) ? 0 : 1;
        if (sa !== sb) return sa - sb;
        return (a.name || "").localeCompare(b.name || "", "ja");
      });

    function App() {
      // 粒度タブ
      const [tab, setTab] = useState("department"); // department | corner | line | category | item | sku

      // 選択状態
      const [selDep,  setSelDep]  = useState(new Set());
      const [selCor,  setSelCor]  = useState(new Set());
      const [selLin,  setSelLin]  = useState(new Set());
      const [selCat,  setSelCat]  = useState(new Set());
      const [selItem, setSelItem] = useState(new Set());
      const [selSku,  setSelSku]  = useState(new Set());

      // アイテム粒度：＋Nで拡張
      const THRESHOLD = 5;
      const [expanded, setExpanded] = useState(false);

      // アイテム詳細検索モーダル
      const [open, setOpen] = useState(false);
      const [q, setQ] = useState("");
      const [token, setToken] = useState("all"); // all | popular | new

      // 上位でフィルタ
      const corList = useMemo(() => {
        return selDep.size
          ? DATA.corners.filter(c => selDep.has(c.departmentId))
          : DATA.corners;
      }, [selDep]);

      const linList = useMemo(() => {
        return selCor.size
          ? DATA.lines.filter(l => selCor.has(l.cornerId))
          : DATA.lines;
      }, [selCor]);

      const catList = useMemo(() => {
        return selLin.size
          ? DATA.categories.filter(c => selLin.has(c.lineId))
          : DATA.categories;
      }, [selLin]);

      const itemList = useMemo(() => {
        return selCat.size
          ? DATA.items.filter(i => selCat.has(i.categoryId))
          : DATA.items;
      }, [selCat]);

      const skuList = useMemo(() => {
        return selItem.size
          ? DATA.skus.filter(s => selItem.has(s.itemId))
          : DATA.skus;
      }, [selItem]);

      // 表示（選択優先ソート）
      const depView  = useMemo(() => sortWithSelectedFirst(DATA.departments, selDep), [selDep]);
      const corView  = useMemo(() => sortWithSelectedFirst(corList, selCor), [corList, selCor]);
      const linView  = useMemo(() => sortWithSelectedFirst(linList, selLin), [linList, selLin]);
      const catView  = useMemo(() => sortWithSelectedFirst(catList, selCat), [catList, selCat]);
      const itemView = useMemo(() => sortWithSelectedFirst(itemList, selItem), [itemList, selItem]);
      const skuView  = useMemo(() => sortWithSelectedFirst(skuList, selSku), [skuList, selSku]);

      // アイテムの可視件数（＋N）
      const itemVisible = expanded ? itemView : itemView.slice(0, THRESHOLD);
      const itemHiddenCount = Math.max(0, itemView.length - itemVisible.length);

      // トグル共通
      const toggleSet = (setfn, id) => setfn(prev => {
        const next = new Set(prev);
        next.has(id) ? next.delete(id) : next.add(id);
        return next;
      });

      // モーダル：アイテム検索結果
      const modalItems = useMemo(() => {
        let list = itemList;
        if (token === "popular") list = list.filter(i => i.tags.includes("popular") || i.tags.includes("人気"));
        if (token === "new")     list = list.filter(i => i.tags.includes("新着") || i.tags.includes("new"));
        if (q.trim()) {
          const qq = q.trim().toLowerCase();
          list = list.filter(i => i.name.toLowerCase().includes(qq));
        }
        return list;
      }, [itemList, q, token]);

      // 共通パネル（chips）— hybrid=true ならアイテム用＋N＆モーダルボタン
      const ChipPanel = ({ list, selected, onToggle, hybrid=false }) => {
        const chips = hybrid ? itemVisible : list;
        return (
          <Box className="panel" role="group">
            <Stack direction="row" spacing={1} useFlexGap flexWrap="wrap">
              {chips.map(x => {
                const isSel = selected.has(x.id);
                return (
                  <Chip
                    key={x.id}
                    label={x.name}
                    color={isSel ? "primary" : "default"}
                    variant={isSel ? "filled" : "outlined"}
                    onClick={() => onToggle(x.id)}
                    onDelete={isSel ? () => onToggle(x.id) : undefined}
                    deleteIcon={isSel ? <span className="material-icons" style={{fontSize:18}}>close</span> : undefined}
                    sx={{ borderRadius: 999 }}
                  />
                );
              })}
              {hybrid && !expanded && itemHiddenCount > 0 && (
                <Chip
                  variant="outlined"
                  label={`＋${itemHiddenCount}件`}
                  onClick={() => setExpanded(true)}
                  icon={<span className="material-icons">expand_more</span>}
                  sx={{ borderStyle: "dashed", borderRadius: 999 }}
                />
              )}
              {hybrid && expanded && (
                <Chip
                  color="info"
                  variant="outlined"
                  label="詳細検索"
                  onClick={() => setOpen(true)}
                  icon={<span className="material-icons">search</span>}
                  sx={{ borderRadius: 999 }}
                />
              )}
            </Stack>
            <Typography variant="body2" sx={{ mt: 1, color: "text.secondary" }}>
              選択中: {selected.size} 件{hybrid && <> ／ しきい値: {THRESHOLD}</>}
            </Typography>
          </Box>
        );
      };

      return (
        <Box>
          <Typography variant="h6" gutterBottom>
            粒度タブ × Chip × ＋件数（アイテム） × 詳細検索（モーダル）
          </Typography>

          <Tabs value={tab} onChange={(e,v)=>setTab(v)} aria-label="granularity" sx={{ mb: 2 }}>
            <Tab value="department" label="部門" />
            <Tab value="corner"     label="コーナー" />
            <Tab value="line"       label="ライン" />
            <Tab value="category"   label="カテゴリ" />
            <Tab value="item"       label="アイテム（拡張/検索）" />
            <Tab value="sku"        label="SKU" />
          </Tabs>

          {tab === "department" && (
            <ChipPanel list={depView} selected={selDep} onToggle={(id)=>toggleSet(setSelDep,id)} />
          )}

          {tab === "corner" && (
            <ChipPanel list={corView} selected={selCor} onToggle={(id)=>toggleSet(setSelCor,id)} />
          )}

          {tab === "line" && (
            <ChipPanel list={linView} selected={selLin} onToggle={(id)=>toggleSet(setSelLin,id)} />
          )}

          {tab === "category" && (
            <ChipPanel list={catView} selected={selCat} onToggle={(id)=>toggleSet(setSelCat,id)} />
          )}

          {tab === "item" && (
            <ChipPanel list={itemView} selected={selItem} onToggle={(id)=>toggleSet(setSelItem,id)} hybrid />
          )}

          {tab === "sku" && (
            <ChipPanel list={skuView} selected={selSku} onToggle={(id)=>toggleSet(setSelSku,id)} />
          )}

          {/* 下部サマリ */}
          <Divider sx={{ my: 2 }} />
          <Typography variant="body2" color="text.secondary">
            選択 — 部門:{selDep.size} / コーナー:{selCor.size} / ライン:{selLin.size} /
            カテゴリ:{selCat.size} / アイテム:{selItem.size} / SKU:{selSku.size}
          </Typography>

          {/* アイテム詳細検索モーダル */}
          <Dialog open={open} onClose={()=>setOpen(false)} fullWidth maxWidth="md" aria-labelledby="dialog-title">
            <DialogTitle id="dialog-title">アイテムを検索して追加</DialogTitle>
            <DialogContent dividers>
              <Stack direction={{ xs: "column", sm: "row" }} spacing={1} sx={{ mb: 1 }}>
                <TextField
                  fullWidth autoFocus
                  placeholder="例: Pixel / MacBook"
                  value={q}
                  onChange={(e)=>setQ(e.target.value)}
                  InputProps={{ startAdornment: <span className="material-icons" style={{marginRight:8, opacity:.6}}>search</span> }}
                />
                <Button onClick={()=>setQ("")}>クリア</Button>
              </Stack>
              <ToggleButtonGroup
                value={token}
                exclusive
                onChange={(e,v)=>{ if(v) setToken(v); }}
                size="small"
                sx={{ mb: 1, flexWrap: "wrap" }}
              >
                <ToggleButton value="all">すべて</ToggleButton>
                <ToggleButton value="popular">人気</ToggleButton>
                <ToggleButton value="new">新着</ToggleButton>
              </ToggleButtonGroup>

              <List dense disablePadding>
                {modalItems.map(item => {
                  const checked = selItem.has(item.id);
                  return (
                    <ListItem
                      key={item.id}
                      secondaryAction={<Chip size="small" label={item.tags.length ? item.tags.join(", ") : "—"} variant="outlined" />}
                      sx={{ border: "1px solid #eee", borderRadius: 1, mb: .5 }}
                    >
                      <ListItemIcon sx={{ minWidth: 36 }}>
                        <Checkbox edge="start" checked={checked} tabIndex={-1} onChange={() => toggleSet(setSelItem, item.id)} />
                      </ListItemIcon>
                      <ListItemText primary={item.name} secondary={item.tags.length ? "" : "タグなし"} />
                    </ListItem>
                  );
                })}
              </List>
            </DialogContent>
            <DialogActions>
              <Button onClick={()=>setOpen(false)}>閉じる</Button>
              <Button variant="contained" onClick={()=>setOpen(false)}>適用して閉じる</Button>
            </DialogActions>
          </Dialog>
        </Box>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<App />);
  </script>
</body>
</html>
