<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <title>全角 -> 半角 onBlur/Enter (React + MUI)</title>

    <!-- Roboto フォント & Material Icons -->
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap"
    />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/icon?family=Material+Icons"
    />

    <!-- React, ReactDOM, Babel -->
    <script
      src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js"
      crossorigin
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js"
      crossorigin
    ></script>
    <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.23.8/babel.min.js"></script>

    <!-- Emotion (MUI依存) -->
    <script
      src="https://cdn.jsdelivr.net/npm/@emotion/react@11.11.3/dist/emotion-react.umd.min.js"
      crossorigin
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/@emotion/styled@11.11.0/dist/emotion-styled.umd.min.js"
      crossorigin
    ></script>

    <!-- MUI Core -->
    <script
      src="https://cdn.jsdelivr.net/npm/@mui/material@5.15.3/umd/material-ui.production.min.js"
      crossorigin
    ></script>

    <style>
      body {
        margin: 0;
        font-family: 'Roboto', 'Helvetica', 'Arial', sans-serif;
      }
      #root {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        flex-direction: column;
      }
    </style>
  </head>
  <body>
    <div id="root"></div>
    <!-- Babel による JSX のインラインコンパイル -->
    <script type="text/babel">
      const { Button, TextField, Typography, Paper, Box } = MaterialUI;

      /**
       * 全角数字を半角数字に変換する関数
       * 例: "１２３４" → "1234"
       */
      function convertFullWidthToHalfWidth(str) {
        return str.replace(/[０-９]/g, (ch) =>
          String.fromCharCode(ch.charCodeAt(0) - 0xFEE0)
        );
      }

      function App() {
        const [value, setValue] = React.useState("");
        const [isComposing, setIsComposing] = React.useState(false);

        // IME入力開始時のハンドラー
        const handleCompositionStart = () => {
          setIsComposing(true);
        };

        // IME入力終了時のハンドラー（合成完了時に変換処理を適用）
        const handleCompositionEnd = (e) => {
          setIsComposing(false);
          let newValue = e.target.value;
          newValue = convertFullWidthToHalfWidth(newValue);
          newValue = newValue.replace(/[^0-9]/g, "");
          setValue(newValue);
        };

        // 入力変更時に数値以外を除去する処理を、合成中は実行しない
        const handleChange = (e) => {
          if (!isComposing) {
            let newValue = e.target.value;
            newValue = convertFullWidthToHalfWidth(newValue);
            newValue = newValue.replace(/[^0-9]/g, "");
            setValue(newValue);
          } else {
            // 合成中はそのままの値を一時保存
            setValue(e.target.value);
          }
        };

        // onBlur 時にも最終的な値をチェック（保険として）
        const handleBlur = () => {
          let newValue = convertFullWidthToHalfWidth(value);
          newValue = newValue.replace(/[^0-9]/g, "");
          setValue(newValue);
        };

        // Enter キーが押された場合にも確定（変換＆alert）する
        const handleKeyDown = (event) => {
          if (event.key === "Enter") {
            event.preventDefault();
            let newValue = convertFullWidthToHalfWidth(value);
            newValue = newValue.replace(/[^0-9]/g, "");
            setValue(newValue);
            alert(`現在の値: ${newValue}`);
          }
        };

        return (
          <Paper elevation={3} style={{ padding: 24, textAlign: "center" }}>
            <Typography variant="h5" gutterBottom>
              全角 -> 半角 (onBlur/Enter)
            </Typography>
            <Box mb={2}>
              <TextField
                label="数値を入力"
                variant="outlined"
                value={value}
                onChange={handleChange}
                onBlur={handleBlur}
                onKeyDown={handleKeyDown}
                onCompositionStart={handleCompositionStart}
                onCompositionEnd={handleCompositionEnd}
                // 自動補正等を無効化（主にモバイル向け）
                inputProps={{
                  autoComplete: "off",
                  autoCorrect: "off",
                  autoCapitalize: "off",
                  spellCheck: "false",
                  inputMode: "numeric"
                }}
              />
            </Box>
            <Button
              variant="contained"
              onClick={() => alert(`現在の値: ${value}`)}
            >
              確認
            </Button>
          </Paper>
        );
      }

      const rootElement = document.getElementById("root");
      ReactDOM.render(<App />, rootElement);
    </script>
  </body>
</html>
