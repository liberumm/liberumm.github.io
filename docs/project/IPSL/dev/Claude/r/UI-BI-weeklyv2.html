<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>売上分析 / ダッシュボード（軽量版＋ドリルダウン＋完全レスポンシブ）</title>

  <!-- Fonts / Icons -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap"/>
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons"/>

  <!-- React / Babel / MUI / Chart.js (UMD) -->
  <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js" crossorigin></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.23.8/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mui/material@5.15.3/umd/material-ui.production.min.js" crossorigin></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js" crossorigin></script>

  <style>
    /* ===== レイアウト / スタイル（完全レスポンシブ対応） ===== */
    html,body{margin:0;padding:0;height:100%;font-family:Roboto,sans-serif;background:#f5f7fa}
    #root{height:100%}
    header.masthead{background:#1976d2;color:#fff}
    main{display:flex;flex-direction:column;gap:16px;padding:16px}
    .section-box{background:#fff;border:1px solid rgba(0,0,0,.1);border-radius:14px}
    .soft-bg{background:linear-gradient(180deg,#f8fbff 0%,#f2f5f8 100%)}

    /* Container Query root */
    .page{container-type:inline-size}

    /* テーブル */
    .table-wrap{overflow:auto;border-top:1px solid rgba(0,0,0,.08);max-height:min(560px,58dvh)}
    @supports not (height: 1dvh){
      .table-wrap{max-height:min(560px,58vh)}
    }
    table.tbl{border-collapse:separate;border-spacing:0;width:100%;background:#fff;min-width:1080px}
    .tbl th,.tbl td{border-right:1px solid #e0e0e0;border-bottom:1px solid #e0e0e0;padding:6px 8px;font-size:12px;white-space:nowrap}
    .tbl thead th{background:#e9f1ff;color:#333;font-weight:600;text-align:center;position:sticky;top:0;z-index:3}
    .tbl thead tr.group th{background:#dbe8ff}
    /* 2段目ヘッダのstickyずれ対策 */
    .tbl thead tr:nth-child(2) th{top:34px;line-height:34px;height:34px;z-index:3}
    .tbl tbody tr:nth-child(odd){background:#fafcff}
    .tbl tbody tr:hover{background:#f3f8ff}
    .sticky{position:sticky;left:0;background:#fff;z-index:4}
    tbody tr:nth-child(odd) .sticky{background:#fafcff}
    tbody tr:hover .sticky{background:#f3f8ff}
    thead .sticky{background:#dbe8ff!important}
    .subtotal{background:#fff9e6!important;font-weight:700}
    .total{background:#eaf7ea!important;font-weight:800}

    .pill{display:inline-flex;gap:8px}
    .pill>button{border:1px solid #cfd8dc;border-radius:999px;padding:6px 12px;background:#f8fafc;color:#1565c0;font-weight:500;cursor:pointer}
    .pill>button.on{background:#fff;box-shadow:0 1px 2px rgba(0,0,0,.08)}

    .kpi-grid .kpi{padding:12px;text-align:left}
    .kpi .h{display:flex;align-items:center;gap:6px;color:#607d8b;font-size:12px}
    .kpi .h .material-icons{font-size:18px}
    .kpi .v{font-weight:800;font-size:24px;line-height:1.1}
    .kpi .delta{font-size:12px;font-weight:700}
    .kpi .delta.pos{color:#2e7d32}
    .kpi .delta.neg{color:#d32f2f}
    .kpi .sub{color:#78909c;font-size:11px}

    .drill{cursor:pointer}
    .drill:after{content:' ▶';font-size:11px;color:#78909c}

    /* ===== スモール端末（< 900px） ===== */
    @media(max-width:900px){
      main{padding:8px;gap:8px}
      .section-box{border-radius:12px}
      .tbl th,.tbl td{padding:4px 6px;font-size:11px}
      .pill{flex-wrap:wrap;row-gap:6px}
      .table-wrap{max-height:calc(100dvh - 320px)}
      table.tbl{min-width:960px}
    }

    /* ===== モバイル（< 720px）で列を間引く ===== */
    /* data-g 属性でグループを制御（必要に応じて調整可） */
    @media(max-width:720px){
      /* B001/A001 共通で優先度の低いグループは非表示 */
      [data-g="promo"],
      [data-g="flyer"],
      [data-g="init"],
      [data-g="loss"],
      [data-g="qty"],
      [data-g="price"],
      [data-g="impact"],
      [data-g="exist"],
      [data-g="valuein"],
      [data-g="win"],
      [data-g="gp"]{display:none}
      table.tbl{min-width:640px}
      .kpi .v{font-size:20px}
    }

    /* ===== 極小端末（< 360px）微調整 ===== */
    @media(max-width:360px){
      .tbl th,.tbl td{font-size:10px}
      .kpi .v{font-size:18px}
    }

    /* ===== コンテナクエリ版（.page の表示領域に追従） ===== */
    @container (max-width:900px){
      .section-box{border-radius:12px}
      .tbl th,.tbl td{padding:4px 6px;font-size:11px}
      .pill{flex-wrap:wrap;row-gap:6px}
      .table-wrap{max-height:calc(100dvh - 320px)}
    }
    @container (max-width:720px){
      [data-g="promo"],
      [data-g="flyer"],
      [data-g="init"],
      [data-g="loss"],
      [data-g="qty"],
      [data-g="price"],
      [data-g="impact"],
      [data-g="exist"],
      [data-g="valuein"],
      [data-g="win"],
      [data-g="gp"]{display:none}
      table.tbl{min-width:640px}
      .kpi .v{font-size:20px}
    }
    @container (max-width:360px){
      .tbl th,.tbl td{font-size:10px}
      .kpi .v{font-size:18px}
    }

    /* ===== ワイド端末（>= 1200px） ===== */
    @media(min-width:1200px){.page{max-width:100%!important;padding-left:0!important;padding-right:0!important}}
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    // =============================================================
    // 完全レスポンシブ化＆不具合修正版
    // - data-g 属性で列グループを識別し、ブレークポイントでの表示/非表示を制御
    // - 小計切替時の key 衝突を回避（安定 id）
    // - 再計算のメモ化で軽量化
    // =============================================================
    const {AppBar,Toolbar,Typography,Box,Container,Grid,Paper,TextField,MenuItem,Button,FormGroup,FormControlLabel,Checkbox,Chip,Stack,Tooltip,RadioGroup,Radio,ToggleButtonGroup,ToggleButton,Switch,ThemeProvider,createTheme,Snackbar} = MaterialUI;

    /* ===== テーマ ===== */
    const theme = createTheme({
      palette:{primary:{main:'#1976d2'},success:{main:'#2e7d32'},warning:{main:'#ff8a00'},background:{default:'#f5f7fa'}},
      shape:{borderRadius:14},
      components:{MuiPaper:{styleOverrides:{root:{borderRadius:14}}},MuiButton:{styleOverrides:{root:{borderRadius:12,textTransform:'none'}}},MuiChip:{styleOverrides:{root:{borderRadius:10}}}}
    });

    /* ===== マスター / 共通 ===== */
    const STORES=[{value:'079',label:'079) ○○南青山店'},{value:'350',label:'350) 三軒茶屋店'},{value:'999',label:'999) 全店'}];
    const DEPTS=[{value:'総菜',label:'総菜'},{value:'ベーカリー',label:'ベーカリー'},{value:'精肉',label:'精肉'}];
    const UNITS=[{value:'千円未満四捨五入',label:'千円未満四捨五入'},{value:'円単位',label:'円単位'},{value:'百円未満四捨五入',label:'百円未満四捨五入'}];
    const HIER=[{value:'corner',label:'コーナー'},{value:'line',label:'ライン'},{value:'category',label:'カテゴリ'},{value:'item',label:'アイテム'}];
    const NEXT_OF={corner:'line',line:'category',category:'item',item:null};
    const PARENT={line:null,corner:'line',category:'corner',item:'category'};
    const ROWS=5000, SEED=42;

    /* ===== 日付 util ===== */
    const WD=['日','月','火','水','木','金','土'];
    const dHead=d=>`${d.getFullYear()}年${String(d.getMonth()+1).padStart(2,'0')}月${String(d.getDate()).padStart(2,'0')}日（${WD[d.getDay()]}）`;
    const startISO=d=>{const x=new Date(d),w=(x.getDay()+6)%7;x.setDate(x.getDate()-w);x.setHours(0,0,0,0);return x};
    const getISOWeek=d=>{const x=new Date(Date.UTC(d.getFullYear(),d.getMonth(),d.getDate()));const w=(x.getUTCDay()+6)%7; x.setUTCDate(x.getUTCDate()-w+3); const t=new Date(Date.UTC(x.getUTCFullYear(),0,4)); return 1+Math.round((x-t)/(7*24*3600*1000))};
    const fmtShort=d=>`${d.getFullYear()}/${String(d.getMonth()+1).padStart(2,'0')}/${String(d.getDate()).padStart(2,'0')}(${WD[d.getDay()]})`;
    const makeWeekOpts=(n=54,base=new Date())=>{const o=[],m=startISO(base);for(let i=0;i<n;i++){const mon=new Date(m);mon.setDate(mon.getDate()-7*i);const iso=String(getISOWeek(mon)).padStart(2,'0');o.push({value:`W${iso}-${mon.toISOString()}`,label:`${iso}週:${fmtShort(mon)}`})}return o};
    const makeMonthOpts=(n=25,base=new Date())=>{const o=[],y=base.getFullYear(),m=base.getMonth();for(let i=0;i<n;i++){const d=new Date(y,m-i,1),lbl=i?`${d.getFullYear()}/${String(d.getMonth()+1).padStart(2,'0')}`:'当月';o.push({value:`M${d.getFullYear()}-${d.getMonth()+1}`,label:lbl})}return o};

    /* ===== 疑似データ ===== */
    const rng32=a=>()=>{let t=a+=0x6D2B79F5;t=Math.imul(t^t>>>15,t|1);t^=t+Math.imul(t^t>>>7,t|61);return((t^t>>>14)>>>0)/4294967296};
    const r=(rng,min,max)=>min+(max-min)*rng();
    const makeData=(n=ROWS,seed=SEED)=>{const rng=rng32(seed);const corners=['惣菜','お弁当','ホットメン','デリ・イタチ','ベーカリー','精肉','青果','鮮魚','日配','グロサリー'];const lines=['和日配','洋日配','惣菜','グロサリー','生鮮','非食品','日配','日用雑貨'];const cats=Array.from({length:12},(_,i)=>`カテゴリ${i+1}`);const items=Array.from({length:40},(_,i)=>`SKU-${1000+i}`);const a=[];for(let i=0;i<n;i++){const line=lines[i%lines.length],corner=corners[(i*3)%corners.length],category=cats[(i*5)%cats.length],item=`${items[(i*7)%items.length]}-${String(i%100).padStart(2,'0')}`;const idx=(i%8)+1;const gC=Math.round(r(rng,2000,200000)), yoy=r(rng,0.88,1.12), gP=Math.max(100,Math.round(gC/yoy)); const lrP=r(rng,0.03,0.10), lrC=Math.min(0.20,Math.max(0.005,lrP+r(rng,-0.02,0.02))), Lp=Math.round(gP*lrP), Lc=Math.round(gC*lrC); const md=r(rng,0.01,0.08), ws=r(rng,0.005,0.03); const pC=r(rng,120,600), pP=pC*r(rng,0.9,1.1), qC=Math.max(1,Math.round(gC/pC)), qP=Math.max(1,Math.round(gP/pP)); const prT=!(i%4), prP=!(i%5); const flyer=prT>0, exW=0.98+(Array.from(line).reduce((a,c)=>a+c.charCodeAt(0),0)%5)*0.01; a.push({id:i+1,line,corner,category,item,periodIndex:idx,grossCurr:gC,grossPrev:gP,lossCurr:Lc,lossPrev:Lp,markdownRate:md,wasteRate:ws,qtyCurr:qC,qtyPrev:qP,priceCurr:pC,pricePrev:pP,promoThis:+prT,promoPrev:+prP,flyer,existWeight:exW})}return a};

    /* ===== 集計 ===== */
    const H=h=>{let x=0;for(let i=0;i<h.length;i++)x=((x<<5)-x)+h.charCodeAt(i)|0;return x};

    const agg=(data,{flt,level,addSub,winOnly})=>{
      const f=data.filter(x=>(!flt.line||x.line===flt.line)&&(!flt.corner||x.corner===flt.corner)&&(!flt.category||x.category===flt.category));
      const tot=f.reduce((a,x)=>({gC:a.gC+x.grossCurr,gP:a.gP+x.grossPrev,eG:a.eG+x.grossCurr*x.existWeight,lC:a.lC+x.lossCurr,lP:a.lP+x.lossPrev,qC:a.qC+x.qtyCurr,qP:a.qP+x.qtyPrev}),{gC:0,gP:0,eG:0,lC:0,lP:0,qC:0,qP:0});
      const key=x=>level==='line'?x.line:level==='corner'?x.corner:level==='category'?x.category:x.item; const parent=x=>{const p=PARENT[level];return p==='line'?x.line:p==='corner'?x.corner:p==='category'?x.category:null};
      const m=new Map();
      for(const x of f){const k=key(x),p=parent(x); if(!m.has(k))m.set(k,{k,p,gC:0,gP:0,lC:0,lP:0,eG:0,md:0,ws:0,wG:0,qC:0,qP:0,prT:0,prP:0}); const g=m.get(k); g.gC+=x.grossCurr; g.gP+=x.grossPrev; g.lC+=x.lossCurr; g.lP+=x.lossPrev; g.eG+=x.grossCurr*x.existWeight; g.md+=x.markdownRate*x.grossCurr; g.ws+=x.wasteRate*x.grossCurr; g.wG+=x.grossCurr; g.qC+=x.qtyCurr; g.qP+=x.qtyPrev; g.prT+=x.promoThis; g.prP+=x.promoPrev }

      let rows=[...m.values()].map((g)=>{const compS=tot.gC?g.gC/tot.gC*100:0, compE=tot.eG?g.eG/tot.eG*100:0, yoy=g.gP?g.gC/g.gP*100:100, cLR=g.gC?g.lC/g.gC*100:0, pLR=g.gP?g.lP/g.gP*100:cLR, md=g.wG?g.md/g.wG*100:0, ws=g.wG?g.ws/g.wG*100:0, loss=md+ws, gpC=g.gC-g.lC, gpP=g.gP-g.lP, gpRC=g.gC?gpC/g.gC*100:0, gpRP=g.gP?gpP/g.gP*100:0, mC=gpRC+md+ws, mP=gpRP+md+ws, qYY=g.qP?g.qC/g.qP*100:100, prC=g.qC?g.gC/g.qC:0, prP=g.qP?g.gP/g.qP:prC, prYY=prP?prC/prP*100:100; return {
        id:`row_${level}_${g.k}`,
        name:g.k,parent:g.p,code:'C'+(Math.abs(H(g.k))%9999).toString().padStart(4,'0'),
        win:yoy>=100?'○':'●',win2:cLR<=pLR?'○':'●',
        comp_self:+compS.toFixed(1),comp_exist:+compE.toFixed(1),yoy_self:+yoy.toFixed(1),yoy_exist:+yoy.toFixed(1),
        grossCurr:g.gC,grossPrev:g.gP,deltaGross:g.gC-g.gP,gpCurr:gpC,gpPrev:gpP,
        gpRateCurr:+gpRC.toFixed(1),gpRatePrev:+gpRP.toFixed(1),gpRateDiff:+(gpRC-gpRP).toFixed(1),
        initMarginCurr:+mC.toFixed(1),initMarginPrev:+mP.toFixed(1),initMarginDiff:+(mC-mP).toFixed(1),
        currLossRate:+cLR.toFixed(1),prevLossRate:+pLR.toFixed(1),markdownRate:+md.toFixed(1),wasteRate:+ws.toFixed(1),
        lossSumRate:+loss.toFixed(1),lossDiff:+(loss-pLR).toFixed(1),
        qtyCurr:g.qC,qtyPrev:g.qP,qtyYoY:+qYY.toFixed(1),priceCurr:+prC.toFixed(1),priceYoY:+prYY.toFixed(1),
        existGross:g.eG,promoThis:g.prT,promoPrev:g.prP,flyer:g.prT>0?'有':'無',impact:+(((yoy-100)*compS/100).toFixed(1))
      };});

      if(winOnly) rows=rows.filter(r=>r.win==='○');

      const par=PARENT[level]; let out=rows; if(addSub&&par){
        const g=new Map(); for(const r of rows){const p=r.parent||'（親未設定）'; if(!g.has(p))g.set(p,[]); g.get(p).push(r)}
        out=[]; for(const [p,arr] of g.entries()){
          const s=arr.reduce((a,x)=>({gC:a.gC+x.grossCurr,gP:a.gP+x.grossPrev,gpC:a.gpC+x.gpCurr,gpP:a.gpP+x.gpPrev,qC:a.qC+x.qtyCurr,qP:a.qP+x.qtyPrev}),{gC:0,gP:0,gpC:0,gpP:0,qC:0,qP:0});
          const yoy=s.gP?+((s.gC/s.gP)*100).toFixed(1):100, prC=s.qC?+(s.gC/s.qC).toFixed(1):0, prP=s.qP?+(s.gP/s.qP).toFixed(1):0, prYY=prP?+((prC/prP)*100).toFixed(1):100;
          out.push({
            id:`sub_${level}_${p}`,
            name:`◆ ${p} 小計`,code:'-',parent:null,win:'-',comp_self:'-',comp_exist:'-',yoy_self:yoy,yoy_exist:'-',
            grossCurr:s.gC,grossPrev:s.gP,deltaGross:s.gC-s.gP,gpCurr:s.gpC,gpPrev:s.gpP,
            gpRateCurr:'-',gpRatePrev:'-',gpRateDiff:'-',initMarginCurr:'-',initMarginPrev:'-',initMarginDiff:'-',
            currLossRate:'-',prevLossRate:'-',markdownRate:'-',wasteRate:'-',lossSumRate:'-',lossDiff:'-',
            qtyCurr:s.qC,qtyPrev:s.qP,qtyYoY:s.qP?+((s.qC/s.qP*100).toFixed(1)):100,priceCurr:prC,priceYoY:prYY,
            existGross:'-',promoThis:'-',promoPrev:'-',flyer:'-',impact:'-',win2:'-',_subtotal:true
          },...arr)
        }
      }

      const gpC=tot.gC-tot.lC, gpP=tot.gP-tot.lP, prC=tot.qC?tot.gC/tot.qC:0, prP=tot.qP?tot.gP/tot.qP:0;
      const total={id:'total',name:'総計',code:'-',win:'-',comp_self:100,comp_exist:100,yoy_self:tot.gP?+((tot.gC/tot.gP)*100).toFixed(1):100,yoy_exist:'-',grossCurr:tot.gC,grossPrev:tot.gP,deltaGross:tot.gC-tot.gP,gpCurr:gpC,gpPrev:gpP,gpRateCurr:tot.gC?+((gpC/tot.gC*100).toFixed(1)):0,gpRatePrev:tot.gP?+((gpP/tot.gP*100).toFixed(1)):0,gpRateDiff:'-',initMarginCurr:'-',initMarginPrev:'-',initMarginDiff:'-',currLossRate:tot.gC?+((tot.lC/tot.gC*100).toFixed(1)):0,prevLossRate:tot.gP?+((tot.lP/tot.gP*100).toFixed(1)):0,markdownRate:'-',wasteRate:'-',lossSumRate:'-',lossDiff:'-',qtyCurr:tot.qC,qtyPrev:tot.qP,qtyYoY:tot.qP?+((tot.qC/tot.qP*100).toFixed(1)):100,priceCurr:+prC.toFixed(1),priceYoY: prP?+((prC/prP)*100).toFixed(1):100,existGross:'-',promoThis:'-',promoPrev:'-',flyer:'-',impact:'-',win2:'-',_total:true};
      return {rows:[total,...out]};
    };

    /* ===== CSV ===== */
    const toCsv=(rows,heads,pick)=>{const csv=[heads.join(',') , ...rows.map(r=>pick(r).join(','))].join('');const bom=new Uint8Array([0xEF,0xBB,0xBF]);const blob=new Blob([bom,csv],{type:'text/csv;charset=utf-8;'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download='売上分析_集計.csv';a.click();URL.revokeObjectURL(url)};

    /* ===== 共通UI ===== */
    const HeadCard=({title})=> (
      <Paper elevation={0} className="section-box" sx={{p:1.25,mb:2,display:'flex',alignItems:'center',gap:1}}>
        <Chip size="small" color="success" label="サミット"/>
        <Typography variant="h6" fontWeight={700}>{title}</Typography>
        <Typography sx={{ml:1,color:'text.secondary'}}>ウィークリーチェンジ 1.0.0.2</Typography>
        <Box sx={{flexGrow:1}}/>
        <Typography sx={{color:'text.secondary'}}>{dHead(new Date())}</Typography>
      </Paper>
    );

    const Section=({title,children,right=null})=> (
      <Paper className="soft-bg section-box" elevation={1} sx={{p:2,mb:2}}>
        <Stack direction="row" alignItems="center" justifyContent="space-between" sx={{mb:1}}>
          <Typography variant="h6" fontWeight={700}>{title}</Typography>
          {right ?? <Button size="small" variant="outlined" startIcon={<span className="material-icons">help_outline</span>}>ヘルプ</Button>}
        </Stack>
        {children}
      </Paper>
    );

    const UtilityExit=({onExit,show=true})=>{const [open,setOpen]=React.useState(false); React.useEffect(()=>{const h=e=>{if(e.key==='Escape'){setOpen(true);onExit?.()}};window.addEventListener('keydown',h);return()=>window.removeEventListener('keydown',h)},[onExit]); return (
      <Paper className="section-box" elevation={1} sx={{p:2}}>
        {show&& (
          <Stack spacing={1} sx={{mb:2}}>
            <Typography variant="subtitle1" fontWeight={700}>ユーティリティ</Typography>
            <Stack direction={{xs:'column',sm:'row'}} spacing={1}>
              <Button variant="outlined" startIcon={<span className="material-icons">edit_note</span>}>補填額入力</Button>
              <Button variant="outlined" startIcon={<span className="material-icons">timeline</span>}>週間粗利修正</Button>
              <Button variant="outlined" startIcon={<span className="material-icons">calendar_month</span>}>月間粗利修正</Button>
            </Stack>
          </Stack>
        )}
        <Button fullWidth size="large" variant="contained" color="warning" startIcon={<span className="material-icons">logout</span>} onClick={()=>{setOpen(true);onExit?.()}} sx={{fontWeight:800}}>終了（ESC）</Button>
        <Snackbar open={open} autoHideDuration={1800} onClose={()=>setOpen(false)} message="終了しました（デモ）" />
      </Paper>
    )};

    const Pills=({val,onChange})=> (
      <div className="pill" role="tablist" aria-label="テーブル階層選択">
        {HIER.map(h=> <button key={h.value} className={val===h.value?'on':''} role="tab" aria-selected={val===h.value} onClick={()=>onChange(h.value)}>{h.label}</button>)}
      </div>
    );

    const KPIs=({sum,yoy,loss,prevLoss=loss,deltaGross=0,win})=>{
      const money=n=>n>=1_0000_0000?(n/1_0000_0000).toFixed(2)+'億':n>=1_0000?(n/1_0000).toFixed(2)+'万':Number(n||0).toLocaleString('ja-JP');
      const sign=(v)=> (v>0?'+':'') + (Number.isFinite(v)?Number(Math.abs(v)).toFixed(1):v);
      const signMoney=(v)=> (v>0?'+':'') + money(Math.abs(v));
      const arrow=v=> v>0?'▲':(v<0?'▼':'■');
      const cls=(v,goodWhenPositive=true)=> goodWhenPositive ? (v>=0?'pos':'neg') : (v<=0?'pos':'neg');
      const yoyDelta = Number((Number(yoy??100) - 100).toFixed(1));
      const lossDelta = Number((Number(loss??0) - Number(prevLoss??0)).toFixed(1));
      const dg = Number(deltaGross||0);
      return (
        <Grid container spacing={1} className="kpi-grid">
          <Grid item xs={12} sm={6} md={3}>
            <Paper className="kpi" elevation={1}>
              <div className="h"><span className="material-icons" aria-hidden>attach_money</span><span>売上合計</span></div>
              <div className="v">{money(sum)} 円</div>
              <div className={`delta ${dg>=0?'pos':'neg'}`}>{arrow(dg)} {signMoney(dg)} 円</div>
              <div className="sub">前年差異</div>
            </Paper>
          </Grid>
          <Grid item xs={12} sm={6} md={3}>
            <Paper className="kpi" elevation={1}>
              <div className="h"><span className="material-icons" aria-hidden>trending_up</span><span>前年比（総計）</span></div>
              <div className="v">{Number(yoy??100).toFixed(1)}%</div>
              <div className={`delta ${cls(yoyDelta,true)}`}>{arrow(yoyDelta)} {sign(yoyDelta)} pt</div>
              <div className="sub">基準: 100%</div>
            </Paper>
          </Grid>
          <Grid item xs={12} sm={6} md={3}>
            <Paper className="kpi" elevation={1}>
              <div className="h"><span className="material-icons" aria-hidden>warning_amber</span><span>当年ロス率</span></div>
              <div className="v">{Number(loss??0).toFixed(1)}%</div>
              <div className={`delta ${cls(lossDelta,false)}`}>{arrow(lossDelta)} {sign(lossDelta)} pt</div>
              <div className="sub">前年: {Number(prevLoss??0).toFixed(1)}%</div>
            </Paper>
          </Grid>
          <Grid item xs={12} sm={6} md={3}>
            <Paper className="kpi" elevation={1}>
              <div className="h"><span className="material-icons" aria-hidden>emoji_events</span><span>勝ち（○）</span></div>
              <div className="v">{Number(win??0)}</div>
              <div className="sub">○ = 前年比100%以上</div>
            </Paper>
          </Grid>
        </Grid>
      )
    };

    /* ===== 列スキーマ（動的見出しラベル＋グループキー） ===== */
    const firstLabel=(level)=> (HIER.find(h=>h.value===level)?.label || 'コーナー');

    // ★ CSSで制御しやすいように key を付与
    const baseB001=[
      {key:'dim',label:'DIM',cols:[{key:'name',label:'DIM',sticky:true,align:'left',drill:true},{key:'code',label:'ｺｰﾄﾞ',align:'left'}]},
      {key:'promo',label:'特売回数',cols:[{key:'promoThis',label:'当年'},{key:'promoPrev',label:'前年'}]},
      {key:'flyer',label:'チラシ',cols:[{key:'flyer',label:' '}]},
      {key:'sales',label:'売上',cols:[
        {key:'comp_self',label:'構成比(自店)',fmt:v=>v.toFixed?.(1)+'%'},
        {key:'comp_exist',label:'構成比(既存店)',fmt:v=>v.toFixed?.(1)+'%'},
        {key:'synergy',label:'相乗比',derive:r=>r.comp_exist>0?(r.comp_self/r.comp_exist*100):100,fmt:v=>v.toFixed(1)},
        {key:'grossCurr',label:'金額',fmt:v=>Number(v).toLocaleString('ja-JP'),drill:true},
        {key:'yoy_self',label:'前年比',fmt:v=>v.toFixed?.(1)+'%'},
        {key:'deltaGross',label:'前年差異',fmt:v=>Number(v).toLocaleString('ja-JP')}
      ]},
      {key:'gp',label:'見込粗利',cols:[
        {key:'gpCurr',label:'粗利高',fmt:v=>Number(v).toLocaleString('ja-JP')},
        {key:'gpRateCurr',label:'率',fmt:v=>v.toFixed?.(1)+'%'},
        {key:'gpRateYoY',label:'前年比',derive:r=>r.gpRatePrev>0?(r.gpRateCurr/r.gpRatePrev*100):100,fmt:v=>v.toFixed(1)+'%'},
        {key:'gpRateDiff',label:'差異',fmt:v=>typeof v==='number'?v.toFixed(1):v}
      ]},
      {key:'init',label:'値入（調整前）',cols:[
        {key:'initMarginCurr',label:'値入率',fmt:v=>typeof v==='number'?v.toFixed(1)+'%':v},
        {key:'initMarginDiff',label:'差異',fmt:v=>typeof v==='number'?v.toFixed(1):v}
      ]},
      {key:'loss',label:'ロス（率）',cols:[
        {key:'markdownRate',label:'値下率',fmt:v=>v.toFixed?.(1)+'%'},
        {key:'wasteRate',label:'廃棄率',fmt:v=>v.toFixed?.(1)+'%'},
        {key:'lossSumRate',label:'ロス率計',fmt:v=>v.toFixed?.(1)+'%'},
        {key:'lossDiff',label:'差異',fmt:v=>typeof v==='number'?v.toFixed(1)+'%':v}
      ]},
      {key:'qty',label:'数量',cols:[{key:'qtyCurr',label:'当年',fmt:v=>Number(v).toLocaleString('ja-JP')},{key:'qtyYoY',label:'前年比',fmt:v=>v.toFixed?.(1)+'%'}]},
      {key:'price',label:'平均単価',cols:[{key:'priceCurr',label:'当年',fmt:v=>Number(v).toLocaleString('ja-JP')},{key:'priceYoY',label:'前年比',fmt:v=>v.toFixed?.(1)+'%'}]},
    ];

    const baseA001=[
      {key:'no',label:'NO',cols:[{key:'rowNo',label:'NO'}]},
      {key:'dim',label:'DIM',cols:[{key:'name',label:'DIM',sticky:true,align:'left',drill:true}]},
      {key:'win',label:'売上',cols:[{key:'win',label:'勝　敗',align:'center'}]},
      {key:'impact',label:'影響度',cols:[{key:'impact',label:'影響度',fmt:v=>typeof v==='number'?v.toFixed(1):v}]},
      {key:'yoyex',label:'売上前年比',cols:[{key:'yoy_exist',label:'既存店',fmt:v=>typeof v==='number'?v.toFixed(1)+'%':v},{key:'yoyDiff',label:'差異',derive:r=>typeof r.yoy_exist==='number'?r.yoy_exist-100:0,fmt:v=>v.toFixed(1)}]},
      {key:'comp',label:'構成比',cols:[{key:'comp_self',label:'構成比',fmt:v=>v.toFixed?.(1)+'%'}]},
      {key:'self',label:'自店 = 久我山店（売上/数量）',cols:[
        {key:'grossCurr',label:'当年売上',fmt:v=>Number(v).toLocaleString('ja-JP'),drill:true},
        {key:'yoy_self',label:'前年比',fmt:v=>v.toFixed?.(1)+'%'},
        {key:'deltaGross',label:'差異',fmt:v=>Number(v).toLocaleString('ja-JP')},
        {key:'qtyCurr',label:'当年数量',fmt:v=>Number(v).toLocaleString('ja-JP')},
        {key:'qtyYoY',label:'数量前年比',fmt:v=>v.toFixed?.(1)+'%'}
      ]},
      {key:'exist',label:'既存店平均',cols:[
        {key:'existGross',label:'当年売上',fmt:v=>typeof v==='number'?Math.round(v).toLocaleString('ja-JP'):v},
        {key:'existQty',label:'当年数量',derive:r=>r.priceCurr>0?Math.round(r.existGross/r.priceCurr):0,fmt:v=>Number(v).toLocaleString('ja-JP')},
        {key:'diffVsExist',label:'差異',derive:r=>r.grossCurr-(typeof r.existGross==='number'?r.existGross:0),fmt:v=>Number(v).toLocaleString('ja-JP')}
      ]},
      {key:'gp',label:'自店（見込粗利）',cols:[
        {key:'gpCurr',label:'見込粗利',fmt:v=>Number(v).toLocaleString('ja-JP')},
        {key:'gpDelta',label:'差異',derive:r=>r.gpCurr-r.gpPrev,fmt:v=>Number(v).toLocaleString('ja-JP')},
        {key:'gpRatePrev',label:'前年粗利率',fmt:v=>typeof v==='number'?v.toFixed(1)+'%':v},
        {key:'gpRateDiff',label:'差異',fmt:v=>typeof v==='number'?v.toFixed(1):v}
      ]},
      {key:'valuein',label:'値入',cols:[
        {key:'valueInNow',label:'値入高',derive:r=>Math.round(r.grossCurr*(r.initMarginCurr/100)),fmt:v=>Number(v).toLocaleString('ja-JP')},
        {key:'valueInPrev',label:'前年高',derive:r=>Math.round(r.grossPrev*(r.initMarginPrev/100)),fmt:v=>Number(v).toLocaleString('ja-JP')}
      ]},
    ];

    const makeGroups=(schema,level)=>{
      const src = (schema==='A001'? baseA001: baseB001).map(g=>({key:g.key,label:g.label, cols:g.cols.map(c=>({...c}))}));
      const flabel = firstLabel(level);
      const idx = schema==='A001'?1:0;
      src[idx].label = flabel;
      src[idx].cols = src[idx].cols.map((c,i)=> i===0? {...c,label:flabel}: c);
      return src;
    };

    /* ===== テーブル ===== */
    const TableView=({rows,sch,level,onDrill})=>{const G=React.useMemo(()=>makeGroups(sch,level),[sch,level]); const body=rows.map((r,i)=>({...r,rowNo:r._total?'':(r._subtotal?'':i)})); const canDrill=(r)=>!r._total && !r._subtotal && NEXT_OF[level]; return (
      <div className="table-wrap">
        <table className="tbl" role="table" aria-label="集計表（可変スキーマ＋ドリルダウン）">
          <thead>
            <tr className="group">{G.map((g,gi)=>(<th key={gi} data-g={g.key} colSpan={g.cols.length} className={g.cols[0].sticky?'sticky':''} style={{background:'#dbe8ff',zIndex:4}}>{g.label}</th>))}</tr>
            <tr>{G.flatMap(g=>g.cols.map((c,ci)=>(<th key={g.label+'_'+ci} data-g={g.key} className={c.sticky?'sticky':''} style={{textAlign:'center'}}>{c.label}</th>)))}</tr>
          </thead>
          <tbody>
            {body.map(r=>{const cls=r._total?'total':r._subtotal?'subtotal':''; return (
              <tr key={r.id} className={cls}>
                {G.flatMap(g=>g.cols.map(c=>{let v=typeof c.derive==='function'?c.derive(r):r[c.key]; if(typeof c.fmt==='function') v=c.fmt(v); const isNum=!isNaN(Number(String(v).replace(/[,％%]/g,''))); const click = (c.drill && canDrill(r))? ()=>onDrill(r.name): null; const style={textAlign:c.align||(isNum?'right':(c.key==='name'?'left':'right')),fontWeight:r._total?800:r._subtotal?700:500,cursor:click?'pointer':'inherit'}; return <td key={r.id+'_'+c.key} data-g={g.key} className={(c.sticky?'sticky ':'')+(click?'drill':'')} style={style} onClick={click}>{c.key==='name'?r.name:v}</td>}))}
              </tr>
            )})}
            {Array.from({length:6}).map((_,i)=>(<tr key={'e-'+i}>{G.flatMap(g=>g.cols.map((_,j)=>(<td key={g.label+'-'+i+'-'+j} data-g={g.key}>&nbsp;</td>)))}</tr>))}
          </tbody>
        </table>
      </div>
    )};

    /* ===== チャート ===== */
    const Charts=({data,flt,level,period,sch})=>{const trendRef=React.useRef(null), topRef=React.useRef(null); const trend=React.useRef(null), top=React.useRef(null);
      const labels=React.useMemo(()=>period==='week'?Array.from({length:8},(_,i)=>`${i+1}週`):Array.from({length:6},(_,i)=>`${i+1}月`),[period]);
      const filtered=React.useMemo(()=>data.filter(x=>(!flt.line||x.line===flt.line)&&(!flt.corner||x.corner===flt.corner)&&(!flt.category||x.category===flt.category)),[data,flt.line,flt.corner,flt.category]);
      const max=period==='week'?8:6; const by=React.useCallback((fn)=>Array.from({length:max},(_,i)=>{const idx=i+1;return filtered.filter(x=>(((x.periodIndex-1)%max)+1)===idx).reduce((a,t)=>a+fn(t),0)}),[filtered,max]);
      const trGross=by(t=>t.grossCurr), trGP=by(t=>t.grossCurr-t.lossCurr);
      const tot=React.useMemo(()=>filtered.reduce((a,t)=>a+t.grossCurr,0)||1,[filtered]); const getKey=React.useCallback(x=>level==='line'?x.line:level==='corner'?x.corner:level==='category'?x.category:x.item,[level]);
      const ranked=React.useMemo(()=>{const g=new Map(); for(const x of filtered){const k=getKey(x); if(!g.has(k))g.set(k,{g:0,p:0}); const o=g.get(k); o.g+=x.grossCurr; o.p+=x.grossPrev}
        const list=[...g.entries()].map(([name,v])=>{const yoy=v.p?(v.g/v.p)*100:100, comp=v.g/tot*100, impact=((yoy-100)*comp)/100; return {name,gross:v.g,yoy,comp,impact}});
        return (sch==='A001'?list.sort((a,b)=>b.impact-a.impact):list.sort((a,b)=>b.gross-a.gross)).slice(0,10);
      },[filtered,getKey,sch,tot]);

      React.useEffect(()=>{
        if(trend.current){trend.current.destroy();trend.current=null} if(top.current){top.current.destroy();top.current=null}
        trend.current=new Chart(trendRef.current,{type:'line',data:{labels,datasets:[{label:'売上',data:trGross},...(sch==='A001'?[{label:'見込粗利',data:trGP}]:[])]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:true}},scales:{y:{beginAtZero:true}}}});
        top.current=new Chart(topRef.current,{type:'bar',data:{labels:ranked.map(r=>r.name),datasets:[{label:sch==='A001'?'影響度':'売上',data:(sch==='A001'?ranked.map(r=>+r.impact.toFixed(1)):ranked.map(r=>r.gross))}]},options:{indexAxis:'y',responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{x:{beginAtZero:true}}}});
        return()=>{if(trend.current)trend.current.destroy(); if(top.current)top.current.destroy()};
      },[sch,labels,JSON.stringify(trGross),JSON.stringify(trGP),JSON.stringify(ranked.map(r=>({n:r.name,v:sch==='A001'?r.impact:r.gross})))]);

      return (
        <Grid container spacing={2}>
          <Grid item xs={12} md={6}>
            <Paper className="section-box" elevation={0} style={{height:'clamp(220px, 38dvh, 360px)',padding:8}}>
              <Typography variant="subtitle2" sx={{px:1,pt:1,pb:.5}}>期間トレンド（{sch==='A001'?'売上 / 見込粗利':'売上'}）</Typography>
              <div style={{height:'calc(100% - 32px)'}}><canvas ref={trendRef}/></div>
            </Paper>
          </Grid>
          <Grid item xs={12} md={6}>
            <Paper className="section-box" elevation={0} style={{height:'clamp(220px, 38dvh, 360px)',padding:8}}>
              <Typography variant="subtitle2" sx={{px:1,pt:1,pb:.5}}>Top10（{sch==='A001'?'影響度':'売上'} / {level==='line'?'ライン':level==='corner'?'コーナー':level==='category'?'カテゴリ':'アイテム'}）</Typography>
              <div style={{height:'calc(100% - 32px)'}}><canvas ref={topRef}/></div>
            </Paper>
          </Grid>
        </Grid>
      )};

    /* ===== メニュー（A/B共通） ===== */
    const Menu=({sch,onWeek,onMonth,onExit})=>{const wOps=React.useMemo(()=>makeWeekOpts(54,new Date()),[]); const mOps=React.useMemo(()=>makeMonthOpts(25,new Date()),[]);
      const [w,setW]=React.useState({dept:sch==='A001'?'60:家庭用品':'30:家庭用品',start:wOps[1]?.label||'',end:wOps[0]?.label||'',mode:'sales'});
      const [m,setM]=React.useState({dept:sch==='A001'?'10:青果':'30:家庭用品',start:mOps[0]?.label||'当月',end:mOps[0]?.label||'当月',mode:'sales',scope:'all'});
      return (
        <Container maxWidth="md" sx={{py:3}}>
          <HeadCard title={`◆メイン画面(${sch})◆`}/>
          <Section title="当週を含む過去54週間">
            <Grid container spacing={1} alignItems="center">
              <Grid item xs={12} sm={6} md={4}><TextField size="small" fullWidth label="部門選択" value={w.dept} onChange={e=>setW(s=>({...s,dept:e.target.value}))}/></Grid>
              <Grid item xs={12} sm={6} md={8}>
                <Grid container spacing={1}>
                  <Grid item xs={12} sm={6}><TextField select size="small" fullWidth label="開始週" value={w.start} onChange={e=>setW(s=>({...s,start:e.target.value}))}>{wOps.map(o=><MenuItem key={o.value} value={o.label}>{o.label}</MenuItem>)}</TextField></Grid>
                  <Grid item xs={12} sm={6}><TextField select size="small" fullWidth label="終了週" value={w.end} onChange={e=>setW(s=>({...s,end:e.target.value}))}>{wOps.map(o=><MenuItem key={o.value} value={o.label}>{o.label}</MenuItem>)}</TextField></Grid>
                </Grid>
              </Grid>
              <Grid item xs={12}>
                <RadioGroup row value={w.mode} onChange={e=>setW(s=>({...s,mode:e.target.value}))} sx={{mb:1}}>
                  <FormControlLabel value="sales" control={<Radio size="small"/>} label="売上分析"/>
                  <FormControlLabel value="loss" control={<Radio size="small"/>} label="ロス分析"/>
                </RadioGroup>
                <Stack direction="row" spacing={1}>
                  <Button variant="contained" startIcon={<span className="material-icons">play_arrow</span>} onClick={()=>onWeek?.({dept:w.dept,start:w.start,end:w.end,schema:sch,mode:'week'})}>実行</Button>
                  <Button variant="text" startIcon={<span className="material-icons">tune</span>}>詳細条件</Button>
                </Stack>
              </Grid>
            </Grid>
          </Section>
          <Section title="当月を含む過去25ヶ月">
            <Grid container spacing={1} alignItems="center">
              <Grid item xs={12} sm={6} md={4}><TextField size="small" fullWidth label="部門選択" value={m.dept} onChange={e=>setM(s=>({...s,dept:e.target.value}))}/></Grid>
              <Grid item xs={12} sm={6} md={8}>
                <Grid container spacing={1}>
                  <Grid item xs={12} sm={6}><TextField select size="small" fullWidth label="開始月" value={m.start} onChange={e=>setM(s=>({...s,start:e.target.value}))}>{mOps.map(o=><MenuItem key={o.value} value={o.label}>{o.label}</MenuItem>)}</TextField></Grid>
                  <Grid item xs={12} sm={6}><TextField select size="small" fullWidth label="終了月" value={m.end} onChange={e=>setM(s=>({...s,end:e.target.value}))}>{mOps.map(o=><MenuItem key={o.value} value={o.label}>{o.label}</MenuItem>)}</TextField></Grid>
                </Grid>
              </Grid>
              <Grid item xs={12}>
                <RadioGroup row value={m.scope} onChange={e=>setM(s=>({...s,scope:e.target.value}))} sx={{mb:1}}>
                  <FormControlLabel value="all" control={<Radio size="small"/>} label="全店"/>
                  <FormControlLabel value="exist" control={<Radio size="small"/>} label="既存店"/>
                </RadioGroup>
                <RadioGroup row value={m.mode} onChange={e=>setM(s=>({...s,mode:e.target.value}))} sx={{mb:1}}>
                  <FormControlLabel value="sales" control={<Radio size="small"/>} label="売上分析"/>
                  <FormControlLabel value="loss" control={<Radio size="small"/>} label="ロス分析"/>
                </RadioGroup>
                <Stack direction="row" spacing={1}>
                  <Button variant="contained" startIcon={<span className="material-icons">play_arrow</span>} onClick={()=>onMonth?.({dept:m.dept,start:m.start,end:m.end,schema:sch,mode:'month'})}>実行</Button>
                  <Button variant="text" startIcon={<span className="material-icons">tune</span>}>詳細条件</Button>
                </Stack>
              </Grid>
            </Grid>
          </Section>
          <UtilityExit onExit={onExit}/>
        </Container>
      )};

    /* ===== 検索条件バー ===== */
    const SearchBar=({onSearch,onExport,st,setSt,winOnly,setWinOnly,sch,setSch})=>{const lv=HIER.find(h=>h.value===st.level)||{}; const chips=React.useMemo(()=>[
        `表示範囲: ${st.start} - ${st.end}`,`部門: ${st.dept}`,`表示単位: ${st.unit}`,`表示階層: ${lv.label||''}`,`カラム: ${sch}`
      ],[st.start,st.end,st.dept,st.unit,st.level,sch]);
      const lbl=React.useMemo(()=>st.mode==='week'?{start:'開始週',end:'終了週',hint:'例: 2025/08/04(月)'}:{start:'開始月',end:'終了月',hint:'例: 2025/08'},[st.mode]);
      return (
        <Paper className="section-box" elevation={0}>
          <Box sx={{p:2}}>
            <Stack direction={{xs:'column',sm:'row'}} spacing={1} alignItems={{xs:'flex-start',sm:'center'}} sx={{mb:1}}>
              <Typography variant="h6" sx={{fontWeight:700,flexGrow:1}}>売上分析（検索条件）</Typography>
              <FormControlLabel control={<Switch checked={winOnly} onChange={e=>setWinOnly(e.target.checked)}/>} label="勝ち（○）のみ"/>
              <TextField select size="small" value={sch} onChange={e=>setSch(e.target.value)} label="列スキーマ" sx={{minWidth:140}}>
                <MenuItem value="B001">B001</MenuItem>
                <MenuItem value="A001">A001</MenuItem>
              </TextField>
            </Stack>
            <Grid container spacing={1}>
              <Grid item xs={6} sm={6} md={2}><TextField size="small" fullWidth label={lbl.start} placeholder={lbl.hint} value={st.start} onChange={e=>setSt(s=>({...s,start:e.target.value}))}/></Grid>
              <Grid item xs={12} sm={6} md={2}><TextField size="small" fullWidth label={lbl.end} placeholder={lbl.hint} value={st.end} onChange={e=>setSt(s=>({...s,end:e.target.value}))}/></Grid>
              <Grid item xs={12} sm={6} md={2}><TextField select size="small" fullWidth label="店舗" value={st.store} onChange={e=>setSt(s=>({...s,store:e.target.value}))}>{STORES.map(x=><MenuItem key={x.value} value={x.value}>{x.label}</MenuItem>)}</TextField></Grid>
              <Grid item xs={12} sm={6} md={2}><TextField select size="small" fullWidth label="部門" value={st.dept} onChange={e=>setSt(s=>({...s,dept:e.target.value}))}>{DEPTS.map(x=><MenuItem key={x.value} value={x.value}>{x.label}</MenuItem>)}</TextField></Grid>
              <Grid item xs={12} sm={8} md={1}><TextField select size="small" fullWidth label="データ表示単位" value={st.unit} onChange={e=>setSt(s=>({...s,unit:e.target.value}))}>{UNITS.map(x=><MenuItem key={x.value} value={x.value}>{x.label}</MenuItem>)}</TextField></Grid>
              <Grid item xs={12} sm={4} md={1}><FormGroup><FormControlLabel control={<Checkbox checked={st.addSub} onChange={e=>setSt(s=>({...s,addSub:e.target.checked}))}/>} label="小計行"/></FormGroup></Grid>
              <Grid item xs={12} sm={4} md={2}>
                <Stack direction="row" spacing={1}>
                  <Tooltip title="条件で検索"><Button variant="contained" size="small" onClick={onSearch} startIcon={<span className="material-icons">search</span>}>検索実行</Button></Tooltip>
                </Stack>
              </Grid>
              <Grid item xs={12}><Stack direction="row" spacing={1} sx={{flexWrap:'wrap'}}>{chips.map((c,i)=>(<Chip key={i} size="small" label={c}/>))}</Stack></Grid>
            </Grid>
          </Box>
        </Paper>
      )};

    /* ===== アプリ本体 ===== */
    const App=()=>{
      const [view,setView]=React.useState('dashboard');
      const [st,setSt]=React.useState({mode:'week',level:'corner',store:'079',dept:'総菜',start:'2025/08/04(月)',end:'2025/08/17(日)',unit:'千円未満四捨五入',addSub:true});
      const [sch,setSch]=React.useState('B001');
      const [seed,setSeed]=React.useState(SEED);
      const [winOnly,setWinOnly]=React.useState(false);
      const [flt,setFlt]=React.useState({line:null,corner:null,category:null});

      const data=React.useMemo(()=>makeData(ROWS,seed),[seed]);

      const [sortKey,setSortKey]=React.useState('grossCurr');
      const [sortDir,setSortDir]=React.useState('desc');

      const {rows}=React.useMemo(()=>{
        const {rows}=agg(data,{flt,level:st.level,addSub:st.addSub,winOnly});
        const [head,...rest]=rows; const getter=r=>r[sortKey];
        const cmp=(a,b)=>{const av=getter(a),bv=getter(b); const nA=typeof av==='number'?av:parseFloat(av)||-Infinity, nB=typeof bv==='number'?bv:parseFloat(bv)||-Infinity; return sortDir==='asc'?(nA-nB):(nB-nA)};
        const out=[]; let block=[]; let inSub=false;
        for(const r of rest){
          if(r._subtotal){
            if(block.length){block.sort(cmp);out.push(...block);block=[]}
            inSub=true; out.push(r)
          } else if(inSub) block.push(r); else out.push(r)
        }
        if(block.length){block.sort(cmp);out.push(...block)}
        return {rows:[head,...out]};
      },[data,flt,st.level,st.addSub,winOnly,sortKey,sortDir]);

      const total=rows[0]||{}; const kpi={yoy:total?.yoy_self??100,loss:total?.currLossRate??0,win:rows.slice(1).filter(r=>r.win==='○').length};

      const onExport=()=>{const G=makeGroups(sch,st.level).flatMap(g=>g.cols); const heads=G.map(c=>c.label); const pick=r=>G.map(c=>{const raw=typeof c.derive==='function'?c.derive(r):r[c.key]; return typeof raw==='number'?raw:(raw??'')}); toCsv(rows,heads,pick)};

      const jump=(p)=>{setFlt({line:null,corner:null,category:null}); if(p.schema) setSch(p.schema); setSt(s=>({...s,mode:p.mode??s.mode,dept:p.dept??s.dept,start:p.start??s.start,end:p.end??s.end,level:'corner'})); setView('dashboard')};

      const crumbs=[]; if(flt.line) crumbs.push({dim:'line',label:`ライン: ${flt.line}`}); if(flt.corner) crumbs.push({dim:'corner',label:`コーナー: ${flt.corner}`}); if(flt.category) crumbs.push({dim:'category',label:`カテゴリ: ${flt.category}`});
      const clearDim=dim=>setFlt(f=>{const n={...f}; if(dim==='line'){n.line=n.corner=n.category=null} if(dim==='corner'){n.corner=n.category=null} if(dim==='category'){n.category=null} return n});

      const onDrill=(name)=>{
        const lv=st.level; const next=NEXT_OF[lv]; if(!next) return;
        setFlt(f=>({
          line:   lv==='line'   ? name : f.line,
          corner: lv==='corner' ? name : f.corner,
          category: lv==='category' ? name : f.category
        }));
        setSt(s=>({...s, level: next }));
      };

      return (
        <ThemeProvider theme={theme}>
          <Box sx={{height:'100%',display:'grid',gridTemplateRows:'auto 1fr auto'}}>
            <header className="masthead">
              <AppBar position="static" elevation={1} sx={{bgcolor:'primary.main'}}>
                <Toolbar>
                  <Typography variant="h6" sx={{fontWeight:700,flexGrow:1}}>
                    {`売上分析ダッシュボード（${sch}列｜${firstLabel(st.level)}別）`}
                  </Typography>
                  <Stack direction="row" spacing={1}>
                    <Button color="inherit" onClick={()=>setView('dashboard')}>ダッシュボード</Button>
                    <Button color="inherit" onClick={()=>setView('menuB001')}>B001</Button>
                    <Button color="inherit" onClick={()=>setView('menuA001')}>A001</Button>
                  </Stack>
                </Toolbar>
              </AppBar>
            </header>

            <main>
              {view==='dashboard' && (
                <Container className="page" maxWidth={false} disableGutters>
                  <SearchBar st={st} setSt={setSt} onSearch={()=>setSeed(s=>s+1)} onExport={onExport} winOnly={winOnly} setWinOnly={setWinOnly} sch={sch} setSch={setSch}/>
                  <Box sx={{mb:1}}><KPIs sum={total?.grossCurr||0} deltaGross={total?.deltaGross||0} yoy={kpi.yoy} loss={kpi.loss} prevLoss={total?.prevLossRate||0} win={kpi.win}/></Box>$1

                  {(crumbs.length>0) && (
                    <Box sx={{mb:1}}>
                      <Stack direction="row" spacing={1}>{crumbs.map(c=>(<Chip key={c.dim} label={c.label} onDelete={()=>clearDim(c.dim)} color="primary" variant="outlined"/>))}
                        <Button size="small" onClick={()=>clearDim('line')}>すべて解除</Button>
                      </Stack>
                    </Box>
                  )}

                  <Paper className="section-box" elevation={0}>
                    <Box sx={{p:1,borderBottom:'1px solid rgba(0,0,0,.06)'}}>
                      <Stack direction="row" spacing={1} alignItems="center" flexWrap="wrap">
                        <ToggleButtonGroup exclusive size="small" value={st.mode} onChange={(e,v)=>v&&setSt(s=>({...s,mode:v}))} sx={{mr:1}} aria-label="週次月次切替">
                          <ToggleButton value="week" aria-label="週次">週次</ToggleButton>
                          <ToggleButton value="month" aria-label="月次">月次</ToggleButton>
                        </ToggleButtonGroup>
                        <Pills val={st.level} onChange={v=>setSt(s=>({...s,level:v}))}/>
                        <Box sx={{flexGrow:1}}/>
                        <Stack direction="row" spacing={1}>
                          <Button variant="contained" size="small" onClick={()=>setSeed(s=>s+1)} startIcon={<span className="material-icons">refresh</span>}>再表示</Button>
                          <Button variant="outlined" size="small" onClick={onExport} startIcon={<span className="material-icons">file_download</span>}>Excel</Button>
                        </Stack>
                        <Typography variant="subtitle2" sx={{color:'#455a64'}}>（単位: %, 円）</Typography>
                      </Stack>
                    </Box>
                    <Box sx={{p:1}}>
                      <Typography variant="subtitle2" sx={{mb:1,color:'#546e7a'}}>
                        セル（{firstLabel(st.level)}名 / 売上金額 など）をクリックすると次の階層へドリルダウンします。
                      </Typography>
                      <TableView rows={rows} sch={sch} level={st.level} onDrill={onDrill}/>
                    </Box>
                  </Paper>

                  <Box sx={{mt:2}}>
                    <Charts data={data} flt={flt} level={st.level} period={st.mode} sch={sch}/>
                  </Box>
                </Container>
              )}

              {view==='menuB001' && (<Menu sch="B001" onWeek={jump} onMonth={jump} onExit={()=>setView('dashboard')}/>)}
              {view==='menuA001' && (<Menu sch="A001" onWeek={jump} onMonth={jump} onExit={()=>setView('dashboard')}/>)}
            </main>

            <Box component="footer" sx={{textAlign:'center',padding:'12px',color:'#607d8b'}}>&copy; 2025 Company</Box>
          </Box>
        </ThemeProvider>
      )
    };

    ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
  </script>
</body>
</html>
