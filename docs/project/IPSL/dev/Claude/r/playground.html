<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MR & AI Chat – Improved</title>
  <!-- Roboto & MUI -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" />
  <!-- React, ReactDOM, Babel -->
  <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js" crossorigin></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.23.8/babel.min.js"></script>
  <!-- Emotion (MUI依存) -->
  <script src="https://cdn.jsdelivr.net/npm/@emotion/react@11.11.3/dist/emotion-react.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@emotion/styled@11.11.0/dist/emotion-styled.umd.min.js"></script>
  <!-- MUI Core -->
  <script src="https://cdn.jsdelivr.net/npm/@mui/material@5.15.3/umd/material-ui.production.min.js" crossorigin></script>
  <!-- MUI Icons -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">

  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: Roboto, system-ui, -apple-system, "Segoe UI", Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background: linear-gradient(180deg, #eef1f7 0%, #f6f7fb 100%);
    }
    #root { min-height: 100vh; display: flex; flex-direction: column; }

    /* ガラス風カード */
    .glass {
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      background: rgba(255,255,255,0.7);
      border: 1px solid rgba(255,255,255,0.6);
      box-shadow: 0 10px 30px rgba(76, 87, 125, 0.08);
      border-radius: 16px;
    }

    /* メッセージ */
    .bubble {
      display: inline-block;
      padding: 10px 14px;
      border-radius: 14px;
      max-width: min(80%, 640px);
      word-wrap: break-word;
      line-height: 1.5;
      margin-bottom: 10px;
      white-space: pre-wrap;
    }
    .bubble.user {
      background: #e8f0ff;
      border: 1px solid rgba(63,81,181,0.25);
      align-self: flex-end;
    }
    .bubble.agent {
      background: #ffffff;
      border: 1px solid rgba(0,0,0,0.06);
      align-self: flex-start;
    }

    /* タイピングドット */
    .typing {
      display: inline-flex;
      gap: 4px;
      align-items: center;
    }
    .typing span {
      width: 6px; height: 6px; border-radius: 50%; background: #9aa7c7;
      animation: blink 1.2s infinite ease-in-out;
    }
    .typing span:nth-child(2) { animation-delay: .2s; }
    .typing span:nth-child(3) { animation-delay: .4s; }
    @keyframes blink { 0%, 80%, 100% { opacity: .2 } 40% { opacity: 1 } }

    /* メニュー */
    .menu-icon {
      border-radius: 16px;
      width: 60px; height: 60px;
      display: flex; align-items: center; justify-content: center;
      color: white; margin: 0 auto;
      transition: transform 0.25s ease, box-shadow 0.25s ease, filter .25s ease;
      box-shadow: 0 8px 22px rgba(50,50,93,.12), 0 4px 12px rgba(0,0,0,.08);
    }
    .menu-icon:hover { transform: translateY(-3px) scale(1.02); filter: brightness(1.03); }
    .menu-label { font-size: .85rem; margin-top: 8px; text-align: center; color: #556; font-weight: 500; }

    /* コンパクト化 */
    @media (max-width: 600px) {
      .menu-icon { width: 48px; height: 48px; border-radius: 12px; }
      .menu-icon .material-icons { font-size: 22px; }
      .menu-label { font-size: .72rem; margin-top: 4px; }
    }

    /* MR オーバーレイ */
    .mr-overlay {
      position: absolute; top: 12px; left: 12px;
      background-color: rgba(255,255,0,0.85);
      padding: 6px 10px; border-radius: 6px; font-size: .9rem;
      pointer-events: none; z-index: 10;
    }
    .mr-agent {
      position: absolute; bottom: 12px; right: 12px;
      background-color: rgba(255,255,255,0.75);
      padding: 8px 12px; border-radius: 12px; font-weight: bold; color: #444;
      pointer-events: none; z-index: 10;
    }

    /* ドロワー内の高さ制御 */
    .chat-drawer-body {
      display: flex; flex-direction: column;
      height: 100%;
    }
  </style>
</head>
<body>
<div id="root"></div>

<script type="text/babel">
  const {
    AppBar, Toolbar, Typography, Box, Grid, Paper, IconButton,
    TextField, Button, Switch, FormControlLabel, Container,
    CssBaseline, ThemeProvider, createTheme, useMediaQuery,
    Divider, Chip, SwipeableDrawer, Tooltip, Avatar
  } = MaterialUI;

  const menuItems = [
    { icon: "home", label: "ホーム" },
    { icon: "person", label: "プロフィール" },
    { icon: "mail", label: "メッセージ" },
    { icon: "settings", label: "設定" },
    { icon: "photo_camera", label: "カメラ" },
    { icon: "map", label: "マップ" },
    { icon: "event", label: "カレンダー" },
    { icon: "shopping_cart", label: "ショップ" },
    { icon: "help", label: "ヘルプ" },
    { icon: "info", label: "情報" },
    { icon: "phone", label: "連絡先" },
    { icon: "music_note", label: "音楽" },
  ];

  const iconColors = [
    "#f44336", "#e91e63", "#9c27b0", "#673ab7",
    "#3f51b5", "#2196f3", "#03a9f4", "#00bcd4",
    "#009688", "#4caf50", "#ff9800", "#795548"
  ];

  // テーマ（微ダーク・彩度控えめ）
  const theme = createTheme({
    palette: {
      mode: 'light',
      primary: { main: '#283593' },
      secondary: { main: '#00bcd4' },
      background: { default: 'transparent', paper: 'rgba(255,255,255,0.7)' },
    },
    shape: { borderRadius: 14 },
    typography: { button: { textTransform: 'none', fontWeight: 600 } }
  });

  function ChatMessages({ messages, typing }) {
    return (
      <Box sx={{ display: 'flex', flexDirection: 'column', gap: 1, p: 1 }}>
        {messages.map((m, i) => (
          <Box key={i} sx={{ display: 'flex', justifyContent: m.role === 'user' ? 'flex-end' : 'flex-start' }}>
            <div className={`bubble ${m.role}`}>{m.text}</div>
          </Box>
        ))}
        {typing && (
          <Box sx={{ display: 'flex', justifyContent: 'flex-start' }}>
            <div className="bubble agent">
              <span class="typing"><span></span><span></span><span></span></span>
            </div>
          </Box>
        )}
      </Box>
    );
  }

  function AIMRChat({ autoFocusOnOpen }) {
    const videoRef = React.useRef(null);
    const inputRef = React.useRef(null);
    const [messages, setMessages] = React.useState([
      { role: "agent", text: "こんにちは、AIエージェントです。ご用件は何でしょうか？" },
    ]);
    const [input, setInput] = React.useState("");
    const [overlayText, setOverlayText] = React.useState("MR Overlay");
    const [isMRMode, setIsMRMode] = React.useState(false);
    const [typing, setTyping] = React.useState(false);

    // SpeechRecognition
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    const recognitionRef = React.useRef(null);

    React.useEffect(() => {
      if (isMRMode && navigator.mediaDevices?.getUserMedia) {
        navigator.mediaDevices.getUserMedia({ video: true })
          .then((stream) => { if (videoRef.current) videoRef.current.srcObject = stream; })
          .catch((err) => console.error("カメラアクセスエラー:", err));
      }
      // 停止（モードOFF時）
      return () => {
        if (videoRef.current?.srcObject) {
          for (const track of videoRef.current.srcObject.getTracks()) track.stop();
          videoRef.current.srcObject = null;
        }
      };
    }, [isMRMode]);

    React.useEffect(() => {
      if (SpeechRecognition) {
        recognitionRef.current = new SpeechRecognition();
        recognitionRef.current.continuous = false;
        recognitionRef.current.lang = "ja-JP";
        recognitionRef.current.onresult = (e) => setInput(e.results[0][0].transcript);
        recognitionRef.current.onerror = (e) => console.error("音声認識エラー:", e.error);
      }
    }, []);

    React.useEffect(() => {
      if (autoFocusOnOpen && inputRef.current) {
        inputRef.current.focus();
      }
    }, [autoFocusOnOpen]);

    const simulateAgentReply = () => {
      setTyping(true);
      // デモ用の簡易応答
      setTimeout(() => {
        setTyping(false);
        setMessages(prev => [...prev, { role: "agent", text: "はい、かしこまりました。続けてご質問ください。" }]);
      }, 700);
    };

    const handleSend = () => {
      const val = input.trim();
      if (!val) return;
      setMessages(prev => [...prev, { role: "user", text: val }]);
      setInput("");
      simulateAgentReply();
    };

    const handleVoiceInput = () => {
      if (!SpeechRecognition || !recognitionRef.current) {
        alert("このブラウザでは音声認識がサポートされていません。");
        return;
      }
      recognitionRef.current.start();
    };

    const onKeyDown = (e) => {
      if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
        e.preventDefault();
        handleSend();
      }
    };

    return (
      <Box sx={{ width: '100%', display: 'flex', flexDirection: 'column', gap: 2 }}>
        {isMRMode && (
          <Box className="glass" sx={{
            position: 'relative', width: '100%', aspectRatio: '16/9',
            overflow: 'hidden', p: 0
          }}>
            <video ref={videoRef} autoPlay muted playsInline style={{ width: '100%', height: '100%', objectFit: 'cover' }} />
            <div className="mr-overlay">{overlayText}</div>
            <div className="mr-agent">AI Agent</div>
          </Box>
        )}

        <Paper className="glass" sx={{ p: 0, overflow: 'hidden' }} variant="outlined">
          <Box sx={{ maxHeight: 360, overflowY: 'auto', p: 2 }}>
            <ChatMessages messages={messages} typing={typing} />
          </Box>

          <Divider textAlign="left">
            <Chip size="small" color="primary" variant="outlined" icon={<span class="material-icons" style={{fontSize:16}}>chat</span>} label="チャット" />
          </Divider>

          <Box sx={{ p: 1.5, display: 'flex', flexDirection: 'column', gap: 1 }}>
            <TextField
              inputRef={inputRef}
              variant="outlined"
              multiline
              minRows={2}
              maxRows={5}
              size="small"
              fullWidth
              value={input}
              onKeyDown={onKeyDown}
              placeholder="メッセージを入力…（Ctrl/⌘ + Enter で送信）"
              onChange={(e) => setInput(e.target.value)}
              aria-label="チャット入力"
            />
            <Box sx={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
              <FormControlLabel
                control={<Switch checked={isMRMode} onChange={(e)=>setIsMRMode(e.target.checked)} color="primary" />}
                label="MRモード"
              />
              <Box sx={{ display: 'flex', gap: 1 }}>
                {isMRMode && (
                  <Tooltip title="音声入力">
                    <IconButton onClick={handleVoiceInput} color="primary" aria-label="音声入力">
                      <span className="material-icons">mic</span>
                    </IconButton>
                  </Tooltip>
                )}
                <Button variant="contained" onClick={handleSend} startIcon={<span className="material-icons">send</span>}>
                  送信
                </Button>
              </Box>
            </Box>
          </Box>
        </Paper>
      </Box>
    );
  }

  function App() {
    const [drawerOpen, setDrawerOpen] = React.useState(false);
    const isMobile = MaterialUI.useMediaQuery('(max-width:600px)');

    const toggleDrawer = (next) => () => setDrawerOpen(next);

    return (
      <ThemeProvider theme={theme}>
        <CssBaseline />
        <Box sx={{ minHeight: "100vh", display: 'flex', flexDirection: 'column' }}>
          <AppBar position="sticky" elevation={8} onClick={toggleDrawer(true)} sx={{
            cursor: 'pointer',
            background: 'linear-gradient(90deg, #283593 0%, #3949ab 50%, #1e88e5 100%)'
          }}>
            <Toolbar sx={{ minHeight: { xs: 64, sm: 72 } }}>
              <IconButton edge="start" color="inherit" aria-label="メニュー" sx={{ mr: 1 }}>
                <span className="material-icons">menu</span>
              </IconButton>
              <Typography variant="h6" sx={{ flexGrow: 1, fontWeight: 700, letterSpacing: .2 }}>
                MR+AI Assistant
              </Typography>
              <Tooltip title="通知">
                <IconButton color="inherit" aria-label="通知">
                  <span className="material-icons">notifications</span>
                </IconButton>
              </Tooltip>
              <Tooltip title="アカウント">
                <IconButton color="inherit" aria-label="アカウント">
                  <span className="material-icons">account_circle</span>
                </IconButton>
              </Tooltip>
            </Toolbar>
          </AppBar>

          <Container maxWidth="md" sx={{ flex: 1, py: { xs: 2, sm: 3 } }}>
            {/* ホーム面：軽い説明 + 小さめチャット */}
            <Box sx={{ display: 'flex', flexDirection: 'column', gap: 2 }}>
              <Paper className="glass" sx={{ p: 3 }} variant="outlined">
                <Box sx={{ display: 'flex', alignItems: 'center', gap: 1.5, mb: 1 }}>
                  <Avatar sx={{ bgcolor: 'primary.main' }}><span class="material-icons">smart_toy</span></Avatar>
                  <Typography variant="h6" sx={{ fontWeight: 700 }}>AIアシスタント</Typography>
                </Box>
                <Typography variant="body2" color="text.secondary">
                  AppBar をクリックすると、下からフルスクリーンのチャットが開きます。画面遷移はありません。
                  MRモードでカメラオーバーレイを使いながら会話も可能です。
                </Typography>
              </Paper>

              <AIMRChat autoFocusOnOpen={false} />
            </Box>
          </Container>

          <Paper className="glass" sx={{ py: 2, px: 1, mx: { md: 2 }, mb: { xs: 1.5, md: 2 } }} elevation={0}>
            <Grid container spacing={2} justifyContent="center">
              {menuItems.map((item, index) => (
                <Grid item key={index} xs={3} sm={2} md={1} sx={{ textAlign: 'center' }}>
                  <div className="menu-icon" style={{ backgroundColor: iconColors[index % iconColors.length] }}>
                    <span className="material-icons">{item.icon}</span>
                  </div>
                  <div className="menu-label">{item.label}</div>
                </Grid>
              ))}
            </Grid>
          </Paper>

          <Box component="footer" sx={{ textAlign: 'center', p: 2, color: 'white',
            background: 'linear-gradient(90deg, #283593 0%, #1e88e5 100%)',
            boxShadow: '0 -8px 24px rgba(0,0,0,0.08)' }}>
            <Typography variant="caption">&copy; 2025 My Company - All Rights Reserved.</Typography>
          </Box>

          {/* >>> 画面遷移せずに会話するためのフルスクリーンドロワー <<< */}
          <SwipeableDrawer
            anchor="bottom"
            open={drawerOpen}
            onClose={toggleDrawer(false)}
            onOpen={toggleDrawer(true)}
            disableDiscovery
            PaperProps={{
              sx: {
                height: isMobile ? '100vh' : '80vh',
                borderTopLeftRadius: 16, borderTopRightRadius: 16,
                backgroundImage: 'linear-gradient(180deg,#ffffff 0%, #f7f9ff 100%)'
              }
            }}
          >
            <Box className="chat-drawer-body">
              <Toolbar sx={{ px: 2 }}>
                <Typography variant="h6" sx={{ flexGrow: 1, fontWeight: 700 }}>
                  AIチャット
                </Typography>
                <Tooltip title="閉じる (Esc)">
                  <IconButton onClick={toggleDrawer(false)} aria-label="閉じる">
                    <span className="material-icons">close</span>
                  </IconButton>
                </Tooltip>
              </Toolbar>
              <Divider />
              <Box sx={{ px: { xs: 1.5, sm: 2 }, pb: 2, overflow: 'auto', flex: 1 }}>
                <AIMRChat autoFocusOnOpen />
              </Box>
            </Box>
          </SwipeableDrawer>
        </Box>
      </ThemeProvider>
    );
  }

  ReactDOM.createRoot(document.getElementById("root")).render(<App />);
</script>
</body>
</html>
