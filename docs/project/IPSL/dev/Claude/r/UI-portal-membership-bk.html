<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <title>ポイントポータル</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Fonts / Icons -->
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap"
    />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/icon?family=Material+Icons"
    />

    <!-- React / Babel / MUI / Chart.js (UMD) -->
    <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js" crossorigin></script>
    <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.23.8/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mui/material@5.15.3/umd/material-ui.production.min.js" crossorigin></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js" crossorigin></script>

    <style>
      html, body, #root { height: 100%; }
      body { margin: 0; font-family: Roboto, "Helvetica Neue", Arial, sans-serif; }
      .number { font-variant-numeric: tabular-nums; }
      .cardTitle { display: flex; gap: 8px; align-items: center; }
      .material-icons { vertical-align: middle; }
      canvas { max-width: 100%; }
    </style>
  </head>
  <body>
    <div id="root"></div>

    <script type="text/babel">
      const {
        ThemeProvider, createTheme, CssBaseline, AppBar, Toolbar, Typography, IconButton,
        Container, Box, Tabs, Tab, Paper, Grid, Card, CardContent, CardActions,
        Button, Chip, Avatar, Divider, TextField, MenuItem, List, ListItem,
        ListItemIcon, ListItemText, Snackbar, Alert, Table, TableBody, TableHead,
        TableRow, TableCell, Stack, Badge, Icon, Tooltip
      } = MaterialUI;

      // ---------- Utilities ----------
      const formatDate = (d) => {
        const dt = new Date(d);
        const y = dt.getFullYear();
        const m = String(dt.getMonth() + 1).padStart(2, '0');
        const day = String(dt.getDate()).padStart(2, '0');
        return `${y}-${m}-${day}`;
      };

      const formatDateTime = (d) => {
        const dt = new Date(d);
        const y = dt.getFullYear();
        const m = String(dt.getMonth() + 1).padStart(2, '0');
        const day = String(dt.getDate()).padStart(2, '0');
        const hh = String(dt.getHours()).padStart(2, '0');
        const mm = String(dt.getMinutes()).padStart(2, '0');
        return `${y}-${m}-${day} ${hh}:${mm}`;
      };

      const loadLS = (key, fallback) => {
        try {
          const raw = localStorage.getItem(key);
          return raw ? JSON.parse(raw) : fallback;
        } catch {
          return fallback;
        }
      };
      const saveLS = (key, value) => localStorage.setItem(key, JSON.stringify(value));

      // ---------- Initial Mock ----------
      const defaultMember = {
        memberId: "M-0001",
        name: "山田 太郎",
        email: "taro.yamada@example.com",
        phone: "090-1234-5678",
        address: "東京都千代田区1-2-3",
        rank: "Gold",
      };
      const defaultTransactions = [
        { id: crypto.randomUUID(), type: "earn", amount: 500, memo: "新規登録ボーナス", at: Date.now() - 1000*60*60*24*30 },
        { id: crypto.randomUUID(), type: "spend", amount: 120, memo: "EC購入", at: Date.now() - 1000*60*60*24*20 },
        { id: crypto.randomUUID(), type: "earn", amount: 300, memo: "レビュー投稿", at: Date.now() - 1000*60*60*24*7 },
        { id: crypto.randomUUID(), type: "spend", amount: 90,  memo: "店舗購入", at: Date.now() - 1000*60*60*24*2 }
      ];

      // ---------- Chart Component ----------
      const PointsChart = ({ transactions }) => {
        const canvasRef = React.useRef(null);
        const chartRef = React.useRef(null);

        React.useEffect(() => {
          const ctx = canvasRef.current.getContext('2d');

          // Sort by date asc & build cumulative balance over time
          const sorted = [...transactions].sort((a,b) => a.at - b.at);
          let balance = 0;
          const labels = [];
          const data = [];
          sorted.forEach(tx => {
            balance += tx.type === "earn" ? tx.amount : -tx.amount;
            labels.push(formatDate(tx.at));
            data.push(balance);
          });

          // Ensure at least one point
          if (labels.length === 0) {
            labels.push(formatDate(Date.now()));
            data.push(0);
          }

          // Destroy previous chart to avoid leaks
          if (chartRef.current) {
            chartRef.current.destroy();
            chartRef.current = null;
          }

          chartRef.current = new Chart(ctx, {
            type: 'line',
            data: {
              labels,
              datasets: [{
                label: 'ポイント残高推移',
                data,
                tension: 0.25,
                fill: false,
                pointRadius: 3
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { display: true }
              },
              scales: {
                x: { title: { display: true, text: '日付' } },
                y: { title: { display: true, text: 'ポイント' }, beginAtZero: true }
              }
            }
          });

          return () => {
            if (chartRef.current) {
              chartRef.current.destroy();
              chartRef.current = null;
            }
          };
        }, [transactions]);

        return (
          <Box sx={{ height: 280 }}>
            <canvas ref={canvasRef} aria-label="ポイント推移グラフ"></canvas>
          </Box>
        );
      };

      // ---------- Tab Panels ----------
      const TabPanel = ({ value, index, children }) => (
        <div role="tabpanel" hidden={value !== index} aria-labelledby={`tab-${index}`}>
          {value === index && <Box sx={{ pt: 2 }}>{children}</Box>}
        </div>
      );

      // ---------- Main App ----------
      const App = () => {
        const [tab, setTab] = React.useState(0);

        // State from localStorage
        const [member, setMember] = React.useState(() => loadLS("memberProfile", defaultMember));
        const [transactions, setTransactions] = React.useState(() => loadLS("pointTransactions", defaultTransactions));

        // Derived balance
        const balance = React.useMemo(() => {
          return transactions.reduce((sum, t) => sum + (t.type === "earn" ? t.amount : -t.amount), 0);
        }, [transactions]);

        // Form states
        const [amount, setAmount] = React.useState("");
        const [memo, setMemo] = React.useState("");
        const [filterType, setFilterType] = React.useState("all");
        const [searchMemo, setSearchMemo] = React.useState("");

        const [toast, setToast] = React.useState({open:false, severity:"success", message:""});

        // Persist on change
        React.useEffect(() => { saveLS("memberProfile", member); }, [member]);
        React.useEffect(() => { saveLS("pointTransactions", transactions); }, [transactions]);

        // Handlers
        const handleAddTx = (type) => {
          const n = Number(amount);
          if (!n || n <= 0) {
            setToast({open:true, severity:"warning", message:"正の数のポイントを入力してください。"});
            return;
          }
          const newTx = {
            id: crypto.randomUUID(),
            type,
            amount: Math.floor(n),
            memo: memo?.trim() || (type === "earn" ? "ポイント加算" : "ポイント減算"),
            at: Date.now()
          };
          setTransactions([newTx, ...transactions]);
          setAmount("");
          setMemo("");
          setToast({open:true, severity:"success", message: type === "earn" ? "ポイントを加算しました。" : "ポイントを減算しました。"});
        };

        const filteredTx = React.useMemo(() => {
          return transactions.filter(tx => {
            const typeOK = filterType === "all" ? true : tx.type === filterType;
            const memoOK = searchMemo.trim() ? tx.memo.includes(searchMemo.trim()) : true;
            return typeOK && memoOK;
          });
        }, [transactions, filterType, searchMemo]);

        const handleMemberSave = (e) => {
          e.preventDefault();
          setToast({open:true, severity:"success", message:"会員情報を保存しました。"});
        };

        const theme = React.useMemo(() => createTheme({
          palette: { mode: 'light' }
        }), []);

        return (
          <ThemeProvider theme={theme}>
            <CssBaseline />
            <AppBar position="sticky" elevation={1}>
              <Toolbar>
                <Typography variant="h6" sx={{ flexGrow: 1 }}>
                  ポイントポータル
                </Typography>
                <Tooltip title="通知（ダミー）">
                  <IconButton color="inherit" size="large">
                    <Badge color="error" variant="dot">
                      <span className="material-icons">notifications</span>
                    </Badge>
                  </IconButton>
                </Tooltip>
                <Tooltip title="アカウント">
                  <IconButton color="inherit" size="large">
                    <span className="material-icons">account_circle</span>
                  </IconButton>
                </Tooltip>
              </Toolbar>
            </AppBar>

            <Container maxWidth="lg" sx={{ py: 4 }}>
              <Grid container spacing={2} sx={{ mb: 2 }}>
                <Grid item xs={12} md={4}>
                  <Card sx={{ height: "100%" }}>
                    <CardContent>
                      <div className="cardTitle">
                        <Icon><span className="material-icons">paid</span></Icon>
                        <Typography variant="h6">ポイント管理</Typography>
                      </div>
                      <Typography variant="body2" color="text.secondary" sx={{ mt: 1 }}>
                        残高の確認、加算・減算、履歴の管理ができます。
                      </Typography>
                      <Divider sx={{ my: 2 }} />
                      <Typography variant="h3" className="number">{balance.toLocaleString()} pt</Typography>
                      <Chip label={member.rank} sx={{ mt: 1 }} />
                    </CardContent>
                    <CardActions>
                      <Button onClick={() => setTab(0)}>開く</Button>
                    </CardActions>
                  </Card>
                </Grid>

                <Grid item xs={12} md={4}>
                  <Card sx={{ height: "100%" }}>
                    <CardContent>
                      <div className="cardTitle">
                        <Icon><span className="material-icons">person</span></Icon>
                        <Typography variant="h6">会員情報管理</Typography>
                      </div>
                      <Typography variant="body2" color="text.secondary" sx={{ mt: 1 }}>
                        氏名や連絡先、ランクなどの会員情報を編集します。
                      </Typography>
                      <Divider sx={{ my: 2 }} />
                      <Stack direction="row" spacing={2} alignItems="center">
                        <Avatar>{member.name?.[0] || "会"}</Avatar>
                        <Box>
                          <Typography variant="subtitle1">{member.name}</Typography>
                          <Typography variant="body2" color="text.secondary">{member.memberId}</Typography>
                        </Box>
                      </Stack>
                    </CardContent>
                    <CardActions>
                      <Button onClick={() => setTab(1)}>開く</Button>
                    </CardActions>
                  </Card>
                </Grid>

                <Grid item xs={12} md={4}>
                  <Card sx={{ height: "100%" }}>
                    <CardContent>
                      <div className="cardTitle">
                        <Icon><span className="material-icons">search</span></Icon>
                        <Typography variant="h6">ポイント情報照会</Typography>
                      </div>
                      <Typography variant="body2" color="text.secondary" sx={{ mt: 1 }}>
                        種別やメモで取引履歴を絞り込み検索できます。
                      </Typography>
                      <Divider sx={{ my: 2 }} />
                      <Typography variant="body2" color="text.secondary">
                        直近の取引: {transactions.length ? formatDateTime(transactions[0].at) : "—"}
                      </Typography>
                    </CardContent>
                    <CardActions>
                      <Button onClick={() => setTab(2)}>開く</Button>
                    </CardActions>
                  </Card>
                </Grid>
              </Grid>

              <Paper elevation={1} sx={{ p: 2 }}>
                <Tabs value={tab} onChange={(e, v) => setTab(v)} variant="scrollable" scrollButtons allowScrollButtonsMobile>
                  <Tab id="tab-0" icon={<span className="material-icons">paid</span>} iconPosition="start" label="ポイント管理" />
                  <Tab id="tab-1" icon={<span className="material-icons">person</span>} iconPosition="start" label="会員情報管理" />
                  <Tab id="tab-2" icon={<span className="material-icons">search</span>} iconPosition="start" label="ポイント情報照会" />
                </Tabs>

                {/* ポイント管理 */}
                <TabPanel value={tab} index={0}>
                  <Grid container spacing={2}>
                    <Grid item xs={12} md={5}>
                      <Card>
                        <CardContent>
                          <Typography variant="h6" gutterBottom>残高と操作</Typography>
                          <Typography variant="h3" className="number">{balance.toLocaleString()} pt</Typography>
                          <Divider sx={{ my: 2 }} />
                          <Stack spacing={2}>
                            <TextField
                              label="ポイント数"
                              type="number"
                              value={amount}
                              onChange={e => setAmount(e.target.value)}
                              inputProps={{ min: 1 }}
                              fullWidth
                              required
                            />
                            <TextField
                              label="メモ（任意）"
                              value={memo}
                              onChange={e => setMemo(e.target.value)}
                              fullWidth
                            />
                            <Stack direction={{ xs: 'column', sm: 'row' }} spacing={1}>
                              <Button variant="contained" onClick={() => handleAddTx("earn")} startIcon={<span className="material-icons">add</span>}>加算</Button>
                              <Button variant="outlined" color="error" onClick={() => handleAddTx("spend")} startIcon={<span className="material-icons">remove</span>}>減算</Button>
                            </Stack>
                          </Stack>
                        </CardContent>
                      </Card>

                      <Box sx={{ mt: 2 }}>
                        <Card>
                          <CardContent>
                            <Typography variant="h6" gutterBottom>最近の取引</Typography>
                            <Table size="small" aria-label="最近の取引">
                              <TableHead>
                                <TableRow>
                                  <TableCell>日時</TableCell>
                                  <TableCell>種別</TableCell>
                                  <TableCell align="right">ポイント</TableCell>
                                  <TableCell>メモ</TableCell>
                                </TableRow>
                              </TableHead>
                              <TableBody>
                                {transactions.slice(0, 5).map(tx => (
                                  <TableRow key={tx.id} hover>
                                    <TableCell>{formatDateTime(tx.at)}</TableCell>
                                    <TableCell>
                                      <Chip size="small" color={tx.type === "earn" ? "primary" : "default"} label={tx.type === "earn" ? "加算" : "減算"} />
                                    </TableCell>
                                    <TableCell align="right" className="number">
                                      {tx.type === "earn" ? "+" : "-"}{tx.amount.toLocaleString()}
                                    </TableCell>
                                    <TableCell>{tx.memo}</TableCell>
                                  </TableRow>
                                ))}
                                {transactions.length === 0 && (
                                  <TableRow><TableCell colSpan={4} align="center">取引はまだありません。</TableCell></TableRow>
                                )}
                              </TableBody>
                            </Table>
                          </CardContent>
                        </Card>
                      </Box>
                    </Grid>

                    <Grid item xs={12} md={7}>
                      <Card sx={{ height: '100%' }}>
                        <CardContent>
                          <Typography variant="h6" gutterBottom>ポイント推移</Typography>
                          <PointsChart transactions={transactions} />
                        </CardContent>
                      </Card>
                    </Grid>
                  </Grid>
                </TabPanel>

                {/* 会員情報管理 */}
                <TabPanel value={tab} index={1}>
                  <Grid container spacing={2}>
                    <Grid item xs={12} md={6}>
                      <Card>
                        <CardContent>
                          <Typography variant="h6" gutterBottom>会員情報</Typography>
                          <Box component="form" onSubmit={handleMemberSave}>
                            <Stack spacing={2}>
                              <TextField label="会員ID" value={member.memberId} onChange={e => setMember({...member, memberId: e.target.value})} required fullWidth />
                              <TextField label="氏名" value={member.name} onChange={e => setMember({...member, name: e.target.value})} required fullWidth />
                              <TextField label="メール" type="email" value={member.email} onChange={e => setMember({...member, email: e.target.value})} fullWidth />
                              <TextField label="電話" value={member.phone} onChange={e => setMember({...member, phone: e.target.value})} fullWidth />
                              <TextField label="住所" value={member.address} onChange={e => setMember({...member, address: e.target.value})} fullWidth />
                              <TextField
                                select
                                label="ランク"
                                value={member.rank}
                                onChange={e => setMember({...member, rank: e.target.value})}
                                fullWidth
                              >
                                {["Bronze","Silver","Gold","Platinum"].map(r => (
                                  <MenuItem key={r} value={r}>{r}</MenuItem>
                                ))}
                              </TextField>
                              <Stack direction={{ xs: 'column', sm: 'row' }} spacing={1}>
                                <Button type="submit" variant="contained" startIcon={<span className="material-icons">save</span>}>保存</Button>
                                <Button variant="outlined" startIcon={<span className="material-icons">restart_alt</span>}
                                  onClick={() => { setMember(defaultMember); setToast({open:true, severity:"info", message:"初期値へリセットしました。"}); }}>
                                  リセット
                                </Button>
                              </Stack>
                            </Stack>
                          </Box>
                        </CardContent>
                      </Card>
                    </Grid>

                    <Grid item xs={12} md={6}>
                      <Card sx={{ height: '100%' }}>
                        <CardContent>
                          <Typography variant="h6" gutterBottom>会員カード</Typography>
                          <Stack direction="row" spacing={2} alignItems="center">
                            <Avatar sx={{ width: 64, height: 64 }}>{member.name?.[0] || "会"}</Avatar>
                            <Box>
                              <Typography variant="h5">{member.name}</Typography>
                              <Typography color="text.secondary">{member.memberId}</Typography>
                              <Stack direction="row" spacing={1} sx={{ mt: 1 }}>
                                <Chip icon={<span className="material-icons">star</span>} label={`ランク: ${member.rank}`} />
                                <Chip icon={<span className="material-icons">paid</span>} label={`残高: ${balance.toLocaleString()} pt`} />
                              </Stack>
                            </Box>
                          </Stack>
                          <Divider sx={{ my: 2 }} />
                          <Typography variant="subtitle1">連絡先</Typography>
                          <List dense>
                            <ListItem>
                              <ListItemIcon><span className="material-icons">mail</span></ListItemIcon>
                              <ListItemText primary={member.email || "—"} />
                            </ListItem>
                            <ListItem>
                              <ListItemIcon><span className="material-icons">call</span></ListItemIcon>
                              <ListItemText primary={member.phone || "—"} />
                            </ListItem>
                            <ListItem>
                              <ListItemIcon><span className="material-icons">home</span></ListItemIcon>
                              <ListItemText primary={member.address || "—"} />
                            </ListItem>
                          </List>
                        </CardContent>
                      </Card>
                    </Grid>
                  </Grid>
                </TabPanel>

                {/* ポイント情報照会 */}
                <TabPanel value={tab} index={2}>
                  <Card>
                    <CardContent>
                      <Typography variant="h6" gutterBottom>取引履歴検索</Typography>
                      <Grid container spacing={2} alignItems="center">
                        <Grid item xs={12} md={3}>
                          <TextField
                            select
                            label="種別"
                            value={filterType}
                            onChange={(e) => setFilterType(e.target.value)}
                            fullWidth
                          >
                            <MenuItem value="all">全て</MenuItem>
                            <MenuItem value="earn">加算</MenuItem>
                            <MenuItem value="spend">減算</MenuItem>
                          </TextField>
                        </Grid>
                        <Grid item xs={12} md={6}>
                          <TextField
                            label="メモに含むキーワード"
                            value={searchMemo}
                            onChange={(e) => setSearchMemo(e.target.value)}
                            fullWidth
                          />
                        </Grid>
                        <Grid item xs={12} md={3}>
                          <Button
                            fullWidth
                            variant="outlined"
                            startIcon={<span className="material-icons">filter_alt_off</span>}
                            onClick={() => { setFilterType("all"); setSearchMemo(""); }}
                          >
                            クリア
                          </Button>
                        </Grid>
                      </Grid>

                      <Box sx={{ mt: 2 }}>
                        <Table size="small" aria-label="取引履歴">
                          <TableHead>
                            <TableRow>
                              <TableCell>日時</TableCell>
                              <TableCell>種別</TableCell>
                              <TableCell align="right">ポイント</TableCell>
                              <TableCell>メモ</TableCell>
                            </TableRow>
                          </TableHead>
                          <TableBody>
                            {filteredTx.map(tx => (
                              <TableRow key={tx.id} hover>
                                <TableCell>{formatDateTime(tx.at)}</TableCell>
                                <TableCell>
                                  <Chip size="small" color={tx.type === "earn" ? "primary" : "default"} label={tx.type === "earn" ? "加算" : "減算"} />
                                </TableCell>
                                <TableCell align="right" className="number">
                                  {tx.type === "earn" ? "+" : "-"}{tx.amount.toLocaleString()}
                                </TableCell>
                                <TableCell>{tx.memo}</TableCell>
                              </TableRow>
                            ))}
                            {filteredTx.length === 0 && (
                              <TableRow><TableCell colSpan={4} align="center">条件に一致する取引はありません。</TableCell></TableRow>
                            )}
                          </TableBody>
                        </Table>
                      </Box>
                    </CardContent>
                  </Card>
                </TabPanel>
              </Paper>
            </Container>

            <Snackbar open={toast.open} autoHideDuration={2500} onClose={() => setToast({...toast, open:false})} anchorOrigin={{ vertical: 'bottom', horizontal: 'center' }}>
              <Alert severity={toast.severity} variant="filled" onClose={() => setToast({...toast, open:false})}>
                {toast.message}
              </Alert>
            </Snackbar>
          </ThemeProvider>
        );
      };

      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
  </body>
</html>
