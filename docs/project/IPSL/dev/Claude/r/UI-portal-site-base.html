<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>統合ドメインダッシュボード（改善版）</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap"/>
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons"/>
  <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mui/material@5.15.14/umd/material-ui.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.25.6/babel.min.js"></script>
  <style>
    html,body{height:100%;margin:0;font-family:Roboto,system-ui;background:#fafafa}
    .grid{display:grid;gap:12px}
    .mono{font-variant-numeric:tabular-nums}
    .kpi{display:grid;grid-template-columns:repeat(5,1fr);gap:8px;margin-bottom:10px}
    @media(max-width:900px){.kpi{grid-template-columns:repeat(2,1fr)}}
  </style>
</head>
<body>
  <div id="app"></div>

  <script type="text/babel">
const {
  Box, Card, CardContent, Typography, Stack, Table, TableHead, TableBody, TableRow, TableCell,
  TableContainer, Paper, TextField, Button, Chip, ThemeProvider, createTheme,
  MenuItem, Select, FormControl, InputLabel, OutlinedInput, Checkbox, ListItemText, Divider
} = MaterialUI;

/* ========= ユーティリティ ========= */
// 乱数（再現性のためのシード付き）
function mulberry32(a){return function(){let t=a+=0x6D2B79F5;t=Math.imul(t^t>>>15,t|1);t^=t+Math.imul(t^t>>>7,t|61);return ((t^t>>>14)>>>0)/4294967296;};}
function hashStrToSeed(str){let h=2166136261;for(let i=0;i<str.length;i++){h^=str.charCodeAt(i);h=Math.imul(h,16777619);}return (h>>>0)||1;}
const makeRng = (seedStr)=>mulberry32(hashStrToSeed(seedStr));
const pick = (rnd, arr) => arr[Math.floor(rnd()*arr.length)];

function useDebounced(value, delay=300){
  const [v, setV] = React.useState(value);
  React.useEffect(()=>{
    const t = setTimeout(()=>setV(value), delay);
    return ()=>clearTimeout(t);
  }, [value, delay]);
  return v;
}

/* ========= 共通データ ========= */
const FACILITIES = [
  {id:'HQ',name:'本社'},
  {id:'S1',name:'店舗A'},
  {id:'S2',name:'店舗B'},
  {id:'DC',name:'物流センター'},
  {id:'R1',name:'研究棟'}
];

const ALL_STATUS = ['稼働','有効','点検中','未対応','期限切れ','停止','完了','未完','遵守','無効','退去'];

/* ========= 汎用パネル ========= */
function GenericPanel({ title, list, columns, kpiFactory, filters }) {
  const [page,setPage]=React.useState(0);
  const perPage=15;

  const filtered=React.useMemo(()=>{
    const q = (filters.q||'').toLowerCase();
    const keys = ['id','name','store_name','type','category','partner','item','content','status']; // 検索対象キー
    return list.filter(r=>{
      const matchFacility = !filters.facilities.length || filters.facilities.includes(r.facility);
      const matchStatus = !filters.statuses.length ||
        (typeof r.status==='string' ? filters.statuses.includes(r.status) : true);
      const matchQuery = !q || keys.some(k => String(r[k]??'').toLowerCase().includes(q));
      return matchFacility && matchStatus && matchQuery;
    });
  },[list,filters.facilities,filters.statuses,filters.q]);

  // フィルタが変わったら 1 ページ目へ
  React.useEffect(()=>{ setPage(0); },[filters.facilities,filters.statuses,filters.q]);

  const total=filtered.length, pages=Math.max(1, Math.ceil(total/perPage));
  const curPage=Math.min(page, pages-1);
  const pageRows=filtered.slice(curPage*perPage,curPage*perPage+perPage);
  const start=total?curPage*perPage+1:0,end=Math.min(total,(curPage+1)*perPage);
  const kpis=(kpiFactory||((rs)=>[{label:'件数',value:rs.length}]))(filtered);

  return(
    <Card>
      <CardContent>
        <Typography variant="h6" sx={{mb:1}}>{title}</Typography>

        {/* KPI */}
        <Box className="kpi">
          {kpis.map(k=>(
            <Card key={k.label} variant="outlined" sx={{p:1}}>
              <Typography color="text.secondary" variant="body2">{k.label}</Typography>
              <Typography variant="h6" className="mono">{k.value}</Typography>
              {k.sub && <Typography color="text.secondary" variant="caption">{k.sub}</Typography>}
            </Card>
          ))}
        </Box>

        {/* テーブル */}
        <TableContainer component={Paper} variant="outlined" sx={{maxHeight: 420}}>
          <Table size="small" stickyHeader>
            <TableHead><TableRow>{columns.map(c=><TableCell key={c.key} align={c.align||'left'}>{c.label}</TableCell>)}</TableRow></TableHead>
            <TableBody>
              {pageRows.map((r,i)=>(
                <TableRow key={r.id||i} hover>
                  {columns.map(c=>{
                    const v=typeof c.render==='function'?c.render(r):(r[c.key]??'');
                    return <TableCell key={c.key} align={c.align||'left'} className={c.mono?'mono':''}>{v}</TableCell>;
                  })}
                </TableRow>
              ))}
              {pageRows.length===0 && (
                <TableRow><TableCell colSpan={columns.length} align="center">
                  <Typography color="text.secondary" sx={{py:2}}>該当データがありません</Typography>
                </TableCell></TableRow>
              )}
            </TableBody>
          </Table>
        </TableContainer>

        {/* ページネーション */}
        <Stack direction="row" justifyContent="space-between" alignItems="center" sx={{mt:1}}>
          <Typography variant="body2" color="text.secondary">表示 {start}-{end}/{total} 件</Typography>
          <Stack direction="row" gap={0.5} alignItems="center">
            <Button onClick={()=>setPage(0)} disabled={curPage===0}>⏮</Button>
            <Button onClick={()=>setPage(p=>Math.max(0,p-1))} disabled={curPage===0}>◀</Button>
            <Typography className="mono">Page {curPage+1}/{pages}</Typography>
            <Button onClick={()=>setPage(p=>Math.min(pages-1,p+1))} disabled={curPage>=pages-1}>▶</Button>
            <Button onClick={()=>setPage(pages-1)} disabled={curPage>=pages-1}>⏭</Button>
          </Stack>
        </Stack>
      </CardContent>
    </Card>
  );
}

/* ========= 各ドメイン定義（list は rnd を受け取る） ========= */
const panels = {
  equip:{
    title:"設備管理",
    columns:[{key:'id',label:'ID'},{key:'name',label:'設備名'},{key:'type',label:'区分'},{key:'status',label:'状態'}],
    list:(rnd)=>Array.from({length:80}).map((_,i)=>({
      id:`EQ-${i+1}`,
      name:`設備${i+1}`,
      type:pick(rnd,['空調','電源','POS']),
      status:pick(rnd,['稼働','点検中','停止']),
      facility:pick(rnd,FACILITIES.map(f=>f.id))
    })),
    kpi:r=>[{label:'設備数',value:r.length},{label:'点検中',value:r.filter(x=>x.status==='点検中').length}]
  },
  store:{
    title:"店舗管理",
    columns:[
      {key:'id',label:'ID'},
      {key:'store_name',label:'店舗名'},
      {key:'business_category',label:'業種'},
      {key:'area',label:'面積(㎡)',align:'right',mono:true},
      {key:'status',label:'状態',render:r=>r.status==='稼働'?<Chip label="稼働中" color="success" size="small"/>:<Chip label="停止" size="small"/>}
    ],
    list:(rnd)=>Array.from({length:120}).map((_,i)=>{
      const active = rnd()>.2;
      return {
        id:`ST-${i+1}`,
        store_name:`店舗${i+1}`,
        business_category:pick(rnd,['物販','飲食','サービス']),
        area:Math.round(500+rnd()*2500),
        status: active ? '稼働' : '停止', // 文字列に統一
        facility:pick(rnd,FACILITIES.map(f=>f.id))
      };
    }),
    kpi:r=>[
      {label:'店舗数',value:r.length},
      {label:'稼働率',value:r.length?Math.round(r.filter(x=>x.status==='稼働').length/r.length*100)+'%':'—'}
    ]
  },
  ops:{
    title:"店舗営業管理",
    columns:[{key:'id',label:'ID'},{key:'name',label:'施策名'},{key:'category',label:'種別'},{key:'status',label:'状態'}],
    list:(rnd)=>Array.from({length:80}).map((_,i)=>({
      id:`OP-${i+1}`,name:`施策${i+1}`,
      category:pick(rnd,['販促','時短','人員']),
      status:pick(rnd,['稼働','停止']),
      facility:pick(rnd,FACILITIES.map(f=>f.id))
    })),
    kpi:r=>[{label:'施策数',value:r.length},{label:'実施中',value:r.filter(x=>x.status==='稼働').length}]
  },
  contract:{
    title:"契約管理",
    columns:[{key:'id',label:'ID'},{key:'type',label:'契約種別'},{key:'partner',label:'相手先'},{key:'status',label:'状態'}],
    list:(rnd)=>Array.from({length:100}).map((_,i)=>({
      id:`CT-${i+1}`,type:pick(rnd,['賃貸','保守','委託']),
      partner:pick(rnd,['A社','B社','C社']),
      status:pick(rnd,['稼働','期限切れ','解約予定','停止']),
      facility:pick(rnd,FACILITIES.map(f=>f.id))
    })),
    kpi:r=>[{label:'契約数',value:r.length},{label:'期限切れ',value:r.filter(x=>x.status==='期限切れ').length}]
  },
  tenant:{
    title:"テナント管理",
    columns:[{key:'id',label:'ID'},{key:'name',label:'テナント名'},{key:'status',label:'状態'}],
    list:(rnd)=>Array.from({length:100}).map((_,i)=>({
      id:`TN-${i+1}`,name:`テナント${i+1}`,
      status:pick(rnd,['有効','退去','無効']),
      facility:pick(rnd,FACILITIES.map(f=>f.id))
    })),
    kpi:r=>[{label:'テナント数',value:r.length},{label:'有効率',value:r.length?Math.round(r.filter(x=>x.status==='有効').length/r.length*100)+'%':'—'}]
  },
  building:{
    title:"建物情報管理",
    columns:[{key:'id',label:'ID'},{key:'name',label:'建物名'},{key:'category',label:'区分'},{key:'status',label:'状態'}],
    list:(rnd)=>Array.from({length:80}).map((_,i)=>({
      id:`BL-${i+1}`,name:`建物${i+1}`,
      category:pick(rnd,['構造','用途','耐震']),
      status:pick(rnd,['有効','未対応']),
      facility:pick(rnd,FACILITIES.map(f=>f.id))
    })),
    kpi:r=>[{label:'建物数',value:r.length}]
  },
  client:{
    title:"取引先管理",
    columns:[{key:'id',label:'ID'},{key:'name',label:'取引先名'},{key:'type',label:'区分'},{key:'status',label:'状態'}],
    list:(rnd)=>Array.from({length:70}).map((_,i)=>({
      id:`CL-${i+1}`,name:`取引先${i+1}`,
      type:pick(rnd,['仕入','販売','委託']),
      status:pick(rnd,['有効','停止']),
      facility:pick(rnd,FACILITIES.map(f=>f.id))
    })),
    kpi:r=>[{label:'取引先数',value:r.length}]
  },
  sales:{
    title:"売上管理",
    columns:[{key:'id',label:'ID'},{key:'category',label:'区分'},{key:'amount',label:'売上(千円)',align:'right',mono:true}],
    list:(rnd)=>Array.from({length:160}).map((_,i)=>({
      id:`SL-${i+1}`,
      category:pick(rnd,['総売上','部門','チャネル']),
      amount:Math.round(500+rnd()*3000),
      facility:pick(rnd,FACILITIES.map(f=>f.id))
    })),
    kpi:r=>[
      {label:'件数',value:r.length},
      {label:'合計(千円)',value:r.reduce((s,x)=>s+x.amount,0).toLocaleString()}
    ]
  },
  history:{
    title:"履歴管理",
    columns:[{key:'id',label:'ID'},{key:'content',label:'内容'},{key:'status',label:'状態'}],
    list:(rnd)=>Array.from({length:200}).map((_,i)=>({
      id:`HS-${i+1}`,content:`履歴${i+1}`,
      status:pick(rnd,['完了','未完']),
      facility:pick(rnd,FACILITIES.map(f=>f.id))
    })),
    kpi:r=>[{label:'履歴数',value:r.length}]
  },
  neighbor:{
    title:"近隣管理",
    columns:[{key:'id',label:'ID'},{key:'name',label:'名称'},{key:'distance',label:'距離(m)',align:'right',mono:true}],
    list:(rnd)=>Array.from({length:120}).map((_,i)=>({
      id:`NB-${i+1}`,name:`近隣${i+1}`,
      distance:Math.round(100+rnd()*3000),
      facility:pick(rnd,FACILITIES.map(f=>f.id))
    })),
    kpi:r=>[{label:'件数',value:r.length}]
  },
  law:{
    title:"法令管理",
    columns:[{key:'id',label:'ID'},{key:'item',label:'項目'},{key:'status',label:'遵守'}],
    list:(rnd)=>Array.from({length:100}).map((_,i)=>({
      id:`LW-${i+1}`,item:`法令${i+1}`,
      status:pick(rnd,['遵守','未対応']),
      facility:pick(rnd,FACILITIES.map(f=>f.id))
    })),
    kpi:r=>[
      {label:'法令件数',value:r.length},
      {label:'遵守率',value:r.length?Math.round(r.filter(x=>x.status==='遵守').length/r.length*100)+'%':'—'}
    ]
  },
  land:{
    title:"土地情報管理",
    columns:[{key:'id',label:'ID'},{key:'name',label:'土地名'},{key:'area',label:'面積(㎡)',align:'right',mono:true}],
    list:(rnd)=>Array.from({length:90}).map((_,i)=>({
      id:`LD-${i+1}`,name:`土地${i+1}`,
      area:Math.round(100+rnd()*9000),
      facility:pick(rnd,FACILITIES.map(f=>f.id))
    })),
    kpi:r=>[
      {label:'土地数',value:r.length},
      {label:'合計面積(㎡)',value:r.reduce((s,x)=>s+x.area,0).toLocaleString()}
    ]
  }
};

/* ========= App ========= */
const theme=createTheme({palette:{primary:{main:'#1976d2'}}});

function App(){
  const [facSel,setFacSel]=React.useState([]);
  const [sts,setSts]=React.useState(['稼働','有効','未対応']); // デフォルトの表示に合わせた初期値
  const [qInput,setQInput]=React.useState('');
  const q = useDebounced(qInput, 300);
  const filters={facilities:facSel,q, statuses:sts};

  // 初回のみ、各パネルに固有シードの rng でデータ生成して固定
  const dataMemo = React.useMemo(()=>{
    const entries = Object.entries(panels).map(([id,p])=>{
      const rnd = makeRng('seed:'+id);
      return [id, p.list(rnd)];
    });
    return Object.fromEntries(entries);
  },[]);

  return(
    <ThemeProvider theme={theme}>
      <Box sx={{p:{xs:1, md:2}}}>
        <Card sx={{mb:2}}>
          <CardContent>
            <Typography variant="h5" gutterBottom>統合ドメインダッシュボード（改善版：全体フィルター＋KPI＋15件/ページ）</Typography>
            <Stack direction={{xs:'column',md:'row'}} gap={1} alignItems={{xs:'stretch',md:'center'}}>
              <FormControl fullWidth size="small">
                <InputLabel>施設（複数選択）</InputLabel>
                <Select multiple value={facSel} onChange={e=>setFacSel(e.target.value)} input={<OutlinedInput label="施設"/>}
                  renderValue={(sel)=>sel.map(id=>FACILITIES.find(f=>f.id===id)?.name||id).join(', ')}>
                  {FACILITIES.map(f=>(
                    <MenuItem key={f.id} value={f.id}>
                      <Checkbox checked={facSel.indexOf(f.id)>-1}/><ListItemText primary={f.name}/>
                    </MenuItem>
                  ))}
                </Select>
              </FormControl>

              <FormControl fullWidth size="small">
                <InputLabel>状態</InputLabel>
                <Select multiple value={sts} onChange={e=>setSts(e.target.value)} input={<OutlinedInput label="状態"/>}
                  renderValue={(sel)=>sel.join(', ')}>
                  {ALL_STATUS.map(s=>(
                    <MenuItem key={s} value={s}>
                      <Checkbox checked={sts.indexOf(s)>-1}/><ListItemText primary={s}/>
                    </MenuItem>
                  ))}
                </Select>
              </FormControl>

              <TextField fullWidth size="small" label="全体検索" value={qInput} onChange={e=>setQInput(e.target.value)}
                placeholder="ID / 名称 / 区分 / 状態 など"/>
            </Stack>

            <Divider sx={{mt:2}}/>
            <Typography variant="caption" color="text.secondary" sx={{mt:1, display:'block'}}>
              ※ KPI と一覧はすべて「現在のフィルター後」の対象に基づいています。検索は主要フィールドのみ対象・300ms デバウンス。
            </Typography>
          </CardContent>
        </Card>

        <Box className="grid">
          {Object.entries(panels).map(([id,p])=>(
            <GenericPanel
              key={id}
              title={p.title}
              list={dataMemo[id]}
              columns={p.columns}
              kpiFactory={p.kpi}
              filters={filters}
            />
          ))}
        </Box>
      </Box>
    </ThemeProvider>
  );
}

ReactDOM.createRoot(document.getElementById('app')).render(<App/>);
  </script>
</body>
</html>
