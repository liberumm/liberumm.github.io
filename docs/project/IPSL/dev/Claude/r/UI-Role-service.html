<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>サービス管理デモ（ステータス＆縦罫線）</title>

  <!-- CDN -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap"/>
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
  <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js" crossorigin></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.23.8/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@emotion/react@11.11.3/dist/emotion-react.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@emotion/styled@11.11.0/dist/emotion-styled.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mui/material@5.15.3/umd/material-ui.production.min.js" crossorigin></script>

  <style>
    html, body, #root { height: 100%; margin: 0; background: #fafafa; }
    .dragging { opacity: .6; transform: scale(.98); }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { StrictMode, useMemo, useState, useRef } = React;
    const {
      AppBar, Toolbar, Typography, CssBaseline,
      Drawer, Divider, List, ListItemButton, ListItemIcon, ListItemText,
      IconButton, Box, Stack, Container, Paper, Grid, Card, CardContent, Avatar, Badge, Chip,
      Dialog, DialogTitle, DialogContent, DialogActions,
      Button, TextField, Switch, FormControlLabel, RadioGroup, Radio,
      Table, TableHead, TableRow, TableCell, TableBody, Select, MenuItem, Alert,
      Tabs, Tab, Checkbox
    } = MaterialUI;

    // ===== デモデータ（19サービス） =====
    const DEFAULT_SERVICES = [
      { id:"svc-01", name:"会計" }, { id:"svc-02", name:"人事" }, { id:"svc-03", name:"顧客管理" },
      { id:"svc-04", name:"在庫" }, { id:"svc-05", name:"分析" }, { id:"svc-06", name:"承認" },
      { id:"svc-07", name:"レポート" }, { id:"svc-08", name:"ID管理" }, { id:"svc-09", name:"購買" },
      { id:"svc-10", name:"販売" }, { id:"svc-11", name:"請求" }, { id:"svc-12", name:"契約" },
      { id:"svc-13", name:"資産" }, { id:"svc-14", name:"プロジェクト" }, { id:"svc-15", name:"eラーニング" },
      { id:"svc-16", name:"コンテンツ" }, { id:"svc-17", name:"ワークフロー" }, { id:"svc-18", name:"セキュリティ" },
      { id:"svc-19", name:"監査" },
    ];
    const INTERNAL_ORGS = [
      { id:"in-001", name:"営業本部" }, { id:"in-002", name:"コーポレートIT" },
      { id:"in-003", name:"開発部" },   { id:"in-004", name:"総務部" },
      { id:"in-005", name:"経理部" },   { id:"in-006", name:"人事部" }
    ];
    const PARTNER_ORGS = [
      { id:"ex-101", name:"販売代理店A" }, { id:"ex-102", name:"アウトソースBPO" },
      { id:"ex-103", name:"物流パートナーC" }, { id:"ex-104", name:"SIパートナーD" }
    ];
    const USERS = [
      { id:"u-001", name:"山田 太郎" },
      { id:"u-002", name:"佐藤 花子" },
      { id:"u-003", name:"John Doe" },
      { id:"u-004", name:"Jane Smith" }
    ];
    const CURRENT_USER = { id: "admin", name: "管理者" };
    const ROLE_OPTIONS = ["ルート","管理者","一般"];

    // URL（ダミー）
    const makeInviteUrl = (serviceId) => {
      const token = Math.random().toString(36).slice(2, 10);
      return `${location.origin}/invite/${serviceId}/${token}`;
    };
    const makeRegistrationUrl = (serviceId) => `${location.origin}/register/${serviceId}`;

    // 罫線（縦線）付きスプレッドシート風テーブル
    const spreadsheetTableSx = {
      border: '1px solid #e0e0e0',
      // 各セル：右罫線＋下罫線
      '& .MuiTableCell-root': {
        borderRight: '1px solid #e0e0e0',
        borderBottom: '1px solid #e0e0e0',
      },
      // 行末セルは右罫線を消す
      '& .MuiTableCell-root:last-of-type': { borderRight: 0 },

      // ヘッダー：背景色＋やや太い下罫線
      '& thead .MuiTableCell-root': {
        backgroundColor: '#f6f8fa',   // お好みで #f5f7fa などに
        fontWeight: 600,
        borderBottom: '2px solid #d0d7de',
      },
      '& thead .MuiTableCell-root': {
        position: 'sticky', top: 0, zIndex: 1,
        backgroundColor: '#f6f8fa',
        fontWeight: 600,
        borderBottom: '2px solid #d0d7de',
      },
    };


    // ====== メッセージ/確認モーダル ======
    const MessageDialog = ({ open, title="メッセージ", message="", onClose }) => (
      <Dialog open={open} onClose={onClose} fullWidth maxWidth="xs">
        <DialogTitle>{title}</DialogTitle>
        <DialogContent dividers>
          <Typography>{message}</Typography>
        </DialogContent>
        <DialogActions>
          <Button type="button" variant="contained" onClick={onClose}>OK</Button>
        </DialogActions>
      </Dialog>
    );
    const ConfirmDialog = ({ open, title="確認", message="よろしいですか？", onCancel, onConfirm }) => (
      <Dialog open={open} onClose={onCancel} fullWidth maxWidth="xs">
        <DialogTitle>{title}</DialogTitle>
        <DialogContent dividers>
          <Typography>{message}</Typography>
        </DialogContent>
        <DialogActions>
          <Button type="button" onClick={onCancel}>キャンセル</Button>
          <Button type="button" color="error" variant="contained" onClick={onConfirm}>OK</Button>
        </DialogActions>
      </Dialog>
    );

    // ===== サービス設定（保存なし） =====
    const defaultSettings = (svcId) => {
      const base = {
        platformEnabled: true,
        registrationPageEnabled: false,
        ownerInternal: [],
        ownerExternal: [],
        ownerUsers: [],
        internalAssigned: [],
        externalAssigned: [],
        externalIndividualsEnabled: false,
        invites: [],        // {id,url,targetType,targetId,role,expiresAt,enabled,createdBy,usedBy}
        inviteEnabled: false,
        users: []           // [{ userId, enabled }]
      };
      // デモ用に svc-01 だけ最初から1名（有効）登録済み
      if (svcId === "svc-01") {
        base.inviteEnabled = true;
        base.invites = [{
          id:"demo1",
          url: makeInviteUrl(svcId),
          targetType:"個人",
          targetId:"new",
          role:"一般",
          expiresAt: new Date(Date.now()+ 7*86400000).toISOString(),
          enabled: true,
          createdBy: CURRENT_USER,
          usedBy: USERS[0] // 山田 太郎
        }];
        base.users = [{ userId: USERS[0].id, enabled: true }];
      }
      return base;
    };

    // ====== 大量選択ピッカー（設定モーダル用） ======
    const MultiPickerDialog = ({ open, title, options, selectedIds, onClose, onApply, showId = true }) => {
      const [kw, setKw] = React.useState("");
      const [local, setLocal] = React.useState(new Set(selectedIds));
      const [onlySelected, setOnlySelected] = React.useState(false);

      React.useEffect(()=>{ if(open){ setLocal(new Set(selectedIds)); setKw(""); setOnlySelected(false);} }, [open, selectedIds]);

      const filtered = React.useMemo(()=>{
        const k = kw.trim().toLowerCase();
        const base = options.filter(o => !onlySelected || (onlySelected && local.has(o.id)));
        if(!k) return base;
        return base.filter(o => (o.name + (o.id||"")).toLowerCase().includes(k));
      }, [options, kw, onlySelected, local]);

      const toggle = (id) => setLocal(prev => { const n = new Set(prev); n.has(id)?n.delete(id):n.add(id); return n; });
      const allSelect = () => setLocal(prev => { const n=new Set(prev); filtered.forEach(o=>n.add(o.id)); return n; });
      const allClear  = () => setLocal(prev => { const n=new Set(prev); filtered.forEach(o=>n.delete(o.id)); return n; });
      const removeOne = (id) => setLocal(prev => { const n=new Set(prev); n.delete(id); return n; });

      const idToName = React.useMemo(()=>Object.fromEntries(options.map(o=>[o.id,o.name])),[options]);

      return (
        <Dialog open={open} onClose={onClose} fullWidth maxWidth="md">
          <DialogTitle>
            <Stack direction="row" justifyContent="space-between" alignItems="center" sx={{gap:1}}>
              <Typography variant="h6">{title}</Typography>
              <Stack direction="row" spacing={1} alignItems="center">
                <Button type="button" size="small" onClick={allSelect}>表示分を全選択</Button>
                <Button type="button" size="small" onClick={allClear}>表示分を全解除</Button>
                <FormControlLabel control={<Switch size="small" checked={onlySelected} onChange={(e)=>setOnlySelected(e.target.checked)} />} label="選択中のみ表示" />
              </Stack>
            </Stack>
          </DialogTitle>
          <DialogContent dividers>
            <Stack direction="row" spacing={2}>
              <Box sx={{flex:1, minWidth:0}}>
                <TextField size="small" fullWidth placeholder="検索（名前/ID）" value={kw} onChange={(e)=>setKw(e.target.value)}
                  InputProps={{startAdornment:<span className="material-icons" style={{opacity:.6, marginRight:6}}>search</span>}} sx={{mb:1}}/>
                <Paper variant="outlined" sx={{maxHeight:420, overflow:"auto"}}>
                  <List dense>
                    {filtered.map(opt=>(
                      <ListItemButton key={opt.id} onClick={()=>toggle(opt.id)}>
                        <ListItemIcon><Checkbox edge="start" checked={local.has(opt.id)} tabIndex={-1}/></ListItemIcon>
                        <ListItemText primary={opt.name} secondary={showId?opt.id:null}/>
                      </ListItemButton>
                    ))}
                    {filtered.length===0 && (<Box sx={{p:2, color:"text.secondary"}}>該当がありません。</Box>)}
                  </List>
                </Paper>
              </Box>
              <Paper variant="outlined" sx={{width:300, p:1.5, alignSelf:"stretch"}}>
                <Stack direction="row" justifyContent="space-between" alignItems="center" sx={{mb:1}}>
                  <Typography variant="subtitle2">選択中（{local.size}）</Typography>
                  <Button type="button" size="small" onClick={()=>setLocal(new Set())}>すべて解除</Button>
                </Stack>
                <Box sx={{display:"flex", flexWrap:"wrap", gap:.5, maxHeight:360, overflow:"auto"}}>
                  {Array.from(local).map(id=>(
                    <Chip key={id} size="small" label={idToName[id]||id} onDelete={()=>removeOne(id)}/>
                  ))}
                  {local.size===0 && <span style={{opacity:.7}}>未選択</span>}
                </Box>
              </Paper>
            </Stack>
          </DialogContent>
          <DialogActions>
            <Button type="button" onClick={onClose}>キャンセル</Button>
            <Button type="button" variant="contained" onClick={()=>onApply(Array.from(local))} startIcon={<span className="material-icons">check</span>}>適用</Button>
          </DialogActions>
        </Dialog>
      );
    };

    // ====== 招待リンク作成（個人＝完全新規） ======
    const InviteCreateDialog = ({ open, onClose, onCreate, serviceId, showMessage }) => {
      const [targetType, setTargetType] = useState("社内組織"); // 社内組織 | 社外組織 | 個人(新規)
      const [orgId, setOrgId] = useState("");
      const [role, setRole] = useState("一般");
      const [days, setDays] = useState(7);

      React.useEffect(()=>{ if(open){ setTargetType("社内組織"); setOrgId(""); setRole("一般"); setDays(7);} },[open]);

      const list = targetType==="社内組織" ? INTERNAL_ORGS : PARTNER_ORGS;
      const expiresAtIso = () => { const d=new Date(); d.setDate(d.getDate() + (parseInt(days,10)||0)); return d.toISOString(); };

      const handleCreate = () => {
        if(targetType!=="個人" && !orgId) return showMessage("入力エラー", "組織を選択してください。");
        const targetId = (targetType==="個人") ? "new" : orgId; // 個人は完全新規

        const inv = {
          id: Math.random().toString(36).slice(2,10),
          url: makeInviteUrl(serviceId),
          targetType, targetId, role,
          expiresAt: expiresAtIso(),
          enabled: true,
          createdBy: CURRENT_USER,
          usedBy: null
        };
        onCreate(inv);
        onClose();
      };

      return (
        <Dialog open={open} onClose={onClose} fullWidth maxWidth="sm">
          <DialogTitle>招待リンクを作成</DialogTitle>
          <DialogContent dividers>
            <Stack spacing={2}>
              <Box>
                <Typography variant="caption">対象</Typography>
                <RadioGroup row value={targetType} onChange={(e)=>{ setTargetType(e.target.value); setOrgId(""); }}>
                  <FormControlLabel value="社内組織" control={<Radio/>} label="社内組織" />
                  <FormControlLabel value="社外組織" control={<Radio/>} label="社外組織（取引先）" />
                  <FormControlLabel value="個人"   control={<Radio/>} label="個人（新規ユーザー）" />
                </RadioGroup>
              </Box>

              {targetType!=="個人" && (
                <Box>
                  <Typography variant="caption">組織</Typography>
                  <Select fullWidth value={orgId} onChange={(e)=>setOrgId(e.target.value)} displayEmpty>
                    <MenuItem value=""><em>選択してください</em></MenuItem>
                    {list.map(o => <MenuItem key={o.id} value={o.id}>{o.name} <span style={{opacity:.6, marginLeft:8}}>({o.id})</span></MenuItem>)}
                  </Select>
                </Box>
              )}

              <Box>
                <Typography variant="caption">役割</Typography>
                <Select fullWidth value={role} onChange={(e)=>setRole(e.target.value)}>
                  {ROLE_OPTIONS.map(r => <MenuItem key={r} value={r}>{r}</MenuItem>)}
                </Select>
              </Box>

              <Box>
                <Typography variant="caption">有効期限（日数）</Typography>
                <TextField type="number" inputProps={{min:1, step:1}} value={days} onChange={(e)=>setDays(e.target.value)} fullWidth />
              </Box>

              <Alert severity="info" sx={{lineHeight:1.6}}>
                個人は<strong>完全新規ユーザー</strong>向けの招待です。<br/>
                既存ユーザーがこのリンクを利用した場合は、<strong>そのユーザーに本サービスの利用権限が追加</strong>されます。<br/>
                送信は各自のメールソフトで行ってください（作成後に共有ダイアログが表示されます）。
              </Alert>
            </Stack>
          </DialogContent>
          <DialogActions>
            <Button type="button" onClick={onClose}>キャンセル</Button>
            <Button type="button" variant="contained" onClick={handleCreate} startIcon={<span className="material-icons">link</span>}>作成</Button>
          </DialogActions>
        </Dialog>
      );
    };

    // ====== 招待リンク共有（コピー／メール作成） ======
    const InviteShareDialog = ({ open, onClose, serviceName, invite, showMessage }) => {
      if(!invite) return null;
      const subject = `【${serviceName}】ユーザー招待のご案内`;
      const body = [
        `${serviceName} への登録をご案内します。`,
        ``,
        `▼ 招待リンク`,
        `${invite.url}`,
        ``,
        `役割: ${invite.role}`,
        `有効期限: ${new Date(invite.expiresAt).toLocaleString()}`,
        ``,
        `※ 新規ユーザーはこのリンクから登録できます。既存ユーザーがアクセスした場合は、利用できるサービスが追加されます。`,
        `※ このメールはシステムから自動送信されません。必要に応じて転送・編集してご利用ください。`
      ].join('%0D%0A');

      const openMail = () => {
        const mailto = `mailto:?subject=${encodeURIComponent(subject)}&body=${body}`;
        window.open(mailto, '_blank');
      };

      const copy = async () => {
        try { await navigator.clipboard.writeText(invite.url); showMessage("完了", "招待リンクをコピーしました。"); }
        catch { showMessage("エラー", "クリップボードへのコピーに失敗しました。"); }
      };

      return (
        <Dialog open={open} onClose={onClose} fullWidth maxWidth="sm">
          <DialogTitle>招待リンクを共有</DialogTitle>
          <DialogContent dividers>
            <Stack spacing={2}>
              <Box>
                <Typography variant="caption">招待URL</Typography>
                <Box sx={{display:'flex', gap:1, alignItems:'center', mt:.5}}>
                  <TextField size="small" fullWidth value={invite.url} InputProps={{readOnly:true}}/>
                  <IconButton type="button" onClick={copy}><span className="material-icons">content_copy</span></IconButton>
                </Box>
              </Box>
              <Alert severity="info">このリンクをメールソフトで送ってください。下の「メール作成」を押すと、件名・本文に埋め込んだメールが開きます。</Alert>
            </Stack>
          </DialogContent>
          <DialogActions>
            <Button type="button" onClick={onClose}>閉じる</Button>
            <Button type="button" variant="contained" onClick={openMail} startIcon={<span className="material-icons">outgoing_mail</span>}>メール作成</Button>
          </DialogActions>
        </Dialog>
      );
    };

    // ====== 招待リンク管理（変更なし） ======
    const InviteManageDialog = ({ open, onClose, invites, setInvites, serviceName, showMessage }) => {
      const [tab, setTab] = useState("enabled");
      const [shareTarget, setShareTarget] = useState(null);

      React.useEffect(()=>{ if(open){ setTab("enabled"); setShareTarget(null); } }, [open]);

      const copy = async (url) => { try { await navigator.clipboard.writeText(url); showMessage("完了", "招待リンクをコピーしました。"); } catch { showMessage("エラー", "コピーに失敗しました。"); } };
      const status = (i) => {
        const now = new Date();
        const exp = new Date(i.expiresAt);
        if(exp < now) return { label:"期限切れ", color:"warning" };
        return i.enabled ? { label:"有効", color:"success" } : { label:"無効", color:"default" };
      };

      const toggleEnabled = (id) => setInvites(prev => prev.map(i => i.id===id ? {...i, enabled: !i.enabled} : i));
      const remove = (id) => setInvites(prev => prev.filter(i => i.id!==id));

      const idToName = (id, pool) => (pool.find(x=>x.id===id)?.name) || id;

      const filteredInvites = invites.filter(i=>{
        if(tab==="enabled")  return i.enabled;
        if(tab==="disabled") return !i.enabled;
        return true;
      });

      const renderTarget = (i) => {
        if(i.targetType==="個人"){
          return "個人: 新規ユーザー";
        }
        if(i.targetType==="社内組織"){
          return `社内: ${idToName(i.targetId, INTERNAL_ORGS)}`;
        }
        return `社外: ${idToName(i.targetId, PARTNER_ORGS)}`;
      };

      return (
        <>
          <Dialog open={open} onClose={onClose} fullWidth maxWidth="lg">
            <DialogTitle>招待リンク管理</DialogTitle>

            <Tabs value={tab} onChange={(_,v)=>setTab(v)} sx={{px:2}}>
              <Tab label="有効" value="enabled" />
              <Tab label="すべて" value="all" />
              <Tab label="無効" value="disabled" />
            </Tabs>

            <DialogContent dividers>
              <Table size="small" sx={spreadsheetTableSx}>
                <TableHead>
                  <TableRow>
                    <TableCell>状態</TableCell>
                    <TableCell>対象</TableCell>
                    <TableCell>URL</TableCell>
                    <TableCell>役割</TableCell>
                    <TableCell>期限</TableCell>
                    <TableCell>作成ユーザー</TableCell>
                    <TableCell>登録ユーザー</TableCell>
                    <TableCell align="right">操作</TableCell>
                  </TableRow>
                </TableHead>
                <TableBody>
                  {filteredInvites.length===0 && (
                    <TableRow><TableCell colSpan="8"><span style={{opacity:.7}}>該当するリンクはありません。</span></TableCell></TableRow>
                  )}
                  {filteredInvites.map(i=>{
                    const s = status(i);
                    return (
                      <TableRow key={i.id}>
                        <TableCell><Chip size="small" label={s.label} color={s.color}/></TableCell>
                        <TableCell>{renderTarget(i)}</TableCell>
                        <TableCell>
                          <Box sx={{display:"flex", alignItems:"center", gap:1}}>
                            <TextField value={i.url} size="small" fullWidth InputProps={{readOnly:true}}/>
                            <IconButton onClick={()=>copy(i.url)}><span className="material-icons">content_copy</span></IconButton>
                          </Box>
                        </TableCell>
                        <TableCell>{i.role}</TableCell>
                        <TableCell>{new Date(i.expiresAt).toLocaleString()}</TableCell>
                        <TableCell>{i.createdBy?.name || "-"}</TableCell>
                        <TableCell>{i.usedBy?.name || <span style={{opacity:.6}}>未登録</span>}</TableCell>
                        <TableCell align="right">
                          <Stack direction="row" spacing={1} justifyContent="flex-end">
                            <Button type="button" size="small" onClick={()=>setShareTarget(i)}>メール作成</Button>
                            <Button type="button" size="small" onClick={()=>toggleEnabled(i.id)}>{i.enabled ? "無効化" : "有効化"}</Button>
                            <Button type="button" size="small" color="error" onClick={()=>remove(i.id)}>削除</Button>
                          </Stack>
                        </TableCell>
                      </TableRow>
                    );
                  })}
                </TableBody>
              </Table>
            </DialogContent>
            <DialogActions><Button type="button" onClick={onClose}>閉じる</Button></DialogActions>
          </Dialog>

          {/* 共有（mailto） */}
          <InviteShareDialog
            open={!!shareTarget}
            onClose={()=>setShareTarget(null)}
            serviceName={serviceName}
            invite={shareTarget}
            showMessage={showMessage}
          />
        </>
      );
    };

    // ====== サービス単位ユーザー管理（検索＋確認/削除＋有効切替） ======
    const UserManageDialog = ({ open, onClose, serviceName, users, onRemoveUser, onToggleUser }) => {
      const [kw, setKw] = useState("");
      const [confirm, setConfirm] = useState({ open:false, target:null });

      const filtered = useMemo(()=>{
        const k = kw.trim().toLowerCase();
        if(!k) return users;
        return users.filter(u=>{
          const user = USERS.find(x=>x.id===u.userId);
          return (user?.name||"").toLowerCase().includes(k) || (u.userId||"").toLowerCase().includes(k);
        });
      }, [kw, users]);

      const statusLabel = (enabled) => enabled ? "利用中" : "停止中";

      return (
        <>
          <Dialog open={open} onClose={onClose} fullWidth maxWidth="md">
            <DialogTitle>{serviceName} のユーザー管理</DialogTitle>
            <DialogContent dividers>
              <Stack spacing={1.5}>
                <Alert severity="info" sx={{lineHeight:1.6}}>
                  この画面では<strong>招待URLから登録済みのユーザー</strong>のみ表示します。<br/>
                  既存ユーザーへの直接付与や手動追加はできません。ユーザー登録は必ず招待URL経由で本人に実施してもらってください。
                </Alert>
                <TextField size="small" placeholder="ユーザーを検索（名前/ID）" value={kw} onChange={e=>setKw(e.target.value)}
                  InputProps={{startAdornment:<span className="material-icons" style={{opacity:.6, marginRight:6}}>search</span>}}/>
                <Paper variant="outlined">
                  <Table size="small" sx={spreadsheetTableSx}>
                    <TableHead>
                      <TableRow>
                        <TableCell>ユーザー名</TableCell>
                        <TableCell>ユーザーID</TableCell>
                        <TableCell>ステータス</TableCell>
                        <TableCell>有効/無効</TableCell>
                        <TableCell align="right">操作</TableCell>
                      </TableRow>
                    </TableHead>
                    <TableBody>
                      {filtered.length===0 && (
                        <TableRow><TableCell colSpan="5"><span style={{opacity:.7}}>該当するユーザーがいません。</span></TableCell></TableRow>
                      )}
                      {filtered.map(u=>{
                        const user = USERS.find(x=>x.id===u.userId);
                        return (
                          <TableRow key={u.userId}>
                            <TableCell>{user?.name || u.userId}</TableCell>
                            <TableCell>{u.userId}</TableCell>
                            <TableCell>{statusLabel(u.enabled)}</TableCell>
                            <TableCell>
                              <FormControlLabel
                                control={<Switch checked={u.enabled} onChange={(e)=>onToggleUser(u.userId, e.target.checked)} />}
                                label={u.enabled ? "有効" : "無効"}
                              />
                            </TableCell>
                            <TableCell align="right">
                              <Button type="button" size="small" color="error" onClick={()=>setConfirm({open:true, target:u.userId})}>削除</Button>
                            </TableCell>
                          </TableRow>
                        );
                      })}
                    </TableBody>
                  </Table>
                </Paper>
              </Stack>
            </DialogContent>
            <DialogActions><Button type="button" onClick={onClose}>閉じる</Button></DialogActions>
          </Dialog>

          <ConfirmDialog
            open={confirm.open}
            title="ユーザー削除の確認"
            message="このユーザーの本サービス利用を削除します。よろしいですか？"
            onCancel={()=>setConfirm({open:false, target:null})}
            onConfirm={()=>{ onRemoveUser(confirm.target); setConfirm({open:false, target:null}); }}
          />
        </>
      );
    };

    // ====== サービス一覧（非編集=正方形カード） ======
    const ServiceGrid = ({ services, settingsMap, setServices, editMode, setEditMode, onOpenSettings, onOpenCreate, onOpenManage }) => {
      const [keyword, setKeyword] = useState("");
      const draggingIdRef = useRef(null);

      const filtered = useMemo(()=>{
        const kw = keyword.trim().toLowerCase();
        if(!kw) return services;
        return services.filter(s => s.name.toLowerCase().includes(kw));
      }, [services, keyword]);

      const handleDragStart = (e, id) => { if(!editMode) return; draggingIdRef.current = id; e.currentTarget.classList.add('dragging'); e.dataTransfer.effectAllowed = 'move'; };
      const handleDragEnd = (e) => { e.currentTarget.classList.remove('dragging'); draggingIdRef.current = null; };
      const handleDragOver = (e) => { if(editMode){ e.preventDefault(); } };
      const handleDrop = (e, overId) => {
        if(!editMode) return; e.preventDefault();
        const fromId = draggingIdRef.current; if(!fromId || fromId===overId) return;
        const newOrder = [...services];
        const fromIdx = newOrder.findIndex(s=>s.id===fromId);
        const toIdx   = newOrder.findIndex(s=>s.id===overId);
        const [moved] = newOrder.splice(fromIdx,1);
        newOrder.splice(toIdx,0,moved);
        setServices(newOrder);
      };

      return (
        <Paper variant="outlined" sx={{p:1, pb:1}}>
          <Stack direction="row" spacing={1} alignItems="center" sx={{mb:1}}>
            <span className="material-icons" style={{ opacity:.6 }}>search</span>
            <TextField size="small" placeholder="サービスを検索" value={keyword} onChange={e=>setKeyword(e.target.value)} fullWidth/>
            <FormControlLabel control={<Switch checked={editMode} onChange={(e)=>setEditMode(e.target.checked)} />} label="編集モード" sx={{ml:1, mr:0}}/>
          </Stack>

          <Grid container spacing={1}>
            {filtered.map(svc=>{
              const st = settingsMap[svc.id] || defaultSettings(svc.id);
              const owners = (st.ownerInternal?.length||0) + (st.ownerExternal?.length||0) + (st.ownerUsers?.length||0);
              const assigns = (st.internalAssigned?.length||0) + (st.externalAssigned?.length||0);
              const inviteEnabled = !!st.inviteEnabled;

              return (
                <Grid item xs={4} sm={4} md={3} lg={2.4} xl={2} key={svc.id}>
                  <Card
                    variant="outlined"
                    draggable={editMode}
                    onDragStart={(e)=>handleDragStart(e, svc.id)}
                    onDragEnd={handleDragEnd}
                    onDragOver={handleDragOver}
                    onDrop={(e)=>handleDrop(e, svc.id)}
                    sx={{ position:"relative", display:"flex", flexDirection:"column", height:"100%", outline: editMode ? "1px dashed #90caf9" : "none" }}
                  >
                    {editMode && (
                      <Box sx={{position:"absolute", top:6, left:8, display:"flex", alignItems:"center", gap:.5, color:"text.secondary"}}>
                        <span className="material-icons" style={{fontSize:18}}>drag_indicator</span>
                      </Box>
                    )}

                    <CardContent sx={{flexGrow:1, display:"flex", flexDirection:"column", gap:1, pt: editMode ? 4 : 1}}>
                      {!editMode ? (
                        <Box sx={{ width:'100%', aspectRatio:'1 / 1', display:'flex', alignItems:'center', justifyContent:'center' }}>
                          <Avatar sx={{width:60, height:60}}>{svc.name[0]}</Avatar>
                        </Box>
                      ) : (
                        <Box sx={{display:'flex', alignItems:'center', justifyContent:'center'}}>
                          <Badge color="primary" badgeContent={owners + assigns} showZero overlap="circular">
                            <Avatar sx={{width:52, height:52}}>{svc.name[0]}</Avatar>
                          </Badge>
                        </Box>
                      )}
                      <Typography variant="subtitle2" sx={{textAlign:"center"}}>{svc.name}</Typography>
                      {editMode && (
                        <Typography variant="caption" sx={{textAlign:"center", color:"text.secondary"}}>
                          オーナー:{owners} / 利用割当:{assigns}{inviteEnabled ? " / 招待リンク:有効" : ""}
                        </Typography>
                      )}
                    </CardContent>

                    {editMode && (
                      <Box sx={{px:1, pb:1}}>
                        <Stack direction="row" spacing={0.5}>
                          <Button type="button" fullWidth variant="contained" size="small" onClick={()=>onOpenSettings(svc.id)} startIcon={<span className="material-icons">tune</span>}>設定</Button>
                          <Button type="button" fullWidth variant="outlined" size="small" disabled={!inviteEnabled} onClick={()=>onOpenCreate(svc.id)} startIcon={<span className="material-icons">add_link</span>}>作成</Button>
                          <Button type="button" fullWidth variant="outlined" size="small" disabled={!inviteEnabled} onClick={()=>onOpenManage(svc.id)} startIcon={<span className="material-icons">settings</span>}>管理</Button>
                        </Stack>
                        {!inviteEnabled && <Typography variant="caption" sx={{mt:.25, color:"text.secondary"}}>※ 設定で招待リンク機能を有効化可</Typography>}
                      </Box>
                    )}
                  </Card>
                </Grid>
              );
            })}
            {filtered.length===0 && (
              <Grid item xs={12}>
                <Box sx={{p:2, color:"text.secondary"}}>該当するサービスがありません。</Box>
              </Grid>
            )}
          </Grid>
        </Paper>
      );
    };

    // ====== ユーザー招待ページ（招待有効サービスの一覧） ======
    const InviteServicesPage = ({ services, settingsMap, onOpenCreate, onOpenManage, onOpenUserManage }) => {
      const [kw, setKw] = useState("");
      const servicesWithInvite = useMemo(()=>{
        const list = services.filter(s => (settingsMap[s.id]?.inviteEnabled));
        const k = kw.trim().toLowerCase();
        return k ? list.filter(s=>s.name.toLowerCase().includes(k)) : list;
      }, [services, settingsMap, kw]);

      return (
        <Paper variant="outlined" sx={{p:1}}>
          <Stack direction="row" spacing={1} alignItems="center" sx={{mb:1}}>
            <span className="material-icons" style={{ opacity:.6 }}>search</span>
            <TextField size="small" placeholder="サービスを検索（招待有効のみ）" value={kw} onChange={e=>setKw(e.target.value)} fullWidth/>
          </Stack>

          <Table size="small" sx={spreadsheetTableSx}>
            <TableHead>
              <TableRow>
                <TableCell>サービス</TableCell>
                <TableCell>招待数</TableCell>
                <TableCell>最近の1件</TableCell>
                <TableCell align="right">操作</TableCell>
              </TableRow>
            </TableHead>
            <TableBody>
              {servicesWithInvite.length===0 && (
                <TableRow><TableCell colSpan="4"><span style={{opacity:.7}}>招待リンク機能が有効なサービスがありません。</span></TableCell></TableRow>
              )}
              {servicesWithInvite.map(svc=>{
                const st = settingsMap[svc.id] || defaultSettings(svc.id);
                const last = st.invites[st.invites.length-1];
                const renderLast = () => {
                  if(!last) return <span style={{opacity:.6}}>—</span>;
                  const who = last.targetType==="個人"
                    ? (last.usedBy?.name || "新規ユーザー")
                    : (last.targetType==="社内組織" ? INTERNAL_ORGS.find(o=>o.id===last.targetId)?.name : PARTNER_ORGS.find(o=>o.id===last.targetId)?.name) || last.targetId;
                  return `${who} / ${last.role} / ${new Date(last.expiresAt).toLocaleDateString()}`;
                };
                return (
                  <TableRow key={svc.id} hover>
                    <TableCell>
                      <Stack direction="row" spacing={1} alignItems="center">
                        <Avatar sx={{width:28,height:28}}>{svc.name[0]}</Avatar>
                        <Typography>{svc.name}</Typography>
                      </Stack>
                    </TableCell>
                    <TableCell>{st.invites.length}</TableCell>
                    <TableCell>{renderLast()}</TableCell>
                    <TableCell align="right">
                      <Stack direction="row" spacing={1} justifyContent="flex-end">
                        <Button type="button" size="small" variant="outlined" onClick={()=>onOpenUserManage(svc.id)} startIcon={<span className="material-icons">manage_accounts</span>}>ユーザー管理</Button>
                        <Button type="button" size="small" variant="outlined" onClick={()=>onOpenCreate(svc.id)} startIcon={<span className="material-icons">add_link</span>}>リンク作成</Button>
                        <Button type="button" size="small" variant="outlined" onClick={()=>onOpenManage(svc.id)} startIcon={<span className="material-icons">settings</span>}>管理</Button>
                      </Stack>
                    </TableCell>
                  </TableRow>
                );
              })}
            </TableBody>
          </Table>
        </Paper>
      );
    };

    // ==== 置き換え：ServiceSettingsModal ====
    const ServiceSettingsModal = ({ open, service, settings, onChange, onClose, showMessage }) => {
      const [picker, setPicker] = React.useState({ open:false, target:null });
      if (!service) return null;

      const setField = (key, value) => onChange({ ...settings, [key]: value });
      const openPicker = (target) => setPicker({ open:true, target });
      const closePicker = () => setPicker({ open:false, target:null });
      const applyPicker = (ids) => { setField(picker.target, ids); closePicker(); };

      const pickerMeta = (()=> {
        switch(picker.target){
          case 'ownerInternal':    return { title:'サービスオーナー（社内組織）を選択', options: INTERNAL_ORGS, selected: settings.ownerInternal };
          case 'ownerExternal':    return { title:'サービスオーナー（社外組織）を選択', options: PARTNER_ORGS, selected: settings.ownerExternal };
          case 'ownerUsers':       return { title:'サービスオーナー（個人ユーザー）を選択', options: USERS, selected: settings.ownerUsers, showId:false };
          case 'internalAssigned': return { title:'利用割当：社内組織を選択', options: INTERNAL_ORGS, selected: settings.internalAssigned };
          case 'externalAssigned': return { title:'利用割当：社外組織（取引先）を選択', options: PARTNER_ORGS, selected: settings.externalAssigned };
          default:                 return { title:'', options: [], selected: [] };
        }
      })();

      const renderSelectedChips = (ids, dict, emptyLabel) => {
        if(!ids || ids.length===0) return <span style={{opacity:.7}}>{emptyLabel}</span>;
        const nameMap = Object.fromEntries(dict.map(d=>[d.id, d.name]));
        return (
          <Box sx={{display:'flex', flexWrap:'wrap', gap:.5}}>
            {ids.map(id => <Chip key={id} size="small" label={nameMap[id]||id} />)}
          </Box>
        );
      };

      const regUrl = makeRegistrationUrl(service.id);
      const copyReg = async () => {
        try { await navigator.clipboard.writeText(regUrl); showMessage("完了", "登録ページURLをコピーしました。"); }
        catch { showMessage("エラー", "コピーに失敗しました。"); }
      };

      return (
        <>
          <Dialog open={open} onClose={onClose} fullWidth maxWidth="md">
            <DialogTitle>
              <Stack direction="row" justifyContent="space-between" alignItems="center">
                <Typography variant="h6">{service.name} の設定</Typography>
                <Chip size="small" variant="outlined" label="保存なしデモ"/>
              </Stack>
            </DialogTitle>

            <DialogContent dividers>
              <Stack spacing={3}>
                {/* プラットフォーム */}
                <Paper variant="outlined" sx={{p:2}}>
                  <Typography variant="subtitle1">プラットフォーム</Typography>
                  <FormControlLabel
                    control={<Switch checked={settings.platformEnabled} onChange={(e)=>setField("platformEnabled", e.target.checked)} />}
                    label="有効にする"
                  />
                </Paper>

                {/* 新規ユーザー登録用ページ（URL表示） */}
                <Paper variant="outlined" sx={{p:2}}>
                  <Typography variant="subtitle1">新規ユーザー登録用ページ</Typography>
                  <FormControlLabel
                    control={<Switch checked={settings.registrationPageEnabled} onChange={(e)=>setField("registrationPageEnabled", e.target.checked)} />}
                    label={settings.registrationPageEnabled ? "有効" : "無効"}
                  />
                  {settings.registrationPageEnabled && (
                    <Box sx={{mt:1}}>
                      <Typography variant="caption" sx={{display:'block', mb:.5, color:'text.secondary'}}>登録ページURL</Typography>
                      <Box sx={{display:'flex', gap:1, alignItems:'center'}}>
                        <TextField size="small" fullWidth value={regUrl} InputProps={{readOnly:true}}/>
                        <IconButton type="button" onClick={copyReg}><span className="material-icons">content_copy</span></IconButton>
                      </Box>
                    </Box>
                  )}
                </Paper>

                {/* サービスオーナー（社内／社外／個人ユーザー） */}
                <Paper variant="outlined" sx={{p:2}}>
                  <Typography variant="subtitle1" sx={{mb:1}}>サービスオーナー（複数選択可）</Typography>

                  <Stack spacing={1.5}>
                    <Stack direction="row" justifyContent="space-between" alignItems="center">
                      <Typography variant="body2">社内組織</Typography>
                      <Button type="button" size="small" onClick={()=>openPicker('ownerInternal')} startIcon={<span className="material-icons">edit</span>}>選択…</Button>
                    </Stack>
                    {renderSelectedChips(settings.ownerInternal, INTERNAL_ORGS, "未選択")}

                    <Divider sx={{my:1.5}}/>

                    <Stack direction="row" justifyContent="space-between" alignItems="center">
                      <Typography variant="body2">社外組織（取引先）</Typography>
                      <Button type="button" size="small" onClick={()=>openPicker('ownerExternal')} startIcon={<span className="material-icons">edit</span>}>選択…</Button>
                    </Stack>
                    {renderSelectedChips(settings.ownerExternal, PARTNER_ORGS, "未選択")}

                    <Divider sx={{my:1.5}}/>

                    <Stack direction="row" justifyContent="space-between" alignItems="center">
                      <Typography variant="body2">個人ユーザー</Typography>
                      <Button type="button" size="small" onClick={()=>openPicker('ownerUsers')} startIcon={<span className="material-icons">edit</span>}>選択…</Button>
                    </Stack>
                    {renderSelectedChips(settings.ownerUsers, USERS, "未選択")}
                  </Stack>
                </Paper>

                {/* 利用割当（社内／社外） */}
                <Paper variant="outlined" sx={{p:2}}>
                  <Typography variant="subtitle1" sx={{mb:1}}>利用割当</Typography>

                  <Stack spacing={1.5}>
                    <Stack direction="row" justifyContent="space-between" alignItems="center">
                      <Typography variant="body2">社内組織</Typography>
                      <Button type="button" size="small" onClick={()=>openPicker('internalAssigned')} startIcon={<span className="material-icons">edit</span>}>選択…</Button>
                    </Stack>
                    {renderSelectedChips(settings.internalAssigned, INTERNAL_ORGS, "未選択")}

                    <Divider sx={{my:1.5}}/>

                    <Stack direction="row" justifyContent="space-between" alignItems="center">
                      <Typography variant="body2">社外組織（取引先）</Typography>
                      <Button type="button" size="small" onClick={()=>openPicker('externalAssigned')} startIcon={<span className="material-icons">edit</span>}>選択…</Button>
                    </Stack>
                    {renderSelectedChips(settings.externalAssigned, PARTNER_ORGS, "未選択")}
                  </Stack>
                </Paper>

                {/* 個人（社外）の利用 */}
                <Paper variant="outlined" sx={{p:2}}>
                  <Typography variant="subtitle1">個人（社外）の利用</Typography>
                  <FormControlLabel
                    control={<Switch checked={settings.externalIndividualsEnabled} onChange={(e)=>setField("externalIndividualsEnabled", e.target.checked)} />}
                    label="有効にする"
                  />
                </Paper>

                {/* 招待リンク機能 */}
                <Paper variant="outlined" sx={{p:2}}>
                  <Typography variant="subtitle1">新規ユーザー招待リンク機能</Typography>
                  <FormControlLabel
                    control={<Switch checked={settings.inviteEnabled} onChange={(e)=>setField("inviteEnabled", e.target.checked)} />}
                    label={settings.inviteEnabled ? "有効（ユーザー招待ページで操作可）" : "無効"}
                  />
                </Paper>
              </Stack>
            </DialogContent>

            <DialogActions>
              <Button type="button" onClick={onClose}>閉じる</Button>
              <Button type="button" variant="contained" onClick={onClose} startIcon={<span className="material-icons">check</span>}>適用（デモ）</Button>
            </DialogActions>
          </Dialog>

          {/* 大量選択ピッカー（社内／社外／個人ユーザー） */}
          <MultiPickerDialog
            open={picker.open}
            title={pickerMeta.title}
            options={pickerMeta.options}
            selectedIds={pickerMeta.selected}
            onClose={closePicker}
            onApply={applyPicker}
            showId={pickerMeta.showId!==false}
          />
        </>
      );
    };


    // ====== ユーザー管理（レフトナビ） ======
    const UsersPage = ({ services, settingsMap }) => {
      const [kw, setKw] = useState("");
      const [onlyActive, setOnlyActive] = useState(true); // サービス利用者のみ

      // userId -> { enabled:数, disabled:数, services:[{s, enabled}] }
      const map = useMemo(()=>{
        const m = new Map();
        services.forEach(s=>{
          const st = settingsMap[s.id] || defaultSettings(s.id);
          (st.users||[]).forEach(u=>{
            if(!m.has(u.userId)) m.set(u.userId, { enabled:0, disabled:0, services:[] });
            const rec = m.get(u.userId);
            if(u.enabled) rec.enabled++; else rec.disabled++;
            rec.services.push({ service:s, enabled:u.enabled });
          });
        });
        return m;
      }, [services, settingsMap]);

      const rows = useMemo(()=>{
        const base = onlyActive ? USERS.filter(u=>map.has(u.id)) : USERS.slice();
        const k = kw.trim().toLowerCase();
        const f = k ? base.filter(u=>u.name.toLowerCase().includes(k) || u.id.toLowerCase().includes(k)) : base;
        return f.map(u=>{
          const rec = map.get(u.id) || {enabled:0,disabled:0,services:[]};
          const status = rec.enabled>0 ? "利用中" : (rec.disabled>0 ? "停止中" : "未登録");
          return { user:u, status, stats:rec };
        });
      }, [kw, onlyActive, map]);

      return (
        <Paper variant="outlined" sx={{p:1}}>
          <Stack direction="row" spacing={1} alignItems="center" sx={{mb:1}}>
            <span className="material-icons" style={{ opacity:.6 }}>search</span>
            <TextField size="small" placeholder="ユーザーを検索（名前/ID）" value={kw} onChange={e=>setKw(e.target.value)} fullWidth/>
            <FormControlLabel control={<Switch checked={onlyActive} onChange={e=>setOnlyActive(e.target.checked)} />} label="サービス利用者のみ" />
          </Stack>
          <Table size="small" sx={spreadsheetTableSx}>
            <TableHead>
              <TableRow>
                <TableCell>ユーザー名</TableCell>
                <TableCell>ユーザーID</TableCell>
                <TableCell>ステータス</TableCell>
                <TableCell>有効/無効</TableCell>
                <TableCell>利用中サービス</TableCell>
                <TableCell align="right">件数</TableCell>
              </TableRow>
            </TableHead>
            <TableBody>
              {rows.length===0 && (
                <TableRow><TableCell colSpan="6"><span style={{opacity:.7}}>該当がありません。</span></TableCell></TableRow>
              )}
              {rows.map(({user, status, stats})=>(
                <TableRow key={user.id}>
                  <TableCell>{user.name}</TableCell>
                  <TableCell>{user.id}</TableCell>
                  <TableCell>{status}</TableCell>
                  <TableCell>有効 {stats.enabled} / 無効 {stats.disabled}</TableCell>
                  <TableCell>
                    <Box sx={{display:'flex', flexWrap:'wrap', gap:.5}}>
                      {stats.services.map(({service,enabled})=> (
                        <Chip key={service.id} size="small" variant={enabled?'filled':'outlined'} label={`${service.name}${enabled?'':'（無効）'}`}/>
                      ))}
                      {stats.services.length===0 && <span style={{opacity:.6}}>—</span>}
                    </Box>
                  </TableCell>
                  <TableCell align="right">{stats.services.length}</TableCell>
                </TableRow>
              ))}
            </TableBody>
          </Table>
        </Paper>
      );
    };

    // ====== 組織管理（レフトナビ） ======
    const OrgsPage = ({ services, settingsMap }) => {
      const [tab, setTab] = useState("internal"); // internal | external
      const [kw, setKw] = useState("");

      const list = tab==="internal" ? INTERNAL_ORGS : PARTNER_ORGS;

      // 組織ごとの割当集計
      const rows = useMemo(()=>{
        const k = kw.trim().toLowerCase();
        const filt = k ? list.filter(o=>o.name.toLowerCase().includes(k) || o.id.toLowerCase().includes(k)) : list.slice();
        return filt.map(org=>{
          let ownerCount = 0;
          let assignCount = 0;
          services.forEach(s=>{
            const st = settingsMap[s.id] || defaultSettings(s.id);
            if(tab==="internal"){
              if(st.ownerInternal.includes(org.id)) ownerCount++;
              if(st.internalAssigned.includes(org.id)) assignCount++;
            }else{
              if(st.ownerExternal.includes(org.id)) ownerCount++;
              if(st.externalAssigned.includes(org.id)) assignCount++;
            }
          });
          const total = ownerCount + assignCount;
          const status = total>0 ? "割当あり" : "未割当";
          const enabledDisabled = total>0 ? "有効 / 無効 0" : "有効 0 / 無効";
          // 表示簡素化：有効/無効は概念上（割当あり＝有効）で表現
          return { org, ownerCount, assignCount, status, enabledDisabled: (total>0 ? "有効" : "無効") };
        });
      }, [tab, kw, services, settingsMap]);

      return (
        <Paper variant="outlined" sx={{p:1}}>
          <Tabs value={tab} onChange={(_,v)=>setTab(v)} sx={{mb:1}}>
            <Tab label="社内組織" value="internal"/>
            <Tab label="社外組織（取引先）" value="external"/>
          </Tabs>
          <Stack direction="row" spacing={1} alignItems="center" sx={{mb:1}}>
            <span className="material-icons" style={{ opacity:.6 }}>search</span>
            <TextField size="small" placeholder="組織を検索（名前/ID）" value={kw} onChange={e=>setKw(e.target.value)} fullWidth/>
          </Stack>

          <Table size="small" sx={spreadsheetTableSx}>
            <TableHead>
              <TableRow>
                <TableCell>組織名</TableCell>
                <TableCell>組織ID</TableCell>
                <TableCell>ステータス</TableCell>
                <TableCell>有効/無効</TableCell>
                <TableCell>オーナー割当数</TableCell>
                <TableCell>利用割当数</TableCell>
              </TableRow>
            </TableHead>
            <TableBody>
              {rows.length===0 && (
                <TableRow><TableCell colSpan="6"><span style={{opacity:.7}}>該当がありません。</span></TableCell></TableRow>
              )}
              {rows.map(({org, ownerCount, assignCount, status, enabledDisabled})=>(
                <TableRow key={org.id}>
                  <TableCell>{org.name}</TableCell>
                  <TableCell>{org.id}</TableCell>
                  <TableCell>{status}</TableCell>
                  <TableCell>{enabledDisabled}</TableCell>
                  <TableCell>{ownerCount}</TableCell>
                  <TableCell>{assignCount}</TableCell>
                </TableRow>
              ))}
            </TableBody>
          </Table>
        </Paper>
      );
    };

    // ====== レイアウト（AppBar / LeftNav / Footer） ======
    const drawerWidth = 260;

    const App = () => {
      const [services, setServices] = useState(DEFAULT_SERVICES);
      const [settingsMap, setSettingsMap] = useState(
        Object.fromEntries(DEFAULT_SERVICES.map(s => [s.id, defaultSettings(s.id)]))
      );
      const [activeId, setActiveId] = useState(null);
      const [inviteCreateFor, setInviteCreateFor] = useState(null);
      const [inviteManageFor, setInviteManageFor] = useState(null);
      const [shareInviteFor, setShareInviteFor] = useState(null);
      const [userManageFor, setUserManageFor] = useState(null); // サービスID
      const [mobileOpen, setMobileOpen] = useState(false);
      const [editMode, setEditMode] = useState(false);
      const [nav, setNav] = useState("services");

      // ★ レフトナビと同じタイトルを返す関数（メイン領域に表示）
      const navTitle = () => {
        switch (nav) {
          case "users":    return "ユーザー管理";
          case "services": return "サービス一覧";
          case "invites":  return "ユーザー招待";
          case "orgs":     return "組織管理";
          case "notify":   return "通知管理（ダミー）";
          default:         return "";
        }
      };

      // メッセージモーダル
      const [msg, setMsg] = useState({ open:false, title:"", message:"" });
      const showMessage = (title, message) => setMsg({ open:true, title, message });

      const activeService = services.find(s => s.id === activeId);

      const setSettingsFor = (svcId, newSettings) =>
        setSettingsMap(prev => ({ ...prev, [svcId]: newSettings }));

      // 招待作成
      const onCreateInvite = (serviceId, inv) => {
        setSettingsMap(prev => {
          const cur = prev[serviceId] || defaultSettings(serviceId);
          return { ...prev, [serviceId]: { ...cur, invites: [...cur.invites, inv] } };
        });
        setShareInviteFor({ serviceId, invite: inv });
      };

      // サービスのユーザー削除
      const removeUserFromService = (serviceId, userId) => {
        setSettingsMap(prev=>{
          const cur = prev[serviceId] || defaultSettings(serviceId);
          return { ...prev, [serviceId]: { ...cur, users: cur.users.filter(u=>u.userId!==userId) } };
        });
        showMessage("完了", "ユーザーを削除しました。");
      };

      // サービスのユーザー有効/無効切替
      const toggleUserEnabled = (serviceId, userId, enabled) => {
        setSettingsMap(prev=>{
          const cur = prev[serviceId] || defaultSettings(serviceId);
          return { ...prev, [serviceId]: { ...cur, users: cur.users.map(u=>u.userId===userId ? {...u, enabled} : u) } };
        });
      };

      const drawer = (
        <Box sx={{height:"100%", display:"flex", flexDirection:"column"}}>
          <Toolbar>
            <Stack direction="row" spacing={1} alignItems="center">
              <span className="material-icons">apps</span>
              <Typography variant="h6">Admin</Typography>
            </Stack>
          </Toolbar>
          <Divider />
          <List>
            <ListItemButton selected={nav==="users"} onClick={()=>setNav("users")}>
              <ListItemIcon><span className="material-icons">group</span></ListItemIcon>
              <ListItemText primary="ユーザー管理" />
            </ListItemButton>
            <ListItemButton selected={nav==="services"} onClick={()=>setNav("services")}>
              <ListItemIcon><span className="material-icons">view_module</span></ListItemIcon>
              <ListItemText primary="サービス一覧" />
            </ListItemButton>
            <ListItemButton selected={nav==="invites"} onClick={()=>setNav("invites")}>
              <ListItemIcon><span className="material-icons">link</span></ListItemIcon>
              <ListItemText primary="ユーザー招待" />
            </ListItemButton>
            <ListItemButton selected={nav==="orgs"} onClick={()=>setNav("orgs")}>
              <ListItemIcon><span className="material-icons">business</span></ListItemIcon>
              <ListItemText primary="組織管理" />
            </ListItemButton>
            <ListItemButton selected={nav==="notify"} onClick={()=>setNav("notify")}>
              <ListItemIcon><span className="material-icons">notifications</span></ListItemIcon>
              <ListItemText primary="通知管理（ダミー）" />
            </ListItemButton>
          </List>
          <Box sx={{flexGrow:1}}/>
          <Divider/>
          <Box sx={{p:2, color:"text.secondary", fontSize:12}}>
            バージョン 1.2 デモ
          </Box>
        </Box>
      );

      // URL クエリ(serverWindowId)掃除（不要なら削除）
      React.useEffect(() => {
        const url = new URL(window.location.href);
        if (url.searchParams.has('serverWindowId')) {
          url.searchParams.delete('serverWindowId');
          const qs = url.searchParams.toString();
          const clean = url.pathname + (qs ? `?${qs}` : '') + url.hash;
          window.history.replaceState({}, '', clean);
        }
      }, []);

      return (
        <Box sx={{ display: 'flex', minHeight:'100vh' }}>
          <CssBaseline />

          {/* AppBar */}
          <AppBar position="fixed" sx={{ zIndex: (theme) => theme.zIndex.drawer + 1 }} color="default" elevation={0}>
            <Toolbar>
              <IconButton edge="start" onClick={()=>setMobileOpen(!mobileOpen)} sx={{ mr: 2, display:{md:'none'} }}>
                <span className="material-icons">menu</span>
              </IconButton>

              {/* ★ 常に「ポータル」固定 */}
              <Typography variant="h6" sx={{ flexGrow:1 }}>
                ポータル
              </Typography>

              <IconButton><span className="material-icons">help_outline</span></IconButton>
              <IconButton><span className="material-icons">account_circle</span></IconButton>
            </Toolbar>
          </AppBar>

          {/* LeftNav */}
          <Box component="nav" sx={{ width: { md: drawerWidth }, flexShrink: { md: 0 } }}>
            <Drawer
              variant="temporary"
              open={mobileOpen}
              onClose={()=>setMobileOpen(false)}
              ModalProps={{ keepMounted: true }}
              sx={{
                display: { xs: 'block', md: 'none' },
                '& .MuiDrawer-paper': { boxSizing: 'border-box', width: drawerWidth }
              }}
            >
              {drawer}
            </Drawer>
            <Drawer
              variant="permanent"
              sx={{
                display: { xs: 'none', md: 'block' },
                '& .MuiDrawer-paper': { boxSizing: 'border-box', width: drawerWidth }
              }}
              open
            >
              {drawer}
            </Drawer>
          </Box>

          {/* Main */}
          <Box component="main" sx={{ flexGrow:1, p:1, width:{ md: `calc(100% - ${drawerWidth}px)` }, display:'flex', flexDirection:'column' }}>
            <Toolbar />
            <Container maxWidth="xl" disableGutters sx={{ flex:1, pb:1 }}>

              {/* ★ レフトナビと同じタイトルを各メイン画面の先頭に表示 */}
              <Typography variant="h6" sx={{ mb: 1.5 }}>{navTitle()}</Typography>

              {nav==="services" && (
                <ServiceGrid
                  services={services}
                  settingsMap={settingsMap}
                  setServices={setServices}
                  editMode={editMode}
                  setEditMode={setEditMode}
                  onOpenSettings={setActiveId}
                  onOpenCreate={setInviteCreateFor}
                  onOpenManage={setInviteManageFor}
                />
              )}

              {nav==="invites" && (
                <InviteServicesPage
                  services={services}
                  settingsMap={settingsMap}
                  onOpenCreate={setInviteCreateFor}
                  onOpenManage={setInviteManageFor}
                  onOpenUserManage={setUserManageFor}
                />
              )}

              {nav==="users" && (
                <UsersPage
                  services={services}
                  settingsMap={settingsMap}
                />
              )}

              {nav==="orgs" && (
                <OrgsPage
                  services={services}
                  settingsMap={settingsMap}
                />
              )}

              {nav==="notify" && (
                <Paper variant="outlined" sx={{p:2, color:"text.secondary", m:0}}>
                  このページはダミーです。機能は未実装。
                </Paper>
              )}
            </Container>

            {/* Footer */}
            <Box component="footer" sx={{ borderTop:'1px solid #e0e0e0', py:.75, px:1.5, background:'#fff' }}>
              <Container maxWidth="xl" disableGutters sx={{ display:'flex', justifyContent:'space-between', alignItems:'center' }}>
                <Typography variant="caption">© 2025 Example Corp.</Typography>
                <Stack direction="row" spacing={1}>
                  <Button type="button" size="small">利用規約</Button>
                  <Button type="button" size="small">プライバシー</Button>
                </Stack>
              </Container>
            </Box>
          </Box>

          {/* 設定モーダル */}
          {activeService && (
            <ServiceSettingsModal
              open={!!activeService}
              service={activeService}
              settings={settingsMap[activeService.id] || defaultSettings(activeService.id)}
              onChange={(newSettings)=>setSettingsFor(activeService.id, newSettings)}
              onClose={()=>setActiveId(null)}
              showMessage={showMessage}
            />
          )}

          {/* 招待リンク：作成／管理 */}
          {inviteCreateFor && (
            <InviteCreateDialog
              open={!!inviteCreateFor}
              onClose={()=>setInviteCreateFor(null)}
              onCreate={(inv)=>onCreateInvite(inviteCreateFor, inv)}
              serviceId={inviteCreateFor}
              showMessage={showMessage}
            />
          )}
          {inviteManageFor && (
            <InviteManageDialog
              open={!!inviteManageFor}
              onClose={()=>setInviteManageFor(null)}
              invites={(settingsMap[inviteManageFor]||defaultSettings(inviteManageFor)).invites}
              setInvites={(newInvites)=>setSettingsMap(prev=>{
                const cur = prev[inviteManageFor] || defaultSettings(inviteManageFor);
                return { ...prev, [inviteManageFor]: { ...cur, invites:newInvites } };
              })}
              serviceName={DEFAULT_SERVICES.find(s=>s.id===inviteManageFor)?.name || "サービス"}
              showMessage={showMessage}
            />
          )}

          {/* サービスのユーザー管理（確認/削除/有効切替） */}
          {userManageFor && (
            <UserManageDialog
              open={!!userManageFor}
              onClose={()=>setUserManageFor(null)}
              serviceName={DEFAULT_SERVICES.find(s=>s.id===userManageFor)?.name || "サービス"}
              users={(settingsMap[userManageFor]||defaultSettings(userManageFor)).users}
              onRemoveUser={(userId)=>removeUserFromService(userManageFor, userId)}
              onToggleUser={(userId, enabled)=>toggleUserEnabled(userManageFor, userId, enabled)}
            />
          )}

          {/* メッセージモーダル */}
          <MessageDialog
            open={msg.open}
            title={msg.title}
            message={msg.message}
            onClose={()=>setMsg({open:false,title:"",message:""})}
          />
        </Box>
      );
    };

    ReactDOM.createRoot(document.getElementById('root')).render(<StrictMode><App/></StrictMode>);
  </script>
</body>
</html>
