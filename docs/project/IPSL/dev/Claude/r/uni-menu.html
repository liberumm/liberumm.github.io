<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MR & AI Chat</title>
  <!-- Roboto & MUI -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" />
  <!-- React, ReactDOM, Babel -->
  <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js" crossorigin></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.23.8/babel.min.js"></script>
  <!-- Emotion (MUI依存) -->
  <script src="https://cdn.jsdelivr.net/npm/@emotion/react@11.11.3/dist/emotion-react.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@emotion/styled@11.11.0/dist/emotion-styled.umd.min.js"></script>
  <!-- MUI Core -->
  <script src="https://cdn.jsdelivr.net/npm/@mui/material@5.15.3/umd/material-ui.production.min.js" crossorigin></script>
  <!-- MUI Icons -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100vh;
      font-family: Roboto, sans-serif;
      background-color: #f0f0f0;
    }
    #root {
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    .home-icon {
      width: 64px;
      height: 64px;
      border-radius: 16px;
      margin: 8px auto;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    .home-label {
      font-size: 0.8rem;
      margin-top: 4px;
      text-align: center;
      color: #333;
      font-weight: 500;
    }
    .chat-message {
      margin-bottom: 10px;
      line-height: 1.5;
      word-wrap: break-word;
    }
    .chat-message.user {
      text-align: right;
      color: #333;
    }
    .chat-message.agent {
      text-align: left;
      color: #283593;
      font-weight: 500;
    }
  </style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
  // MaterialUI コンポーネントの分割代入
  const {
    AppBar,
    Toolbar,
    Typography,
    Box,
    Grid,
    Paper,
    IconButton,
    TextField,
    Button,
    Switch,
    FormControlLabel,
    Container,
    useMediaQuery,
    Modal
  } = MaterialUI;
  
  /**
   * ナビゲーションメニューの項目定義
   * icon: Material Iconsの名前
   * label: 表示ラベル
   */
  const menuItems = [
    { icon: "home", label: "ホーム" },
    { icon: "person", label: "プロフィール" },
    { icon: "mail", label: "メッセージ" },
    { icon: "settings", label: "設定" },
    { icon: "photo_camera", label: "カメラ" },
    { icon: "map", label: "マップ" },
    { icon: "event", label: "カレンダー" },
    { icon: "shopping_cart", label: "ショップ" },
    { icon: "help", label: "ヘルプ" },
    { icon: "info", label: "情報" },
    { icon: "phone", label: "連絡先" },
    { icon: "music_note", label: "音楽" },
  ];
  
  /**
   * アイコンの背景色パレット
   * メニュー項目に順番に適用される
   */
  const iconColors = [
    "#f44336", "#e91e63", "#9c27b0", "#673ab7",
    "#3f51b5", "#2196f3", "#03a9f4", "#00bcd4",
    "#009688", "#4caf50", "#ff9800", "#795548"
  ];

  /**
   * チャットインターフェースコンポーネント
   * - メッセージ履歴の表示
   * - テキスト入力
   * - 音声入力
   * - MRモード切り替え
   */
  function AIMRChatArea({ messages, input, setInput, handleSend, handleVoiceInput, isMRMode, setIsMRMode }) {
    return (
      <Box sx={{ height: '100%', display: 'flex', flexDirection: 'column', p: 0 }}>
        <Box
          sx={{
            flex: 1,
            overflowY: 'auto',
            border: '1px solid rgba(0,0,0,0.1)',
            borderRadius: 1,
            p: 2,
            mb: 2,
            backgroundColor: '#fff'
          }}
        >
          {messages.map((msg, i) => (
            <div key={i} className={`chat-message ${msg.role}`}>
              {msg.role === "agent" ? "AI: " : "あなた: "}
              {msg.text}
            </div>
          ))}
        </Box>
        <Box sx={{ p: 2, pt: 0 }}>
          <TextField
            variant="outlined"
            multiline
            minRows={2}
            maxRows={4}
            size="small"
            fullWidth
            value={input}
            placeholder="メッセージを入力..."
            onChange={(e) => setInput(e.target.value)}
          />
          <Box sx={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', mt: 2 }}>
            <FormControlLabel
              control={
                <Switch
                  checked={isMRMode}
                  onChange={(event) => setIsMRMode(event.target.checked)}
                  color="primary"
                  size="small"
                />
              }
              label="MRモード"
            />
            <Box sx={{ display: 'flex', gap: 1 }}>
              <Button size="small" variant="outlined" onClick={handleVoiceInput}>
                音声入力
              </Button>
              <Button size="small" variant="contained" onClick={handleSend}>
                送信
              </Button>
            </Box>
          </Box>
        </Box>
      </Box>
    );
  }

  /**
   * ビデオ表示コンポーネント
   */
  function VideoDisplay() {
    const videoRef = React.useRef(null);
    const [devices, setDevices] = React.useState([]);
    const [activeDeviceId, setActiveDeviceId] = React.useState(null);

    // デバイス一覧の取得
    React.useEffect(() => {
      navigator.mediaDevices.enumerateDevices()
        .then(devices => {
          const videoDevices = devices.filter(device => device.kind === 'videoinput');
          setDevices(videoDevices);
          if (videoDevices.length > 0) {
            setActiveDeviceId(videoDevices[0].deviceId);
          }
        });
    }, []);

    // カメラストリームの開始
    React.useEffect(() => {
      if (activeDeviceId) {
        navigator.mediaDevices.getUserMedia({
          video: { deviceId: activeDeviceId }
        })
        .then(stream => {
          videoRef.current.srcObject = stream;
        })
        .catch(err => console.error('カメラアクセスエラー:', err));
      }
    }, [activeDeviceId]);

    const handleDeviceChange = () => {
      const currentIndex = devices.findIndex(d => d.deviceId === activeDeviceId);
      const nextIndex = (currentIndex + 1) % devices.length;
      setActiveDeviceId(devices[nextIndex].deviceId);
    };

    return (
      <Box sx={{ position: 'relative', height: '100%' }}>
        <video
          ref={videoRef}
          autoPlay
          playsInline
          style={{
            width: '100%',
            height: '100%',
            objectFit: 'cover'
          }}
        />
        {devices.length > 1 && (
          <Button
            variant="contained"
            onClick={handleDeviceChange}
            sx={{
              position: 'absolute',
              top: '10px',
              left: '50%',
              transform: 'translateX(-50%)',
              backgroundColor: 'rgba(0,0,0,0.6)',
              '&:hover': {
                backgroundColor: 'rgba(0,0,0,0.8)'
              }
            }}
          >
            <span className="material-icons">switch_video</span>
          </Button>
        )}
      </Box>
    );
  }

  /**
   * メインアプリケーションコンポーネント
   * - ヘッダー
   * - メニューグリッド
   * - チャットインターフェース
   * - フッター（チャット開閉ボタン）
   */
  function App() {
    // レスポンシブデザインの判定
    const isMobile = useMediaQuery('(max-width:600px)');
    
    // チャット表示の状態管理
    const [openChat, setOpenChat] = React.useState(false);
    const handleOpenChat = () => setOpenChat(!openChat);

    // メッセージ関連の状態をAppコンポーネントに移動
    const [messages, setMessages] = React.useState([
      { role: "agent", text: "こんにちは、AIエージェントです。ご用件は何でしょうか？" },
    ]);
    const [input, setInput] = React.useState("");
    const [isMRMode, setIsMRMode] = React.useState(false);

    // 音声認識の設定と初期化
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    const recognitionRef = React.useRef(null);

    React.useEffect(() => {
      if (SpeechRecognition) {
        recognitionRef.current = new SpeechRecognition();
        recognitionRef.current.continuous = false;
        recognitionRef.current.lang = "ja-JP";
        recognitionRef.current.onresult = (event) => {
          const transcript = event.results[0][0].transcript;
          setInput(transcript);
        };
      }
    }, []);

    const handleVoiceInput = () => {
      if (!SpeechRecognition || !recognitionRef.current) {
        alert("このブラウザでは音声認識がサポートされていません。");
        return;
      }
      recognitionRef.current.start();
    };

    const handleSend = () => {
      if (!input.trim()) return;
      // メッセージ履歴エリアを展開
      if (!openChat) {
        setOpenChat(true);
      }
      setMessages(prev => [...prev, { role: "user", text: input }]);
      setInput("");
      setTimeout(() => {
        setMessages(prev => [...prev, { role: "agent", text: "はい、かしこまりました。" }]);
      }, 800);
    };

    // デバイスに応じたサイズ設定
    const appBarHeight = isMobile ? '48px' : '64px';
    const footerHeight = isMobile ? '48px' : '56px';

    return (
      <Box sx={{ height: "100vh", display: 'flex', flexDirection: 'column' }}>
        {/* ヘッダー */}
        <AppBar position="static" elevation={4} sx={{ minHeight: appBarHeight }}>
          <Toolbar sx={{ minHeight: appBarHeight }}>
            <IconButton edge="start" color="inherit" sx={{ mr: 2 }}>
              <span className="material-icons">menu</span>
            </IconButton>
            <Typography variant="h6" sx={{ flexGrow: 1, fontWeight: 'bold', fontSize: isMobile ? '1rem' : '1.25rem' }}>
              MR+AI Assistant
            </Typography>
            <IconButton color="inherit">
              <span className="material-icons">notifications</span>
            </IconButton>
            <IconButton color="inherit">
              <span className="material-icons">account_circle</span>
            </IconButton>
          </Toolbar>
        </AppBar>

        {/* メインコンテンツ */}
        <Box sx={{ flex: 1, position: 'relative', overflowY: 'auto', display: 'flex', flexDirection: 'column' }}>
          {/* スライドイン式メッセージ履歴エリア */}
          <Box
            sx={{
              height: openChat ? '40vh' : 0,
              overflow: 'hidden',
              transition: 'height 0.3s ease-in-out',
              borderBottom: openChat ? '1px solid rgba(0,0,0,0.1)' : 'none',
              bgcolor: 'rgba(255,255,255,0.95)',
            }}
          >
            <Box
              sx={{
                height: '100%',
                overflowY: 'auto',
                p: 2,
                backgroundColor: '#fff'
              }}
            >
              {isMRMode ? (
                <VideoDisplay />
              ) : (
                messages.map((msg, i) => (
                  <div key={i} className={`chat-message ${msg.role}`}>
                    {msg.role === "agent" ? "AI: " : "あなた: "}
                    {msg.text}
                  </div>
                ))
              )}
            </Box>
          </Box>

          {/* チャット入力エリア */}
          <Box sx={{ 
            p: 2, 
            borderBottom: '1px solid rgba(0,0,0,0.1)', 
            bgcolor: 'white',
            boxShadow: '0 -4px 12px rgba(0,0,0,0.05)'
          }}>
            <Box sx={{ 
              display: 'flex', 
              gap: 1, 
              alignItems: 'center',
              backgroundColor: '#f5f5f5',
              borderRadius: '12px',
              padding: '8px',
              border: '1px solid rgba(0,0,0,0.08)'
            }}>
              <TextField
                variant="standard"
                size="small"
                fullWidth
                value={input}
                placeholder="メッセージを入力..."
                onChange={(e) => setInput(e.target.value)}
                InputProps={{
                  disableUnderline: true,
                  sx: { 
                    padding: '0 8px',
                    fontSize: '0.95rem'
                  }
                }}
              />
              <Button 
                size="small" 
                variant={isMRMode ? "contained" : "outlined"}
                onClick={() => setIsMRMode(!isMRMode)}
                sx={{ 
                  minWidth: '40px',
                  height: '36px',
                  borderRadius: '8px',
                  backgroundColor: isMRMode ? '#1976d2' : 'transparent'
                }}
              >
                <span className="material-icons" style={{ fontSize: '20px' }}>view_in_ar</span>
              </Button>
              <Button 
                size="small" 
                variant="outlined"
                onClick={handleVoiceInput}
                sx={{ 
                  minWidth: '40px',
                  height: '36px',
                  borderRadius: '8px'
                }}
              >
                <span className="material-icons" style={{ fontSize: '20px' }}>mic</span>
              </Button>
              <Button 
                size="small" 
                variant="contained"
                onClick={handleSend}
                sx={{ 
                  height: '36px',
                  borderRadius: '8px',
                  px: 2
                }}
              >
                送信
              </Button>
            </Box>
          </Box>

          {/* メニューアイコングリッド */}
          <Box sx={{ 
            flex: 1, 
            p: 2, 
            overflowY: 'hidden' // スクロールバーを非表示に
          }}>
            <Grid container spacing={2} justifyContent="center">
              {menuItems.map((item, index) => (
                <Grid item key={index} xs={4} sm={3} md={2} sx={{ textAlign: 'center' }}>
                  <div
                    className="home-icon"
                    style={{ backgroundColor: iconColors[index % iconColors.length] }}
                  >
                    <span className="material-icons">{item.icon}</span>
                  </div>
                  <div className="home-label">{item.label}</div>
                </Grid>
              ))}
            </Grid>
          </Box>
        </Box>

        {/* フッター - メッセージ履歴の開閉ボタン */}
        <Paper
          onClick={handleOpenChat}
          sx={{
            bgcolor: '#283593',
            color: 'white',
            minHeight: footerHeight,
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            cursor: 'pointer',
            transition: 'background-color 0.2s',
            '&:hover': {
              bgcolor: '#1a237e',
            }
          }}
          elevation={4}
        >
          <Box sx={{ display: 'flex', alignItems: 'center', gap: 1 }}>
            <span className="material-icons">
              {openChat ? 'expand_more' : 'expand_less'}
            </span>
            <Typography>
              {openChat ? 'メッセージを閉じる' : 'メッセージを表示'}
            </Typography>
          </Box>
        </Paper>
      </Box>
    );
  }
  
  // アプリケーションのレンダリング
  ReactDOM.createRoot(document.getElementById("root")).render(<App />);
</script>
</body>
</html>
