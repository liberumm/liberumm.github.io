<!DOCTYPE html><html lang="ja"><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/> 
<title>電子メールシステム（A4固定＋自動改ページ＋表分割防止＋見出し先頭＋改行記号＋フォント操作）</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap"/>
<link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons"/>
<script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js" crossorigin></script>
<script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js" crossorigin></script>
<script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.23.8/babel.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mui/material@5.15.3/umd/material-ui.production.min.js" crossorigin></script>
<style>
  :root{
    --text-900:#111827;--text-800:#1f2937;--text-700:#374151;--text-600:#4b5563;--text-500:#6b7280;
    --text-400:#9ca3af;--text-300:#d1d5db;--text-200:#e5e7eb;--text-100:#f3f4f6;
    --border:#e5e7eb;--border-light:#f3f4f6;--border-dark:#d1d5db;--background:#ffffff;--background-alt:#f9fafb;
  }
  html,body,#root{height:100%}
  body{margin:0;background:#f6f7fb}
  .scroll{overflow:auto;-webkit-overflow-scrolling:touch}
  .stickyTop{position:sticky;top:0;background:#fff;z-index:2;border-bottom:1px solid #eee}
  .stickyBottom{position:sticky;bottom:0;background:#fff;z-index:1;border-top:1px solid #eee}
  .navPane{width:280px;border-right:1px solid #eee;background:#fff}
  .paper{border-radius:12px}
  .twocol{height:calc(100dvh - 150px)}
  .touchy .MuiButton-root,.touchy .MuiListItemButton-root{min-height:44px}
  @media (max-width:980px){.navPane{display:none}.twocol{height:auto}}

  .rte-attachment{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border:1px solid #e0e0e0;border-radius:8px;background:#fafafa}
  .rte-attachment .material-icons{font-size:16px}
  .rte-img{max-width:100%;height:auto;border-radius:8px}

  /* ====== A4 プレビュー（画面） ====== */
  .pageWrap{background:#e9ebf0;padding:16px}
  .a4{
    width:210mm;
    height:297mm;              /* ★枠の高さ固定 */
    margin:16px auto;
    background:#fff;
    box-shadow:0 2px 12px rgba(0,0,0,.12);
    position:relative;
    overflow:hidden;           /* 視覚的に伸びない */
    --content-top: 15mm;
    --content-bottom: 18mm;
    --header-h: 0px;
  }
  .a4 .content{
    padding:15mm 15mm 18mm 15mm;
    box-sizing:border-box;
    height:calc(297mm - var(--content-top) - var(--content-bottom) - var(--header-h));
    overflow:visible;
    word-break:break-word;
  }
  .a4-guides::before{content:"";position:absolute;inset:12mm;border:1px dashed rgba(0,0,0,.12);pointer-events:none}

  /* ====== 1ページ目ヘッダー ====== */
  .doc-header{padding:8mm 15mm 0 15mm;font-size:12px}
  .doc-header-row{display:flex;gap:12px;align-items:flex-start;margin-bottom:6px;flex-wrap:wrap}
  .doc-header-col{flex:1 1 200px;min-width:200px}
  .doc-header-label{min-width:80px;color:#64748b;font-weight:600;font-size:11px}
  .doc-header-value{flex:1;border-bottom:1px solid #e2e8f0;padding:2px 0 4px;word-break:break-all}
  .doc-header-sep{border:none;border-top:2px solid #0ea5e9;margin:10px 0 8px}

  /* === リッチツールバー & 書式 === */
  .rte-toolbar{display:flex;flex-wrap:wrap;gap:6px;padding:8px;border-bottom:1px solid #e5e7eb;background:#fff;position:sticky;top:0;z-index:3}
  .rte-toolbar .MuiButton-root,.rte-toolbar .MuiIconButton-root{min-width:36px}
  .rte-toolbar .MUI-Sep{width:1px;background:#e5e7eb;margin:0 4px}

  .rte-hr{border:none;border-top:2px dashed #cbd5e1;margin:14px 0}
  @media print{ .rte-hr{border:none;page-break-after:always} }

  .a4 .content p{margin:8px 0;line-height:1.7}
  .a4 blockquote{border-left:3px solid #94a3b8;padding:4px 10px;margin:8px 0;background:#f8fafc}
  .a4 pre{background:#f1f5f9;padding:8px;border-radius:6px;overflow:auto}

  /* === 改行記号（↵ / ¶）の可視化：レイアウト非干渉のオーバーレイ === */
  .content.show-breaks{ position:relative; }
  .content.show-breaks p,
  .content.show-breaks li,
  .content.show-breaks pre,
  .content.show-breaks blockquote{ position:relative; min-height:1.2em; }
  .content.show-breaks p::after,
  .content.show-breaks li::after,
  .content.show-breaks pre::after,
  .content.show-breaks blockquote::after{
    content:"¶";
    position:absolute; right:-0.8em; top:50%; transform:translateY(-50%);
    font-size:0.85em; color:#94a3b8; opacity:.8; pointer-events:none; z-index:1;
  }
  .content.show-breaks p:empty::after,
  .content.show-breaks li:empty::after{ content:"¶"; position:absolute; right:-0.8em; top:0; font-size:0.85em; color:#94a3b8; opacity:.8; pointer-events:none; z-index:1; }
  .content.show-breaks br::before{
    content:"↵";
    position:absolute; left:0; top:-1em; font-size:0.8em; color:#94a3b8; opacity:.8; pointer-events:none; z-index:1;
  }
  /* 計測時だけ記号を不可視化（高さに影響させない） */
  .content.breaks-hidden p::after,
  .content.breaks-hidden li::after,
  .content.breaks-hidden pre::after,
  .content.breaks-hidden blockquote::after,
  .content.breaks-hidden br::before{ display:none !important; }
</style>
</head><body><div id="root"></div>
<script type="text/babel">
const {useMemo,useState,useEffect,useRef} = React;
const M = MaterialUI;
const {
  ThemeProvider,createTheme,AppBar,Toolbar,Tooltip,IconButton,Button,Divider,Box,Paper,Grid,Stack,
  Typography,TextField,InputAdornment,Chip,Badge,List,ListItemButton,ListItemIcon,ListItemText,Checkbox,
  Dialog,DialogTitle,DialogContent,DialogActions,Select,MenuItem,Table,TableHead,TableBody,TableRow,TableCell,
  Switch,FormControlLabel,useMediaQuery,RadioGroup,Radio, Tabs, Tab, Popover, Slider
} = M;

/* ========= 定数 ========= */
const GROUPS=[{id:'sales',name:'営業部',members:[
  {id:'u1',name:'田中 太郎',email:'taro.tanaka@example.com'},
  {id:'u2',name:'山田 花子',email:'hanako.yamada@example.com'},
  {id:'u3',name:'佐藤 健',email:'ken.sato@example.com'},
  {id:'u4',name:'高橋 茜',email:'akane.takahashi@example.com'}]},
{id:'dev',name:'開発部',members:[
  {id:'u5',name:'小林 翔',email:'sho.kobayashi@example.com'},
  {id:'u6',name:'鈴木 直子',email:'naoko.suzuki@example.com'},
  {id:'u7',name:'伊藤 誠',email:'makoto.ito@example.com'},
  {id:'u8',name:'渡辺 沙織',email:'saori.watanabe@example.com'},
  {id:'u9',name:'中村 悠',email:'haruka.nakamura@example.com'}]},
{id:'hr',name:'人事・総務',members:[
  {id:'u10',name:'加藤 翔子',email:'shoko.kato@example.com'},
  {id:'u11',name:'松本 大',email:'dai.matsumoto@example.com'},
  {id:'u12',name:'石井 未来',email:'miki.ishii@example.com'}]}];

const PATTERNS=[
  {id:'all',name:'全社',groups:['sales','dev','hr']},
  {id:'store',name:'店舗連絡',groups:['sales']},
  {id:'hq',name:'本部連絡',groups:['dev','hr']},
  {id:'plan',name:'企画書',groups:['dev'],members:['u6']},
  {id:'asset',name:'資産購入',groups:['hr'],members:['u11']},
  {id:'trip',name:'出張申請',groups:['sales','hr']}
];

const FORMS_MASTER=['お知らせ','修繕','修繕依頼','作業依頼','配車','請求','回覧','企画書'];
const NAV_ITEMS=[{key:'01',label:'01.日別発信'},{key:'02',label:'02.○○他発信別'},{key:'03',label:'03.処理待ち'},{key:'04',label:'04.発信済み'},{key:'05',label:'05.返信文書'},{key:'06',label:'06.伝達対象別'},{key:'07',label:'07.下書き'}];
const STATUSES=['発信','発信待ち','返却','下書き'];
const BASE_LIST=[
  {id:'m1',date:'2025-08-21',time:'11:50',dept:'神谷商店',form:'修繕',title:'セルフ精算レジ端末修繕',status:'発信',deadline:''},
  {id:'m2',date:'2025-08-21',time:'12:45',dept:'システム部',form:'作業依頼',title:'インカム備品発送',status:'発信',deadline:''},
  {id:'m3',date:'2025-08-21',time:'07:34',dept:'総務部',form:'配車',title:'誤配達対応のお願い',status:'発信',deadline:'2025/08/31'},
  {id:'m4',date:'2025-08-20',time:'16:03',dept:'能代店',form:'修繕依頼',title:'床補修の件',status:'発信',deadline:''},
  {id:'m5',date:'2025-08-20',time:'14:22',dept:'経理部',form:'請求',title:'精算の件',status:'返却',deadline:''},
  {id:'m6',date:'2025-08-19',time:'09:10',dept:'営業企画',form:'お知らせ',title:'棚卸のお願い',status:'発信待ち',deadline:''},
];

/* ========= ユーティリティ ========= */
const pad2=n=>String(n).padStart(2,'0');
const today=()=>{const d=new Date();return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;}
const nowJST=()=>{const d=new Date();return {date:`${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`,time:`${pad2(d.getHours())}:${pad2(d.getMinutes())}`}}
const fmtJP=d=>new Date(d).toLocaleDateString('ja-JP',{year:'numeric',month:'2-digit',day:'2-digit',weekday:'short'});
const idgen=()=> 'm'+Math.random().toString(36).slice(2,9);
const memberById=Object.fromEntries(GROUPS.flatMap(g=>g.members.map(m=>[m.id,{...m,groupId:g.id,groupName:g.name}])));

const blankSel=()=>Object.fromEntries(GROUPS.map(g=>[g.id,new Set()]));
const cloneSel=sel=>Object.fromEntries(Object.entries(sel).map(([k,v])=>[k,new Set([...v])]));
const allIds=sel=>Object.values(sel).reduce((a,s)=>(s.forEach(id=>a.push(id)),a),[]);
const toggle=(set,id)=>{set.has(id)?set.delete(id):set.add(id);return set}
const Icon=({name,style})=><span className="material-icons" style={style}>{name}</span>;
const ChipStatus=({s})=> s==='発信'? <Chip label="発信" size="small" color="success" variant="outlined"/>:
  s==='返却'? <Chip label="返却" size="small" color="error" variant="outlined"/>:
  s==='発信待ち'? <Chip label="発信待ち" size="small" color="warning" variant="outlined"/>:
  s==='下書き'? <Chip label="下書き" size="small" variant="outlined"/>:<Chip size="small" label={s}/>;
const ChipApproval=({a})=>!a?null: a==='承認済'?<Chip size="small" color="success" label="承認済"/>:
  a==='差戻し'?<Chip size="small" color="error" label="差戻し"/>:<Chip size="small" color="warning" variant="outlined" label="未承認"/>;

/* ========= サンプル ========= */
const SAMPLE_DEPTS=['神谷商店','能代店','経理部','総務部','システム部','営業企画','営業部','開発部'];
const SAMPLE_TITLES=['棚卸のお願い','精算の件','レジ不具合','備品発送','レイアウト変更','回線障害調査','出張旅費申請','勤怠締め確認','新製品企画書レビュー'];
const rand=a=>a[Math.floor(Math.random()*a.length)];
function makeSamples(n=200){
  const arr=[]; const t=new Date();
  for(let i=0;i<n;i++){
    const d=new Date(t); d.setDate(d.getDate()-Math.floor(Math.random()*10));
    const date=`${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
    const time=`${pad2(Math.floor(Math.random()*24))}:${pad2(Math.floor(Math.random()*60))}`;
    const form=rand(FORMS_MASTER), status=rand(STATUSES);
    const dl=Math.random()>0.7?`${d.getFullYear()}/${pad2(d.getMonth()+1)}/${pad2(d.getDate()+Math.floor(Math.random()*10)+1)}`:'';
    const approval=form==='企画書'?rand(['未承認','承認済','差戻し']):null;
    arr.push({id:idgen(),date,time,dept:rand(SAMPLE_DEPTS),form,title:rand(SAMPLE_TITLES),status,deadline:dl,approval,
      body:`<p style="font-size:14px">【${rand(SAMPLE_DEPTS)}】${rand(SAMPLE_TITLES)}についてご連絡します。</p><ul><li>対象：全店舗</li><li>対応期限：${dl||'—'}</li></ul><p>ご確認をお願いします。</p>`});
  }
  return arr;
}

/* ========= 印刷ヘルパー ========= */
function printA4() {
  const src = document.querySelector('.pageWrap.print-area');
  if (!src) { alert('印刷対象（A4プレビュー）が見つかりません。作成画面またはプレビューダイアログを開いてください。'); return; }
  const win = window.open('', '_blank');
  const html = `
<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8"/>
<title>印刷</title>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap"/>
<link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons"/>
<style>
  @page { size: A4 portrait; margin: 12mm; }
  html,body{height:auto}
  body{margin:0;background:#fff;-webkit-print-color-adjust:exact;print-color-adjust:exact;font-family:Roboto,"Noto Sans JP",system-ui,-apple-system,Segoe UI,sans-serif}
  .pageWrap{background:#fff;padding:0}
  .a4{width:210mm;min-height:297mm;margin:0 auto;box-shadow:none;page-break-after:always;position:relative}
  .a4:last-child{page-break-after:auto}
  .a4 .content{padding:15mm 15mm 18mm 15mm}
  .a4-guides::before{content:none !important}
  .doc-header{padding:0 15mm 0 15mm;font-size:12px}
  .doc-header-row{display:flex;gap:12px;align-items:flex-start;margin-bottom:6px;flex-wrap:wrap}
  .doc-header-col{flex:1 1 200px;min-width:200px}
  .doc-header-label{min-width:80px;color:#64748b;font-weight:600;font-size:11px}
  .doc-header-value{flex:1;border-bottom:1px solid #e2e8f0;padding:2px 0 4px;word-break:break-all}
  .doc-header-sep{border:none;border-top:2px solid #0ea5e9;margin:10px 0 8px}
  .a4 .content p{margin:8px 0;line-height:1.7}
  blockquote{border-left:3px solid #94a3b8;padding:4px 10px;margin:8px 0;background:#f8fafc}
  pre{background:#f1f5f9;padding:8px;border-radius:6px;overflow:auto}
  .rte-img{max-width:100%;height:auto;border-radius:8px}
  .rte-attachment{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border:1px solid #e0e0e0;border-radius:8px;background:#fafafa}
  .rte-hr{border:none;page-break-after:always}
  table{border-collapse:collapse;width:100%}
  td,th{border:1px solid #cbd5e1;padding:6px}
</style>
</head>
<body>
${src.innerHTML}
<script>
  window.onload = function(){ try{ window.print(); } finally { window.close(); } };
<\/script>
</body>
</html>`;
  win.document.open(); win.document.write(html); win.document.close();
}

/* ========= 宛先ピッカー ========= */
function PatternDialog({open,onClose,onApply}){
  const isSm=M.useMediaQuery('(max-width:600px)'); const [chosen,setChosen]=useState(PATTERNS[0].id); const [mode,setMode]=useState('add');
  useEffect(()=>{if(open){setChosen(PATTERNS[0].id);setMode('add')}},[open]);
  return (<Dialog open={open} onClose={onClose} fullWidth maxWidth="sm" fullScreen={isSm}>
    <DialogTitle>宛先パターンを選択</DialogTitle>
    <DialogContent dividers className={isSm?'touchy':''}>
      <RadioGroup value={chosen} onChange={e=>setChosen(e.target.value)}>
        {PATTERNS.map(p=><M.FormControlLabel key={p.id} value={p.id} control={<Radio/>} label={p.name}/>)}
      </RadioGroup>
      <Divider sx={{my:1.5}}/>
      <Stack direction="row" spacing={1} alignItems="center">
        <Typography variant="body2">適用モード</Typography>
        <Select size="small" value={mode} onChange={e=>setMode(e.target.value)}>
          <MenuItem value="add">追加</MenuItem><MenuItem value="replace">置換</MenuItem>
        </Select>
      </Stack>
    </DialogContent>
    <DialogActions>
      <Button onClick={onClose}>キャンセル</Button>
      <Button variant="contained" startIcon={<Icon name="bolt"/>} onClick={()=>onApply(chosen,mode)}>適用</Button>
    </DialogActions>
  </Dialog>);
}

function PickerBody({sel,setSel,activeGroupId,setActiveGroupId}){
  const isSm=useMediaQuery('(max-width:600px)');
  const [qG,setQG]=useState(''),[qM,setQM]=useState(''),[filter,setFilter]=useState('all');
  const [openPat,setOpenPat]=useState(false),[lastPat,setLastPat]=useState('');
  const g=useMemo(()=>GROUPS.find(x=>x.id===activeGroupId),[activeGroupId]);
  const cur=sel[activeGroupId]||new Set(); const idsAll=allIds(sel);
  const visibleGroups=useMemo(()=>GROUPS.filter(x=>x.name.toLowerCase().includes(qG.trim().toLowerCase())),[qG]);
  const visibleMembers=useMemo(()=>{
    const t=qM.trim().toLowerCase();
    return g.members.filter(m=>{
      const hit=!t||m.name.toLowerCase().includes(t)||m.email.toLowerCase().includes(t);
      return hit && (filter==='all'||(filter==='selected'?cur.has(m.id):!cur.has(m.id)));
    });
  },[g,qM,filter,cur]);

  const setMember=id=>setSel(p=>{const n={...p},s=new Set(p[activeGroupId]); toggle(s,id); n[activeGroupId]=s; return n;});
  const removeAnywhere=id=>{const gid=memberById[id].groupId; setSel(p=>{const n={...p},s=new Set(p[gid]); s.delete(id); n[gid]=s; return n;});};
  const toggleAll=()=>setSel(p=>{
    const n={...p},s=new Set(p[activeGroupId]),targets=visibleMembers.map(m=>m.id),all=targets.every(id=>s.has(id));
    targets.forEach(id=>all?s.delete(id):s.add(id)); n[activeGroupId]=s; return n;
  });
  const applyPattern=(patId,mode='add')=>{
    const p=PATTERNS.find(x=>x.id===patId); if(!p) return;
    setSel(prev=>{
      const next=(mode==='replace')?blankSel():cloneSel(prev);
      const add=(id)=>{const gid=memberById[id]?.groupId; if(!gid) return; (next[gid]||(next[gid]=new Set())).add(id);};
      (p.groups||[]).forEach(gid=>GROUPS.find(x=>x.id===gid)?.members.forEach(m=>add(m.id)));
      (p.members||[]).forEach(add);
      return next;
    });
    setLastPat(`${p.name}（${mode==='add'?'追加':'置換'}）`); setOpenPat(false);
  };
  const listH=isSm?'42vh':'48vh', allChecked=visibleMembers.length>0 && visibleMembers.every(m=>cur.has(m.id));

  return (<Box className={isSm?'touchy':''} sx={{display:'flex',flexDirection:'column'}}>
    <Box className="stickyTop" sx={{p:1.25}}>
      <Stack direction="row" alignItems="center" spacing={1}><Icon name="send"/><Typography variant="h6" sx={{fontWeight:600}}>送信先の選択</Typography><Box sx={{flex:1}}/><Chip label={`選択中: ${idsAll.length}`}/></Stack>
    </Box>
    <Box sx={{p:1.25,borderBottom:'1px solid #eee'}}>
      <Stack direction={{xs:'column',sm:'row'}} spacing={1} alignItems={{xs:'stretch',sm:'center'}}>
        <Typography sx={{fontWeight:600}}>宛先パターン</Typography>
        <Button variant="outlined" startIcon={<Icon name="category"/>} onClick={()=>setOpenPat(true)}>パターン選択</Button>
        {lastPat && <Chip size="small" variant="outlined" label={`適用済み: ${lastPat}`}/>}
        <Box sx={{flex:1}}/>
        <Button size="small" variant={allChecked?'outlined':'contained'} onClick={toggleAll} startIcon={<Icon name={allChecked?'check_box':'check_box_outline_blank'}/>}>表示中を全選択</Button>
      </Stack>
    </Box>

    <Grid container>
      <Grid item xs={12} md={4} lg={3} sx={{borderRight:{md:'1px solid #eee'}}}>
        <Box className="stickyTop" sx={{p:1.25}}>
          <TextField size="small" fullWidth placeholder="グループを検索…" value={qG} onChange={e=>setQG(e.target.value)}
            InputProps={{startAdornment:(<InputAdornment position="start"><Icon name="search"/></InputAdornment>)}}/>
        </Box>
        <Box className="scroll" style={{maxHeight:listH}}>
          <List dense>
            {visibleGroups.map(x=>{
              const c=sel[x.id]?.size??0,active=x.id===activeGroupId;
              return (<ListItemButton key={x.id} selected={active} onClick={()=>setActiveGroupId(x.id)}>
                <ListItemText primary={<Stack direction="row" spacing={1} alignItems="center">
                  <Typography sx={{fontWeight:active?700:500}}>{x.name}</Typography>
                  <Badge color={c?'primary':'default'} badgeContent={c}><span style={{width:0}}/></Badge>
                </Stack>} secondary={`${x.members.length}名`}/>
              </ListItemButton>);
            })}
          </List>
        </Box>
      </Grid>

      <Grid item xs={12} md={8} lg={9}>
        <Box className="stickyTop" sx={{p:1.25,display:'grid',gap:8,gridTemplateColumns:{xs:'1fr',sm:'1fr auto auto'}}}>
          <TextField size="small" fullWidth placeholder={`${g.name} から検索…`} value={qM} onChange={e=>setQM(e.target.value)}
            InputProps={{startAdornment:(<InputAdornment position="start"><Icon name="person_search"/></InputAdornment>)}}/>
          <Stack direction="row" spacing={0.5} alignItems="center" justifyContent="center">
            <IconButton size="small" onClick={()=>{const i=GROUPS.findIndex(x=>x.id===activeGroupId); setActiveGroupId(GROUPS[(i-1+GROUPS.length)%GROUPS.length].id);}}><Icon name="chevron_left"/></IconButton>
            <Typography variant="body2" color="text.secondary">{g.name}</Typography>
            <IconButton size="small" onClick={()=>{const i=GROUPS.findIndex(x=>x.id===activeGroupId); setActiveGroupId(GROUPS[(i+1)%GROUPS.length].id);}}><Icon name="chevron_right"/></IconButton>
          </Stack>
          <Select size="small" value={filter} onChange={e=>setFilter(e.target.value)}>
            <MenuItem value="all">すべて</MenuItem><MenuItem value="selected">選択中のみ</MenuItem><MenuItem value="unselected">未選択のみ</MenuItem>
          </Select>
        </Box>
        <Box className="scroll" style={{maxHeight:listH}}>
          <List dense>
            {visibleMembers.map(m=>{
              const checked=cur.has(m.id);
              return (<ListItemButton key={m.id} onClick={()=>setMember(m.id)}>
                <ListItemIcon><Checkbox edge="start" checked={checked} tabIndex={-1} disableRipple/></ListItemIcon>
                <ListItemText primary={<Typography sx={{fontWeight:checked?600:400}}>{m.name}</Typography>}
                  secondary={<Typography variant="caption" color="text.secondary">{m.email}</Typography>}/>
              </ListItemButton>);
            })}
          </List>
        </Box>
      </Grid>
    </Grid>

    <Box sx={{p:1.25,borderTop:'1px solid #eee'}}>
      <Stack direction="row" alignItems="center" spacing={1} mb={1}><Icon name="groups"/><Typography variant="subtitle1" sx={{fontWeight:600}}>選択状況確認</Typography><Box sx={{flex:1}}/>{idsAll.length>0&&<Button size="small" onClick={()=>setSel(blankSel())} startIcon={<Icon name="clear_all"/>}>すべてクリア</Button>}</Stack>
      <Box className="scroll" style={{maxHeight:isSm?'22vh':'24vh',padding:'4px 0'}}>
        {idsAll.length===0? <Typography variant="body2" color="text.secondary">まだ選択されていません。</Typography>:
          <Box style={{display:'flex',gap:8,flexWrap:'wrap'}}>
            {idsAll.map(id=><Chip key={id} label={`${memberById[id].name}（${memberById[id].groupName}）`} onDelete={()=>removeAnywhere(id)} icon={<Icon name="person" style={{fontSize:18}}/>}/>)}
          </Box>}
      </Box>
    </Box>
    <PatternDialog open={openPat} onClose={()=>setOpenPat(false)} onApply={applyPattern}/>
  </Box>);
}

function PickerDialog({open,onClose,onConfirm,initial}){
  const isSm=useMediaQuery('(max-width:600px)'); const [gid,setGid]=useState(GROUPS[0].id);
  const [sel,setSel]=useState(()=>initial||blankSel());
  useEffect(()=>{if(open) setSel(initial?cloneSel(initial):blankSel())},[open,initial]);
  return (<Dialog open={open} onClose={onClose} fullWidth maxWidth="lg" fullScreen={isSm}>
    <DialogContent dividers sx={{p:0}}><PickerBody sel={sel} setSel={setSel} activeGroupId={gid} setActiveGroupId={setGid}/></DialogContent>
    <DialogActions className="stickyBottom">
      <Button onClick={onClose} fullWidth={isSm}>キャンセル</Button>
      <Button variant="contained" onClick={()=>onConfirm(sel)} startIcon={<Icon name="check"/>} fullWidth={isSm}>決定して追加</Button>
    </DialogActions>
  </Dialog>);
}

/* ========= A4 リッチエディタ ========= */
function PageCanvas({initialHtml, onChange, onMouseDown, onAfterEdit, showBreaks}) {
  const ref = useRef(null);
  const isComposingRef = useRef(false);
  const rafRef = useRef(0);

  useEffect(()=>{ if(ref.current) ref.current.innerHTML = initialHtml || ''; },[]);

  // showBreaks 切替
  useEffect(()=>{
    const el = ref.current; if(!el) return;
    if(showBreaks) { el.classList.add('show-breaks'); el.style.position = 'relative'; }
    else { el.classList.remove('show-breaks'); }
  },[showBreaks]);

  const emit = () => {
    if (!ref.current) return;
    cancelAnimationFrame(rafRef.current);
    rafRef.current = requestAnimationFrame(()=>{
      onChange(ref.current.innerHTML);
      onAfterEdit?.();
    });
  };

  return (
    <div
      ref={ref}
      className="content"
      contentEditable
      suppressContentEditableWarning
      spellCheck={false}
      style={{outline:'none'}}
      onMouseDown={onMouseDown}
      onCompositionStart={()=>{ isComposingRef.current = true; }}
      onCompositionEnd={()=>{ isComposingRef.current = false; emit(); }}
      onInput={()=>{ if (!isComposingRef.current) emit(); }}
      onBlur={emit}
    />
  );
}

function RichEditor({pages,setPages, headerData, showHeader=true}){
  const imgInputRef=useRef(null), fileInputRef=useRef(null);
  const colorRef=useRef(null), bgColorRef=useRef(null);
  const [imgAnchor,setImgAnchor]=useState(null);
  const [imgNode,setImgNode]=useState(null);
  const [imgPct,setImgPct]=useState(60);
  const [showBreaks,setShowBreaks]=useState(true);

  const fontFamilies=[
    {label:'既定（Noto/Roboto）', value:'"Noto Sans JP", Roboto, system-ui, -apple-system, "Segoe UI", sans-serif'},
    {label:'游ゴシック系', value:'"Yu Gothic UI","Yu Gothic","游ゴシック体",Meiryo,sans-serif'},
    {label:'メイリオ', value:'Meiryo, "Hiragino Kaku Gothic ProN", sans-serif'},
    {label:'等幅（コード）', value:'ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace'}
  ];
  const fontSizes=[12,13,14,15,16,18,20,24,28];

  const getPageEls = () => Array.from(document.querySelectorAll('.a4 .content'));
  const getBlocks = (el) => Array.from(el.childNodes).filter(n => n.nodeType === 1 || (n.nodeType === 3 && n.textContent.trim()));
  const syncStateFromDOM = () => setPages(getPageEls().map(el => el.innerHTML));
  const focusFirstEditable = () => document.querySelector('.a4 .content')?.focus();
  const isHeading = (el) => el?.nodeType === 1 && /H[1-3]/.test(el.tagName);

  const withBreaksHidden = (fn) => {
    const pages = getPageEls();
    pages.forEach(el => el.classList.add('breaks-hidden'));
    try { return fn(); }
    finally { setTimeout(() => pages.forEach(el => el.classList.remove('breaks-hidden')), 10); }
  };

  const nearestRowOrTableUnit = (node) => {
    if (!node?.closest) return node;
    return node.closest('tr') || node.closest('thead,tbody,tfoot') || node.closest('table') || node;
  };

  const exec = (cmd, value=null) => {
    focusFirstEditable();
    try { document.execCommand(cmd,false,value); } catch(e) {}
    syncStateFromDOM();
    recalcPageHeights();
    enforceHeadingsTop();
  };
  const execCss = (cmd, value=null) => {
    focusFirstEditable();
    try { document.execCommand('styleWithCSS', true); } catch(e) {}
    try { document.execCommand(cmd,false,value); } catch(e) {}
    syncStateFromDOM();
    recalcPageHeights();
    enforceHeadingsTop();
  };

  const styleString = (styles) => Object.entries(styles).map(([k,v])=> `${k.replace(/[A-Z]/g,m=>'-'+m.toLowerCase())}:${v}`).join(';');

  const wrapSelectionWithSpan = (styles) => {
    focusFirstEditable();
    const sel = window.getSelection();
    if(!sel || sel.rangeCount===0) return;
    const range = sel.getRangeAt(0);
    const pagesEls = getPageEls();
    let targetIdx = pagesEls.findIndex(el => el.contains(range.commonAncestorContainer));

    if(range.collapsed){
      // 文字入力のためのプレースホルダを挿入（ZWSP）
      const span = document.createElement('span');
      Object.assign(span.style, styles);
      span.appendChild(document.createTextNode('\u200B'));
      range.insertNode(span);
      // キャレットをspan内の末尾へ
      const nRange = document.createRange();
      nRange.setStart(span.firstChild, 1);
      nRange.collapse(true);
      sel.removeAllRanges(); sel.addRange(nRange);
    }else{
      try{
        const span = document.createElement('span');
        Object.assign(span.style, styles);
        const contents = range.extractContents();
        span.appendChild(contents);
        range.insertNode(span);
        // 再選択
        sel.removeAllRanges();
        const newRange = document.createRange();
        newRange.selectNodeContents(span);
        sel.addRange(newRange);
      }catch(e){
        // surroundContents 失敗時は insertHTML フォールバック
        const div = document.createElement('div');
        div.appendChild(range.cloneContents());
        const html = `<span style="${styleString(styles)}">${div.innerHTML}</span>`;
        document.execCommand('insertHTML', false, html);
      }
    }
    // DOM→State同期とレイアウト更新
    syncStateFromDOM();
    requestAnimationFrame(() => {
      recalcPageHeights(); enforceHeadingsTop();
      withBreaksHidden(()=>{ if(targetIdx<0) targetIdx=0; checkLastBlockOverflow(targetIdx); });
    });
  };

  const recalcPageHeights = () => withBreaksHidden(() => {
    Array.from(document.querySelectorAll('.a4')).forEach((pageEl, idx) => {
      const header = idx === 0 ? pageEl.querySelector('.doc-header') : null;
      const headerH = header?.getBoundingClientRect().height || 0;
      pageEl.style.setProperty('--header-h', `${headerH}px`);
    });
  });

  const updateLayout = () => {
    requestAnimationFrame(() => {
      recalcPageHeights();
      enforceHeadingsTop();
      withBreaksHidden(() => checkAllOverflows());
    });
  };

  useEffect(() => { recalcPageHeights(); }, [headerData, pages]);
  useEffect(() => { 
    const fn = () => recalcPageHeights(); 
    window.addEventListener('resize',fn); 
    return () => window.removeEventListener('resize',fn); 
  },[]);

  const checkLastBlockOverflow = (pageIndex) => {
    const pagesEls = getPageEls();
    const cur = pagesEls[pageIndex];
    if (!cur) return;

    recalcPageHeights();
    const isOverflow = withBreaksHidden(() => {
      const threshold = Math.max(8, cur.clientHeight * 0.015);
      return (cur.scrollHeight - cur.clientHeight) > threshold;
    });
    if (!isOverflow) return;

    const blocks = getBlocks(cur);
    if (!blocks.length) return;

    let last = nearestRowOrTableUnit(blocks[blocks.length - 1]);
    
    if (!pagesEls[pageIndex + 1]) {
      setPages(prev => [...prev.slice(0, pageIndex + 1), '', ...prev.slice(pageIndex + 1)]);
      return;
    }
    const next = getPageEls()[pageIndex + 1];

    // 画像が巨大で溢れる場合、段階的縮小を試す
    if (last.nodeType === 1 && last.tagName === 'IMG' && last.offsetHeight > cur.clientHeight * 0.8) {
      const curPct = parseInt(String(last.style.width || '').replace('%','')) || 100;
      if (curPct > 40) {
        last.style.width = `${Math.max(40, curPct - 15)}%`;
        syncStateFromDOM();
        return;
      }
    }

    // 見出しは次ノードセットで移動
    const moveNodes = isHeading(last) && last.nextSibling ? [last, last.nextSibling] : [last];
    try {
      moveNodes.reverse().forEach(node => next.insertBefore(node, next.firstChild));
      syncStateFromDOM();
    } catch(e) { console.warn('ページ送り処理でエラー:', e); }
  };

  const enforceHeadingsTop = () => {
    const pages = getPageEls();
    let hasChanges = false;

    pages.forEach((pageEl, idx) => {
      const children = getBlocks(pageEl);
      if (children.length <= 1) return;

      const headingIndex = children.findIndex((node, i) => i > 0 && isHeading(node));
      if (headingIndex === -1) return;

      const heading = children[headingIndex];
      if (!pages[idx + 1]) {
        setPages(prev => [...prev, '']);
        hasChanges = true;
        return;
      }

      const next = getPageEls()[idx + 1];
      const moveNodes = heading.nextSibling ? [heading, heading.nextSibling] : [heading];
      
      try {
        moveNodes.reverse().forEach(node => next.insertBefore(node, next.firstChild));
        hasChanges = true;
      } catch(e) { console.warn('見出し移動でエラー:', e); }
    });

    if (hasChanges) syncStateFromDOM();
  };

  const checkAllOverflows = () => {
    withBreaksHidden(() => {
      for (let i = 0; i < getPageEls().length; i++) checkLastBlockOverflow(i);
    });
  };

  const insertHTML = (html) => {
    focusFirstEditable();
    if(document.queryCommandSupported('insertHTML')){ document.execCommand('insertHTML',false,html); }
    else{
      const sel = window.getSelection(); if(!sel || sel.rangeCount===0) return;
      const range = sel.getRangeAt(0); const div=document.createElement('div'); div.innerHTML=html;
      const frag=document.createDocumentFragment(); let node; while((node=div.firstChild)) frag.appendChild(node);
      range.deleteContents(); range.insertNode(frag);
    }
    const pageEls = Array.from(document.querySelectorAll('.a4 .content'));
    setPages(pageEls.map(el => el.innerHTML));
    recalcPageHeights();
    enforceHeadingsTop();

    const sel = window.getSelection();
    const targetIdx = sel ? pageEls.findIndex(el => el.contains(sel.anchorNode)) : -1;

    setTimeout(() => {
      recalcPageHeights();
      enforceHeadingsTop();
      withBreaksHidden(()=>checkLastBlockOverflow(targetIdx === -1 ? 0 : targetIdx));
    }, 0);
  };

  const insertHTMLToFirstPageTop=(html)=>{
    try{
      const first = document.querySelector('.a4 .content'); if(!first) return;
      const range = document.createRange(); range.setStart(first,0); range.collapse(true);
      const sel = window.getSelection(); sel?.removeAllRanges(); sel?.addRange(range);
      if(document.queryCommandSupported('insertHTML')){ document.execCommand('insertHTML',false,html); }
      else{
        const div=document.createElement('div'); div.innerHTML=html;
        const frag=document.createDocumentFragment(); let node; while((node=div.firstChild)) frag.appendChild(node);
        range.insertNode(frag);
      }
      const updated = document.querySelector('.a4 .content')?.innerHTML ?? '';
      setPages(p=>{ const n=[...p]; n[0]=updated; return n; });
      requestAnimationFrame(() => { recalcPageHeights(); enforceHeadingsTop(); withBreaksHidden(() => checkAllOverflows()); });
    }catch(e){}
  };

  const onPick=(e,type)=>{
    const files=[...e.target.files||[]];
    files.forEach(f=>{
      const reader=new FileReader();
      reader.onload=()=> insertHTMLToFirstPageTop(type==='img'
        ? `<img class="rte-img" style="width:60%" src="${reader.result}" alt="${f.name}"/>`
        : `<span class="rte-attachment"><span class="material-icons">attach_file</span><a href="${URL.createObjectURL(f)}" download="${f.name}">${f.name}</a><span>(${Math.round(f.size/1024)}KB)</span></span>&nbsp;`);
      type==='img'?reader.readAsDataURL(f):reader.readAsArrayBuffer(f);
    });
    e.target.value='';
    requestAnimationFrame(() => { recalcPageHeights(); enforceHeadingsTop(); withBreaksHidden(() => checkAllOverflows()); });
  };

  const onEditorMouseDown = (e)=>{
    const t = e.target;
    if(t && t.tagName==='IMG'){
      setImgNode(t);
      const pct = parseInt(String(t.style.width||'').replace('%','')) || 100;
      setImgPct(pct);
      setImgAnchor(t);
    }else{
      setImgAnchor(null);
      setImgNode(null);
    }
  };

  const applyImgWidth = (pct)=>{
    if(!imgNode) return;
    const clamped=Math.max(10,Math.min(100, pct));
    imgNode.style.width = clamped + '%';
    setImgPct(clamped);
    const pageEls = Array.from(document.querySelectorAll('.a4 .content'));
    const idx = pageEls.findIndex(el=>el.contains(imgNode));
    if(idx>=0){
      const html = pageEls[idx].innerHTML;
      setPages(p=>{ const n=[...p]; n[idx]=html; return n; });
      requestAnimationFrame(() => { recalcPageHeights(); enforceHeadingsTop(); withBreaksHidden(() => checkAllOverflows()); });
    }
  };
  const removeImg=()=>{
    if(!imgNode) return;
    const pageEls = Array.from(document.querySelectorAll('.a4 .content'));
    const parent = pageEls.find(el=>el.contains(imgNode));
    imgNode.remove(); setImgNode(null); setImgAnchor(null);
    if(parent){
      const idx = pageEls.indexOf(parent);
      setPages(p=>{ const n=[...p]; n[idx]=parent.innerHTML; return n; });
      requestAnimationFrame(() => { recalcPageHeights(); enforceHeadingsTop(); withBreaksHidden(() => checkAllOverflows()); });
    }
  };

  const addPage=()=> setPages(prev=>[...prev,'']);
  const deletePage=(i)=>{
    setPages(prev=>{
      if(prev.length<=1) return prev;
      const n=[...prev]; n.splice(i,1); return n;
    });
    requestAnimationFrame(() => { recalcPageHeights(); enforceHeadingsTop(); withBreaksHidden(() => checkAllOverflows()); });
  };

  const applyBlock = (tag) => exec('formatBlock', tag);
  const insertBreakHr = () => insertHTML(`<hr class="rte-hr"/>`);
  const insertTable = (rows=3, cols=3) => {
    let html = `<table style="border-collapse:collapse;width:100%;margin:8px 0">`;
    for(let r=0;r<rows;r++){
      html += `<tr>`;
      for(let c=0;c<cols;c++){
        html += `<td style="border:1px solid #cbd5e1;padding:6px">　</td>`;
      }
      html += `</tr>`;
    }
    html += `</table>`;
    insertHTML(html);
  };
  const insertLink = () => {
    const url = prompt('リンクURLを入力してください（https://…）');
    if(!url) return;
    exec('createLink', url);
  };

  const applyFontFamily = (ff) => wrapSelectionWithSpan({fontFamily: ff});
  const applyFontSize = (px) => wrapSelectionWithSpan({fontSize: `${px}px`, lineHeight:'1.7'});
  const applyTextColor = (color) => execCss('foreColor', color);
  const applyBgColor = (color) => { try { execCss('hiliteColor', color); } catch(e){ execCss('backColor', color); } };

  const ToolbarBtn = ({icon,label,onClick,active}) => (
    <Tooltip title={label}>
      <IconButton size="small" onClick={onClick} color={active?'primary':'default'}>
        <span className="material-icons">{icon}</span>
      </IconButton>
    </Tooltip>
  );

  return (
    <Paper variant="outlined" className="paper">
      <Stack direction="row" spacing={0.5} sx={{p:1,borderBottom:'1px solid #e5e7eb',flexWrap:'wrap'}} alignItems="center">
        <Tooltip title="画像を挿入（1ページ目の先頭）"><IconButton size="small" onClick={()=>imgInputRef.current.click()}><span className="material-icons">image</span></IconButton></Tooltip>
        <input ref={imgInputRef} type="file" accept="image/*" multiple hidden onChange={e=>onPick(e,'img')}/>
        <Tooltip title="添付ファイル（本文にバッジ）"><IconButton size="small" onClick={()=>fileInputRef.current.click()}><span className="material-icons">attach_file</span></IconButton></Tooltip>
        <input ref={fileInputRef} type="file" multiple hidden onChange={e=>onPick(e,'file')}/>
        <Divider flexItem orientation="vertical" sx={{mx:1}}/>
        <Button size="small" startIcon={<span className="material-icons">post_add</span>} onClick={addPage}>ページを追加</Button>
        <Button size="small" startIcon={<span className="material-icons">delete</span>} onClick={()=>deletePage(pages.length-1)} disabled={pages.length<=1}>最後のページを削除</Button>
        <Box sx={{flex:1}}/><Typography variant="caption" color="text.secondary" sx={{px:1}}>A4プレビュー</Typography>
      </Stack>

      {/* 書式ツールバー */}
      <div className="rte-toolbar">
        {/* Undo/Redo */}
        <ToolbarBtn icon="undo" label="取り消し" onClick={()=>exec('undo')}/>
        <ToolbarBtn icon="redo" label="やり直し" onClick={()=>exec('redo')}/>
        <div className="MUI-Sep"></div>

        {/* 太字/斜体/下線/取消/書式クリア */}
        <ToolbarBtn icon="format_bold" label="太字" onClick={()=>exec('bold')}/>
        <ToolbarBtn icon="format_italic" label="斜体" onClick={()=>exec('italic')}/>
        <ToolbarBtn icon="format_underline" label="下線" onClick={()=>exec('underline')}/>
        <ToolbarBtn icon="strikethrough_s" label="取消線" onClick={()=>exec('strikeThrough')}/>
        <ToolbarBtn icon="format_clear" label="書式クリア" onClick={()=>exec('removeFormat')}/>
        <div className="MUI-Sep"></div>

        {/* ブロック種別 */}
        <Select size="small" defaultValue="P" onChange={(e)=>applyBlock(e.target.value)} sx={{minWidth:120}}>
          <MenuItem value="P">段落</MenuItem>
          <MenuItem value="H1">見出しH1</MenuItem>
          <MenuItem value="H2">見出しH2</MenuItem>
          <MenuItem value="H3">見出しH3</MenuItem>
          <MenuItem value="BLOCKQUOTE">引用</MenuItem>
          <MenuItem value="PRE">コード</MenuItem>
        </Select>

        {/* フォントファミリ */}
        <Select size="small" defaultValue={fontFamilies[0].value} onChange={(e)=>applyFontFamily(e.target.value)} sx={{minWidth:180, ml:1}}>
          {fontFamilies.map(f=><MenuItem key={f.value} value={f.value}>{f.label}</MenuItem>)}
        </Select>

        {/* フォントサイズ */}
        <Select size="small" defaultValue={14} onChange={(e)=>applyFontSize(Number(e.target.value))} sx={{minWidth:100, ml:1}}>
          {fontSizes.map(s=><MenuItem key={s} value={s}>{s}px</MenuItem>)}
        </Select>

        <div className="MUI-Sep"></div>

        {/* リスト/インデント */}
        <ToolbarBtn icon="format_list_bulleted" label="箇条書き" onClick={()=>exec('insertUnorderedList')}/>
        <ToolbarBtn icon="format_list_numbered" label="番号付き" onClick={()=>exec('insertOrderedList')}/>
        <ToolbarBtn icon="format_indent_increase" label="インデント" onClick={()=>exec('indent')}/>
        <ToolbarBtn icon="format_indent_decrease" label="アウトデント" onClick={()=>exec('outdent')}/>
        <div className="MUI-Sep"></div>

        {/* 揃え */}
        <ToolbarBtn icon="format_align_left" label="左揃え" onClick={()=>exec('justifyLeft')}/>
        <ToolbarBtn icon="format_align_center" label="中央揃え" onClick={()=>exec('justifyCenter')}/>
        <ToolbarBtn icon="format_align_right" label="右揃え" onClick={()=>exec('justifyRight')}/>
        <ToolbarBtn icon="format_align_justify" label="両端揃え" onClick={()=>exec('justifyFull')}/>
        <div className="MUI-Sep"></div>

        {/* リンク */}
        <ToolbarBtn icon="link" label="リンク" onClick={insertLink}/>
        <ToolbarBtn icon="link_off" label="リンク解除" onClick={()=>exec('unlink')}/>
        <div className="MUI-Sep"></div>

        {/* ページ区切り/テーブル */}
        <ToolbarBtn icon="horizontal_rule" label="ページ区切り（横罫線）" onClick={insertBreakHr}/>
        <ToolbarBtn icon="table_chart" label="テーブル（3×3）" onClick={()=>insertTable(3,3)}/>
        <div className="MUI-Sep"></div>

        {/* フォント色 */}
        <Tooltip title="文字色">
          <IconButton size="small" onClick={()=>colorRef.current.click()}>
            <span className="material-icons">format_color_text</span>
          </IconButton>
        </Tooltip>
        <input ref={colorRef} type="color" hidden onChange={e=>applyTextColor(e.target.value)} />

        {/* 背景色（ハイライト） */}
        <Tooltip title="背景色（ハイライト）">
          <IconButton size="small" onClick={()=>bgColorRef.current.click()}>
            <span className="material-icons">format_color_fill</span>
          </IconButton>
        </Tooltip>
        <input ref={bgColorRef} type="color" hidden onChange={e=>applyBgColor(e.target.value)} />

        <div className="MUI-Sep"></div>
        {/* 改行記号可視化 */}
        <ToolbarBtn
          icon="visibility"
          label={showBreaks?'改行記号を非表示':'改行記号を表示'}
          onClick={()=>setShowBreaks(v=>!v)}
          active={showBreaks}
        />
      </div>

      {/* 印刷対象（画面上に表示） */}
      <Box className="pageWrap print-area">
        {pages.map((html,idx)=>(
          <div key={`page-${idx}`} className="a4 a4-guides" style={{position:'relative'}}>
            <Box sx={{position:'absolute',top:6,right:6}}>
              <Tooltip title="このページを削除">
                <span>
                  <IconButton size="small" onClick={()=>deletePage(idx)} disabled={pages.length<=1}>
                    <span className="material-icons">close</span>
                  </IconButton>
                </span>
              </Tooltip>
            </Box>

            {/* 1ページ目ヘッダー（非編集） */}
            {idx===0 && showHeader && (
              <div className="doc-header" contentEditable={false} aria-label="文書ヘッダー">
                <div className="doc-header-row">
                  <div className="doc-header-label">発信件名</div>
                  <div className="doc-header-value">{headerData?.subject || '（未入力）'}</div>
                </div>
                <div className="doc-header-row">
                  <div className="doc-header-col">
                    <div className="doc-header-label">フォーム</div>
                    <div className="doc-header-value">{headerData?.form || '—'}</div>
                  </div>
                  <div className="doc-header-col">
                    <div className="doc-header-label">発信日</div>
                    <div className="doc-header-value">{headerData?.sendDate || 'yyyy/mm/dd'}</div>
                  </div>
                </div>
                <div className="doc-header-row">
                  <div className="doc-header-label">宛先</div>
                  <div className="doc-header-value">{headerData?.toText || '宛先は未選択です。'}</div>
                </div>
                <div className="doc-header-row">
                  <div className="doc-header-col">
                    <div className="doc-header-label">伝達対象</div>
                    <div className="doc-header-value">{headerData?.target || '例：全社員 / 取締役会'}</div>
                  </div>
                  <div className="doc-header-col">
                    <div className="doc-header-label">発信部署</div>
                    <div className="doc-header-value">{headerData?.originator || '所属名'}</div>
                  </div>
                </div>
                <div className="doc-header-row">
                  <div className="doc-header-col">
                    <div className="doc-header-label">返信期限</div>
                    <div className="doc-header-value">{headerData?.deadline || 'yyyy/mm/dd'}</div>
                  </div>
                  <div className="doc-header-col">
                    <div className="doc-header-label">担当者</div>
                    <div className="doc-header-value">{headerData?.assignee || '担当者名'}</div>
                  </div>
                </div>
                <hr className="doc-header-sep"/>
              </div>
            )}

            {/* 本文エリア（編集可） */}
            <PageCanvas
              initialHtml={html}
              onChange={(newHtml)=>setPages(p=>{const n=[...p]; n[idx]=newHtml; return n;})}
               /* ← 画像ツール起動のバグ修正：ハンドラを正しく渡す */
              onMouseDown={onEditorMouseDown}
              onAfterEdit={()=>{ withBreaksHidden(() => { recalcPageHeights(); enforceHeadingsTop(); checkLastBlockOverflow(idx); }); }}
              showBreaks={showBreaks}
            />
          </div>
        ))}
      </Box>

      {/* 画像調整ポップオーバ */}
      <Popover
        open={Boolean(imgAnchor)}
        anchorEl={imgAnchor}
        onClose={()=>setImgAnchor(null)}
        anchorOrigin={{vertical:'top',horizontal:'center'}}
        transformOrigin={{vertical:'bottom',horizontal:'center'}}
      >
        <Box sx={{p:1.5, width:260}}>
          <Typography variant="caption" sx={{display:'block',mb:.5}}>画像サイズ（用紙幅に対する%）</Typography>
          <MaterialUI.Slider min={10} max={100} step={1} value={imgPct} onChange={(_,v)=>applyImgWidth(v)} />
          <Stack direction="row" spacing={1} justifyContent="space-between">
            {[25,50,75,100].map(p=>
              <Button key={p} size="small" variant={imgPct===p?'contained':'outlined'} onClick={()=>applyImgWidth(p)}>{p}%</Button>
            )}
            <Box sx={{flex:1}}/>
            <Tooltip title="画像を削除">
              <IconButton color="error" size="small" onClick={removeImg}><span className="material-icons">delete</span></IconButton>
            </Tooltip>
          </Stack>
        </Box>
      </Popover>
    </Paper>
  );
}

/* ========= 一覧 ========= */
function InboxList({rows,setRows,onEditDraft,onApprove,onReject}){
  const [preview,setPreview]=useState(true);
  const [dateFrom,setDateFrom]=useState(today()), [dateTo,setDateTo]=useState(today());
  const [q,setQ]=useState(''),[fDept,setFDept]=useState('');
  const [activeKey,setActiveKey]=useState('01');
  const [tab,setTab]=useState('notice');
  const [selDoc,setSelDoc]=useState(null);
  const allStatus = STATUSES.reduce((m,s)=> (m[s]=true, m),{});
  const [statusFilter,setStatusFilter]=useState(allStatus);
  const toggleStatus=s=>setStatusFilter(p=>({...p,[s]:!p[s]}));
  const selectedStatusList = Object.entries(statusFilter).filter(([,v])=>v).map(([k])=>k);

  const applyPreset=t=>{
    const d=new Date(),fmt=x=>`${x.getFullYear()}-${pad2(x.getMonth()+1)}-${pad2(x.getDate())}`;
    if(t==='7'){const s=new Date(d); s.setDate(d.getDate()-6); setDateFrom(fmt(s)); setDateTo(fmt(d));}
    if(t==='week'){const w=d.getDay()||7,s=new Date(d); s.setDate(d.getDate()-(w-1)); const e=new Date(s); e.setDate(s.getDate()+6); setDateFrom(fmt(s)); setDateTo(fmt(e));}
    if(t==='month'){const s=new Date(d.getFullYear(),d.getMonth(),1),e=new Date(d.getFullYear(),d.getMonth()+1,0); setDateFrom(fmt(s)); setDateTo(fmt(e));}
  };

  const filtered=useMemo(()=>{
    const t=q.trim().toLowerCase(), inRange=d=>!dateFrom||!dateTo||(d>=dateFrom&&d<=dateTo);
    const tree = r => activeKey==='03'?r.status==='発信待ち':activeKey==='04'?r.status==='発信':activeKey==='05'?r.status==='返却':activeKey==='07'?r.status==='下書き':true;
    const tabFilter = r => tab==='proposal' ? r.form==='企画書' : r.form!=='企画書';
    const statusOK = r => selectedStatusList.length>0 ? selectedStatusList.includes(r.status) : false;
    return rows.filter(r=>{
      const k=!t||[r.dept,r.title,r.form].some(x=>String(x).toLowerCase().includes(t));
      return tabFilter(r) && k && (!fDept||r.dept===fDept) && inRange(r.date) && tree(r) && statusOK(r);
    }).sort((a,b)=> a.date===b.date ? (a.time<b.time?1:-1) : (a.date<b.date?1:-1));
  },[rows,q,fDept,dateFrom,dateTo,activeKey,tab,statusFilter]);

  const groups=filtered.reduce((m,r)=>(m[r.date]??=[]).push(r)&&m,{}); 
  const unique=a=>[...new Set(a)];
  const depts=unique(rows.map(x=>x.dept));
  const isOverdue=dl=>dl && new Date(dl.replaceAll('/','-')) < new Date(new Date().toDateString());

  return (
  <Box sx={{width:'100%',mx:'auto',p:{xs:1.5,md:2}}}>
    <Paper className="paper" sx={{mb:1.5}}>
      <Tabs value={tab} onChange={(_,v)=>setTab(v)} variant="fullWidth">
        <Tab icon={<Icon name="mail"/>} iconPosition="start" value="notice" label="発信文書一覧"/>
        <Tab icon={<Icon name="description"/>} iconPosition="start" value="proposal" label="企画書一覧"/>
      </Tabs>
    </Paper>

    <Paper className="paper" sx={{p:1.5,mb:1.5}}>
      <Typography variant="subtitle2" color="text.secondary">表示期間</Typography>
      <Stack direction={{xs:'column',sm:'row'}} spacing={1} sx={{mt:.75}}>
        <TextField type="date" size="small" value={dateFrom} onChange={e=>setDateFrom(e.target.value)}/>
        <TextField type="date" size="small" value={dateTo} onChange={e=>setDateTo(e.target.value)}/>
        <Box sx={{flex:1}}/>
        <Stack direction="row" spacing={1}>
          <Button size="small" onClick={()=>applyPreset('7')}>直近7日</Button>
          <Button size="small" onClick={()=>applyPreset('week')}>今週</Button>
          <Button size="small" onClick={()=>applyPreset('month')}>今月</Button>
        </Stack>
      </Stack>
    </Paper>

    <Paper className="paper" sx={{p:1.5,mb:1.5}}>
      <Typography variant="subtitle2" color="text.secondary">検索・絞り込み</Typography>
      <Stack spacing={1} sx={{mt:.75}}>
        <TextField size="small" fullWidth value={q} onChange={e=>setQ(e.target.value)} placeholder="検索（部署 / 件名 / フォーム）"
          InputProps={{startAdornment:(<InputAdornment position="start"><Icon name="search"/></InputAdornment>)}}/>
        <Stack direction="row" spacing={1} alignItems="center">
          <TextField select size="small" label="部署" value={fDept} onChange={e=>setFDept(e.target.value)} sx={{minWidth:220}}>
            <MenuItem value="">すべて</MenuItem>{depts.map(d=><MenuItem key={d} value={d}>{d}</MenuItem>)}
          </TextField>
          <Box sx={{flex:1}}/>
          <FormControlLabel control={<Switch checked={preview} onChange={e=>setPreview(e.target.checked)}/>} label="プレビューモード"/>
          <Button size="small" variant="outlined" startIcon={<Icon name="print"/>} onClick={printA4}>印刷</Button>
        </Stack>
      </Stack>
    </Paper>

    <Paper className="print-paper twocol paper" sx={{display:'flex',width:'100%'}}>
      <Box className="navPane">
        <List dense disablePadding>
          <ListItemButton selected disableRipple>
            <ListItemIcon><Icon name="folder"/></ListItemIcon>
            <ListItemText primary="ツリービュー" primaryTypographyProps={{fontWeight:700}}/>
          </ListItemButton>
          <Divider/>
          {NAV_ITEMS.map(item=>(<ListItemButton key={item.key} sx={{pl:3}} selected={activeKey===item.key} onClick={()=>setActiveKey(item.key)}>
            <ListItemIcon><Icon name="chevron_right"/></ListItemIcon>
            <ListItemText primary={item.label}/>
          </ListItemButton>))}
        </List>
      </Box>

      <Box sx={{flex:1,overflow:'auto'}}>
        <Table size={preview?'small':'medium'} stickyHeader>
          <TableHead><TableRow>
            <TableCell width="120">時刻</TableCell><TableCell width="160">発信部署</TableCell><TableCell>件名</TableCell>
            <TableCell width="160">フォーム</TableCell><TableCell width="200">状況</TableCell><TableCell width="140">返信期限</TableCell>
          </TableRow></TableHead>
          <TableBody>
            {Object.keys(groups).sort((a,b)=>a<b?1:-1).map(date=>(
              <React.Fragment key={date}>
                <TableRow><TableCell colSpan={6} sx={{fontWeight:700,background:'linear-gradient(90deg,rgba(99,102,241,.12),rgba(45,212,191,.12))',borderTop:'1px solid rgba(0,0,0,.06)'}}>{fmtJP(date)}</TableCell></TableRow>
                {groups[date].map((r,i)=>(
                  <TableRow key={r.id} hover onClick={()=>preview&&setSelDoc(r)} sx={{
                    cursor:preview?'pointer':'default',
                    ...(r.status==='発信'?{background:'rgba(46,125,50,.06)'}:r.status==='返却'?{background:'rgba(211,47,47,.06)'}:r.status==='発信待ち'?{background:'rgba(245,124,0,.08)'}:{})
                  }}>
                    <TableCell>{r.time}</TableCell>
                    <TableCell>{r.dept}</TableCell>
                    <TableCell><Stack direction="row" spacing={1} alignItems="center">{i===0&&<Icon name="star" style={{fontSize:16}}/>}<Typography noWrap={preview}>{r.title}</Typography></Stack></TableCell>
                    <TableCell>{r.form}</TableCell>
                    <TableCell><Stack direction="row" spacing={0.5} alignItems="center" flexWrap="wrap"><ChipStatus s={r.status}/><ChipApproval a={r.approval}/></Stack></TableCell>
                    <TableCell sx={isOverdue(r.deadline)?{color:'error.main',fontWeight:700}:null}>{r.deadline||''}</TableCell>
                  </TableRow>
                ))}
              </React.Fragment>
            ))}
            {filtered.length===0 && <TableRow><TableCell colSpan={6}><Typography color="text.secondary">該当するデータがありません。</Typography></TableCell></TableRow>}
          </TableBody>
        </Table>
      </Box>
    </Paper>

    <Dialog open={!!selDoc} onClose={()=>setSelDoc(null)} fullWidth maxWidth="md">
      <DialogTitle>文書プレビュー</DialogTitle>
      <DialogContent dividers>
        {selDoc && (<Stack spacing={1}>
          <Typography variant="h6">{selDoc.title}</Typography>
          <Typography variant="body2" color="text.secondary">{selDoc.date} {selDoc.time}／{selDoc.dept}／{selDoc.form}／{selDoc.status}{selDoc.deadline?`／期限: ${selDoc.deadline}`:''}</Typography>
          <Stack direction="row" spacing={1}><ChipApproval a={selDoc.approval}/></Stack>
          <Divider sx={{my:1}}/>
          <Box className="pageWrap print-area" sx={{p:0, background:'transparent'}}>
            <div className="a4 a4-guides">
              <div className="content" style={{height:'auto'}} dangerouslySetInnerHTML={{__html: selDoc.body || `<p>${selDoc.title} についてご確認をお願いします。</p>`}} />
            </div>
          </Box>
        </Stack>)}
      </DialogContent>
      <DialogActions>
        {selDoc?.status==='下書き' && <Button onClick={()=>{const d=selDoc; setSelDoc(null); onEditDraft(d);}} startIcon={<Icon name="edit"/>}>編集</Button>}
        {selDoc?.form==='企画書' && (<>
          <Button color="error" onClick={()=>{onReject(selDoc.id); setSelDoc(null);}} startIcon={<Icon name="undo"/>}>差戻し</Button>
          <Button variant="contained" color="success" onClick={()=>{onApprove(selDoc.id); setSelDoc(null);}} startIcon={<Icon name="task_alt"/>}>承認</Button>
        </>)}
        <Box sx={{flex:1}}/>
        <Button onClick={()=>setSelDoc(null)}>閉じる</Button>
        <Button variant="contained" startIcon={<Icon name="print"/>} onClick={printA4}>印刷</Button>
      </DialogActions>
    </Dialog>
  </Box>);
}

/* ========= 作成/編集 ========= */
function ComposeView({rows,setRows,initialDoc,onClose,fixedForm,allowedForms}){
  const editing=!!initialDoc;
  const [subject,setSubject]=useState(initialDoc?.title||'');
  const [originator,setOriginator]=useState(initialDoc?.dept||'');
  const [assignee,setAssignee]=useState(''),[target,setTarget]=useState('');
  const [sendDate,setSendDate]=useState(initialDoc?.date||'');
  const [deadline,setDeadline]=useState(initialDoc?.deadline?.replaceAll('-','/')||'');
  const [form,setForm]=useState(initialDoc?.form|| (fixedForm || (allowedForms?.[0] || 'お知らせ')));
  const [pages,setPages]=useState(()=> initialDoc?.body ? [initialDoc.body] : ['']);
  const [toSel,setToSel]=useState(blankSel()), [ccSel,setCcSel]=useState(blankSel());
  const [openPicker,setOpenPicker]=useState(false), [pickerKind,setPickerKind]=useState('to');

  const ids=a=>allIds(a), toIds=ids(toSel), ccIds=ids(ccSel);
  const rm=(kind,id)=>{const gid=memberById[id].groupId; const up=p=>{const n={...p},s=new Set(p[gid]); s.delete(id); n[gid]=s; return n}; (kind==='to'?setToSel:setCcSel)(up);};

  const upsertRow = payload=>{
    const joined = pages.join('<hr style="page-break-after:always;border:none;"/>');
    if(editing){
      setRows(prev=>prev.map(r=> r.id===initialDoc.id?{...r,...payload, body: joined}:r ));
    }else{
      const ts = payload.status==='発信'? nowJST() : (sendDate?{date:sendDate,time:'09:00'}:nowJST());
      setRows(prev=>[...prev,{
        id:idgen(),date:ts.date,time:ts.time,dept:originator||'',form,title:subject||'(無題)',
        status:payload.status,deadline:deadline||'',approval:(form==='企画書'?'未承認':null),body: joined
      }]);
    }
  };
  const saveDraft=()=>{upsertRow({status:'下書き'}); onClose();};
  const send=()=>{upsertRow({status:'発信'}); onClose();};

  const CountBadge=({n})=><Badge badgeContent={n} color={n?'secondary':'default'}><Icon name="groups"/></Badge>;
  const toText = toIds.length ? toIds.map(id => memberById[id].name).join('、') : '宛先は未選択です。';

  return (<Box sx={{width:'100%',mx:'auto',p:2}}>
    <Paper className="paper" sx={{p:2}}>
      <Grid container spacing={2} alignItems="center">
        <Grid item xs={12} md={6}>
          <Typography variant="subtitle2" color="text.secondary" sx={{mb:.5}}>発信件名</Typography>
          <TextField fullWidth value={subject} onChange={e=>setSubject(e.target.value)} placeholder="件名を入力"/>
        </Grid>
        <Grid item xs={6} md={3}>
          <Typography variant="subtitle2" color="text.secondary" sx={{mb:.5}}>フォーム</Typography>
          {fixedForm
            ? <TextField fullWidth value={fixedForm} disabled/>
            : <TextField select fullWidth value={form} onChange={e=>setForm(e.target.value)}>
                {(allowedForms||FORMS_MASTER).map(f=><MenuItem key={f} value={f}>{f}</MenuItem>)}
              </TextField>}
        </Grid>
        <Grid item xs={6} md={3}>
          <Typography variant="subtitle2" color="text.secondary" sx={{mb:.5}}>発信日</Typography>
          <TextField type="date" fullWidth value={sendDate} onChange={e=>setSendDate(e.target.value)}/>
        </Grid>
      </Grid>

      <Divider sx={{my:2,borderStyle:'dashed'}}/>

      <Grid container spacing={2}>
        <Grid item xs={12} md={6}>
          <Typography variant="subtitle2" color="text.secondary" sx={{mb:.5}}>宛先</Typography>
          <Stack direction="row" spacing={1} alignItems="center" sx={{mb:1}}>
            <Tooltip title="宛先を選択"><Button variant="outlined" onClick={()=>{setPickerKind('to');setOpenPicker(true);}} startIcon={<Icon name="group_add"/>} endIcon={<CountBadge n={toIds.length}/>}>宛先</Button></Tooltip>
            <Tooltip title="（写）を選択"><Button variant="outlined" onClick={()=>{setPickerKind('cc');setOpenPicker(true);}} startIcon={<Icon name="group"/>} endIcon={<CountBadge n={ccIds.length}/>}>（写）</Button></Tooltip>
          </Stack>
          {toIds.length===0? <Typography variant="body2" color="text.secondary">宛先は未選択です。</Typography>:
            <Box sx={{display:'flex',gap:.75,flexWrap:'wrap',mb:1}}>
              {toIds.map(id=><Chip key={id} size="small" onDelete={()=>rm('to',id)} label={`${memberById[id].name}（${memberById[id].groupName}）`} icon={<Icon name="person" style={{fontSize:18}}/>}/>)}
            </Box>}
          {ccIds.length>0 && <Box sx={{display:'flex',gap:.75,flexWrap:'wrap'}}>
            {ccIds.map(id=><Chip key={id} size="small" onDelete={()=>rm('cc',id)} label={`(写) ${memberById[id].name}（${memberById[id].groupName}）`} icon={<Icon name="person" style={{fontSize:18}}/>}/>)}
          </Box>}
        </Grid>
        <Grid item xs={12} md={3}>
          <Typography variant="subtitle2" color="text.secondary" sx={{mb:.5}}>伝達対象</Typography>
          <TextField fullWidth placeholder="例：全社員 / 取締役会" value={target} onChange={e=>setTarget(e.target.value)}/>
        </Grid>
        <Grid item xs={12} md={3}>
          <Typography variant="subtitle2" color="text.secondary" sx={{mb:.5}}>発信部署</Typography>
          <TextField fullWidth placeholder="所属名" value={originator} onChange={e=>setOriginator(e.target.value)}/>
        </Grid>
      </Grid>

      <Grid container spacing={2} sx={{mt:1}}>
        <Grid item xs={12} md={3}>
          <Typography variant="subtitle2" color="text.secondary" sx={{mb:.5}}>返信期限</Typography>
          <TextField type="date" fullWidth value={deadline.replaceAll('/','-')} onChange={e=>setDeadline(e.target.value.replaceAll('-','/'))}/>
        </Grid>
        <Grid item xs={12} md={3}>
          <Typography variant="subtitle2" color="text.secondary" sx={{mb:.5}}>担当者</Typography>
          <TextField fullWidth placeholder="担当者名" value={assignee} onChange={e=>setAssignee(e.target.value)}/>
        </Grid>
      </Grid>

      <Divider sx={{my:2,borderStyle:'dashed'}}/>
      <Typography variant="subtitle2" color="text.secondary" sx={{mb:.5}}>本文（リッチ書式 / A4プレビュー / ページ追加可 / フォント操作）</Typography>
      <RichEditor
        pages={pages}
        setPages={setPages}
        headerData={{
          subject,
          form,
          sendDate: (sendDate || '').replaceAll('-','/'),
          toText,
          target,
          originator,
          deadline,
          assignee
        }}
        showHeader={true}
      />
    </Paper>

    <Box mt={2} display="flex" justifyContent="flex-end" gap={1}>
      <Button startIcon={<Icon name="close"/>} onClick={onClose}>キャンセル</Button>
      <Button startIcon={<Icon name="print"/>} onClick={printA4}>プレビュー/印刷</Button>
      <Button onClick={saveDraft}>{editing?'下書き保存':'一時保管'}</Button>
      <Button variant="contained" startIcon={<Icon name="send"/>} onClick={send}>{editing?(fixedForm==='企画書'?'更新して発信（企画書）':'更新して発信'):(fixedForm==='企画書'?'発信（企画書）':'発信')}</Button>
    </Box>

    <PickerDialog open={openPicker} onClose={()=>setOpenPicker(false)} onConfirm={s=>{(pickerKind==='to'?setToSel:setCcSel)(s); setOpenPicker(false);}} initial={pickerKind==='to'?toSel:ccSel}/>
  </Box>);
}

/* ========= メイン ========= */
function App(){
  const theme=useMemo(()=>createTheme({
    palette:{primary:{main:'#6366F1'},secondary:{main:'#14B8A6'},background:{default:'#f6f7fb'}},
    shape:{borderRadius:12},
    components:{MuiPaper:{styleOverrides:{root:{borderRadius:12}}},MuiTableHead:{styleOverrides:{root:{backgroundColor:'rgba(0,0,0,0.02)'}}}},
    typography:{fontFamily:['Roboto','system-ui','-apple-system','BlinkMacSystemFont','Segoe UI','"Noto Sans JP"','sans-serif'].join(',')}
  }),[]);
  const [rows,setRows]=useState(()=>[...BASE_LIST,...makeSamples(200)]);
  const [page,setPage]=useState('list'); // list | composeNotice | composeProposal
  const [editingDoc,setEditingDoc]=useState(null);

  const handleEditDraft=doc=>{setEditingDoc(doc); setPage(doc.form==='企画書'?'composeProposal':'composeNotice');};
  const closeCompose=()=>{setEditingDoc(null); setPage('list');};
  const approve=id=>setRows(p=>p.map(r=>r.id===id?{...r,approval:'承認済'}:r));
  const reject=id=>setRows(p=>p.map(r=>r.id===id?{...r,approval:'差戻し'}:r));

  const title =
    page==='list' ? '一覧（発信文書 / 企画書）'
    : page==='composeProposal' ? (editingDoc?'企画書を編集':'企画書作成')
    : (editingDoc?'下書き編集':'発信文書作成');

  return (<ThemeProvider theme={theme}>
    <AppBar elevation={0} position="sticky" sx={{background:'#fff',borderBottom:'1px solid #e5e7eb',color:'inherit'}}>
      <Toolbar variant="dense" sx={{gap:1,flexWrap:'wrap'}}>
        <Button variant={page==='list'?'contained':'text'} onClick={()=>{setPage('list');setEditingDoc(null);}} startIcon={<Icon name="inbox"/>}>一覧</Button>
        <Button variant={page==='composeNotice'?'contained':'text'} onClick={()=>{setEditingDoc(null);setPage('composeNotice');}} startIcon={<Icon name="edit"/>}>発信文書作成</Button>
        <Button variant={page==='composeProposal'?'contained':'text'} onClick={()=>{setEditingDoc(null);setPage('composeProposal');}} startIcon={<Icon name="description"/>}>企画書作成</Button>
        <Divider orientation="vertical" flexItem sx={{mx:1}}/>
        <Stack direction="row" alignItems="center" spacing={1}>
          <Icon name="dashboard"/><Typography variant="h6" sx={{fontWeight:700}}>{title}</Typography>
        </Stack>
        <Box sx={{flex:1}}/>
        <Tooltip title="A4プレビューを印刷"><IconButton onClick={printA4}><Icon name="print"/></IconButton></Tooltip>
      </Toolbar>
    </AppBar>

    {page==='list'
      ? <InboxList rows={rows} setRows={setRows} onEditDraft={handleEditDraft} onApprove={approve} onReject={reject}/>
      : page==='composeProposal'
        ? <ComposeView rows={rows} setRows={setRows} initialDoc={editingDoc} onClose={closeCompose} fixedForm="企画書" allowedForms={['企画書']}/>
        : <ComposeView rows={rows} setRows={setRows} initialDoc={editingDoc} onClose={closeCompose} allowedForms={FORMS_MASTER.filter(f=>f!=='企画書')}/>
    }
  </ThemeProvider>);
}
ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
</script>
</body></html>
