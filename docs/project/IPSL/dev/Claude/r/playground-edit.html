<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>申込管理システム - 申込・明細管理版</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;600&display=swap" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/react@18/umd/react.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@emotion/react@11.11.3/dist/emotion-react.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@emotion/styled@11.11.0/dist/emotion-styled.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mui/material@5.15.3/umd/material-ui.production.min.js"></script>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { Container, Box, Button, Grid, Stepper, Step, StepLabel, TableContainer, Table, TableHead, TableRow, TableCell, TableBody, Paper, Typography, TextField, Select, MenuItem, FormControl, InputLabel, Chip, Alert, Card, CardContent, CardActions, Divider, Accordion, AccordionSummary, AccordionDetails } = MaterialUI;

    // 申込データ（申込単位）
    const sampleApplications = [
      { 
        id: 1, 
        申込者: '田中様', 
        連絡先: 'tanaka@example.com', 
        申込日: '2024-06-15',
        申込ステータス: '希望',
        備考: '同日3店舗希望'
      },
      { 
        id: 2, 
        申込者: '佐藤様', 
        連絡先: 'sato@example.com', 
        申込日: '2024-06-16',
        申込ステータス: '希望',
        備考: '複数日程希望'
      }
    ];

    // 明細データ（店舗日程単位）- 1申込で同じ日程で3店舗パターン
    const sampleDetails = [
      { id: 1, 申込ID: 1, 店舗: '西永福', 日付: '7月1日', 開始時刻: '10:30', 終了時刻: '15:00', 人数: 5, クラス数: 2, 付添人数: 1, 明細ステータス: '希望' },
      { id: 2, 申込ID: 1, 店舗: '上北沢', 日付: '7月1日', 開始時刻: '10:30', 終了時刻: '15:00', 人数: 5, クラス数: 2, 付添人数: 1, 明細ステータス: '希望' },
      { id: 3, 申込ID: 1, 店舗: '和泉', 日付: '7月1日', 開始時刻: '10:30', 終了時刻: '15:00', 人数: 5, クラス数: 2, 付添人数: 1, 明細ステータス: '希望' },
      { id: 4, 申込ID: 2, 店舗: '成城', 日付: '7月3日', 開始時刻: '10:30', 終了時刻: '15:00', 人数: 8, クラス数: 3, 付添人数: 2, 明細ステータス: '希望' },
      { id: 5, 申込ID: 2, 店舗: '成城', 日付: '7月4日', 開始時刻: '10:30', 終了時刻: '15:00', 人数: 8, クラス数: 3, 付添人数: 2, 明細ステータス: '希望' },
      { id: 6, 申込ID: 2, 店舗: '三軒茶屋', 日付: '7月5日', 開始時刻: '10:30', 終了時刻: '15:00', 人数: 8, クラス数: 3, 付添人数: 2, 明細ステータス: '希望' }
    ];

    const steps = ['希望', '受け入れ予定作成', '店舗確認', '調整・振り替え', '申込者提案', '申込者承認', '受け入れ確定'];
    const detailCols = ['店舗', '日付', '開始時刻', '終了時刻', '人数', 'クラス数', '付添人数', '明細ステータス'];
    const stores = ['西永福', '上北沢', '和泉', '成城', '三軒茶屋'];
    const statusColors = {
      '希望': 'default',
      '受け入れ可能': 'success',
      '受け入れ困難': 'error',
      '調整中': 'warning',
      '承認待ち': 'info',
      '承認済み': 'success',
      '確定': 'primary'
    };

    function ApplicationTable({ title, applications, details, editable, onApplicationEdit, onDetailEdit, confirmMode, onConfirm }) {
      const handleApplicationChange = (appId, field, value) => {
        onApplicationEdit?.(applications.map(app => app.id === appId ? { ...app, [field]: value } : app));
      };

      const handleDetailChange = (detailId, field, value) => {
        onDetailEdit?.(details.map(detail => detail.id === detailId ? { ...detail, [field]: value } : detail));
      };

      const handleDetailStatus = (detailId, status) => {
        onConfirm?.(details.map(detail => detail.id === detailId ? { ...detail, 明細ステータス: status } : detail));
      };

      return (
        <Box>
          <Typography variant="h6" gutterBottom>{title}</Typography>
          {applications.map(app => {
            const appDetails = details.filter(d => d.申込ID === app.id);
            return (
              <Card key={app.id} sx={{ mb: 2 }}>
                <CardContent>
                  <Grid container spacing={2} alignItems="center">
                    <Grid item xs={3}>
                      <Typography variant="h6">{app.申込者}</Typography>
                      <Typography variant="body2" color="text.secondary">
                        申込日: {app.申込日}
                      </Typography>
                    </Grid>
                    <Grid item xs={3}>
                      {editable ? (
                        <TextField
                          label="連絡先"
                          size="small"
                          fullWidth
                          value={app.連絡先}
                          onChange={e => handleApplicationChange(app.id, '連絡先', e.target.value)}
                        />
                      ) : (
                        <Typography variant="body2">{app.連絡先}</Typography>
                      )}
                    </Grid>
                    <Grid item xs={3}>
                      <Chip
                        label={app.申込ステータス}
                        color={statusColors[app.申込ステータス]}
                        size="small"
                      />
                    </Grid>
                    <Grid item xs={3}>
                      {editable ? (
                        <TextField
                          label="備考"
                          size="small"
                          fullWidth
                          value={app.備考}
                          onChange={e => handleApplicationChange(app.id, '備考', e.target.value)}
                        />
                      ) : (
                        <Typography variant="body2">{app.備考}</Typography>
                      )}
                    </Grid>
                  </Grid>
                  
                  <Divider sx={{ my: 2 }} />
                  
                  <Typography variant="subtitle1" gutterBottom>明細情報</Typography>
                  <TableContainer>
                    <Table size="small">
                      <TableHead>
                        <TableRow>
                          {detailCols.map(col => (
                            <TableCell key={col} sx={{ whiteSpace: 'nowrap' }}>{col}</TableCell>
                          ))}
                        </TableRow>
                      </TableHead>
                      <TableBody>
                        {appDetails.map(detail => (
                          <TableRow key={detail.id}>
                            {detailCols.map(col => (
                              <TableCell key={col} sx={{ whiteSpace: 'nowrap', p: editable ? 0.5 : 1 }}>
                                {editable && col !== '明細ステータス' ? (
                                  col === '店舗' ? (
                                    <FormControl size="small" sx={{ minWidth: 80 }}>
                                      <Select value={detail[col]} onChange={e => handleDetailChange(detail.id, col, e.target.value)}>
                                        {stores.map(store => <MenuItem key={store} value={store}>{store}</MenuItem>)}
                                      </Select>
                                    </FormControl>
                                  ) : (
                                    <TextField
                                      variant="standard"
                                      fullWidth
                                      type={col === '人数' || col === 'クラス数' || col === '付添人数' ? 'number' : 'text'}
                                      value={detail[col]}
                                      onChange={e => handleDetailChange(detail.id, col, e.target.value)}
                                      inputProps={{ min: 0 }}
                                    />
                                  )
                                ) : confirmMode && col === '明細ステータス' ? (
                                  <FormControl size="small" sx={{ minWidth: 100 }}>
                                    <Select value={detail.明細ステータス} onChange={e => handleDetailStatus(detail.id, e.target.value)}>
                                      <MenuItem value="受け入れ可能">受け入れ可能</MenuItem>
                                      <MenuItem value="受け入れ困難">受け入れ困難</MenuItem>
                                    </Select>
                                  </FormControl>
                                ) : col === '明細ステータス' ? (
                                  <Chip
                                    label={detail[col]}
                                    color={statusColors[detail[col]]}
                                    size="small"
                                  />
                                ) : detail[col]
                                }
                              </TableCell>
                            ))}
                          </TableRow>
                        ))}
                      </TableBody>
                    </Table>
                  </TableContainer>
                </CardContent>
              </Card>
            );
          })}
        </Box>
      );
    }

    function AdjustmentTable({ title, applications, details, onChange }) {
      const handleDetailChange = (detailId, field, value) => {
        const newDetails = details.map(detail => 
          detail.id === detailId ? { ...detail, [field]: value, 調整済み: true } : detail
        );
        onChange(newDetails);
      };

      // 希望通りの明細を元のデータから取得
      const getOriginalDetail = (detailId) => {
        return sampleDetails.find(d => d.id === detailId);
      };

      return (
        <Box>
          <Typography variant="h6" gutterBottom>{title}</Typography>
          <Alert severity="info" sx={{ mb: 2 }}>
            すべての明細を一覧で確認できます。調整が必要なものは希望と比較して調整してください。
          </Alert>

          {applications.map(app => {
            const appDetails = details.filter(d => d.申込ID === app.id);
            return (
              <Card key={app.id} sx={{ mb: 3 }}>
                <CardContent>
                  <Typography variant="h6" gutterBottom>
                    {app.申込者} - {app.備考}
                  </Typography>
                  
                  <TableContainer>
                    <Table size="small">
                      <TableHead>
                        <TableRow>
                          <TableCell sx={{ width: 120 }}>ステータス</TableCell>
                          <TableCell sx={{ width: 100 }}>日付</TableCell>
                          <TableCell sx={{ width: 100 }}>希望店舗</TableCell>
                          <TableCell sx={{ width: 100 }}>調整店舗</TableCell>
                          <TableCell sx={{ width: 100 }}>希望時間</TableCell>
                          <TableCell sx={{ width: 120 }}>調整時間</TableCell>
                          <TableCell sx={{ width: 80 }}>希望人数</TableCell>
                          <TableCell sx={{ width: 80 }}>調整人数</TableCell>
                          <TableCell sx={{ width: 80 }}>希望クラス</TableCell>
                          <TableCell sx={{ width: 80 }}>調整クラス</TableCell>
                          <TableCell sx={{ width: 80 }}>希望付添</TableCell>
                          <TableCell sx={{ width: 80 }}>調整付添</TableCell>
                        </TableRow>
                      </TableHead>
                      <TableBody>
                        {appDetails.map(detail => {
                          const original = getOriginalDetail(detail.id);
                          const isAdjustmentNeeded = detail.明細ステータス === '受け入れ困難';
                          
                          return (
                            <TableRow 
                              key={detail.id}
                              sx={{ 
                                backgroundColor: isAdjustmentNeeded ? '#ffebee' : '#e8f5e8',
                                '&:hover': { backgroundColor: isAdjustmentNeeded ? '#ffcdd2' : '#c8e6c9' }
                              }}
                            >
                              <TableCell>
                                <Chip
                                  label={detail.明細ステータス}
                                  color={statusColors[detail.明細ステータス]}
                                  size="small"
                                />
                              </TableCell>
                              
                              <TableCell>
                                {isAdjustmentNeeded ? (
                                  <TextField
                                    variant="standard"
                                    size="small"
                                    value={detail.日付}
                                    onChange={e => handleDetailChange(detail.id, '日付', e.target.value)}
                                    sx={{ width: 80 }}
                                  />
                                ) : (
                                  detail.日付
                                )}
                              </TableCell>
                              
                              <TableCell>
                                <Typography variant="body2" color="text.secondary">
                                  {original?.店舗}
                                </Typography>
                              </TableCell>
                              <TableCell>
                                {isAdjustmentNeeded ? (
                                  <FormControl size="small" sx={{ minWidth: 80 }}>
                                    <Select 
                                      value={detail.店舗} 
                                      onChange={e => handleDetailChange(detail.id, '店舗', e.target.value)}
                                      variant="standard"
                                    >
                                      {stores.map(store => <MenuItem key={store} value={store}>{store}</MenuItem>)}
                                    </Select>
                                  </FormControl>
                                ) : (
                                  detail.店舗
                                )}
                              </TableCell>
                              
                              <TableCell>
                                <Typography variant="body2" color="text.secondary">
                                  {original?.開始時刻}-{original?.終了時刻}
                                </Typography>
                              </TableCell>
                              <TableCell>
                                {isAdjustmentNeeded ? (
                                  <Box sx={{ display: 'flex', gap: 0.5 }}>
                                    <TextField
                                      variant="standard"
                                      size="small"
                                      value={detail.開始時刻}
                                      onChange={e => handleDetailChange(detail.id, '開始時刻', e.target.value)}
                                      sx={{ width: 50 }}
                                    />
                                    <Typography variant="body2" sx={{ alignSelf: 'center' }}>-</Typography>
                                    <TextField
                                      variant="standard"
                                      size="small"
                                      value={detail.終了時刻}
                                      onChange={e => handleDetailChange(detail.id, '終了時刻', e.target.value)}
                                      sx={{ width: 50 }}
                                    />
                                  </Box>
                                ) : (
                                  `${detail.開始時刻}-${detail.終了時刻}`
                                )}
                              </TableCell>
                              
                              <TableCell>
                                <Typography variant="body2" color="text.secondary">
                                  {original?.人数}
                                </Typography>
                              </TableCell>
                              <TableCell>
                                {isAdjustmentNeeded ? (
                                  <TextField
                                    variant="standard"
                                    size="small"
                                    type="number"
                                    value={detail.人数}
                                    onChange={e => handleDetailChange(detail.id, '人数', e.target.value)}
                                    inputProps={{ min: 0 }}
                                    sx={{ width: 60 }}
                                  />
                                ) : (
                                  detail.人数
                                )}
                              </TableCell>
                              
                              <TableCell>
                                <Typography variant="body2" color="text.secondary">
                                  {original?.クラス数}
                                </Typography>
                              </TableCell>
                              <TableCell>
                                {isAdjustmentNeeded ? (
                                  <TextField
                                    variant="standard"
                                    size="small"
                                    type="number"
                                    value={detail.クラス数}
                                    onChange={e => handleDetailChange(detail.id, 'クラス数', e.target.value)}
                                    inputProps={{ min: 0 }}
                                    sx={{ width: 60 }}
                                  />
                                ) : (
                                  detail.クラス数
                                )}
                              </TableCell>
                              
                              <TableCell>
                                <Typography variant="body2" color="text.secondary">
                                  {original?.付添人数}
                                </Typography>
                              </TableCell>
                              <TableCell>
                                {isAdjustmentNeeded ? (
                                  <TextField
                                    variant="standard"
                                    size="small"
                                    type="number"
                                    value={detail.付添人数}
                                    onChange={e => handleDetailChange(detail.id, '付添人数', e.target.value)}
                                    inputProps={{ min: 0 }}
                                    sx={{ width: 60 }}
                                  />
                                ) : (
                                  detail.付添人数
                                )}
                              </TableCell>
                            </TableRow>
                          );
                        })}
                      </TableBody>
                    </Table>
                  </TableContainer>
                </CardContent>
              </Card>
            );
          })}
        </Box>
      );
    }

    function GroupedTable({ title, applications, details, showButtons, onApproval, infoText }) {
      const handleApproval = (appId, approved) => {
        onApproval?.(appId, approved);
      };

      return (
        <Box>
          <Typography variant="h6" gutterBottom>{title}</Typography>
          <Alert severity="info" sx={{ mb: 2 }}>{infoText}</Alert>
          
          {applications.map(app => {
            const appDetails = details.filter(d => d.申込ID === app.id);
            return (
              <Card key={app.id} sx={{ mb: 2 }}>
                <CardContent>
                  <Grid container spacing={2} alignItems="center">
                    <Grid item xs={4}>
                      <Typography variant="h6">{app.申込者}</Typography>
                      <Typography variant="body2" color="text.secondary">
                        連絡先: {app.連絡先}
                      </Typography>
                    </Grid>
                    <Grid item xs={4}>
                      <Chip
                        label={app.申込ステータス}
                        color={statusColors[app.申込ステータス]}
                        size="small"
                      />
                    </Grid>
                    <Grid item xs={4}>
                      {showButtons && (
                        <Box>
                          <Button
                            size="small"
                            variant="contained"
                            color="success"
                            onClick={() => handleApproval(app.id, true)}
                            disabled={app.申込ステータス === '承認済み'}
                            sx={{ mr: 1 }}
                          >
                            承認
                          </Button>
                          <Button
                            size="small"
                            variant="outlined"
                            color="error"
                            onClick={() => handleApproval(app.id, false)}
                          >
                            未承認
                          </Button>
                        </Box>
                      )}
                    </Grid>
                  </Grid>
                  
                  <Divider sx={{ my: 2 }} />
                  
                  <TableContainer>
                    <Table size="small">
                      <TableHead>
                        <TableRow>
                          <TableCell>日付</TableCell>
                          <TableCell>店舗</TableCell>
                          <TableCell>時間</TableCell>
                          <TableCell>人数</TableCell>
                          <TableCell>クラス数</TableCell>
                          <TableCell>付添人数</TableCell>
                          <TableCell>状態</TableCell>
                        </TableRow>
                      </TableHead>
                      <TableBody>
                        {appDetails.map(detail => (
                          <TableRow key={detail.id}>
                            <TableCell>{detail.日付}</TableCell>
                            <TableCell>{detail.店舗}</TableCell>
                            <TableCell>{detail.開始時刻}-{detail.終了時刻}</TableCell>
                            <TableCell>{detail.人数}名</TableCell>
                            <TableCell>{detail.クラス数}</TableCell>
                            <TableCell>{detail.付添人数}名</TableCell>
                            <TableCell>
                              <Chip
                                label={detail.調整済み ? "調整済み" : "希望通り"}
                                color={detail.調整済み ? "warning" : "success"}
                                size="small"
                              />
                            </TableCell>
                          </TableRow>
                        ))}
                      </TableBody>
                    </Table>
                  </TableContainer>
                </CardContent>
                
                {!showButtons && (
                  <CardActions>
                    <Button size="small" variant="outlined">メール送信</Button>
                  </CardActions>
                )}
              </Card>
            );
          })}
        </Box>
      );
    }

    function App() {
      const [activeStep, setActiveStep] = React.useState(0);
      const [applications, setApplications] = React.useState([]);
      const [details, setDetails] = React.useState([]);

      const handleNext = () => {
        if (activeStep === 0) {
          // 希望 -> 受け入れ予定作成
          setApplications(sampleApplications.map(app => ({ ...app, 申込ステータス: '受け入れ予定作成' })));
          setDetails(sampleDetails.map(detail => ({ ...detail, 明細ステータス: '受け入れ予定作成' })));
        } else if (activeStep === 1) {
          // 受け入れ予定作成 -> 店舗確認
          setApplications(prev => prev.map(app => ({ ...app, 申込ステータス: '店舗確認' })));
          setDetails(prev => prev.map(detail => ({ ...detail, 明細ステータス: '店舗確認' })));
        } else if (activeStep === 2) {
          // 店舗確認 -> 調整・振り替え
          setApplications(prev => prev.map(app => ({ ...app, 申込ステータス: '調整中' })));
          setDetails(prev => prev.map((detail, i) => ({ 
            ...detail, 
            明細ステータス: i === 1 || i === 4 ? '受け入れ困難' : '受け入れ可能' 
          })));
        } else if (activeStep === 3) {
          // 調整・振り替え -> 申込者提案
          setApplications(prev => prev.map(app => ({ ...app, 申込ステータス: '申込者提案' })));
          setDetails(prev => prev.map(detail => ({ 
            ...detail, 
            明細ステータス: detail.明細ステータス === '受け入れ困難' ? '調整中' : '受け入れ可能' 
          })));
        } else if (activeStep === 4) {
          // 申込者提案 -> 申込者承認
          setApplications(prev => prev.map(app => ({ ...app, 申込ステータス: '承認待ち' })));
        }
        setActiveStep(s => s + 1);
      };

      const handleApproval = (appId, approved) => {
        setApplications(prev => prev.map(app =>
          app.id === appId ? { ...app, 申込ステータス: approved ? '承認済み' : '承認待ち' } : app
        ));
      };

      const renderStep = () => {
        switch (activeStep) {
          case 0:
            return <ApplicationTable 
              title="申込（希望）" 
              applications={sampleApplications} 
              details={sampleDetails} 
            />;
          case 1:
            return <ApplicationTable 
              title="受け入れ予定内容作成" 
              applications={applications} 
              details={details} 
              editable 
              onApplicationEdit={setApplications}
              onDetailEdit={setDetails}
            />;
          case 2:
            return <ApplicationTable 
              title="店舗確認" 
              applications={applications} 
              details={details} 
              confirmMode 
              onConfirm={setDetails}
            />;
          case 3:
            return <AdjustmentTable 
              title="調整・振り替え" 
              applications={applications}
              details={details} 
              onChange={setDetails} 
            />;
          case 4:
            return <GroupedTable 
              title="申込者提案" 
              applications={applications}
              details={details} 
              infoText="調整内容を申込者に提案します" 
            />;
          case 5:
            return <GroupedTable 
              title="申込者承認待ち" 
              applications={applications}
              details={details} 
              showButtons 
              onApproval={handleApproval} 
              infoText="申込者からの承認状況を管理します" 
            />;
          case 6:
            const confirmedApplications = applications.filter(app => app.申込ステータス === '承認済み');
            const confirmedDetails = details.filter(detail => 
              confirmedApplications.some(app => app.id === detail.申込ID)
            );
            return (
              <>
                <GroupedTable 
                  title="受け入れ確定内容" 
                  applications={confirmedApplications.map(app => ({ ...app, 申込ステータス: '確定' }))}
                  details={confirmedDetails} 
                  infoText="承認済みの申込内容が確定されました" 
                />
                <Alert severity="success" sx={{ mt: 2 }}>
                  申込者承認済みの内容が確定されました。各店舗に最終確定の連絡を行ってください。
                </Alert>
              </>
            );
          default:
            return null;
        }
      };

      return (
        <Container maxWidth={false} disableGutters sx={{ width: '100%' }}>
          <Box p={2}>
            <Typography variant="h4" gutterBottom>申込管理システム - 申込・明細管理版</Typography>
            <Stepper activeStep={activeStep} sx={{ mb: 3 }}>
              {steps.map(label => <Step key={label}><StepLabel>{label}</StepLabel></Step>)}
            </Stepper>
            
            <Box mt={3}>
              {renderStep()}
              <Box mt={2}>
                {activeStep > 0 && (
                  <Button onClick={() => setActiveStep(s => s - 1)}>戻る</Button>
                )}
                {activeStep < steps.length - 1 && (
                  <Button variant="contained" onClick={handleNext} sx={{ ml: 1 }}>
                    次へ: {steps[activeStep + 1]}
                  </Button>
                )}
                {activeStep === steps.length - 1 && (
                  <Button onClick={() => { setActiveStep(0); setApplications([]); setDetails([]); }}>
                    最初に戻る
                  </Button>
                )}
              </Box>
            </Box>
          </Box>
        </Container>
      );
    }

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>