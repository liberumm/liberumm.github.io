<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>å¿œæ´ä¾é ¼ãƒ•ãƒ­ãƒ¼</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap"/>
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons"/>
  <script src="https://cdn.jsdelivr.net/npm/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mui/material@5/umd/material-ui.production.min.js" crossorigin></script>
  <style>
    html, body, #root { height: 100%; margin: 0; }
    .mono { font-family: ui-monospace, monospace; }
    .resizable { position: relative; }
    .resizer {
      position: absolute;
      right: 0;
      top: 0;
      height: 100%;
      width: 5px;
      cursor: col-resize;
      user-select: none;
      touch-action: none;
    }
    .resizer:hover { background: rgba(0,0,0,0.1); }
  </style>
</head>
<body>
<div id="root"></div>

<script type="text/babel">
const {
  AppBar, Toolbar, Typography, CssBaseline, Container, Box, Stack, Button,
  ThemeProvider, createTheme, useMediaQuery, Paper, Chip, TextField, Dialog,
  DialogTitle, DialogContent, DialogActions, Grid, MenuItem, Select, InputLabel, FormControl,
  Snackbar, Alert, Table, TableBody, TableCell, TableContainer, TableHead, TableRow, Checkbox,
  FormControlLabel, Divider, IconButton, Tooltip, Badge, Collapse, TableSortLabel
} = MaterialUI;

/* ===== ãƒ‡ãƒ¼ã‚¿å®šç¾© ===== */
const STATUSES = [
  { key: 'request', label: '1.ä¾é ¼', color: 'default' },
  { key: 'estimate', label: '2.è¦‹ç©ã‚‚ã‚Š', color: 'info' },
  { key: 'confirmed', label: '3.ç¢ºå®š', color: 'primary' },
  { key: 'supporter_check', label: '4.å½“æ—¥ç¢ºèª', color: 'warning' },
  { key: 'finalize', label: '5.å®Œäº†ç™»éŒ²', color: 'warning' },
  { key: 'invoice_wait', label: '6.è«‹æ±‚å¾…ã¡', color: 'success' },
];

const mockPartners = ['æ ªå¼ä¼šç¤¾ã‚¢ãƒ«ã‚¿','ãƒ†ã‚¯ãƒãƒªãƒ³ã‚¯ã‚¹','ACMEåˆåŒä¼šç¤¾','åŒ—æ–—ã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ã‚º'];
const mockStores = ['æ–°å®¿æœ¬åº—','å¤§é˜ªä¸­å¤®','åå¤å±‹æ „','æœ­å¹Œé§…å‰'];
const mockDepartments = ['å–¶æ¥­ä¼ç”»éƒ¨','åº—èˆ—æ”¯æ´éƒ¨','æƒ…å ±ã‚·ã‚¹ãƒ†ãƒ éƒ¨','DXæ¨é€²å®¤'];

const randomId = () => Math.random().toString(36).slice(2,8);
const yen = v => v ? `Â¥${Number(v).toLocaleString()}` : 'â€”';
const fmtDate = iso => iso ? new Date(iso).toISOString().slice(0,10) : 'â€”';

function nextStatus(key) {
  const idx = STATUSES.findIndex(s => s.key === key);
  return idx >= 0 && idx < STATUSES.length - 1 ? STATUSES[idx + 1].key : null;
}

function randPick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
function randInt(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }
function daysFromNow(d){ return new Date(Date.now()+86400000*d).toISOString().slice(0,10); }

function makeDummyItem(status = null) {
  const st = status || randPick(['request','estimate','confirmed']);
  const heads = randInt(1,3);
  const schedules = [{
    date: daysFromNow(randInt(1,14)),
    startTime: `${randInt(9,15)}:00`,
    endTime: `${randInt(16,21)}:00`
  }];
  return {
    id: randomId(),
    title: `${randPick(mockStores)} å•†å“é™³åˆ—å¿œæ´`,
    partner: randPick(mockPartners),
    partnerCode: 'P-' + randInt(100,999),
    store: randPick(mockStores),
    schedules,
    heads,
    department: randPick(mockDepartments),
    content: 'æ£šæ›¿ãˆãƒ»ãƒ©ãƒ™ãƒ«å·®æ›¿ãˆ',
    memo: '',
    status: st,
    createdAt: new Date().toISOString(),
    confirmedAt: st === 'confirmed' ? new Date().toISOString() : null,
    estimate: st === 'confirmed' ? {
      amount: randInt(8,50)*10000,
      note: '2åÃ—2h',
      supporters: [{date: schedules[0].date, startTime: schedules[0].startTime, endTime: schedules[0].endTime, name:'å±±ç”°å¤ªéƒ', transport:'800'}]
    } : null,
  };
}

/* ===== CSVå‡ºåŠ› ===== */
function exportCSV(items) {
  const headers = ['No','ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹','å¿œæ´æ—¥','é–‹å§‹æ™‚åˆ»','çµ‚äº†æ™‚åˆ»','äººæ•°','éƒ¨é–€','å–å¼•å…ˆã‚³ãƒ¼ãƒ‰','å–å¼•å…ˆå','å¿œæ´åº—èˆ—','ä¾é ¼æ—¥','ç¢ºå®šæ—¥','è¦‹ç©é‡‘é¡'];
  const rows = items.map((item, idx) => [
    idx + 1,
    STATUSES.find(s => s.key === item.status)?.label || '',
    item.schedules?.map(s => s.date).join('ã€') || '',
    item.schedules?.[0]?.startTime || '',
    item.schedules?.[0]?.endTime || '',
    item.heads,
    item.department,
    item.partnerCode,
    item.partner,
    item.store,
    fmtDate(item.createdAt),
    fmtDate(item.confirmedAt),
    item.estimate ? item.estimate.amount : '',
  ]);
  
  const csv = [headers, ...rows].map(row => 
    row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(',')
  ).join('\n');
  
  const bom = '\uFEFF';
  const blob = new Blob([bom + csv], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = `å¿œæ´ä¾é ¼_${new Date().toISOString().slice(0,10)}.csv`;
  link.click();
}

/* ===== ãƒ˜ãƒƒãƒ€ãƒ¼ ===== */
function Header({role, setRole, onNew, dark, toggleDark, count, onHelp}) {
  return (
    <AppBar position="sticky">
      <Toolbar>
        <Typography variant="h6" sx={{flexGrow:1}}>å¿œæ´ä¾é ¼ãƒ•ãƒ­ãƒ¼ç®¡ç†</Typography>
        <FormControl size="small" sx={{mr:2, minWidth:100, bgcolor:'rgba(255,255,255,0.15)', borderRadius:1}}>
          <Select value={role} onChange={e=>setRole(e.target.value)} sx={{color:'white'}}>
            <MenuItem value="è‡ªç¤¾">è‡ªç¤¾</MenuItem>
            <MenuItem value="å–å¼•å…ˆ">å–å¼•å…ˆ</MenuItem>
          </Select>
        </FormControl>
        {role === 'è‡ªç¤¾' && (
          <Button color="inherit" startIcon={<span className="material-icons">add</span>} onClick={onNew}>
            æ–°è¦ä¾é ¼
          </Button>
        )}
        <IconButton color="inherit" onClick={onHelp} sx={{ml:1}}>
          <span className="material-icons">help_outline</span>
        </IconButton>
        <IconButton color="inherit" onClick={toggleDark} sx={{ml:1}}>
          <span className="material-icons">{dark?'dark_mode':'light_mode'}</span>
        </IconButton>
        <IconButton color="inherit">
          <Badge badgeContent={count} color="error">
            <span className="material-icons">notifications</span>
          </Badge>
        </IconButton>
      </Toolbar>
    </AppBar>
  );
}

/* ===== ãƒ˜ãƒ«ãƒ—ãƒ‘ãƒãƒ« ===== */
function HelpPanel({open}) {
  return (
    <Collapse in={open}>
      <Paper sx={{p:2, mb:2}}>
        <Typography variant="h6" gutterBottom>ğŸ“– ä½¿ã„æ–¹ã‚¬ã‚¤ãƒ‰</Typography>
        <Divider sx={{my:1}}/>
        <Grid container spacing={2}>
          <Grid item xs={12} md={6}>
            <Typography variant="subtitle2" gutterBottom>ğŸ¢ è‡ªç¤¾ã®æ“ä½œ</Typography>
            <Typography variant="body2" component="div">
              â‘  æ–°è¦ä¾é ¼ãƒœã‚¿ãƒ³ã‹ã‚‰ä¾é ¼ã‚’ä½œæˆ<br/>
              â‘¡ å–å¼•å…ˆãŒè¦‹ç©ã‚‚ã‚Šã‚’ç™»éŒ²ã™ã‚‹ã¾ã§å¾…æ©Ÿ<br/>
              â‘¢ ç¢ºå®šå¾Œã€å½“æ—¥ç¢ºèªâ†’å®Œäº†ç™»éŒ²â†’è«‹æ±‚å¾…ã¡ ã¸é€²ã‚ã‚‹<br/>
              â‘£ ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ã‚¯ãƒªãƒƒã‚¯ã§ä¸¦ã³æ›¿ãˆ<br/>
              â‘¤ åˆ—ã®å¢ƒç•Œã‚’ãƒ‰ãƒ©ãƒƒã‚°ã§åˆ—å¹…èª¿æ•´
            </Typography>
          </Grid>
          <Grid item xs={12} md={6}>
            <Typography variant="subtitle2" gutterBottom>ğŸ¤ å–å¼•å…ˆã®æ“ä½œ</Typography>
            <Typography variant="body2" component="div">
              â‘  è¦‹ç©ã‚‚ã‚Šã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®æ¡ˆä»¶ã‚’é–‹ã<br/>
              â‘¡ è¦‹ç©ã‚‚ã‚Šç™»éŒ²ãƒœã‚¿ãƒ³ã‹ã‚‰é‡‘é¡ãƒ»å¿œæ´è€…ã‚’å…¥åŠ›<br/>
              â‘¢ ç‹¬ç¦æ³•æ³¨æ„äº‹é …ã«åŒæ„ã—ã¦ç™»éŒ²<br/>
              â‘£ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã§åŠ¹ç‡çš„ã«ç®¡ç†
            </Typography>
          </Grid>
        </Grid>
      </Paper>
    </Collapse>
  );
}

/* ===== æ–°è¦ä¾é ¼ãƒ€ã‚¤ã‚¢ãƒ­ã‚° ===== */
function CreateDialog({open, onClose, onCreate}) {
  const [partner, setPartner] = React.useState(mockPartners[0]);
  const [partnerCode, setPartnerCode] = React.useState('P-' + randInt(100,999));
  const [store, setStore] = React.useState(mockStores[0]);
  const [heads, setHeads] = React.useState(1);
  const [dept, setDept] = React.useState(mockDepartments[0]);
  const [content, setContent] = React.useState('');
  const [memo, setMemo] = React.useState('');
  const [schedules, setSchedules] = React.useState([
    {date: '', startTime: '09:00', endTime: '18:00'}
  ]);

  const addSchedule = () => setSchedules(prev => [...prev, {date:'', startTime:'09:00', endTime:'18:00'}]);
  const removeSchedule = (idx) => setSchedules(prev => prev.filter((_,i) => i !== idx));
  const updateSchedule = (idx, patch) => setSchedules(prev => prev.map((s,i) => i===idx ? {...s,...patch} : s));

  const canSave = partner && store && heads > 0 && dept && content && schedules.length > 0 && schedules.every(s => s.date && s.startTime && s.endTime);

  const save = () => {
    onCreate({
      id: randomId(),
      title: `${store} å•†å“é™³åˆ—å¿œæ´`,
      partner, partnerCode, store, schedules, heads,
      department: dept, content, memo,
      status: 'request',
      createdAt: new Date().toISOString(),
      confirmedAt: null,
      estimate: null,
    });
  };

  return (
    <Dialog open={open} onClose={onClose} fullWidth maxWidth="md">
      <DialogTitle>æ–°è¦ä¾é ¼ä½œæˆ</DialogTitle>
      <DialogContent dividers>
        <Grid container spacing={2}>
          <Grid item xs={12} sm={6}>
            <FormControl fullWidth>
              <InputLabel>å–å¼•å…ˆ</InputLabel>
              <Select label="å–å¼•å…ˆ" value={partner} onChange={e=>setPartner(e.target.value)}>
                {mockPartners.map(p => <MenuItem key={p} value={p}>{p}</MenuItem>)}
              </Select>
            </FormControl>
          </Grid>
          <Grid item xs={12} sm={6}>
            <TextField label="å–å¼•å…ˆã‚³ãƒ¼ãƒ‰" value={partnerCode} onChange={e=>setPartnerCode(e.target.value)} fullWidth/>
          </Grid>
          
          <Grid item xs={12} sm={6}>
            <FormControl fullWidth>
              <InputLabel>å¿œæ´åº—èˆ—</InputLabel>
              <Select label="å¿œæ´åº—èˆ—" value={store} onChange={e=>setStore(e.target.value)}>
                {mockStores.map(s => <MenuItem key={s} value={s}>{s}</MenuItem>)}
              </Select>
            </FormControl>
          </Grid>
          <Grid item xs={12} sm={6}>
            <FormControl fullWidth>
              <InputLabel>éƒ¨é–€</InputLabel>
              <Select label="éƒ¨é–€" value={dept} onChange={e=>setDept(e.target.value)}>
                {mockDepartments.map(d => <MenuItem key={d} value={d}>{d}</MenuItem>)}
              </Select>
            </FormControl>
          </Grid>

          <Grid item xs={12} sm={6}>
            <TextField type="number" label="äººæ•°" value={heads} onChange={e=>setHeads(Math.max(1, Number(e.target.value)))} fullWidth/>
          </Grid>

          <Grid item xs={12}>
            <Stack direction="row" justifyContent="space-between" alignItems="center" sx={{mb:1}}>
              <Typography variant="subtitle2">å¿œæ´æ—¥æ™‚ï¼ˆè¤‡æ•°æ—¥ç™»éŒ²å¯èƒ½ï¼‰</Typography>
              <Button size="small" onClick={addSchedule} startIcon={<span className="material-icons">add</span>}>æ—¥æ™‚è¿½åŠ </Button>
            </Stack>
            <Paper variant="outlined" sx={{p:2}}>
              {schedules.map((sch, idx) => (
                <Grid container spacing={1} key={idx} sx={{mb:1}}>
                  <Grid item xs={12} sm={4}>
                    <TextField type="date" label="å¿œæ´æ—¥" InputLabelProps={{shrink:true}} value={sch.date} onChange={e=>updateSchedule(idx, {date:e.target.value})} fullWidth size="small"/>
                  </Grid>
                  <Grid item xs={5} sm={3}>
                    <TextField type="time" label="é–‹å§‹æ™‚åˆ»" InputLabelProps={{shrink:true}} value={sch.startTime} onChange={e=>updateSchedule(idx, {startTime:e.target.value})} fullWidth size="small"/>
                  </Grid>
                  <Grid item xs={5} sm={3}>
                    <TextField type="time" label="çµ‚äº†æ™‚åˆ»" InputLabelProps={{shrink:true}} value={sch.endTime} onChange={e=>updateSchedule(idx, {endTime:e.target.value})} fullWidth size="small"/>
                  </Grid>
                  <Grid item xs={2} sm={2}>
                    {schedules.length > 1 && (
                      <IconButton color="error" onClick={() => removeSchedule(idx)} size="small">
                        <span className="material-icons">delete</span>
                      </IconButton>
                    )}
                  </Grid>
                </Grid>
              ))}
            </Paper>
          </Grid>

          <Grid item xs={12}>
            <TextField label="ä¾é ¼å†…å®¹" value={content} onChange={e=>setContent(e.target.value)} fullWidth multiline rows={2}/>
          </Grid>
          <Grid item xs={12}>
            <TextField label="å‚™è€ƒ" value={memo} onChange={e=>setMemo(e.target.value)} fullWidth multiline rows={2}/>
          </Grid>
        </Grid>
      </DialogContent>
      <DialogActions>
        <Button onClick={onClose}>ã‚­ãƒ£ãƒ³ã‚»ãƒ«</Button>
        <Button onClick={save} variant="contained" disabled={!canSave}>ä½œæˆ</Button>
      </DialogActions>
    </Dialog>
  );
}

/* ===== è¦‹ç©ã‚‚ã‚Šãƒ€ã‚¤ã‚¢ãƒ­ã‚° ===== */
function EstimateDialog({open, onClose, item, onSubmit}) {
  const [amount, setAmount] = React.useState('');
  const [note, setNote] = React.useState('');
  const [agree, setAgree] = React.useState(false);
  const [supporters, setSupporters] = React.useState(
    item?.schedules?.map(s => ({date: s.date, startTime: s.startTime, endTime: s.endTime, name:'', transport:''})) || 
    [{date: '', startTime: '09:00', endTime: '18:00', name:'', transport:''}]
  );

  const addRow = () => setSupporters(prev => [...prev, {date:'', startTime:'09:00', endTime:'18:00', name:'', transport:''}]);
  const removeRow = (idx) => setSupporters(prev => prev.filter((_,i)=>i!==idx));
  const updateRow = (idx, patch) => setSupporters(prev => prev.map((r,i)=> i===idx ? {...r, ...patch} : r));

  const ok = amount && supporters.length>0 && supporters.every(s=>s.date && s.startTime && s.endTime && s.name) && agree;

  const submit = () => {
    onSubmit({amount, note, supporters});
  };

  return (
    <Dialog open={open} onClose={onClose} fullWidth maxWidth="md">
      <DialogTitle>è¦‹ç©ã‚‚ã‚Šç™»éŒ²</DialogTitle>
      <DialogContent dividers>
        <Paper variant="outlined" sx={{p:2, mb:2, bgcolor:'warning.light', color:'warning.contrastText'}}>
          <Typography variant="subtitle2" gutterBottom><strong>ç‹¬å ç¦æ­¢æ³• æ³¨æ„äº‹é …</strong></Typography>
          <Typography variant="body2">ä¾¡æ ¼ãƒ»è¦‹ç©é‡‘é¡ã‚’ä»–ç¤¾ã¨å…±åŒæ±ºå®šãƒ»æƒ…å ±äº¤æ›ã—ãªã„ã“ã¨ã€‚æœ¬è¦‹ç©ã‚Šã¯è‡ªç¤¾ã®ç‹¬ç«‹ã—ãŸåˆ¤æ–­ã«åŸºã¥ã„ã¦æç¤ºã—ã¦ãã ã•ã„ã€‚</Typography>
        </Paper>

        <Stack spacing={2}>
          <TextField label="è¦‹ç©é‡‘é¡ï¼ˆç¨æŠœï¼‰" placeholder="ä¾‹: 180000" value={amount} 
            onChange={e=>setAmount(e.target.value.replace(/[^\d]/g,''))} fullWidth/>
          <TextField label="è¦‹ç©ãƒ¡ãƒ¢" value={note} onChange={e=>setNote(e.target.value)} fullWidth/>
          
          <Box>
            <Stack direction="row" justifyContent="space-between" alignItems="center" sx={{mb:1}}>
              <Typography variant="subtitle2">å¿œæ´è€…ãƒªã‚¹ãƒˆ</Typography>
              <Button size="small" onClick={addRow} startIcon={<span className="material-icons">add</span>}>è¿½åŠ </Button>
            </Stack>
            {supporters.map((s, idx) => (
              <Paper key={idx} variant="outlined" sx={{p:1.5, mb:1}}>
                <Grid container spacing={1}>
                  <Grid item xs={12} sm={3}>
                    <TextField type="date" label="æ—¥ä»˜" InputLabelProps={{shrink:true}} value={s.date} onChange={e=>updateRow(idx,{date:e.target.value})} fullWidth size="small"/>
                  </Grid>
                  <Grid item xs={6} sm={2}>
                    <TextField type="time" label="é–‹å§‹" InputLabelProps={{shrink:true}} value={s.startTime} onChange={e=>updateRow(idx,{startTime:e.target.value})} fullWidth size="small"/>
                  </Grid>
                  <Grid item xs={6} sm={2}>
                    <TextField type="time" label="çµ‚äº†" InputLabelProps={{shrink:true}} value={s.endTime} onChange={e=>updateRow(idx,{endTime:e.target.value})} fullWidth size="small"/>
                  </Grid>
                  <Grid item xs={12} sm={2}>
                    <TextField label="æ°å" value={s.name} onChange={e=>updateRow(idx,{name:e.target.value})} fullWidth size="small"/>
                  </Grid>
                  <Grid item xs={10} sm={2}>
                    <TextField label="äº¤é€šè²»" value={s.transport} onChange={e=>updateRow(idx,{transport:e.target.value.replace(/[^\d]/g,'')})} fullWidth size="small"/>
                  </Grid>
                  <Grid item xs={2} sm={1}>
                    <IconButton color="error" onClick={()=>removeRow(idx)} size="small">
                      <span className="material-icons">delete</span>
                    </IconButton>
                  </Grid>
                </Grid>
              </Paper>
            ))}
          </Box>

          <FormControlLabel
            control={<Checkbox checked={agree} onChange={e=>setAgree(e.target.checked)}/>}
            label="ç‹¬å ç¦æ­¢æ³•ã®æ³¨æ„äº‹é …ã‚’èª­ã¿ã€éµå®ˆã®ã†ãˆè¦‹ç©ã‚Šã¾ã™"
          />
        </Stack>
      </DialogContent>
      <DialogActions>
        <Button onClick={onClose}>ã‚­ãƒ£ãƒ³ã‚»ãƒ«</Button>
        <Button variant="contained" disabled={!ok} onClick={submit}>è¦‹ç©ã‚‚ã‚Šç™»éŒ²</Button>
      </DialogActions>
    </Dialog>
  );
}

/* ===== è©³ç´°ãƒ€ã‚¤ã‚¢ãƒ­ã‚° ===== */
function DetailDialog({open, onClose, item, onNext, role, onEstimate}) {
  if (!item) return null;
  const statusObj = STATUSES.find(s => s.key === item.status);
  const ns = nextStatus(item.status);

  return (
    <Dialog open={open} onClose={onClose} fullWidth maxWidth="sm">
      <DialogTitle>
        ä¾é ¼è©³ç´°
        <Chip label={statusObj?.label} color={statusObj?.color} size="small" sx={{ml:1}}/>
      </DialogTitle>
      <DialogContent dividers>
        <Stack spacing={2}>
          <Box>
            <Typography variant="subtitle2" color="text.secondary">å–å¼•å…ˆ</Typography>
            <Typography variant="body1">{item.partner}ï¼ˆ{item.partnerCode}ï¼‰</Typography>
          </Box>
          <Box>
            <Typography variant="subtitle2" color="text.secondary">å¿œæ´åº—èˆ—</Typography>
            <Typography variant="body1">{item.store}</Typography>
          </Box>
          <Box>
            <Typography variant="subtitle2" color="text.secondary">å¿œæ´æ—¥æ™‚</Typography>
            {item.schedules?.map((sch, idx) => (
              <Typography variant="body1" key={idx}>{sch.date} {sch.startTime}ã€œ{sch.endTime}</Typography>
            ))}
          </Box>
          <Box>
            <Typography variant="subtitle2" color="text.secondary">äººæ•°ãƒ»éƒ¨é–€</Typography>
            <Typography variant="body1">{item.heads}å / {item.department}</Typography>
          </Box>
          <Box>
            <Typography variant="subtitle2" color="text.secondary">ä¾é ¼å†…å®¹</Typography>
            <Typography variant="body1">{item.content}</Typography>
          </Box>
          {item.memo && (
            <Box>
              <Typography variant="subtitle2" color="text.secondary">å‚™è€ƒ</Typography>
              <Typography variant="body1">{item.memo}</Typography>
            </Box>
          )}
          {item.estimate && (
            <Box>
              <Typography variant="subtitle2" color="text.secondary">è¦‹ç©é‡‘é¡</Typography>
              <Typography variant="body1">{yen(item.estimate.amount)}</Typography>
            </Box>
          )}
        </Stack>
      </DialogContent>
      <DialogActions>
        <Button onClick={onClose}>é–‰ã˜ã‚‹</Button>
        {role === 'å–å¼•å…ˆ' && item.status === 'estimate' && (
          <Button variant="contained" onClick={onEstimate}>è¦‹ç©ã‚‚ã‚Šç™»éŒ²</Button>
        )}
        {ns && role === 'è‡ªç¤¾' && item.status !== 'estimate' && (
          <Button variant="contained" onClick={onNext}>æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã¸</Button>
        )}
      </DialogActions>
    </Dialog>
  );
}

/* ===== ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åˆ¥ã‚µãƒ³ãƒ—ãƒ«è¿½åŠ ãƒ€ã‚¤ã‚¢ãƒ­ã‚° ===== */
function AddSampleDialog({open, onClose, onAdd}) {
  const [status, setStatus] = React.useState('request');
  
  const handleAdd = () => {
    onAdd(status);
    onClose();
  };

  return (
    <Dialog open={open} onClose={onClose} maxWidth="xs" fullWidth>
      <DialogTitle>ã‚µãƒ³ãƒ—ãƒ«è¿½åŠ </DialogTitle>
      <DialogContent>
        <FormControl fullWidth sx={{mt:1}}>
          <InputLabel>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</InputLabel>
          <Select label="ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹" value={status} onChange={e=>setStatus(e.target.value)}>
            {STATUSES.map(s => (
              <MenuItem key={s.key} value={s.key}>{s.label}</MenuItem>
            ))}
          </Select>
        </FormControl>
      </DialogContent>
      <DialogActions>
        <Button onClick={onClose}>ã‚­ãƒ£ãƒ³ã‚»ãƒ«</Button>
        <Button variant="contained" onClick={handleAdd}>è¿½åŠ </Button>
      </DialogActions>
    </Dialog>
  );
}

/* ===== ãƒ¡ã‚¤ãƒ³App ===== */
function App() {
  const prefersDark = useMediaQuery('(prefers-color-scheme: dark)');
  const [dark, setDark] = React.useState(prefersDark);
  const theme = React.useMemo(() => createTheme({palette:{mode: dark?'dark':'light'}}), [dark]);

  const [role, setRole] = React.useState('è‡ªç¤¾');
  const [items, setItems] = React.useState(() => Array.from({length:5}, () => makeDummyItem()));
  const [filter, setFilter] = React.useState('all');
  const [search, setSearch] = React.useState('');
  const [dlgCreate, setDlgCreate] = React.useState(false);
  const [dlgSample, setDlgSample] = React.useState(false);
  const [detail, setDetail] = React.useState(null);
  const [estimateTarget, setEstimateTarget] = React.useState(null);
  const [snack, setSnack] = React.useState(null);
  const [selected, setSelected] = React.useState([]);
  const [autoGen, setAutoGen] = React.useState(true);
  const [page, setPage] = React.useState(0);
  const [rowsPerPage, setRowsPerPage] = React.useState(25);
  const [helpOpen, setHelpOpen] = React.useState(false);
  const [orderBy, setOrderBy] = React.useState('createdAt');
  const [order, setOrder] = React.useState('desc');
  const [columnWidths, setColumnWidths] = React.useState({});

  // è‡ªå‹•ã‚µãƒ³ãƒ—ãƒ«ç”Ÿæˆ
  const genRef = React.useRef(null);
  React.useEffect(() => {
    if (!autoGen) {
      if (genRef.current) {
        clearInterval(genRef.current);
        genRef.current = null;
      }
      return;
    }
    if (genRef.current) return;
    genRef.current = setInterval(() => {
      setItems(prev => [makeDummyItem(), ...prev].slice(0, 100));
    }, randInt(8000, 15000));
    return () => {
      if (genRef.current) {
        clearInterval(genRef.current);
        genRef.current = null;
      }
    };
  }, [autoGen]);

  const handleSort = (property) => {
    const isAsc = orderBy === property && order === 'asc';
    setOrder(isAsc ? 'desc' : 'asc');
    setOrderBy(property);
  };

  const getComparator = (order, orderBy) => {
    return order === 'desc'
      ? (a, b) => descendingComparator(a, b, orderBy)
      : (a, b) => -descendingComparator(a, b, orderBy);
  };

  const descendingComparator = (a, b, orderBy) => {
    let aVal = a[orderBy];
    let bVal = b[orderBy];
    
    if (orderBy === 'schedules') {
      aVal = a.schedules?.[0]?.date || '';
      bVal = b.schedules?.[0]?.date || '';
    }
    
    if (bVal < aVal) return -1;
    if (bVal > aVal) return 1;
    return 0;
  };

  const filtered = React.useMemo(() => {
    return items
      .filter(i => filter === 'all' || i.status === filter)
      .filter(i => {
        const text = `${i.title}${i.partner}${i.partnerCode}${i.store}${i.department}${i.content}`.toLowerCase();
        return text.includes(search.toLowerCase());
      })
      .sort(getComparator(order, orderBy));
  }, [items, filter, search, order, orderBy]);

  const paged = filtered.slice(page * rowsPerPage, page * rowsPerPage + rowsPerPage);
  const pendingCount = items.filter(i => i.status === 'invoice_wait').length;

  const createItem = (data) => {
    setItems(prev => [data, ...prev]);
    setDlgCreate(false);
    setSnack({severity:'success', msg:'ä¾é ¼ã‚’ä½œæˆã—ã¾ã—ãŸ'});
  };

  const addSample = (status) => {
    setItems(prev => [makeDummyItem(status), ...prev]);
    setSnack({severity:'info', msg:`${STATUSES.find(s=>s.key===status)?.label} ã®ã‚µãƒ³ãƒ—ãƒ«ã‚’è¿½åŠ ã—ã¾ã—ãŸ`});
  };

  const advance = (id) => {
    setItems(prev => prev.map(i => {
      if (i.id !== id) return i;
      const ns = nextStatus(i.status);
      if (!ns) return i;
      return {
        ...i,
        status: ns,
        confirmedAt: ns === 'confirmed' && !i.confirmedAt ? new Date().toISOString() : i.confirmedAt
      };
    }));
    setDetail(null);
    setSnack({severity:'info', msg:'ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ›´æ–°ã—ã¾ã—ãŸ'});
  };

  const submitEstimate = (id, payload) => {
    setItems(prev => prev.map(i => {
      if (i.id !== id) return i;
      return {
        ...i,
        status: 'confirmed',
        confirmedAt: new Date().toISOString(),
        estimate: {
          amount: Number(payload.amount),
          note: payload.note,
          supporters: payload.supporters
        },
        heads: payload.supporters.length
      };
    }));
    setEstimateTarget(null);
    setDetail(null);
    setSnack({severity:'success', msg:'è¦‹ç©ã‚‚ã‚Šã‚’ç™»éŒ²ã—ã¾ã—ãŸ'});
  };

  const handleSelectAll = (e) => {
    if (e.target.checked) {
      setSelected(filtered.map(i => i.id));
    } else {
      setSelected([]);
    }
  };

  const handleSelect = (id) => {
    if (selected.includes(id)) {
      setSelected(selected.filter(x => x !== id));
    } else {
      setSelected([...selected, id]);
    }
  };

  const handleResize = (columnKey, delta) => {
    setColumnWidths(prev => ({
      ...prev,
      [columnKey]: Math.max(50, (prev[columnKey] || 100) + delta)
    }));
  };

  const ResizableCell = ({children, columnKey, ...props}) => {
    const [isResizing, setIsResizing] = React.useState(false);
    const startX = React.useRef(0);

    const handleMouseDown = (e) => {
      setIsResizing(true);
      startX.current = e.clientX;
      e.preventDefault();
    };

    React.useEffect(() => {
      if (!isResizing) return;

      const handleMouseMove = (e) => {
        const delta = e.clientX - startX.current;
        handleResize(columnKey, delta);
        startX.current = e.clientX;
      };

      const handleMouseUp = () => {
        setIsResizing(false);
      };

      document.addEventListener('mousemove', handleMouseMove);
      document.addEventListener('mouseup', handleMouseUp);

      return () => {
        document.removeEventListener('mousemove', handleMouseMove);
        document.removeEventListener('mouseup', handleMouseUp);
      };
    }, [isResizing]);

    return (
      <TableCell 
        {...props} 
        sx={{
          ...props.sx,
          width: columnWidths[columnKey] || 'auto',
          minWidth: columnWidths[columnKey] || 'auto',
          position: 'relative'
        }}
        className="resizable"
      >
        {children}
        <div 
          className="resizer" 
          onMouseDown={handleMouseDown}
          style={{cursor: isResizing ? 'col-resize' : 'col-resize'}}
        />
      </TableCell>
    );
  };

  return (
    <ThemeProvider theme={theme}>
      <CssBaseline/>
      <Header 
        role={role} 
        setRole={setRole} 
        onNew={()=>setDlgCreate(true)} 
        dark={dark} 
        toggleDark={()=>setDark(v=>!v)} 
        count={pendingCount}
        onHelp={()=>setHelpOpen(v=>!v)}
      />
      
      <Container maxWidth={false} sx={{py:3}}>
        <HelpPanel open={helpOpen} />

        {/* æ¤œç´¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ */}
        <Paper sx={{p:2, mb:2}}>
          <Stack spacing={2}>
            <TextField
              placeholder="æ¤œç´¢ï¼ˆå–å¼•å…ˆã€åº—èˆ—ã€æ—¥ä»˜ã€éƒ¨é–€ã€å†…å®¹...ï¼‰"
              value={search}
              onChange={e=>setSearch(e.target.value)}
              fullWidth
              InputProps={{
                startAdornment: <span className="material-icons" style={{marginRight:8, color:'gray'}}>search</span>
              }}
            />
            <Stack direction="row" spacing={1} flexWrap="wrap">
              <Button variant={filter==='all'?'contained':'outlined'} onClick={()=>setFilter('all')}>
                ã™ã¹ã¦ ({items.length})
              </Button>
              {STATUSES.map(s => (
                <Button key={s.key} variant={filter===s.key?'contained':'outlined'} onClick={()=>setFilter(s.key)}>
                  {s.label} ({items.filter(i=>i.status===s.key).length})
                </Button>
              ))}
            </Stack>
          </Stack>
        </Paper>

        {/* çµ±è¨ˆæƒ…å ± */}
        <Paper sx={{p:2, mb:2}}>
          <Stack direction={{xs:'column', sm:'row'}} spacing={2}>
            <Box sx={{flex:1}}>
              <Typography variant="h4" color="primary">{items.length}</Typography>
              <Typography variant="body2" color="text.secondary">ç·ä»¶æ•°</Typography>
            </Box>
            <Box sx={{flex:1}}>
              <Typography variant="h4" color="warning.main">{items.filter(i=>['supporter_check','finalize'].includes(i.status)).length}</Typography>
              <Typography variant="body2" color="text.secondary">å½“æ—¥é€²è¡Œä¸­</Typography>
            </Box>
            <Box sx={{flex:1}}>
              <Typography variant="h4" color="success.main">{pendingCount}</Typography>
              <Typography variant="body2" color="text.secondary">è«‹æ±‚å¾…ã¡</Typography>
            </Box>
            <Box sx={{flex:1, display:'flex', flexDirection:'column', gap:1}}>
              <Stack direction="row" spacing={1}>
                <Button variant="outlined" size="small" onClick={()=>setDlgSample(true)} startIcon={<span className="material-icons">add</span>}>
                  ã‚µãƒ³ãƒ—ãƒ«è¿½åŠ 
                </Button>
                <Button variant="outlined" size="small" color="error" onClick={()=>{setItems([]); setSelected([]);}}>
                  å…¨å‰Šé™¤
                </Button>
              </Stack>
              <FormControlLabel
                control={<Checkbox checked={autoGen} onChange={e=>setAutoGen(e.target.checked)} size="small"/>}
                label={<Typography variant="caption">è‡ªå‹•ç”Ÿæˆ</Typography>}
              />
            </Box>
          </Stack>
        </Paper>

        {/* ãƒ†ãƒ¼ãƒ–ãƒ« */}
        <Paper sx={{mb:2}}>
          <Box sx={{p:2, display:'flex', justifyContent:'space-between', alignItems:'center'}}>
            <Typography variant="h6">ä¾é ¼ä¸€è¦§ï¼ˆ{filtered.length}ä»¶ï¼‰</Typography>
            <Stack direction="row" spacing={1}>
              <Typography variant="body2" color="text.secondary" sx={{alignSelf:'center'}}>
                {selected.length}ä»¶é¸æŠä¸­
              </Typography>
              <Button
                variant="contained"
                startIcon={<span className="material-icons">download</span>}
                onClick={() => exportCSV(filtered)}
                disabled={filtered.length === 0}
              >
                CSVå‡ºåŠ›
              </Button>
            </Stack>
          </Box>
          <TableContainer sx={{maxHeight: 600}}>
            <Table stickyHeader size="small">
              <TableHead>
                <TableRow>
                  <ResizableCell padding="checkbox" columnKey="checkbox" sx={{bgcolor:'grey.100'}}>
                    <Checkbox
                      checked={filtered.length > 0 && selected.length === filtered.length}
                      indeterminate={selected.length > 0 && selected.length < filtered.length}
                      onChange={handleSelectAll}
                    />
                  </ResizableCell>
                  <ResizableCell columnKey="no" sx={{bgcolor:'grey.100'}}>
                    <TableSortLabel
                      active={orderBy === 'id'}
                      direction={orderBy === 'id' ? order : 'asc'}
                      onClick={() => handleSort('id')}
                    >
                      No
                    </TableSortLabel>
                  </ResizableCell>
                  <ResizableCell columnKey="status" sx={{bgcolor:'grey.100'}}>
                    <TableSortLabel
                      active={orderBy === 'status'}
                      direction={orderBy === 'status' ? order : 'asc'}
                      onClick={() => handleSort('status')}
                    >
                      ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
                    </TableSortLabel>
                  </ResizableCell>
                  <ResizableCell columnKey="date" sx={{bgcolor:'grey.100'}}>
                    <TableSortLabel
                      active={orderBy === 'schedules'}
                      direction={orderBy === 'schedules' ? order : 'asc'}
                      onClick={() => handleSort('schedules')}
                    >
                      å¿œæ´æ—¥
                    </TableSortLabel>
                  </ResizableCell>
                  <ResizableCell columnKey="startTime" sx={{bgcolor:'grey.100'}}>é–‹å§‹æ™‚åˆ»</ResizableCell>
                  <ResizableCell columnKey="endTime" sx={{bgcolor:'grey.100'}}>çµ‚äº†æ™‚åˆ»</ResizableCell>
                  <ResizableCell columnKey="heads" sx={{bgcolor:'grey.100'}}>
                    <TableSortLabel
                      active={orderBy === 'heads'}
                      direction={orderBy === 'heads' ? order : 'asc'}
                      onClick={() => handleSort('heads')}
                    >
                      äººæ•°
                    </TableSortLabel>
                  </ResizableCell>
                  <ResizableCell columnKey="department" sx={{bgcolor:'grey.100'}}>
                    <TableSortLabel
                      active={orderBy === 'department'}
                      direction={orderBy === 'department' ? order : 'asc'}
                      onClick={() => handleSort('department')}
                    >
                      éƒ¨é–€
                    </TableSortLabel>
                  </ResizableCell>
                  <ResizableCell columnKey="partnerCode" sx={{bgcolor:'grey.100'}}>
                    <TableSortLabel
                      active={orderBy === 'partnerCode'}
                      direction={orderBy === 'partnerCode' ? order : 'asc'}
                      onClick={() => handleSort('partnerCode')}
                    >
                      å–å¼•å…ˆã‚³ãƒ¼ãƒ‰
                    </TableSortLabel>
                  </ResizableCell>
                  <ResizableCell columnKey="partner" sx={{bgcolor:'grey.100'}}>
                    <TableSortLabel
                      active={orderBy === 'partner'}
                      direction={orderBy === 'partner' ? order : 'asc'}
                      onClick={() => handleSort('partner')}
                    >
                      å–å¼•å…ˆå
                    </TableSortLabel>
                  </ResizableCell>
                  <ResizableCell columnKey="store" sx={{bgcolor:'grey.100'}}>
                    <TableSortLabel
                      active={orderBy === 'store'}
                      direction={orderBy === 'store' ? order : 'asc'}
                      onClick={() => handleSort('store')}
                    >
                      å¿œæ´åº—èˆ—
                    </TableSortLabel>
                  </ResizableCell>
                  <ResizableCell columnKey="createdAt" sx={{bgcolor:'grey.100'}}>
                    <TableSortLabel
                      active={orderBy === 'createdAt'}
                      direction={orderBy === 'createdAt' ? order : 'asc'}
                      onClick={() => handleSort('createdAt')}
                    >
                      ä¾é ¼æ—¥
                    </TableSortLabel>
                  </ResizableCell>
                  <ResizableCell columnKey="confirmedAt" sx={{bgcolor:'grey.100'}}>
                    <TableSortLabel
                      active={orderBy === 'confirmedAt'}
                      direction={orderBy === 'confirmedAt' ? order : 'asc'}
                      onClick={() => handleSort('confirmedAt')}
                    >
                      ç¢ºå®šæ—¥
                    </TableSortLabel>
                  </ResizableCell>
                  <ResizableCell columnKey="estimate" sx={{bgcolor:'grey.100'}}>è¦‹ç©é‡‘é¡</ResizableCell>
                  <ResizableCell columnKey="action" sx={{bgcolor:'grey.100'}}>æ“ä½œ</ResizableCell>
                </TableRow>
              </TableHead>
              <TableBody>
                {paged.map((item, idx) => (
                  <TableRow key={item.id} hover>
                    <TableCell padding="checkbox">
                      <Checkbox
                        checked={selected.includes(item.id)}
                        onChange={() => handleSelect(item.id)}
                      />
                    </TableCell>
                    <TableCell>{page * rowsPerPage + idx + 1}</TableCell>
                    <TableCell>
                      <Chip label={STATUSES.find(s=>s.key===item.status)?.label} color={STATUSES.find(s=>s.key===item.status)?.color} size="small"/>
                    </TableCell>
                    <TableCell>{item.schedules?.map(s => s.date).join('ã€')}</TableCell>
                    <TableCell>{item.schedules?.[0]?.startTime || 'â€”'}</TableCell>
                    <TableCell>{item.schedules?.[0]?.endTime || 'â€”'}</TableCell>
                    <TableCell>{item.heads}</TableCell>
                    <TableCell>{item.department}</TableCell>
                    <TableCell className="mono">{item.partnerCode}</TableCell>
                    <TableCell>{item.partner}</TableCell>
                    <TableCell>{item.store}</TableCell>
                    <TableCell>{fmtDate(item.createdAt)}</TableCell>
                    <TableCell>{fmtDate(item.confirmedAt)}</TableCell>
                    <TableCell>{item.estimate ? yen(item.estimate.amount) : 'â€”'}</TableCell>
                    <TableCell>
                      <Button size="small" onClick={()=>setDetail(item)}>è©³ç´°</Button>
                    </TableCell>
                  </TableRow>
                ))}
              </TableBody>
            </Table>
          </TableContainer>
          <Box component="div" sx={{display:'flex', justifyContent:'flex-end'}}>
            <Stack direction="row" spacing={1} alignItems="center" sx={{py:1, px:2}}>
              <Typography variant="body2">ãƒšãƒ¼ã‚¸ã‚ãŸã‚Šã®è¡Œæ•°:</Typography>
              <Select
                value={rowsPerPage}
                onChange={(e) => { setRowsPerPage(Number(e.target.value)); setPage(0); }}
                size="small"
                sx={{minWidth:80}}
              >
                <MenuItem value={10}>10</MenuItem>
                <MenuItem value={25}>25</MenuItem>
                <MenuItem value={50}>50</MenuItem>
                <MenuItem value={100}>100</MenuItem>
              </Select>
              <Typography variant="body2" sx={{ml:2}}>
                {filtered.length === 0 ? '0ä»¶' : `${page * rowsPerPage + 1}â€“${Math.min((page + 1) * rowsPerPage, filtered.length)} / ${filtered.length}ä»¶`}
              </Typography>
              <IconButton
                onClick={() => setPage(p => Math.max(0, p - 1))}
                disabled={page === 0}
                size="small"
              >
                <span className="material-icons">chevron_left</span>
              </IconButton>
              <IconButton
                onClick={() => setPage(p => Math.min(Math.ceil(filtered.length / rowsPerPage) - 1, p + 1))}
                disabled={page >= Math.ceil(filtered.length / rowsPerPage) - 1}
                size="small"
              >
                <span className="material-icons">chevron_right</span>
              </IconButton>
            </Stack>
          </Box>
        </Paper>
      </Container>

      <CreateDialog open={dlgCreate} onClose={()=>setDlgCreate(false)} onCreate={createItem}/>
      <AddSampleDialog open={dlgSample} onClose={()=>setDlgSample(false)} onAdd={addSample}/>
      <DetailDialog
        open={!!detail}
        onClose={()=>setDetail(null)}
        item={detail}
        role={role}
        onNext={()=>advance(detail.id)}
        onEstimate={()=>setEstimateTarget(detail)}
      />
      <EstimateDialog
        open={!!estimateTarget}
        onClose={()=>setEstimateTarget(null)}
        item={estimateTarget}
        onSubmit={(payload)=>submitEstimate(estimateTarget.id, payload)}
      />
      <Snackbar open={!!snack} autoHideDuration={3000} onClose={()=>setSnack(null)} anchorOrigin={{vertical:'bottom', horizontal:'center'}}>
        {snack && <Alert severity={snack.severity} onClose={()=>setSnack(null)} variant="filled">{snack.msg}</Alert>}
      </Snackbar>
    </ThemeProvider>
  );
}

const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(<App/>);
</script>
</body>
</html>