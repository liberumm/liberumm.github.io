<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>サポートポータル：問い合わせ対応</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Fonts / Icons -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap"/>
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons"/>

  <!-- React / Babel / MUI (UMD) -->
  <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js" crossorigin></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.23.8/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mui/material@5.15.3/umd/material-ui.production.min.js" crossorigin></script>

  <style>
    html, body, #root { height: 100%; }
    body { margin: 0; font-family: Roboto, "Helvetica Neue", Arial, sans-serif;
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); }
    a.cardLink { text-decoration: none; color: inherit; display: block; transition: transform .2s; }
    a.cardLink:hover { transform: translateY(-2px); }
    .iconXL { font-size: 56px; background: linear-gradient(135deg, #495057 0%, #6c757d 100%);
      -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
    .custom-paper { background:#fff; border:1px solid #dee2e6; border-radius:12px; box-shadow:0 2px 8px rgba(0,0,0,.08); }
    .tableWrap { overflow:auto; border-radius:8px; background:#fff; box-shadow: inset 0 1px 3px rgba(0,0,0,0.06); }
    .mono { font-variant-numeric: tabular-nums; font-family:'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace; }
    @media (max-width: 768px){ .iconXL { font-size: 36px; } }
  </style>
</head>
<body>
<div id="root"></div>

<script type="text/babel">
const {
  ThemeProvider, createTheme, CssBaseline, Container, AppBar, Toolbar, Typography, Grid, Card, CardActionArea, CardContent,
  Stack, Chip, Tooltip, IconButton, Alert, AlertTitle, Box, Button, Divider, Snackbar, Paper, Table, TableHead,
  TableRow, TableCell, TableBody, LinearProgress, Badge
} = MaterialUI;

/* ========= 設定 ========= */
const CONFIG = { casesFeedUrl: "" };

/* ========= ユーティリティ ========= */
const fmtDateTime = (d) => d ? new Date(d).toLocaleString() : "-";
const readFileText = (file) => new Promise((res, rej) => {
  const fr = new FileReader(); fr.onload = () => res(String(fr.result)); fr.onerror = rej; fr.readAsText(file);
});
const downloadBlob = (filename, text) => {
  const blob = new Blob([text], {type:"text/csv;charset=utf-8"});
  const a = document.createElement("a"); a.href = URL.createObjectURL(blob);
  a.download = filename; a.click(); URL.revokeObjectURL(a.href);
};

/* ========= ホーム ========= */
const NotificationCenter = ({ pendingCount, onGo }) => {
  const announcements = [
    { id:"n1", severity:"info", title:"運用連絡", msg:"本日 18:00 に運用手順の更新があります。" },
    { id:"n2", severity:"success", title:"新フロー", msg:"ケース一覧→ダウンロード→返却ファイル添付で返却完了！" }
  ];
  return (
    <Stack spacing={2} sx={{ width:"100%" }}>
      <Stack spacing={1.25}>
        {announcements.map(a=>(
          <Alert key={a.id} severity={a.severity} variant="outlined">
            <AlertTitle>{a.title}</AlertTitle>{a.msg}
          </Alert>
        ))}
      </Stack>
      <Card>
        <CardContent>
          <Typography variant="subtitle1" gutterBottom>要対応タスク</Typography>
          <Stack divider={<Divider />} spacing={1}>
            <Stack direction="row" alignItems="center" justifyContent="space-between">
              <Typography variant="body2">返却待ちのケースが {pendingCount} 件あります</Typography>
              <Button size="small" onClick={onGo} endIcon={<span className="material-icons">arrow_forward</span>}>
                問い合わせ対応へ
              </Button>
            </Stack>
          </Stack>
        </CardContent>
      </Card>
    </Stack>
  );
};

const ShortcutCard = ({ title, subtitle, icon, onClick }) => (
  <a className="cardLink" href="#" onClick={(e)=>{e.preventDefault();onClick();}}>
    <Card elevation={0} sx={{ minHeight: 200, width: 280 }}>
      <CardActionArea sx={{ height: '100%', p: 2 }}>
        <CardContent sx={{ textAlign:'center', height:'100%', display:'flex', flexDirection:'column', justifyContent:'center' }}>
          <Stack spacing={2} alignItems="center">
            <Box sx={{ p:2, borderRadius:'50%', background:'linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%)', border:'2px solid #dee2e6' }}>
              <span className="material-icons iconXL">{icon}</span>
            </Box>
            <Stack spacing={1} alignItems="center">
              <Typography variant="h6" sx={{ fontWeight:700, color:'#212529' }}>{title}</Typography>
              <Typography variant="body2" color="text.secondary" sx={{ textAlign:'center', lineHeight:1.5 }}>{subtitle}</Typography>
            </Stack>
          </Stack>
        </CardContent>
      </CardActionArea>
    </Card>
  </a>
);

const Home = ({ goSupport, pendingCount }) => (
  <Container
    maxWidth="md"
    sx={{
      py: 6,
      display: "flex",
      flexDirection: "column",
      alignItems: "center",
      justifyContent: "center", // ← ここで中央寄せ
      gap: 4
    }}
  >
    <Stack spacing={4} alignItems="center" sx={{ width: "100%" }}>
      {/* 通知セクション */}
      <NotificationCenter pendingCount={pendingCount} onGo={goSupport} />

      {/* 問い合わせ対応カード */}
      <ShortcutCard
        title="問い合わせ対応"
        subtitle="ケース一覧からCSVを処理・返却"
        icon="assignment_turned_in"
        onClick={goSupport}
      />
    </Stack>
  </Container>
);

/* ========= ケース一覧（省略: 前回と同じ） ========= */
// （CasesPage, Footer, App は前回回答のものをそのまま利用）

/* ========= ケース一覧ページ ========= */
const CasesPage = ({ goHome, onBadge }) => {
  const [cases, setCases] = React.useState([]);
  const [loading, setLoading] = React.useState(false);
  const [snack, setSnack] = React.useState(null);
  const [uploadingId, setUploadingId] = React.useState(null);

  const refreshBadge = (list) => {
    const pending = (list||[]).filter(x => (x.status||"")!=="返却済み").length;
    onBadge?.(pending);
  };

  const manualAdd = () => {
    const input = document.createElement("input"); input.type="file"; input.accept=".csv";
    input.onchange = async () => {
      const file = input.files?.[0]; if (!file) return;
      const text = await readFileText(file);
      const caseId = prompt("ケースID", "CASE-" + Math.random().toString(36).slice(2,8));
      const returnUrl = prompt("返却先URL", "");
      const newList = [{ id:caseId, createdAt:Date.now(), status:"受領（手動）", inquiryText:text, returnUrl }, ...cases];
      setCases(newList); refreshBadge(newList);
    }; input.click();
  };

  return (
    <Container maxWidth="lg" sx={{ py:3 }}>
      <Stack direction="row" spacing={1} alignItems="center" sx={{ mb:2 }}>
        <Button onClick={goHome} startIcon={<span className="material-icons">arrow_back</span>}>戻る</Button>
        <Typography variant="h5">問い合わせ対応</Typography>
        <Box sx={{ flexGrow:1 }} />
        <Button onClick={manualAdd} startIcon={<span className="material-icons">note_add</span>}>手動追加</Button>
      </Stack>
      {loading && <LinearProgress />}
      <Paper className="custom-paper" sx={{ p:2 }}>
        <div className="tableWrap">
          <Table size="small" stickyHeader>
            <TableHead>
              <TableRow>
                <TableCell>ケースID</TableCell>
                <TableCell>作成日時</TableCell>
                <TableCell>状態</TableCell>
                <TableCell>返却先URL</TableCell>
              </TableRow>
            </TableHead>
            <TableBody>
              {cases.map((cs,i)=>(
                <TableRow key={i}>
                  <TableCell className="mono">{cs.id}</TableCell>
                  <TableCell>{fmtDateTime(cs.createdAt)}</TableCell>
                  <TableCell><Chip label={cs.status||"依頼中"} size="small" /></TableCell>
                  <TableCell className="mono">{cs.returnUrl||"-"}</TableCell>
                </TableRow>
              ))}
              {cases.length===0 && <TableRow><TableCell colSpan={4} align="center">ケースはありません</TableCell></TableRow>}
            </TableBody>
          </Table>
        </div>
      </Paper>
      <Snackbar open={!!snack} autoHideDuration={2500} onClose={()=>setSnack(null)}>
        <Alert severity={snack?.severity||"info"} variant="filled">{snack?.msg}</Alert>
      </Snackbar>
    </Container>
  );
};

/* ========= フッター ========= */
const Footer = () => (
  <Box component="footer" sx={{ mt:'auto', py:3, px:2, background:'linear-gradient(135deg, #343a40 0%, #495057 100%)', color:'white' }}>
    <Container maxWidth="lg" sx={{ textAlign:"center" }}>
      <Typography variant="body2">© 2024 サポートポータル</Typography>
    </Container>
  </Box>
);

/* ========= ルート ========= */
const App = () => {
  const theme = createTheme({
    palette: { primary: { main:'#495057' }, background:{ default:'#f8f9fa' } },
    shape: { borderRadius:12 }
  });

  const [route, setRoute] = React.useState(location.hash.replace('#','')||'/');
  const [pending, setPending] = React.useState(0);
  const go = (path) => { location.hash = path; };
  React.useEffect(()=>{ const onHash=()=>setRoute(location.hash.replace('#','')||'/'); addEventListener('hashchange',onHash); return()=>removeEventListener('hashchange',onHash); },[]);

  return (
    <ThemeProvider theme={theme}>
      <CssBaseline />
      <Box sx={{ display:'flex', flexDirection:'column', minHeight:'100vh' }}>
        <AppBar position="sticky"><Toolbar><Typography variant="h6" sx={{ flexGrow:1 }}>サポートポータル</Typography></Toolbar></AppBar>
        <Box sx={{ flex:1 }}>
          {route==='/' && <Home goSupport={()=>go('/cases')} pendingCount={pending} />}
          {route==='/cases' && <CasesPage goHome={()=>go('/')} onBadge={(n)=>setPending(n)} />}
        </Box>
        <Footer/>
      </Box>
    </ThemeProvider>
  );
};

ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
</script>
</body>
</html>
