<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>業務向けコンパクト：MUI×FullCalendar（CDN）</title>

  <!-- Roboto & MUI Icons -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap"/>
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">

  <!-- React, ReactDOM, Babel -->
  <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js" crossorigin></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.23.8/babel.min.js"></script>

  <!-- Emotion (MUI依存) -->
  <script src="https://cdn.jsdelivr.net/npm/@emotion/react@11.11.3/dist/emotion-react.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@emotion/styled@11.11.0/dist/emotion-styled.umd.min.js"></script>

  <!-- MUI Core -->
  <script src="https://cdn.jsdelivr.net/npm/@mui/material@5.15.3/umd/material-ui.production.min.js" crossorigin></script>

  <!-- FullCalendar (CDN / Global build) -->
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/main.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/locales-all.global.min.js"></script>

  <style>
    body { margin: 0; font-family: Roboto, -apple-system, BlinkMacSystemFont, "Segoe UI", "Hiragino Kaku Gothic ProN","Hiragino Sans", Meiryo, Arial, sans-serif; }
    /* FullCalendar 見栄え */
    .fc-event { border-radius: 10px; border: none; padding: 2px 6px; font-weight: 600; }
    .fc-event.status-confirmed { background: #059669; } /* success.main */
    .fc-event.status-pending  { background: #d97706; } /* warning.main */
    .fc-daygrid-day-frame { min-height: 96px; }
  </style>
</head>
<body>
<div id="root"></div>

<script type="text/babel">
const { useState, useMemo, useEffect, useRef } = React;
const {
  createTheme, ThemeProvider, CssBaseline, Container, Box, Paper, Stack, Typography,
  Chip, Tooltip, IconButton, ToggleButtonGroup, ToggleButton, Divider
} = MaterialUI;

/* ===== データ ===== */
const initialEvents = [
  { date:"2025-09-02", type:"スケジュール", title:"全社会議",         status:"確定" },
  { date:"2025-09-03", type:"スケジュール", title:"朝会（営業）",     status:"確定" },
  { date:"2025-09-03", type:"案件",         title:"A社 キックオフ",   status:"未確定" },
  { date:"2025-09-04", type:"タスク",       title:"仕様書レビュー",   status:"確定" },
  { date:"2025-09-05", type:"案件",         title:"B社 見積提出",     status:"確定" },
  { date:"2025-09-08", type:"タスク",       title:"UIモック作成",     status:"未確定" },
  { date:"2025-09-11", type:"スケジュール", title:"部内1on1",         status:"未確定" },
  { date:"2025-09-15", type:"案件",         title:"契約ドラフト合意", status:"確定" },
  { date:"2025-09-18", type:"タスク",       title:"テスト項目作成",   status:"確定" },
  { date:"2025-09-22", type:"案件",         title:"C社 要件確定",     status:"未確定" },
  { date:"2025-09-25", type:"スケジュール", title:"顧客訪問（D社）",   status:"確定" },
  { date:"2025-09-27", type:"タスク",       title:"資料最終チェック", status:"未確定" },
  { date:"2025-10-01", type:"スケジュール", title:"翌月キックオフ",   status:"確定" }
];

const TYPES  = ["スケジュール","タスク","案件"];
const STATUS = ["全て","未確定","確定"];

/* ===== テーマ ===== */
const theme = createTheme({
  palette: {
    mode: 'light',
    primary: { main: '#2563eb' },
    success: { main: '#059669' },
    warning: { main: '#d97706' },
    background: { default: '#f6f8ff', paper: '#fff' },
    divider: '#e5e7eb',
    text: { secondary: '#6b7280' }
  },
  shape: { borderRadius: 12 },
  components: {
    MuiPaper: { styleOverrides: { root: { boxShadow: '0 8px 24px rgba(15,23,42,.06)' } } }
  }
});

/* ===== カテゴリ：小型チップ＋件数＋マスター切替 ===== */
function CategoryCompact({ categoryOn, countsByType, onToggleAll, onToggleOne }) {
  const allOn = TYPES.every(t => categoryOn[t]);
  return (
    <Stack direction="row" alignItems="center" spacing={0.75} flexWrap="wrap">
      <Typography variant="subtitle2" sx={{ fontWeight: 900, mr: .25 }}>カテゴリ</Typography>
      {TYPES.map(type => {
        const selected = categoryOn[type];
        const count = countsByType[type] ?? 0;
        return (
          <Chip
            key={type}
            size="small"
            variant={selected ? "filled" : "outlined"}
            color={selected ? "primary" : "default"}
            onClick={() => onToggleOne(type)}
            icon={<span className="material-icons" style={{fontSize:16}}>category</span>}
            label={`${type} (${count})`}
            sx={{ fontWeight: 700 }}
          />
        );
      })}
      <Tooltip title={allOn ? '全解除' : '全選択'}>
        <IconButton size="small" onClick={onToggleAll} sx={{ ml: .25 }}>
          <span className="material-icons">{allOn ? 'toggle_on' : 'toggle_off'}</span>
        </IconButton>
      </Tooltip>
    </Stack>
  );
}

/* ===== ステータス：ラジオ的セグメント（視認・即時） ===== */
function StatusRadioPills({ statusByType, onChange }) {
  // 2列グリッド（小画面1列）
  return (
    <Stack spacing={0.75}>
      <Typography variant="subtitle2" sx={{ fontWeight: 900 }}>ステータス</Typography>
      <Box
        sx={{
          display:'grid',
          gridTemplateColumns:{ xs:'1fr', md:'1fr 1fr' },
          gap: 0.75
        }}
      >
        {TYPES.map(type => (
          <Box key={type}
            sx={{
              display:'flex', alignItems:'center', gap: .75,
              p: 0.75, border:'1px solid', borderColor:'divider', borderRadius: 2, bgcolor:'#f9fbff'
            }}
          >
            <Typography variant="body2" sx={{ fontWeight: 800, minWidth: 88 }}>{type}</Typography>
            <ToggleButtonGroup
              value={statusByType[type]}
              exclusive
              onChange={(e, v) => v && onChange(type, v)}
              size="small"
              color="primary"
              sx={{
                ml: 'auto',
                backgroundColor: '#eef3ff',
                borderRadius: 999,
                p: 0.25,
                '& .MuiToggleButton-root': {
                  border: 0, px: 1.2, py: 0.25, fontWeight: 700, textTransform:'none', lineHeight: 1.6
                }
              }}
            >
              <ToggleButton value="全て" aria-label={`${type} 全て`}>全て</ToggleButton>
              <ToggleButton value="未確定" aria-label={`${type} 未確定`}>未確定</ToggleButton>
              <ToggleButton value="確定" aria-label={`${type} 確定`}>確定</ToggleButton>
            </ToggleButtonGroup>
          </Box>
        ))}
      </Box>
    </Stack>
  );
}

/* ===== 凡例 & 件数（1行） ===== */
function LegendCountCompact({ count }) {
  return (
    <Stack direction="row" alignItems="center" spacing={2} flexWrap="wrap">
      <Stack direction="row" spacing={1.5} alignItems="center" sx={{ color: 'text.secondary' }}>
        <Stack direction="row" spacing={0.8} alignItems="center">
          <Box sx={{ width:10, height:10, borderRadius:'50%', bgcolor:'success.main' }} />
          <Typography variant="caption">確定</Typography>
        </Stack>
        <Stack direction="row" spacing={0.8} alignItems="center">
          <Box sx={{ width:10, height:10, borderRadius:'50%', bgcolor:'warning.main' }} />
          <Typography variant="caption">未確定</Typography>
        </Stack>
      </Stack>
      <Typography variant="body2" sx={{ ml: 'auto' }}>
        表示件数 <Box component="b" sx={{ color:'primary.main' }}>{count}</Box>
      </Typography>
    </Stack>
  );
}

/* ===== React x FullCalendar 連携 ===== */
function FullCalendarView({ events }) {
  const calRef = useRef(null);
  const fcRef  = useRef(null);

  useEffect(() => {
    const el = calRef.current;
    if (!el) return;

    fcRef.current = new FullCalendar.Calendar(el, {
      initialView: 'dayGridMonth',
      locale: 'ja',
      timeZone: 'Asia/Tokyo',
      firstDay: 0,
      height: 'auto',
      dayMaxEventRows: 3,
      headerToolbar: { left: 'prev,next today', center: 'title', right: '' },
      eventClassNames: (arg) => {
        const s = arg.event.extendedProps.status;
        return s === '確定' ? ['status-confirmed'] : ['status-pending'];
      },
      eventDidMount: (info) => {
        const { type, status } = info.event.extendedProps;
        info.el.title = `${type} / ${status} : ${info.event.title}`;
      }
    });

    fcRef.current.render();

    return () => {
      fcRef.current?.destroy();
      fcRef.current = null;
    };
  }, []);

  useEffect(() => {
    if (!fcRef.current) return;
    fcRef.current.removeAllEvents();
    fcRef.current.addEventSource(
      events.map(ev => ({
        title: ev.title,
        start: ev.date,
        allDay: true,
        extendedProps: { type: ev.type, status: ev.status }
      }))
    );
  }, [events]);

  return <div ref={calRef} />;
}

/* ===== App ===== */
function App(){
  const [categoryOn, setCategoryOn] = useState({ "スケジュール": true, "タスク": true, "案件": true });
  const [statusByType, setStatusByType] = useState({ "スケジュール":"全て", "タスク":"全て", "案件":"全て" });
  const [events] = useState(initialEvents);

  // ステータス条件のみ反映した「カテゴリ別 潜在件数」
  const countsByType = useMemo(() => {
    const m = { "スケジュール":0, "タスク":0, "案件":0 };
    events.forEach(ev => {
      const need = statusByType[ev.type];
      const ok = need === '全て' ? true : ev.status === need;
      if (ok) m[ev.type] += 1;
    });
    return m;
  }, [events, statusByType]);

  // 実表示（カテゴリON/OFF + ステータス）
  const filtered = useMemo(()=>{
    return events.filter(ev => {
      if (!categoryOn[ev.type]) return false;
      const need = statusByType[ev.type];
      return need === '全て' ? true : ev.status === need;
    });
  }, [events, categoryOn, statusByType]);

  const visibleCount = filtered.length;

  // ハンドラ
  const toggleAll = () => {
    const allOn = TYPES.every(t => categoryOn[t]);
    const next = {};
    TYPES.forEach(t => next[t] = !allOn);
    setCategoryOn(next);
  };
  const toggleOne = (type) => setCategoryOn(prev => ({ ...prev, [type]: !prev[type] }));
  const changeStatus = (type, v) => setStatusByType(prev => ({ ...prev, [type]: v }));

  return (
    <ThemeProvider theme={theme}>
      <CssBaseline />
      <Container maxWidth="lg" sx={{ py: 2 }}>
        {/* --- コンパクト ツールバー --- */}
        <Paper sx={{ p: 1.25, mb: 1.25 }}>
          <Stack spacing={1}>
            <CategoryCompact
              categoryOn={categoryOn}
              countsByType={countsByType}
              onToggleAll={toggleAll}
              onToggleOne={toggleOne}
            />
            <Stack direction={{ xs:'column', md:'row' }} spacing={1} alignItems="stretch">
              <Box sx={{ flex: 1 }}>
                <StatusRadioPills statusByType={statusByType} onChange={changeStatus} />
              </Box>
              <Divider orientation="vertical" flexItem sx={{ display:{ xs:'none', md:'block' } }} />
              <Box sx={{ minWidth: 240 }}>
                <LegendCountCompact count={visibleCount} />
              </Box>
            </Stack>
          </Stack>
        </Paper>

        {/* --- カレンダー --- */}
        <Paper sx={{ p: 1.25 }}>
          <FullCalendarView events={filtered} />
        </Paper>
      </Container>
    </ThemeProvider>
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(<App />);
</script>
</body>
</html>
