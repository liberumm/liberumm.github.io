<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8"/>
  <title>販促PDCAダッシュボード｜複数テーマ×インフォグラフィック/詳細</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <!-- Fonts / Icons -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap"/>
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons"/>
  <!-- React / Babel / MUI (UMD) -->
  <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js" crossorigin></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.23.8/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mui/material@5.15.3/umd/material-ui.production.min.js" crossorigin></script>
  <style>
    html,body,#root{height:100%}
    body{margin:0;background:#fafafa}
    .wrap{max-width:1200px;margin:0 auto;padding:16px}
    .kpi{display:grid;gap:16px;grid-template-columns:repeat(4,minmax(180px,1fr))}
    @media (max-width:1000px){.kpi{grid-template-columns:repeat(2,1fr)}}
    @media (max-width:600px){.kpi{grid-template-columns:1fr}}
    .cards{display:grid;gap:16px;grid-template-columns:repeat(3,minmax(260px,1fr))}
    @media (max-width:1000px){.cards{grid-template-columns:repeat(2,minmax(260px,1fr))}}
    @media (max-width:700px){.cards{grid-template-columns:1fr}}
    .mono{font-variant-numeric:tabular-nums;font-feature-settings:"tnum"}
    .pill{display:inline-flex;align-items:center;gap:6px;border:1px solid #eee;border-radius:999px;padding:2px 8px;background:#fff}
    .mini{font-size:12px;color:#666}
    .barBase{height:8px;background:#eee;border-radius:999px;overflow:hidden}
    .barFill{height:8px;background:#1976d2}
    .legendDot{display:inline-block;width:10px;height:10px;border-radius:50%;margin-right:6px;vertical-align:middle}
    .shadow{filter: drop-shadow(0 1px 2px rgba(0,0,0,.15))}
    .rowHover{cursor:pointer}
    .rowHover:hover{background:#fafafa}
  </style>
</head>
<body>
<div id="root"></div>

<script type="text/babel" data-presets="env,react">
const {
  AppBar, Toolbar, Typography, Container, Paper, Box, Stack, Button, Chip,
  Card, CardContent, Divider, Grid, TextField, MenuItem, ToggleButtonGroup, ToggleButton,
  Autocomplete, Tooltip, Select, Tabs, Tab,
  Table, TableHead, TableRow, TableCell, TableBody
} = MaterialUI;

/* ======= マスター/ダミー ======= */
const CHANNELS=['店舗','アウトレット','オンライン'];
const PRODUCTS=[
  {id:'P001',sku:'TSH-001',name:'ベーシックTシャツ',category:'アパレル',price:1990,cogsRate:0.45},
  {id:'P002',sku:'SNE-101',name:'ライトスニーカー',category:'シューズ',price:5990,cogsRate:0.50},
  {id:'P003',sku:'BAG-777',name:'デイリーバッグ',category:'バッグ',price:3990,cogsRate:0.42},
];
const STORES=[
  {id:'S01',name:'新宿本店',channel:'店舗'},
  {id:'S02',name:'渋谷店',channel:'店舗'},
  {id:'S03',name:'名古屋店',channel:'店舗'},
  {id:'S04',name:'アウトレット木更津',channel:'アウトレット'},
  {id:'S05',name:'ECサイト',channel:'オンライン'},
];
const INVENTORY=[
  {productId:'P001',storeId:'S01',qty:120},{productId:'P001',storeId:'S02',qty:60},
  {productId:'P001',storeId:'S03',qty:40},{productId:'P001',storeId:'S04',qty:200},{productId:'P001',storeId:'S05',qty:150},
  {productId:'P002',storeId:'S01',qty:40},{productId:'P002',storeId:'S02',qty:20},{productId:'P002',storeId:'S03',qty:10},{productId:'P002',storeId:'S04',qty:120},{productId:'P002',storeId:'S05',qty:80},
  {productId:'P003',storeId:'S01',qty:25},{productId:'P003',storeId:'S02',qty:40},{productId:'P003',storeId:'S03',qty:35},{productId:'P003',storeId:'S04',qty:10},{productId:'P003',storeId:'S05',qty:90},
];

/* 売上ダミー（直近120日） */
function generateSales(seed=42){
  let x=seed; const rand=()=> (x=(x*1664525+1013904223)%4294967296)/4294967296;
  const rows=[]; const today=new Date();
  for(let d=0; d<120; d++){
    const dt=new Date(today); dt.setDate(today.getDate()-d); const ds=dt.toISOString().slice(0,10);
    PRODUCTS.forEach(p=>{
      STORES.forEach(s=>{
        const base=(s.channel==='オンライン'?11:s.channel==='アウトレット'?6:4)*(p.id==='P002'?0.9:p.id==='P003'?0.7:1);
        const w=(dt.getDay()===0||dt.getDay()===6)?1.3:1.0; const noise=(rand()*0.8+0.6);
        let units=Math.max(0,Math.round(base*w*noise-1));
        const inv=INVENTORY.find(i=>i.productId===p.id && i.storeId===s.id)?.qty??0;
        if(inv<10) units=Math.min(units, Math.round(inv/5));
        rows.push({productId:p.id,storeId:s.id,date:ds,units,net:units*p.price});
      });
    });
  }
  return rows;
}
let SALES=generateSales();

/* ======= Utils ======= */
const fmtYen=n=>n.toLocaleString('ja-JP',{style:'currency',currency:'JPY',maximumFractionDigits:0});
const sum=(a,sel=x=>x)=>a.reduce((p,c)=>p+sel(c),0);
const byId=list=>Object.fromEntries(list.map(x=>[x.id,x]));
const toDate=s=>new Date(s+'T00:00:00');
const MS=86400000;
const addDays=(d,n)=>{const x=new Date(d); x.setDate(x.getDate()+n); return x;};
const daysBetween=(a,b)=>Math.max(1,Math.round((toDate(b)-toDate(a))/MS)+1);

/* データ抽出 */
function filterSales({productIds,channels,from,to}){
  const storeBy=byId(STORES);
  return SALES.filter(r=> productIds.includes(r.productId) &&
    toDate(r.date)>=toDate(from) && toDate(r.date)<=toDate(to) &&
    channels.includes(storeBy[r.storeId].channel)
  );
}
function aggregate(rows){ return { units:sum(rows,r=>r.units), net:sum(rows,r=>r.net), days:new Set(rows.map(r=>r.date)).size }; }
function trendSeries({productIds,channels,from,to}){
  const storeBy=byId(STORES); const dates=[];
  for(let d=toDate(from); d<=toDate(to); d=addDays(d,1)) dates.push(d.toISOString().slice(0,10));
  return dates.map(ds=> sum(SALES.filter(r=>r.date===ds && productIds.includes(r.productId) && channels.includes(storeBy[r.storeId].channel)), r=>r.net));
}
function productMeta(productIds){
  const items=PRODUCTS.filter(p=>productIds.includes(p.id));
  return {
    priceAvg: items.length? Math.round(sum(items,p=>p.price)/items.length):0,
    cogsRateAvg: items.length? sum(items,p=>p.cogsRate)/items.length : 0.45
  };
}
function grossProfit({units,avgPrice,cogsRate,discountPct=0}){
  const price=avgPrice*(1-discountPct/100);
  return units*(price-avgPrice*cogsRate);
}

/* ======= プラン（= テーマ） ======= */
function makePlan({theme, from, to, channels=CHANNELS, products=['P001'], mechanic='discount', discountPct=15, budgets={店舗:120000, アウトレット:50000, オンライン:90000}, objective='売上最大化＆回転最適化', hypothesis='ECで初動を取り、実店舗は在庫回転重視', kgi={incrNet:1200000, roi:1.5}}){
  return { id:`plan-${Date.now()}-${Math.random().toString(36).slice(2,7)}`, theme, objective, hypothesis, kgi, kpis:{convUpliftPct:8,reach:150000}, period:{from,to}, channels, products, mechanic, discountPct, budgetByChannel:budgets };
}
function seedPlans(){
  const today=new Date(); const d=n=>{const t=new Date(today); t.setDate(t.getDate()+n); return t.toISOString().slice(0,10);};
  return [
    makePlan({ theme:'T1_サマーセール', from:d(-28), to:d(-1), products:['P001','P003'], discountPct:20, budgets:{店舗:120000,アウトレット:70000,オンライン:130000}, kgi:{incrNet:1500000,roi:1.6} }),
    makePlan({ theme:'T2_スニーカーWEEK', from:d(-10), to:d(7), products:['P002'], discountPct:10, budgets:{店舗:80000,アウトレット:20000,オンライン:90000}, kgi:{incrNet:900000,roi:1.4} }),
    makePlan({ theme:'T3_秋の新作先行', from:d(-3), to:d(21), products:['P001'], discountPct:0, mechanic:'points', budgets:{店舗:140000,アウトレット:20000,オンライン:160000}, kgi:{incrNet:1100000,roi:1.5} }),
  ];
}

/* ======= 永続化 ======= */
const LS='promo_pdca_multi_v1';
const loadAll=()=>{ try{const j=localStorage.getItem(LS); return j? JSON.parse(j): seedPlans();}catch{ return seedPlans(); } };
const saveAll=(plans)=> localStorage.setItem(LS, JSON.stringify(plans));

/* ======= ビジュアル部品 ======= */
const KPI=({label,value,sub})=>(
  <Card elevation={0} variant="outlined"><CardContent>
    <Typography variant="body2" color="text.secondary">{label}</Typography>
    <Typography variant="h5" className="mono">{value}</Typography>
    {sub && <Typography variant="caption" color="text.secondary">{sub}</Typography>}
  </CardContent></Card>
);

const Sparkline=({data,width=120,height=36})=>{
  const min=Math.min(...data,0), max=Math.max(...data,1);
  const pts=data.map((v,i)=>`${(i/(data.length-1||1))*width},${height-((v-min)/(max-min||1))*height}`).join(' ');
  return (<svg width={width} height={height}><polyline fill="none" stroke="currentColor" strokeWidth="2" points={pts}/></svg>);
};

const Donut=({value,max=120,size=72,label})=>{
  const r=size/2-6, C=2*Math.PI*r, v=Math.max(0,Math.min(max,value)), dash=C*(v/max); const cx=size/2, cy=size/2;
  return (<svg width={size} height={size} viewBox={`0 0 ${size} ${size}`}>
    <circle cx={cx} cy={cy} r={r} stroke="#eee" strokeWidth="6" fill="none"/>
    <circle cx={cx} cy={cy} r={r} stroke="currentColor" strokeWidth="6" fill="none" strokeDasharray={`${dash} ${C-dash}`} transform={`rotate(-90 ${cx} ${cy})`}/>
    <text x={cx} y={cy} textAnchor="middle" dominantBaseline="central" fontSize="14">{label ?? Math.round(value)}</text>
  </svg>);
};

/* 配色（テーマごとに固定） */
const PALETTE=['#1976d2','#ef6c00','#2e7d32','#6d4c41','#8e24aa','#0097a7','#c62828'];
const colorFor=(idx)=>PALETTE[idx % PALETTE.length];

/* 参照期間グラフ：売上トレンド + テーマ帯 */
function TimelineChart({from,to,series,events=[],onEventClick,width=920,height=180}){
  const min=Math.min(...series,0), max=Math.max(...series,1);
  const toX=(i)=> (series.length<=1?0:(i/(series.length-1))*width);
  const toY=(v)=> height-((v-min)/(max-min||1))*height;

  // イベント→バンド（rect）座標
  const start=toDate(from), end=toDate(to), days=Math.max(1, Math.round((end-start)/MS)+1);
  const dateToIndex=(ds)=> Math.min(days-1, Math.max(0, Math.round((toDate(ds)-start)/MS)));
  const bands=events.map((e,idx)=>{
    const s=dateToIndex(e.from), t=dateToIndex(e.to);
    const x=toX(s), w=Math.max(2, toX(t)-toX(s));
    return {...e, x, w, color:e.color||colorFor(idx)};
  });

  // 折れ線ポイント
  const pts=series.map((v,i)=>`${toX(i)},${toY(v)}`).join(' ');

  return (
    <svg width={width} height={height+40} className="shadow">
      {/* バンド（背景） */}
      {bands.map((b,i)=>(
        <g key={i} cursor="pointer" onClick={()=>onEventClick && onEventClick(b)}>
          <rect x={b.x} y="0" width={b.w} height={height} fill={b.color} opacity="0.13" rx="3"/>
          <rect x={b.x} y={height-4} width={b.w} height="4" fill={b.color} opacity="0.8"/>
          <text x={b.x+4} y="14" font-size="12" fill={b.color}><title>{`${b.label} (${b.from}〜${b.to})`}</title>{b.label}</text>
        </g>
      ))}
      {/* ライン */}
      <polyline fill="none" stroke="#37474f" strokeWidth="2" points={pts}/>
      {/* X 軸目盛り（始点・中点・終点） */}
      <text x="0" y={height+14} font-size="11" fill="#666">{from}</text>
      <text x={width/2-36} y={height+14} font-size="11" fill="#666">
        {addDays(toDate(from), Math.round((toDate(to)-toDate(from))/MS/2)).toISOString().slice(0,10)}
      </text>
      <text x={width-80} y={height+14} font-size="11" fill="#666">{to}</text>
    </svg>
  );
}

/* ======= Infographic（複数テーマ一覧 + 参照期間 + 期間帯可視化 + 商品テーブル） ======= */
function Infographic({plans,setMode,setActiveId}){
  // 参照期間（初期＝直近14日）
  const today=new Date(); const d=n=>{const t=new Date(today); t.setDate(t.getDate()+n); return t.toISOString().slice(0,10);};
  const [from,setFrom]=React.useState(d(-14));
  const [to,setTo]=React.useState(d(0));
  const [ch,setCh]=React.useState(CHANNELS);

  // 期間内にオーバーラップするプラン抽出
  const overlap=(p)=> !(toDate(p.period.to) < toDate(from) || toDate(p.period.from) > toDate(to));
  const visible=plans.filter(overlap);

  // 概況トレンド（可視プランの製品×チャネル総和）
  const allProductIds=[...new Set(visible.flatMap(v=>v.products))];
  const baseProducts=allProductIds.length?allProductIds:PRODUCTS.map(p=>p.id);
  const seriesAll=trendSeries({productIds:baseProducts, channels:ch, from, to});
  const totalSel=seriesAll.reduce((a,b)=>a+b,0);
  const prAvg=productMeta(baseProducts).priceAvg;

  // グラフに重ねるイベント（バンド）
  const events=visible.map((p,idx)=>({
    id:p.id,
    label:p.theme,
    from: (toDate(p.period.from) > toDate(from)) ? p.period.from : from,
    to:   (toDate(p.period.to)   < toDate(to))   ? p.period.to   : to,
    color: colorFor(idx)
  }));

  const pct=(a,b)=> b<=0?0: Math.max(0, Math.min(1, a/b));

  // ===== テーマカード =====
  const cards = visible.map((p,idx)=>{
    const rows=filterSales({productIds:p.products, channels:ch.filter(x=>p.channels.includes(x)), from, to});
    const act=aggregate(rows);
    const base=aggregate(filterSales({productIds:p.products, channels:p.channels, from:p.period.from, to:p.period.to}));
    const meta=productMeta(p.products);
    const gpBase=grossProfit({units:base.units, avgPrice:meta.priceAvg, cogsRate:meta.cogsRateAvg, discountPct:0});
    const gpAct=grossProfit({units:act.units, avgPrice:meta.priceAvg, cogsRate:meta.cogsRateAvg, discountPct:(p.mechanic==='discount'?p.discountPct:0)});
    const incrNet=Math.max(0, act.net - base.net);
    const budget=sum(Object.values(p.budgetByChannel||{}));
    const incrGP=Math.max(0, gpAct - gpBase - budget);
    const roi= budget>0 ? (incrGP/budget) : (incrGP>0?Infinity:0);
    const sr=trendSeries({productIds:p.products, channels:ch.filter(x=>p.channels.includes(x)), from, to});
    const progress=pct(act.net, p.kgi.incrNet);

    return (
      <Card key={p.id} variant="outlined" sx={{cursor:'pointer'}} onClick={()=>{ setActiveId(p.id); setMode('detail'); }}>
        <CardContent>
          <Stack direction="row" justifyContent="space-between" alignItems="center">
            <Stack spacing={.5}>
              <Typography variant="subtitle2"><span className="legendDot" style={{background:colorFor(idx)}}></span>{p.theme}</Typography>
              <span className="mini">{p.period.from}〜{p.period.to}</span>
            </Stack>
            <Donut value={progress*100} max={100} size={64} label={`${Math.round(progress*100)}%`}/>
          </Stack>

          <Box mt={1} className="barBase"><div className="barFill" style={{width:`${Math.min(100,Math.round(progress*100))}%`}}/></Box>
          <span className="mini">進捗：{fmtYen(act.net)} / 目標 {fmtYen(p.kgi.incrNet)}</span>

          <Divider sx={{my:1.2}}/>
          <Stack direction="row" justifyContent="space-between" alignItems="center">
            <Stack>
              <span className="mini">ROI</span>
              <Typography className="mono" variant="h6">{roi===Infinity?'∞':roi.toFixed(2)}x</Typography>
            </Stack>
            <Sparkline data={sr}/>
          </Stack>
          <Box mt={1} className="mini" color="text.secondary">
            {p.mechanic==='discount' ? `値引 ${p.discountPct}%`:`${p.mechanic} 実施`} ／ 予算 {fmtYen(budget)}
          </Box>
        </CardContent>
      </Card>
    );
  });

  // ===== 商品一覧テーブル（可視テーマ × 対象商品） =====
  const productRows = visible.flatMap((p,idx)=>
    p.products.map(pid=>{
      const prod = PRODUCTS.find(x=>x.id===pid);
      return {
        themeId: p.id,
        color: colorFor(idx),
        period: `${p.period.from}〜${p.period.to}`,
        theme: p.theme,
        sku: prod?.sku || '-',
        name: prod?.name || '-',
        category: prod?.category || '-',
        price: prod?.price ?? 0
      };
    })
  );

  return (
    <>
      {/* 参照条件バー */}
      <Paper variant="outlined" sx={{p:2, mb:2}}>
        <Stack direction="row" spacing={1} alignItems="center" flexWrap="wrap">
          <span className="pill">
            <span className="mini" style={{marginRight:6}}>参照期間</span>
            <input type="date" value={from} onChange={e=>setFrom(e.target.value)}/>〜
            <input type="date" value={to} onChange={e=>setTo(e.target.value)}/>
          </span>
          <Autocomplete multiple size="small" options={CHANNELS} value={ch}
            onChange={(e,v)=>setCh(v)} renderInput={(p)=><TextField {...p} label="チャネル" placeholder="選択"/>} sx={{minWidth:240}}/>
          <span className="mini" style={{marginLeft:'auto'}}>I / D キーでモード切替</span>
        </Stack>
      </Paper>

      {/* 概況KPI */}
      <Box className="kpi" mb={2}>
        <KPI label="売上（参照期間）" value={fmtYen(totalSel)} sub={`対象テーマ ${visible.length} 件`} />
        <KPI label="対象商品（推定平均単価）" value={fmtYen(prAvg)} sub={`${baseProducts.length} SKU`} />
        <KPI label="チャネル" value={`${ch.length} 種`} sub={ch.join(' / ')}/>
        <KPI label="ヒント" value="帯やカードをクリック" sub="クリックで詳細へ"/>
      </Box>

      {/* 期間トレンド + テーマ帯オーバーレイ */}
      <Paper variant="outlined" sx={{p:2, mb:2}}>
        <Box className="sectionTitle"><span className="material-icons">show_chart</span> 日次売上トレンド（参照期間）</Box>
        <Divider sx={{mb:1}}/>
        <TimelineChart
          from={from}
          to={to}
          series={seriesAll}
          events={events}
          onEventClick={(b)=>{ setActiveId(b.id); setMode('detail'); }}
          width={920}
          height={180}
        />
        {/* レジェンド */}
        <Stack direction="row" spacing={2} flexWrap="wrap">
          {events.map((e,i)=>(
            <span key={i} className="mini"><span className="legendDot" style={{background:e.color}}></span>{e.label}</span>
          ))}
        </Stack>
      </Paper>

      {/* テーマカード一覧 */}
      <div className="cards">
        {visible.length===0 && <Typography color="text.secondary">参照期間に一致するテーマがありません。</Typography>}
        {cards}
      </div>

      {/* === 新規追加：販促対象 商品一覧テーブル === */}
      <Paper variant="outlined" sx={{p:2, mt:2}}>
        <Box className="sectionTitle"><span className="material-icons">list_alt</span> 販促対象 商品一覧</Box>
        <Divider sx={{mb:1}}/>
        <Table size="small">
          <TableHead>
            <TableRow>
              <TableCell>期間</TableCell>
              <TableCell>テーマ</TableCell>
              <TableCell>SKU</TableCell>
              <TableCell>商品名</TableCell>
              <TableCell>カテゴリ</TableCell>
              <TableCell align="right">価格</TableCell>
            </TableRow>
          </TableHead>
          <TableBody>
            {productRows.length===0 ? (
              <TableRow><TableCell colSpan={6} align="center" style={{color:'#666'}}>該当データがありません</TableCell></TableRow>
            ) : productRows.map((r,i)=>(
              <TableRow key={i} hover className="rowHover" onClick={()=>{ setActiveId(r.themeId); setMode('detail'); }}>
                <TableCell>{r.period}</TableCell>
                <TableCell><span className="legendDot" style={{background:r.color}}></span>{r.theme}</TableCell>
                <TableCell className="mono">{r.sku}</TableCell>
                <TableCell>{r.name}</TableCell>
                <TableCell>{r.category}</TableCell>
                <TableCell align="right">{fmtYen(r.price)}</TableCell>
              </TableRow>
            ))}
          </TableBody>
        </Table>
        <Box mt={1} className="mini" color="text.secondary">行クリックで当該テーマの詳細へ移動します。</Box>
      </Paper>
    </>
  );
}

/* ======= 詳細モード（テーマ選択＋既存PDCA編集） ======= */
function PlanEditor({plan,setPlan,onSave,onExport,onImport}){
  return (
    <Paper variant="outlined" sx={{p:2}}>
      <Box className="sectionTitle"><span className="material-icons">assignment</span> 販促計画（Plan）</Box>
      <Divider sx={{mb:2}}/>
      <Grid container spacing={2}>
        <Grid item xs={12} md={6}><TextField label="テーマ" size="small" fullWidth value={plan.theme} onChange={e=>setPlan({...plan, theme:e.target.value})}/></Grid>
        <Grid item xs={12} md={6}><TextField label="目的（Objective）" size="small" fullWidth value={plan.objective} onChange={e=>setPlan({...plan, objective:e.target.value})}/></Grid>
        <Grid item xs={6} md={3}><TextField label="KGI：増分売上(円)" type="number" size="small" fullWidth value={plan.kgi.incrNet} onChange={e=>setPlan({...plan, kgi:{...plan.kgi, incrNet:Number(e.target.value)}})}/></Grid>
        <Grid item xs={6} md={3}><TextField label="KGI：ROI(×)" type="number" size="small" fullWidth value={plan.kgi.roi} onChange={e=>setPlan({...plan, kgi:{...plan.kgi, roi:Number(e.target.value)}})}/></Grid>
        <Grid item xs={6} md={3}><TextField type="date" size="small" label="開始" InputLabelProps={{shrink:true}} value={plan.period.from} onChange={e=>setPlan({...plan, period:{...plan.period, from:e.target.value}})} fullWidth/></Grid>
        <Grid item xs={6} md={3}><TextField type="date" size="small" label="終了" InputLabelProps={{shrink:true}} value={plan.period.to} onChange={e=>setPlan({...plan, period:{...plan.period, to:e.target.value}})} fullWidth/></Grid>

        <Grid item xs={12} md={6}>
          <Autocomplete multiple size="small" options={CHANNELS} value={plan.channels}
            onChange={(e,v)=>setPlan({...plan, channels:v})}
            renderInput={(p)=><TextField {...p} label="対象チャネル" placeholder="選択"/>}/>
        </Grid>
        <Grid item xs={12} md={6}>
          <Autocomplete multiple size="small" options={PRODUCTS} value={PRODUCTS.filter(p=>plan.products.includes(p.id))}
            onChange={(e,v)=>setPlan({...plan, products:v.map(x=>x.id)})}
            getOptionLabel={o=>`${o.name}（${o.sku}）`}
            renderInput={(p)=><TextField {...p} label="対象商品"/>}/>
        </Grid>

        <Grid item xs={6} md={3}>
          <TextField select size="small" label="メカニクス" value={plan.mechanic} onChange={e=>setPlan({...plan, mechanic:e.target.value})} fullWidth>
            <MenuItem value="discount">値引き</MenuItem>
            <MenuItem value="points">ポイント</MenuItem>
            <MenuItem value="coupon">クーポン</MenuItem>
          </TextField>
        </Grid>
        <Grid item xs={6} md={3}><TextField size="small" type="number" label="割引/還元率(%)" value={plan.discountPct} onChange={e=>setPlan({...plan, discountPct:Number(e.target.value)})} fullWidth/></Grid>
        {CHANNELS.map(ch=>(
          <Grid key={ch} item xs={12} md={4}>
            <TextField size="small" type="number" label={`予算（${ch}）`} value={plan.budgetByChannel[ch]||0}
              onChange={e=>setPlan({...plan, budgetByChannel:{...plan.budgetByChannel,[ch]:Number(e.target.value)}})} fullWidth/>
          </Grid>
        ))}
        <Grid item xs={12}><TextField label="仮説（Why this plan?）" size="small" fullWidth multiline minRows={2} value={plan.hypothesis} onChange={e=>setPlan({...plan, hypothesis:e.target.value})}/></Grid>

        <Grid item xs={12}>
          <Stack direction="row" spacing={2}>
            <Button variant="contained" startIcon={<span className="material-icons">save</span>} onClick={onSave}>保存</Button>
            <Button variant="outlined" startIcon={<span className="material-icons">download</span>} onClick={onExport}>JSON出力</Button>
            <Button variant="outlined" component="label" startIcon={<span className="material-icons">upload_file</span>}>JSON入力<input type="file" hidden accept=".json" onChange={onImport}/></Button>
          </Stack>
        </Grid>
      </Grid>
    </Paper>
  );
}

function ActualsPanel({plan,onLoadSalesCSV,onLoadInvCSV}){
  return (
    <Paper variant="outlined" sx={{p:2}}>
      <Box className="sectionTitle"><span className="material-icons">fact_check</span> 実績（Do / 実行ログ）</Box>
      <Divider sx={{mb:2}}/>
      <Stack direction="row" spacing={2} mb={2} flexWrap="wrap">
        <Button variant="outlined" component="label" startIcon={<span className="material-icons">file_upload</span>}>売上CSV<input type="file" hidden accept=".csv" onChange={onLoadSalesCSV}/></Button>
        <Button variant="outlined" component="label" startIcon={<span className="material-icons">inventory_2</span>}>在庫CSV<input type="file" hidden accept=".csv" onChange={onLoadInvCSV}/></Button>
      </Stack>
      <Typography variant="body2" color="text.secondary">期間: {plan.period.from}〜{plan.period.to} ／ 対象: {plan.products.length}SKU ／ {plan.channels.join(' / ')}</Typography>
    </Paper>
  );
}

function PdcaCheckAct({plan}){
  const rows=filterSales({productIds:plan.products,channels:plan.channels,from:plan.period.from,to:plan.period.to});
  const meta=productMeta(plan.products); const base=aggregate(rows); // デモでは同期間＝実績扱い
  const gpBase=grossProfit({units:base.units,avgPrice:meta.priceAvg,cogsRate:meta.cogsRateAvg,discountPct:(plan.mechanic==='discount'?plan.discountPct:0)});
  const budget=sum(Object.values(plan.budgetByChannel||{}));
  const roi= budget>0 ? (gpBase/budget) : (gpBase>0?Infinity:0);

  const analysis=[
    `増分指標（概算） ROI ${roi===Infinity?'∞':roi.toFixed(2)}x / 期間 ${plan.period.from}〜${plan.period.to}`,
    plan.mechanic==='discount' ? `ディスカウント ${plan.discountPct}%。粗利悪化に注意。` : `非値引きメカニクスで単価維持。`,
    `チャネル配分の最適化を再検討（媒体費の効率差を確認）。`
  ];

  return (
    <Paper variant="outlined" sx={{p:2}}>
      <Box className="sectionTitle"><span className="material-icons">analytics</span> Check & Act</Box>
      <Divider sx={{mb:2}}/>
      <ul>{analysis.map((m,i)=><li key={i}>{m}</li>)}</ul>
    </Paper>
  );
}

/* ======= アプリ本体 ======= */
function App(){
  const [plans,setPlans]=React.useState(loadAll());
  const [activeId,setActiveId]=React.useState(plans[0]?.id);
  const active=plans.find(p=>p.id===activeId) || plans[0];
  const [mode,setMode]=React.useState(()=> localStorage.getItem('promo_mode_multi_v1') || 'infographic');
  React.useEffect(()=>{ localStorage.setItem('promo_mode_multi_v1', mode); },[mode]);
  React.useEffect(()=>{ const onKey=e=>{ if(e.key?.toLowerCase()==='i') setMode('infographic'); if(e.key?.toLowerCase()==='d') setMode('detail'); }; window.addEventListener('keydown',onKey); return ()=>window.removeEventListener('keydown',onKey); },[]);

  /* テーマ操作 */
  const today=new Date(); const d=n=>{const t=new Date(today); t.setDate(t.getDate()+n); return t.toISOString().slice(0,10);};
  const addPlan=()=>{ const np=makePlan({theme:`新規テーマ_${plans.length+1}`,from:d(0),to:d(14)}); const next=[...plans,np]; setPlans(next); setActiveId(np.id); saveAll(next); };
  const copyPlan=()=>{ if(!active) return; const cp={...active, id:`plan-${Date.now()}-${Math.random().toString(36).slice(2,7)}`, theme:active.theme+'（複製）'}; const next=[...plans,cp]; setPlans(next); setActiveId(cp.id); saveAll(next); };
  const deletePlan=()=>{ if(!active) return; const next=plans.filter(p=>p.id!==active.id); setPlans(next); setActiveId(next[0]?.id); saveAll(next); };

  /* I/O */
  const saveAllPlans=()=>{ saveAll(plans); alert('保存しました'); };
  const exportAll=()=>{ const blob=new Blob([JSON.stringify(plans,null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='plans.json'; a.click(); URL.revokeObjectURL(url); };
  const importAll=(file)=>{ const r=new FileReader(); r.onload=()=>{ try{ const arr=JSON.parse(r.result); setPlans(arr); setActiveId(arr[0]?.id); saveAll(arr); }catch{ alert('JSON形式エラー'); } }; r.readAsText(file,'utf-8'); };

  /* CSV 読み込み（省略形：売上・在庫） */
  const onLoadSalesCSV=(e)=>{ const f=e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{ const lines=r.result.split(/\r?\n/).filter(Boolean); const rows=lines.slice(1).map(l=>{const [productId,storeId,date,units,net]=l.split(','); return {productId,storeId,date,units:Number(units),net:Number(net)};}); SALES=rows; alert('売上CSVを読み込みました'); }; r.readAsText(f,'utf-8'); };
  const onLoadInvCSV=(e)=>{ const f=e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{ const lines=r.result.split(/\r?\n/).filter(Boolean); const rows=lines.slice(1).map(l=>{const [productId,storeId,qty]=l.split(','); return {productId,storeId,qty:Number(qty)};}); INVENTORY.splice(0,INVENTORY.length,...rows); alert('在庫CSVを読み込みました'); }; r.readAsText(f,'utf-8'); };

  /* 詳細モード：集計（選択テーマ） */
  const meta=active? productMeta(active.products):{priceAvg:0,cogsRateAvg:0};
  const base=active ? aggregate(filterSales({productIds:active.products,channels:active.channels,from:active.period.from,to:active.period.to})) : {units:0,net:0,days:0};
  const gpBase=grossProfit({units:base.units,avgPrice:meta.priceAvg,cogsRate:meta.cogsRateAvg,discountPct:(active?.mechanic==='discount'?active.discountPct:0)});
  const budget=active? sum(Object.values(active.budgetByChannel||{})):0;
  const roi=budget>0?(gpBase/budget):(gpBase>0?Infinity:0);
  const daysLen=active? daysBetween(active.period.from, active.period.to):0;

  return (
    <>
      <AppBar position="static" color="inherit" elevation={0}>
        <Toolbar className="wrap">
          <span className="material-icons" style={{marginRight:8}}>donut_large</span>
          <Typography variant="h6" sx={{flexGrow:1}}>販促PDCAダッシュボード（複数テーマ）</Typography>
          <ToggleButtonGroup exclusive size="small" value={mode} onChange={(e,v)=> v && setMode(v)}>
            <ToggleButton value="infographic"><span className="material-icons" style={{fontSize:16,marginRight:4}}>dashboard</span>Infographic</ToggleButton>
            <ToggleButton value="detail"><span className="material-icons" style={{fontSize:16,marginRight:4}}>table_view</span>Detail</ToggleButton>
          </ToggleButtonGroup>
        </Toolbar>
      </AppBar>

      <div className="wrap">
        {mode==='infographic' ? (
          <Infographic plans={plans} setMode={setMode} setActiveId={setActiveId}/>
        ) : (
          <>
            {/* テーマ選択＆操作 */}
            <Paper variant="outlined" sx={{p:2, mb:2}}>
              <Stack direction="row" spacing={1} alignItems="center" flexWrap="wrap">
                <TextField select size="small" label="テーマ" value={active?.id||''} onChange={e=>setActiveId(e.target.value)} sx={{minWidth:280}}>
                  {plans.map((p,i)=><MenuItem key={p.id} value={p.id}><span className="legendDot" style={{background:colorFor(i)}}></span>{p.theme}（{p.period.from}〜{p.period.to}）</MenuItem>)}
                </TextField>
                <Button size="small" variant="outlined" onClick={addPlan} startIcon={<span className="material-icons">add</span>}>追加</Button>
                <Button size="small" variant="outlined" onClick={copyPlan} startIcon={<span className="material-icons">content_copy</span>}>複製</Button>
                <Button size="small" variant="outlined" color="error" onClick={deletePlan} startIcon={<span className="material-icons">delete</span>}>削除</Button>
                <span className="mini" style={{marginLeft:'auto'}}>全テーマ I/O</span>
                <Button size="small" variant="outlined" onClick={saveAllPlans}>保存</Button>
                <Button size="small" variant="outlined" onClick={exportAll}>JSON出力</Button>
                <Button size="small" variant="outlined" component="label">JSON入力<input type="file" hidden accept=".json" onChange={(e)=>e.target.files[0]&&importAll(e.target.files[0])}/></Button>
              </Stack>
            </Paper>

            {/* 概況カード（選択テーマ） */}
            {active ? (
              <>
                <Box className="kpi" mb={2}>
                  <KPI label="売上（期間）" value={fmtYen(base.net)} sub={`数量 ${base.units.toLocaleString()} ／ ${active.period.from}〜${active.period.to}（${daysLen}日）`} />
                  <KPI label="平均単価（推定）" value={fmtYen(meta.priceAvg)} sub={`${active.products.length} SKU`} />
                  <KPI label="予算合計" value={fmtYen(budget)} sub={active.channels.join(' / ')}/>
                  <KPI label="ROI（概算）" value={roi===Infinity?'∞':roi.toFixed(2)} sub={active.mechanic==='discount'?`値引 ${active.discountPct}%`:`${active.mechanic} 施策`}/>
                </Box>

                <PlanEditor
                  plan={active}
                  setPlan={(p)=>{ const next=plans.map(x=>x.id===active.id?p:x); setPlans(next); saveAll(next); }}
                  onSave={()=>{ saveAll(plans); alert('保存しました'); }}
                  onExport={()=>{ const blob=new Blob([JSON.stringify(active,null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`plan-${active.theme}.json`; a.click(); URL.revokeObjectURL(url); }}
                  onImport={(e)=>{ const f=e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{ try{ const p=JSON.parse(r.result); const next=plans.map(x=>x.id===active.id?p:x); setPlans(next); saveAll(next); }catch{alert('JSON不正');} }; r.readAsText(f,'utf-8'); }}
                />

                <Box my={2}>
                  <ActualsPanel plan={active} onLoadSalesCSV={onLoadSalesCSV} onLoadInvCSV={onLoadInvCSV}/>
                </Box>

                <PdcaCheckAct plan={active}/>
              </>
            ) : (
              <Typography color="text.secondary">テーマがありません。追加してください。</Typography>
            )}
          </>
        )}
      </div>
    </>
  );
}

const root=ReactDOM.createRoot(document.getElementById('root'));
root.render(<App/>);
</script>
</body>
</html>
