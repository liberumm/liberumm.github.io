<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>ポータル：通知＋ショートカット＋会員情報取得（申請フロー）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Fonts / Icons -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap"/>
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons"/>

  <!-- React / Babel / MUI (UMD) -->
  <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js" crossorigin></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.23.8/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mui/material@5.15.3/umd/material-ui.production.min.js" crossorigin></script>

  <style>
    html, body, #root {
      height: 100%;
    }
    body {
      margin: 0;
      font-family: Roboto, "Helvetica Neue", Arial, sans-serif;
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      min-height: 100vh;
    }
    
    /* カードリンクスタイル */
    a.cardLink {
      text-decoration: none;
      color: inherit;
      display: block;
      transition: transform 0.2s ease-in-out;
    }
    a.cardLink:hover {
      transform: translateY(-2px);
    }
    
    /* アイコンスタイル */
    .iconXL {
      font-size: 56px;
      background: linear-gradient(135deg, #495057 0%, #6c757d 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 8px;
    }
    
    /* ドロップゾーンスタイル */
    .dropzone {
      border: 2px dashed #dee2e6;
      border-radius: 8px;
      padding: 32px 20px;
      text-align: center;
      transition: all 0.2s ease;
      background: #ffffff;
    }
    .dropzone:hover {
      border-color: #495057;
      background: #f8f9fa;
    }
    .dropzone.dragover {
      border-color: #495057;
      background: #e9ecef;
    }
    
    /* テーブルラップスタイル */
    .tableWrap {
      overflow: auto;
      border-radius: 8px;
      box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
      background: #ffffff;
    }
    .tableWrap.fullHeight {
      height: calc(100vh - 320px);
      min-height: 400px;
    }
    
    /* モノスペースフォント */
    .mono {
      font-variant-numeric: tabular-nums;
      font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
      font-weight: 500;
    }
    
    /* セル入力スタイル */
    .cellInput {
      width: 180px;
      font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, monospace;
    }
    
    /* ミュートテキスト */
    .muted {
      color: #64748b;
    }
    
    /* 行番号スタイル */
    .rowNum {
      width: 60px;
      text-align: right;
      padding-right: 12px;
      color: #94a3b8;
      font-weight: 500;
      background: #f8fafc;
    }
    
    /* カスタムペーパースタイル */
    .custom-paper {
      background: #ffffff;
      border: 1px solid #dee2e6;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }
    
    /* ステータスチップ強化 */
    .status-chip {
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    /* アニメーション */
    @keyframes slideInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .slide-in {
      animation: slideInUp 0.4s ease-out;
    }
    
    /* レスポンシブ調整 */
    @media (max-width: 768px) {
      .cellInput {
        width: 140px;
      }
      .iconXL {
        font-size: 36px;
      }
      .dropzone {
        padding: 24px 16px;
      }
    }
  </style>
</head>
<body>
<div id="root"></div>

<script type="text/babel">
const {
  ThemeProvider,
  createTheme,
  CssBaseline,
  Container,
  AppBar,
  Toolbar,
  Typography,
  Grid,
  Card,
  CardActionArea,
  CardContent,
  Stack,
  Chip,
  Tooltip,
  IconButton,
  Alert,
  AlertTitle,
  Box,
  Button,
  Divider,
  LinearProgress,
  Snackbar,
  Tabs,
  Tab,
  TextField,
  Paper,
  Table,
  TableHead,
  TableRow,
  TableCell,
  TableBody,
  Collapse,
  Badge
} = MaterialUI;

const MOCK_DB = {
  "M-0001": { name: "山田 太郎", phone: "090-1234-5678", address: "東京都千代田区1-2-3" },
  "M-0002": { name: "佐藤 花子", phone: "080-5555-6666", address: "神奈川県横浜市青葉区4-5-6" },
  "M-0003": { name: "鈴木 次郎", phone: "070-7777-8888", address: "大阪府大阪市北区7-8-9" }
};
const lookupMember = async (memberId) => {
  await new Promise(r => setTimeout(r, 300));
  return MOCK_DB[memberId] || null;
};

const uid = () => 'REQ-' + Date.now().toString(36) + '-' + Math.random().toString(36).slice(2,8);
const fmtDateTime = (d) => new Date(d).toLocaleString();

const NotificationCenter = ({ pendingCount, onGoRequests }) => {
  const announcements = [
    { id:"info1", severity: "info", title: "メンテナンス案内", msg: "9/5(木) 02:00-03:00 システムメンテナンスを実施します。" },
    { id:"info2", severity: "success", title: "新機能", msg: "会員情報取得が『申請→承認→実行』フローに対応しました。" }
  ];
  return (
    <Box sx={{ my: 2 }}>
      <Grid container spacing={2}>
        <Grid item xs={12}>
          <Stack spacing={1.25}>
            {announcements.map(a => (
              <Alert key={a.id} severity={a.severity} variant="outlined">
                <AlertTitle>{a.title}</AlertTitle>
                {a.msg}
              </Alert>
            ))}
          </Stack>
        </Grid>
        <Grid item xs={12}>
          <Card>
            <CardContent>
              <Typography variant="subtitle1" gutterBottom>要対応タスク</Typography>
              <Stack divider={<Divider />} spacing={1}>
                <Stack direction="row" spacing={1} justifyContent="space-between" alignItems="center">
                  <Typography variant="body2">
                    承認待ちの取得申請が {pendingCount} 件あります
                  </Typography>
                  <Button
                    size="small"
                    onClick={onGoRequests}
                    endIcon={<span className="material-icons">arrow_forward</span>}
                  >
                    申請一覧へ
                  </Button>
                </Stack>
              </Stack>
            </CardContent>
          </Card>
        </Grid>
      </Grid>
    </Box>
  );
};

const ShortcutCard = ({ title, subtitle, icon, onClick, href }) => (
  <Grid item xs={12} sm={6} md={4}>
    <a
      className="cardLink"
      href={href}
      target={href ? "_blank" : undefined}
      rel={href ? "noopener noreferrer" : undefined}
      onClick={onClick}
    >
      <Card elevation={0} sx={{ height: '100%', minHeight: 200 }}>
        <CardActionArea sx={{ height: '100%', p: 2 }}>
          <CardContent sx={{ textAlign: 'center', height: '100%', display: 'flex', flexDirection: 'column', justifyContent: 'center' }}>
            <Stack spacing={2} alignItems="center" sx={{ height: '100%', justifyContent: 'center' }}>
              <Box sx={{ 
                p: 2, 
                borderRadius: '50%', 
                background: 'linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%)',
                border: '2px solid #dee2e6'
              }}>
                <span className="material-icons iconXL">{icon}</span>
              </Box>
              <Stack spacing={1} alignItems="center">
                <Typography variant="h6" sx={{ fontWeight: 700, color: '#212529' }}>{title}</Typography>
                <Typography variant="body2" color="text.secondary" sx={{ textAlign: 'center', lineHeight: 1.5 }}>{subtitle}</Typography>
              </Stack>
              <Chip
                size="small"
                variant="outlined"
                icon={<span className="material-icons" style={{fontSize: 16}}>open_in_new</span>}
                label={href ? "外部サービス" : "内部画面"}
                sx={{ mt: 'auto' }}
              />
            </Stack>
          </CardContent>
        </CardActionArea>
      </Card>
    </a>
  </Grid>
);

const SpreadsheetInput = ({ value, onChange, onSubmit }) => {
  const [rows, setRows] = React.useState(value?.length ? value : Array.from({length:10},()=>({memberId:""})));
  const tableRef = React.useRef(null);
  React.useEffect(()=>{ onChange?.(rows); }, [rows]);
  const setCell = (idx, v) => {
    setRows(prev => {
      const next = [...prev];
      next[idx] = { memberId: v.trim() };
      return next;
    });
  };
  const addRows = (n=10) => setRows(prev => [...prev, ...Array.from({length:n},()=>({memberId:""}))]);
  const clearEmpty = () => setRows(prev => prev.filter(r=>r.memberId.trim()!=="").concat({memberId:""}));
  const downloadTemplate = () => {
    const csv = 'memberId\nM-0001\nM-0002\nM-0003\n';
    const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "member_template.csv";
    a.click();
    URL.revokeObjectURL(a.href);
  };
  const handlePaste = (startIdx, e) => {
    const text = e.clipboardData.getData('text');
    if (!text) return;
    e.preventDefault();
    const tokens = text.replace(/\r/g,"\n").split(/[\n,\t,]+/).map(s=>s.trim()).filter(Boolean);
    if (!tokens.length) return;
    setRows(prev => {
      const next = [...prev];
      for (let i=0; i<tokens.length; i++) {
        const idx = startIdx + i;
        if (idx >= next.length) next.push({memberId:""});
        next[idx] = { memberId: tokens[i] };
      }
      return next;
    });
  };
  const handleKeyDown = (idx, e) => {
    if (!["Enter","ArrowDown","ArrowUp","ArrowLeft","ArrowRight"].includes(e.key)) return;
    e.preventDefault();
    const inputs = tableRef.current.querySelectorAll("input.cellInput");
    const cols = 1;
    const row = idx;
    let targetRow = row;
    if (e.key==="Enter" || e.key==="ArrowDown") targetRow = row+1;
    if (e.key==="ArrowUp") targetRow = Math.max(0,row-1);
    if (targetRow >= rows.length) {
      addRows(1);
      setTimeout(()=>{
        const newInputs = tableRef.current.querySelectorAll("input.cellInput");
        newInputs[targetRow*cols]?.focus();
      }, 50);
      return;
    }
    inputs[targetRow*cols]?.focus();
  };
  const ids = rows.map(r=>r.memberId.trim()).filter(Boolean);
  const uniqueCount = new Set(ids).size;
  const dupCount = ids.length - uniqueCount;
  return (
    <Paper variant="outlined" className="custom-paper slide-in" sx={{ p:3, borderRadius: 3, height: '100%', display: 'flex', flexDirection: 'column' }}>
      <Stack spacing={1.5} sx={{ flex: 1, display: 'flex', flexDirection: 'column' }}>
        <Stack direction="row" alignItems="center" spacing={1} sx={{ mb: 1, flexShrink: 0 }}>
          <span className="material-icons" style={{ color: '#495057' }}>edit</span>
          <Typography variant="h6" sx={{ fontWeight: 600 }}>画面入力</Typography>
        </Stack>
        <Typography variant="body2" color="text.secondary" sx={{ flexShrink: 0 }}>
          セルに入力し、<b>複数行をそのまま貼り付け</b>できます。Enter/矢印で移動、最終行でEnterすると自動で行追加。空行は無視されます。
        </Typography>
        <Box className="tableWrap fullHeight" ref={tableRef} sx={{ flex: 1 }}>
          <Table size="small" aria-label="会員番号入力表" stickyHeader>
            <TableHead>
              <TableRow>
                <TableCell className="rowNum">#</TableCell>
                <TableCell className="mono">memberId</TableCell>
              </TableRow>
            </TableHead>
            <TableBody>
              {rows.map((r, idx) => (
                <TableRow key={idx}>
                  <TableCell className="rowNum">{idx+1}</TableCell>
                  <TableCell>
                  <TextField
                    id={`cell-${idx}`}
                    size="small"
                    placeholder="例: M-0001"
                    value={r.memberId}
                    onChange={e => setCell(idx, e.target.value)}
                    onPaste={e => handlePaste(idx, e)}
                    onKeyDown={e => {
                      if (["Enter","ArrowDown","ArrowUp"].includes(e.key)) {
                        e.preventDefault();
                        let target = idx;
                        if (e.key === "Enter" || e.key === "ArrowDown") {
                          target = idx + 1;
                        } else if (e.key === "ArrowUp") {
                          target = Math.max(0, idx - 1);
                        }
                        if (target >= rows.length) {
                          // 新しい行を追加
                          addRows(1);
                          setTimeout(() => {
                            const el = document.getElementById(`cell-${target}`);
                            el?.focus();
                          }, 0);
                        } else {
                          const el = document.getElementById(`cell-${target}`);
                          el?.focus();
                        }
                      }
                    }}
                    className="cellInput mono"
                  />

                  </TableCell>
                </TableRow>
              ))}
            </TableBody>
          </Table>
        </Box>
        <Stack direction="row" spacing={1} flexWrap="wrap" sx={{ flexShrink: 0, mt: 2 }}>
          <Button onClick={()=>addRows(10)} startIcon={<span className="material-icons">add</span>}>行を10行追加</Button>
          <Button onClick={clearEmpty} startIcon={<span className="material-icons">filter_alt</span>}>空行を削除</Button>
          <Button onClick={downloadTemplate} startIcon={<span className="material-icons">download</span>}>テンプレートCSV</Button>
          <Box sx={{ flexGrow:1 }} />
          <Chip label={`入力件数: ${ids.length}`} />
          <Chip color={dupCount>0 ? "warning" : "default"} label={`重複: ${dupCount}`} />
          <Button variant="contained" disabled={ids.length===0} onClick={()=>onSubmit(ids)} startIcon={<span className="material-icons">send</span>}>
            取得申請を作成
          </Button>
        </Stack>
      </Stack>
    </Paper>
  );
};
const FileUploadPanel = ({ onSubmit }) => {
  const [dragOver, setDragOver] = React.useState(false);
  const [ids, setIds] = React.useState([]);

  const parseIds = (text) => {
    const lines = text.replace(/\r/g, "\n").split("\n").filter(l=>l!=="");
    if (!lines.length) return [];
    const first = lines[0];
    const isCSV = first.includes(",");
    const isTSV = first.includes("\t");
    let vals = [];
    if (isCSV || isTSV) {
      const sep = isCSV ? "," : "\t";
      const header = first.split(sep).map(s=>s.trim().toLowerCase());
      const idx = header.findIndex(h => ["memberid","member_id","会員id","会員番号","会員ナンバー","id"].includes(h));
      const startRow = idx>=0 ? 1 : 0;
      const col = idx>=0 ? idx : 0;
      for (let i=startRow; i<lines.length; i++) {
        const cols = lines[i].split(sep);
        const raw = (cols[col] ?? "").trim().replace(/^"+|"+$/g, "");
        if (raw) vals.push(raw);
      }
    } else {
      vals = lines.map(s=>s.trim());
    }
    return Array.from(new Set(vals.filter(Boolean)));
  };

  const handleFiles = async (file) => {
    if (!file) return;
    const text = await file.text();
    const list = parseIds(text);
    setIds(list);
  };

  const onDrop = (e) => {
    e.preventDefault();
    setDragOver(false);
    const file = e.dataTransfer.files?.[0];
    handleFiles(file);
  };

  const [fileInput, setFileInput] = React.useState();

  return (
    <Paper variant="outlined" className="custom-paper slide-in" sx={{ p:3, borderRadius: 3 }}>
      <Stack spacing={1.5}>
        <Stack direction="row" alignItems="center" spacing={1} sx={{ mb: 1 }}>
          <span className="material-icons" style={{ color: '#495057' }}>cloud_upload</span>
          <Typography variant="h6" sx={{ fontWeight: 600 }}>ファイルアップロード</Typography>
        </Stack>
        <Typography variant="body2" color="text.secondary">
          CSV / TSV / 改行区切り（UTF-8）。ヘッダー名の例：<code className="mono">memberId</code> / <code className="mono">会員番号</code>など。
        </Typography>
        <Box
          className={`dropzone ${dragOver ? "dragover" : ""}`}
          onDragOver={(e)=>{e.preventDefault(); setDragOver(true);}}
          onDragLeave={()=>setDragOver(false)}
          onDrop={onDrop}
          role="group"
          aria-label="ファイルドロップ領域"
        >
          <Stack spacing={1} alignItems="center">
            <span className="material-icons">file_upload</span>
            <Typography>ここにファイルをドラッグ＆ドロップ</Typography>
            <Typography variant="caption" color="text.secondary">または</Typography>
            <Button variant="outlined" onClick={()=>fileInput?.click()} startIcon={<span className="material-icons">upload_file</span>}>
              ファイルを選択
            </Button>
            <input
              ref={r=>setFileInput(r)}
              type="file" accept=".csv,.tsv,.txt"
              onChange={(e)=>handleFiles(e.target.files?.[0])}
              style={{ display:"none" }}
            />
          </Stack>
        </Box>

        {!!ids.length && (
          <Paper variant="outlined" className="tableWrap">
            <Table size="small" aria-label="読み込みプレビュー">
              <TableHead>
                <TableRow>
                  <TableCell className="mono">memberId</TableCell>
                </TableRow>
              </TableHead>
              <TableBody>
                {ids.map((id, i)=>(
                  <TableRow key={id+i}><TableCell className="mono">{id}</TableCell></TableRow>
                ))}
              </TableBody>
            </Table>
          </Paper>
        )}

        <Stack direction="row" spacing={1}>
          <Button variant="outlined" onClick={()=>setIds([])} startIcon={<span className="material-icons">clear_all</span>} disabled={!ids.length}>クリア</Button>
          <Box sx={{ flexGrow:1 }} />
          <Chip label={`読み込み件数: ${ids.length}`} />
          <Button variant="contained" disabled={!ids.length} onClick={()=>onSubmit(ids)} startIcon={<span className="material-icons">send</span>}>
            取得申請を作成
          </Button>
        </Stack>
      </Stack>
    </Paper>
  );
};

const RequestsPanel = ({ requests, onApprove, onReject, onExport, onExpandToggle }) => {
  const pending = requests.filter(r=>r.status==="申請中").length;
  return (
    <Paper variant="outlined" className="custom-paper slide-in" sx={{ p:3, borderRadius: 3, height: '100%', display: 'flex', flexDirection: 'column' }}>
      <Stack spacing={1.5} sx={{ flex: 1, display: 'flex', flexDirection: 'column' }}>
        <Stack direction="row" alignItems="center" spacing={2} sx={{ mb: 2, flexShrink: 0 }}>
          <Stack direction="row" alignItems="center" spacing={1}>
            <span className="material-icons" style={{ color: '#495057' }}>assignment</span>
            <Typography variant="h6" sx={{ fontWeight: 600 }}>申請一覧</Typography>
          </Stack>
          <Chip 
            label={`承認待ち: ${pending}`} 
            color={pending > 0 ? "warning" : "default"}
            className="status-chip"
            size="small"
          />
        </Stack>
        <div className="tableWrap fullHeight" style={{ flex: 1 }}>
          <Table size="small" aria-label="申請一覧" stickyHeader>
            <TableHead>
              <TableRow>
                <TableCell>申請ID</TableCell>
                <TableCell>作成日時</TableCell>
                <TableCell>方式</TableCell>
                <TableCell align="right">対象件数</TableCell>
                <TableCell>状態</TableCell>
                <TableCell>操作</TableCell>
              </TableRow>
            </TableHead>
            <TableBody>
              {requests.map(req=>(
                <React.Fragment key={req.id}>
                  <TableRow hover>
                    <TableCell className="mono">{req.id}</TableCell>
                    <TableCell>{fmtDateTime(req.createdAt)}</TableCell>
                    <TableCell>{req.source === "manual" ? "画面入力" : "ファイル"}</TableCell>
                    <TableCell align="right">{req.memberIds.length}</TableCell>
                    <TableCell>
                      <Stack direction="row" spacing={1} alignItems="center">
                        <Chip size="small" color={
                          req.status==="申請中" ? "default" :
                          req.status==="承認済み(未実行)" ? "info" :
                          req.status==="実行中" ? "warning" :
                          req.status==="実行済み" ? "success" : "error"
                        } label={req.status} />
                        {typeof req.progress === "number" && req.status!=="実行済み" && (
                          <Typography variant="caption" className="mono">{Math.round(req.progress*100)}%</Typography>
                        )}
                      </Stack>
                    </TableCell>
                    <TableCell>
                      <Stack direction="row" spacing={1} flexWrap="wrap">
                        <Button size="small" onClick={()=>onExpandToggle(req.id)} startIcon={<span className="material-icons">unfold_more</span>}>詳細</Button>
                        {req.status==="申請中" && (
                          <>
                            <Button size="small" onClick={()=>onApprove(req.id)} startIcon={<span className="material-icons">check</span>}>承認（本部）</Button>
                            <Button size="small" color="error" onClick={()=>onReject(req.id)} startIcon={<span className="material-icons">close</span>}>却下</Button>
                          </>
                        )}
                        {req.status==="実行済み" && (
                          <Button size="small" onClick={()=>onExport(req.id)} startIcon={<span className="material-icons">download</span>}>CSV</Button>
                        )}
                      </Stack>
                    </TableCell>
                  </TableRow>
                  <TableRow>
                    <TableCell colSpan={6} sx={{ p:0, border:0 }}>
                      <Collapse in={!!req.expanded} unmountOnExit>
                        <Box sx={{ p:2, bgcolor: 'action.hover' }}>
                          {req.status==="実行中" && (
                            <Box sx={{ mb:2 }}>
                              <LinearProgress variant="determinate" value={Math.round((req.progress||0)*100)} />
                              <Typography variant="caption" color="text.secondary">実行中…</Typography>
                            </Box>
                          )}
                          {(req.results?.length>0) ? (
                            <div className="tableWrap">
                              <Table size="small">
                                <TableHead>
                                  <TableRow>
                                    <TableCell className="mono">memberId</TableCell>
                                    <TableCell>名前</TableCell>
                                    <TableCell>電話番号</TableCell>
                                    <TableCell>住所</TableCell>
                                    <TableCell>ステータス</TableCell>
                                  </TableRow>
                                </TableHead>
                                <TableBody>
                                  {req.results.map((r,i)=>(
                                    <TableRow key={r.memberId + i}>
                                      <TableCell className="mono">{r.memberId}</TableCell>
                                      <TableCell>{r.name || "-"}</TableCell>
                                      <TableCell>{r.phone || "-"}</TableCell>
                                      <TableCell>{r.address || "-"}</TableCell>
                                      <TableCell>
                                        <Chip size="small" color={r.status==="OK" ? "success" : "warning"} label={r.status} />
                                      </TableCell>
                                    </TableRow>
                                  ))}
                                </TableBody>
                              </Table>
                            </div>
                          ) : (
                            <Typography variant="body2" className="muted">結果はまだありません。</Typography>
                          )}
                        </Box>
                      </Collapse>
                    </TableCell>
                  </TableRow>
                </React.Fragment>
              ))}
              {requests.length===0 && (
                <TableRow><TableCell colSpan={6} align="center">申請はまだありません。</TableCell></TableRow>
              )}
            </TableBody>
          </Table>
        </div>
      </Stack>
    </Paper>
  );
};

const MemberPage = ({ goHome }) => {
  const [tab, setTab] = React.useState(0); // 0: 申請状況
  const [sheetRows, setSheetRows] = React.useState([]);
  const [requests, setRequests] = React.useState([]);
  const [snack, setSnack] = React.useState(null);

  const createRequest = (ids, source) => {
    const memberIds = Array.from(new Set(ids.map(s=>s.trim()).filter(Boolean)));
    if (memberIds.length === 0) {
      setSnack({severity:"warning", msg:"会員番号がありません。"});
      return;
    }
    const req = {
      id: uid(),
      createdAt: Date.now(),
      source,
      memberIds,
      status: "申請中",
      results: [],
      progress: undefined,
      expanded: true
    };
    setRequests(prev => [req, ...prev]);
    setSnack({severity:"success", msg:`取得申請を作成しました（${memberIds.length}件）。`});
    setTab(0);
  };

  const executeRequest = async (reqId) => {
    setRequests(prev => prev.map(r => r.id===reqId ? { ...r, status:"実行中", progress:0, results:[] } : r));
    const req = requests.find(r=>r.id===reqId);
    if (!req) return;
    const total = req.memberIds.length;
    const results = [];
    for (let i=0; i<total; i++) {
      const id = req.memberIds[i];
      const data = await lookupMember(id);
      if (data) {
        results.push({ memberId: id, ...data, status: "OK" });
      } else {
        results.push({ memberId: id, name:"", phone:"", address:"", status: "NOT_FOUND" });
      }
      const p = (i+1)/total;
      setRequests(prev => prev.map(r => r.id===reqId ? { ...r, progress: p } : r));
    }
    setRequests(prev => prev.map(r => r.id===reqId ? { ...r, status:"実行済み", progress:1, results } : r));
    setSnack({severity:"success", msg:"取得が完了しました。"});
  };

  const approve = (reqId) => {
    setRequests(prev => prev.map(r => r.id===reqId ? { ...r, status:"承認済み(未実行)" } : r));
    setTimeout(()=>executeRequest(reqId), 300);
  };

  const reject = (reqId) => {
    setRequests(prev => prev.map(r => r.id===reqId ? { ...r, status:"却下" } : r));
    setSnack({severity:"info", msg:"申請を却下しました。"});
  };

  const exportCSV = (reqId) => {
    const req = requests.find(r=>r.id===reqId);
    if (!req || !req.results?.length) return;
    const header = ["memberId","name","phone","address","status"];
    const csv = [header.join(",")].concat(
      req.results.map(x => [x.memberId, x.name, x.phone, x.address, x.status]
        .map(v => `"${String(v??"").replace(/"/g,'""')}"`).join(","))
    ).join("\n");
    const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `member_results_${req.id}.csv`;
    a.click();
    URL.revokeObjectURL(a.href);
  };

  const toggleExpand = (reqId) => setRequests(prev => prev.map(r => r.id===reqId ? ({...r, expanded: !r.expanded}) : r));

  return (
    <Container maxWidth="lg" sx={{ py:2, px: { xs: 2, sm: 3 }, height: '100%', display: 'flex', flexDirection: 'column' }}>
      <Stack direction="row" spacing={1} alignItems="center" sx={{ mb: 1, flexShrink: 0 }}>
        <Button onClick={goHome} startIcon={<span className="material-icons">arrow_back</span>}>戻る</Button>
        <Typography variant="h5">会員情報取得</Typography>
      </Stack>
      <Tabs value={tab} onChange={(e,v)=>setTab(v)} sx={{ mb:2, flexShrink: 0 }}>
        <Tab label="申請状況" />
        <Tab label="画面入力" />
        <Tab label="ファイルアップロード" />
      </Tabs>
      <Box sx={{ flex: 1, display: 'flex', flexDirection: 'column' }}>
        {tab===0 && (
          <RequestsPanel
            requests={requests}
            onApprove={approve}
            onReject={reject}
            onExport={exportCSV}
            onExpandToggle={toggleExpand}
          />
        )}
        {tab===1 && (
          <SpreadsheetInput
            value={sheetRows}
            onChange={setSheetRows}
            onSubmit={(ids)=>createRequest(ids, "manual")}
          />
        )}
        {tab===2 && (
          <FileUploadPanel onSubmit={(ids)=>createRequest(ids, "file")} />
        )}
      </Box>
      <Snackbar open={!!snack} autoHideDuration={2500} onClose={()=>setSnack(null)} anchorOrigin={{ vertical:'bottom', horizontal:'center' }}>
        <Alert severity={snack?.severity||"info"} variant="filled" onClose={()=>setSnack(null)}>
          {snack?.msg}
        </Alert>
      </Snackbar>
    </Container>
  );
};

const Footer = () => (
  <Box component="footer" sx={{ 
    mt: 'auto', 
    py: 3, 
    px: 2, 
    background: 'linear-gradient(135deg, #343a40 0%, #495057 100%)',
    color: 'white'
  }}>
    <Container maxWidth="lg">
      <Stack direction={{ xs: 'column', sm: 'row' }} spacing={2} justifyContent="space-between" alignItems="center">
        <Stack direction="row" spacing={2} alignItems="center">
          <Typography variant="body2" sx={{ fontWeight: 600 }}>
            © 2024 ポータルシステム
          </Typography>
          <Divider orientation="vertical" flexItem sx={{ bgcolor: 'rgba(255,255,255,0.3)' }} />
          <Typography variant="body2" color="rgba(255,255,255,0.8)">
            Version 1.0.0
          </Typography>
        </Stack>
        <Stack direction="row" spacing={2}>
          <Button size="small" sx={{ color: 'rgba(255,255,255,0.8)' }} startIcon={<span className="material-icons">help</span>}>
            ヘルプ
          </Button>
          <Button size="small" sx={{ color: 'rgba(255,255,255,0.8)' }} startIcon={<span className="material-icons">contact_support</span>}>
            サポート
          </Button>
        </Stack>
      </Stack>
    </Container>
  </Box>
);

const Home = ({ goMember, pendingCount }) => (
  <Container maxWidth="lg" sx={{ py:4, px: { xs: 2, sm: 3 } }}>
    <NotificationCenter pendingCount={pendingCount} onGoRequests={goMember} />
    <Stack direction="row" alignItems="center" spacing={1} sx={{ mb: 3 }}>
      <span className="material-icons" style={{ color: '#495057', fontSize: 28 }}>apps</span>
      <Typography variant="h4" sx={{ fontWeight: 700, color: '#212529' }}>各サービス</Typography>
    </Stack>
    <Grid container spacing={3}>
      <ShortcutCard
        title="カード管理"
        subtitle="カード発行・停止・履歴の確認"
        icon="credit_card"
        href="https://example.com/cards"
      />
      <ShortcutCard
        title="会員情報メンテナンス"
        subtitle="会員属性・連絡先・ランクの更新"
        icon="manage_accounts"
        href="https://example.com/member/edit"
      />
      <ShortcutCard
        title="会員情報取得"
        subtitle="番号リストから照会（申請フロー）"
        icon="person_search"
        onClick={(e)=>{ e.preventDefault?.(); goMember(); }}
      />
    </Grid>
  </Container>
);

const App = () => {
  const theme = createTheme({
    palette: {
      mode: 'light',
      primary: {
        main: '#495057',
        light: '#6c757d',
        dark: '#343a40',
      },
      secondary: {
        main: '#6c757d',
        light: '#adb5bd',
        dark: '#495057',
      },
      success: {
        main: '#10b981',
        light: '#34d399',
        dark: '#059669',
      },
      warning: {
        main: '#f59e0b',
        light: '#fbbf24',
        dark: '#d97706',
      },
      error: {
        main: '#ef4444',
        light: '#f87171',
        dark: '#dc2626',
      },
      background: {
        default: '#f8f9fa',
        paper: '#ffffff',
      },
    },
    typography: {
      fontFamily: '"Roboto", "Helvetica Neue", Arial, sans-serif',
      h4: {
        fontWeight: 700,
        letterSpacing: '-0.02em',
      },
      h5: {
        fontWeight: 600,
        letterSpacing: '-0.01em',
      },
      h6: {
        fontWeight: 600,
      },
      subtitle1: {
        fontWeight: 600,
        letterSpacing: '0.01em',
      },
    },
    shape: {
      borderRadius: 12,
    },
    components: {
      MuiCard: {
        styleOverrides: {
          root: {
            background: 'linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%)',
            border: '1px solid #dee2e6',
            boxShadow: '0 4px 16px rgba(0, 0, 0, 0.08)',
            transition: 'all 0.3s ease',
            '&:hover': {
              boxShadow: '0 8px 24px rgba(0, 0, 0, 0.15)',
              transform: 'translateY(-4px)',
              background: 'linear-gradient(135deg, #ffffff 0%, #f1f3f4 100%)',
            },
          },
        },
      },
      MuiPaper: {
        styleOverrides: {
          root: {
            background: '#ffffff',
            border: '1px solid #dee2e6',
          },
        },
      },
      MuiButton: {
        styleOverrides: {
          root: {
            textTransform: 'none',
            fontWeight: 600,
            borderRadius: 8,
            padding: '8px 16px',
          },
          contained: {
            boxShadow: '0 2px 4px rgba(0, 0, 0, 0.1)',
            '&:hover': {
              boxShadow: '0 4px 8px rgba(0, 0, 0, 0.15)',
            },
          },
        },
      },
      MuiChip: {
        styleOverrides: {
          root: {
            fontWeight: 600,
            borderRadius: 6,
          },
        },
      },
      MuiAppBar: {
        styleOverrides: {
          root: {
            background: 'linear-gradient(135deg, #343a40 0%, #495057 100%)',
            boxShadow: '0 4px 16px rgba(0, 0, 0, 0.15)',
          },
        },
      },
    },
  });
  const [route, setRoute] = React.useState(location.hash.replace('#','') || '/');
  const go = (path) => { location.hash = path; };
  React.useEffect(()=>{
    const onHash = () => setRoute(location.hash.replace('#','') || '/');
    addEventListener('hashchange', onHash);
    return () => removeEventListener('hashchange', onHash);
  }, []);
  const [requests, setRequests] = React.useState([]);
  const pendingCount = requests.filter(r=>r.status==="申請中").length;
  return (
    <ThemeProvider theme={theme}>
      <CssBaseline />
      <Box sx={{ display: 'flex', flexDirection: 'column', minHeight: '100vh' }}>
        <AppBar position="sticky" elevation={1}>
          <Toolbar>
            <Typography variant="h6" sx={{ flexGrow: 1 }}>ポータル</Typography>
            <Tooltip title="通知">
              <IconButton color="inherit" size="large">
                <Badge color="error" badgeContent={pendingCount}>
                  <span className="material-icons">notifications</span>
                </Badge>
              </IconButton>
            </Tooltip>
          </Toolbar>
        </AppBar>
        <Box sx={{ flex: 1 }}>
          {route === '/' && <Home goMember={()=>go('/member')} pendingCount={pendingCount} />}
          {route === '/member' && <MemberPage goHome={()=>go('/')} />}
        </Box>
        <Footer />
      </Box>
    </ThemeProvider>
  );
};

ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
</script>
</body>
</html>
