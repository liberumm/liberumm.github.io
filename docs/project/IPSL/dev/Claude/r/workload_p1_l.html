<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>納品数配分システム</title>
    <!-- React & ReactDOM CDN -->
    <script src="https://unpkg.com/react@17/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.production.min.js"></script>

    <!-- MUI CoreのCSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@mui/material@5.13.0/umd/material-ui.development.css">
    <!-- MUI CoreのJS -->
    <script src="https://cdn.jsdelivr.net/npm/@mui/material@5.13.0/umd/material-ui.development.js" crossorigin></script>
    
    <!-- XLSX (for Excel/CSV export) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.16.9/xlsx.full.min.js"></script>
</head>

<body>
    <div id="root"></div>
    <script>
        const { useState, useEffect } = React;
        const { theme, isMobile , useMediaQuery, useTheme, Button, ButtonGroup, Container, Grid, TextField, Typography, Box, Table, TableHead, TableBody, TableRow, TableCell, TableContainer, Paper, Checkbox, Tabs, Tab, Menu, MenuItem, Select, AppBar, Toolbar, IconButton, Slider } = MaterialUI;

        // このオブジェクトは、テーブルの各列に対して適切な幅を指定します。
        // 各プロパティは列の名前で、その値が幅をピクセル単位で指定しています。
        // 商品リストタブ用の列幅を定義するオブジェクト
        const productColumnWidths = {
            checkbox: "50px",           // チェックボックス列の幅
            no: "50px",                 // No列の幅
            status: "100px",            // ステータス列の幅
            deliveryAvailableDate: "125px", // 納品可能日列の幅
            deliveryDate: "125px",      // 納品日列の幅
            productCode: "125px",       // 商品コード列の幅
            productName: "200px",       // 商品名列の幅
            cost: "75px",               // 原価列の幅
            price: "75px",              // 売価列の幅
            profit: "75px",             // 値入（利益）列の幅
            coefficientPattern: "100px", // パターン列の幅
            totalPlanQuantity: "100px", // 総計画数列の幅
            distribution: "100px",      // 配分数列の幅
            unit: "75px",               // 単位列の幅
            minimumQuantity: "100px",   // 最低導入数列の幅
            bulkQuantity: "100px",      // 一括導入数列の幅
            totalPriceAmount: "125px",  // 売価額計列の幅
            totalCostAmount: "125px",   // 原価額計列の幅
            totalPlanPriceAmount: "125px", // 合計売価額列の幅
            totalPlanCostAmount: "125px"  // 合計原価額列の幅
        };

        // 納品数配分タブ用の列幅設定
        const allocationColumnWidths = {
            checkbox: "40px",
            deliveryDate: "130px",
            productCode: "125px",
            productName: "150px",
            cost: "75px",
            price: "75px",
            coefficientPattern: "80px",
            remainingPlan: "80px",
            distribution: "80px",
            totalPriceAmount: "125px",  // 売価額計列の幅
            totalCostAmount: "125px",   // 原価額計列の幅
            unit: "65px",
            minimumQuantity: "65px",
            bulkQuantity: "65px",
            storeName: "65px",
            total: "80px"
        };

        // 店舗係数確認タブ用の列幅設定
        const coefficientColumnWidths = {
            storeCode: "80px",
            storeName: "150px",
            pattern: "80px"  // パターン列の幅を指定
        };

        const rowHeight = 45; // 行の高さ

        const statusOptions = ["配分済", "未配分"];
        const coefficientPatterns = ["パターン1", "パターン2"];
        const years = [2022, 2023, 2024];
        const months = ["1月", "2月", "3月", "4月", "5月", "6月", "7月", "8月", "9月", "10月", "11月", "12月"];
        const periods = ["週", "月", "年"];

        // 商品リストテーブルの各行データを初期化する関数
        const createEmptyRow = (id) => ({
            id: id,                     // 行のID
            selected: false,            // チェックボックスの選択状態
            status: "",                 // ステータス
            deliveryAvailableDate: "",  // 納品可能日
            deliveryDate: "",           // 納品日
            productCode: "",            // 商品コード
            productName: "",            // 商品名
            cost: 0,                    // 原価
            price: 0,                   // 売価
            profit: 0,                  // 値入（利益）
            coefficientPattern: "",     // 係数パターン
            totalPlanQuantity: 0,       // 総計画数
            distribution: 0,            // 配分数
            unit: 1,                   // 単位
            minimumQuantity: 0,         // 最低導入数
            bulkQuantity: 0,            // 一括導入数
            totalPriceAmount: 0,        // 売価額計（配分数×売価）
            totalCostAmount: 0,         // 原価額計（配分数×原価）
            totalPlanPriceAmount: 0,    // 合計売価額（総計画数×売価）
            totalPlanCostAmount: 0      // 合計原価額（総計画数×原価）
        });

        const createEmptyAllocationRow = (id, numberOfStores) => ({
                id: id,
                deliveryDate: '',
                productCode: '',
                productName: '',
                cost: 0,
                price: 0,
                coefficientPattern: '',
                remainingPlan: 0,
                distribution: 0,
                unit: '',
                minimumQuantity: 0,
                bulkQuantity: 0,
                stores: Array(numberOfStores).fill(0),  // numberOfStoresに基づいて初期化
                selected: false
        });

        function createEmptyCoefficientRow(id) {
            return {
                id: id,
                storeCode: "",
                storeName: "",
                pattern1: 0,
                pattern2: 0
            };
        }
        // 週の開始日と終了日を計算する関数
        function getWeekRange(year, month, weekNumber) {
            const startOfYear = new Date(year, 3, 1); // 4月1日
            const dayOfWeek = startOfYear.getDay();
            const daysOffset = (weekNumber - 1) * 7 - dayOfWeek + 1;
            const startDate = new Date(startOfYear);
            startDate.setDate(startOfYear.getDate() + daysOffset);

            const endDate = new Date(startDate);
            endDate.setDate(startDate.getDate() + 6);

            return { startDate, endDate };
        }

        // 月の開始日と終了日を計算する関数
        function getMonthRange(year, month) {
            const startDate = new Date(year, month - 1, 1);
            const endDate = new Date(year, month, 0); // 月末日
            return { startDate, endDate };
        }

        // 年度の開始日と終了日を計算する関数
        function getYearRange(year) {
            const startDate = new Date(year, 3, 1); // 4月1日
            const endDate = new Date(year + 1, 2, 31); // 翌年3月31日
            return { startDate, endDate };
        }

        const App = () => {    
            // タブ管理のステート
            const [activeTab, setActiveTab] = useState(0); // 現在のアクティブなタブのインデックス
            const [filterTab, setFilterTab] = useState(0); // フィルタタブのインデックス

            // 設定セクションの表示/非表示を管理するためのステート
            const [showSettings, setShowSettings] = useState(false);

            // コンポーネントが初めてレンダリングされたときに実行される処理
            useEffect(() => {
                // 現在の日付を取得
                const currentDate = new Date();

                // 現在の日付から7日後の日付を計算
                const futureDate = new Date();
                futureDate.setDate(currentDate.getDate() );

                // 納品日の初期値として7日後の日付をセット
                setStartDate(futureDate.toISOString().split('T')[0]);
            }, []);  // 空の依存配列を渡すことで、この処理はコンポーネントの初回レンダリング時にのみ実行される

            // 納品日の状態を追加
            const [deliveryDate, setDeliveryDate] = useState('');

            // ステートの定義
            const [availableCoefficientPatterns, setAvailableCoefficientPatterns] = useState([]); // 利用可能な係数パターンを保存するステート
            const [storeHeaders, setStoreHeaders] = useState([]); // 店舗ヘッダー情報を管理するステート

            // テーブル関連のステート
            const [rowCount, setRowCount] = useState(10); // テーブルの行数
            const [tableData, setTableData] = useState([createEmptyRow(1)]); // 商品リストのデータ
            const [allocationData, setAllocationData] = useState([]); // 納品数配分データ

            //納品数配分タブ
            const [numberOfStores, setNumberOfStores] = useState(5);  // 店舗列数を管理

            // allocationTableData ステートの定義
            const [allocationTableData, setAllocationTableData] = useState(() => {
                return Array(rowCount).fill().map((_, idx) => createEmptyAllocationRow(idx + 1, numberOfStores));
            });

            const [storeMasterData, setStoreMasterData] = useState([]); // 店舗マスタデータ

            // チェックボックスの選択状態を管理するステート
            const [storeCheckboxState, setStoreCheckboxState] = useState(
                (storeMasterData && storeMasterData.length > 0) 
                    ? Array(storeMasterData.length).fill(true)  // 全てのチェックボックスをfalseで初期化
                    : Array(numberOfStores).fill(true)  // numberOfStoresが使用される場合もfalseで初期化
            );

            // ソートとフィルタのステート
            const [sortConfig, setSortConfig] = useState({ key: null, direction: 'ascending' }); // ソート設定
            const [filters, setFilters] = useState({}); // フィルタ条件

            // 係数データのステート
            const [coefficientData, setCoefficientData] = useState([createEmptyCoefficientRow(1)]); // 店舗係数データ

            const [patternHeaders, setPatternHeaders] = useState([]);  // パターン名を格納

            // ステートの定義部分 (Reactコンポーネントの他のuseStateと一緒に)
            const [showMasterImportControls, setShowMasterImportControls] = useState(false); 

            // 月度の選択肢
            const months = ["選択しない", "1月", "2月", "3月", "4月", "5月", "6月", "7月", "8月", "9月", "10月", "11月", "12月"];

            // 週の選択肢
            const weeks = ["選択しない", ...Array.from({ length: 52 }).map((_, i) => `${i + 1}`)];

            // 週番号の計算関数
            const getFiscalWeekNumber = (date) => {
                const fiscalYearStart = new Date(date.getFullYear(), 3, 1); // 4月1日を年度開始日として設定
                const firstMonday = new Date(fiscalYearStart);

                // 4月1日が含まれる週を1週目として計算するために、その週の月曜日を探す
                const dayOfWeek = firstMonday.getDay(); // 4月1日の曜日を取得
                firstMonday.setDate(fiscalYearStart.getDate() - dayOfWeek + 1); // 月曜日を特定

                const diffInDays = Math.floor((date - firstMonday) / (1000 * 60 * 60 * 24)); // 月曜日からの経過日数を計算
                return Math.floor(diffInDays / 7) + 1; // 経過日数から週番号を計算
            };
            
            // 週の範囲を計算するサンプル関数
            const getWeekRange = (year, month, week) => {
                const firstDayOfMonth = new Date(year, month - 1, 1);
                const startOfWeek = new Date(firstDayOfMonth.setDate(firstDayOfMonth.getDate() + (week - 1) * 7));
                const endOfWeek = new Date(startOfWeek);
                endOfWeek.setDate(endOfWeek.getDate() + 6);

                return {
                    startDate: startOfWeek,
                    endDate: endOfWeek
                };
            };

            // 週番号に基づいて開始日と終了日を計算する関数
            const calculateWeekRange = (year, week) => {
                // 年度の4月1日を基準として、その年の最初の月曜日を特定
                const fiscalYearStart = new Date(year, 3, 1); // 4月1日
                const dayOfWeek = fiscalYearStart.getDay();
                const firstMonday = new Date(fiscalYearStart);
                firstMonday.setDate(fiscalYearStart.getDate() + (1 - dayOfWeek + 7) % 7);

                // 指定された週番号に基づいて週の開始日と終了日を計算
                const startOfWeek = new Date(firstMonday);
                startOfWeek.setDate(firstMonday.getDate() + (week - 1) * 7);
                const endOfWeek = new Date(startOfWeek);
                endOfWeek.setDate(startOfWeek.getDate() + 6);

                // 日付が有効かどうかをチェック
                if (isNaN(startOfWeek.getTime()) || isNaN(endOfWeek.getTime())) {
                    throw new Error('Invalid date generated');
                }

                return { startDate: startOfWeek, endDate: endOfWeek };
            };

            // 月度に基づいて開始日と終了日を計算する関数
            const getMonthRange = (year, month) => {
                const startDate = new Date(year, month - 1, 1 + 1); // 月の初日
                const endDate = new Date(year, month, 1); // 月の最終日
                return { startDate, endDate };
            };

            // 年度全体の期間を計算する関数
            const getYearRange = (year) => {
                const startDate = new Date(year, 3, 1); // 4月1日
                const endDate = new Date(year + 1, 2, 31); // 翌年の3月31日
                return { startDate, endDate };
            };

            // 年度や期間の設定ステート
            const currentDate = new Date();
            const [year, setYear] = useState(new Date().getFullYear());
            const [month, setMonth] = useState("選択しない");
            const [weekNumber, setWeekNumber] = useState("選択しない");
            const [startDate, setStartDate] = useState("");
            const [endDate, setEndDate] = useState("");
            const [location, setLocation] = useState("");
            const [department, setDepartment] = useState("");
            const [period, setPeriod] = useState("年");

            // テーマやレスポンシブ対応のためのフック
            // AppBar用のState
            const [anchorEl, setAnchorEl] = useState(null);
            const theme = useTheme();
            const isMobile = useMediaQuery(theme.breakpoints.down("sm"));

            // 現在の日時を yyyymmddHHMMSS 形式で取得する関数
            const getFormattedDate = () => {
                const now = new Date();
                const year = now.getFullYear();
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const day = String(now.getDate()).padStart(2, '0');
                const hours = String(now.getHours()).padStart(2, '0');
                const minutes = String(now.getMinutes()).padStart(2, '0');
                const seconds = String(now.getSeconds()).padStart(2, '0');
                return `${year}${month}${day}${hours}${minutes}${seconds}`;
            };

            // Excelファイルとして配分データをエクスポートする関数
            const exportToExcel = async () => {
                const worksheetData = allocationData.map(row => ({
                    "納品日": row.deliveryDate,
                    "商品コード": row.productCode,
                    "商品名": row.productName,
                    "原価": row.cost,
                    "売価": row.price,
                    "係数パターン": row.coefficientPattern,
                    "計画残数": row.remainingPlan,
                    "配分数": row.distribution,
                    "単位": row.unit,
                    "最低導入数": row.minimumQuantity,
                    "一括導入数": row.bulkQuantity,
                    "合計": row.total,
                    ...row.stores.reduce((acc, val, i) => ({ ...acc, [`店舗${i + 1}`]: val }), {})
                }));

                const worksheet = XLSX.utils.json_to_sheet(worksheetData);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "納品数配分");

                const defaultFileName = `配分データ_${getFormattedDate()}.xlsx`;

                const fileHandle = await window.showSaveFilePicker({
                    suggestedName: defaultFileName,
                    types: [{
                        description: 'Excel Files',
                        accept: {'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet': ['.xlsx']}
                    }]
                });

                const writableStream = await fileHandle.createWritable();
                const buffer = XLSX.write(workbook, { bookType: 'xlsx', type: 'array' });
                await writableStream.write(buffer);
                await writableStream.close();
            };

            // CSVファイルとして配分データをエクスポートする関数
            const exportToCsv = async () => {
                const header = [
                    "納品日", "商品コード", "商品名", "原価", "売価", "係数パターン", "計画残数", "配分数", "単位", "最低導入数", "一括導入数", "合計",
                    ...Array.from({ length: numberOfStores }).map((_, i) => `店舗${i + 1}`)
                ];

                const rows = allocationData.map(row => [
                    row.deliveryDate, row.productCode, row.productName, row.cost, row.price, row.coefficientPattern,
                    row.remainingPlan, row.distribution, row.unit, row.minimumQuantity, row.bulkQuantity, row.total,
                    ...row.stores
                ]);

                const csvContent = [header, ...rows].map(e => e.join(",")).join("\n");

                const defaultFileName = `配分データ_${getFormattedDate()}.csv`;

                const fileHandle = await window.showSaveFilePicker({
                    suggestedName: defaultFileName ,
                    types: [{
                        description: 'CSV Files',
                        accept: {'text/csv': ['.csv']}
                    }]
                });

                const writableStream = await fileHandle.createWritable();
                await writableStream.write(new Blob([csvContent], { type: "text/csv;charset=utf-8;" }));
                await writableStream.close();
            };

            // 選択された行を削除する関数
            const handleDeleteSelectedRows = () => {
                // 選択されていない行だけを残すようにデータをフィルタリング
                const updatedTableData = tableData.filter(row => !row.selected);
                setTableData(updatedTableData); // 更新されたデータをステートにセット
            };

            // 店舗/部署および部門の選択肢リストを定義します。
            // これらはユーザーがドロップダウンから選択できる選択肢です。
            const locations = [
                "全社",   // 例: 東京本店
                "東京本店",   // 例: 東京本店
                "大阪支店",   // 例: 大阪支店
                "名古屋支店", // 例: 名古屋支店
                "福岡支店"    // 例: 福岡支店
            ];

            const departments = [
                "全部門",   // 例: 営業部
                "営業部",   // 例: 営業部
                "企画部",   // 例: 企画部
                "開発部",   // 例: 開発部
                "総務部"    // 例: 総務部
            ];

            useEffect(() => {
                // storeMasterDataが変更されたときにコンポーネントが再レンダリングされる
            }, [storeMasterData]);

            // 年度、月度、週番号の選択によって開始日と終了日を更新する処理
            useEffect(() => {
                let newStartDate, newEndDate;

                try {
                    if (weekNumber !== "選択しない" && weekNumber) {
                        // 週が選択されている場合、週に対応する開始日と終了日を設定
                        const { startDate, endDate } = calculateWeekRange(year, parseInt(weekNumber, 10));
                        newStartDate = startDate;
                        newEndDate = endDate;
                        // 月度も自動で設定
                        setMonth(`${startDate.getMonth() + 1}月`);
                    } else if (month !== "選択しない" && month) {
                        // 月度が選択されている場合、月に対応する開始日と終了日を設定
                        const { startDate, endDate } = getMonthRange(year, parseInt(month.replace('月', ''), 10));
                        newStartDate = startDate;
                        newEndDate = endDate;
                    } else {
                        // 年度のみが選択されている場合、年度全体の期間を設定
                        const { startDate, endDate } = getYearRange(year);
                        newStartDate = startDate;
                        newEndDate = endDate;
                    }

                    // ステートを更新する前に有効な日付かチェック
                    if (isNaN(newStartDate.getTime()) || isNaN(newEndDate.getTime())) {
                        throw new Error('Invalid date calculated');
                    }

                    // ステートを更新
                    setStartDate(newStartDate.toISOString().split('T')[0]);
                    setEndDate(newEndDate.toISOString().split('T')[0]);

                } catch (error) {
                    console.error("Error setting date range:", error);
                }
            }, [year, month, weekNumber]);

            // ページ読み込み時に年度、月度、週を自動設定する処理
            useEffect(() => {
                const currentYear = currentDate.getFullYear(); // 現在の年を取得
                const currentMonth = `${currentDate.getMonth() + 1}月`; // 現在の月を "X月" 形式で取得
                const currentWeekNumber = getFiscalWeekNumber(currentDate); // 現在の週番号を計算

                setYear(currentYear); // 年度をセット
                setMonth(currentMonth); // 月度をセット
                setWeekNumber(currentWeekNumber); // 週番号をセット

                let newStartDate, newEndDate;

                // 週が選択されている場合の期間設定
                const { startDate: weekStartDate, endDate: weekEndDate } = getWeekRange(currentYear, currentDate.getMonth() + 1, currentWeekNumber);
                newStartDate = weekStartDate; // 週の開始日を設定
                newEndDate = weekEndDate; // 週の終了日を設定

                setStartDate(newStartDate.toISOString().split('T')[0]); // 開始日をステートに設定
                setEndDate(newEndDate.toISOString().split('T')[0]); // 終了日をステートに設定
            }, []); // 空配列を渡しているため、コンポーネントの初回レンダリング時にのみ実行

            // デフォルト行数を設定
            useEffect(() => {
                if (activeTab === 1) {
                    setAllocationData(Array(rowCount).fill().map((_, idx) => createEmptyRow(idx + 1)));
                }
            }, [activeTab, rowCount]);

            // 商品行数や店舗列数が変更された際にテーブルデータを初期化するためのuseEffectフック
            useEffect(() => {
                // rowCount（行数）に基づいてallocationDataを初期化する
                const initialData = Array(rowCount).fill().map((_, idx) => ({
                    id: idx + 1,
                    selected: false, // 行の選択状態を管理するフラグ
                    deliveryDate: "", // 納品日
                    productCode: "",  // 商品コード
                    productName: "",  // 商品名
                    cost: 0,          // 原価
                    price: 0,         // 売価
                    coefficientPattern: "", // 係数パターン
                    remainingPlan: 0,       // 計画残数
                    distribution: 0,        // 配分数
                    unit: 1,               // 単位
                    minimumQuantity: 0,     // 最低導入数
                    bulkQuantity: 0,        // 一括導入数
                    stores: Array(numberOfStores).fill(0), // 店舗ごとの配分数を格納する配列
                    total: 0  // 合計（確認用）
                }));

                // 初期化したデータをallocationDataステートにセットする
                setAllocationData(initialData);
            }, [rowCount, numberOfStores]); // rowCountまたはnumberOfStoresが変更されるたびに実行


            // 納品数配分タブがアクティブになったとき、または店舗数が変更されたときにテーブルデータを再初期化します。
            useEffect(() => {
                if (activeTab === 1) {  // 現在アクティブなタブが納品数配分タブであるかをチェック
                    // 既存のテーブルデータを元に、新しいデータを生成します。
                    setAllocationTableData((prevData) =>
                        prevData.map(row => ({
                            ...row,  // 既存の行データをスプレッド演算子でコピー
                            // 店舗数が変更された場合、新しい店舗数に合わせてstores配列を再設定します。
                            stores: row.stores.length === numberOfStores ? row.stores : Array(numberOfStores).fill(0)
                        }))
                    );
                }
            }, [activeTab, numberOfStores]);  // タブが切り替わったとき、または店舗数が変更されたときに再実行されます。

            //納品日
            useEffect(() => {
                const currentDate = new Date();
                const futureDate = new Date();
                futureDate.setDate(currentDate.getDate() + 7);
                setDeliveryDate(futureDate.toISOString().split('T')[0]);
            }, []);

            // 店舗数が増減した際に storeCheckboxState を更新する useEffect フック
            useEffect(() => {
                setStoreCheckboxState((prevState) => {
                    // 以前の状態と新しい店舗数が一致しているか確認
                    if (prevState.length === numberOfStores) {
                        return prevState;
                    }

                    // 新しい店舗数に合わせて配列を更新
                    const newState = [...prevState];
                    if (newState.length < numberOfStores) {
                        // 店舗数が増えた場合、新しい店舗分を追加（デフォルトは true）
                        return newState.concat(Array(numberOfStores - newState.length).fill(true));
                    } else if (newState.length > numberOfStores) {
                        // 店舗数が減った場合、余分な店舗分を削除
                        return newState.slice(0, numberOfStores);
                    }
                    return newState;
                });
            }, [numberOfStores]);

            // タブの切り替えを処理する関数
            const handleTabChange = (event, newValue) => {
                setActiveTab(newValue); // 新しいタブのインデックスをactiveTabステートにセット
            };

            // 納品数配分タブがアクティブになったとき、既存のデータを再利用し、必要に応じて再初期化する

            // フィルタタブの切り替え
            const handleFilterTabChange = (event, newValue) => {
                setFilterTab(newValue);
            };

            // 月度が変更されたときの処理
            const handleMonthChange = (e) => {
                    const newMonth = e.target.value;

                    // 月度を更新
                    setMonth(newMonth);

                    // 週を「選択しない」にリセット
                    setWeekNumber("選択しない");

                    // 新しい月に基づいて期間を再計算
                    const { startDate, endDate } = getMonthRange(year, parseInt(newMonth.replace('月', ''), 10));
                    setStartDate(startDate.toISOString().split('T')[0]);
                    setEndDate(endDate.toISOString().split('T')[0]);
            };

            // 行数変更時の処理
            const handleRowCountChange = (value) => {
                const count = parseInt(value, 10);
                setRowCount(count);
                const newAllocationData = [...allocationData];
                if (count > allocationData.length) {
                    while (newAllocationData.length < count) {
                        newAllocationData.push(createEmptyRow(newAllocationData.length + 1));
                    }
                } else if (count < allocationData.length) {
                    newAllocationData.length = count;
                }
                setAllocationData(newAllocationData);
            };

            // 商品リストタブの各行データの処理
            const handleInputChange = (index, field, value) => {
                const newData = [...tableData];
                const row = newData[index];

                // フィールドの値を更新
                row[field] = value;

                // 売価と配分数が有効な数値かどうかをチェックし、合計を計算
                const price = parseFloat(row.price) || 0;
                const distribution = parseFloat(row.distribution) || 0;
                const cost = parseFloat(row.cost) || 0;
                const totalPlanQuantity = parseFloat(row.totalPlanQuantity) || 0;

                row.totalPriceAmount = isNaN(price * distribution) ? 0 : price * distribution;
                row.totalCostAmount = isNaN(cost * distribution) ? 0 : cost * distribution;
                row.totalPlanPriceAmount = isNaN(price * totalPlanQuantity) ? 0 : price * totalPlanQuantity;
                row.totalPlanCostAmount = isNaN(cost * totalPlanQuantity) ? 0 : cost * totalPlanQuantity;

                // 最後の行に入力があった場合、新しい行を追加
                if (index === tableData.length - 1 && value !== "") {
                    newData.push(createEmptyRow(tableData.length + 1));
                }

                setTableData(newData);
            };


            // 配分データの各フィールドの変更を処理する関数
            const handleAllocationInputChange = (index, key, value) => {
                // 現在の配分データをコピー（不変性を保つため）
                const updatedData = [...allocationData];
                const row = updatedData[index];

                // フィールドが "stores" の場合、特別な処理を行う
                if (key === 'stores') {
                    row.stores = value;  // storesを更新
                    row.total = row.stores.reduce((acc, val) => acc + val, 0); // stores配列を合計してtotalにセット
                } else {
                    row[key] = value;  // それ以外のフィールドを更新
                }

                // 最後の行が編集され、かつその値が空でない場合、新しい行を追加
                if (index === allocationData.length - 1 && value !== "") {
                    // 新しい行を生成し、データに追加
                    updatedData.push(createEmptyAllocationRow(updatedData.length + 1, numberOfStores));
                }

                // 更新された配分データをステートにセット
                setAllocationData(updatedData);
            };

            // 係数データの変更
            const handleCoefficientInputChange = (index, field, value) => {
                const newData = [...coefficientData];
                newData[index][field] = value;
                setCoefficientData(newData);
            };

            // 行の選択状態を変更
            const handleSelectRow = (index) => {
                const newData = [...tableData];
                newData[index].selected = !newData[index].selected;
                setTableData(newData);
            };

            // 商品リストから納品数配分タブに選択された商品を転送
            const handleTransferSelectedRows = () => {
                const selectedRows = tableData.filter(row => row.selected);
                setAllocationData([...selectedRows, ...allocationData]);
                setActiveTab(1);
            };

            // フィルタが変更された際に呼び出される関数
            const handleFilterChange = (key, value) => {
                setFilters(prevFilters => ({
                    ...prevFilters,          // 以前のフィルタを維持
                    [key]: value,            // 新しいフィルタ条件を追加または更新
                }));
            };

            // フィルタ条件に基づいてテーブルデータをフィルタリング
            const filteredTableData = tableData.filter(row => {
                for (const key in filters) {
                    // 各フィルタ条件にマッチしない行は除外
                    if (filters[key] && !row[key].toString().includes(filters[key])) {
                        return false;
                    }
                }
                return true;  // すべての条件を満たす行のみを返す
            });

            // ソート処理
            const handleSort = (key) => {
                let direction = 'ascending';
                if (sortConfig.key === key && sortConfig.direction === 'ascending') {
                    direction = 'descending';
                }
                setSortConfig({ key, direction });

                const sortedData = [...tableData].sort((a, b) => {
                    if (a[key] < b[key]) {
                        return direction === 'ascending' ? -1 : 1;
                    }
                    if (a[key] > b[key]) {
                        return direction === 'ascending' ? 1 : -1;
                    }
                    return 0;
                });
                setTableData(sortedData);
            };

            // すべての行に対して一括で納品日を設定する関数
            const setAllDeliveryDates = () => {
                // allocationDataをマップし、すべての行のdeliveryDateをdeliveryDate変数に設定
                const newData = allocationData.map(row => ({ ...row, deliveryDate: deliveryDate }));
                setAllocationData(newData); // 更新されたデータをallocationDataステートにセット
            };

            // すべての行に対して一括で納品日をクリアする関数
            const clearAllDeliveryDates = () => {
                // allocationDataをマップし、すべての行のdeliveryDateをクリア
                const newData = allocationData.map(row => ({ ...row, deliveryDate: '' }));
                setAllocationData(newData); // 更新されたデータをallocationDataステートにセット
            };

            // テーブルのクリア
            // 配分テーブルのデータをクリアする関数
            const clearTable = () => {
                // 行数に基づいてallocationDataを初期化し、全行を空にする
                const clearedData = Array(rowCount).fill().map((_, idx) => ({
                    id: idx + 1,
                    selected: false,
                    deliveryDate: "",
                    productCode: "",
                    productName: "",
                    cost: 0,
                    price: 0,
                    coefficientPattern: "",
                    remainingPlan: 0,
                    distribution: 0,
                    unit: "",
                    minimumQuantity: 0,
                    bulkQuantity: 0,
                    stores: Array(numberOfStores).fill(0),
                    total: 0
                }));
                setAllocationData(clearedData); // クリアしたデータをセット
            };

            const createCoefficientMapFromData = (coefficientData, patternHeaders) => {
                const coefficientMap = {}; // 店舗コードをキーとして、係数を格納するオブジェクト

                coefficientData.forEach((row) => {
                    const storeCode = row.storeCode.trim(); // 店舗コードを取得
                    coefficientMap[storeCode] = {}; // 店舗コードをキーとしてオブジェクトを初期化

                    // 各パターンに対して係数を取得し、coefficientMapに格納
                    patternHeaders.forEach((pattern, index) => {
                        const coefficient = row.patterns[index] || 1; // パターンの値を取得し、無い場合はデフォルトで1
                        coefficientMap[storeCode][pattern] = coefficient;
                    });
                });

                console.log('Coefficient Map from Data:', coefficientMap); // coefficientMapをログに出力
                return coefficientMap;
            };

            // 選択された行または全ての行を配分する関数
            const distributeAllocations = (onlySelected = false) => {
                const coefficientMap = createCoefficientMapFromData(coefficientData, patternHeaders); // Coefficient Mapを生成

                // allocationData内の各行に対して処理を行う
                const distributedData = allocationData.map(row => {
                    // 選択された行だけを処理するための条件分岐
                    if (!onlySelected || (onlySelected && row.selected)) {
                        // storesプロパティが定義されていない場合に備えて初期化
                        if (!row.stores) {
                            row.stores = Array(numberOfStores).fill(0);
                        }

                        // 店舗数を取得
                        const totalStores = row.stores.length;

                        // 係数パターンの指定がある場合は、対応する係数を取得
                        let coefficients;
                        if (row.coefficientPattern && coefficientMap) {
                            coefficients = row.stores.map((store, i) => {
                                const storeCode = storeMasterData[i].storeCode; // 各店舗のコードを取得
                                const storeCoefficient = coefficientMap[storeCode] ? coefficientMap[storeCode][row.coefficientPattern] : 1; // 指定されたパターンに基づく係数を取得
                                console.log(`店舗コード: ${storeCode} の係数 (${row.coefficientPattern}): ${storeCoefficient}`);
                                return storeCoefficient;
                            });
                        } else {
                            coefficients = Array(totalStores).fill(1); // 指定がない場合、係数を1に初期化
                        }

                        // 配分数と単位が有効かどうかをチェック
                        if (row.distribution <= 0 || row.unit <= 0 || isNaN(row.distribution) || isNaN(row.unit)) {
                            console.log(`無効な配分数 (${row.distribution}) または単位 (${row.unit}) のため、計算をスキップします。`);
                            return {
                                ...row,
                                stores: Array(totalStores).fill(0),
                                total: 0
                            };
                        }

                        // 最低導入数が設定されているか確認
                        if (row.minimumQuantity >= 0 && !isNaN(row.minimumQuantity)) {
                            console.log(`最低導入数が設定されています (${row.minimumQuantity})`);

                            // 必要に応じて、他の処理をここに追加することができます
                        }

                        // 基本配分量を係数を使用して計算
                        const totalCoefficient = coefficients.reduce((acc, coef) => acc + coef, 0);
                        const baseQuantity = Math.floor((row.distribution -( totalStores * row.minimumQuantity ))/ row.unit);
                        let remainingQuantity = baseQuantity;

                        console.log(`商品コード: ${row.productCode}`);
                        console.log(`配分数: ${row.distribution}, 単位: ${row.unit}`);
                        console.log(`基本配分量 (配分数 / 単位): ${baseQuantity}`);
                        console.log(`店舗数: ${totalStores}`);

                        // 係数に基づいて初期配分を計算
                        const initialAllocation = coefficients.map(coef => Math.floor((baseQuantity * coef) / totalCoefficient));
                        remainingQuantity = baseQuantity - initialAllocation.reduce((acc, qty) => acc + qty, 0);

                        console.log(`初期配分結果 (係数考慮): `, initialAllocation);
                        console.log(`残りの基本配分量 (余り): ${remainingQuantity}`);

                        // 余りを係数が高い店舗順に配分
                        const sortedIndices = coefficients
                            .map((coef, index) => ({ index, coef }))   // インデックスと係数をペアにする
                            .sort((a, b) => b.coef - a.coef)           // 係数の降順でソート

                        for (let i = 0; i < remainingQuantity; i++) {
                            initialAllocation[sortedIndices[i % totalStores].index]++;
                        }

                        console.log(`余りを考慮した配分結果: `, initialAllocation);

                        // row.minimumQuantityを数値に変換し、無効な場合は0に設定
                        const minimumQuantity = isNaN(Number(row.minimumQuantity)) ? 0 : Number(row.minimumQuantity);

                        // 最終的な配分に単位を掛けて実際の配分数にし、最低導入数を足す
                        const finalAllocation = initialAllocation.map(value => (value * row.unit) + minimumQuantity);

                        console.log(`最終配分結果 (単位掛け + 最低導入数): `, finalAllocation);

                        const numericStores = finalAllocation.map(value => Number(value));

                        const total = numericStores.reduce((acc, val) => acc + val, 0);

                        console.log(`商品コード: ${row.productCode} の最終配分結果: `, numericStores);
                        console.log(`配分合計: ${total}\n`);

                        return {
                            ...row,
                            stores: numericStores,
                            total: total
                        };
                    }
                    return row; // 選択されていない行はそのまま返す
                });

                setAllocationData(distributedData); // 更新されたデータをセット
            };

            // 選択された行の配分をクリアする関数
            const clearSelectedAllocations = () => {
                const newData = allocationData.map(row => {
                    if (row.selected) {
                        return {
                            ...row,
                            distribution: 0, // 配分数を0にリセット
                            stores: Array(row.stores.length).fill(0), // 店舗ごとの配分を0にリセット
                            total: 0 // 合計も0にリセット
                        };
                    }
                    return row;
                });
                setAllocationData(newData); // 更新されたデータをセット
            };

            // 店舗係数確認タブのフィルタリング処理
            const filterCoefficientData = () => {
                const filteredData = coefficientData.filter((row) => {
                    const isYearMatch = row.year === year;
                    const isMonthMatch = row.month === month;
                    const isStartDateMatch = !startDate || new Date(row.date) >= new Date(startDate);
                    const isEndDateMatch = !endDate || new Date(row.date) <= new Date(endDate);

                    return isYearMatch && isMonthMatch && isStartDateMatch && isEndDateMatch;
                });

                setCoefficientData(filteredData);
            };

            const handleMenuClick = (event) => {
                setAnchorEl(event.currentTarget);
            };
            const handleMenuClose = () => {
                setAnchorEl(null);
            };

            // 店舗係数マスタテンプレートダウンロード
            const downloadCoefficientMasterTemplate = () => {
                const templateData = [
                    ["店舗コード", "店舗名", "パターン1", "パターン2"],
                    ["001", "東京本店", 1.0, 1.5],
                    ["002", "大阪支店", 1.0, 1.0],
                    ["003", "名古屋支店", 0.8, 1.2],
                    ["004", "福岡支店", 1.1, 1.3]
                ];

                // テンプレートデータをシートに変換
                const ws = XLSX.utils.aoa_to_sheet(templateData);

                // 新しいワークブックを作成
                const wb = XLSX.utils.book_new();

                // ワークブックにシートを追加
                XLSX.utils.book_append_sheet(wb, ws, "CoefficientMasterTemplate");

                // ファイルを書き出し、ダウンロード
                XLSX.writeFile(wb, "coefficient_master_template.xlsx");
            };

            const [isDragging, setIsDragging] = useState(false); // ドラッグ中かどうかの状態
            
            // ファイルインポートを処理する統合関数
            const handleFileImport = (event, type) => {
                // ファイル選択またはドロップされたファイルを取得
                const file = event.target.files ? event.target.files[0] : event.dataTransfer.files[0];
                if (!file) return;  // ファイルがない場合は何もしない

                const reader = new FileReader();
                reader.onload = function (e) {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheet = workbook.Sheets[workbook.SheetNames[0]];
                    const json = XLSX.utils.sheet_to_json(sheet, { header: 1 });

                    // タイプごとの処理
                    switch (type) {
                        case 'productList':
                            // 商品リストのデータを取得して保存
                            const importedProductData = json.slice(1).map((row, index) => ({
                                id: index + 1,
                                deliveryAvailableDate: row[1] || '',
                                deliveryDate: row[2] || '',
                                productCode: row[3] || '',
                                productName: row[4] || '',
                                cost: row[5] || 0,
                                price: row[6] || 0,
                                coefficientPattern: row[7] || '',
                                remainingPlan: row[8] || 0,
                                distribution: row[9] || 0,
                                unit: row[10] || '',
                                minimumQuantity: row[11] || 0,
                                bulkQuantity: row[12] || 0
                            }));
                            setTableData(importedProductData);
                            break;

                        case 'storeMaster':
                            // 店舗マスタデータを取得して保存
                            const storeData = json.slice(1).map((row) => ({
                                storeCode: row[0] || '',
                                storeName: row[1] || ''
                            }));
                            setStoreMasterData(storeData);
                            // 取り込んだ店舗数を店舗列数に反映
                            const storeCount1 = storeData.length;
                            setNumberOfStores(storeCount1);
                            break;

                        case 'coefficient':
                            // パターンのヘッダー行（1行目）を取得して保存
                            if (json.length > 0) {
                                setPatternHeaders(json[0].slice(2));  // 「店舗コード」と「店舗名」を除いたパターン部分を取得
                            } else {
                                setPatternHeaders([]); // デフォルトの空配列を設定
                            }

                            // 店舗係数データを取得して保存
                            const coefficientData = json.slice(1).map((row) => ({
                                storeCode: row[0] || '',  // 店舗コード
                                storeName: row[1] || '',  // 店舗名
                                patterns: row.slice(2).map(value => parseFloat(value) || 0)    // パターンの値を小数点付き数値として保存
                            }));
                            setCoefficientData(coefficientData);
                            // 取り込んだ係数の店舗数を店舗列数に反映
                            const storeCount2 = coefficientData.length;
                            setNumberOfStores(storeCount2);

                            // インポートされた店舗データを納品数配分タブに反映
                            const updatedAllocationData = allocationData.map((allocationRow) => {
                                const storeInfo = coefficientData.map((coefficientRow) => ({
                                    storeCode: coefficientRow.storeCode,
                                    storeName: coefficientRow.storeName,
                                    coefficient: coefficientRow.patterns
                                }));
                                return {
                                    ...allocationRow,
                                    stores: storeInfo
                                };
                            });

                            // ステートを更新
                            setAllocationData(updatedAllocationData);
                            setStoreMasterData(coefficientData);
                            break;

                        default:
                            console.warn(`Unknown type: ${type}`);
                            break;
                    }
                };
                reader.readAsArrayBuffer(file);  // ファイルを読み込む
            };

            const downloadTemplate = (type) => {
                let templateData;
                switch (type) {
                    case 'productList':
                        templateData = [
                            ["ID", "納品可能日", "納品日", "商品コード", "商品名", "原価", "売価", "係数パターン", "計画残数", "配分数", "単位", "最低導入数", "一括導入数"],
                            [1, "2024-08-01", "2024-08-02", "P001", "商品A", 100, 150, "パターン1", 100, 200, 1, 10, 50]
                        ];
                        break;

                    case 'storeMaster':
                        templateData = [
                            ["店舗コード", "店舗名"],
                            ["S001", "東京本店"]
                        ];
                        break;

                    case 'coefficientMaster':
                        templateData = [
                            ["店舗コード", "パターン1", "パターン2"],
                            ["S001", 1.0, 1.1]
                        ];
                        break;

                    default:
                        return;
                }

                const ws = XLSX.utils.aoa_to_sheet(templateData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Template");
                XLSX.writeFile(wb, `${type}_template.xlsx`);
            };

            const handleFileDrop = (event, type) => {
                event.preventDefault();  // デフォルトのブラウザ動作を無効化
                handleFileImport(event, type);  // handleFileImport 関数を呼び出して、ファイルをインポート
            };

            // ドラッグオーバーイベントの処理（ドロップゾーンにドラッグしたときに発火）
            const handleDragOver = (event) => {
                event.preventDefault();  // デフォルトのブラウザ動作を無効化
            };

            // ドラッグリーブイベントの処理（ドロップゾーンからドラッグが離れたときに発火）
            const handleDragLeave = (event) => {
                event.preventDefault();  // デフォルトのブラウザ動作を無効化
            };

            const handleDrop = (e, type) => {
                e.preventDefault();
                setIsDragging(false);
                handleFileImport(e, type); // ドロップされたファイルを処理
            };

            return (
                React.createElement(Container, { style: { paddingLeft: '8px', paddingRight: '8px', maxWidth: '100%' } },
                    // AppBarセクション
                    React.createElement(
                        AppBar,
                        { position: "static" },
                        React.createElement(
                            Toolbar,
                            null,
                            React.createElement(
                                Typography,
                                { variant: "h6", style: { flexGrow: 1 } },
                                "納品数配分システム"
                            ),
                            isMobile
                                ? React.createElement(
                                    React.Fragment,
                                    null,
                                    React.createElement(
                                        IconButton,
                                        { edge: "start", color: "inherit", "aria-label": "menu", onClick: handleMenuClick },
                                        React.createElement(
                                            "span",
                                            { className: "material-icons" },
                                            "menu"
                                        )
                                    ),
                                    React.createElement(
                                        Menu,
                                        {
                                            anchorEl: anchorEl,
                                            open: Boolean(anchorEl),
                                            onClose: handleMenuClose
                                        },
                                        React.createElement(MenuItem, { onClick: handleMenuClose }, "ホーム"),
                                        React.createElement(MenuItem, { onClick: handleMenuClose }, "設定"),
                                        React.createElement(MenuItem, { onClick: handleMenuClose }, "ログアウト")
                                    )
                                )
                                : React.createElement(
                                    React.Fragment,
                                    null,
                                    React.createElement(Button, { color: "inherit" }, "ホーム"),
                                    React.createElement(Button, { color: "inherit" }, "設定"),
                                    React.createElement(Button, { color: "inherit" }, "ログアウト")
                                )
                        )
                    ),
                    // フィルタおよびフィルタタブ
                    React.createElement(Box, { px: 3, py: 2 },
                        React.createElement(Grid, { container: true, spacing: 2 },

                            // 年度の選択
                            React.createElement(Grid, { item: true, xs: 4, sm: 4, md:2 },
                                React.createElement(TextField, {
                                    select: true,
                                    label: "年度",
                                    value: year,
                                    onChange: (e) => setYear(e.target.value),
                                    fullWidth: true
                                },
                                    years.map(year =>
                                        React.createElement(MenuItem, { key: year, value: year }, year)
                                    )
                                )
                            ),

                            // 月度の選択
                            React.createElement(Grid, { item: true, xs: 4, sm: 4, md:2 },
                                React.createElement(TextField, {
                                    select: true,
                                    label: "月度",
                                    value: month,
                                    onChange: handleMonthChange, // 月度変更時の処理をここに適用
                                    fullWidth: true
                                },
                                    months.map(month =>
                                        React.createElement(MenuItem, { key: month, value: month }, month)
                                    )
                                )
                            ),

                            // 週の選択
                            React.createElement(Grid, { item: true, xs: 4, sm: 4, md:2 },
                                React.createElement(TextField, {
                                    select: true,
                                    label: "週",
                                    value: weekNumber,
                                    onChange: (e) => setWeekNumber(e.target.value),
                                    fullWidth: true
                                },
                                    weeks.map(week =>
                                        React.createElement(MenuItem, { key: week, value: week }, week)
                                    ),
                                    React.createElement(MenuItem, { value: "選択しない" }, "選択しない")
                                )
                            ),

                            // 開始日の選択
                            React.createElement(Grid, { item: true, xs: 6, sm: 6,md: 3 },
                                React.createElement(TextField, {
                                    label: "開始日",
                                    type: "date",
                                    value: startDate,
                                    onChange: (e) => setStartDate(e.target.value),
                                    InputLabelProps: { shrink: true },
                                    fullWidth: true
                                })
                            ),

                            // 終了日の選択
                            React.createElement(Grid, { item: true, xs: 6, sm: 6,md:3 },
                                React.createElement(TextField, {
                                    label: "終了日",
                                    type: "date",
                                    value: endDate,
                                    onChange: (e) => setEndDate(e.target.value),
                                    InputLabelProps: { shrink: true },
                                    fullWidth: true
                                })
                            ),

                            // 店舗/部署の選択
                            React.createElement(Grid, { item: true, xs: 12, sm: 6,md:6 },
                                React.createElement(TextField, {
                                    select: true,  // 店舗/部署のドロップダウンリストとして機能させます。
                                    label: "店舗/部署",
                                    value: location,
                                    onChange: (e) => setLocation(e.target.value),
                                    fullWidth: true
                                },
                                    // 店舗/部署の選択肢リストから選択肢を生成します。
                                    locations.map(loc => 
                                        React.createElement(MenuItem, { key: loc, value: loc }, loc)
                                    )
                                )
                            ),

                            // 部門の選択
                            React.createElement(Grid, { item: true, xs: 12, sm: 6,md:6 },
                                React.createElement(TextField, {
                                    select: true,  // 部門のドロップダウンリストとして機能させます。
                                    label: "部門",
                                    value: department,
                                    onChange: (e) => setDepartment(e.target.value),
                                    fullWidth: true
                                },
                                    // 部門の選択肢リストから選択肢を生成します。
                                    departments.map(dep => 
                                        React.createElement(MenuItem, { key: dep, value: dep }, dep)
                                    )
                                )
                            ),

                            // 適用ボタン
                            React.createElement(Grid, { item: true, xs: 12, sm: 12 },
                                React.createElement(Button, {
                                    variant: "contained",
                                    color: "primary",
                                    fullWidth: true,
                                    style: { height: '100%' }
                                }, "適用")
                            )
                        )
                    ),
                    // 新しいインポートセクション
                    React.createElement(Box, { mt: 2 },
                        //React.createElement(Typography, { variant: "h6", gutterBottom: true }, "インポート機能"),
                        React.createElement(Button, {
                            variant: "outlined",
                            color: "primary",
                            onClick: () => setShowMasterImportControls(!showMasterImportControls), // インポート機能の表示/非表示を切り替える
                            fullWidth: true,
                            style: { marginBottom: '16px' }
                        }, showMasterImportControls ? "インポート機能を非表示" : "インポート機能を表示"),
                        showMasterImportControls && React.createElement(Grid, { container: true, spacing: 2 },
                            // 商品リストのインポートとテンプレートダウンロード
                            React.createElement(Grid, { item: true, xs: 12, sm: 6, md: 4 },
                                React.createElement(Typography, { variant: "subtitle1" }, "商品リスト"),
                                React.createElement(Box, {
                                    border: "2px dashed #cccccc",
                                    borderRadius: "8px",
                                    padding: "16px",
                                    textAlign: "center",
                                    onDrop: (e) => handleFileDrop(e, 'productList'),
                                    onDragOver: (e) => e.preventDefault()
                                }, "ここにファイルをドラッグ＆ドロップ"),
                                React.createElement(Button, {
                                    variant: "contained",
                                    color: "primary",
                                    component: "label",
                                    fullWidth: true,
                                    style: { marginTop: '8px' }
                                }, "商品リスト取込",
                                    React.createElement("input", {
                                        type: "file",
                                        accept: ".xlsx, .xls",
                                        hidden: true,
                                        onChange: (e) => handleFileImport(e, 'productList') // 商品リストのインポート処理
                                    })
                                ),
                                React.createElement(Button, {
                                    variant: "contained",
                                    color: "secondary",
                                    onClick: () => downloadTemplate('productList'),
                                    fullWidth: true,
                                    style: { marginTop: '8px' }
                                }, "商品リストテンプレート出力")
                            ),
                            // 店舗マスタのインポートとテンプレートダウンロード
                            React.createElement(Grid, { item: true, xs: 12, sm: 6, md: 4 },
                                React.createElement(Typography, { variant: "subtitle1" }, "店舗マスタ"),
                                React.createElement(Box, {
                                    border: "2px dashed #cccccc",
                                    borderRadius: "8px",
                                    padding: "16px",
                                    textAlign: "center",
                                    onDrop: (e) => handleFileDrop(e, 'storeMaster'),
                                    onDragOver: (e) => e.preventDefault()
                                }, "ここにファイルをドラッグ＆ドロップ"),
                                React.createElement(Button, {
                                    variant: "contained",
                                    color: "primary",
                                    component: "label",
                                    fullWidth: true,
                                    style: { marginTop: '8px' }
                                }, "店舗マスタ取込",
                                    React.createElement("input", {
                                        type: "file",
                                        accept: ".xlsx, .xls",
                                        hidden: true,
                                        onChange: (e) => handleFileImport(e, 'storeMaster') // 店舗マスタのインポート処理
                                    })
                                ),
                                React.createElement(Button, {
                                    variant: "contained",
                                    color: "secondary",
                                    onClick: () => downloadTemplate('storeMaster'),
                                    fullWidth: true,
                                    style: { marginTop: '8px' }
                                }, "店舗マスタテンプレート出力")
                            ),
                            // 店舗係数のインポートとテンプレートダウンロード
                            React.createElement(Grid, { item: true, xs: 12, sm: 6, md: 4 },
                                React.createElement(Typography, { variant: "subtitle1" }, "店舗係数"),
                                React.createElement(Box, {
                                    border: "2px dashed #cccccc",
                                    borderRadius: "8px",
                                    padding: "16px",
                                    textAlign: "center",
                                    onDrop: (e) => handleFileDrop(e, 'coefficient'),
                                    onDragOver: (e) => e.preventDefault()
                                }, "ここにファイルをドラッグ＆ドロップ"),
                                React.createElement(Button, {
                                    variant: "contained",
                                    color: "primary",
                                    component: "label",
                                    fullWidth: true,
                                    style: { marginTop: '8px' }
                                }, "店舗係数の取込",
                                    React.createElement("input", {
                                        type: "file",
                                        accept: ".xlsx, .xls",
                                        hidden: true,
                                        onChange: (e) => handleFileImport(e, 'coefficient') // 店舗係数のインポート処理
                                    })
                                ),
                                React.createElement(Button, {
                                    variant: "contained",
                                    color: "secondary",
                                    onClick: downloadCoefficientMasterTemplate,  // この関数をダウンロードボタンに接続
                                    fullWidth: true,
                                    style: { marginTop: '8px' }
                                }, "店舗係数テンプレート出力")
                            )
                        )
                    ),
                    // タブの表示
                    React.createElement(Tabs, { value: activeTab, onChange: handleTabChange, indicatorColor: "primary", textColor: "primary", centered: true },
                        React.createElement(Tab, { label: "商品リスト" }),
                        React.createElement(Tab, { label: "納品数配分" }),
                        React.createElement(Tab, { label: "店舗係数確認" })
                    ),
                    // 商品リストタブがアクティブな場合の表示
                    activeTab === 0 && (
                        React.createElement(Box, { mt: 1 },

                            // タブのタイトルを表示
                            React.createElement(Typography, { variant: "h6", gutterBottom: true }, "商品リスト"),

                            // 商品リストのインポートとテンプレートダウンロードセクション
                            React.createElement(Grid, { container: true, spacing: 2 },

                                // ボタングループ
                                React.createElement(Grid, { item: true, xs: 12 },
                                    React.createElement(ButtonGroup, { fullWidth: true, variant: "contained" },
                                        // 商品リストインポートボタン
                                        React.createElement(Button, { component: "label" },
                                            "商品リスト取込",
                                            // ファイル入力を隠し、ボタンとして表示
                                            React.createElement("input", {
                                                type: "file",
                                                accept: ".xlsx, .xls",
                                                hidden: true,
                                                onChange: handleFileImport  // ファイルインポート処理を呼び出す
                                            })
                                        ),

                                        // テンプレートダウンロードボタン
                                        React.createElement(Button, { color: "secondary", onClick: downloadTemplate }, "テンプレートを出力"),

                                        // 選択された商品を転送するボタン
                                        React.createElement(Button, { color: "primary", onClick: handleTransferSelectedRows }, "選択された商品を配分"),

                                        // 選択された行を削除するボタン
                                        React.createElement(Button, { color: "warning", onClick: handleDeleteSelectedRows }, "選択した商品を削除")
                                    )
                                )
                            ),

                            // フィルタタブのセクション
                            React.createElement(Grid, { item: true, xs: 12 },
                                // 全体、未配分、配分済みのフィルタタブ
                                React.createElement(Tabs, { value: filterTab, onChange: handleFilterTabChange, indicatorColor: "primary", textColor: "primary", centered: true },
                                    React.createElement(Tab, { label: "全て" }),
                                    React.createElement(Tab, { label: "未配分" }),
                                    React.createElement(Tab, { label: "配分済" })
                                )
                            ),

                            // 商品リストテーブルのセクション
                            React.createElement(Grid, { item: true, xs: 12 },
                                React.createElement(Box, { mt: 2, style: { overflowX: 'auto', width: '100%' } },
                                    React.createElement(TableContainer, { component: Paper, style: { width: '100%' } },
                                        React.createElement(Table, { size: "small", style: { minWidth: '1800px' } },

                                            // フィルタ行の追加
                                            React.createElement(TableHead, null,
                                                React.createElement(TableRow, null,

                                                    // 全行選択用のチェックボックス
                                                    React.createElement(TableCell, { padding: "none", style: { width: productColumnWidths.checkbox }, align: "center" },
                                                        React.createElement(Checkbox, {
                                                            inputProps: { 'aria-label': 'select all rows' },
                                                            onChange: (e) => {
                                                                const checked = e.target.checked;
                                                                setTableData(tableData.map(row => ({ ...row, selected: checked })));  // 全行の選択状態を変更
                                                            }
                                                        })
                                                    ),

                                                    // 各列に対応するフィルタ入力欄を表示
                                                    ["No", "status", "deliveryAvailableDate", "deliveryDate", "productCode", "productName", "cost", "price", "coefficientPattern", "distribution", "unit", "minimumQuantity", "bulkQuantity"].map((key, i) =>
                                                        React.createElement(TableCell, { key: i, padding: "none", style: { width: productColumnWidths[key] }, align: "center" },
                                                            React.createElement(TextField, {
                                                                placeholder: "フィルタ",
                                                                variant: "standard",
                                                                onChange: (e) => handleFilterChange(key, e.target.value),  // フィルタの条件を変更
                                                                fullWidth: true
                                                            })
                                                        )
                                                    )
                                                )
                                            ),

                                            // テーブルのデータ行のヘッダー
                                            React.createElement(TableHead, null,
                                                React.createElement(TableRow, null,
                                                    React.createElement(TableCell, { padding: "none", style: { width: productColumnWidths.checkbox }, align: "center" }),
                                                    React.createElement(TableCell, { padding: "none", style: { width: productColumnWidths.no }, align: "center" }, "No"),
                                                    React.createElement(TableCell, { padding: "none", style: { width: productColumnWidths.status }, align: "center" }, "ステータス"),
                                                    React.createElement(TableCell, { padding: "none", style: { width: productColumnWidths.deliveryAvailableDate }, align: "center" }, "納品可能日"),
                                                    React.createElement(TableCell, { padding: "none", style: { width: productColumnWidths.deliveryDate }, align: "center" }, "納品日"),
                                                    React.createElement(TableCell, { padding: "none", style: { width: productColumnWidths.productCode }, align: "center" }, "商品コード"),
                                                    React.createElement(TableCell, { padding: "none", style: { width: productColumnWidths.productName }, align: "center" }, "商品名"),
                                                    React.createElement(TableCell, { padding: "none", style: { width: productColumnWidths.cost }, align: "center" }, "原価"),
                                                    React.createElement(TableCell, { padding: "none", style: { width: productColumnWidths.price }, align: "center" }, "売価"),
                                                    React.createElement(TableCell, { padding: "none", style: { width: productColumnWidths.profit }, align: "center" }, "値入"),
                                                    React.createElement(TableCell, { padding: "none", style: { width: productColumnWidths.coefficientPattern }, align: "center" }, "パターン"),
                                                    React.createElement(TableCell, { padding: "none", style: { width: productColumnWidths.totalPlanQuantity }, align: "center" }, "総計画数"),
                                                    React.createElement(TableCell, { padding: "none", style: { width: productColumnWidths.distribution }, align: "center" }, "配分数"),
                                                    React.createElement(TableCell, { padding: "none", style: { width: productColumnWidths.unit }, align: "center" }, "単位"),
                                                    React.createElement(TableCell, { padding: "none", style: { width: productColumnWidths.minimumQuantity }, align: "center" }, "最低導入数"),
                                                    React.createElement(TableCell, { padding: "none", style: { width: productColumnWidths.bulkQuantity }, align: "center" }, "一括導入数"),
                                                    React.createElement(TableCell, { padding: "none", style: { width: productColumnWidths.totalCostAmount }, align: "center" }, "原価額計"),
                                                    React.createElement(TableCell, { padding: "none", style: { width: productColumnWidths.totalPriceAmount }, align: "center" }, "売価額計"),
                                                    React.createElement(TableCell, { padding: "none", style: { width: productColumnWidths.totalPlanCostAmount }, align: "center" }, "合計原価額"),
                                                    React.createElement(TableCell, { padding: "none", style: { width: productColumnWidths.totalPlanPriceAmount }, align: "center" }, "合計売価額")
                                                )
                                            ),

                                            // テーブルのデータ行を表示
                                            React.createElement(TableBody, null,
                                                filteredTableData.map((row, index) =>
                                                    React.createElement(TableRow, { key: row.id, style: { height: `${rowHeight}px` } },

                                                        // 各行の選択用チェックボックス
                                                        React.createElement(TableCell, { padding: "none", style: { width: productColumnWidths.checkbox }, align: "center" },
                                                            React.createElement(Checkbox, {
                                                                checked: row.selected,
                                                                onChange: () => handleSelectRow(index)  // 行の選択状態を変更
                                                            })
                                                        ),

                                                        // 行番号を表示
                                                        React.createElement(TableCell, { padding: "none", align: "center" }, index + 1),

                                                        // ステータスのドロップダウンメニュー
                                                        React.createElement(TableCell, { padding: "none", align: "center" },
                                                            React.createElement(Select, {
                                                                value: row.status,
                                                                onChange: (e) => handleInputChange(index, 'status', e.target.value),  // ステータスの変更を処理
                                                                fullWidth: true,
                                                                style: { height: '40px', padding: 0 },  // セレクトボックスの高さを調整
                                                                inputProps: { style: { padding: '4px 0' } }  // 余白を調整
                                                            }, statusOptions.map(option =>
                                                                React.createElement(MenuItem, { key: option, value: option }, option)
                                                            ))
                                                        ),

                                                        // 他のフィールドも同様に処理
                                                        ["deliveryAvailableDate", "deliveryDate", "productCode", "productName", "cost", "price", "profit", "coefficientPattern", "totalPlanQuantity", "distribution", "unit", "minimumQuantity", "bulkQuantity"].map((key, i) =>
                                                            React.createElement(TableCell, { padding: "none", key: i, align: "center", width: productColumnWidths[key] },
                                                                React.createElement(TextField, {
                                                                    type: key === "cost" || key === "price" || key === "distribution" || key === "minimumQuantity" || key === "bulkQuantity" || key === "totalPlanQuantity" ? "number" : "text",
                                                                    value: row[key],
                                                                    onChange: (e) => {
                                                                        handleInputChange(index, key, e.target.value);  // 値の変更を処理

                                                                        // 最後の行が入力されている場合は新しい行を追加
                                                                        if (index === tableData.length - 1 && e.target.value !== "") {
                                                                            setTableData([...tableData, createEmptyRow(tableData.length + 1)]);
                                                                        }
                                                                    },
                                                                    fullWidth: true,
                                                                    inputProps: { style: { height: '40px', padding: '0 8px' } }
                                                                })
                                                            )
                                                        ),

                                                        // 原価額計（配分数×原価）
                                                        React.createElement(TableCell, { padding: "none", align: "center" },
                                                            (row.distribution * row.cost).toFixed(0)
                                                        ),

                                                        // 売価額計（配分数×売価）
                                                        React.createElement(TableCell, { padding: "none", align: "center" },
                                                            (row.distribution * row.price).toFixed(0)
                                                        ),

                                                        // 合計原価額（総計画数×原価）
                                                        React.createElement(TableCell, { padding: "none", align: "center" },
                                                            (row.totalPlanQuantity * row.cost).toFixed(0)
                                                        ),

                                                        // 合計売価額（総計画数×売価）
                                                        React.createElement(TableCell, { padding: "none", align: "center" },
                                                            (row.totalPlanQuantity * row.price).toFixed(0)
                                                        )
                                                    )
                                                )
                                            )
                                        )
                                    )
                                )
                            )
                        )
                    ),
                    // 納品数配分タブの表示と操作を担当する部分
                    activeTab === 1 && (
                        React.createElement(Box, { mt: 1 },
                            // タブのタイトル "納品数配分"
                            React.createElement(Typography, { variant: "h6", gutterBottom: true }, "納品数配分"),
                            React.createElement(Button, {
                                variant: "outlined",
                                color: "primary",
                                onClick: () => setShowSettings(!showSettings), // インポート機能の表示/非表示を切り替える
                                fullWidth: true,
                                style: { marginBottom: '16px' }
                                }, showSettings ? "設定を非表示" : "設定を表示"),
                                // 設定セクション（トグルで表示/非表示）
                                showSettings && React.createElement(Grid, { container: true, spacing: 2 },
                                // 設定セクションのコード
                                React.createElement(Grid, { item: true, xs: 12 },
                                React.createElement(Grid, { item: true, xs: 12 },
                                React.createElement(Typography, { variant: "h6", gutterBottom: true }, "設定"),
                                React.createElement(Grid, { container: true, spacing: 2 },
                                    // 商品行数の設定フィールド
                                    React.createElement(Grid, { item: true, xs: 6 },
                                        React.createElement(TextField, {
                                            label: "商品行数",
                                            type: "number",
                                            value: rowCount,
                                            onChange: (e) => setRowCount(parseInt(e.target.value, 10)),
                                            fullWidth: true
                                        }),
                                        // 商品行数のスライダー
                                        React.createElement(Slider, {
                                            value: rowCount,
                                            min: 1,
                                            max: 100,
                                            onChange: (e, value) => setRowCount(value),
                                            valueLabelDisplay: "auto"
                                        })
                                    ),
                                    // 店舗列数の設定フィールド
                                    React.createElement(Grid, { item: true, xs: 6 },
                                        React.createElement(TextField, {
                                            label: "店舗列数",
                                            type: "number",
                                            value: numberOfStores,
                                            onChange: (e) => setNumberOfStores(parseInt(e.target.value, 10)),
                                            fullWidth: true
                                        }),
                                        // 店舗列数のスライダー
                                        React.createElement(Slider, {
                                            value: numberOfStores,
                                            min: 1,
                                            max: 100,
                                            onChange: (e, value) => setNumberOfStores(value),
                                            valueLabelDisplay: "auto"
                                        })
                                    )
                                )
                            ))),
                            React.createElement(Grid, { item: true, xs: 12 },

                                // アクションボタンのセクション
                                React.createElement(Grid, { container: true, spacing: 1 },
                                    // アクションタイトル
                                    React.createElement(Grid, { item: true, xs: 12 },
                                    //React.createElement(Typography, { variant: "h6", gutterBottom: true }, "アクション")
                                    ),
                                    // 納品日を設定するセクション
                                    React.createElement(Grid, { container: true, spacing: 1 },
                                    // 納品日フィールド
                                        // 納品日の設定（初期値は当日から7日後）
                                        React.createElement(Grid, { item: true, xs: 4 },
                                            React.createElement(TextField, {
                                                label: "納品日",
                                                type: "date",
                                                value: deliveryDate,
                                                onChange: (e) => setDeliveryDate(e.target.value),
                                                fullWidth: true
                                            })
                                        ),
                                        // 納品日を全行に一括設定するボタン
                                        React.createElement(Grid, { item: true, xs: 4 },
                                            React.createElement(Button, {
                                                onClick: setAllDeliveryDates,
                                                variant: "contained",
                                                color: "info",  // ボタンの色を適宜設定
                                                fullWidth: true,
                                                style: { marginTop: '8px' }
                                            }, "納品日を一括設定")
                                        ),
                                        // 納品日をクリアするボタン
                                        React.createElement(Grid, { item: true, xs: 4 },
                                            React.createElement(Button, {
                                                onClick: clearAllDeliveryDates,
                                                variant: "contained",
                                                color: "secondary",  // ボタンの色を適宜設定
                                                fullWidth: true,
                                                style: { marginTop: '8px' }
                                            }, "納品日をクリア")
                                        )
                                    ),

                                    // クリア（赤）と選択した行を削除（黄）のボタングループ
                                    React.createElement(Grid, { item: true, xs: 12, sm: 6, md: 3 },
                                        React.createElement(ButtonGroup, {
                                            variant: "contained",
                                            fullWidth: true,
                                        },
                                            React.createElement(Button, {
                                                onClick: clearTable,
                                                style: { backgroundColor: '#f44336', color: 'white' }  // 赤色
                                            }, "クリア"),
                                            React.createElement(Button, {
                                                onClick: () => setAllocationData(allocationData.filter(row => !row.selected)),
                                                style: { backgroundColor: '#ffeb3b', color: 'black' }  // 黄色
                                            }, "行削除")
                                        )
                                    ),

                                    // Excelエクスポート（緑）とCSVエクスポート（灰）のボタングループ
                                    React.createElement(Grid, { item: true, xs: 12, sm: 6, md: 3 },
                                        React.createElement(ButtonGroup, {
                                            variant: "contained",
                                            fullWidth: true,
                                            style: { marginBottom: '8px' }  // ボタングループ間に余白を追加
                                        },
                                            React.createElement(Button, {
                                                onClick: exportToExcel,
                                                style: { backgroundColor: '#4caf50', color: 'white' }  // 緑色
                                            }, "Excel出力"),
                                            React.createElement(Button, {
                                                onClick: exportToCsv,
                                                style: { backgroundColor: '#9e9e9e', color: 'white' }  // 灰色
                                            }, "CSV出力")
                                        )
                                    ),
                                ),
                                // アクションボタンのセクション
                                React.createElement(Grid, { container: true, spacing: 1 },
                                        // 配分をクリアするボタン（選択された行）
                                        React.createElement(Grid, { item: true, xs: 4 },
                                            React.createElement(Button, {
                                                onClick: clearSelectedAllocations,
                                                variant: "contained",
                                                color: "secondary", // ボタンの色を適宜設定
                                                fullWidth: true,
                                                style: { marginTop: '8px' }
                                            }, "選択行の配分をクリア")
                                        ),
                                        // 全ての行を配分するボタン
                                        React.createElement(Grid, { item: true, xs: 4 },
                                        React.createElement(Button, {
                                            onClick: () => distributeAllocations(),
                                            variant: "contained",
                                            color: "primary",
                                            fullWidth: true,
                                            style: { marginTop: '8px' }
                                        }, "全ての行を配分")
                                        ),
                                        React.createElement(Grid, { item: true, xs: 4 },
                                        // 選択された行のみ配分するボタン
                                        React.createElement(Button, {
                                            onClick: () => distributeAllocations(true),
                                            variant: "contained",
                                            color: "primary",
                                            fullWidth: true,
                                            style: { marginTop: '8px' }
                                        }, "選択された行を配分")
                                        )
                                    ),

                                // 配分データを表示するテーブルセクション
                                React.createElement(Box, { mt: 2, style: { overflowX: 'auto', width: '100%' } },
                                    React.createElement(TableContainer, { component: Paper, style: { width: '100%' } },
                                        React.createElement(Table, { size: "small", style: { minWidth: '1200px', tableLayout: 'fixed' } },
                                            // テーブルヘッダー
                                            React.createElement(TableHead, null,
                                                React.createElement(TableRow, null,
                                                    // 全行選択用のチェックボックスヘッダー
                                                    React.createElement(TableCell, { padding: "none", style: { width: allocationColumnWidths.checkbox }, align: "center" },
                                                        React.createElement(Checkbox, {
                                                            inputProps: { 'aria-label': 'select all rows' },
                                                            onChange: (e) => {
                                                                const checked = e.target.checked;
                                                                setAllocationData(allocationData.map(row => ({ ...row, selected: checked })));
                                                            }
                                                        })
                                                    ),
                                                    React.createElement(TableCell, { padding: "none", style: { width: allocationColumnWidths.deliveryDate }, align: "center" }, "納品日"),
                                                    React.createElement(TableCell, { padding: "none", style: { width: allocationColumnWidths.productCode }, align: "center" }, "商品コード"),
                                                    React.createElement(TableCell, { padding: "none", style: { width: allocationColumnWidths.productName }, align: "center" }, "商品名"),
                                                    React.createElement(TableCell, { padding: "none", style: { width: allocationColumnWidths.cost }, align: "center" }, "原価"),
                                                    React.createElement(TableCell, { padding: "none", style: { width: allocationColumnWidths.price }, align: "center" }, "売価"),
                                                    React.createElement(TableCell, { padding: "none", style: { width: allocationColumnWidths.coefficientPattern }, align: "center" }, "係数パターン"),
                                                    React.createElement(TableCell, { padding: "none", style: { width: allocationColumnWidths.remainingPlan }, align: "center" }, "計画残数"),
                                                    React.createElement(TableCell, { padding: "none", style: { width: allocationColumnWidths.distribution }, align: "center" }, "配分数"),
                                                    React.createElement(TableCell, { padding: "none", style: { width: allocationColumnWidths.totalCostAmount }, align: "center" }, "原価計"),
                                                    React.createElement(TableCell, { padding: "none", style: { width: allocationColumnWidths.totalPriceAmount }, align: "center" }, "売価計"),
                                                    React.createElement(TableCell, { padding: "none", style: { width: allocationColumnWidths.unit }, align: "center" }, "単位"),
                                                    React.createElement(TableCell, { padding: "none", style: { width: allocationColumnWidths.minimumQuantity }, align: "center" }, "最低導入数"),
                                                    React.createElement(TableCell, { padding: "none", style: { width: allocationColumnWidths.bulkQuantity }, align: "center" }, "一括導入数"),
                                                    React.createElement(TableCell, { padding: "none", style: { width: allocationColumnWidths.total }, align: "center" }, "合計"),

                                                    // 各店舗ごとの列ヘッダー
                                                    (storeMasterData && storeMasterData.length > 0 ? storeMasterData : Array(numberOfStores).fill({ storeCode: '', storeName: '' })).map((store, i) =>
                                                        React.createElement(TableCell, { key: i, padding: "none", style: { width: allocationColumnWidths.storeName }, align: "center" },
                                                            React.createElement(Box, { display: "flex", flexDirection: "column", alignItems: "center" },
                                                                React.createElement(Checkbox, {
                                                                    inputProps: { 'aria-label': `select store ${i + 1}` },
                                                                    checked: storeCheckboxState[i] || false, // undefined を避けるためにデフォルトで false を指定
                                                                    onChange: (e) => {
                                                                        const updatedCheckboxState = [...storeCheckboxState];
                                                                        updatedCheckboxState[i] = e.target.checked;
                                                                        setStoreCheckboxState(updatedCheckboxState);
                                                                    }
                                                                }),
                                                                React.createElement(Typography, { variant: "caption", align: "center" }, 
                                                                    store.storeCode ? 
                                                                    React.createElement(React.Fragment, null, 
                                                                        store.storeCode, React.createElement("br"), store.storeName
                                                                    ) : `店舗${i + 1}`
                                                                )
                                                            )
                                                        )
                                                    ),
                                                    React.createElement(TableCell, { padding: "none", style: { width: allocationColumnWidths.total }, align: "center" }, "合計（確認）")
                                                )
                                            ),

                                            // テーブルボディ
                                            React.createElement(TableBody, null,
                                                allocationData.map((row, index) =>
                                                    React.createElement(TableRow, { key: row.id, style: { height: `${rowHeight}px` } },
                                                        React.createElement(TableCell, { padding: "none", style: { width: allocationColumnWidths.checkbox }, align: "center" },
                                                            React.createElement(Checkbox, {
                                                                checked: row.selected,
                                                                onChange: () => handleAllocationInputChange(index, 'selected', !row.selected)
                                                            })
                                                        ),
                                                        //納品日
                                                        React.createElement(TableCell, { padding: "none", style: { width: allocationColumnWidths.deliveryDate }, align: "center" },
                                                            React.createElement(TextField, {
                                                                type: "date",
                                                                value: row.deliveryDate,
                                                                onChange: (e) => handleAllocationInputChange(index, "deliveryDate", e.target.value),
                                                                fullWidth: true,
                                                                inputProps: { style: { height: '40px', padding: '0 8px' } }
                                                            })
                                                        ),
                                                        //商品コード
                                                        React.createElement(TableCell, { padding: "none", style: { width: allocationColumnWidths.productCode }, align: "center" },
                                                            React.createElement(TextField, {
                                                                value: row.productCode,
                                                                onChange: (e) => handleAllocationInputChange(index, "productCode", e.target.value),
                                                                inputProps: { maxLength: 10, style: { height: '40px', padding: '0 8px', textAlign: "center" } },
                                                                fullWidth: true
                                                            })
                                                        ),
                                                        //商品名
                                                        React.createElement(TableCell, { padding: "none", style: { width: allocationColumnWidths.productName }, align: "center" },
                                                            React.createElement(TextField, {
                                                                value: row.productName,
                                                                onChange: (e) => handleAllocationInputChange(index, "productName", e.target.value),
                                                                inputProps: { maxLength: 20, style: { height: '40px', padding: '0 8px' } },
                                                                fullWidth: true
                                                            })
                                                        ),
                                                        //原価
                                                        React.createElement(TableCell, { padding: "none", style: { width: allocationColumnWidths.cost }, align: "center" },
                                                            React.createElement(TextField, {
                                                                type: "number",
                                                                value: row.cost,
                                                                onChange: (e) => handleAllocationInputChange(index, "cost", e.target.value),
                                                                inputProps: { maxLength: 5, style: { height: '40px', padding: '0 8px', textAlign: "right" } },
                                                                fullWidth: true
                                                            })
                                                        ),
                                                        //売価
                                                        React.createElement(TableCell, { padding: "none", style: { width: allocationColumnWidths.price }, align: "center" },
                                                            React.createElement(TextField, {
                                                                type: "number",
                                                                value: row.price,
                                                                onChange: (e) => handleAllocationInputChange(index, "price", e.target.value),
                                                                inputProps: { maxLength: 5, style: { height: '40px', padding: '0 8px', textAlign: "right" } },
                                                                fullWidth: true
                                                            })
                                                        ),
                                                         // 係数パターン選択のTableCell
                                                        React.createElement(
                                                            TableCell,
                                                            { padding: "none", style: { width: allocationColumnWidths.coefficientPattern }, align: "center" },
                                                            React.createElement(
                                                                Select,
                                                                {
                                                                    value: row.coefficientPattern,
                                                                    onChange: (e) => handleAllocationInputChange(index, 'coefficientPattern', e.target.value),
                                                                    fullWidth: true,
                                                                    style: { height: '40px', padding: 0 }
                                                                },
                                                                patternHeaders.map((pattern, i) =>
                                                                    React.createElement(
                                                                        MenuItem,
                                                                        { key: i, value: pattern },
                                                                        pattern
                                                                    )
                                                                ))
                                                        ),
                                                        //計画数
                                                        React.createElement(TableCell, { padding: "none", style: { width: allocationColumnWidths.remainingPlan }, align: "center" },
                                                            React.createElement(TextField, {
                                                                type: "number",
                                                                value: row.remainingPlan,
                                                                onChange: (e) => handleAllocationInputChange(index, "remainingPlan", e.target.value),
                                                                inputProps: { maxLength: 5, style: { height: '40px', padding: '0 8px', textAlign: "right" } },
                                                                fullWidth: true
                                                            })
                                                        ),
                                                        //配分数
                                                        React.createElement(TableCell, { padding: "none", style: { width: allocationColumnWidths.distribution }, align: "center" },
                                                            React.createElement(TextField, {
                                                                type: "number",
                                                                value: row.distribution,
                                                                onChange: (e) => handleAllocationInputChange(index, "distribution", e.target.value),
                                                                fullWidth: true,
                                                                inputProps: { maxLength: 5, style: { height: '40px', padding: '0 8px', textAlign: "right" } }
                                                            })
                                                        ),
                                                        // 原価合計
                                                        React.createElement(TableCell, { padding: "none", style: { width: allocationColumnWidths.totalCostAmount }, align: "center" },
                                                            React.createElement(TextField, {
                                                                type: "number",
                                                                value: row.cost && row.total ? row.cost * row.total : 0,  // 初期値0を表示
                                                                disabled: true,
                                                                fullWidth: true,
                                                                inputProps: { style: { height: '40px', padding: '0 8px', textAlign: "right" } }
                                                            })
                                                        ),
                                                        // 売価合計
                                                        React.createElement(TableCell, { padding: "none", style: { width: allocationColumnWidths.totalPriceAmount }, align: "center" },
                                                            React.createElement(TextField, {
                                                                type: "number",
                                                                value: row.price && row.total ? row.price * row.total : 0,  // 初期値0を表示
                                                                disabled: true,
                                                                fullWidth: true,
                                                                inputProps: { style: { height: '40px', padding: '0 8px', textAlign: "right" } }
                                                            })
                                                        ),
                                                        //単位
                                                        React.createElement(TableCell, { padding: "none", style: { width: allocationColumnWidths.unit }, align: "center" },
                                                            React.createElement(TextField, {
                                                                type: "number",
                                                                value: row.unit,
                                                                onChange: (e) => handleAllocationInputChange(index, "unit", e.target.value),
                                                                inputProps: { maxLength: 5, style: { height: '40px', padding: '0 8px', textAlign: "right" } },
                                                                fullWidth: true
                                                            })
                                                        ),
                                                        // 最低導入数量
                                                        React.createElement(TableCell, { padding: "none", style: { width: allocationColumnWidths.minimumQuantity }, align: "center" },
                                                            React.createElement(TextField, {
                                                                type: "number",
                                                                value: row.minimumQuantity,
                                                                onChange: (e) => handleAllocationInputChange(index, "minimumQuantity", e.target.value),
                                                                inputProps: { maxLength: 5, style: { height: '40px', padding: '0 8px', textAlign: "right" } },
                                                                fullWidth: true
                                                            })
                                                        ),
                                                        // 一括導入数量（この値を入力すると、すべての店舗にその数値が適用される）
                                                        React.createElement(TableCell, { padding: "none", style: { width: allocationColumnWidths.bulkQuantity }, align: "center" },
                                                            React.createElement(TextField, {
                                                                type: "number",
                                                                value: row.bulkQuantity,
                                                                onChange: (e) => {
                                                                    const bulkQuantity = parseInt(e.target.value, 10) || 0;
                                                                    // 一括導入数を全店舗に反映させる処理
                                                                    const updatedStores = Array(numberOfStores).fill(bulkQuantity);
                                                                    handleAllocationInputChange(index, "bulkQuantity", bulkQuantity);
                                                                    handleAllocationInputChange(index, "stores", updatedStores);
                                                                },
                                                                inputProps: { maxLength: 5, style: { height: '40px', padding: '0 8px', textAlign: "right" } },
                                                                fullWidth: true
                                                            })
                                                        ),
                                                        // 合計確認1セル
                                                        React.createElement(TableCell, { padding: "none", style: { width: allocationColumnWidths.total }, align: "center" },
                                                            React.createElement(TextField, {
                                                                type: "number",
                                                                value: row.total,
                                                                disabled: true,
                                                                fullWidth: true,
                                                                inputProps: { style: { height: '40px', padding: '0 8px', textAlign: "right" } }
                                                            })
                                                        ),
                                                        // 各店舗ごとの入力フィールド
                                                        (storeMasterData.length > 0 ? storeMasterData : Array(numberOfStores).fill({ storeCode: '', storeName: '' })).map((store, i) =>
                                                            React.createElement(TableCell, { key: i, padding: "none", style: { width: allocationColumnWidths.storeName }, align: "center" },
                                                                React.createElement(Box, null,
                                                                    // 店舗コードと店舗名の表示
                                                                    //React.createElement(Typography, { variant: "caption" }, store.storeCode ? `${store.storeCode}: ${store.storeName}` : `店舗${i + 1}`),
                                                                    // 店舗ごとの配分数の入力フィールド
                                                                    React.createElement(TextField, {
                                                                        type: "number",
                                                                        value: (row.stores && row.stores[i] !== undefined) ? row.stores[i] : 0,  // stores配列が存在し、その要素が定義されていることを確認
                                                                        onChange: (e) => {
                                                                            const updatedStores = row.stores ? [...row.stores] : Array(numberOfStores).fill(0);
                                                                            updatedStores[i] = parseInt(e.target.value, 10) || 0;
                                                                            handleAllocationInputChange(index, 'stores', updatedStores);
                                                                        },
                                                                        fullWidth: true,
                                                                        inputProps: { style: { height: '40px', padding: '0 8px', textAlign: "right" } }
                                                                    })
                                                                )
                                                            )
                                                        ),
                                                        // 合計確認セル
                                                        React.createElement(TableCell, { padding: "none", style: { width: allocationColumnWidths.total }, align: "center" },
                                                            React.createElement(TextField, {
                                                                type: "number",
                                                                value: row.total,
                                                                disabled: true,
                                                                fullWidth: true,
                                                                inputProps: { style: { height: '40px', padding: '0 8px', textAlign: "right" } }
                                                            })
                                                        )
                                                    )
                                                )
                                            )
                                        )
                                    )
                                )
                            )
                        )
                    ),
                    // 店舗係数確認タブ
                    activeTab === 2 && (
                        React.createElement(Box, { mt: 2 },
                            React.createElement(Typography, { variant: "h6", gutterBottom: true }, "店舗係数確認"),
                            React.createElement(Grid, { container: true, spacing: 2 },
                                // 年度、月度、開始日、終了日のフィルター
                                React.createElement(Grid, { item: true, xs: 3 },
                                    React.createElement(TextField, {
                                        label: "年度",
                                        type: "number",
                                        value: year,
                                        onChange: (e) => setYear(e.target.value),
                                        InputLabelProps: { shrink: true },
                                        fullWidth: true,
                                        style: { marginTop: '16px' }
                                    })
                                ),
                                React.createElement(Grid, { item: true, xs: 3 },
                                    React.createElement(TextField, {
                                        label: "月度",
                                        type: "number",
                                        value: month,
                                        onChange: (e) => setMonth(e.target.value),
                                        InputLabelProps: { shrink: true },
                                        fullWidth: true,
                                        style: { marginTop: '16px' }
                                    })
                                ),
                                React.createElement(Grid, { item: true, xs: 3 },
                                    React.createElement(TextField, {
                                        label: "開始日",
                                        type: "date",
                                        value: startDate,
                                        onChange: (e) => setStartDate(e.target.value),
                                        InputLabelProps: { shrink: true },
                                        fullWidth: true,
                                        style: { marginTop: '16px' }
                                    })
                                ),
                                React.createElement(Grid, { item: true, xs: 3 },
                                    React.createElement(TextField, {
                                        label: "終了日",
                                        type: "date",
                                        value: endDate,
                                        onChange: (e) => setEndDate(e.target.value),
                                        InputLabelProps: { shrink: true },
                                        fullWidth: true,
                                        style: { marginTop: '16px' }
                                    })
                                ),
                                React.createElement(Grid, { item: true, xs: 12 },
                                    React.createElement(Button, {
                                        variant: "contained",
                                        color: "primary",
                                        fullWidth: true,
                                        onClick: filterCoefficientData,
                                        style: { marginTop: '16px' }
                                    }, "フィルタリング")
                                ),
                                // Coefficient Table Section
                                React.createElement(Grid, { item: true, xs: 12 },
                                    React.createElement(Box, { mt: 2, style: { overflowX: 'auto', width: '100%' } },
                                        React.createElement(TableContainer, { component: Paper, style: { width: '100%' } },
                                            React.createElement(Table, { size: "small", style: { minWidth: '1200px', tableLayout: 'fixed' } },
                                                // パターンヘッダーを動的に表示するTableHead
                                                React.createElement(TableHead, null,
                                                    React.createElement(TableRow, { style: { height: `${rowHeight}px` } },
                                                        React.createElement(TableCell, { padding: "none", style: { width: coefficientColumnWidths.storeCode }, align: "center" }, "店舗コード"),
                                                        React.createElement(TableCell, { padding: "none", style: { width: coefficientColumnWidths.storeName }, align: "center" }, "店舗名"),
                                                        ...(patternHeaders && patternHeaders.length > 0 ? patternHeaders : ["パターン1", "パターン2"]).map((header, index) =>
                                                            React.createElement(TableCell, { key: index, padding: "none", align: "center" }, header)
                                                        )
                                                    )
                                                ),
                                                // coefficientDataに基づくTableBody
                                                React.createElement(TableBody, null,
                                                    (coefficientData && coefficientData.length > 0) ? coefficientData.map((row, rowIndex) =>
                                                        React.createElement(TableRow, { key: rowIndex, style: { height: `${rowHeight}px` } },
                                                            React.createElement(TableCell, { padding: "none", style: { width: coefficientColumnWidths.storeCode }, align: "center" },
                                                                React.createElement(TextField, {
                                                                    type: "text",
                                                                    value: row.storeCode,
                                                                    onChange: (e) => handleCoefficientInputChange(rowIndex, 0, e.target.value),
                                                                    fullWidth: true,
                                                                    inputProps: { style: { height: '40px', padding: '0 8px', textAlign: "center" } }
                                                                })
                                                            ),
                                                            React.createElement(TableCell, { padding: "none", style: { width: coefficientColumnWidths.storeName }, align: "center" },
                                                                React.createElement(TextField, {
                                                                    type: "text",
                                                                    value: row.storeName,
                                                                    onChange: (e) => handleCoefficientInputChange(rowIndex, 1, e.target.value),
                                                                    fullWidth: true,
                                                                    inputProps: { style: { height: '40px', padding: '0 8px', textAlign: "center" } }
                                                                })
                                                            ),
                                                            ...(row.patterns && row.patterns.length > 0 ? row.patterns : Array(2).fill(0)).map((patternValue, patternIndex) =>
                                                                React.createElement(TableCell, { key: patternIndex, padding: "none", align: "center" },
                                                                    React.createElement(TextField, {
                                                                        type: "number",
                                                                        step: "any",
                                                                        value: patternValue,
                                                                        onChange: (e) => handleCoefficientInputChange(rowIndex, patternIndex + 2, e.target.value),
                                                                        fullWidth: true,
                                                                        inputProps: { style: { height: '40px', padding: '0 8px', textAlign: "center" } }
                                                                    })
                                                                )
                                                            )
                                                        )
                                                    ) : (
                                                        React.createElement(TableRow, null,
                                                            React.createElement(TableCell, { colSpan: 3, align: "center" }, "データがありません")
                                                        )
                                                    )
                                                )
                                            )
                                        )
                                    )
                                )
                            )
                        )
                    )
                )
            );
        };

        ReactDOM.render(React.createElement(App), document.getElementById('root'));
    </script>
</body>

</html>
