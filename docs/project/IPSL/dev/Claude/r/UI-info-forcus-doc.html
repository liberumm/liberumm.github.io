<!DOCTYPE html><html lang="ja"><head><meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>電子メールシステム｜企画書タブのみ有効（他はモック）</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap"/>
<link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons"/>
<script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js" crossorigin></script>
<script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js" crossorigin></script>
<script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.23.8/babel.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mui/material@5.15.3/umd/material-ui.production.min.js" crossorigin></script>
<style>
  html,body,#root{height:100%}
  body{margin:0;background:#f6f7fb}
  .paper{border-radius:12px}
  .stickyTop{position:sticky;top:0;background:#fff;z-index:2;border-bottom:1px solid #eee}
  .rte-img{max-width:100%;height:auto;border-radius:8px}
  .rte-attachment{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border:1px solid #e0e0e0;border-radius:8px;background:#fafafa}
  .pageWrap{background:#e9ebf0;padding:16px}
  .a4{width:210mm;height:297mm;margin:16px auto;background:#fff;box-shadow:0 2px 12px rgba(0,0,0,.12);position:relative;overflow:hidden;--content-top:15mm;--content-bottom:18mm;--header-h:0px}
  .a4 .content{padding:15mm;box-sizing:border-box;height:calc(297mm - var(--content-top) - var(--content-bottom) - var(--header-h));overflow:visible;word-break:break-word}
  .a4-guides::before{content:"";position:absolute;inset:12mm;border:1px dashed rgba(0,0,0,.12);pointer-events:none}
  .doc-header{padding:8mm 15mm 0 15mm;font-size:12px}
  .doc-header-row{display:flex;gap:12px;align-items:flex-start;margin-bottom:6px;flex-wrap:wrap}
  .doc-header-col{flex:1 1 200px;min-width:200px}
  .doc-header-label{min-width:80px;color:#64748b;font-weight:600;font-size:11px}
  .doc-header-value{flex:1;border-bottom:1px solid #e2e8f0;padding:2px 0 4px;word-break:break-all}
  .doc-header-sep{border:none;border-top:2px solid #0ea5e9;margin:10px 0 8px}
  .content.show-breaks p,.content.show-breaks li,.content.show-breaks pre,.content.show-breaks blockquote{position:relative;min-height:1.2em}
  .content.show-breaks p::after,.content.show-breaks li::after,.content.show-breaks pre::after,.content.show-breaks blockquote::after{content:"¶";position:absolute;right:-0.8em;top:50%;transform:translateY(-50%);font-size:.85em;color:#94a3b8;opacity:.8;pointer-events:none}
  .content.show-breaks br::before{content:"↵";position:absolute;left:0;top:-1em;font-size:.8em;color:#94a3b8;opacity:.8;pointer-events:none}
  .content.breaks-hidden p::after,.content.breaks-hidden li::after,.content.breaks-hidden pre::after,.content.breaks-hidden blockquote::after,.content.breaks-hidden br::before{display:none!important}
  .mock{position:relative}
  .mock::after{content:"これはモック（無効）です";position:absolute;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(255,255,255,.6);backdrop-filter:blur(1px);font-weight:700;color:#334155;border:1px dashed #94a3b8}
</style>
</head><body><div id="root"></div>
<script type="text/babel">
const {useMemo,useState,useEffect,useRef} = React;
const M = MaterialUI;
const {ThemeProvider,createTheme,AppBar,Toolbar,Tooltip,IconButton,Button,Divider,Box,Paper,Grid,Stack,Typography,TextField,InputAdornment,Chip,Badge,List,ListItemButton,ListItemIcon,ListItemText,Checkbox,Dialog,DialogTitle,DialogContent,DialogActions,Select,MenuItem,Popover,Slider,Switch,FormControlLabel,useMediaQuery} = M;
const GROUPS=[{id:'sales',name:'営業部',members:[{id:'u1',name:'田中 太郎',email:'taro.tanaka@example.com'},{id:'u2',name:'山田 花子',email:'hanako.yamada@example.com'},{id:'u3',name:'佐藤 健',email:'ken.sato@example.com'},{id:'u4',name:'高橋 茜',email:'akane.takahashi@example.com'}]},{id:'dev',name:'開発部',members:[{id:'u5',name:'小林 翔',email:'sho.kobayashi@example.com'},{id:'u6',name:'鈴木 直子',email:'naoko.suzuki@example.com'},{id:'u7',name:'伊藤 誠',email:'makoto.ito@example.com'},{id:'u8',name:'渡辺 沙織',email:'saori.watanabe@example.com'},{id:'u9',name:'中村 悠',email:'haruka.nakamura@example.com'}]},{id:'hr',name:'人事・総務',members:[{id:'u10',name:'加藤 翔子',email:'shoko.kato@example.com'},{id:'u11',name:'松本 大',email:'dai.matsumoto@example.com'},{id:'u12',name:'石井 未来',email:'miki.ishii@example.com'}]}];
const PATTERNS=[{id:'all',name:'全社',groups:['sales','dev','hr']},{id:'store',name:'店舗連絡',groups:['sales']},{id:'hq',name:'本部連絡',groups:['dev','hr']},{id:'plan',name:'企画書',groups:['dev'],members:['u6']},{id:'asset',name:'資産購入',groups:['hr'],members:['u11']},{id:'trip',name:'出張申請',groups:['sales','hr']}];
const memberById=Object.fromEntries(GROUPS.flatMap(g=>g.members.map(m=>[m.id,{...m,groupId:g.id,groupName:g.name}])));
const blankSel=()=>Object.fromEntries(GROUPS.map(g=>[g.id,new Set()]));
const cloneSel=sel=>Object.fromEntries(Object.entries(sel).map(([k,v])=>[k,new Set([...v])]));
const allIds=sel=>Object.values(sel).reduce((a,s)=>(s.forEach(id=>a.push(id)),a),[]);
const Icon=({name,style})=> <span className="material-icons" style={style}>{name}</span>;
function printA4(){
  const src=document.querySelector('.pageWrap.print-area');
  if(!src){alert('印刷対象（A4プレビュー）が見つかりません。');return;}
  const win=window.open('','_blank');
  const html=`<!DOCTYPE html><html lang=ja><head><meta charset=utf-8><title>印刷</title><style>@page{size:A4 portrait;margin:12mm}body{margin:0;-webkit-print-color-adjust:exact;print-color-adjust:exact;font-family:Roboto,\"Noto Sans JP\",system-ui} .a4{width:210mm;min-height:297mm;margin:0 auto;page-break-after:always} .a4:last-child{page-break-after:auto} .a4 .content{padding:15mm} .a4-guides::before{content:none!important} .doc-header{padding:0 15mm} .doc-header-row{display:flex;gap:12px;flex-wrap:wrap;margin-bottom:6px} .doc-header-label{min-width:80px;color:#64748b;font-weight:600;font-size:11px} .doc-header-value{flex:1;border-bottom:1px solid #e2e8f0;padding:2px 0 4px}</style></head><body>${src.innerHTML}<script>window.onload=()=>{try{print()}finally{close()}}<\/script></body></html>`;
  win.document.open();win.document.write(html);win.document.close();
}
function PatternDialog({open,onClose,onApply}){
  const isSm=M.useMediaQuery('(max-width:600px)');
  const [chosen,setChosen]=useState(PATTERNS[0].id);
  const [mode,setMode]=useState('add');
  useEffect(()=>{if(open){setChosen(PATTERNS[0].id);setMode('add')}},[open]);
  return (
    <Dialog open={open} onClose={onClose} fullWidth maxWidth="sm" fullScreen={isSm}>
      <DialogTitle>宛先パターンを選択</DialogTitle>
      <DialogContent dividers>
        <Stack spacing={1}>
          <Select size="small" value={chosen} onChange={e=>setChosen(e.target.value)}>
            {PATTERNS.map(p=><MenuItem key={p.id} value={p.id}>{p.name}</MenuItem>)}
          </Select>
          <Select size="small" value={mode} onChange={e=>setMode(e.target.value)}>
            <MenuItem value="add">追加</MenuItem>
            <MenuItem value="replace">置換</MenuItem>
          </Select>
        </Stack>
      </DialogContent>
      <DialogActions>
        <Button onClick={onClose}>キャンセル</Button>
        <Button variant="contained" startIcon={<Icon name="bolt"/>} onClick={()=>onApply(chosen,mode)}>適用</Button>
      </DialogActions>
    </Dialog>
  );
}
function PickerBody({sel,setSel,activeGroupId,setActiveGroupId}){
  const isSm=useMediaQuery('(max-width:600px)');
  const [qG,setQG]=useState(''),[qM,setQM]=useState(''),[filter,setFilter]=useState('all');
  const [openPat,setOpenPat]=useState(false),[lastPat,setLastPat]=useState('');
  const g=useMemo(()=>GROUPS.find(x=>x.id===activeGroupId),[activeGroupId]);
  const cur=sel[activeGroupId]||new Set(); const idsAll=allIds(sel);
  const visibleGroups=useMemo(()=>GROUPS.filter(x=>x.name.toLowerCase().includes(qG.trim().toLowerCase())),[qG]);
  const visibleMembers=useMemo(()=>{const t=qM.trim().toLowerCase();return g.members.filter(m=>{const hit=!t||m.name.toLowerCase().includes(t)||m.email.toLowerCase().includes(t);return hit && (filter==='all'||(filter==='selected'?cur.has(m.id):!cur.has(m.id)));});},[g,qM,filter,cur]);
  const setMember=id=>setSel(p=>{const n={...p},s=new Set(p[activeGroupId]); s.has(id)?s.delete(id):s.add(id); n[activeGroupId]=s; return n;});
  const removeAnywhere=id=>{const gid=memberById[id].groupId; setSel(p=>{const n={...p},s=new Set(p[gid]); s.delete(id); n[gid]=s; return n;});};
  const toggleAll=()=>setSel(p=>{const n={...p},s=new Set(p[activeGroupId]),targets=visibleMembers.map(m=>m.id),all=targets.every(id=>s.has(id));targets.forEach(id=>all?s.delete(id):s.add(id)); n[activeGroupId]=s; return n;});
  const applyPattern=(patId,mode='add')=>{const p=PATTERNS.find(x=>x.id===patId); if(!p) return; setSel(prev=>{const next=(mode==='replace')?blankSel():cloneSel(prev); const add=(id)=>{const gid=memberById[id]?.groupId; if(!gid) return; (next[gid]||(next[gid]=new Set())).add(id);}; (p.groups||[]).forEach(gid=>GROUPS.find(x=>x.id===gid)?.members.forEach(m=>add(m.id))); (p.members||[]).forEach(add); return next;}); setLastPat(`${p.name}（${mode==='add'?'追加':'置換'}）`); setOpenPat(false);};
  const listH=isSm?'42vh':'48vh'; const allChecked=visibleMembers.length>0 && visibleMembers.every(m=>cur.has(m.id));
  return (
    <Box>
      <Box className="stickyTop" sx={{p:1.25}}>
        <Stack direction="row" alignItems="center" spacing={1}><Icon name="send"/><Typography variant="h6" sx={{fontWeight:600}}>送信先の選択</Typography><Box sx={{flex:1}}/><Chip label={`選択中: ${idsAll.length}`}/></Stack>
      </Box>
      <Box sx={{p:1.25,borderBottom:'1px solid #eee'}}>
        <Stack direction={{xs:'column',sm:'row'}} spacing={1} alignItems={{xs:'stretch',sm:'center'}}>
          <Typography sx={{fontWeight:600}}>宛先パターン</Typography>
          <Button variant="outlined" startIcon={<Icon name="category"/>} onClick={()=>setOpenPat(true)}>パターン選択</Button>
          {lastPat && <Chip size="small" variant="outlined" label={`適用済み: ${lastPat}`}/>}<Box sx={{flex:1}}/>
          <Button size="small" variant={allChecked?'outlined':'contained'} onClick={toggleAll} startIcon={<Icon name={allChecked?'check_box':'check_box_outline_blank'}/>}>表示中を全選択</Button>
        </Stack>
      </Box>
      <Grid container>
        <Grid item xs={12} md={4} lg={3} sx={{borderRight:{md:'1px solid #eee'}}}>
          <Box className="stickyTop" sx={{p:1.25}}>
            <TextField size="small" fullWidth placeholder="グループを検索…" value={qG} onChange={e=>setQG(e.target.value)} InputProps={{startAdornment:(<InputAdornment position="start"><Icon name="search"/></InputAdornment>)}}/>
          </Box>
          <Box className="scroll" style={{maxHeight:listH}}>
            <List dense>
              {visibleGroups.map(x=>{const c=sel[x.id]?.size??0,active=x.id===activeGroupId;return (
                <ListItemButton key={x.id} selected={active} onClick={()=>setActiveGroupId(x.id)}>
                  <ListItemText primary={<Stack direction="row" spacing={1} alignItems="center"><Typography sx={{fontWeight:active?700:500}}>{x.name}</Typography><Badge color={c?'primary':'default'} badgeContent={c}><span style={{width:0}}/></Badge></Stack>} secondary={`${x.members.length}名`}/>
                </ListItemButton>
              );})}
            </List>
          </Box>
        </Grid>
        <Grid item xs={12} md={8} lg={9}>
          <Box className="stickyTop" sx={{p:1.25,display:'grid',gap:8,gridTemplateColumns:{xs:'1fr',sm:'1fr auto auto'}}}>
            <TextField size="small" fullWidth placeholder={`${g.name} から検索…`} value={qM} onChange={e=>setQM(e.target.value)} InputProps={{startAdornment:(<InputAdornment position="start"><Icon name="person_search"/></InputAdornment>)}}/>
            <Stack direction="row" spacing={0.5} alignItems="center" justifyContent="center">
              <IconButton size="small" onClick={()=>{const i=GROUPS.findIndex(x=>x.id===activeGroupId); setActiveGroupId(GROUPS[(i-1+GROUPS.length)%GROUPS.length].id);}}><Icon name="chevron_left"/></IconButton>
              <Typography variant="body2" color="text.secondary">{g.name}</Typography>
              <IconButton size="small" onClick={()=>{const i=GROUPS.findIndex(x=>x.id===activeGroupId); setActiveGroupId(GROUPS[(i+1)%GROUPS.length].id);}}><Icon name="chevron_right"/></IconButton>
            </Stack>
            <Select size="small" value={filter} onChange={e=>setFilter(e.target.value)}>
              <MenuItem value="all">すべて</MenuItem><MenuItem value="selected">選択中のみ</MenuItem><MenuItem value="unselected">未選択のみ</MenuItem>
            </Select>
          </Box>
          <Box className="scroll" style={{maxHeight:listH}}>
            <List dense>
              {visibleMembers.map(m=>{const checked=cur.has(m.id);return (
                <ListItemButton key={m.id} onClick={()=>setMember(m.id)}>
                  <ListItemIcon><Checkbox edge="start" checked={checked} tabIndex={-1} disableRipple/></ListItemIcon>
                  <ListItemText primary={<Typography sx={{fontWeight:checked?600:400}}>{m.name}</Typography>} secondary={<Typography variant="caption" color="text.secondary">{m.email}</Typography>}/>
                </ListItemButton>
              );})}
            </List>
          </Box>
        </Grid>
      </Grid>
      <Box sx={{p:1.25,borderTop:'1px solid #eee'}}>
        <Stack direction="row" alignItems="center" spacing={1} mb={1}><Icon name="groups"/><Typography variant="subtitle1" sx={{fontWeight:600}}>選択状況確認</Typography><Box sx={{flex:1}}/>{idsAll.length>0&&<Button size="small" onClick={()=>setSel(blankSel())} startIcon={<Icon name="clear_all"/>}>すべてクリア</Button>}</Stack>
        <Box className="scroll" style={{maxHeight:'24vh',padding:'4px 0'}}>
          {idsAll.length===0? <Typography variant="body2" color="text.secondary">まだ選択されていません。</Typography>:
            <Box style={{display:'flex',gap:8,flexWrap:'wrap'}}>
              {idsAll.map(id=><Chip key={id} label={`${memberById[id].name}（${memberById[id].groupName}）`} onDelete={()=>removeAnywhere(id)} icon={<Icon name="person" style={{fontSize:18}}/>}/>)}
            </Box>}
        </Box>
      </Box>
      <PatternDialog open={openPat} onClose={()=>setOpenPat(false)} onApply={applyPattern}/>
    </Box>
  );
}
function PickerDialog({open,onClose,onConfirm,initial}){
  const isSm=useMediaQuery('(max-width:600px)');
  const [gid,setGid]=useState(GROUPS[0].id);
  const [sel,setSel]=useState(()=>initial||blankSel());
  useEffect(()=>{if(open) setSel(initial?cloneSel(initial):blankSel())},[open,initial]);
  return (
    <Dialog open={open} onClose={onClose} fullWidth maxWidth="lg" fullScreen={isSm}>
      <DialogContent dividers sx={{p:0}}>
        <PickerBody sel={sel} setSel={setSel} activeGroupId={gid} setActiveGroupId={setGid}/>
      </DialogContent>
      <DialogActions className="stickyBottom">
        <Button onClick={onClose} fullWidth={isSm}>キャンセル</Button>
        <Button variant="contained" onClick={()=>onConfirm(sel)} startIcon={<Icon name="check"/>} fullWidth={isSm}>決定して追加</Button>
      </DialogActions>
    </Dialog>
  );
}
function PageCanvas({initialHtml,onChange,onMouseDown,onAfterEdit,showBreaks}){
  const ref=useRef(null); const composing=useRef(false); const raf=useRef(0);
  useEffect(()=>{ if(ref.current) ref.current.innerHTML=initialHtml||''; },[]);
  useEffect(()=>{const el=ref.current;if(!el) return;showBreaks?el.classList.add('show-breaks'):el.classList.remove('show-breaks')},[showBreaks]);
  const emit=()=>{if(!ref.current) return; cancelAnimationFrame(raf.current); raf.current=requestAnimationFrame(()=>{onChange(ref.current.innerHTML); onAfterEdit?.();});};
  return <div ref={ref} className="content" contentEditable suppressContentEditableWarning spellCheck={false} style={{outline:'none'}} onMouseDown={onMouseDown} onCompositionStart={()=>{composing.current=true}} onCompositionEnd={()=>{composing.current=false;emit()}} onInput={()=>{if(!composing.current) emit()}} onBlur={emit}/>;
}
function RichEditor({pages,setPages,headerData}){
  const imgInputRef=useRef(null),fileInputRef=useRef(null); const [showBreaks,setShowBreaks]=useState(true);
  const [imgAnchor,setImgAnchor]=useState(null),[imgNode,setImgNode]=useState(null),[imgPct,setImgPct]=useState(60);
  const getPageEls=()=>Array.from(document.querySelectorAll('.a4 .content'));
  const getBlocks=el=>Array.from(el.childNodes).filter(n=>n.nodeType===1||(n.nodeType===3&&n.textContent.trim()));
  const isHeading=el=>el?.nodeType===1 && /H[1-3]/.test(el.tagName);
  const withBreaksHidden=(fn)=>{const els=getPageEls(); els.forEach(e=>e.classList.add('breaks-hidden')); try{return fn()} finally{setTimeout(()=>els.forEach(e=>e.classList.remove('breaks-hidden')),10)}};
  const sync=()=>setPages(getPageEls().map(el=>el.innerHTML));
  const recalc=()=>withBreaksHidden(()=>{Array.from(document.querySelectorAll('.a4')).forEach((pageEl,idx)=>{const header=idx===0?pageEl.querySelector('.doc-header'):null; const h=header?.getBoundingClientRect().height||0; pageEl.style.setProperty('--header-h',`${h}px`);});});
  const ensureLayout=()=>{requestAnimationFrame(()=>{recalc(); enforceHeadingsTop(); withBreaksHidden(()=>checkAllOverflows());});};
  const nearestUnit=(node)=>{const el=node&&node.nodeType===1?node:node?.parentElement; return el?.closest('tr,thead,tbody,tfoot,table')||node};
  const checkLastOverflow=(pageIndex)=>{const pagesEls=getPageEls(); const cur=pagesEls[pageIndex]; if(!cur) return; recalc(); const overflow=withBreaksHidden(()=> (cur.scrollHeight-cur.clientHeight) > Math.max(8,cur.clientHeight*0.015)); if(!overflow) return; const blocks=getBlocks(cur); if(!blocks.length) return; let last=nearestUnit(blocks[blocks.length-1]); if(!pagesEls[pageIndex+1]){ setPages(prev=>[...prev.slice(0,pageIndex+1),'',...prev.slice(pageIndex+1)]); return;} const next=getPageEls()[pageIndex+1]; if(last.nodeType===1 && last.tagName==='IMG' && last.offsetHeight>cur.clientHeight*0.8){ const curPct=parseInt(String(last.style.width||'').replace('%',''))||100; if(curPct>40){ last.style.width=`${Math.max(40,curPct-15)}%`; sync(); return; } } const move=isHeading(last)&&last.nextSibling?[last,last.nextSibling]:[last]; try{ move.reverse().forEach(n=>next.insertBefore(n,next.firstChild)); sync(); }catch{} };
  const enforceHeadingsTop=()=>{const pages=getPageEls(); let changed=false; pages.forEach((pageEl,idx)=>{const children=getBlocks(pageEl); if(children.length<=1) return; const i=children.findIndex((node,i)=>i>0 && isHeading(node)); if(i===-1) return; const heading=children[i]; if(!pages[idx+1]){ setPages(prev=>[...prev,'']); changed=true; return;} const next=getPageEls()[idx+1]; const move=heading.nextSibling?[heading,heading.nextSibling]:[heading]; try{ move.reverse().forEach(n=>next.insertBefore(n,next.firstChild)); changed=true; }catch{} }); if(changed) sync(); };
  const checkAllOverflows=()=>{withBreaksHidden(()=>{for(let i=0;i<getPageEls().length;i++) checkLastOverflow(i);});};
  const exec=(cmd,val=null)=>{document.querySelector('.a4 .content')?.focus(); try{document.execCommand(cmd,false,val)}catch{} sync(); recalc(); enforceHeadingsTop()};
  const execCss=(cmd,val=null)=>{document.querySelector('.a4 .content')?.focus(); try{document.execCommand('styleWithCSS',true)}catch{} try{document.execCommand(cmd,false,val)}catch{} sync(); recalc(); enforceHeadingsTop()};
  const wrapSpan=(styles)=>{const sel=window.getSelection(); if(!sel||sel.rangeCount===0) return; const range=sel.getRangeAt(0); const pagesEls=getPageEls(); let targetIdx=pagesEls.findIndex(el=>el.contains(range.commonAncestorContainer)); if(range.collapsed){const span=document.createElement('span'); Object.assign(span.style,styles); span.appendChild(document.createTextNode('\u200B')); range.insertNode(span); const n=document.createRange(); n.setStart(span.firstChild,1); n.collapse(true); sel.removeAllRanges(); sel.addRange(n);}else{ try{const span=document.createElement('span'); Object.assign(span.style,styles); const contents=range.extractContents(); span.appendChild(contents); range.insertNode(span); sel.removeAllRanges(); const n=document.createRange(); n.selectNodeContents(span); sel.addRange(n);}catch{ const div=document.createElement('div'); div.appendChild(range.cloneContents()); const css=Object.entries(styles).map(([k,v])=>`${k.replace(/[A-Z]/g,m=>'-'+m.toLowerCase())}:${v}`).join(';'); document.execCommand('insertHTML',false,`<span style="${css}">${div.innerHTML}</span>`); } } sync(); requestAnimationFrame(()=>{recalc(); enforceHeadingsTop(); withBreaksHidden(()=>{if(targetIdx<0) targetIdx=0; checkLastOverflow(targetIdx);});}); };
  const applyFont=(ff)=>wrapSpan({fontFamily:ff});
  const applySize=(px)=>wrapSpan({fontSize:`${px}px`,lineHeight:'1.7'});
  const applyColor=(c)=>execCss('foreColor',c);
  const applyBg=(c)=>{try{execCss('hiliteColor',c)}catch{execCss('backColor',c)}};
  const onPick=(e,type)=>{const files=[...e.target.files||[]]; files.forEach(f=>{const reader=new FileReader(); reader.onload=()=>{insertAtTop(type==='img'?`<img class=\"rte-img\" style=\"width:60%\" src=\"${reader.result}\" alt=\"${f.name}\"/>`:`<span class=\"rte-attachment\"><span class=\"material-icons\">attach_file</span><a href=\"${URL.createObjectURL(f)}\" download=\"${f.name}\">${f.name}</a><span>(${Math.round(f.size/1024)}KB)</span></span>&nbsp;`)}; type==='img'?reader.readAsDataURL(f):reader.readAsArrayBuffer(f)}); e.target.value=''; ensureLayout(); };
  const insertAtTop=(html)=>{const first=document.querySelector('.a4 .content'); if(!first) return; const range=document.createRange(); range.setStart(first,0); range.collapse(true); const sel=window.getSelection(); sel?.removeAllRanges(); sel?.addRange(range); if(document.queryCommandSupported('insertHTML')){document.execCommand('insertHTML',false,html)} else {const div=document.createElement('div'); div.innerHTML=html; const frag=document.createDocumentFragment(); let node; while((node=div.firstChild)) frag.appendChild(node); range.insertNode(frag);} const updated=document.querySelector('.a4 .content')?.innerHTML||''; setPages(p=>{const n=[...p]; n[0]=updated; return n}); ensureLayout(); };
  const onEditorMouseDown=e=>{const t=e.target; if(t && t.tagName==='IMG'){setImgNode(t); const pct=parseInt(String(t.style.width||'').replace('%',''))||100; setImgPct(pct); setImgAnchor(t)} else {setImgAnchor(null); setImgNode(null)}};
  const applyImgWidth=pct=>{if(!imgNode) return; const v=Math.max(10,Math.min(100,Array.isArray(pct)?pct[0]:pct)); imgNode.style.width=v+'%'; setImgPct(v); const idx=getPageEls().findIndex(el=>el.contains(imgNode)); if(idx>=0){ const html=getPageEls()[idx].innerHTML; setPages(p=>{const n=[...p]; n[idx]=html; return n}); ensureLayout(); }};
  const removeImg=()=>{if(!imgNode) return; const parent=getPageEls().find(el=>el.contains(imgNode)); imgNode.remove(); setImgNode(null); setImgAnchor(null); if(parent){ const idx=getPageEls().indexOf(parent); setPages(p=>{const n=[...p]; n[idx]=parent.innerHTML; return n}); ensureLayout(); }};
  const addPage=()=>setPages(prev=>[...prev,'']);
  const delLast=()=>setPages(prev=> prev.length<=1?prev : prev.slice(0,-1));
  const ToolbarBtn=({icon,label,onClick,active})=> (<Tooltip title={label}><IconButton size="small" onClick={onClick} color={active?'primary':'default'}><span className="material-icons">{icon}</span></IconButton></Tooltip>);
  return (
    <Paper className="paper" variant="outlined">
      <Stack direction="row" spacing={0.5} sx={{p:1,borderBottom:'1px solid #e5e7eb',flexWrap:'wrap'}} alignItems="center">
        <Tooltip title="画像挿入（1ページ目の先頭）"><IconButton size="small" onClick={()=>imgInputRef.current.click()}><span className="material-icons">image</span></IconButton></Tooltip>
        <input ref={imgInputRef} type="file" accept="image/*" multiple hidden onChange={e=>onPick(e,'img')}/>
        <Tooltip title="添付（本文にバッジ）"><IconButton size="small" onClick={()=>fileInputRef.current.click()}><span className="material-icons">attach_file</span></IconButton></Tooltip>
        <input ref={fileInputRef} type="file" multiple hidden onChange={e=>onPick(e,'file')}/>
        <Divider flexItem orientation="vertical" sx={{mx:1}}/>
        <Button size="small" startIcon={<Icon name="post_add"/>} onClick={addPage}>ページ追加</Button>
        <Button size="small" startIcon={<Icon name="delete"/>} onClick={delLast}>最後のページ削除</Button>
        <Box sx={{flex:1}}/><Typography variant="caption" color="text.secondary" sx={{px:1}}>A4プレビュー</Typography>
      </Stack>
      <div className="stickyTop" style={{display:'flex',flexWrap:'wrap',gap:6,padding:8}}>
        <ToolbarBtn icon="undo" label="取り消し" onClick={()=>exec('undo')}/>
        <ToolbarBtn icon="redo" label="やり直し" onClick={()=>exec('redo')}/>
        <Divider orientation="vertical" flexItem sx={{mx:1}}/>
        <ToolbarBtn icon="format_bold" label="太字" onClick={()=>exec('bold')}/>
        <ToolbarBtn icon="format_italic" label="斜体" onClick={()=>exec('italic')}/>
        <ToolbarBtn icon="format_underline" label="下線" onClick={()=>exec('underline')}/>
        <ToolbarBtn icon="strikethrough_s" label="取消線" onClick={()=>exec('strikeThrough')}/>
        <ToolbarBtn icon="format_clear" label="書式クリア" onClick={()=>exec('removeFormat')}/>
        <Divider orientation="vertical" flexItem sx={{mx:1}}/>
        <Select size="small" defaultValue={"P"} onChange={e=>exec('formatBlock',e.target.value)} sx={{minWidth:120}}>
          <MenuItem value="P">段落</MenuItem><MenuItem value="H1">見出しH1</MenuItem><MenuItem value="H2">見出しH2</MenuItem><MenuItem value="H3">見出しH3</MenuItem><MenuItem value="BLOCKQUOTE">引用</MenuItem><MenuItem value="PRE">コード</MenuItem>
        </Select>
        <Select size="small" defaultValue={14} onChange={e=>applySize(Number(e.target.value))} sx={{minWidth:90,ml:1}}>
          {[12,13,14,15,16,18,20,24,28].map(s=> <MenuItem key={s} value={s}>{s}px</MenuItem>)}
        </Select>
        <Tooltip title="文字色"><IconButton size="small" onClick={()=>document.getElementById('txtColor').click()}><span className="material-icons">format_color_text</span></IconButton></Tooltip>
        <input id="txtColor" type="color" hidden onChange={e=>applyColor(e.target.value)}/>
        <Tooltip title="背景色"><IconButton size="small" onClick={()=>document.getElementById('bgColor').click()}><span className="material-icons">format_color_fill</span></IconButton></Tooltip>
        <input id="bgColor" type="color" hidden onChange={e=>applyBg(e.target.value)}/>
        <ToolbarBtn icon="horizontal_rule" label="ページ区切り（横罫線）" onClick={()=>document.execCommand('insertHTML',false,'<hr class=\'rte-hr\'/>')}/>
        <ToolbarBtn icon="link" label="リンク" onClick={()=>{const u=prompt('リンクURL（https://…）'); if(u) document.execCommand('createLink',false,u)}}/>
        <ToolbarBtn icon="link_off" label="リンク解除" onClick={()=>exec('unlink')}/>
        <ToolbarBtn icon="visibility" label={showBreaks?'改行記号を非表示':'改行記号を表示'} active={showBreaks} onClick={()=>setShowBreaks(v=>!v)}/>
      </div>
      <Box className="pageWrap print-area">
        {pages.map((html,idx)=> (
          <div key={idx} className="a4 a4-guides">
            {idx===0 && (
              <div className="doc-header" contentEditable={false}>
                <div className="doc-header-row"><div className="doc-header-label">発信件名</div><div className="doc-header-value">{headerData.subject||'（未入力）'}</div></div>
                <div className="doc-header-row">
                  <div className="doc-header-col"><div className="doc-header-label">フォーム</div><div className="doc-header-value">企画書</div></div>
                  <div className="doc-header-col"><div className="doc-header-label">発信日</div><div className="doc-header-value">{headerData.sendDate||'yyyy/mm/dd'}</div></div>
                </div>
                <div className="doc-header-row"><div className="doc-header-label">宛先</div><div className="doc-header-value">{headerData.toText||'宛先は未選択です。'}</div></div>
                <div className="doc-header-row">
                  <div className="doc-header-col"><div className="doc-header-label">伝達対象</div><div className="doc-header-value">{headerData.target||'—'}</div></div>
                  <div className="doc-header-col"><div className="doc-header-label">発信部署</div><div className="doc-header-value">{headerData.originator||'—'}</div></div>
                </div>
                <div className="doc-header-row">
                  <div className="doc-header-col"><div className="doc-header-label">返信期限</div><div className="doc-header-value">{headerData.deadline||'—'}</div></div>
                  <div className="doc-header-col"><div className="doc-header-label">担当者</div><div className="doc-header-value">{headerData.assignee||'—'}</div></div>
                </div>
                <hr className="doc-header-sep"/>
              </div>
            )}
            <PageCanvas initialHtml={html} onChange={nh=>setPages(p=>{const n=[...p];n[idx]=nh;return n})} onMouseDown={e=>{const t=e.target;if(t&&t.tagName==='IMG'){setImgNode(t);setImgAnchor(t);setImgPct(parseInt(String(t.style.width||'').replace('%',''))||100)} else {setImgAnchor(null);setImgNode(null)}}} onAfterEdit={()=>{withBreaksHidden(()=>{recalc(); enforceHeadingsTop(); checkAllOverflows();})}} showBreaks={showBreaks}/>
          </div>
        ))}
      </Box>
      <Popover open={Boolean(imgAnchor)} anchorEl={imgAnchor} onClose={()=>setImgAnchor(null)} anchorOrigin={{vertical:'top',horizontal:'center'}} transformOrigin={{vertical:'bottom',horizontal:'center'}}>
        <Box sx={{p:1.5,width:260}}>
          <Typography variant="caption" sx={{display:'block',mb:.5}}>画像サイズ（%）</Typography>
          <Slider min={10} max={100} step={1} value={imgPct} onChange={(_,v)=>applyImgWidth(v)}/>
          <Stack direction="row" spacing={1} justifyContent="space-between">
            {[25,50,75,100].map(p=> <Button key={p} size="small" variant={imgPct===p?'contained':'outlined'} onClick={()=>applyImgWidth(p)}>{p}%</Button>)}
            <Box sx={{flex:1}}/>
            <Tooltip title="画像を削除"><IconButton color="error" size="small" onClick={removeImg}><span className="material-icons">delete</span></IconButton></Tooltip>
          </Stack>
        </Box>
      </Popover>
    </Paper>
  );
}
function ComposeProposal(){
  const [subject,setSubject]=useState('');
  const [originator,setOriginator]=useState('');
  const [assignee,setAssignee]=useState('');
  const [target,setTarget]=useState('');
  const [sendDate,setSendDate]=useState('');
  const [deadline,setDeadline]=useState('');
  const [pages,setPages]=useState(['']);
  const [toSel,setToSel]=useState(blankSel()), [ccSel,setCcSel]=useState(blankSel());
  const [openPicker,setOpenPicker]=useState(false), [pickerKind,setPickerKind]=useState('to');
  const CountBadge=({n})=><Badge badgeContent={n} color={n?'secondary':'default'}><Icon name="groups"/></Badge>;
  const ids=a=>allIds(a); const toIds=ids(toSel), ccIds=ids(ccSel);
  const rm=(kind,id)=>{const gid=memberById[id].groupId; const up=p=>{const n={...p},s=new Set(p[gid]); s.delete(id); n[gid]=s; return n}; (kind==='to'?setToSel:setCcSel)(up);};
  const toText = toIds.length ? toIds.map(id => memberById[id].name).join('、') : '宛先は未選択です。';
  return (
    <Box sx={{width:'100%',mx:'auto',p:2}}>
      <Paper className="paper" sx={{p:2}}>
        <Grid container spacing={2} alignItems="center">
          <Grid item xs={12} md={6}>
            <Typography variant="subtitle2" color="text.secondary" sx={{mb:.5}}>発信件名</Typography>
            <TextField fullWidth value={subject} onChange={e=>setSubject(e.target.value)} placeholder="件名を入力"/>
          </Grid>
          <Grid item xs={6} md={3}>
            <Typography variant="subtitle2" color="text.secondary" sx={{mb:.5}}>フォーム</Typography>
            <TextField fullWidth value="企画書" disabled/>
          </Grid>
          <Grid item xs={6} md={3}>
            <Typography variant="subtitle2" color="text.secondary" sx={{mb:.5}}>発信日</Typography>
            <TextField type="date" fullWidth value={sendDate} onChange={e=>setSendDate(e.target.value)}/>
          </Grid>
        </Grid>
        <Divider sx={{my:2,borderStyle:'dashed'}}/>
        <Grid container spacing={2}>
          <Grid item xs={12} md={6}>
            <Typography variant="subtitle2" color="text.secondary" sx={{mb:.5}}>宛先</Typography>
            <Stack direction="row" spacing={1} alignItems="center" sx={{mb:1}}>
              <Tooltip title="宛先を選択"><Button variant="outlined" onClick={()=>{setPickerKind('to');setOpenPicker(true);}} startIcon={<Icon name="group_add"/>} endIcon={<CountBadge n={toIds.length}/>}>宛先</Button></Tooltip>
              <Tooltip title="（写）を選択"><Button variant="outlined" onClick={()=>{setPickerKind('cc');setOpenPicker(true);}} startIcon={<Icon name="group"/>} endIcon={<CountBadge n={ccIds.length}/>}>（写）</Button></Tooltip>
            </Stack>
            {toIds.length===0? <Typography variant="body2" color="text.secondary">宛先は未選択です。</Typography>:
              <Box sx={{display:'flex',gap:.75,flexWrap:'wrap',mb:1}}>
                {toIds.map(id=><Chip key={id} size="small" onDelete={()=>rm('to',id)} label={`${memberById[id].name}（${memberById[id].groupName}）`} icon={<Icon name="person" style={{fontSize:18}}/>}/>) }
              </Box>}
            {ccIds.length>0 && <Box sx={{display:'flex',gap:.75,flexWrap:'wrap'}}>
              {ccIds.map(id=><Chip key={id} size="small" onDelete={()=>rm('cc',id)} label={`(写) ${memberById[id].name}（${memberById[id].groupName}）`} icon={<Icon name="person" style={{fontSize:18}}/>}/>) }
            </Box>}
          </Grid>
          <Grid item xs={12} md={3}>
            <Typography variant="subtitle2" color="text.secondary" sx={{mb:.5}}>伝達対象</Typography>
            <TextField fullWidth placeholder="例：全社員 / 取締役会" value={target} onChange={e=>setTarget(e.target.value)}/>
          </Grid>
          <Grid item xs={12} md={3}>
            <Typography variant="subtitle2" color="text.secondary" sx={{mb:.5}}>発信部署</Typography>
            <TextField fullWidth placeholder="所属名" value={originator} onChange={e=>setOriginator(e.target.value)}/>
          </Grid>
        </Grid>
        <Grid container spacing={2} sx={{mt:1}}>
          <Grid item xs={12} md={3}>
            <Typography variant="subtitle2" color="text.secondary" sx={{mb:.5}}>返信期限</Typography>
            <TextField type="date" fullWidth value={deadline.replaceAll('/','-')} onChange={e=>setDeadline(e.target.value.replaceAll('-','/'))}/>
          </Grid>
          <Grid item xs={12} md={3}>
            <Typography variant="subtitle2" color="text.secondary" sx={{mb:.5}}>担当者</Typography>
            <TextField fullWidth placeholder="担当者名" value={assignee} onChange={e=>setAssignee(e.target.value)}/>
          </Grid>
        </Grid>
        <Divider sx={{my:2,borderStyle:'dashed'}}/>
        <Typography variant="subtitle2" color="text.secondary" sx={{mb:.5}}>本文（A4プレビュー／改行記号／画像・添付）</Typography>
        <RichEditor pages={pages} setPages={setPages} headerData={{subject,sendDate:sendDate.replaceAll('-','/'),toText,target,originator,deadline,assignee}}/>
      </Paper>
      <Box mt={2} display="flex" justifyContent="flex-end" gap={1}>
        <Button startIcon={<Icon name="print"/>} onClick={printA4}>プレビュー/印刷</Button>
        <Button onClick={()=>{const payload={status:'下書き',subject,originator,assignee,target,sendDate,deadline,body:pages.join('<hr style=\"page-break-after:always;border:none;\"/>'), to:toIds, cc:ccIds}; console.log('企画書下書き',payload); alert('下書き保存しました（コンソールを確認）');}}>下書き保存</Button>
        <Button variant="contained" startIcon={<Icon name="send"/>} onClick={()=>{const payload={status:'発信',subject,originator,assignee,target,sendDate,deadline,body:pages.join('<hr style=\"page-break-after:always;border:none;\"/>'), to:toIds, cc:ccIds}; console.log('企画書発信',payload); alert('発信しました（コンソールを確認）');}}>発信（企画書）</Button>
      </Box>
      <PickerDialog open={openPicker} onClose={()=>setOpenPicker(false)} onConfirm={s=>{(pickerKind==='to'?setToSel:setCcSel)(s); setOpenPicker(false);}} initial={pickerKind==='to'?toSel:ccSel}/>
    </Box>
  );
}
function App(){
  const theme=useMemo(()=>createTheme({palette:{primary:{main:'#6366F1'},secondary:{main:'#14B8A6'},background:{default:'#f6f7fb'}},shape:{borderRadius:12},typography:{fontFamily:['Roboto','system-ui','-apple-system','BlinkMacSystemFont','Segoe UI','"Noto Sans JP"','sans-serif'].join(',')}}),[]);
  const [page,setPage]=useState('composeProposal');
  const TopButton=({label,icon,active,disabled,onClick})=> (<Button variant={active?'contained':'text'} disabled={disabled} onClick={onClick} startIcon={<Icon name={icon}/>}>{label}</Button>);
  return (
    <ThemeProvider theme={theme}>
      <M.AppBar elevation={0} position="sticky" sx={{background:'#fff',borderBottom:'1px solid #e5e7eb',color:'inherit'}}>
        <Toolbar variant="dense" sx={{gap:1,flexWrap:'wrap'}}>
          <TopButton label="一覧" icon="inbox" active={page==='list'} disabled onClick={()=>setPage('list')}/>
          <TopButton label="発信文書作成" icon="edit" active={page==='composeNotice'} disabled onClick={()=>setPage('composeNotice')}/>
          <TopButton label="企画書作成" icon="description" active={page==='composeProposal'} onClick={()=>setPage('composeProposal')}/>
          <Divider orientation="vertical" flexItem sx={{mx:1}}/>
          <Stack direction="row" alignItems="center" spacing={1}><Icon name="dashboard"/><Typography variant="h6" sx={{fontWeight:700}}>企画書作成（他タブはモック）</Typography></Stack>
          <Box sx={{flex:1}}/>
          <Tooltip title="A4プレビューを印刷"><IconButton onClick={printA4}><Icon name="print"/></IconButton></Tooltip>
        </Toolbar>
      </M.AppBar>
      {page!=='composeProposal' && (
        <Box sx={{p:2}}>
          <Paper className="paper mock" sx={{p:3,minHeight:240}}>
            <Typography variant="h6" gutterBottom>このタブはモック（UIのみ）です</Typography>
            <Typography color="text.secondary">実装対象外：一覧／発信文書作成</Typography>
          </Paper>
        </Box>
      )}
      {page==='composeProposal' && <ComposeProposal/>}
    </ThemeProvider>
  );
}
ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
</script>
</body></html>
