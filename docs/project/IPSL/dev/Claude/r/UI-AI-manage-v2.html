<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <title>AIチャットボット管理 — Demo Console</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />

    <!-- フォント -->
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap"
    />
    <!-- Material Icons（フォントアイコン） -->
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/icon?family=Material+Icons"
    />

    <style>
      html, body, #root {
        height: 100%;
        margin: 0;
        background: #fafafa;
        font-family: "Roboto", "Helvetica", "Arial", sans-serif;
      }
      .material-icons {
        vertical-align: middle;
      }
      *:focus-visible {
        outline: 2px solid #1976d2;
        outline-offset: 2px;
      }
      section {
        scroll-margin-top: 72px;
      }
      .tight > * {
        margin-top: 8px !important;
        margin-bottom: 8px !important;
      }
      @media (max-width: 600px) {
        .appTitle {
          font-size: 16px !important;
        }
      }
    </style>
  </head>
  <body>
    <div id="root"></div>

    <!-- Babel Standalone（JSX -> JS 変換用） -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- React 19 / MUI 7.3.5 / Icons を ESM import -->
    <script type="module">
      import React from "https://esm.sh/react@19.2.0";
      import { createRoot } from "https://esm.sh/react-dom@19.2.0/client";
      import * as MaterialUI from "https://esm.sh/@mui/material@7.3.5?deps=react@19.2.0,react-dom@19.2.0";
      import * as MaterialIcons from "https://esm.sh/@mui/icons-material@7.3.5?deps=react@19.2.0,react-dom@19.2.0";

      const appCode = `
        const {
          useState,
          useEffect,
          useMemo
        } = React;

        const {
          ThemeProvider,
          createTheme,
          CssBaseline,
          useMediaQuery,
          Container,
          Box,
          Stack,
          AppBar,
          Toolbar,
          Typography,
          Paper,
          Divider,
          Button,
          IconButton,
          Tabs,
          Tab,
          TextField,
          List,
          ListItemText,
          ListItemButton,
          ListItemAvatar,
          Avatar,
          Grid,
          Slider,
          Select,
          MenuItem,
          FormControl,
          InputLabel,
          Chip,
          Card,
          CardContent,
          Dialog,
          DialogTitle,
          DialogContent,
          DialogActions,
          Table,
          TableBody,
          TableCell,
          TableContainer,
          TableHead,
          TableRow
        } = MaterialUI;

        const {
          Send,
          Chat,
          SmartToy,
          Settings,
          Dashboard,
          History,
          Security,
          Star,
          ThumbUp,
          ThumbDown,
          Edit,
          Group,
          Person,
          Business
        } = MaterialIcons;

        // ==== Utils ====
        const LS = {
          load: function(key, fallback) {
            try {
              const raw = localStorage.getItem(key);
              if (!raw) return fallback;
              const parsed = JSON.parse(raw);
              return parsed == null ? fallback : parsed;
            } catch (e) {
              return fallback;
            }
          },
          save: function(key, value) {
            try {
              localStorage.setItem(key, JSON.stringify(value));
            } catch (e) {
              // ignore
            }
          }
        };

        const uid = function(prefix) {
          const p = prefix || "id";
          return p + "_" + Math.random().toString(36).slice(2, 9);
        };

        // ==== デフォルトデータ ====

        const defaultAgents = function() {
          return [
            {
              id: uid("agent"),
              name: "FAQエージェント",
              description: "よくある質問に回答する標準エージェント。",
              model: "gpt-4.1-mini",
              version: "v1.0",
              temperature: 0.2,
              systemPrompt: "あなたはFAQ専用のアシスタントです。簡潔に日本語で回答してください。",
              createdAt: new Date().toISOString(),
              isActive: true,
              ragFiles: [],
              ragSettings: {
                chunkSize: 800,
                chunkOverlap: 100,
                embeddingModel: "text-embedding-3-small",
                retrievalCount: 5,
                similarityThreshold: 0.7
              }
            },
            {
              id: uid("agent"),
              name: "トリアージエージェント",
              description: "問い合わせ内容をカテゴリに振り分けます。",
              model: "gpt-4o-mini",
              version: "v1.0",
              temperature: 0.1,
              systemPrompt: "ユーザーの意図を分類し、どの窓口につなぐかを決めるルーターです。",
              createdAt: new Date().toISOString(),
              isActive: true,
              ragFiles: [],
              ragSettings: {
                chunkSize: 600,
                chunkOverlap: 50,
                embeddingModel: "text-embedding-3-small",
                retrievalCount: 3,
                similarityThreshold: 0.8
              }
            }
          ];
        };

        const defaultBots = function(agents) {
          const primaryAgentId = (agents[0] && agents[0].id) || null;
          return [
            {
              id: uid("bot"),
              name: "Webサイト用 FAQ ボット",
              description: "コーポレートサイトの問い合わせ窓口。",
              status: "draft",
              channel: "web",
              entryMessage: "こんにちは。ご質問をどうぞ。",
              primaryAgentId: primaryAgentId,
              agentIds: [primaryAgentId].filter(Boolean)
            }
          ];
        };

        const defaultChatHistory = function() {
          return [
            {
              id: uid("chat"),
              botId: null,
              userId: "user_001",
              userName: "田中太郎",
              timestamp: new Date(Date.now() - 86400000).toISOString(),
              messages: [
                { from: "user", text: "営業時間を教えてください", timestamp: new Date(Date.now() - 86400000).toISOString() },
                { from: "bot", text: "営業時間は平日9:00-18:00です。", timestamp: new Date(Date.now() - 86399000).toISOString() }
              ],
              rating: 4,
              feedback: "迅速な回答でした",
              resolved: true
            },
            {
              id: uid("chat"),
              botId: null,
              userId: "user_002",
              userName: "佐藤花子",
              timestamp: new Date(Date.now() - 43200000).toISOString(),
              messages: [
                { from: "user", text: "料金プランについて", timestamp: new Date(Date.now() - 43200000).toISOString() },
                { from: "bot", text: "料金プランは基本プラン月額1000円からです。", timestamp: new Date(Date.now() - 43199000).toISOString() },
                { from: "user", text: "詳細資料はありますか？", timestamp: new Date(Date.now() - 43100000).toISOString() },
                { from: "bot", text: "資料をメールでお送りします。", timestamp: new Date(Date.now() - 43099000).toISOString() }
              ],
              rating: 5,
              feedback: "とても親切でした",
              resolved: true
            }
          ];
        };

        const defaultPermissions = function() {
          return {
            organizations: [
              {
                id: uid("org"),
                name: "本社",
                description: "本社組織",
                permissions: ["admin", "manage_bots", "manage_agents", "view_history"]
              },
              {
                id: uid("org"),
                name: "営業部",
                description: "営業部門",
                permissions: ["manage_bots", "view_history"]
              }
            ],
            users: [
              {
                id: uid("user"),
                name: "管理者",
                email: "admin@example.com",
                organizationId: null,
                role: "admin",
                permissions: ["admin", "manage_bots", "manage_agents", "view_history", "manage_permissions"]
              },
              {
                id: uid("user"),
                name: "営業担当A",
                email: "sales-a@example.com",
                organizationId: null,
                role: "user",
                permissions: ["manage_bots", "view_history"]
              }
            ]
          };
        };

        // ==== モーダルメッセージ ====
        function MessageDialog(props) {
          const open = props.open;
          const onClose = props.onClose;
          const title = props.title || "メッセージ";
          const message = props.message || "";
          return (
            <Dialog open={open} onClose={onClose} fullWidth maxWidth="xs">
              <DialogTitle>{title}</DialogTitle>
              <DialogContent>
                <Typography variant="body2">{message}</Typography>
              </DialogContent>
              <DialogActions>
                <Button onClick={onClose} autoFocus>OK</Button>
              </DialogActions>
            </Dialog>
          );
        }

        // ==== Bot 管理セクション ====
        function BotsSection(props) {
          const bots = props.bots;
          const setBots = props.setBots;
          const agents = props.agents;
          const notify = props.notify;

          const [selectedId, setSelectedId] = useState(bots[0] ? bots[0].id : null);
          const [chatInput, setChatInput] = useState("");
          const [messages, setMessages] = useState([]);

          useEffect(function() {
            if (!selectedId && bots[0]) {
              setSelectedId(bots[0].id);
            }
          }, [bots, selectedId]);

          const currentBot = useMemo(function() {
            return (bots || []).find(function(b) { return b.id === selectedId; }) || null;
          }, [bots, selectedId]);

          const updateBot = function(patch) {
            if (!currentBot) return;
            setBots(function(prev) {
              return (prev || []).map(function(b) {
                if (b.id === currentBot.id) {
                  return Object.assign({}, b, patch);
                }
                return b;
              });
            });
          };

          const handleAdd = function() {
            const primaryAgentId = (agents[0] && agents[0].id) || null;
            const bot = {
              id: uid("bot"),
              name: "新規チャットボット",
              description: "",
              status: "draft",
              channel: "web",
              entryMessage: "こんにちは。どんなことでお手伝いできますか？",
              primaryAgentId: primaryAgentId,
              agentIds: [primaryAgentId].filter(Boolean)
            };
            setBots(function(prev) {
              const next = (prev || []).concat([bot]);
              return next;
            });
            setSelectedId(bot.id);
            notify("チャットボットを追加しました。");
          };

          const handleAddAgent = function(agentId) {
            if (!currentBot || (currentBot.agentIds || []).includes(agentId)) return;
            updateBot({ agentIds: (currentBot.agentIds || []).concat([agentId]) });
            notify("エージェントを追加しました。");
          };

          const handleRemoveAgent = function(agentId) {
            if (!currentBot) return;
            const newAgentIds = (currentBot.agentIds || []).filter(function(id) { return id !== agentId; });
            updateBot({ 
              agentIds: newAgentIds,
              primaryAgentId: currentBot.primaryAgentId === agentId ? (newAgentIds[0] || null) : currentBot.primaryAgentId
            });
            notify("エージェントを削除しました。");
          };

          const handleDelete = function(id) {
            if (!window.confirm("このボットを削除しますか？")) return;
            setBots(function(prev) {
              return (prev || []).filter(function(b) { return b.id !== id; });
            });
            const remain = (bots || []).filter(function(b) { return b.id !== id; });
            setSelectedId(remain[0] ? remain[0].id : null);
            notify("チャットボットを削除しました。");
          };

          const handleSend = function() {
            if (!currentBot) return;
            if (!chatInput.trim()) return;
            const q = chatInput.trim();
            const userMsg = { from: "user", text: q, id: uid("msg") };
            const botAgents = (currentBot.agentIds || []).map(function(id) {
              return (agents || []).find(function(a) { return a.id === id; });
            }).filter(Boolean);
            const agentName = botAgents.length > 0 ? botAgents.map(function(a) { return a.name; }).join(", ") : "エージェント";
          const botMsg = {
            from: "bot",
            text:
              "［モック応答］ボット「" +
              (currentBot.name || "") +
              "」がエージェントセット[" +
              agentName +
              "]で処理します。\\n\\n質問: " +
              q +
              "\\n→ ここに実際のLLM応答が入ります。",
            id: uid("msg")
          };
            setMessages(function(prev) { return prev.concat([userMsg, botMsg]); });
            setChatInput("");
          };

          return (
            <section>
              <Paper variant="outlined">
                <Box p={2}>
                  <Typography variant="h6">
                    <Chat sx={{ mr:1, verticalAlign:"middle" }} />
                    チャットボット管理（モック）
                  </Typography>
                </Box>
                <Divider />
                <Box p={2}>
                  <Grid container spacing={2}>
                    {/* 左ペイン: ボット一覧 */}
                    <Grid item xs={12} md={4}>
                      <Stack spacing={1}>
                        <Button
                          variant="contained"
                          startIcon={<SmartToy />}
                          onClick={handleAdd}
                        >
                          ボットを追加
                        </Button>
                        <List dense>
                          {(bots || []).map(function(bot) {
                            return (
                              <ListItemButton
                                key={bot.id}
                                selected={bot.id === selectedId}
                                onClick={function() { setSelectedId(bot.id); }}
                              >
                                <ListItemAvatar>
                                  <Avatar>
                                    {(bot.name || "?").slice(0, 2)}
                                  </Avatar>
                                </ListItemAvatar>
                                <ListItemText
                                  primary={bot.name}
                                  secondary={
                                    (bot.status || "draft") + " / " + (bot.channel || "web")
                                  }
                                />
                                <IconButton
                                  edge="end"
                                  size="small"
                                  onClick={function(e) {
                                    e.stopPropagation();
                                    handleDelete(bot.id);
                                  }}
                                >
                                  <span className="material-icons">delete</span>
                                </IconButton>
                              </ListItemButton>
                            );
                          })}
                        </List>
                      </Stack>
                    </Grid>

                    {/* 右ペイン: ボット詳細＆テストチャット */}
                    <Grid item xs={12} md={8}>
                      {currentBot ? (
                        <Stack spacing={2} className="tight">
                          <Grid container spacing={2}>
                            <Grid item xs={12} md={6}>
                              <TextField
                                label="ボット名"
                                fullWidth
                                value={currentBot.name || ""}
                                onChange={function(e) {
                                  updateBot({ name: e.target.value });
                                }}
                              />
                            </Grid>
                            <Grid item xs={12} md={6}>
                              <FormControl fullWidth>
                                <InputLabel>ステータス</InputLabel>
                                <Select
                                  label="ステータス"
                                  value={currentBot.status || "draft"}
                                  onChange={function(e) {
                                    updateBot({ status: e.target.value });
                                  }}
                                >
                                  <MenuItem value="draft">下書き</MenuItem>
                                  <MenuItem value="active">有効</MenuItem>
                                  <MenuItem value="archived">アーカイブ</MenuItem>
                                </Select>
                              </FormControl>
                            </Grid>
                          </Grid>

                          <Grid container spacing={2}>
                            <Grid item xs={12} md={6}>
                              <FormControl fullWidth>
                                <InputLabel>チャネル</InputLabel>
                                <Select
                                  label="チャネル"
                                  value={currentBot.channel || "web"}
                                  onChange={function(e) {
                                    updateBot({ channel: e.target.value });
                                  }}
                                >
                                  <MenuItem value="web">Webチャット</MenuItem>
                                  <MenuItem value="in-app">アプリ内</MenuItem>
                                  <MenuItem value="slack">Slack</MenuItem>
                                  <MenuItem value="line">LINE</MenuItem>
                                </Select>
                              </FormControl>
                            </Grid>
                            <Grid item xs={12} md={6}>
                              <FormControl fullWidth>
                                <InputLabel>メインエージェント</InputLabel>
                                <Select
                                  label="メインエージェント"
                                  value={currentBot.primaryAgentId || ""}
                                  onChange={function(e) {
                                    updateBot({ primaryAgentId: e.target.value });
                                  }}
                                >
                                  {(agents || []).filter(function(a) {
                                    return (currentBot.agentIds || []).includes(a.id);
                                  }).map(function(a) {
                                    return (
                                      <MenuItem key={a.id} value={a.id}>
                                        {a.name} ({a.version || "v1.0"}) {a.isActive ? "[アクティブ]" : ""}
                                      </MenuItem>
                                    );
                                  })}
                                </Select>
                              </FormControl>
                            </Grid>
                          </Grid>

                          <TextField
                            label="説明"
                            fullWidth
                            multiline
                            minRows={2}
                            value={currentBot.description || ""}
                            onChange={function(e) {
                              updateBot({ description: e.target.value });
                            }}
                          />

                          <TextField
                            label="初回メッセージ"
                            fullWidth
                            multiline
                            minRows={2}
                            value={currentBot.entryMessage || ""}
                            onChange={function(e) {
                              updateBot({ entryMessage: e.target.value });
                            }}
                          />

                          <Card variant="outlined">
                            <CardContent>
                              <Typography variant="subtitle2" gutterBottom>
                                エージェント構成
                              </Typography>
                              <Stack spacing={1}>
                                <Box display="flex" alignItems="center" gap={1}>
                                  <FormControl size="small" sx={{ minWidth: 200 }}>
                                    <InputLabel>エージェントを追加</InputLabel>
                                    <Select
                                      label="エージェントを追加"
                                      value=""
                                      onChange={function(e) {
                                        if (e.target.value) {
                                          handleAddAgent(e.target.value);
                                        }
                                      }}
                                    >
                                      {(agents || []).filter(function(a) {
                                        return !(currentBot.agentIds || []).includes(a.id);
                                      }).map(function(a) {
                                        return (
                                          <MenuItem key={a.id} value={a.id}>
                                            {a.name} ({a.version || "v1.0"})
                                          </MenuItem>
                                        );
                                      })}
                                    </Select>
                                  </FormControl>
                                </Box>
                                <Stack spacing={1}>
                                  {(currentBot.agentIds || []).map(function(agentId) {
                                    const agent = (agents || []).find(function(a) { return a.id === agentId; });
                                    if (!agent) return null;
                                    return (
                                      <Box key={agentId} display="flex" alignItems="center" gap={1}>
                                        <Chip
                                          label={agent.name + " (" + (agent.version || "v1.0") + ")"}
                                          color={currentBot.primaryAgentId === agentId ? "primary" : "default"}
                                          variant={currentBot.primaryAgentId === agentId ? "filled" : "outlined"}
                                          onDelete={function() { handleRemoveAgent(agentId); }}
                                        />
                                        {currentBot.primaryAgentId === agentId && (
                                          <Typography variant="caption" color="primary">
                                            メイン
                                          </Typography>
                                        )}
                                      </Box>
                                    );
                                  })}
                                </Stack>
                              </Stack>
                            </CardContent>
                          </Card>

                          <Paper variant="outlined">
                            <Box p={2}>
                              <Typography variant="subtitle1" gutterBottom>
                                <Chat sx={{ mr:1, fontSize:20 }} />
                                テストチャット（モック応答）
                              </Typography>
                              <Stack spacing={1}>
                                <TextField
                                  placeholder="ユーザーとして質問を入力..."
                                  value={chatInput}
                                  onChange={function(e) { setChatInput(e.target.value); }}
                                  multiline
                                  minRows={2}
                                  onKeyDown={function(e) {
                                    if (e.key === "Enter" && !e.shiftKey) {
                                      e.preventDefault();
                                      handleSend();
                                    }
                                  }}
                                />
                                <Box display="flex" justifyContent="flex-end">
                                  <Button
                                    variant="contained"
                                    startIcon={<Send />}
                                    onClick={handleSend}
                                  >
                                    送信（モック）
                                  </Button>
                                </Box>
                                <Stack spacing={1} sx={{ maxHeight: 240, overflow: "auto" }}>
                                  {(messages || []).map(function(m) {
                                    return (
                                      <Card
                                        key={m.id}
                                        variant="outlined"
                                        sx={{ bgcolor: m.from === "user" ? "#e3f2fd" : "#f5f5f5" }}
                                      >
                                        <CardContent>
                                          <Typography
                                            variant="caption"
                                            color="text.secondary"
                                            gutterBottom
                                          >
                                            {m.from === "user" ? "ユーザー" : "ボット（デモ）"}
                                          </Typography>
                                          <Typography variant="body2" sx={{ whiteSpace: "pre-wrap" }}>
                                            {m.text}
                                          </Typography>
                                        </CardContent>
                                      </Card>
                                    );
                                  })}
                                  {messages.length === 0 && (
                                    <Typography
                                      variant="body2"
                                      color="text.secondary"
                                    >
                                      ここにデモ用の会話ログが表示されます（LLM呼び出しは行っていません）。
                                    </Typography>
                                  )}
                                </Stack>
                              </Stack>
                            </Box>
                          </Paper>
                        </Stack>
                      ) : (
                        <Typography color="text.secondary">
                          左のリストからチャットボットを選択してください。
                        </Typography>
                      )}
                    </Grid>
                  </Grid>
                </Box>
              </Paper>
            </section>
          );
        }

        // ==== エージェント管理セクション ====
        function AgentsSection(props) {
          const agents = props.agents;
          const setAgents = props.setAgents;
          const notify = props.notify;

          const [selectedId, setSelectedId] = useState(agents[0] ? agents[0].id : null);
          const [chatInput, setChatInput] = useState("");
          const [messages, setMessages] = useState([]);

          useEffect(function() {
            if (!selectedId && agents[0]) {
              setSelectedId(agents[0].id);
            }
          }, [agents, selectedId]);

          const currentAgent = useMemo(function() {
            return (agents || []).find(function(a) { return a.id === selectedId; }) || null;
          }, [agents, selectedId]);

          const updateAgent = function(patch) {
            if (!currentAgent) return;
            setAgents(function(prev) {
              return (prev || []).map(function(a) {
                if (a.id === currentAgent.id) {
                  return Object.assign({}, a, patch);
                }
                return a;
              });
            });
          };

          const handleAdd = function() {
            const a = {
              id: uid("agent"),
              name: "新規エージェント",
              description: "",
              model: "gpt-4.1-mini",
              version: "v1.0",
              temperature: 0.3,
              systemPrompt: "あなたは親切な日本語アシスタントです。",
              createdAt: new Date().toISOString(),
              isActive: true,
              ragFiles: [],
              ragSettings: {
                chunkSize: 800,
                chunkOverlap: 100,
                embeddingModel: "text-embedding-3-small",
                retrievalCount: 5,
                similarityThreshold: 0.7
              }
            };
            setAgents(function(prev) {
              return (prev || []).concat([a]);
            });
            setSelectedId(a.id);
            notify("エージェントを追加しました。");
          };

          const handleCreateVersion = function() {
            if (!currentAgent) return;
            const newVersion = "v" + (parseFloat(currentAgent.version.slice(1)) + 0.1).toFixed(1);
            const newAgent = Object.assign({}, currentAgent, {
              id: uid("agent"),
              version: newVersion,
              createdAt: new Date().toISOString(),
              isActive: false
            });
            setAgents(function(prev) {
              return (prev || []).concat([newAgent]);
            });
            setSelectedId(newAgent.id);
            notify("新しいバージョンを作成しました: " + newVersion);
          };

          const handleActivateVersion = function(agentId) {
            setAgents(function(prev) {
              return (prev || []).map(function(a) {
                if (a.name === currentAgent.name) {
                  return Object.assign({}, a, { isActive: a.id === agentId });
                }
                return a;
              });
            });
            notify("アクティブバージョンを変更しました。");
          };

          const handleDelete = function(id) {
            if (!window.confirm("このエージェントを削除しますか？")) return;
            setAgents(function(prev) {
              return (prev || []).filter(function(a) { return a.id !== id; });
            });
            const remain = (agents || []).filter(function(a) { return a.id !== id; });
            setSelectedId(remain[0] ? remain[0].id : null);
            notify("エージェントを削除しました。");
          };

          const handleSend = function() {
            if (!currentAgent) return;
            if (!chatInput.trim()) return;
            const q = chatInput.trim();
            const userMsg = { from: "user", text: q, id: uid("msg") };
          // AgentsSection 内 handleSend の agentMsg も同じパターンで修正
          const agentMsg = {
            from: "agent",
            text:
              "［モック応答］エージェント「" +
              currentAgent.name +
              "」がモデル「" +
              (currentAgent.model || "") +
              "」で返答すると想定されます。\\n\\n質問: " +
              q +
              "\\n→ ここに実際のLLM応答が入ります。",
            id: uid("msg"),
          };

            setMessages(function(prev) { return prev.concat([userMsg, agentMsg]); });
            setChatInput("");
          };

          return (
            <section>
              <Paper variant="outlined">
                <Box p={2}>
                  <Typography variant="h6">
                    <SmartToy sx={{ mr:1, verticalAlign:"middle" }} />
                    エージェント管理（モック）
                  </Typography>
                </Box>
                <Divider />
                <Box p={2}>
                  <Grid container spacing={2}>
                    {/* 左ペイン: エージェント一覧 */}
                    <Grid item xs={12} md={3}>
                      <Stack spacing={1}>
                        <Button
                          variant="contained"
                          startIcon={<SmartToy />}
                          onClick={handleAdd}
                        >
                          エージェントを追加
                        </Button>
                        <List dense>
                          {(agents || []).map(function(agent) {
                            return (
                              <ListItemButton
                                key={agent.id}
                                selected={agent.id === selectedId}
                                onClick={function() { setSelectedId(agent.id); }}
                              >
                                <ListItemAvatar>
                                  <Avatar>
                                    {(agent.name || "?").slice(0, 2)}
                                  </Avatar>
                                </ListItemAvatar>
                                <ListItemText
                                  primary={agent.name + " (" + (agent.version || "v1.0") + ")"}
                                  secondary={(agent.model || "モデル未設定") + (agent.isActive ? " [アクティブ]" : "")}
                                />
                                <IconButton
                                  edge="end"
                                  size="small"
                                  onClick={function(e) {
                                    e.stopPropagation();
                                    handleDelete(agent.id);
                                  }}
                                >
                                  <span className="material-icons">delete</span>
                                </IconButton>
                              </ListItemButton>
                            );
                          })}
                        </List>
                      </Stack>
                    </Grid>

                    {/* 右ペイン: エージェント詳細＆テスト */}
                    <Grid item xs={12} md={9}>
                      {currentAgent ? (
                        <Stack spacing={2} className="tight">
                          <Grid container spacing={2}>
                            <Grid item xs={12} md={6}>
                              <TextField
                                label="エージェント名"
                                fullWidth
                                value={currentAgent.name || ""}
                                onChange={function(e) {
                                  updateAgent({ name: e.target.value });
                                }}
                              />
                            </Grid>
                            <Grid item xs={12} md={4}>
                              <FormControl fullWidth>
                                <InputLabel>モデル</InputLabel>
                                <Select
                                  label="モデル"
                                  value={currentAgent.model || "gpt-4.1-mini"}
                                  onChange={function(e) {
                                    updateAgent({ model: e.target.value });
                                  }}
                                >
                                  <MenuItem value="gpt-4.1-mini">gpt-4.1-mini</MenuItem>
                                  <MenuItem value="gpt-4o-mini">gpt-4o-mini</MenuItem>
                                  <MenuItem value="gpt-4.1">gpt-4.1</MenuItem>
                                  <MenuItem value="local-llm">ローカルLLM</MenuItem>
                                </Select>
                              </FormControl>
                            </Grid>
                            <Grid item xs={12} md={4}>
                              <TextField
                                label="バージョン"
                                fullWidth
                                value={currentAgent.version || "v1.0"}
                                onChange={function(e) {
                                  updateAgent({ version: e.target.value });
                                }}
                              />
                            </Grid>
                          </Grid>

                          <Grid container spacing={2}>
                            <Grid item xs={12} md={6}>
                              <Typography gutterBottom>温度（創造性）</Typography>
                              <Slider
                                min={0}
                                max={1}
                                step={0.05}
                                value={
                                  typeof currentAgent.temperature === "number"
                                    ? currentAgent.temperature
                                    : 0.2
                                }
                                onChange={function(_, v) {
                                  updateAgent({ temperature: v });
                                }}
                                valueLabelDisplay="auto"
                              />
                            </Grid>
                          </Grid>

                          <TextField
                            label="説明"
                            fullWidth
                            multiline
                            minRows={2}
                            value={currentAgent.description || ""}
                            onChange={function(e) {
                              updateAgent({ description: e.target.value });
                            }}
                          />

                          <TextField
                            label="システムプロンプト（デモ）"
                            fullWidth
                            multiline
                            minRows={3}
                            value={currentAgent.systemPrompt || ""}
                            onChange={function(e) {
                              updateAgent({ systemPrompt: e.target.value });
                            }}
                          />

                          <Card variant="outlined">
                            <CardContent>
                              <Typography variant="subtitle2" gutterBottom>
                                RAGファイル管理
                              </Typography>
                              <Stack spacing={2}>
                                <Box>
                                  <input
                                    type="file"
                                    multiple
                                    accept=".txt,.pdf,.docx,.md"
                                    onChange={function(e) {
                                      const files = Array.from(e.target.files);
                                      files.forEach(function(file) {
                                        const reader = new FileReader();
                                        reader.onload = function(event) {
                                          const newFile = {
                                            id: uid("file"),
                                            name: file.name,
                                            size: file.size,
                                            type: file.type,
                                            content: event.target.result,
                                            uploadedAt: new Date().toISOString()
                                          };
                                          updateAgent({ 
                                            ragFiles: (currentAgent.ragFiles || []).concat([newFile]) 
                                          });
                                        };
                                        reader.readAsText(file);
                                      });
                                      notify("ファイルをアップロードしました。");
                                    }}
                                    style={{ display: "none" }}
                                    id="file-upload"
                                  />
                                  <label htmlFor="file-upload">
                                    <Button variant="outlined" component="span" size="small">
                                      ファイル追加
                                    </Button>
                                  </label>
                                </Box>
                                <Stack spacing={1}>
                                  {(currentAgent.ragFiles || []).map(function(file) {
                                    return (
                                      <Box key={file.id} display="flex" alignItems="center" gap={1}>
                                        <Chip
                                          label={file.name + " (" + Math.round(file.size/1024) + "KB)"}
                                          size="small"
                                          onDelete={function() {
                                            updateAgent({
                                              ragFiles: (currentAgent.ragFiles || []).filter(function(f) {
                                                return f.id !== file.id;
                                              })
                                            });
                                            notify("ファイルを削除しました。");
                                          }}
                                        />
                                      </Box>
                                    );
                                  })}
                                </Stack>
                              </Stack>
                            </CardContent>
                          </Card>

                          <Card variant="outlined">
                            <CardContent>
                              <Typography variant="subtitle2" gutterBottom>
                                RAG設定
                              </Typography>
                              <Grid container spacing={2}>
                                <Grid item xs={6}>
                                  <TextField
                                    label="チャンクサイズ"
                                    type="number"
                                    fullWidth
                                    size="small"
                                    value={(currentAgent.ragSettings || {}).chunkSize || 800}
                                    onChange={function(e) {
                                      updateAgent({
                                        ragSettings: Object.assign({}, currentAgent.ragSettings, {
                                          chunkSize: parseInt(e.target.value) || 800
                                        })
                                      });
                                    }}
                                  />
                                </Grid>
                                <Grid item xs={6}>
                                  <TextField
                                    label="オーバーラップ"
                                    type="number"
                                    fullWidth
                                    size="small"
                                    value={(currentAgent.ragSettings || {}).chunkOverlap || 100}
                                    onChange={function(e) {
                                      updateAgent({
                                        ragSettings: Object.assign({}, currentAgent.ragSettings, {
                                          chunkOverlap: parseInt(e.target.value) || 100
                                        })
                                      });
                                    }}
                                  />
                                </Grid>
                                <Grid item xs={12}>
                                  <FormControl fullWidth size="small">
                                    <InputLabel>埋め込みモデル</InputLabel>
                                    <Select
                                      label="埋め込みモデル"
                                      value={(currentAgent.ragSettings || {}).embeddingModel || "text-embedding-3-small"}
                                      onChange={function(e) {
                                        updateAgent({
                                          ragSettings: Object.assign({}, currentAgent.ragSettings, {
                                            embeddingModel: e.target.value
                                          })
                                        });
                                      }}
                                    >
                                      <MenuItem value="text-embedding-3-small">text-embedding-3-small</MenuItem>
                                      <MenuItem value="text-embedding-3-large">text-embedding-3-large</MenuItem>
                                      <MenuItem value="text-embedding-ada-002">text-embedding-ada-002</MenuItem>
                                    </Select>
                                  </FormControl>
                                </Grid>
                                <Grid item xs={6}>
                                  <TextField
                                    label="取得件数"
                                    type="number"
                                    fullWidth
                                    size="small"
                                    value={(currentAgent.ragSettings || {}).retrievalCount || 5}
                                    onChange={function(e) {
                                      updateAgent({
                                        ragSettings: Object.assign({}, currentAgent.ragSettings, {
                                          retrievalCount: parseInt(e.target.value) || 5
                                        })
                                      });
                                    }}
                                  />
                                </Grid>
                                <Grid item xs={6}>
                                  <TextField
                                    label="類似度闾値"
                                    type="number"
                                    fullWidth
                                    size="small"
                                    inputProps={{ min: 0, max: 1, step: 0.1 }}
                                    value={(currentAgent.ragSettings || {}).similarityThreshold || 0.7}
                                    onChange={function(e) {
                                      updateAgent({
                                        ragSettings: Object.assign({}, currentAgent.ragSettings, {
                                          similarityThreshold: parseFloat(e.target.value) || 0.7
                                        })
                                      });
                                    }}
                                  />
                                </Grid>
                              </Grid>
                            </CardContent>
                          </Card>

                          <Card variant="outlined">
                            <CardContent>
                              <Typography variant="subtitle2" gutterBottom>
                                バージョン管理
                              </Typography>
                              <Stack direction="row" spacing={1} sx={{ mb: 2 }}>
                                <Button
                                  variant="outlined"
                                  size="small"
                                  onClick={handleCreateVersion}
                                >
                                  新バージョン作成
                                </Button>
                                <Button
                                  variant={currentAgent.isActive ? "contained" : "outlined"}
                                  size="small"
                                  color={currentAgent.isActive ? "success" : "primary"}
                                  onClick={function() { handleActivateVersion(currentAgent.id); }}
                                  disabled={currentAgent.isActive}
                                >
                                  {currentAgent.isActive ? "アクティブ" : "アクティブ化"}
                                </Button>
                              </Stack>
                              <Typography variant="body2" color="text.secondary">
                                作成日時: {new Date(currentAgent.createdAt || Date.now()).toLocaleString()}
                              </Typography>
                            </CardContent>
                          </Card>

                          <Paper variant="outlined">
                            <Box p={2}>
                              <Typography variant="subtitle1" gutterBottom>
                                <SmartToy sx={{ mr:1, fontSize:20 }} />
                                テストメッセージ（モック応答）
                              </Typography>
                              <Stack spacing={1}>
                                <TextField
                                  placeholder="このエージェントに問い合わせるメッセージを入力..."
                                  value={chatInput}
                                  onChange={function(e) { setChatInput(e.target.value); }}
                                  multiline
                                  minRows={2}
                                  onKeyDown={function(e) {
                                    if (e.key === "Enter" && !e.shiftKey) {
                                      e.preventDefault();
                                      handleSend();
                                    }
                                  }}
                                />
                                <Box display="flex" justifyContent="flex-end">
                                  <Button
                                    variant="contained"
                                    startIcon={<Send />}
                                    onClick={handleSend}
                                  >
                                    テスト送信（モック）
                                  </Button>
                                </Box>
                                <Stack spacing={1} sx={{ maxHeight: 240, overflow: "auto" }}>
                                  {(messages || []).map(function(m) {
                                    return (
                                      <Card
                                        key={m.id}
                                        variant="outlined"
                                        sx={{ bgcolor: m.from === "user" ? "#e3f2fd" : "#f5f5f5" }}
                                      >
                                        <CardContent>
                                          <Typography
                                            variant="caption"
                                            color="text.secondary"
                                            gutterBottom
                                          >
                                            {m.from === "user" ? "ユーザー" : "エージェント（デモ）"}
                                          </Typography>
                                          <Typography variant="body2" sx={{ whiteSpace: "pre-wrap" }}>
                                            {m.text}
                                          </Typography>
                                        </CardContent>
                                      </Card>
                                    );
                                  })}
                                  {messages.length === 0 && (
                                    <Typography
                                      variant="body2"
                                      color="text.secondary"
                                    >
                                      ここにデモ用の会話ログが表示されます（実際の推論は行っていません）。
                                    </Typography>
                                  )}
                                </Stack>
                              </Stack>
                            </Box>
                          </Paper>
                        </Stack>
                      ) : (
                        <Typography color="text.secondary">
                          左のリストからエージェントを選択してください。
                        </Typography>
                      )}
                    </Grid>
                  </Grid>
                </Box>
              </Paper>
            </section>
          );
        }

        // ==== 履歴管理セクション ====
        function HistorySection(props) {
          const chatHistory = props.chatHistory;
          const setChatHistory = props.setChatHistory;
          const notify = props.notify;

          const [selectedId, setSelectedId] = useState(chatHistory[0] ? chatHistory[0].id : null);
          const [filterRating, setFilterRating] = useState("");
          const [filterResolved, setFilterResolved] = useState("");

          const currentChat = useMemo(function() {
            return (chatHistory || []).find(function(c) { return c.id === selectedId; }) || null;
          }, [chatHistory, selectedId]);

          const filteredHistory = useMemo(function() {
            return (chatHistory || []).filter(function(chat) {
              if (filterRating && chat.rating !== parseInt(filterRating)) return false;
              if (filterResolved === "true" && !chat.resolved) return false;
              if (filterResolved === "false" && chat.resolved) return false;
              return true;
            });
          }, [chatHistory, filterRating, filterResolved]);

          const updateChatRating = function(chatId, rating) {
            setChatHistory(function(prev) {
              return (prev || []).map(function(c) {
                if (c.id === chatId) {
                  return Object.assign({}, c, { rating: rating });
                }
                return c;
              });
            });
            notify("評価を更新しました。");
          };

          const updateChatFeedback = function(chatId, feedback) {
            setChatHistory(function(prev) {
              return (prev || []).map(function(c) {
                if (c.id === chatId) {
                  return Object.assign({}, c, { feedback: feedback });
                }
                return c;
              });
            });
          };

          return (
            <section>
              <Paper variant="outlined">
                <Box p={2}>
                  <Typography variant="h6">
                    <History sx={{ mr:1, verticalAlign:"middle" }} />
                    チャット履歴管理
                  </Typography>
                </Box>
                <Divider />
                <Box p={2}>
                  <Grid container spacing={2}>
                    <Grid item xs={12} md={4}>
                      <Stack spacing={2}>
                        <Grid container spacing={1}>
                          <Grid item xs={6}>
                            <FormControl fullWidth size="small">
                              <InputLabel>評価フィルタ</InputLabel>
                              <Select
                                label="評価フィルタ"
                                value={filterRating}
                                onChange={function(e) { setFilterRating(e.target.value); }}
                              >
                                <MenuItem value="">すべて</MenuItem>
                                <MenuItem value="5">★★★★★</MenuItem>
                                <MenuItem value="4">★★★★☆</MenuItem>
                                <MenuItem value="3">★★★☆☆</MenuItem>
                                <MenuItem value="2">★★☆☆☆</MenuItem>
                                <MenuItem value="1">★☆☆☆☆</MenuItem>
                              </Select>
                            </FormControl>
                          </Grid>
                          <Grid item xs={6}>
                            <FormControl fullWidth size="small">
                              <InputLabel>解決状況</InputLabel>
                              <Select
                                label="解決状況"
                                value={filterResolved}
                                onChange={function(e) { setFilterResolved(e.target.value); }}
                              >
                                <MenuItem value="">すべて</MenuItem>
                                <MenuItem value="true">解決済み</MenuItem>
                                <MenuItem value="false">未解決</MenuItem>
                              </Select>
                            </FormControl>
                          </Grid>
                        </Grid>
                        <List dense>
                          {filteredHistory.map(function(chat) {
                            return (
                              <ListItemButton
                                key={chat.id}
                                selected={chat.id === selectedId}
                                onClick={function() { setSelectedId(chat.id); }}
                              >
                                <ListItemAvatar>
                                  <Avatar>
                                    {(chat.userName || "?").slice(0, 2)}
                                  </Avatar>
                                </ListItemAvatar>
                                <ListItemText
                                  primary={chat.userName}
                                  secondary={
                                    new Date(chat.timestamp).toLocaleDateString() + " " +
                                    "★".repeat(chat.rating || 0) + "☆".repeat(5 - (chat.rating || 0))
                                  }
                                />
                                <Chip
                                  size="small"
                                  label={chat.resolved ? "解決" : "未解決"}
                                  color={chat.resolved ? "success" : "warning"}
                                />
                              </ListItemButton>
                            );
                          })}
                        </List>
                      </Stack>
                    </Grid>
                    <Grid item xs={12} md={8}>
                      {currentChat ? (
                        <Stack spacing={2}>
                          <Card variant="outlined">
                            <CardContent>
                              <Typography variant="h6" gutterBottom>
                                {currentChat.userName} との会話
                              </Typography>
                              <Typography variant="body2" color="text.secondary">
                                {new Date(currentChat.timestamp).toLocaleString()}
                              </Typography>
                            </CardContent>
                          </Card>
                          <Paper variant="outlined" sx={{ p: 2, maxHeight: 300, overflow: "auto" }}>
                            <Stack spacing={1}>
                              {(currentChat.messages || []).map(function(msg, idx) {
                                return (
                                  <Card
                                    key={idx}
                                    variant="outlined"
                                    sx={{ bgcolor: msg.from === "user" ? "#e3f2fd" : "#f5f5f5" }}
                                  >
                                    <CardContent sx={{ py: 1 }}>
                                      <Typography variant="caption" color="text.secondary">
                                        {msg.from === "user" ? "ユーザー" : "ボット"} - {new Date(msg.timestamp).toLocaleTimeString()}
                                      </Typography>
                                      <Typography variant="body2">
                                        {msg.text}
                                      </Typography>
                                    </CardContent>
                                  </Card>
                                );
                              })}
                            </Stack>
                          </Paper>
                          <Card variant="outlined">
                            <CardContent>
                              <Typography variant="subtitle2" gutterBottom>
                                評価・フィードバック
                              </Typography>
                              <Grid container spacing={2} alignItems="center">
                                <Grid item>
                                  <Typography variant="body2">評価:</Typography>
                                </Grid>
                                <Grid item>
                                  {[1, 2, 3, 4, 5].map(function(star) {
                                    return (
                                      <IconButton
                                        key={star}
                                        size="small"
                                        onClick={function() { updateChatRating(currentChat.id, star); }}
                                      >
                                        <Star
                                          sx={{
                                            color: star <= (currentChat.rating || 0) ? "#ffc107" : "#e0e0e0"
                                          }}
                                        />
                                      </IconButton>
                                    );
                                  })}
                                </Grid>
                              </Grid>
                              <TextField
                                label="フィードバック"
                                fullWidth
                                multiline
                                minRows={2}
                                value={currentChat.feedback || ""}
                                onChange={function(e) {
                                  updateChatFeedback(currentChat.id, e.target.value);
                                }}
                                sx={{ mt: 2 }}
                              />
                            </CardContent>
                          </Card>
                        </Stack>
                      ) : (
                        <Typography color="text.secondary">
                          左のリストからチャット履歴を選択してください。
                        </Typography>
                      )}
                    </Grid>
                  </Grid>
                </Box>
              </Paper>
            </section>
          );
        }

        // ==== 権限管理セクション ====
        function PermissionsSection(props) {
          const permissions = props.permissions;
          const setPermissions = props.setPermissions;
          const notify = props.notify;

          const [tab, setTab] = useState(0);
          const [selectedOrgId, setSelectedOrgId] = useState(null);
          const [selectedUserId, setSelectedUserId] = useState(null);

          const currentOrg = useMemo(function() {
            return (permissions.organizations || []).find(function(o) { return o.id === selectedOrgId; }) || null;
          }, [permissions.organizations, selectedOrgId]);

          const currentUser = useMemo(function() {
            return (permissions.users || []).find(function(u) { return u.id === selectedUserId; }) || null;
          }, [permissions.users, selectedUserId]);

          const updateOrgPermissions = function(orgId, newPermissions) {
            setPermissions(function(prev) {
              return Object.assign({}, prev, {
                organizations: (prev.organizations || []).map(function(o) {
                  if (o.id === orgId) {
                    return Object.assign({}, o, { permissions: newPermissions });
                  }
                  return o;
                })
              });
            });
            notify("組織権限を更新しました。");
          };

          const updateUserPermissions = function(userId, newPermissions) {
            setPermissions(function(prev) {
              return Object.assign({}, prev, {
                users: (prev.users || []).map(function(u) {
                  if (u.id === userId) {
                    return Object.assign({}, u, { permissions: newPermissions });
                  }
                  return u;
                })
              });
            });
            notify("ユーザー権限を更新しました。");
          };

          const addOrganization = function() {
            const org = {
              id: uid("org"),
              name: "新規組織",
              description: "",
              permissions: []
            };
            setPermissions(function(prev) {
              return Object.assign({}, prev, {
                organizations: (prev.organizations || []).concat([org])
              });
            });
            setSelectedOrgId(org.id);
            notify("組織を追加しました。");
          };

          const addUser = function() {
            const user = {
              id: uid("user"),
              name: "新規ユーザー",
              email: "",
              organizationId: null,
              role: "user",
              permissions: []
            };
            setPermissions(function(prev) {
              return Object.assign({}, prev, {
                users: (prev.users || []).concat([user])
              });
            });
            setSelectedUserId(user.id);
            notify("ユーザーを追加しました。");
          };

          const availablePermissions = [
            { id: "admin", label: "管理者権限" },
            { id: "manage_bots", label: "ボット管理" },
            { id: "manage_agents", label: "エージェント管理" },
            { id: "view_history", label: "履歴閲覧" },
            { id: "manage_permissions", label: "権限管理" }
          ];

          return (
            <section>
              <Paper variant="outlined">
                <Box p={2}>
                  <Typography variant="h6">
                    <Security sx={{ mr:1, verticalAlign:"middle" }} />
                    権限管理
                  </Typography>
                </Box>
                <Divider />
                <Box p={2}>
                  <Tabs value={tab} onChange={function(_, v) { setTab(v); }}>
                    <Tab icon={<Business />} iconPosition="start" label="組織" />
                    <Tab icon={<Person />} iconPosition="start" label="ユーザー" />
                  </Tabs>
                  
                  {tab === 0 && (
                    <Grid container spacing={2} sx={{ mt: 1 }}>
                      <Grid item xs={12} md={4}>
                        <Stack spacing={1}>
                          <Button
                            variant="contained"
                            startIcon={<Business />}
                            onClick={addOrganization}
                          >
                            組織を追加
                          </Button>
                          <List dense>
                            {(permissions.organizations || []).map(function(org) {
                              return (
                                <ListItemButton
                                  key={org.id}
                                  selected={org.id === selectedOrgId}
                                  onClick={function() { setSelectedOrgId(org.id); }}
                                >
                                  <ListItemAvatar>
                                    <Avatar>
                                      <Business />
                                    </Avatar>
                                  </ListItemAvatar>
                                  <ListItemText
                                    primary={org.name}
                                    secondary={org.permissions.length + "個の権限"}
                                  />
                                </ListItemButton>
                              );
                            })}
                          </List>
                        </Stack>
                      </Grid>
                      <Grid item xs={12} md={8}>
                        {currentOrg ? (
                          <Stack spacing={2}>
                            <TextField
                              label="組織名"
                              fullWidth
                              value={currentOrg.name}
                              onChange={function(e) {
                                setPermissions(function(prev) {
                                  return Object.assign({}, prev, {
                                    organizations: (prev.organizations || []).map(function(o) {
                                      if (o.id === currentOrg.id) {
                                        return Object.assign({}, o, { name: e.target.value });
                                      }
                                      return o;
                                    })
                                  });
                                });
                              }}
                            />
                            <TextField
                              label="説明"
                              fullWidth
                              multiline
                              minRows={2}
                              value={currentOrg.description}
                              onChange={function(e) {
                                setPermissions(function(prev) {
                                  return Object.assign({}, prev, {
                                    organizations: (prev.organizations || []).map(function(o) {
                                      if (o.id === currentOrg.id) {
                                        return Object.assign({}, o, { description: e.target.value });
                                      }
                                      return o;
                                    })
                                  });
                                });
                              }}
                            />
                            <Typography variant="subtitle2">権限設定</Typography>
                            <Stack spacing={1}>
                              {availablePermissions.map(function(perm) {
                                const hasPermission = (currentOrg.permissions || []).includes(perm.id);
                                return (
                                  <Box key={perm.id} display="flex" alignItems="center" gap={1}>
                                    <IconButton
                                      size="small"
                                      onClick={function() {
                                        const newPerms = hasPermission
                                          ? (currentOrg.permissions || []).filter(function(p) { return p !== perm.id; })
                                          : (currentOrg.permissions || []).concat([perm.id]);
                                        updateOrgPermissions(currentOrg.id, newPerms);
                                      }}
                                    >
                                      {hasPermission ? <ThumbUp color="primary" /> : <ThumbDown />}
                                    </IconButton>
                                    <Typography variant="body2">{perm.label}</Typography>
                                  </Box>
                                );
                              })}
                            </Stack>
                          </Stack>
                        ) : (
                          <Typography color="text.secondary">
                            左のリストから組織を選択してください。
                          </Typography>
                        )}
                      </Grid>
                    </Grid>
                  )}
                  
                  {tab === 1 && (
                    <Grid container spacing={2} sx={{ mt: 1 }}>
                      <Grid item xs={12} md={4}>
                        <Stack spacing={1}>
                          <Button
                            variant="contained"
                            startIcon={<Person />}
                            onClick={addUser}
                          >
                            ユーザーを追加
                          </Button>
                          <List dense>
                            {(permissions.users || []).map(function(user) {
                              return (
                                <ListItemButton
                                  key={user.id}
                                  selected={user.id === selectedUserId}
                                  onClick={function() { setSelectedUserId(user.id); }}
                                >
                                  <ListItemAvatar>
                                    <Avatar>
                                      <Person />
                                    </Avatar>
                                  </ListItemAvatar>
                                  <ListItemText
                                    primary={user.name}
                                    secondary={user.role + " - " + user.permissions.length + "個の権限"}
                                  />
                                </ListItemButton>
                              );
                            })}
                          </List>
                        </Stack>
                      </Grid>
                      <Grid item xs={12} md={8}>
                        {currentUser ? (
                          <Stack spacing={2}>
                            <Grid container spacing={2}>
                              <Grid item xs={12} md={6}>
                                <TextField
                                  label="ユーザー名"
                                  fullWidth
                                  value={currentUser.name}
                                  onChange={function(e) {
                                    setPermissions(function(prev) {
                                      return Object.assign({}, prev, {
                                        users: (prev.users || []).map(function(u) {
                                          if (u.id === currentUser.id) {
                                            return Object.assign({}, u, { name: e.target.value });
                                          }
                                          return u;
                                        })
                                      });
                                    });
                                  }}
                                />
                              </Grid>
                              <Grid item xs={12} md={6}>
                                <TextField
                                  label="メールアドレス"
                                  fullWidth
                                  value={currentUser.email}
                                  onChange={function(e) {
                                    setPermissions(function(prev) {
                                      return Object.assign({}, prev, {
                                        users: (prev.users || []).map(function(u) {
                                          if (u.id === currentUser.id) {
                                            return Object.assign({}, u, { email: e.target.value });
                                          }
                                          return u;
                                        })
                                      });
                                    });
                                  }}
                                />
                              </Grid>
                            </Grid>
                            <FormControl fullWidth>
                              <InputLabel>ロール</InputLabel>
                              <Select
                                label="ロール"
                                value={currentUser.role}
                                onChange={function(e) {
                                  setPermissions(function(prev) {
                                    return Object.assign({}, prev, {
                                      users: (prev.users || []).map(function(u) {
                                        if (u.id === currentUser.id) {
                                          return Object.assign({}, u, { role: e.target.value });
                                        }
                                        return u;
                                      })
                                    });
                                  });
                                }}
                              >
                                <MenuItem value="admin">管理者</MenuItem>
                                <MenuItem value="manager">マネージャー</MenuItem>
                                <MenuItem value="user">一般ユーザー</MenuItem>
                              </Select>
                            </FormControl>
                            <Typography variant="subtitle2">権限設定</Typography>
                            <Stack spacing={1}>
                              {availablePermissions.map(function(perm) {
                                const hasPermission = (currentUser.permissions || []).includes(perm.id);
                                return (
                                  <Box key={perm.id} display="flex" alignItems="center" gap={1}>
                                    <IconButton
                                      size="small"
                                      onClick={function() {
                                        const newPerms = hasPermission
                                          ? (currentUser.permissions || []).filter(function(p) { return p !== perm.id; })
                                          : (currentUser.permissions || []).concat([perm.id]);
                                        updateUserPermissions(currentUser.id, newPerms);
                                      }}
                                    >
                                      {hasPermission ? <ThumbUp color="primary" /> : <ThumbDown />}
                                    </IconButton>
                                    <Typography variant="body2">{perm.label}</Typography>
                                  </Box>
                                );
                              })}
                            </Stack>
                          </Stack>
                        ) : (
                          <Typography color="text.secondary">
                            左のリストからユーザーを選択してください。
                          </Typography>
                        )}
                      </Grid>
                    </Grid>
                  )}
                </Box>
              </Paper>
            </section>
          );
        }

        // ==== ダッシュボード（概要） ====
        function OverviewSection(props) {
          const bots = props.bots;
          const agents = props.agents;
          const chatHistory = props.chatHistory;

          const activeBots = (bots || []).filter(function(b) {
            return b.status === "active";
          }).length;

          const avgRating = useMemo(function() {
            const ratings = (chatHistory || []).filter(function(c) { return c.rating; }).map(function(c) { return c.rating; });
            return ratings.length > 0 ? (ratings.reduce(function(a, b) { return a + b; }, 0) / ratings.length).toFixed(1) : 0;
          }, [chatHistory]);

          const recentHistory = useMemo(function() {
            return (chatHistory || []).slice(0, 5);
          }, [chatHistory]);

          return (
            <section>
              <Paper variant="outlined">
                <Box p={2}>
                  <Typography variant="h6">
                    <Dashboard sx={{ mr:1, verticalAlign:"middle" }} />
                    システム概要
                  </Typography>
                </Box>
                <Divider />
                <Box p={2}>
                  <Grid container spacing={2}>
                    <Grid item xs={12} md={3}>
                      <Card variant="outlined">
                        <CardContent>
                          <Typography variant="subtitle2" color="text.secondary">
                            ボット数
                          </Typography>
                          <Typography variant="h4">
                            {bots.length}
                          </Typography>
                          <Typography variant="body2" color="text.secondary">
                            うち有効: {activeBots}
                          </Typography>
                        </CardContent>
                      </Card>
                    </Grid>
                    <Grid item xs={12} md={3}>
                      <Card variant="outlined">
                        <CardContent>
                          <Typography variant="subtitle2" color="text.secondary">
                            エージェント数
                          </Typography>
                          <Typography variant="h4">
                            {agents.length}
                          </Typography>
                        </CardContent>
                      </Card>
                    </Grid>
                    <Grid item xs={12} md={3}>
                      <Card variant="outlined">
                        <CardContent>
                          <Typography variant="subtitle2" color="text.secondary">
                            総チャット数
                          </Typography>
                          <Typography variant="h4">
                            {chatHistory.length}
                          </Typography>
                        </CardContent>
                      </Card>
                    </Grid>
                    <Grid item xs={12} md={3}>
                      <Card variant="outlined">
                        <CardContent>
                          <Typography variant="subtitle2" color="text.secondary">
                            平均評価
                          </Typography>
                          <Typography variant="h4">
                            {avgRating}
                          </Typography>
                          <Typography variant="body2" color="text.secondary">
                            ★{avgRating}/5.0
                          </Typography>
                        </CardContent>
                      </Card>
                    </Grid>
                    <Grid item xs={12}>
                      <Paper variant="outlined">
                        <Box p={2}>
                          <Typography variant="h6" gutterBottom>
                            最近のチャット履歴
                          </Typography>
                          <TableContainer>
                            <Table size="small">
                              <TableHead>
                                <TableRow>
                                  <TableCell>ユーザー</TableCell>
                                  <TableCell>日時</TableCell>
                                  <TableCell>最初のメッセージ</TableCell>
                                  <TableCell>評価</TableCell>
                                  <TableCell>状態</TableCell>
                                </TableRow>
                              </TableHead>
                              <TableBody>
                                {recentHistory.map(function(chat) {
                                  const firstMessage = (chat.messages || [])[0];
                                  return (
                                    <TableRow key={chat.id}>
                                      <TableCell>{chat.userName}</TableCell>
                                      <TableCell>
                                        {new Date(chat.timestamp).toLocaleDateString()}
                                      </TableCell>
                                      <TableCell>
                                        {firstMessage ? firstMessage.text.slice(0, 30) + (firstMessage.text.length > 30 ? "..." : "") : "-"}
                                      </TableCell>
                                      <TableCell>
                                        {"★".repeat(chat.rating || 0) + "☆".repeat(5 - (chat.rating || 0))}
                                      </TableCell>
                                      <TableCell>
                                        <Chip
                                          size="small"
                                          label={chat.resolved ? "解決" : "未解決"}
                                          color={chat.resolved ? "success" : "warning"}
                                        />
                                      </TableCell>
                                    </TableRow>
                                  );
                                })}
                              </TableBody>
                            </Table>
                          </TableContainer>
                        </Box>
                      </Paper>
                    </Grid>
                  </Grid>
                </Box>
              </Paper>
            </section>
          );
        }

        // ==== ルート App ====
        function App() {
          const prefersDark = useMediaQuery("(prefers-color-scheme: dark)");

          const [agents, setAgents] = useState(function() {
            return LS.load("demo-agents", defaultAgents());
          });

          const [bots, setBots] = useState(function() {
            return LS.load("demo-bots", defaultBots(defaultAgents()));
          });

          const [chatHistory, setChatHistory] = useState(function() {
            return LS.load("demo-chat-history", defaultChatHistory());
          });

          const [permissions, setPermissions] = useState(function() {
            return LS.load("demo-permissions", defaultPermissions());
          });

          const [msg, setMsg] = useState({
            open: false,
            title: "",
            message: ""
          });

          const [tab, setTab] = useState(0);

          const notify = function(message) {
            setMsg({
              open: true,
              title: "情報",
              message: message
            });
          };

          useEffect(function() {
            LS.save("demo-agents", agents);
          }, [agents]);

          useEffect(function() {
            LS.save("demo-bots", bots);
          }, [bots]);

          useEffect(function() {
            LS.save("demo-chat-history", chatHistory);
          }, [chatHistory]);

          useEffect(function() {
            LS.save("demo-permissions", permissions);
          }, [permissions]);

          const theme = useMemo(function() {
            return createTheme({
              palette: {
                mode: prefersDark ? "dark" : "light",
                background: {
                  default: "#fafafa",
                  paper: "#ffffff"
                }
              },
              shape: {
                borderRadius: 10
              },
              typography: {
                fontFamily: '"Roboto", "Helvetica", "Arial", sans-serif'
              },
              components: {
                MuiPaper: {
                  defaultProps: {
                    elevation: 0
                  }
                }
              }
            });
          }, [prefersDark]);

          const handleReset = function() {
            if (!window.confirm("ローカルのデモデータを初期状態に戻しますか？")) return;
            const baseAgents = defaultAgents();
            setAgents(baseAgents);
            setBots(defaultBots(baseAgents));
            setChatHistory(defaultChatHistory());
            setPermissions(defaultPermissions());
            notify("デモデータを初期化しました。");
          };

          return (
            <ThemeProvider theme={theme}>
              <CssBaseline />
              <AppBar position="sticky" color="inherit" elevation={1}>
                <Toolbar sx={{ gap: 1 }}>
                  <Typography
                    variant="h6"
                    className="appTitle"
                    sx={{ flexGrow: 1, minWidth: 200 }}
                  >
                    AIチャットボット管理コンソール（モックUI）
                  </Typography>
                  <IconButton
                    size="small"
                    onClick={handleReset}
                    title="デモデータを初期化"
                  >
                    <span className="material-icons">restart_alt</span>
                  </IconButton>
                </Toolbar>
                <Tabs
                  value={tab}
                  onChange={function(_, v) { setTab(v); }}
                  variant="scrollable"
                  scrollButtons="auto"
                  textColor="primary"
                  indicatorColor="primary"
                >
                  <Tab icon={<Dashboard />} iconPosition="start" label="概要" />
                  <Tab icon={<Chat />} iconPosition="start" label="ボット" />
                  <Tab icon={<SmartToy />} iconPosition="start" label="エージェント" />
                  <Tab icon={<History />} iconPosition="start" label="履歴" />
                  <Tab icon={<Security />} iconPosition="start" label="権限" />
                  <Tab icon={<Settings />} iconPosition="start" label="設定" />
                </Tabs>
              </AppBar>

              <Container maxWidth={false} sx={{ py: 2, px: 2 }}>
                {tab === 0 && (
                  <OverviewSection bots={bots} agents={agents} chatHistory={chatHistory} />
                )}
                {tab === 1 && (
                  <BotsSection
                    bots={bots}
                    setBots={setBots}
                    agents={agents}
                    notify={notify}
                  />
                )}
                {tab === 2 && (
                  <AgentsSection
                    agents={agents}
                    setAgents={setAgents}
                    notify={notify}
                  />
                )}
                {tab === 3 && (
                  <HistorySection
                    chatHistory={chatHistory}
                    setChatHistory={setChatHistory}
                    notify={notify}
                  />
                )}
                {tab === 4 && (
                  <PermissionsSection
                    permissions={permissions}
                    setPermissions={setPermissions}
                    notify={notify}
                  />
                )}
                {tab === 5 && (
                  <section>
                    <Paper variant="outlined">
                      <Box p={2}>
                        <Typography variant="h6">
                          <Settings sx={{ mr:1, verticalAlign:"middle" }} />
                          システム設定
                        </Typography>
                      </Box>
                      <Divider />
                      <Box p={2}>
                        <Typography variant="body2" color="text.secondary">
                          ここには本来、APIキー・エンドポイント・RAGストア設定などの
                          システム設定を配置します。このデモでは実装していません。
                        </Typography>
                        <Box mt={2}>
                          <TextField
                            label="API ベースURL（ダミー）"
                            fullWidth
                            value="https://api.example.com"
                            disabled
                            sx={{ mb: 2 }}
                          />
                          <TextField
                            label="OpenAI API Key（ダミー表示）"
                            fullWidth
                            type="password"
                            value="sk-********************************"
                            disabled
                          />
                        </Box>
                      </Box>
                    </Paper>
                  </section>
                )}
              </Container>

              <MessageDialog
                open={msg.open}
                title={msg.title}
                message={msg.message}
                onClose={function() {
                  setMsg(function(prev) {
                    return Object.assign({}, prev, { open: false });
                  });
                }}
              />
            </ThemeProvider>
          );
        }

        const rootElement = document.getElementById("root");
        const root = createRoot(rootElement);
        root.render(
          <React.StrictMode>
            <App />
          </React.StrictMode>
        );
      `;

      const { code } = Babel.transform(appCode, { presets: ["react"] });

      const runApp = new Function(
        "React",
        "createRoot",
        "MaterialUI",
        "MaterialIcons",
        code
      );

      runApp(React, createRoot, MaterialUI, MaterialIcons);
    </script>
  </body>
</html>
