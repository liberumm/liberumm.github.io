<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>地理院タイル + 町丁目ポリゴン（直fetch / プロキシ無し）</title>
  <link rel="icon" href="data:,">

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <!-- TopoJSON client -->
  <script src="https://unpkg.com/topojson-client@3"></script>

  <style>
    html, body, #map { height: 100%; margin: 0; }
    .ui {
      position: absolute; top: 10px; left: 10px; z-index: 1000;
      background: rgba(255,255,255,0.92);
      border: 1px solid rgba(0,0,0,0.15);
      border-radius: 10px;
      padding: 10px 12px;
      font: 13px/1.3 Meiryo, system-ui, sans-serif;
      box-shadow: 0 2px 10px rgba(0,0,0,0.08);
      max-width: 440px;
    }
    .status { margin-top: 6px; color: #333; font-size: 12px; }
    code { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size: 12px; }
  </style>
</head>
<body>
  <div id="map"></div>

  <div class="ui">
    <div><b>直fetch（プロキシ無し）</b></div>
    <div class="status" id="status">読み込み中...</div>
    <div class="status">URL：<br><code id="src"></code></div>
    <div class="status">
      ※ この版は、相手サーバがCORS許可していないとブラウザ仕様で失敗します。
    </div>
  </div>

  <script>
    const GEOSHAPE_TOPO =
      'https://geoshape.ex.nii.ac.jp/ka/topojson/2020/13/r2ka13102.topojson';
    document.getElementById('src').textContent = GEOSHAPE_TOPO;

    const statusEl = document.getElementById('status');
    const map = L.map('map').setView([35.6812, 139.7671], 15);

    // 地理院淡色地図
    L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/pale/{z}/{x}/{y}.png', {
      maxZoom: 18,
      attribution: '地理院タイル'
    }).addTo(map);

    function setStatus(msg) { statusEl.textContent = msg; }

    function polyStyle() {
      return {
        color: '#ff2d55',
        weight: 3.5,
        opacity: 1.0,
        fillColor: '#ffcc00',
        fillOpacity: 0.35
      };
    }
    function hoverStyle() {
      return { weight: 6, color: '#00e5ff', fillOpacity: 0.55 };
    }

    fetch(GEOSHAPE_TOPO)
      .then(r => {
        if (!r.ok) throw new Error('HTTP ' + r.status);
        return r.json();
      })
      .then(topo => {
        const keys = Object.keys(topo.objects || {});
        if (keys.length === 0) throw new Error('TopoJSON objects が空です');
        const objName = keys[0];

        const geojson = topojson.feature(topo, topo.objects[objName]);
        setStatus(`表示中：objects="${objName}" / features=${geojson.features.length}`);

        const layer = L.geoJSON(geojson, {
          style: polyStyle,
          onEachFeature: (feature, lyr) => {
            lyr.on('mouseover', () => lyr.setStyle(hoverStyle()));
            lyr.on('mouseout', () => layer.resetStyle(lyr));
          }
        }).addTo(map);

        map.fitBounds(layer.getBounds(), { padding: [20, 20] });
      })
      .catch(err => {
        console.error(err);
        setStatus('失敗: ' + err.message);
        alert(
          '直fetchに失敗しました。\n' +
          'ブラウザのCORS仕様でブロックされるのが典型です。\n\n' +
          'エラー: ' + err.message
        );
      });
  </script>
</body>
</html>
