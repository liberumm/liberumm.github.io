<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <title>React 19 + MUI 7.3.5 - Action List UI</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Roboto（300 / 400 / 600 / 700） -->
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;600;700&display=swap"
    />

    <!-- Material Icons（フォントアイコン） -->
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/icon?family=Material+Icons"
    />
  </head>
  <body>
    <div id="root"></div>

    <!-- Babel Standalone（JSX -> JS 変換用） -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- React 19 / MUI 7.3.5 / Icons を ESM import -->
    <script type="module">
      import React from "https://esm.sh/react@19.2.0";
      import { createRoot } from "https://esm.sh/react-dom@19.2.0/client";
      import * as MaterialUI from "https://esm.sh/@mui/material@7.3.5?deps=react@19.2.0,react-dom@19.2.0";
      import * as MaterialIcons from "https://esm.sh/@mui/icons-material@7.3.5?deps=react@19.2.0,react-dom@19.2.0";

      // DataGrid（X）を追加
      import { DataGrid } from "https://esm.sh/@mui/x-data-grid@7.23.6?deps=react@19.2.0,react-dom@19.2.0,@mui/material@7.3.5";

      const appCode = `
        const { useMemo, useState } = React;

        const {
          ThemeProvider,
          createTheme,
          CssBaseline,
          Container,
          Box,
          Stack,
          TextField,
          Button,
          Typography,
          AppBar,
          Toolbar,
          Chip,
          Paper,
          Tabs,
          Tab,
          Divider,
          IconButton,
          Tooltip,
          FormControl,
          InputLabel,
          Select,
          MenuItem,
          Badge,
          Drawer,
          List,
          ListItem,
          ListItemText,
          Dialog,
          DialogTitle,
          DialogContent,
          DialogActions,
          Snackbar,
          Alert,
          ToggleButtonGroup,
          ToggleButton,
        } = MaterialUI;

        const {
          CheckCircle,
          Undo,
          FilterList,
          Search,
          Info,
          Close,
          LocalShipping,
          ShoppingCart,
          PriceChange,
        } = MaterialIcons;

        const theme = createTheme({
          palette: {
            mode: "light",
            primary: { main: "#1976d2" },
            success: { main: "#2e7d32" },
            warning: { main: "#ed6c02" },
            error: { main: "#d32f2f" },
          },
          typography: {
            fontFamily: '"Roboto", "Helvetica", "Arial", sans-serif',
          },
          shape: { borderRadius: 10 },
        });

        const ACTION_META = {
          発注: { color: "info", icon: ShoppingCart },
          移管出庫: { color: "warning", icon: LocalShipping },
          値下げ: { color: "error", icon: PriceChange },
        };

        function nowISO() {
          const d = new Date();
          const pad = (n) => String(n).padStart(2, "0");
          return (
            d.getFullYear() +
            "/" +
            pad(d.getMonth() + 1) +
            "/" +
            pad(d.getDate()) +
            " " +
            pad(d.getHours()) +
            ":" +
            pad(d.getMinutes()) +
            ":" +
            pad(d.getSeconds())
          );
        }

        function App() {
          // ダミーデータ（UI検証用）
          const [rows, setRows] = useState([
            {
              id: 1,
              direction: "商品部→店舗",
              datetime: "2026/01/27 18:39:59",
              date: "2026/01/28",
              productName: "Tシャツー5分ーシャーリングー三ニHNー初秋",
              productCode: "0001899710",
              store: "コルモピアコピオ柏原",
              actionType: "移管出庫",
              content: "コルモピアコピオ柏原 → コルモピア氷川台駅前：2個",
              qtyOrRate: "2個",
              status: "未対応",
              note: "",
            },
            {
              id: 2,
              direction: "店舗→商品部",
              datetime: "2026/01/27 18:29:05",
              date: "2026/01/31",
              productName: "長袖裏毛ベスト＋TシャツES",
              productCode: "0002611800",
              store: "コルモピア横浜岡野",
              actionType: "発注",
              content: "発注推奨",
              qtyOrRate: "22個",
              status: "未対応",
              note: "",
            },
            {
              id: 3,
              direction: "店舗→商品部",
              datetime: "2026/01/27 18:29:05",
              date: "2026/01/28",
              productName: "B＋ES JQベスト＋裾ラウンドT",
              productCode: "0002612210",
              store: "コルモピア松戸新田",
              actionType: "値下げ",
              content: "値下げ推奨",
              qtyOrRate: "23%",
              status: "未対応",
              note: "",
            },
            {
              id: 4,
              direction: "店舗→商品部",
              datetime: "2026/01/15 11:01:41",
              date: "2026/01/23",
              productName: "F4-32 婦人 まるごたソックス黒2325",
              productCode: "1017566700",
              store: "コルモピア王子",
              actionType: "発注",
              content: "発注推奨",
              qtyOrRate: "12個",
              status: "完了/承認",
              note: "実施済",
            },
            {
              id: 5,
              direction: "店舗→商品部",
              datetime: "2025/12/22 11:42:02",
              date: "2025/12/25",
              productName: "裏起毛上下セット",
              productCode: "0451319700",
              store: "コルモピア王子",
              actionType: "移管出庫",
              content: "コルモピア王子 → コルモピア氷川台駅前：5個",
              qtyOrRate: "5個",
              status: "差戻",
              note: "移管先の在庫過多。別店舗を提案。",
            },
          ]);

          // UI state
          const [tab, setTab] = useState("すべて"); // すべて/未対応/対応済
          const [query, setQuery] = useState("");
          const [storeFilter, setStoreFilter] = useState("全店舗");
          const [typeFilter, setTypeFilter] = useState("全種別");
          const [directionFilter, setDirectionFilter] = useState("全方向");
          const [density, setDensity] = useState("standard");

          const [selected, setSelected] = useState(null);
          const [drawerOpen, setDrawerOpen] = useState(false);

          const [rejectOpen, setRejectOpen] = useState(false);
          const [rejectReason, setRejectReason] = useState("在庫過多");
          const [rejectComment, setRejectComment] = useState("");

          const [snack, setSnack] = useState({ open: false, message: "", severity: "success" });

          const stores = useMemo(() => {
            const set = new Set(rows.map((r) => r.store));
            return ["全店舗", ...Array.from(set)];
          }, [rows]);

          const kpi = useMemo(() => {
            const total = rows.length;
            const pending = rows.filter((r) => r.status === "未対応").length;
            const done = rows.filter((r) => r.status === "完了/承認").length;
            const rejected = rows.filter((r) => r.status === "差戻").length;
            return { total, pending, done, rejected };
          }, [rows]);

          const filteredRows = useMemo(() => {
            return rows
              .filter((r) => {
                if (tab === "未対応") return r.status === "未対応";
                if (tab === "対応済") return r.status !== "未対応";
                return true;
              })
              .filter((r) => (storeFilter === "全店舗" ? true : r.store === storeFilter))
              .filter((r) => (typeFilter === "全種別" ? true : r.actionType === typeFilter))
              .filter((r) => (directionFilter === "全方向" ? true : r.direction === directionFilter))
              .filter((r) => {
                if (!query.trim()) return true;
                const q = query.trim().toLowerCase();
                const hay = (
                  r.productName +
                  " " +
                  r.productCode +
                  " " +
                  r.store +
                  " " +
                  r.actionType +
                  " " +
                  r.content +
                  " " +
                  r.status
                ).toLowerCase();
                return hay.includes(q);
              });
          }, [rows, tab, storeFilter, typeFilter, directionFilter, query]);

          function openDetails(row) {
            setSelected(row);
            setDrawerOpen(true);
          }

          function markDone(row) {
            if (row.status !== "未対応") {
              setSnack({ open: true, message: "未対応の行のみ完了にできます。", severity: "warning" });
              return;
            }
            setRows((prev) =>
              prev.map((r) =>
                r.id === row.id
                  ? { ...r, status: "完了/承認", note: "完了：" + nowISO() }
                  : r
              )
            );
            setSnack({ open: true, message: "完了にしました。", severity: "success" });
          }

          function openReject(row) {
            if (row.status !== "未対応") {
              setSnack({ open: true, message: "未対応の行のみ差戻にできます。", severity: "warning" });
              return;
            }
            setSelected(row);
            setRejectComment("");
            setRejectReason("在庫過多");
            setRejectOpen(true);
          }

          function submitReject() {
            if (!rejectComment.trim()) {
              setSnack({ open: true, message: "差戻コメントは必須です。", severity: "error" });
              return;
            }
            setRows((prev) =>
              prev.map((r) =>
                r.id === selected.id
                  ? {
                      ...r,
                      status: "差戻",
                      note: "差戻理由：" + rejectReason + "｜コメント：" + rejectComment.trim(),
                    }
                  : r
              )
            );
            setRejectOpen(false);
            setSnack({ open: true, message: "差戻しました。", severity: "info" });
          }

          const columns = useMemo(() => {
            return [
              {
                field: "direction",
                headerName: "方向",
                width: 140,
                renderCell: (params) => (
                  <Chip
                    size="small"
                    label={params.value}
                    variant="outlined"
                    sx={{ fontWeight: 600 }}
                  />
                ),
              },
              { field: "datetime", headerName: "日時", width: 170 },
              { field: "date", headerName: "日付", width: 110 },
              {
                field: "productName",
                headerName: "商品",
                width: 320,
                renderCell: (params) => (
                  <Box>
                    <Typography variant="body2" sx={{ fontWeight: 700, lineHeight: 1.2 }}>
                      {params.row.productName}
                    </Typography>
                    <Typography variant="caption" color="text.secondary">
                      {params.row.productCode}
                    </Typography>
                  </Box>
                ),
              },
              { field: "store", headerName: "店舗", width: 180 },
              {
                field: "actionType",
                headerName: "内容",
                width: 120,
                renderCell: (params) => {
                  const meta = ACTION_META[params.value] || { color: "default", icon: Info };
                  const Icon = meta.icon;
                  return (
                    <Chip
                      size="small"
                      color={meta.color}
                      icon={<Icon sx={{ fontSize: 18 }} />}
                      label={params.value}
                      sx={{ fontWeight: 700 }}
                    />
                  );
                },
              },
              {
                field: "content",
                headerName: "詳細",
                width: 300,
                renderCell: (params) => (
                  <Typography variant="body2" sx={{ whiteSpace: "nowrap", overflow: "hidden", textOverflow: "ellipsis" }}>
                    {params.value}
                  </Typography>
                ),
              },
              { field: "qtyOrRate", headerName: "数量/率", width: 110 },
              {
                field: "status",
                headerName: "ステータス",
                width: 130,
                renderCell: (params) => {
                  const v = params.value;
                  const color =
                    v === "未対応" ? "warning" : v === "完了/承認" ? "success" : v === "差戻" ? "error" : "default";
                  return <Chip size="small" color={color} label={v} sx={{ fontWeight: 700 }} />;
                },
              },
              {
                field: "actions",
                headerName: "操作",
                width: 220,
                sortable: false,
                filterable: false,
                renderCell: (params) => (
                  <Stack direction="row" spacing={1}>
                    <Button
                      size="small"
                      variant="contained"
                      color="success"
                      startIcon={<CheckCircle />}
                      onClick={() => markDone(params.row)}
                      disabled={params.row.status !== "未対応"}
                    >
                      完了
                    </Button>
                    <Button
                      size="small"
                      variant="outlined"
                      color="error"
                      startIcon={<Undo />}
                      onClick={() => openReject(params.row)}
                      disabled={params.row.status !== "未対応"}
                    >
                      差戻
                    </Button>
                    <Tooltip title="詳細">
                      <IconButton size="small" onClick={() => openDetails(params.row)}>
                        <Info fontSize="small" />
                      </IconButton>
                    </Tooltip>
                  </Stack>
                ),
              },
            ];
          }, [rows, tab, storeFilter, typeFilter, directionFilter, query, selected]);

          return (
            <ThemeProvider theme={theme}>
              <CssBaseline />

              <AppBar position="sticky" color="default" elevation={0} sx={{ borderBottom: "1px solid", borderColor: "divider" }}>
                <Toolbar sx={{ gap: 2 }}>
                  <Typography variant="h6" sx={{ fontWeight: 800 }}>
                    やることリスト（推奨アクション）
                  </Typography>

                  <Box sx={{ flex: 1 }} />

                  <Stack direction="row" spacing={1} alignItems="center">
                    <Badge badgeContent={kpi.pending} color="warning">
                      <Chip label={"未対応 " + kpi.pending} color="warning" variant="outlined" />
                    </Badge>
                    <Chip label={"完了 " + kpi.done} color="success" variant="outlined" />
                    <Chip label={"差戻 " + kpi.rejected} color="error" variant="outlined" />
                    <Chip label={"合計 " + kpi.total} variant="outlined" />
                  </Stack>
                </Toolbar>
              </AppBar>

              <Container maxWidth="xl">
                <Box sx={{ mt: 2, mb: 3 }}>
                  <Paper variant="outlined" sx={{ p: 2 }}>
                    <Stack spacing={2}>
                      <Stack direction={{ xs: "column", md: "row" }} spacing={2} alignItems={{ md: "center" }}>
                        <TextField
                          size="small"
                          fullWidth
                          placeholder="検索（商品名/コード/店舗/内容/ステータス）"
                          value={query}
                          onChange={(e) => setQuery(e.target.value)}
                          InputProps={{
                            startAdornment: (
                              <Box sx={{ display: "flex", alignItems: "center", mr: 1, color: "text.secondary" }}>
                                <Search fontSize="small" />
                              </Box>
                            ),
                          }}
                        />

                        <Stack direction="row" spacing={2} sx={{ width: { xs: "100%", md: "auto" } }}>
                          <FormControl size="small" sx={{ minWidth: 160, flex: 1 }}>
                            <InputLabel>店舗</InputLabel>
                            <Select label="店舗" value={storeFilter} onChange={(e) => setStoreFilter(e.target.value)}>
                              {stores.map((s) => (
                                <MenuItem key={s} value={s}>{s}</MenuItem>
                              ))}
                            </Select>
                          </FormControl>

                          <FormControl size="small" sx={{ minWidth: 140, flex: 1 }}>
                            <InputLabel>種別</InputLabel>
                            <Select label="種別" value={typeFilter} onChange={(e) => setTypeFilter(e.target.value)}>
                              {["全種別", "発注", "移管出庫", "値下げ"].map((t) => (
                                <MenuItem key={t} value={t}>{t}</MenuItem>
                              ))}
                            </Select>
                          </FormControl>

                          <FormControl size="small" sx={{ minWidth: 160, flex: 1 }}>
                            <InputLabel>方向</InputLabel>
                            <Select label="方向" value={directionFilter} onChange={(e) => setDirectionFilter(e.target.value)}>
                              {["全方向", "商品部→店舗", "店舗→商品部"].map((d) => (
                                <MenuItem key={d} value={d}>{d}</MenuItem>
                              ))}
                            </Select>
                          </FormControl>
                        </Stack>
                      </Stack>

                      <Stack direction={{ xs: "column", md: "row" }} spacing={2} alignItems={{ md: "center" }}>
                        <Tabs
                          value={tab}
                          onChange={(_, v) => setTab(v)}
                          textColor="primary"
                          indicatorColor="primary"
                          sx={{ minHeight: 40 }}
                        >
                          <Tab value="すべて" label="すべて" />
                          <Tab value="未対応" label="未対応" />
                          <Tab value="対応済" label="対応済" />
                        </Tabs>

                        <Box sx={{ flex: 1 }} />

                        <ToggleButtonGroup
                          size="small"
                          exclusive
                          value={density}
                          onChange={(_, v) => v && setDensity(v)}
                        >
                          <ToggleButton value="compact">コンパクト</ToggleButton>
                          <ToggleButton value="standard">標準</ToggleButton>
                        </ToggleButtonGroup>

                        <Tooltip title="フィルタをリセット">
                          <Button
                            variant="outlined"
                            startIcon={<FilterList />}
                            onClick={() => {
                              setQuery("");
                              setStoreFilter("全店舗");
                              setTypeFilter("全種別");
                              setDirectionFilter("全方向");
                              setTab("すべて");
                              setSnack({ open: true, message: "フィルタをリセットしました。", severity: "success" });
                            }}
                          >
                            リセット
                          </Button>
                        </Tooltip>
                      </Stack>

                      <Divider />

                      <Box sx={{ height: 560 }}>
                        <DataGrid
                          rows={filteredRows}
                          columns={columns}
                          density={density === "compact" ? "compact" : "standard"}
                          disableRowSelectionOnClick
                          onRowDoubleClick={(params) => openDetails(params.row)}
                          getRowClassName={(params) => {
                            if (params.row.status === "完了/承認") return "rowDone";
                            if (params.row.status === "差戻") return "rowRejected";
                            return "";
                          }}
                          sx={{
                            border: 0,
                            "& .rowDone": { backgroundColor: "rgba(46,125,50,0.08)" },
                            "& .rowRejected": { backgroundColor: "rgba(211,47,47,0.08)" },
                          }}
                          initialState={{
                            pagination: { paginationModel: { pageSize: 10, page: 0 } },
                          }}
                          pageSizeOptions={[10, 25, 50]}
                        />
                      </Box>

                      <Typography variant="caption" color="text.secondary">
                        操作：行をダブルクリックで詳細表示。未対応のみ「完了/差戻」が可能。
                      </Typography>
                    </Stack>
                  </Paper>
                </Box>
              </Container>

              {/* 詳細Drawer */}
              <Drawer anchor="right" open={drawerOpen} onClose={() => setDrawerOpen(false)}>
                <Box sx={{ width: 380, p: 2 }}>
                  <Stack direction="row" alignItems="center" spacing={1}>
                    <Typography variant="h6" sx={{ fontWeight: 800 }}>詳細</Typography>
                    <Box sx={{ flex: 1 }} />
                    <IconButton onClick={() => setDrawerOpen(false)}><Close /></IconButton>
                  </Stack>
                  <Divider sx={{ my: 1.5 }} />

                  {!selected ? (
                    <Typography variant="body2" color="text.secondary">未選択</Typography>
                  ) : (
                    <List dense>
                      <ListItem><ListItemText primary="方向" secondary={selected.direction} /></ListItem>
                      <ListItem><ListItemText primary="日時" secondary={selected.datetime} /></ListItem>
                      <ListItem><ListItemText primary="日付" secondary={selected.date} /></ListItem>
                      <ListItem><ListItemText primary="商品" secondary={selected.productName} /></ListItem>
                      <ListItem><ListItemText primary="商品コード" secondary={selected.productCode} /></ListItem>
                      <ListItem><ListItemText primary="店舗" secondary={selected.store} /></ListItem>
                      <ListItem><ListItemText primary="内容" secondary={selected.actionType} /></ListItem>
                      <ListItem><ListItemText primary="詳細" secondary={selected.content} /></ListItem>
                      <ListItem><ListItemText primary="数量/率" secondary={selected.qtyOrRate} /></ListItem>
                      <ListItem><ListItemText primary="ステータス" secondary={selected.status} /></ListItem>
                      <ListItem><ListItemText primary="備考/差戻コメント" secondary={selected.note || "-"} /></ListItem>
                    </List>
                  )}

                  <Divider sx={{ my: 1.5 }} />

                  <Stack direction="row" spacing={1}>
                    <Button
                      fullWidth
                      variant="contained"
                      color="success"
                      startIcon={<CheckCircle />}
                      onClick={() => selected && markDone(selected)}
                      disabled={!selected || selected.status !== "未対応"}
                    >
                      完了
                    </Button>
                    <Button
                      fullWidth
                      variant="outlined"
                      color="error"
                      startIcon={<Undo />}
                      onClick={() => selected && openReject(selected)}
                      disabled={!selected || selected.status !== "未対応"}
                    >
                      差戻
                    </Button>
                  </Stack>
                </Box>
              </Drawer>

              {/* 差戻 Dialog */}
              <Dialog open={rejectOpen} onClose={() => setRejectOpen(false)} fullWidth maxWidth="sm">
                <DialogTitle sx={{ fontWeight: 800 }}>差戻（理由とコメント必須）</DialogTitle>
                <DialogContent>
                  <Stack spacing={2} sx={{ mt: 1 }}>
                    <Typography variant="body2" color="text.secondary">
                      対象：{selected ? selected.productName + " / " + selected.store : "-"}
                    </Typography>

                    <FormControl size="small" fullWidth>
                      <InputLabel>理由</InputLabel>
                      <Select
                        label="理由"
                        value={rejectReason}
                        onChange={(e) => setRejectReason(e.target.value)}
                      >
                        {["在庫過多", "売場都合", "季節ズレ", "価格施策NG", "データ不整合", "その他"].map((r) => (
                          <MenuItem key={r} value={r}>{r}</MenuItem>
                        ))}
                      </Select>
                    </FormControl>

                    <TextField
                      label="差戻コメント（必須）"
                      value={rejectComment}
                      onChange={(e) => setRejectComment(e.target.value)}
                      multiline
                      minRows={3}
                      placeholder="例：移管先が在庫過多。○○店なら受入可能。"
                      fullWidth
                    />
                  </Stack>
                </DialogContent>
                <DialogActions>
                  <Button onClick={() => setRejectOpen(false)}>キャンセル</Button>
                  <Button variant="contained" color="error" onClick={submitReject}>
                    差戻する
                  </Button>
                </DialogActions>
              </Dialog>

              {/* Snackbar */}
              <Snackbar
                open={snack.open}
                autoHideDuration={2600}
                onClose={() => setSnack((s) => ({ ...s, open: false }))}
                anchorOrigin={{ vertical: "bottom", horizontal: "center" }}
              >
                <Alert
                  onClose={() => setSnack((s) => ({ ...s, open: false }))}
                  severity={snack.severity}
                  variant="filled"
                  sx={{ width: "100%" }}
                >
                  {snack.message}
                </Alert>
              </Snackbar>
            </ThemeProvider>
          );
        }

        const root = createRoot(document.getElementById("root"));
        root.render(
          <React.StrictMode>
            <App />
          </React.StrictMode>
        );
      `;

      const { code } = Babel.transform(appCode, { presets: ["react"] });

      const runApp = new Function(
        "React",
        "createRoot",
        "MaterialUI",
        "MaterialIcons",
        "DataGrid",
        code
      );

      runApp(React, createRoot, MaterialUI, MaterialIcons, DataGrid);
    </script>
  </body>
</html>
