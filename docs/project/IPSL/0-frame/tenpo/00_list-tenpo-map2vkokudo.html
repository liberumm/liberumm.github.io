<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>React Leaflet with GSI Tiles</title>
  <!-- React and ReactDOM -->
  <script src="https://cdn.jsdelivr.net/npm/react@18/umd/react.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18/umd/react-dom.production.min.js"></script>
  <!-- MUI (Material-UI) -->
  <script src="https://cdn.jsdelivr.net/npm/@mui/material@5.11.15/umd/material-ui.production.min.js"></script>
  <!-- Babel for JSX -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.21.0/babel.min.js"></script>
  <!-- Emotion ライブラリ -->
  <script src="https://cdn.jsdelivr.net/npm/@emotion/react@11.11.0/dist/emotion-react.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@emotion/styled@11.11.0/dist/emotion-styled.umd.min.js"></script>
  <!-- PapaParse -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <!-- Material-UI Styles -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons" />

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    #root {
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    footer {
      text-align: center;
      background-color: #1976d2;
      color: white;
      padding: 0.5rem;
    }
    .drop-zone {
      border: 2px dashed #1976d2;
      border-radius: 4px;
      padding: 20px;
      text-align: center;
      color: #1976d2;
      cursor: pointer;
      transition: background-color 0.2s;
      position: relative;
    }
    .drop-zone.dragover {
      background-color: #e3f2fd;
    }

    /* テーブルセル内で折り畳まないように */
    td, th {
      white-space: nowrap;
    }
  </style>
</head>
<body>
  <div id="root"></div>
  <!-- Leaflet JS -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    crossorigin=""
  ></script>
  <script type="text/babel">
    const {
      AppBar,
      Toolbar,
      Typography,
      CssBaseline,
      Box,
      Table,
      TableBody,
      TableCell,
      TableContainer,
      TableHead,
      TableRow,
      TablePagination,
      Paper,
      TextField,
      Button,
      Collapse,
      Checkbox,
      FormGroup,
      FormControlLabel,
      FormControl,
      FormLabel,
      Select,
      MenuItem,
      InputLabel,
      Typography: MuiTypography,
      Dialog,
      DialogTitle,
      DialogContent,
      DialogContentText,
      DialogActions,
      IconButton,
      TableSortLabel,
      Tooltip, // 追加
    } = MaterialUI;

    const App = () => {
      // e-Stat APIキー
      //const ESTAT_API_KEY = 'YOUR_ESTAT_API_KEY'; // ここに実際のAPIキーを入力してください
      const ESTAT_API_KEY = ''; // ここに実際のAPIキーを入力してください

      // 初期店舗データ（サンプル）
      const initialStores = Array.from({ length: 10 }, (_, i) => ({
        storeCode: `S${i + 1}`,
        name: `Store ${i + 1}`,
        sales: (Math.random() * 100000).toFixed(2),
        budget: (Math.random() * 120000).toFixed(2),
        startDate: `2024-01-${String((i % 28) + 1).padStart(2, "0")}`,
        endDate: `2024-12-${String((i % 28) + 1).padStart(2, "0")}`,
        days: 365,
        address: `Address ${i + 1}`,
        lat: 35.6895 + (i % 5) * 0.01,
        lng: 139.6917 + (i % 5) * 0.01,
        businessType: "Retail",
        block: `Block ${i + 1}`,
        area: `${(Math.random() * 500).toFixed(2)}㎡`,
        isActive: i % 2 === 0 ? "有効" : "無効",
        posCode: `POS${i + 1}`,
        market: `Market ${i + 1}`,
        marketId: `M${i + 1}`,
      }));

      // 初期選択状態を全選択に設定
      const [selectedStores, setSelectedStores] = React.useState(new Set(initialStores.map(store => store.storeCode)));

      const [stores, setStores] = React.useState(initialStores);
      const [filteredStores, setFilteredStores] = React.useState(initialStores);
      const [page, setPage] = React.useState(0);
      const [rowsPerPage, setRowsPerPage] = React.useState(10);
      const [globalFilterText, setGlobalFilterText] = React.useState("");
      const [expandedCSV, setExpandedCSV] = React.useState(false);
      const [expandedMap, setExpandedMap] = React.useState(true);
      const [expandedTable, setExpandedTable] = React.useState(true);

      const mapRef = React.useRef(null);
      const markersRef = React.useRef({}); // storeCode -> marker

      // 列フィルター用
      const [columnFilters, setColumnFilters] = React.useState({
        storeCode: "",
        name: "",
        sales: "",
        budget: "",
        startDate: "",
        endDate: "",
        days: "",
        address: "",
        lat: "",
        lng: "",
        businessType: "",
        block: "",
        area: "",
        isActive: "",
        posCode: "",
        market: "",
        marketId: "",
      });

      // フィルターモード（partial または exact）用の状態
      const [filterModes, setFilterModes] = React.useState({
        storeCode: "partial",
        name: "partial",
        sales: "partial",
        budget: "partial",
        startDate: "partial",
        endDate: "partial",
        days: "partial",
        address: "partial",
        lat: "partial",
        lng: "partial",
        businessType: "partial",
        block: "partial",
        area: "partial",
        isActive: "partial",
        posCode: "partial",
        market: "partial",
        marketId: "partial",
      });

      // サークル表示モード（複数選択可能）
      const [circleModes, setCircleModes] = React.useState({
        trade1: true,  // 初期は1次と2次商圏を有効
        trade2: true,
        trade3: false, // 3次商圏は初期では無効
        sales: false,
        budget: false,
        area: false,
      });
      // 商圏用設定（各レベルの半径と色）
      const [tradeSettings, setTradeSettings] = React.useState({
        trade1: { radius: 1500, color: '#77DD77' }, // 1次商圏: 1500m, パステルグリーン
        trade2: { radius: 3000, color: '#77DD77' }, // 2次商圏: 3000m, パステルグリーン
        trade3: { radius: 4500, color: '#77DD77' }, // 3次商圏: 4500m, パステルグリーン
      });

      // その他のサークル設定（売上、予算、面積）
      const [circleSettings, setCircleSettings] = React.useState({
        sales: { scale: 0.01, color: '#AEC6CF' },   // 売上: スケール 0.01, パステルブルー
        budget: { scale: 0.01, color: '#D3D3D3' },  // 予算: スケール 0.01, グレー
        area: { scale: 0.2, color: '#FFD1B3' },     // 面積: スケール 0.2, パステルオレンジ
      });

      // ドラッグオーバーの状態を管理
      const [isDragOver, setIsDragOver] = React.useState(false);

      // 詳細ダイアログの状態
      const [openDetailDialog, setOpenDetailDialog] = React.useState(false);
      const [selectedStore, setSelectedStore] = React.useState(null);

      // 並び順の状態
      const [order, setOrder] = React.useState('asc');
      const [orderBy, setOrderBy] = React.useState('');

      // 人口データの状態
      const [populationData, setPopulationData] = React.useState({}); // { storeCode: { trade1: population, trade2: population, ... } }

      React.useEffect(() => {
        if (!mapRef.current) {
          mapRef.current = L.map("map").setView([35.6895, 139.6917], 13);
          L.tileLayer(
            "https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png",
            {
              attribution:
                '&copy; <a href="https://www.gsi.go.jp/" target="_blank">国土地理院</a>',
            }
          ).addTo(mapRef.current);
        }

        const mapInstance = mapRef.current;
        // 既存マーカー・サークルを削除
        mapInstance.eachLayer((layer) => {
          if (layer instanceof L.Marker || layer instanceof L.Circle || layer instanceof L.Popup) {
            mapInstance.removeLayer(layer);
          }
        });

        // マーカーのリファレンスをリセット
        markersRef.current = {};

        // 地図に表示する店舗を選択された店舗に限定
        const storesToDisplay = filteredStores.filter(store => selectedStores.has(store.storeCode));

        storesToDisplay.forEach((store) => {
          // マーカー
          const marker = L.marker([store.lat, store.lng])
            .addTo(mapInstance)
            .bindPopup(generatePopupContent(store))
            .on('popupopen', () => {
              // Popupが開いた際のイベント（必要に応じて追加）
            });

          // マーカーをリファレンスに保存
          markersRef.current[store.storeCode] = marker;

          // 商圏サークルの描画
          Object.keys(tradeSettings).forEach((tradeLevel) => {
            if (circleModes[tradeLevel]) {
              const { radius, color } = tradeSettings[tradeLevel];
              if (radius && radius > 0) {
                const circle = L.circle([store.lat, store.lng], {
                  radius: radius,
                  color: color,
                  fillColor: color,
                  fillOpacity: 0.2,
                }).addTo(mapInstance);

                // ポップアップに人口データを表示
                const population = populationData[store.storeCode] && populationData[store.storeCode][tradeLevel]
                  ? populationData[store.storeCode][tradeLevel]
                  : 'Loading...';

                circle.bindPopup(`<strong>${tradeLevel}商圏の人口:</strong> ${population}`);
              }
            }
          });

          // その他のサークルモードの描画
          Object.keys(circleModes).forEach((mode) => {
            if (mode !== 'trade1' && mode !== 'trade2' && mode !== 'trade3' && circleModes[mode]) {
              let radius = null;
              let color = '#0000FF'; // デフォルト色

              if (mode === "sales") {
                // 売上ベース
                radius = parseFloat(store.sales) * (circleSettings.sales.scale || 1) || 0;
                color = circleSettings.sales.color || '#AEC6CF';
              } else if (mode === "budget") {
                // 予算ベース
                radius = parseFloat(store.budget) * (circleSettings.budget.scale || 1) || 0;
                color = circleSettings.budget.color || '#D3D3D3';
              } else if (mode === "area") {
                // 面積ベース (末尾の㎡を削除してパース)
                const areaVal = parseFloat(store.area.replace(/,/g, '').replace("㎡","")) || 0;
                radius = areaVal * (circleSettings.area.scale || 1) || 0;
                color = circleSettings.area.color || '#FFD1B3';
              }

              if (radius && radius > 0) {
                L.circle([store.lat, store.lng], {
                  radius: radius,
                  color: color,
                  fillColor: color,
                  fillOpacity: 0.2,
                }).addTo(mapInstance);
              }
            }
          });
        });
      }, [filteredStores, circleModes, tradeSettings, circleSettings, selectedStores, populationData]);

      // ポップアップ内容の生成関数
      const generatePopupContent = (store) => {
        const googleMapLink = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(store.address)}`;
        return `
          <div>
            <p><strong>店舗コード:</strong> ${store.storeCode}</p>
            <p><strong>店舗名:</strong> ${store.name}</p>
            <p><strong>住所:</strong> ${store.address}</p>
            <button onclick="window.dispatchEvent(new CustomEvent('openDetailDialog', { detail: '${store.storeCode}' }))">詳細</button>
            <button onclick="window.open('${googleMapLink}', '_blank')">Google Map</button>
          </div>
        `;
      };

      // ポップアップ内のボタンからのイベントリスナー
      React.useEffect(() => {
        const handleOpenDetailDialog = (event) => {
          const storeCode = event.detail;
          const store = stores.find(s => s.storeCode === storeCode);
          if (store) {
            setSelectedStore(store);
            setOpenDetailDialog(true);
          }
        };
        window.addEventListener('openDetailDialog', handleOpenDetailDialog);
        return () => {
          window.removeEventListener('openDetailDialog', handleOpenDetailDialog);
        };
      }, [stores]);

      // フィルタリング関数
      const applyFilters = () => {
        let filtered = stores.filter((store) => {
          // 全体フィルター判定
          const globalMatch = globalFilterText
            ? Object.values(store).some((value) =>
                String(value).toLowerCase().includes(globalFilterText.toLowerCase())
              )
            : true;

          // 列フィルター判定
          const columnMatch = Object.entries(columnFilters).every(([col, val]) => {
            if (!val) return true;

            const mode = filterModes[col];
            const storeValue = String(store[col]).toLowerCase();
            const filterValue = val.toLowerCase();

            if (mode === "exact") {
              return storeValue === filterValue;
            } else { // partial
              return storeValue.includes(filterValue);
            }
          });

          return globalMatch && columnMatch;
        });

        // 並び替えを適用
        if (orderBy) {
          filtered = stableSort(filtered, getComparator(order, orderBy));
        }

        setFilteredStores(filtered);
        setPage(0);
      };

      const handleFilterChange = (event) => {
        setGlobalFilterText(event.target.value);
      };

      const handleColumnFilterChange = (column) => (event) => {
        setColumnFilters((prev) => ({
          ...prev,
          [column]: event.target.value,
        }));
      };

      const handleFilterModeChange = (column) => (event) => {
        setFilterModes((prev) => ({
          ...prev,
          [column]: event.target.value,
        }));
      };

      const handleFilterApply = () => {
        applyFilters();
      };

      const handleFilterClear = () => {
        setGlobalFilterText("");
        setColumnFilters({
          storeCode: "",
          name: "",
          sales: "",
          budget: "",
          startDate: "",
          endDate: "",
          days: "",
          address: "",
          lat: "",
          lng: "",
          businessType: "",
          block: "",
          area: "",
          isActive: "",
          posCode: "",
          market: "",
          marketId: "",
        });
        setFilterModes({
          storeCode: "partial",
          name: "partial",
          sales: "partial",
          budget: "partial",
          startDate: "partial",
          endDate: "partial",
          days: "partial",
          address: "partial",
          lat: "partial",
          lng: "partial",
          businessType: "partial",
          block: "partial",
          area: "partial",
          isActive: "partial",
          posCode: "partial",
          market: "partial",
          marketId: "partial",
        });
        setFilteredStores(stores);
        setSelectedStores(new Set(stores.map(store => store.storeCode))); // 全選択にリセット
        setOrder('asc');
        setOrderBy('');
        setPopulationData({}); // 人口データをリセット
        setPage(0);
      };

      const fetchCoordinates = async (address) => {
        try {
          const response = await fetch(
            `https://msearch.gsi.go.jp/address-search/AddressSearch?q=${encodeURIComponent(
              address
            )}`
          );
          const data = await response.json();
          if (data.length > 0) {
            return {
              lat: data[0].geometry.coordinates[1],
              lng: data[0].geometry.coordinates[0],
            };
          }
        } catch (error) {
          console.error("Error fetching coordinates:", error);
        }
        return { lat: 35.6895, lng: 139.6917 }; 
      };

      const handleCSVUpload = async (file) => {
        if (file) {
          Papa.parse(file, {
            header: true,
            skipEmptyLines: true,
            transformHeader: header => header.replace(/^\ufeff/, '').trim(), // BOMを削除し、トリム
            complete: async (results) => {
              const parsedData = results.data;
              console.log("Parsed Data:", parsedData); // デバッグ用

              const parsedStores = await Promise.all(
                parsedData.map(async (row, idx) => {
                  // フィールド名に基づいてデータを取得
                  const {
                    店舗コード: storeCode,
                    店舗名: name,
                    売上: sales,
                    予算: budget,
                    開始日: startDate,
                    終了日: endDate,
                    日数: days,
                    住所: address,
                    緯度: lat,
                    経度: lng, // '経度'に修正
                    事業区分: businessType,
                    ブロック: block,
                    面積: area,
                    有効無効: isActive,
                    POSコード: posCode,
                    市場: market,
                    市場ID: marketId,
                  } = row;

                  // デバッグ用に各フィールドを確認
                  console.log(`Store ${idx + 1}:`, {
                    storeCode, name, sales, budget, startDate, endDate, days,
                    address, lat, lng, businessType, block, area, isActive,
                    posCode, market, marketId
                  });

                  // 緯度と経度のパース
                  let parsedLat = parseFloat(lat);
                  let parsedLng = parseFloat(lng);
                  if ((!parsedLat || !parsedLng) && address) {
                    const coordinates = await fetchCoordinates(address);
                    parsedLat = coordinates.lat;
                    parsedLng = coordinates.lng;
                  }

                  // 面積のカンマを削除してパース
                  let parsedArea = area ? parseFloat(area.replace(/,/g, '').replace("㎡","")) : 0;

                  return {
                    storeCode: storeCode || `CSV${idx + 1}`,
                    name: name || `CSV Store ${idx + 1}`,
                    sales: sales || "0.00",
                    budget: budget || "0.00",
                    startDate: startDate || "2024-01-01",
                    endDate: endDate || "2024-12-31",
                    days: days ? parseInt(days, 10) : 365,
                    address: address || "Unknown",
                    lat: parsedLat || 35.6895,
                    lng: parsedLng || 139.6917,
                    businessType: businessType || "Unknown",
                    block: block || "Unknown",
                    area: parsedArea ? `${parsedArea}㎡` : "0㎡",
                    isActive: isActive || "無効",
                    posCode: posCode || "Unknown",
                    market: market || "Unknown",
                    marketId: marketId || `M${idx + 1}`,
                  };
                })
              );
              setStores(parsedStores);
              setFilteredStores(parsedStores);
              setSelectedStores(new Set(parsedStores.map(store => store.storeCode))); // 全選択にリセット
              setOrder('asc');
              setOrderBy('');
              setPopulationData({}); // 人口データをリセット
              fetchAllPopulation(parsedStores); // 人口データを取得
              setPage(0);
            },
            error: (error) => {
              console.error("Error parsing CSV:", error);
            }
          });
        }
      };

      const handleDrop = async (event) => {
        event.preventDefault();
        setIsDragOver(false);
        const file = event.dataTransfer.files[0];
        if (file) {
          await handleCSVUpload(file);
        }
      };

      const handleDragOver = (event) => {
        event.preventDefault();
        setIsDragOver(true);
      };

      const handleDragLeave = (event) => {
        event.preventDefault();
        setIsDragOver(false);
      };

      const handleDownloadTemplate = () => {
        const csvContent = `店舗コード,店舗名,売上,予算,開始日,終了日,日数,住所,緯度,経度,事業区分,ブロック,面積,有効無効,POSコード,市場,市場ID
901,久我山,,,,,,東京都杉並区久我山３－２５－１,,,1,6,822,0,103,ｾﾞﾝﾉｳ,3
902,深沢不動前,,,,,,東京都世田谷区深沢４－３３－６,,,1,9,526,0,114,ｷﾝﾀｹ,6
903,東府中,,,,,,東京都府中市清水ケ丘１－３－８,,,1,7,827,0,117,ｾﾞﾝﾉｳ,3
904,笹塚,,,,,,東京都渋谷区笹塚２－１２－１１,,,1,8,593,0,118,ｷﾝﾀｹ,6
905,上北沢,,,,,,東京都世田谷区上北沢４－１４－１２,,,1,6,"1,040",0,121,ｾﾞﾝﾉｳ,3
908,和泉,,,,,,東京都杉並区和泉４－５０－１１,,,1,8,724,0,124,ｱﾀﾞﾁ,2
909,新宿,,,,,,東京都新宿区新宿１－１－１,,,1,10,900,1,125,ｳｲﾝ,4
910,池袋,,,,,,東京都豊島区池袋２－２－２,,,1,11,1100,1,126,ｳｲﾝ,4
911,渋谷,,,,,,東京都渋谷区渋谷３－３－３,,,1,12,1200,1,127,ｳｲﾝ,4
912,原宿,,,,,,東京都渋谷区原宿４－４－４,,,1,13,1300,1,128,ｳｲﾝ,4
`;
        const blob = new Blob([csvContent], { type: "text/csv" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "template.csv";
        a.click();
        URL.revokeObjectURL(url);
      };

      const toggleExpand = (type) => {
        if (type === "csv") setExpandedCSV(!expandedCSV);
        if (type === "map") setExpandedMap(!expandedMap);
        if (type === "table") setExpandedTable(!expandedTable);
      };

      const handleCircleModeChange = (event) => {
        const { name, checked } = event.target;
        setCircleModes((prev) => ({
          ...prev,
          [name]: checked,
        }));
      };

      // Trade Settings のハンドラー
      const handleTradeSettingChange = (level, key) => (event) => {
        const value = event.target.value;
        setTradeSettings((prev) => ({
          ...prev,
          [level]: {
            ...prev[level],
            [key]: key === 'radius' ? parseFloat(value) || prev[level][key] : value,
          },
        }));
      };

      // Circle Settings のハンドラー
      const handleCircleSettingChange = (mode, key) => (event) => {
        const value = event.target.value;
        setCircleSettings((prev) => ({
          ...prev,
          [mode]: {
            ...prev[mode],
            [key]: key === 'scale' ? parseFloat(value) || prev[mode][key] : value,
          },
        }));
      };

      const columns = [
        { key: "storeCode", label: "店舗コード" },
        { key: "name", label: "店舗名" },
        { key: "sales", label: "売上" },
        { key: "budget", label: "予算" },
        { key: "startDate", label: "開始日" },
        { key: "endDate", label: "終了日" },
        { key: "days", label: "日数" },
        { key: "address", label: "住所" },
        { key: "lat", label: "緯度" },
        { key: "lng", label: "経度" },
        { key: "businessType", label: "事業区分" },
        { key: "block", label: "ブロック" },
        { key: "area", label: "面積" },
        { key: "isActive", label: "有効無効" },
        { key: "posCode", label: "POSコード" },
        { key: "market", label: "市場" },
        { key: "marketId", label: "市場ID" },
      ];

      // ファイル入力のref
      const fileInputRef = React.useRef(null);

      const handleDropZoneClick = () => {
        fileInputRef.current.click();
      };

      // テーブル行クリックハンドラー
      const handleRowClick = (store) => {
        const marker = markersRef.current[store.storeCode];
        if (marker) {
          mapRef.current.setView([store.lat, store.lng], mapRef.current.getZoom());
          marker.openPopup();
        }
      };

      // チェックボックスのハンドラー
      const handleSelectStore = (storeCode) => (event) => {
        const newSelected = new Set(selectedStores);
        if (event.target.checked) {
          newSelected.add(storeCode);
        } else {
          newSelected.delete(storeCode);
        }
        setSelectedStores(newSelected);
      };

      // ヘッダーの全選択チェックボックスのハンドラー
      const handleSelectAll = (event) => {
        if (event.target.checked) {
          const newSelected = new Set(filteredStores.map(store => store.storeCode));
          setSelectedStores(new Set([...selectedStores, ...newSelected]));
        } else {
          const updatedSelected = new Set(selectedStores);
          filteredStores.forEach(store => updatedSelected.delete(store.storeCode));
          setSelectedStores(updatedSelected);
        }
      };

      // ヘッダーの全選択チェックボックスの状態
      const isAllSelected = filteredStores.length > 0 && filteredStores.every(store => selectedStores.has(store.storeCode));
      const isIndeterminate = selectedStores.size > 0 && selectedStores.size < filteredStores.length;

      // 並び替えのハンドラー
      const handleRequestSort = (property) => (event) => {
        const isAsc = orderBy === property && order === 'asc';
        setOrder(isAsc ? 'desc' : 'asc');
        setOrderBy(property);
      };

      // 並び替え用の関数
      const descendingComparator = (a, b, orderBy) => {
        if (b[orderBy] < a[orderBy]) {
          return -1;
        }
        if (b[orderBy] > a[orderBy]) {
          return 1;
        }
        return 0;
      };

      const getComparator = (order, orderBy) => {
        return order === 'desc'
          ? (a, b) => descendingComparator(a, b, orderBy)
          : (a, b) => -descendingComparator(a, b, orderBy);
      };

      const stableSort = (array, comparator) => {
        const stabilizedThis = array.map((el, index) => [el, index]);
        stabilizedThis.sort((a, b) => {
          const order = comparator(a[0], b[0]);
          if (order !== 0) return order;
          return a[1] - b[1];
        });
        return stabilizedThis.map((el) => el[0]);
      };

      // e-Stat APIを使用して人口データを取得する関数
      const fetchPopulation = async (storeCode, lat, lng) => {
        try {
          // ここでは、簡略化のために行政区域コードを取得するAPIを使用する仮定とします
          // 実際のAPI仕様に基づいて適宜調整してください
          const response = await fetch(
            `https://api.e-stat.go.jp/rest/3.0/app/json/getStatsData?appId=${ESTAT_API_KEY}&statsDataId=000001234567&metaGetFlg=Y&cntGetFlg=N&explanationGetFlg=Y&annotationGetFlg=Y&replaceSpChar=1&lang=J`
          );
          const data = await response.json();
          // 取得したデータを解析して人口を抽出します（仮の実装）
          // 実際にはAPIのレスポンス形式に応じてデータ処理を行ってください
          const population = 10000; // 仮の人口データ
          return population;
        } catch (error) {
          console.error(`Error fetching population for store ${storeCode}:`, error);
          return 'Error';
        }
      };

      // すべての店舗の人口データを取得する関数
      const fetchAllPopulation = async (storeList) => {
        const newPopulationData = { ...populationData };
        await Promise.all(storeList.map(async (store) => {
          if (!newPopulationData[store.storeCode]) {
            newPopulationData[store.storeCode] = {};
          }
          // 各商圏レベルに対して人口を取得
          await Promise.all(Object.keys(tradeSettings).map(async (tradeLevel) => {
            const population = await fetchPopulation(store.storeCode, store.lat, store.lng);
            newPopulationData[store.storeCode][tradeLevel] = population;
          }));
        }));
        setPopulationData(newPopulationData);
      };

      React.useEffect(() => {
        // 初期店舗データに対して人口データを取得
        fetchAllPopulation(initialStores);
      }, []);

      // フィルター適用後に人口データを取得
      React.useEffect(() => {
        fetchAllPopulation(filteredStores);
      }, [filteredStores]);

      return (
        <Box id="root" sx={{ display: "flex", flexDirection: "column", height: "100vh" }}>
          <CssBaseline />
          <AppBar position="static">
            <Toolbar>
              <Typography variant="h6" component="div">
                Store Locator
              </Typography>
            </Toolbar>
          </AppBar>

          {/* 地図エリア */}
          <Box sx={{ flexGrow: 1, padding: 2 }}>
            <Collapse in={expandedMap}>
              <Box id="map" sx={{ height: "70vh", marginTop: 1 }} />
            </Collapse>
            <Button onClick={() => toggleExpand("map")} variant="text">
              {expandedMap ? "Hide Map" : "Show Map"}
            </Button>
          </Box>

          {/* CSVアップロードエリア */}
          <Box sx={{ padding: 1 }}>
            <Button onClick={() => toggleExpand("csv")} variant="text">
              {expandedCSV ? "Hide CSV Upload" : "Show CSV Upload"}
            </Button>
            <Collapse in={expandedCSV}>
              <Box
                className={`drop-zone ${isDragOver ? 'dragover' : ''}`}
                onDrop={handleDrop}
                onDragOver={handleDragOver}
                onDragLeave={handleDragLeave}
                onClick={handleDropZoneClick}
              >
                <input
                  type="file"
                  accept=".csv"
                  ref={fileInputRef}
                  onChange={(e) => handleCSVUpload(e.target.files[0])}
                  style={{ display: "none" }}
                />
                Drag and drop a CSV file here or click to select a file
              </Box>
              <Box sx={{ display: "flex", gap: 2, alignItems: "center", marginTop: 2 }}>
                <Button
                  variant="contained"
                  color="primary"
                  onClick={handleDownloadTemplate}
                >
                  Download Template
                </Button>
              </Box>
            </Collapse>
          </Box>

          {/* 全体フィルター */}
          <Box sx={{ padding: 1, display: "flex", gap: 1, alignItems: "center" }}>
            <TextField
              label="Global Filter"
              variant="outlined"
              size="small"
              value={globalFilterText}
              onChange={handleFilterChange}
            />
            <Button variant="contained" color="primary" onClick={handleFilterApply}>
              Apply Filter
            </Button>
            <Button variant="outlined" color="secondary" onClick={handleFilterClear}>
              Clear Filter
            </Button>
          </Box>

          {/* サークル表示オプション（複数選択可能） */}
          <Box sx={{ padding: 1, display: "flex", gap: 2, alignItems: "center", flexWrap: 'wrap' }}>
            <FormControl component="fieldset">
              <FormLabel component="legend">Circle Mode</FormLabel>
              <FormGroup row>
                <FormControlLabel
                  control={
                    <Checkbox
                      checked={circleModes.trade1}
                      onChange={handleCircleModeChange}
                      name="trade1"
                    />
                  }
                  label="1次商圏"
                />
                <FormControlLabel
                  control={
                    <Checkbox
                      checked={circleModes.trade2}
                      onChange={handleCircleModeChange}
                      name="trade2"
                    />
                  }
                  label="2次商圏"
                />
                <FormControlLabel
                  control={
                    <Checkbox
                      checked={circleModes.trade3}
                      onChange={handleCircleModeChange}
                      name="trade3"
                    />
                  }
                  label="3次商圏"
                />
                <FormControlLabel
                  control={
                    <Checkbox
                      checked={circleModes.sales}
                      onChange={handleCircleModeChange}
                      name="sales"
                    />
                  }
                  label="売上"
                />
                <FormControlLabel
                  control={
                    <Checkbox
                      checked={circleModes.budget}
                      onChange={handleCircleModeChange}
                      name="budget"
                    />
                  }
                  label="予算"
                />
                <FormControlLabel
                  control={
                    <Checkbox
                      checked={circleModes.area}
                      onChange={handleCircleModeChange}
                      name="area"
                    />
                  }
                  label="面積"
                />
              </FormGroup>
            </FormControl>
            {/* Circle Settings */}
            <Box sx={{ display: "flex", gap: 4, flexWrap: 'wrap' }}>
              {/* 1次商圏設定 */}
              {circleModes.trade1 && (
                <Box sx={{ display: "flex", flexDirection: "column", gap: 1 }}>
                  <MuiTypography variant="subtitle1">1次商圏設定</MuiTypography>
                  <TextField
                    label="半径(m)"
                    type="number"
                    variant="outlined"
                    size="small"
                    value={tradeSettings.trade1.radius}
                    onChange={handleTradeSettingChange('trade1', 'radius')}
                    inputProps={{ min: "0", step: "100" }}
                  />
                  <input
                    type="color"
                    value={tradeSettings.trade1.color}
                    onChange={handleTradeSettingChange('trade1', 'color')}
                    style={{ width: '40px', height: '40px', border: 'none', padding: '0' }}
                  />
                </Box>
              )}
              {/* 2次商圏設定 */}
              {circleModes.trade2 && (
                <Box sx={{ display: "flex", flexDirection: "column", gap: 1 }}>
                  <MuiTypography variant="subtitle1">2次商圏設定</MuiTypography>
                  <TextField
                    label="半径(m)"
                    type="number"
                    variant="outlined"
                    size="small"
                    value={tradeSettings.trade2.radius}
                    onChange={handleTradeSettingChange('trade2', 'radius')}
                    inputProps={{ min: "0", step: "100" }}
                  />
                  <input
                    type="color"
                    value={tradeSettings.trade2.color}
                    onChange={handleTradeSettingChange('trade2', 'color')}
                    style={{ width: '40px', height: '40px', border: 'none', padding: '0' }}
                  />
                </Box>
              )}
              {/* 3次商圏設定 */}
              {circleModes.trade3 && (
                <Box sx={{ display: "flex", flexDirection: "column", gap: 1 }}>
                  <MuiTypography variant="subtitle1">3次商圏設定</MuiTypography>
                  <TextField
                    label="半径(m)"
                    type="number"
                    variant="outlined"
                    size="small"
                    value={tradeSettings.trade3.radius}
                    onChange={handleTradeSettingChange('trade3', 'radius')}
                    inputProps={{ min: "0", step: "100" }}
                  />
                  <input
                    type="color"
                    value={tradeSettings.trade3.color}
                    onChange={handleTradeSettingChange('trade3', 'color')}
                    style={{ width: '40px', height: '40px', border: 'none', padding: '0' }}
                  />
                </Box>
              )}
              {/* 売上設定 */}
              {circleModes.sales && (
                <Box sx={{ display: "flex", flexDirection: "column", gap: 1 }}>
                  <MuiTypography variant="subtitle1">売上設定</MuiTypography>
                  <TextField
                    label="スケール"
                    type="number"
                    variant="outlined"
                    size="small"
                    value={circleSettings.sales.scale}
                    onChange={handleCircleSettingChange('sales', 'scale')}
                    inputProps={{ min: "0", step: "0.01" }}
                  />
                  <input
                    type="color"
                    value={circleSettings.sales.color}
                    onChange={handleCircleSettingChange('sales', 'color')}
                    style={{ width: '40px', height: '40px', border: 'none', padding: '0' }}
                  />
                </Box>
              )}
              {/* 予算設定 */}
              {circleModes.budget && (
                <Box sx={{ display: "flex", flexDirection: "column", gap: 1 }}>
                  <MuiTypography variant="subtitle1">予算設定</MuiTypography>
                  <TextField
                    label="スケール"
                    type="number"
                    variant="outlined"
                    size="small"
                    value={circleSettings.budget.scale}
                    onChange={handleCircleSettingChange('budget', 'scale')}
                    inputProps={{ min: "0", step: "0.01" }}
                  />
                  <input
                    type="color"
                    value={circleSettings.budget.color}
                    onChange={handleCircleSettingChange('budget', 'color')}
                    style={{ width: '40px', height: '40px', border: 'none', padding: '0' }}
                  />
                </Box>
              )}
              {/* 面積設定 */}
              {circleModes.area && (
                <Box sx={{ display: "flex", flexDirection: "column", gap: 1 }}>
                  <MuiTypography variant="subtitle1">面積設定</MuiTypography>
                  <TextField
                    label="スケール"
                    type="number"
                    variant="outlined"
                    size="small"
                    value={circleSettings.area.scale}
                    onChange={handleCircleSettingChange('area', 'scale')}
                    inputProps={{ min: "0", step: "0.1" }}
                  />
                  <input
                    type="color"
                    value={circleSettings.area.color}
                    onChange={handleCircleSettingChange('area', 'color')}
                    style={{ width: '40px', height: '40px', border: 'none', padding: '0' }}
                  />
                </Box>
              )}
            </Box>
          </Box>

          {/* テーブルエリア */}
          <Box sx={{ padding: 2 }}>
            <Button onClick={() => toggleExpand("table")} variant="text">
              {expandedTable ? "Hide Table" : "Show Table"}
            </Button>
            <Collapse in={expandedTable}>
              <TableContainer component={Paper} sx={{ marginTop: 1, overflow: 'auto' }}>
                <Table size="small">
                  <TableHead>
                    <TableRow>
                      {/* 全選択チェックボックス */}
                      <TableCell padding="checkbox">
                        <Checkbox
                          indeterminate={isIndeterminate}
                          checked={isAllSelected}
                          onChange={handleSelectAll}
                          inputProps={{ 'aria-label': 'select all stores' }}
                        />
                      </TableCell>
                      {columns.map((col) => (
                        <TableCell key={col.key}>
                          <TableSortLabel
                            active={orderBy === col.key}
                            direction={orderBy === col.key ? order : 'asc'}
                            onClick={handleRequestSort(col.key)}
                          >
                            {col.label}
                            {orderBy === col.key ? (
                              <Box component="span" sx={{ visuallyHidden: true }}>
                                {order === 'desc' ? 'sorted descending' : 'sorted ascending'}
                              </Box>
                            ) : null}
                          </TableSortLabel>
                        </TableCell>
                      ))}
                    </TableRow>
                    <TableRow>
                      {/* 空のセル（チェックボックス列） */}
                      <TableCell />
                      {columns.map((col) => (
                        <TableCell key={col.key}>
                          {/* フィルターモード選択をテキストボックスの上に配置 */}
                          <Box sx={{ display: "flex", flexDirection: "column" }}>
                            <FormControl variant="standard" size="small" sx={{ minWidth: 80 }}>
                              <InputLabel id={`filter-mode-label-${col.key}`}>Mode</InputLabel>
                              <Select
                                labelId={`filter-mode-label-${col.key}`}
                                id={`filter-mode-select-${col.key}`}
                                value={filterModes[col.key]}
                                onChange={handleFilterModeChange(col.key)}
                                label="Mode"
                              >
                                <MenuItem value="partial">Partial</MenuItem>
                                <MenuItem value="exact">Exact</MenuItem>
                              </Select>
                            </FormControl>
                            <TextField
                              variant="outlined"
                              size="small"
                              value={columnFilters[col.key]}
                              onChange={handleColumnFilterChange(col.key)}
                              placeholder={`Filter ${col.label}`}
                              sx={{ mt: 1 }}
                            />
                          </Box>
                        </TableCell>
                      ))}
                    </TableRow>
                  </TableHead>
                  <TableBody>
                    {stableSort(filteredStores, getComparator(order, orderBy))
                      .slice(
                        rowsPerPage === -1 ? 0 : page * rowsPerPage,
                        rowsPerPage === -1 ? filteredStores.length : page * rowsPerPage + rowsPerPage
                      )
                      .map((store) => (
                        <TableRow key={store.storeCode} hover style={{ cursor: 'pointer' }}>
                          <TableCell padding="checkbox">
                            <Checkbox
                              checked={selectedStores.has(store.storeCode)}
                              onChange={handleSelectStore(store.storeCode)}
                              inputProps={{ 'aria-labelledby': `checkbox-${store.storeCode}` }}
                            />
                          </TableCell>
                          {columns.map((col) => (
                            <TableCell key={col.key} onClick={() => handleRowClick(store)}>
                              {store[col.key]}
                            </TableCell>
                          ))}
                        </TableRow>
                      ))}
                  </TableBody>
                </Table>
                <TablePagination
                  component="div"
                  count={filteredStores.length}
                  rowsPerPage={rowsPerPage}
                  page={page}
                  onPageChange={(event, newPage) => setPage(newPage)}
                  onRowsPerPageChange={(event) => {
                    const value = parseInt(event.target.value, 10);
                    setRowsPerPage(value === -1 ? filteredStores.length : value);
                    setPage(0);
                  }}
                  rowsPerPageOptions={[
                    { label: '10', value: 10 },
                    { label: '20', value: 20 },
                    { label: '30', value: 30 },
                    { label: '全て', value: -1 },
                  ]}
                />
              </TableContainer>
            </Collapse>
          </Box>

          {/* 詳細ダイアログ */}
          <Dialog
            open={openDetailDialog}
            onClose={() => setOpenDetailDialog(false)}
          >
            <DialogTitle>店舗詳細</DialogTitle>
            <DialogContent>
              {selectedStore && (
                <>
                  <DialogContentText><strong>店舗コード:</strong> {selectedStore.storeCode}</DialogContentText>
                  <DialogContentText><strong>店舗名:</strong> {selectedStore.name}</DialogContentText>
                  <DialogContentText><strong>住所:</strong> {selectedStore.address}</DialogContentText>
                  {/* 追加の詳細情報があればここに追加 */}
                </>
              )}
            </DialogContent>
            <DialogActions>
              <Button onClick={() => setOpenDetailDialog(false)} color="primary">
                Close
              </Button>
            </DialogActions>
          </Dialog>

          <footer>&copy; 2024 Store Locator Inc. All Rights Reserved.</footer>
        </Box>
        );
      }

        ReactDOM.createRoot(document.getElementById("root")).render(<App />);

      </script>
</body>
</html>
