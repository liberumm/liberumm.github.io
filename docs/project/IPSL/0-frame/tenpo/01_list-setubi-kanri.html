<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>設備管理システム</title>
  <!-- React and ReactDOM -->
  <script src="https://cdn.jsdelivr.net/npm/react@18/umd/react.production.min.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18/umd/react-dom.production.min.js" crossorigin="anonymous"></script>
  <!-- MUI (Material-UI) v5 -->
  <script src="https://cdn.jsdelivr.net/npm/@mui/material@5.11.15/umd/material-ui.production.min.js" crossorigin="anonymous"></script>
  <!-- Babel for JSX -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.21.0/babel.min.js" crossorigin="anonymous"></script>
  <!-- Emotion ライブラリ -->
  <script src="https://cdn.jsdelivr.net/npm/@emotion/react@11.11.0/dist/emotion-react.umd.min.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@emotion/styled@11.11.0/dist/emotion-styled.umd.min.js" crossorigin="anonymous"></script>
  <!-- Papaparse for CSV parsing -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js" crossorigin="anonymous"></script>
  <!-- SheetJS for Excel handling -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js" crossorigin="anonymous"></script>
  <!-- Material-UIのスタイルシート -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons" />
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: 'Roboto', sans-serif;
    }
    #root {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }
    .content {
      flex: 1;
      padding: 20px;
      background-color: #f5f5f5;
    }
    .footer {
      padding: 10px;
      text-align: center;
      background-color: #1976d2;
      color: white;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const {
      AppBar, Toolbar, Typography, Table, TableBody, TableCell, TableContainer,
      TableHead, TableRow, Paper, TextField, Select, MenuItem: MenuItemMUI,
      InputLabel, FormControl, Button, IconButton, Dialog, DialogActions, DialogContent,
      DialogTitle, Switch, FormControlLabel, Snackbar, Alert,
      Box, Grid, Checkbox, TablePagination, Menu, Tooltip
    } = MaterialUI;

    const { useState } = React;

    // 初期データの定義（管理者情報を追加）
    const initialRows = [
      {
        no: 1,
        equipmentId: "EQ-001",
        equipmentName: "電気メーター",
        equipmentCategory: "計測機器",
        modelNumber: "EM-100",
        purchaseDate: "2023-01-15",
        location: "東京営業所",
        installationPlace: "第1営業所",
        manager: "山田 太郎", // 管理者情報
        status: "良好",
        nextMaintenanceDate: "2024-01-15",
        lastMaintenanceDate: "2023-01-15",
        maintenanceInterval: "12",
        usefulLife: "60",
        scheduledUpdateDate: "2028-01-15",
        notes: "定期メンテナンス済",
        active: true,
      },
      {
        no: 2,
        equipmentId: "EQ-002",
        equipmentName: "水道メーター",
        equipmentCategory: "計測機器",
        modelNumber: "WM-200",
        purchaseDate: "2022-06-20",
        location: "大阪営業所",
        installationPlace: "第2営業所",
        manager: "佐藤 花子", // 管理者情報
        status: "使用中",
        nextMaintenanceDate: "2023-06-20",
        lastMaintenanceDate: "2022-06-20",
        maintenanceInterval: "12",
        usefulLife: "48",
        scheduledUpdateDate: "2026-06-20",
        notes: "OSアップデート必要",
        active: true,
      },
      {
        no: 3,
        equipmentId: "EQ-003",
        equipmentName: "冷蔵庫",
        equipmentCategory: "家電",
        modelNumber: "FR-300",
        purchaseDate: "2021-03-10",
        location: "名古屋営業所",
        installationPlace: "第3営業所",
        manager: "鈴木 一郎", // 管理者情報
        status: "良好",
        nextMaintenanceDate: "2023-03-10",
        lastMaintenanceDate: "2022-03-10",
        maintenanceInterval: "12",
        usefulLife: "60",
        scheduledUpdateDate: "2026-03-10",
        notes: "内部清掃必要",
        active: true,
      },
      {
        no: 4,
        equipmentId: "EQ-004",
        equipmentName: "エレベーター",
        equipmentCategory: "輸送機器",
        modelNumber: "EL-400",
        purchaseDate: "2020-11-05",
        location: "福岡営業所",
        installationPlace: "第4営業所",
        manager: "田中 次郎", // 管理者情報
        status: "稼働中",
        nextMaintenanceDate: "2023-11-05",
        lastMaintenanceDate: "2022-11-05",
        maintenanceInterval: "12",
        usefulLife: "120",
        scheduledUpdateDate: "2030-11-05",
        notes: "定期点検済",
        active: true,
      },
      {
        no: 5,
        equipmentId: "EQ-005",
        equipmentName: "パソコン",
        equipmentCategory: "コンピュータ",
        modelNumber: "Dell XPS 13",
        purchaseDate: "2022-06-20",
        location: "大阪営業所",
        installationPlace: "第2営業所",
        manager: "中村 美咲", // 管理者情報
        status: "使用中",
        nextMaintenanceDate: "2023-06-20",
        lastMaintenanceDate: "2022-06-20",
        maintenanceInterval: "12",
        usefulLife: "48",
        scheduledUpdateDate: "2026-06-20",
        notes: "OSアップデート必要",
        active: true,
      },
      // 必要に応じて他のデータも追加可能
    ];

    function App() {
      const [rows, setRows] = useState(initialRows);
      const [filterYear, setFilterYear] = useState("");
      const [filterMonth, setFilterMonth] = useState("");
      const [filterLocation, setFilterLocation] = useState("");
      const [filterCategory, setFilterCategory] = useState("");
      const [filterStatus, setFilterStatus] = useState("");
      const [searchTerm, setSearchTerm] = useState("");
      const [openDialog, setOpenDialog] = useState(false);
      const [newRow, setNewRow] = useState({
        equipmentId: "",
        equipmentName: "",
        equipmentCategory: "",
        modelNumber: "",
        purchaseDate: "",
        location: "",
        installationPlace: "",
        manager: "", // 管理者情報
        status: "",
        nextMaintenanceDate: "",
        lastMaintenanceDate: "",
        maintenanceInterval: "",
        usefulLife: "",
        scheduledUpdateDate: "",
        notes: "",
        active: true,
      });
      const [snackbar, setSnackbar] = useState({ open: false, message: "", severity: "success" });
      const [selectedRows, setSelectedRows] = useState([]);
      const [page, setPage] = useState(0);
      const [rowsPerPage, setRowsPerPage] = useState(10);
      const [rowsPerPageOption, setRowsPerPageOption] = useState('10'); // '10', '20', '30', '全て', '数値入力'
      const [customRowsPerPage, setCustomRowsPerPage] = useState('');
      const [anchorEl, setAnchorEl] = useState(null);
      const [menuRow, setMenuRow] = useState(null);

      // モーダル用のステート
      const [openSubMenuDialog, setOpenSubMenuDialog] = useState(false);
      const [subMenuAction, setSubMenuAction] = useState("");
      const [currentRow, setCurrentRow] = useState(null);

      // フィルタリング処理
      const filteredRows = rows.filter(row => {
        // 年度フィルター
        let matchesYear = true;
        if (filterYear) {
          const purchaseYear = new Date(row.purchaseDate).getFullYear();
          const maintenanceYear = row.nextMaintenanceDate ? new Date(row.nextMaintenanceDate).getFullYear() : null;
          matchesYear = purchaseYear.toString() === filterYear || (maintenanceYear && maintenanceYear.toString() === filterYear);
        }

        // 月度フィルター
        let matchesMonth = true;
        if (filterMonth) {
          const purchaseMonth = new Date(row.purchaseDate).getMonth() + 1; // 月は0始まり
          const maintenanceMonth = row.nextMaintenanceDate ? new Date(row.nextMaintenanceDate).getMonth() + 1 : null;
          matchesMonth = String(purchaseMonth).padStart(2, '0') === filterMonth ||
                         (maintenanceMonth && String(maintenanceMonth).padStart(2, '0') === filterMonth);
        }

        // その他のフィルター
        const matchesLocation = filterLocation === "" || row.location === filterLocation;
        const matchesCategory = filterCategory === "" || row.equipmentCategory === filterCategory;
        const matchesStatus = filterStatus === "" || row.status === filterStatus;

        // 検索フィルター（管理者情報を追加）
        const matchesSearch = searchTerm === "" || 
                              row.equipmentId.includes(searchTerm) ||
                              row.equipmentName.includes(searchTerm) ||
                              row.modelNumber.includes(searchTerm) ||
                              row.location.includes(searchTerm) ||
                              row.installationPlace.includes(searchTerm) ||
                              row.manager.includes(searchTerm);

        return matchesYear && matchesMonth && matchesLocation && matchesCategory && matchesStatus && matchesSearch;
      });

      // ページネーション処理
      const handleChangePage = (event, newPage) => {
        setPage(newPage);
      };

      const handleRowsPerPageOptionChange = (event) => {
        const value = event.target.value;
        setRowsPerPageOption(value);
        setPage(0);

        if (value === '全て') {
          setRowsPerPage(filteredRows.length);
          setCustomRowsPerPage('');
        } else if (value === '数値入力') {
          // 保持されているカスタム値があればそれを使用、なければデフォルトの10
          setRowsPerPage(customRowsPerPage ? parseInt(customRowsPerPage, 10) : 10);
        } else {
          setRowsPerPage(parseInt(value, 10));
          setCustomRowsPerPage('');
        }
      };

      const handleCustomRowsPerPageChange = (event) => {
        const value = event.target.value;
        setCustomRowsPerPage(value);
        const parsedValue = parseInt(value, 10);
        if (!isNaN(parsedValue) && parsedValue > 0) {
          setRowsPerPage(parsedValue);
        } else {
          setRowsPerPage(10); // デフォルト値
        }
        setPage(0);
      };

      // 全選択・全解除
      const handleSelectAllClick = (event) => {
        if (event.target.checked) {
          const newSelecteds = filteredRows.map((row) => row.no);
          setSelectedRows(newSelecteds);
          return;
        }
        setSelectedRows([]);
      };

      // 行の選択・解除
      const handleClick = (event, no) => {
        const selectedIndex = selectedRows.indexOf(no);
        let newSelected = [];

        if (selectedIndex === -1) {
          newSelected = newSelected.concat(selectedRows, no);
        } else if (selectedIndex === 0) {
          newSelected = newSelected.concat(selectedRows.slice(1));
        } else if (selectedIndex === selectedRows.length - 1) {
          newSelected = newSelected.concat(selectedRows.slice(0, -1));
        } else if (selectedIndex > 0) {
          newSelected = newSelected.concat(
            selectedRows.slice(0, selectedIndex),
            selectedRows.slice(selectedIndex + 1),
          );
        }

        setSelectedRows(newSelected);
      };

      const isSelected = (no) => selectedRows.indexOf(no) !== -1;

      // 新規登録ダイアログのハンドラー
      const handleOpenDialog = () => {
        setNewRow({
          equipmentId: "",
          equipmentName: "",
          equipmentCategory: "",
          modelNumber: "",
          purchaseDate: "",
          location: "",
          installationPlace: "",
          manager: "", // 管理者情報
          status: "",
          nextMaintenanceDate: "",
          lastMaintenanceDate: "",
          maintenanceInterval: "",
          usefulLife: "",
          scheduledUpdateDate: "",
          notes: "",
          active: true,
        });
        setOpenDialog(true);
      };

      const handleCloseDialog = () => {
        setOpenDialog(false);
      };

      const handleAddRow = () => {
        if (!newRow.equipmentId || !newRow.equipmentName) {
          setSnackbar({ open: true, message: "設備IDと設備名は必須です。", severity: "error" });
          return;
        }
        const newNo = rows.length > 0 ? Math.max(...rows.map(r => r.no)) + 1 : 1;
        setRows([...rows, { ...newRow, no: newNo }]);
        setOpenDialog(false);
        setSnackbar({ open: true, message: "新規設備を追加しました。", severity: "success" });
      };

      // 削除ハンドラー
      const handleDelete = (no) => {
        if (window.confirm("本当にこの設備を削除しますか？")) {
          setRows(rows.filter(row => row.no !== no));
          setSnackbar({ open: true, message: "設備を削除しました。", severity: "info" });
        }
      };

      // 有効・無効切り替えハンドラー
      const handleToggleActive = (no) => {
        setRows(rows.map(row => row.no === no ? { ...row, active: !row.active } : row));
        setSnackbar({ open: true, message: "設備の状態を更新しました。", severity: "success" });
      };

      // インポートハンドラー（管理者情報を追加）
      const handleImport = (e) => {
        const file = e.target.files[0];
        if (file) {
          Papa.parse(file, {
            header: true,
            skipEmptyLines: true,
            complete: function(results) {
              const importedData = results.data.map((row, index) => ({
                no: rows.length + index + 1,
                equipmentId: row['設備ID'] || "",
                equipmentName: row['設備名'] || "",
                equipmentCategory: row['設備カテゴリー'] || "",
                modelNumber: row['型番'] || "",
                purchaseDate: row['購入日'] || "",
                location: row['拠点'] || "",
                installationPlace: row['設置場所'] || "",
                manager: row['管理者'] || "", // 管理者情報
                status: row['状態'] || "",
                nextMaintenanceDate: row['メンテナンス予定日'] || "",
                lastMaintenanceDate: row['メンテナンス前回実施日'] || "",
                maintenanceInterval: row['メンテナンス周期（月）'] || "",
                usefulLife: row['耐用年数（月）'] || "",
                scheduledUpdateDate: row['更新予定日'] || "",
                notes: row['備考'] || "",
                active: row['有効'] === 'true' || false,
              }));
              setRows([...rows, ...importedData]);
              setSnackbar({ open: true, message: "データをインポートしました。", severity: "success" });
            },
            error: function(error) {
              console.error("インポートエラー:", error);
              setSnackbar({ open: true, message: "インポートに失敗しました。", severity: "error" });
            }
          });
        }
      };

      // エクスポートハンドラー（管理者情報を追加）
      const handleExport = () => {
        const dataToExport = filteredRows.map(row => ({
          'No.': row.no,
          '設備ID': row.equipmentId,
          '設備カテゴリー': row.equipmentCategory,
          '設備名': row.equipmentName,
          '型番': row.modelNumber,
          '購入日': row.purchaseDate,
          '拠点': row.location,
          '設置場所': row.installationPlace,
          '管理者': row.manager, // 管理者情報
          '状態': row.status,
          'メンテナンス予定日': row.nextMaintenanceDate,
          'メンテナンス前回実施日': row.lastMaintenanceDate,
          'メンテナンス周期（月）': row.maintenanceInterval,
          '耐用年数（月）': row.usefulLife,
          '更新予定日': row.scheduledUpdateDate,
          '備考': row.notes,
          '有効': row.active,
        }));
        const worksheet = XLSX.utils.json_to_sheet(dataToExport);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, "設備データ");
        XLSX.writeFile(workbook, "equipment_data.xlsx");
      };

      // テンプレートダウンロードハンドラーの追加（管理者情報を追加）
      const handleDownloadTemplate = () => {
        const templateHeaders = [
          '設備ID',
          '設備名',
          '設備カテゴリー',
          '型番',
          '購入日',
          '拠点',
          '設置場所',
          '管理者', // 管理者情報
          '状態',
          'メンテナンス予定日',
          'メンテナンス前回実施日',
          'メンテナンス周期（月）',
          '耐用年数（月）',
          '更新予定日',
          '備考',
          '有効',
        ];

        const templateData = [
          templateHeaders,
          // 以下に例として1行目のデータを追加できます（必要に応じてコメントアウトを外してください）
          // ['EQ-006', 'エアコン', '家電', 'AC-500', '2023-07-20', '札幌営業所', '第5営業所', '高橋 三郎', '良好', '2024-07-20', '2023-07-20', '12', '60', '2029-07-20', '定期点検済', 'true']
        ];

        // CSV文字列を生成
        const csvContent = templateData.map(e => e.join(",")).join("\n");

        // Blobを作成してダウンロード
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.href = url;
        link.setAttribute("download", "import_template.csv");
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      };

      const handleCloseSnackbar = () => {
        setSnackbar({ ...snackbar, open: false });
      };

      // 操作メニューのハンドラー
      const handleMenuClick = (event, row) => {
        setAnchorEl(event.currentTarget);
        setMenuRow(row);
      };

      const handleMenuClose = () => {
        setAnchorEl(null);
        setMenuRow(null);
      };

      const handleMenuAction = (action) => {
        if (action === "詳細" || action === "記録" || action === "履歴") {
          setSubMenuAction(action);
          setCurrentRow(menuRow);
          setOpenSubMenuDialog(true);
        } else if (action === "削除") {
          handleDelete(menuRow.no);
        }
        handleMenuClose();
      };

      // ユニークな拠点とカテゴリーの取得
      const uniqueLocations = [...new Set(rows.map(row => row.location))];
      const uniqueCategories = [...new Set(rows.map(row => row.equipmentCategory))];
      const uniqueYears = [...new Set(rows.map(row => new Date(row.purchaseDate).getFullYear().toString()))];
      const uniqueMonths = [...new Set(rows.map(row => String(new Date(row.purchaseDate).getMonth() + 1).padStart(2, '0')))];

      // サブメニュー用モーダルの閉鎖
      const handleCloseSubMenuDialog = () => {
        setOpenSubMenuDialog(false);
        setSubMenuAction("");
        setCurrentRow(null);
      };

      return (
        <Box display="flex" flexDirection="column" minHeight="100vh">
          {/* ヘッダー */}
          <AppBar position="static">
            <Toolbar>
              <Typography variant="h6" component="div" sx={{ flexGrow: 1 }}>
                設備管理システム
              </Typography>
            </Toolbar>
          </AppBar>

          {/* メインコンテンツ */}
          <Box className="content">
            <Paper style={{ padding: 20, marginBottom: 20 }}>
              {/* フィルターエリアを独立したPaperで囲む */}
              <Paper style={{ padding: 20, marginBottom: 20 }}>
                <Grid container spacing={2} alignItems="center">
                  {/* 年度フィルター */}
                  <Grid item xs={12} sm={6} md={2}>
                    <FormControl variant="outlined" size="small" fullWidth>
                      <InputLabel>年度</InputLabel>
                      <Select
                        value={filterYear}
                        onChange={(e) => setFilterYear(e.target.value)}
                        label="年度"
                      >
                        <MenuItemMUI value=""><em>全て</em></MenuItemMUI>
                        {uniqueYears.map((year) => (
                          <MenuItemMUI key={year} value={year}>
                            {year}年
                          </MenuItemMUI>
                        ))}
                      </Select>
                    </FormControl>
                  </Grid>

                  {/* 月度フィルター */}
                  <Grid item xs={12} sm={6} md={2}>
                    <FormControl variant="outlined" size="small" fullWidth>
                      <InputLabel>月度</InputLabel>
                      <Select
                        value={filterMonth}
                        onChange={(e) => setFilterMonth(e.target.value)}
                        label="月度"
                      >
                        <MenuItemMUI value=""><em>全て</em></MenuItemMUI>
                        {uniqueMonths.map((month) => (
                          <MenuItemMUI key={month} value={month}>
                            {month}月
                          </MenuItemMUI>
                        ))}
                      </Select>
                    </FormControl>
                  </Grid>

                  {/* 拠点フィルター */}
                  <Grid item xs={12} sm={6} md={2}>
                    <FormControl variant="outlined" size="small" fullWidth>
                      <InputLabel>拠点フィルター</InputLabel>
                      <Select
                        value={filterLocation}
                        onChange={(e) => setFilterLocation(e.target.value)}
                        label="拠点フィルター"
                      >
                        <MenuItemMUI value=""><em>全て</em></MenuItemMUI>
                        {uniqueLocations.map((location) => (
                          <MenuItemMUI key={location} value={location}>{location}</MenuItemMUI>
                        ))}
                      </Select>
                    </FormControl>
                  </Grid>

                  {/* 設備カテゴリー */}
                  <Grid item xs={12} sm={6} md={2}>
                    <FormControl variant="outlined" size="small" fullWidth>
                      <InputLabel>設備カテゴリー</InputLabel>
                      <Select
                        value={filterCategory}
                        onChange={(e) => setFilterCategory(e.target.value)}
                        label="設備カテゴリー"
                      >
                        <MenuItemMUI value=""><em>全て</em></MenuItemMUI>
                        {uniqueCategories.map((category) => (
                          <MenuItemMUI key={category} value={category}>{category}</MenuItemMUI>
                        ))}
                      </Select>
                    </FormControl>
                  </Grid>

                  {/* 状態フィルター */}
                  <Grid item xs={12} sm={6} md={2}>
                    <FormControl variant="outlined" size="small" fullWidth>
                      <InputLabel>状態フィルター</InputLabel>
                      <Select
                        value={filterStatus}
                        onChange={(e) => setFilterStatus(e.target.value)}
                        label="状態フィルター"
                      >
                        <MenuItemMUI value=""><em>全て</em></MenuItemMUI>
                        <MenuItemMUI value="良好">良好</MenuItemMUI>
                        <MenuItemMUI value="使用中">使用中</MenuItemMUI>
                        <MenuItemMUI value="故障中">故障中</MenuItemMUI>
                        <MenuItemMUI value="稼働中">稼働中</MenuItemMUI>
                      </Select>
                    </FormControl>
                  </Grid>

                  {/* 検索 */}
                  <Grid item xs={12} sm={12} md={2}>
                    <TextField
                      label="検索"
                      variant="outlined"
                      size="small"
                      fullWidth
                      value={searchTerm}
                      onChange={(e) => setSearchTerm(e.target.value)}
                    />
                  </Grid>

                  {/* フィルターリセットボタン */}
                  <Grid item xs={12} sm={12} md={2}>
                    <Button
                      variant="outlined"
                      color="secondary"
                      fullWidth
                      onClick={() => {
                        setFilterYear("");
                        setFilterMonth("");
                        setFilterLocation("");
                        setFilterCategory("");
                        setFilterStatus("");
                        setSearchTerm("");
                      }}
                    >
                      リセット
                    </Button>
                  </Grid>
                </Grid>
              </Paper>

              {/* 設備管理テーブルと機能ボタン */}
              <Grid container spacing={2} alignItems="center" style={{ marginBottom: 20 }}>
                <Grid item xs={12} md={6}>
                  <Toolbar>
                    <Typography variant="h6" component="div" style={{ flexGrow: 1 }}>
                      設備管理テーブル
                    </Typography>
                  </Toolbar>
                </Grid>
                <Grid item xs={12} md={6} style={{ textAlign: 'right' }}>
                  <Button variant="contained" color="primary" onClick={handleOpenDialog} style={{ marginRight: 10 }}>
                    新規登録
                  </Button>
                  <Button variant="contained" color="success" onClick={handleExport} style={{ marginRight: 10 }}>
                    エクスポート
                  </Button>
                  {/* テンプレートダウンロードボタンの追加 */}
                  <Button variant="contained" color="warning" onClick={handleDownloadTemplate} style={{ marginRight: 10 }}>
                    テンプレートダウンロード
                  </Button>
                  <input
                    accept=".csv, .xlsx, .xls"
                    style={{ display: 'none' }}
                    id="import-file-main"
                    type="file"
                    onChange={handleImport}
                  />
                  <label htmlFor="import-file-main">
                    <Button variant="contained" color="secondary" component="span">
                      インポート
                    </Button>
                  </label>
                </Grid>
              </Grid>

              {/* テーブル */}
              <TableContainer component={Paper}>
                <Table size="small">
                  <TableHead>
                    <TableRow>
                      <TableCell padding="checkbox">
                        <Checkbox
                          indeterminate={selectedRows.length > 0 && selectedRows.length < filteredRows.length}
                          checked={filteredRows.length > 0 && selectedRows.length === filteredRows.length}
                          onChange={handleSelectAllClick}
                          color="primary"
                        />
                      </TableCell>
                      <TableCell>No.</TableCell>
                      <TableCell>設備ID</TableCell>
                      <TableCell>設備カテゴリー</TableCell>
                      <TableCell>設備名</TableCell>
                      <TableCell>型番</TableCell>
                      <TableCell>購入日</TableCell>
                      <TableCell>拠点</TableCell>
                      <TableCell>設置場所</TableCell>
                      <TableCell>管理者</TableCell> {/* 新しく追加した列 */}
                      <TableCell>状態</TableCell>
                      <TableCell>メンテナンス予定日</TableCell>
                      <TableCell>メンテナンス前回実施日</TableCell>
                      <TableCell>メンテナンス周期（月）</TableCell>
                      <TableCell>耐用年数（月）</TableCell>
                      <TableCell>更新予定日</TableCell>
                      <TableCell>備考</TableCell>
                      <TableCell>有効</TableCell>
                      <TableCell>操作</TableCell>
                    </TableRow>
                  </TableHead>
                  <TableBody>
                    {(rowsPerPage > 0
                      ? filteredRows.slice(page * rowsPerPage, page * rowsPerPage + rowsPerPage)
                      : filteredRows
                    ).map((row) => {
                      const isItemSelected = isSelected(row.no);
                      return (
                        <TableRow key={row.no} selected={isItemSelected}>
                          <TableCell padding="checkbox">
                            <Checkbox
                              checked={isItemSelected}
                              onChange={(event) => handleClick(event, row.no)}
                              color="primary"
                            />
                          </TableCell>
                          <TableCell>
                            <Tooltip title={row.no.toString()} arrow>
                              <Typography noWrap>
                                {row.no}
                              </Typography>
                            </Tooltip>
                          </TableCell>
                          <TableCell>
                            <Tooltip title={row.equipmentId} arrow>
                              <Typography noWrap>
                                {row.equipmentId}
                              </Typography>
                            </Tooltip>
                          </TableCell>
                          <TableCell>
                            <Tooltip title={row.equipmentCategory} arrow>
                              <Typography noWrap>
                                {row.equipmentCategory}
                              </Typography>
                            </Tooltip>
                          </TableCell>
                          <TableCell>
                            <Tooltip title={row.equipmentName} arrow>
                              <Typography noWrap>
                                {row.equipmentName}
                              </Typography>
                            </Tooltip>
                          </TableCell>
                          <TableCell>
                            <Tooltip title={row.modelNumber} arrow>
                              <Typography noWrap>
                                {row.modelNumber}
                              </Typography>
                            </Tooltip>
                          </TableCell>
                          <TableCell>
                            <Tooltip title={row.purchaseDate} arrow>
                              <Typography noWrap>
                                {row.purchaseDate}
                              </Typography>
                            </Tooltip>
                          </TableCell>
                          <TableCell>
                            <Tooltip title={row.location} arrow>
                              <Typography noWrap>
                                {row.location}
                              </Typography>
                            </Tooltip>
                          </TableCell>
                          <TableCell>
                            <Tooltip title={row.installationPlace} arrow>
                              <Typography noWrap>
                                {row.installationPlace}
                              </Typography>
                            </Tooltip>
                          </TableCell>
                          <TableCell>
                            <Tooltip title={row.manager} arrow>
                              <Typography noWrap>
                                {row.manager}
                              </Typography>
                            </Tooltip>
                          </TableCell>
                          <TableCell>
                            <Tooltip title={row.status} arrow>
                              <Typography noWrap>
                                {row.status}
                              </Typography>
                            </Tooltip>
                          </TableCell>
                          <TableCell>
                            <Tooltip title={row.nextMaintenanceDate || "未設定"} arrow>
                              <Typography noWrap>
                                {row.nextMaintenanceDate || "未設定"}
                              </Typography>
                            </Tooltip>
                          </TableCell>
                          <TableCell>
                            <Tooltip title={row.lastMaintenanceDate || "未設定"} arrow>
                              <Typography noWrap>
                                {row.lastMaintenanceDate || "未設定"}
                              </Typography>
                            </Tooltip>
                          </TableCell>
                          <TableCell>
                            <Tooltip title={row.maintenanceInterval || "未設定"} arrow>
                              <Typography noWrap>
                                {row.maintenanceInterval || "未設定"}
                              </Typography>
                            </Tooltip>
                          </TableCell>
                          <TableCell>
                            <Tooltip title={row.usefulLife || "未設定"} arrow>
                              <Typography noWrap>
                                {row.usefulLife || "未設定"}
                              </Typography>
                            </Tooltip>
                          </TableCell>
                          <TableCell>
                            <Tooltip title={row.scheduledUpdateDate || "未設定"} arrow>
                              <Typography noWrap>
                                {row.scheduledUpdateDate || "未設定"}
                              </Typography>
                            </Tooltip>
                          </TableCell>
                          <TableCell>
                            <Tooltip title={row.notes} arrow>
                              <Typography noWrap>
                                {row.notes}
                              </Typography>
                            </Tooltip>
                          </TableCell>
                          <TableCell>
                            <FormControlLabel
                              control={
                                <Switch
                                  checked={row.active}
                                  onChange={() => handleToggleActive(row.no)}
                                  color="primary"
                                />
                              }
                              label={row.active ? "有効" : "無効"}
                            />
                          </TableCell>
                          <TableCell>
                            <IconButton onClick={(e) => handleMenuClick(e, row)}>
                              <span className="material-icons">more_vert</span>
                            </IconButton>
                          </TableCell>
                        </TableRow>
                      );
                    })}
                    {filteredRows.length === 0 && (
                      <TableRow>
                        <TableCell colSpan={19} align="center"> {/* 列数を19に変更 */}
                          データが見つかりません。
                        </TableCell>
                      </TableRow>
                    )}
                  </TableBody>
                </Table>
              </TableContainer>

              {/* 操作メニュー */}
              <Menu
                anchorEl={anchorEl}
                open={Boolean(anchorEl)}
                onClose={handleMenuClose}
              >
                <MenuItemMUI onClick={() => handleMenuAction('詳細')}>詳細</MenuItemMUI>
                <MenuItemMUI onClick={() => handleMenuAction('記録')}>記録</MenuItemMUI>
                <MenuItemMUI onClick={() => handleMenuAction('履歴')}>履歴</MenuItemMUI>
                <MenuItemMUI onClick={() => handleMenuAction('削除')}>削除</MenuItemMUI>
              </Menu>

              {/* ページネーション */}
              <Grid container alignItems="center" justifyContent="flex-end" style={{ marginTop: 20 }}>
                <Grid item>
                  <Grid container alignItems="center">
                    <Typography variant="body2" style={{ marginRight: 10 }}>
                      合計件数: {filteredRows.length} 件
                    </Typography>
                    <Typography variant="body2" style={{ marginRight: 10 }}>
                      1ページあたりの件数:
                    </Typography>
                    <FormControl variant="outlined" size="small" style={{ width: 120, marginRight: 10 }}>
                      <InputLabel>表示件数</InputLabel>
                      <Select
                        value={rowsPerPageOption}
                        onChange={handleRowsPerPageOptionChange}
                        label="表示件数"
                      >
                        <MenuItemMUI value="10">10</MenuItemMUI>
                        <MenuItemMUI value="20">20</MenuItemMUI>
                        <MenuItemMUI value="30">30</MenuItemMUI>
                        <MenuItemMUI value="全て">全て</MenuItemMUI>
                        <MenuItemMUI value="数値入力">数値入力</MenuItemMUI>
                      </Select>
                    </FormControl>
                    {rowsPerPageOption === '数値入力' && (
                      <TextField
                        value={customRowsPerPage}
                        onChange={handleCustomRowsPerPageChange}
                        variant="outlined"
                        size="small"
                        type="number"
                        inputProps={{ min: 1 }}
                        style={{ width: 80, marginRight: 10 }}
                      />
                    )}
                    <TablePagination
                      component="div"
                      count={filteredRows.length}
                      rowsPerPage={rowsPerPage}
                      page={page}
                      onPageChange={handleChangePage}
                      style={{ border: 'none' }}
                      labelRowsPerPage=""
                      rowsPerPageOptions={[]}
                    />
                  </Grid>
                </Grid>
              </Grid>
            </Paper>
          </Box>

          {/* フッター */}
          <Box className="footer">
            <Typography variant="body2">
              © 2024 設備管理システム. All rights reserved.
            </Typography>
          </Box>

          {/* 新規登録ダイアログ */}
          <Dialog open={openDialog} onClose={handleCloseDialog} maxWidth="sm" fullWidth>
            <DialogTitle>新規設備登録</DialogTitle>
            <DialogContent>
              <Grid container spacing={2}>
                <Grid item xs={12} sm={6}>
                  <TextField
                    label="設備ID"
                    variant="outlined"
                    fullWidth
                    required
                    value={newRow.equipmentId}
                    onChange={(e) => setNewRow({ ...newRow, equipmentId: e.target.value })}
                  />
                </Grid>
                <Grid item xs={12} sm={6}>
                  <TextField
                    label="設備名"
                    variant="outlined"
                    fullWidth
                    required
                    value={newRow.equipmentName}
                    onChange={(e) => setNewRow({ ...newRow, equipmentName: e.target.value })}
                  />
                </Grid>
                <Grid item xs={12} sm={6}>
                  <TextField
                    label="設備カテゴリー"
                    variant="outlined"
                    fullWidth
                    value={newRow.equipmentCategory}
                    onChange={(e) => setNewRow({ ...newRow, equipmentCategory: e.target.value })}
                  />
                </Grid>
                <Grid item xs={12} sm={6}>
                  <TextField
                    label="型番"
                    variant="outlined"
                    fullWidth
                    value={newRow.modelNumber}
                    onChange={(e) => setNewRow({ ...newRow, modelNumber: e.target.value })}
                  />
                </Grid>
                <Grid item xs={12} sm={6}>
                  <TextField
                    label="購入日"
                    variant="outlined"
                    type="date"
                    fullWidth
                    InputLabelProps={{
                      shrink: true,
                    }}
                    value={newRow.purchaseDate}
                    onChange={(e) => setNewRow({ ...newRow, purchaseDate: e.target.value })}
                  />
                </Grid>
                <Grid item xs={12} sm={6}>
                  <TextField
                    label="拠点"
                    variant="outlined"
                    fullWidth
                    value={newRow.location}
                    onChange={(e) => setNewRow({ ...newRow, location: e.target.value })}
                  />
                </Grid>
                <Grid item xs={12} sm={6}>
                  <TextField
                    label="設置場所"
                    variant="outlined"
                    fullWidth
                    value={newRow.installationPlace}
                    onChange={(e) => setNewRow({ ...newRow, installationPlace: e.target.value })}
                  />
                </Grid>
                <Grid item xs={12} sm={6}>
                  <TextField
                    label="管理者"
                    variant="outlined"
                    fullWidth
                    value={newRow.manager}
                    onChange={(e) => setNewRow({ ...newRow, manager: e.target.value })}
                  />
                </Grid>
                <Grid item xs={12} sm={6}>
                  <FormControl variant="outlined" fullWidth>
                    <InputLabel>状態</InputLabel>
                    <Select
                      value={newRow.status}
                      onChange={(e) => setNewRow({ ...newRow, status: e.target.value })}
                      label="状態"
                    >
                      <MenuItemMUI value=""><em>選択なし</em></MenuItemMUI>
                      <MenuItemMUI value="良好">良好</MenuItemMUI>
                      <MenuItemMUI value="使用中">使用中</MenuItemMUI>
                      <MenuItemMUI value="故障中">故障中</MenuItemMUI>
                      <MenuItemMUI value="稼働中">稼働中</MenuItemMUI>
                    </Select>
                  </FormControl>
                </Grid>
                <Grid item xs={12} sm={6}>
                  <TextField
                    label="メンテナンス予定日"
                    variant="outlined"
                    type="date"
                    fullWidth
                    InputLabelProps={{
                      shrink: true,
                    }}
                    value={newRow.nextMaintenanceDate}
                    onChange={(e) => setNewRow({ ...newRow, nextMaintenanceDate: e.target.value })}
                  />
                </Grid>
                <Grid item xs={12} sm={6}>
                  <TextField
                    label="メンテナンス前回実施日"
                    variant="outlined"
                    type="date"
                    fullWidth
                    InputLabelProps={{
                      shrink: true,
                    }}
                    value={newRow.lastMaintenanceDate}
                    onChange={(e) => setNewRow({ ...newRow, lastMaintenanceDate: e.target.value })}
                  />
                </Grid>
                <Grid item xs={12} sm={6}>
                  <TextField
                    label="メンテナンス周期（月）"
                    variant="outlined"
                    fullWidth
                    type="number"
                    value={newRow.maintenanceInterval}
                    onChange={(e) => setNewRow({ ...newRow, maintenanceInterval: e.target.value })}
                  />
                </Grid>
                <Grid item xs={12} sm={6}>
                  <TextField
                    label="耐用年数（月）"
                    variant="outlined"
                    fullWidth
                    type="number"
                    value={newRow.usefulLife}
                    onChange={(e) => setNewRow({ ...newRow, usefulLife: e.target.value })}
                  />
                </Grid>
                <Grid item xs={12} sm={6}>
                  <TextField
                    label="更新予定日"
                    variant="outlined"
                    type="date"
                    fullWidth
                    InputLabelProps={{
                      shrink: true,
                    }}
                    value={newRow.scheduledUpdateDate}
                    onChange={(e) => setNewRow({ ...newRow, scheduledUpdateDate: e.target.value })}
                  />
                </Grid>
                <Grid item xs={12}>
                  <TextField
                    label="備考"
                    variant="outlined"
                    fullWidth
                    multiline
                    rows={3}
                    value={newRow.notes}
                    onChange={(e) => setNewRow({ ...newRow, notes: e.target.value })}
                  />
                </Grid>
              </Grid>
            </DialogContent>
            <DialogActions>
              <Button onClick={handleCloseDialog} color="secondary">
                キャンセル
              </Button>
              <Button onClick={handleAddRow} color="primary" variant="contained">
                追加
              </Button>
            </DialogActions>
          </Dialog>

          {/* サブメニュー用モーダルダイアログ */}
          <Dialog open={openSubMenuDialog} onClose={handleCloseSubMenuDialog} maxWidth="sm" fullWidth>
            <DialogTitle>
              {subMenuAction === "詳細" && "詳細情報"}
              {subMenuAction === "記録" && "記録情報"}
              {subMenuAction === "履歴" && "履歴情報"}
            </DialogTitle>
            <DialogContent>
              {currentRow && (
                <>
                  <Typography variant="subtitle1" gutterBottom>
                    設備ID: {currentRow.equipmentId}
                  </Typography>
                  <Typography variant="subtitle1" gutterBottom>
                    設備名: {currentRow.equipmentName}
                  </Typography>
                  <Typography variant="subtitle1" gutterBottom>
                    管理者: {currentRow.manager}
                  </Typography> {/* 管理者情報を追加 */}
                  {subMenuAction === "詳細" && (
                    <>
                      <Typography variant="body1" gutterBottom>
                        設備カテゴリー: {currentRow.equipmentCategory}
                      </Typography>
                      <Typography variant="body1" gutterBottom>
                        型番: {currentRow.modelNumber}
                      </Typography>
                      <Typography variant="body1" gutterBottom>
                        購入日: {currentRow.purchaseDate}
                      </Typography>
                      <Typography variant="body1" gutterBottom>
                        拠点: {currentRow.location}
                      </Typography>
                      <Typography variant="body1" gutterBottom>
                        設置場所: {currentRow.installationPlace}
                      </Typography>
                      <Typography variant="body1" gutterBottom>
                        状態: {currentRow.status}
                      </Typography>
                      <Typography variant="body1" gutterBottom>
                        メンテナンス予定日: {currentRow.nextMaintenanceDate || "未設定"}
                      </Typography>
                      <Typography variant="body1" gutterBottom>
                        メンテナンス前回実施日: {currentRow.lastMaintenanceDate || "未設定"}
                      </Typography>
                      <Typography variant="body1" gutterBottom>
                        メンテナンス周期（月）: {currentRow.maintenanceInterval || "未設定"}
                      </Typography>
                      <Typography variant="body1" gutterBottom>
                        耐用年数（月）: {currentRow.usefulLife || "未設定"}
                      </Typography>
                      <Typography variant="body1" gutterBottom>
                        更新予定日: {currentRow.scheduledUpdateDate || "未設定"}
                      </Typography>
                      <Typography variant="body1" gutterBottom>
                        備考: {currentRow.notes}
                      </Typography>
                      <Typography variant="body1" gutterBottom>
                        有効: {currentRow.active ? "有効" : "無効"}
                      </Typography>
                    </>
                  )}
                  {subMenuAction === "記録" && (
                    <>
                      {/* 記録情報の詳細をここに追加 */}
                      <Typography variant="body1" gutterBottom>
                        記録情報がここに表示されます。
                      </Typography>
                    </>
                  )}
                  {subMenuAction === "履歴" && (
                    <>
                      {/* 履歴情報の詳細をここに追加 */}
                      <Typography variant="body1" gutterBottom>
                        履歴情報がここに表示されます。
                      </Typography>
                    </>
                  )}
                </>
              )}
            </DialogContent>
            <DialogActions>
              <Button onClick={handleCloseSubMenuDialog} color="primary">
                閉じる
              </Button>
            </DialogActions>
          </Dialog>

          {/* スナックバー */}
          <Snackbar
            open={snackbar.open}
            autoHideDuration={3000}
            onClose={handleCloseSnackbar}
            anchorOrigin={{ vertical: 'bottom', horizontal: 'center' }}
          >
            <Alert onClose={handleCloseSnackbar} severity={snackbar.severity} sx={{ width: '100%' }}>
              {snackbar.message}
            </Alert>
          </Snackbar>
        </Box>
      );
    }

      // ReactDOM.render をコンポーネントの外に配置
      ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>
