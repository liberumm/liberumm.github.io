<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>ãƒ¢ãƒ€ãƒ³ã‚¹ãƒ­ãƒƒãƒˆã‚«ãƒ¼ã‚²ãƒ¼ãƒ  - 8ã®å­—ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼ˆç­‰è·é›¢ãƒ¬ãƒ¼ãƒ³ï¼‰</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap');
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Orbitron', monospace;
            display: flex; justify-content: center; align-items: center;
            min-height: 100vh;
            background:
                radial-gradient(circle at 20% 50%, rgba(120,119,198,0.3), transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255,119,198,0.3), transparent 50%),
                radial-gradient(circle at 40% 80%, rgba(120,219,255,0.3), transparent 50%),
                linear-gradient(135deg, #0c0c0c 0%, #1a1a2e 50%, #16213e 100%);
            overflow: hidden; position: relative;
        }
        body::before {
            content: '';
            position: fixed; inset: 0;
            background: repeating-linear-gradient(
                0deg, transparent, transparent 2px,
                rgba(255,255,255,0.03) 2px, rgba(255,255,255,0.03) 4px
            );
            pointer-events: none; z-index: 1;
        }
        #gameContainer {
            position: relative; width: 900px; height: 500px;
            background: radial-gradient(ellipse at center,
                        rgba(15,32,39,0.9) 0%, rgba(32,58,67,0.8) 50%, rgba(44,83,100,0.7) 100%);
            border-radius: 250px;
            box-shadow:
                0 0 100px rgba(0,255,255,0.2),
                0 0 200px rgba(255,0,255,0.1),
                inset 0 0 100px rgba(0,0,0,0.5),
                0 20px 80px rgba(0,0,0,0.8);
            transform: perspective(1000px) rotateX(5deg);
            overflow: visible; z-index: 10;
        }
        .track {
            position: absolute; inset: 0;
            border: 6px solid;
            border-image: linear-gradient(45deg, #00ffff, #ff00ff, #ffff00, #00ffff) 1;
            border-radius: 250px; box-sizing: border-box; z-index: 1;
            box-shadow:
                inset 0 0 50px rgba(0,255,255,0.3),
                0 0 30px rgba(0,255,255,0.5);
            animation: trackGlow 3s ease-in-out infinite alternate;
        }
        @keyframes trackGlow {
            0% { box-shadow: inset 0 0 50px rgba(0,255,255,0.3), 0 0 30px rgba(0,255,255,0.5); }
            100% { box-shadow: inset 0 0 80px rgba(255,0,255,0.4), 0 0 50px rgba(255,0,255,0.6); }
        }

        /* 8ã®å­—ã®ä¸­å¿ƒç·šãŠã‚ˆã³ã‚¬ã‚¤ãƒ‰ãƒ¬ãƒ¼ãƒ³ã‚’æã SVG */
        #trackSvg { position: absolute; left: 0; top: 0; width: 900px; height: 500px; z-index: 2; }
        .laneGuide { fill: none; stroke: rgba(255,255,255,0.28); stroke-width: 2; stroke-dasharray: 8 8; }
        .centerPath { fill: none; stroke: rgba(0,255,255,0.35); stroke-width: 4; }

        .car {
            position: absolute; width: 28px; height: 14px;
            border-radius: 6px; transform-origin: center;
            transition: transform 0.08s linear;
            box-shadow: 0 0 15px rgba(255,255,255,0.6), 0 4px 20px rgba(0,0,0,0.8);
            filter: brightness(1.2);
            z-index: 10;
        }
        .car::before {
            content: '';
            position: absolute; width: 8px; height: 8px;
            background: radial-gradient(circle, rgba(255,255,255,1) 0%, rgba(255,255,255,0.8) 50%, transparent 100%);
            border-radius: 50%; top: 50%; left: 3px; transform: translateY(-50%);
            box-shadow: 0 0 10px rgba(255,255,255,0.8);
            animation: headlightFlicker 0.1s ease-in-out infinite alternate;
        }
        .car::after {
            content: '';
            position: absolute; width: 6px; height: 6px;
            background: radial-gradient(circle, rgba(255,50,50,1) 0%, rgba(255,0,0,0.8) 50%, transparent 100%);
            border-radius: 50%; top: 50%; right: 3px; transform: translateY(-50%);
            box-shadow: 0 0 8px rgba(255,0,0,0.8);
        }
        @keyframes headlightFlicker { 0% { opacity: 0.9; } 100% { opacity: 1; } }

        .car-trail {
            position: absolute; width: 2px; height: 2px;
            background: radial-gradient(circle, rgba(255,255,255,0.8) 0%, transparent 100%);
            border-radius: 50%; pointer-events: none; z-index: 5;
            animation: trailFade 0.8s ease-out forwards;
        }
        @keyframes trailFade { 0% { opacity: 0.8; transform: scale(1); } 100% { opacity: 0; transform: scale(0.2); } }

        .controls {
            position: absolute; bottom: -100px; left: 50%;
            transform: translateX(-50%); display: flex; gap: 20px;
            z-index: 100;
        }
        .btn {
            padding: 15px 30px; font-size: 16px; font-weight: 700;
            font-family: 'Orbitron', monospace; border: none; border-radius: 30px; cursor: pointer;
            position: relative; text-transform: uppercase; letter-spacing: 2px;
            transition: all 0.3s ease; overflow: hidden;
        }
        .btn::before {
            content: ''; position: absolute; top: 0; left: -100%;
            width: 100%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            transition: left 0.6s;
        }
        .btn:hover::before { left: 100%; }
        #startButton {
            background: linear-gradient(45deg, #00ff88, #00cc66); color: #003322;
            box-shadow: 0 0 30px rgba(0,255,136,0.5), 0 6px 20px rgba(0,0,0,0.4);
        }
        #startButton:hover { transform: translateY(-3px); box-shadow: 0 0 40px rgba(0,255,136,0.8), 0 8px 30px rgba(0,0,0,0.6); }
        #resetButton {
            background: linear-gradient(45deg, #ff6b6b, #ee5a52); color: #fff;
            box-shadow: 0 0 30px rgba(255,107,107,0.5), 0 6px 20px rgba(0,0,0,0.4);
        }
        #resetButton:hover { transform: translateY(-3px); box-shadow: 0 0 40px rgba(255,107,107,0.8), 0 8px 30px rgba(0,0,0,0.6); }

        .lap-counter {
            position: absolute; font-family: 'Orbitron', monospace;
            font-size: 13px; font-weight: 700; color: #00ffff;
            background: linear-gradient(135deg, rgba(0,255,255,0.1) 0%, rgba(0,100,100,0.2) 50%, rgba(0,50,50,0.3) 100%);
            padding: 10px 15px; border-radius: 25px; border: 2px solid rgba(0,255,255,0.4);
            backdrop-filter: blur(15px); transition: all 0.3s ease;
            box-shadow: 0 0 20px rgba(0,255,255,0.3), inset 0 0 20px rgba(0,255,255,0.1);
            z-index: 15;
        }
        .lap-counter.finished {
            background: linear-gradient(135deg, #ffd700, #ffb300); color: #333; border-color: #ffd700;
            animation: championPulse 1.5s infinite;
            box-shadow: 0 0 30px rgba(255,215,0,0.8), inset 0 0 20px rgba(255,215,0,0.2);
        }
        @keyframes championPulse { 0%,100% { transform: scale(1); } 50% { transform: scale(1.05); } }

        .speedometer {
            position: absolute; top: 30px; right: 30px;
            width: 120px; height: 120px;
            background: radial-gradient(circle, rgba(0,0,0,0.9) 0%, rgba(20,20,40,0.8) 70%, rgba(0,255,255,0.1) 100%);
            border-radius: 50%; border: 3px solid rgba(0,255,255,0.6);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            font-family: 'Orbitron', monospace; font-size: 12px; font-weight: 700; color: #00ffff;
            box-shadow: 0 0 40px rgba(0,255,255,0.4), inset 0 0 30px rgba(0,0,0,0.5);
            z-index: 20;
        }

        .finish-line {
            position: absolute; top: 50%;
            width: 6px; height: 50px;
            background: repeating-linear-gradient(0deg, #000 0, #000 5px, #fff 5px, #fff 10px);
            transform: translateY(-50%);
            box-shadow: 0 0 20px rgba(255,255,255,0.6);
            animation: finishLineGlow 2s ease-in-out infinite alternate;
            z-index: 3;
        }
        @keyframes finishLineGlow { 0% { box-shadow: 0 0 20px rgba(255,255,255,0.6); } 100% { box-shadow: 0 0 40px rgba(255,255,255,1); } }

        .particle {
            position: absolute; border-radius: 50%; pointer-events: none; z-index: 5;
            animation: particleFloat 2s ease-out forwards;
        }
        @keyframes particleFloat { 0% { opacity: 1; transform: translate(0,0) scale(1); } 100% { opacity: 0; transform: translate(var(--dx),var(--dy)) scale(0.2); } }

        .race-stats {
            position: absolute; top: 30px; left: 30px;
            background: linear-gradient(135deg, rgba(0,0,0,0.9) 0%, rgba(20,20,40,0.8) 100%);
            padding: 20px; border-radius: 15px; font-family: 'Orbitron', monospace;
            font-size: 14px; font-weight: 700; color: #00ffff;
            box-shadow: 0 0 30px rgba(0,255,255,0.3), inset 0 0 20px rgba(0,255,255,0.1);
            min-width: 220px; z-index: 20;
        }

        .leader-indicator {
            position: absolute; width: 35px; height: 35px;
            background: radial-gradient(circle, rgba(255,215,0,1) 0%, rgba(255,140,0,0.8) 70%, transparent 100%);
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-family: 'Orbitron', monospace; font-size: 14px; font-weight: 900; color: white;
            border: 2px solid rgba(255,255,255,0.8);
            box-shadow: 0 0 20px rgba(255,215,0,0.8);
            animation: leaderGlow 2s infinite; z-index: 15;
        }
        @keyframes leaderGlow { 0%,100% { transform: scale(1); } 50% { transform: scale(1.1); } }

        .winner-banner {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%);
            background: linear-gradient(135deg, rgba(255,215,0,0.9) 0%, rgba(255,140,0,0.9) 50%, rgba(255,69,0,0.9) 100%);
            color: white; padding: 30px 50px; border-radius: 20px;
            font-family: 'Orbitron', monospace; font-size: 24px; font-weight: 900; text-align: center;
            display: none; z-index: 50; box-shadow: 0 0 80px rgba(255,215,0,0.8), 0 20px 40px rgba(0,0,0,0.6);
            border: 3px solid rgba(255,255,255,0.8); animation: victorySlideIn 0.8s ease;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }
        @keyframes victorySlideIn {
            0%   { opacity: 0; transform: translate(-50%,-50%) scale(0.3) rotateY(180deg); }
            50%  { opacity: 1; transform: translate(-50%,-50%) scale(1.1) rotateY(0deg); }
            100% { opacity: 1; transform: translate(-50%,-50%) scale(1) rotateY(0deg); }
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        <div class="track"></div>
        <svg id="trackSvg" viewBox="0 0 900 500" aria-hidden="true"></svg>

        <!-- ãƒ•ã‚£ãƒ‹ãƒƒã‚·ãƒ¥ãƒ©ã‚¤ãƒ³ï¼ˆä½ç½®ã¯ JS ã§ 8 ã®å­—ã®å³ç«¯ã«åˆã‚ã›ã‚‹ï¼‰ -->
        <div class="finish-line" id="finishLine"></div>

        <div id="cars"></div>

        <div class="race-stats">
            <div>ğŸ ãƒ¬ãƒ¼ã‚¹çµ±è¨ˆ</div>
            <div id="raceTime">çµŒéæ™‚é–“: 0.0ç§’</div>
            <div id="leader">ãƒªãƒ¼ãƒ€ãƒ¼: ---</div>
        </div>

        <div class="speedometer">
            <div>é€Ÿåº¦</div>
            <div id="avgSpeed">0 km/h</div>
        </div>

        <div class="winner-banner" id="winnerBanner">ğŸ† å„ªå‹ãŠã‚ã§ã¨ã†ï¼ ğŸ†</div>

        <div class="controls">
            <button id="startButton" class="btn">ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
            <button id="resetButton" class="btn">ãƒªã‚»ãƒƒãƒˆ</button>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const gameContainer = document.getElementById('gameContainer');
        const carsContainer = document.getElementById('cars');
        const startButton = document.getElementById('startButton');
        const resetButton = document.getElementById('resetButton');
        const winnerBanner = document.getElementById('winnerBanner');
        const raceTimeElement = document.getElementById('raceTime');
        const leaderElement = document.getElementById('leader');
        const avgSpeedElement = document.getElementById('avgSpeed');
        const svg = document.getElementById('trackSvg');
        const finishLine = document.getElementById('finishLine');

        // ====== è¨­å®šå€¤ ======
        const numLanes = 6;                 // ãƒ¬ãƒ¼ãƒ³æ•°
        const lapsToFinish = 3;             // ã‚´ãƒ¼ãƒ«å‘¨å›
        const centerX = 450, centerY = 250; // 8ã®å­—ä¸­å¿ƒ
        const a = 330;                      // 8ã®å­—ã®æ¨ªæ–¹å‘ã‚¹ã‚±ãƒ¼ãƒ«ï¼ˆå³ç«¯ = cx + aï¼‰
        const samples = 600;                // ãƒ‘ã‚¹ç”Ÿæˆãƒ»ã‚¬ã‚¤ãƒ‰ç”¨ã‚µãƒ³ãƒ—ãƒ«ç‚¹æ•°
        const laneGap = 18;                 // ãƒ¬ãƒ¼ãƒ³é–“ã®è¦‹ãŸç›®ã‚ªãƒ•ã‚»ãƒƒãƒˆï¼ˆpxï¼‰
        const laneOffsets = [...Array(numLanes)].map((_,i)=> (i-(numLanes-1)/2)*laneGap);
        const pxPerSecBaseMin = 80, pxPerSecBaseMax = 120; // é€Ÿåº¦ãƒ¬ãƒ³ã‚¸ï¼ˆpx/sï¼‰
        const epsForTangent = 1;            // æ¥ç·šè¨ˆç®—ç”¨ã®å¾®å°è·é›¢ï¼ˆpxï¼‰

        // ====== çŠ¶æ…‹ ======
        let cars = [];
        let isRunning = false;
        let animationFrameId;
        let raceStartTime = 0;
        let lastTs = 0;
        let winner = null;
        let leaderIndicator = null;

        const carNames = ['ãƒã‚ªãƒ³','ã‚µã‚¤ãƒãƒ¼','ãƒ—ãƒ©ã‚ºãƒ','ãƒ¬ãƒ¼ã‚¶ãƒ¼','ãƒ•ã‚©ãƒˆãƒ³','ã‚¯ã‚©ãƒ³ã‚¿ãƒ '];
        const carColors = [
            'linear-gradient(45deg,#ff6b6b,#ee5a52)',
            'linear-gradient(45deg,#4ecdc4,#44a08d)',
            'linear-gradient(45deg,#45b7d1,#2196f3)',
            'linear-gradient(45deg,#f9ca24,#f0932b)',
            'linear-gradient(45deg,#6c5ce7,#a29bfe)',
            'linear-gradient(45deg,#00b894,#00cec9)'
        ];

        /** Gerono ã®ãƒ¬ãƒ ãƒ‹ã‚¹ã‚±ãƒ¼ãƒˆï¼ˆ8ã®å­—ï¼‰: x=a cos t, y=(a/2) sin(2t) ã‚’ [0,2Ï€] ã§ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ã—ã¦ãƒ‘ã‚¹åŒ– */
        function buildLemniscatePath(cx, cy, a, nSamples) {
            const pts = [];
            for (let i=0;i<nSamples;i++) {
                const t = (i/(nSamples-1)) * Math.PI*2; // 0..2Ï€
                const x = cx + a * Math.cos(t);
                const y = cy + (a/2) * Math.sin(2*t);
                pts.push([x,y]);
            }
            // æŠ˜ã‚Œç·šãƒ‘ã‚¹ï¼ˆååˆ†ç´°ã‹ã„ã®ã§æ»‘ã‚‰ã‹ã«è¦‹ãˆã‚‹ï¼‰
            let d = `M ${pts[0][0]},${pts[0][1]}`;
            for (let i=1;i<pts.length;i++) d += ` L ${pts[i][0]},${pts[i][1]}`;
            return d;
        }

        /** ä¸­å¿ƒç·šãƒ‘ã‚¹ã‚’æç”»ã—ã€ã‚¬ã‚¤ãƒ‰ãƒ¬ãƒ¼ãƒ³ï¼ˆè¦‹ãŸç›®ç”¨ã‚ªãƒ•ã‚»ãƒƒãƒˆï¼‰ã‚‚ç”Ÿæˆ */
        function drawEightAndGuides() {
            svg.innerHTML = '';
            // ä¸­å¿ƒç·š
            const center = document.createElementNS('http://www.w3.org/2000/svg','path');
            center.setAttribute('d', buildLemniscatePath(centerX, centerY, a, samples));
            center.setAttribute('class','centerPath');
            center.setAttribute('id','centerPath');
            svg.appendChild(center);

            // ãƒ•ã‚£ãƒ‹ãƒƒã‚·ãƒ¥ãƒ©ã‚¤ãƒ³ã‚’ 8 ã®å­—å³ç«¯ã«åˆã‚ã›ã‚‹ï¼ˆx = cx + aï¼‰
            finishLine.style.left = `${centerX + a - 3}px`; // 6pxå¹…ã®ä¸­å¤®åˆã‚ã›
            finishLine.style.top  = `50%`;

            // ã‚¬ã‚¤ãƒ‰ãƒ¬ãƒ¼ãƒ³ï¼ˆè¦‹ãŸç›®ç”¨ï¼‰ï¼šä¸­å¿ƒç·šã®æ³•ç·šæ–¹å‘ã«ã‚ªãƒ•ã‚»ãƒƒãƒˆ
            const centerPath = center;
            const totalLen = centerPath.getTotalLength();

            laneOffsets.forEach((off, idx) => {
                let d = '';
                for (let i=0;i<samples;i++){
                    const s = (i/(samples-1)) * totalLen;
                    const p  = centerPath.getPointAtLength(s);
                    const p2 = centerPath.getPointAtLength((s + epsForTangent) % totalLen);
                    const tx = p2.x - p.x, ty = p2.y - p.y;
                    const len = Math.hypot(tx,ty) || 1;
                    // å·¦æ³•ç·šï¼ˆé€²è¡Œæ–¹å‘ã«å¯¾ã—å·¦å´ã‚’æ­£ã¨ã™ã‚‹ï¼‰
                    const nx = -ty/len, ny = tx/len;
                    const x = p.x + nx * off;
                    const y = p.y + ny * off;
                    d += (i===0 ? `M ${x},${y}` : ` L ${x},${y}`);
                }
                const guide = document.createElementNS('http://www.w3.org/2000/svg','path');
                guide.setAttribute('d', d);
                guide.setAttribute('class','laneGuide');
                guide.setAttribute('id', `laneGuide_${idx}`);
                svg.appendChild(guide);
            });
        }

        /** åˆæœŸåŒ–ï¼šä¸­å¿ƒç·šã‚’åŸºæº–ã«ã€Œè·é›¢å®Œå…¨åŒä¸€ã€ã®èµ°è¡Œã‚’æ§‹æˆã€‚è¦‹ãŸç›®ã ã‘ãƒ¬ãƒ¼ãƒ³å·®ã‚’ä»˜ã‘ã‚‹ã€‚ */
        function init() {
            carsContainer.innerHTML = '';
            document.querySelectorAll('.lap-counter').forEach(el => el.remove());
            if (leaderIndicator) leaderIndicator.remove();
            winner = null;
            winnerBanner.style.display = 'none';

            // 8ã®å­—ï¼†ã‚¬ã‚¤ãƒ‰ç”Ÿæˆ
            drawEightAndGuides();

            // ä¸­å¿ƒç·šãƒ‘ã‚¹ã‚’å–å¾—ï¼ˆèµ°è¡Œã¯å¿…ãšã“ã®å¼§é•·ã‚’ä½¿ã†ï¼å…¨ãƒ¬ãƒ¼ãƒ³åŒè·é›¢ï¼‰
            const centerPath = document.getElementById('centerPath');
            const totalLen = centerPath.getTotalLength();

            // è»Šä¸¡ç”Ÿæˆï¼ˆè¦‹ãŸç›®ä½ç½®ã¯ã‚ªãƒ•ã‚»ãƒƒãƒˆã€é€²æ— s ã¯ä¸­å¿ƒç·šè·é›¢ï¼‰
            cars = [];
            for (let i=0;i<numLanes;i++) {
                const carEl = document.createElement('div');
                carEl.className = 'car';
                carEl.style.background = carColors[i];
                carsContainer.appendChild(carEl);

                const lapCounter = document.createElement('div');
                lapCounter.className = 'lap-counter';
                lapCounter.textContent = `${carNames[i]}: 0/${lapsToFinish}å‘¨`;
                lapCounter.style.left = `20px`;
                lapCounter.style.top  = `${80 + i*40}px`;
                gameContainer.appendChild(lapCounter);

                const baseSpeed = pxPerSecBaseMin + Math.random()*(pxPerSecBaseMax - pxPerSecBaseMin); // px/s
                cars.push({
                    element: carEl,
                    name: carNames[i],
                    s: Math.random() * totalLen * 0.2,   // ã‚¹ã‚¿ãƒ¼ãƒˆæ™‚ã«å°‘ã—æ•£ã‚‰ã™
                    baseSpeed,
                    laps: 0,
                    lapCounter,
                    finished: false,
                    laneOffset: laneOffsets[i],          // è¦‹ãŸç›®ã‚ªãƒ•ã‚»ãƒƒãƒˆ
                });
            }

            leaderIndicator = document.createElement('div');
            leaderIndicator.className = 'leader-indicator';
            leaderIndicator.textContent = 'ğŸ‘‘';
            gameContainer.appendChild(leaderIndicator);

            avgSpeedElement.textContent = `0 km/h`;
            leaderElement.textContent = `ãƒªãƒ¼ãƒ€ãƒ¼: ---`;
            raceTimeElement.textContent = `çµŒéæ™‚é–“: 0.0ç§’`;
        }

        function createParticle(x,y,type='normal') {
            const p = document.createElement('div');
            p.className = 'particle';
            const dx = (Math.random()-0.5)*100;
            const dy = (Math.random()-0.5)*100;
            p.style.setProperty('--dx', dx+'px');
            p.style.setProperty('--dy', dy+'px');
            if (type==='spark') {
                p.style.width = '3px'; p.style.height = '3px';
                p.style.background = 'radial-gradient(circle,#ffff00,#ff8800)';
                p.style.boxShadow = '0 0 10px #ffff00';
            } else {
                p.style.width = '2px'; p.style.height = '2px';
                p.style.background = '#fff';
            }
            p.style.left = x+'px'; p.style.top = y+'px';
            gameContainer.appendChild(p);
            setTimeout(()=>p.remove(),2000);
        }
        function createTrail(x,y) {
            const t = document.createElement('div');
            t.className = 'car-trail';
            t.style.left = x+'px'; t.style.top = y+'px';
            gameContainer.appendChild(t);
            setTimeout(()=>t.remove(),800);
        }

        /** å®Ÿæ™‚é–“ dt ã§ä¸­å¿ƒç·šä¸Šã®å¼§é•· s ã‚’é€²ã‚ã€è¦‹ãŸç›®ã¯æ³•ç·šã‚ªãƒ•ã‚»ãƒƒãƒˆã§é…ç½® */
        function updateCars(ts) {
            if (!isRunning) return;

            const nowSec = (Date.now() - raceStartTime)/1000;
            raceTimeElement.textContent = `çµŒéæ™‚é–“: ${nowSec.toFixed(1)}ç§’`;

            if (!lastTs) lastTs = ts;
            const dt = Math.min(0.05, (ts - lastTs) / 1000);
            lastTs = ts;

            const centerPath = document.getElementById('centerPath');
            const totalLen = centerPath.getTotalLength();

            let leaderCar = null;
            let maxProg = -Infinity;
            let allFinished = true;
            let totalSpeed = 0;
            let activeCount = 0;

            cars.forEach(car => {
                if (car.finished) return;

                // é€Ÿåº¦å¾®æºã‚‰ãï¼ˆÂ±5%ï¼‰
                const jitter = 1 + (Math.random()-0.5)*0.10;
                const speed = car.baseSpeed * jitter; // px/s
                let sNext = car.s + speed * dt;

                // ãƒ©ãƒƒãƒ—åˆ¤å®šï¼ˆä¸­å¿ƒç·šåŸºæº–ï¼å…¨ãƒ¬ãƒ¼ãƒ³ç­‰è·é›¢ï¼‰
                if (sNext >= totalLen) {
                    sNext -= totalLen;
                    car.laps++;
                    car.lapCounter.textContent = `${car.name}: ${car.laps}/${lapsToFinish}å‘¨`;

                    // èŠ±ç«
                    const p0 = centerPath.getPointAtLength(0);
                    for (let i=0;i<10;i++) setTimeout(()=> createParticle(p0.x,p0.y,'spark'), i*30);

                    if (car.laps >= lapsToFinish) {
                        car.finished = true;
                        car.lapCounter.classList.add('finished');
                        if (!winner) {
                            winner = car;
                            winnerBanner.innerHTML = `ğŸ† ${car.name} å„ªå‹ï¼ ğŸ†<br><span style="font-size:18px;">ã‚¿ã‚¤ãƒ : ${nowSec.toFixed(2)}ç§’</span>`;
                            winnerBanner.style.display = 'block';
                        }
                    }
                }
                car.s = sNext;

                // ä½ç½®ãƒ»è§’åº¦ï¼ˆä¸­å¿ƒç·šï¼‰â†’ è¦‹ãŸç›®ã¯æ³•ç·šã‚ªãƒ•ã‚»ãƒƒãƒˆ
                const p  = centerPath.getPointAtLength(car.s);
                const p2 = centerPath.getPointAtLength((car.s + epsForTangent) % totalLen);
                const tx = p2.x - p.x, ty = p2.y - p.y;
                const len = Math.hypot(tx,ty) || 1;
                const nx = -ty/len, ny = tx/len; // å·¦æ³•ç·š
                const x = p.x + nx * car.laneOffset;
                const y = p.y + ny * car.laneOffset;
                const angleDeg = Math.atan2(ty, tx) * 180 / Math.PI;

                car.element.style.left = `${x - 14}px`;
                car.element.style.top  = `${y - 7}px`;
                car.element.style.transform = `rotate(${angleDeg}deg)`;

                if (Math.random() < 0.10) createTrail(x, y);
                if (Math.random() < 0.05) createParticle(x, y, 'spark');

                const prog = car.laps * totalLen + car.s;
                if (prog > maxProg) { maxProg = prog; leaderCar = car; }

                allFinished = false;
                totalSpeed += speed;
                activeCount++;
            });

            // ãƒªãƒ¼ãƒ€ãƒ¼è¡¨ç¤º
            if (leaderCar) {
                leaderElement.textContent = `ãƒªãƒ¼ãƒ€ãƒ¼: ${leaderCar.name}`;
                const p  = document.getElementById('centerPath').getPointAtLength(leaderCar.s);
                const p2 = document.getElementById('centerPath').getPointAtLength((leaderCar.s + epsForTangent) % document.getElementById('centerPath').getTotalLength());
                const tx = p2.x - p.x, ty = p2.y - p.y;
                const len = Math.hypot(tx,ty) || 1;
                const nx = -ty/len, ny = tx/len;
                const lx = p.x + nx * leaderCar.laneOffset;
                const ly = p.y + ny * leaderCar.laneOffset;
                leaderIndicator.style.left = `${lx - 17.5}px`;
                leaderIndicator.style.top  = `${ly - 45}px`;
            }

            // å¹³å‡é€Ÿåº¦ï¼ˆè¦‹ãŸç›®ç”¨æ›ç®—ï¼‰
            if (activeCount > 0) {
                const pxPerSecAvg = totalSpeed / activeCount;
                const kmh = pxPerSecAvg * 0.20; // è¦‹ã›æ–¹ç”¨ä¿‚æ•°
                avgSpeedElement.textContent = `${kmh.toFixed(0)} km/h`;
            }

            // çµ‚äº†
            if (allFinished) {
                isRunning = false;
                startButton.textContent = 'ã‚¹ã‚¿ãƒ¼ãƒˆ';
                leaderIndicator.style.display = 'none';
                for (let i=0; i<30; i++) {
                    setTimeout(()=>{
                        const x = Math.random()*900, y = Math.random()*500;
                        createParticle(x,y,'spark');
                    }, i*80);
                }
                return;
            }

            animationFrameId = requestAnimationFrame(updateCars);
        }

        // ====== ãƒœã‚¿ãƒ³æ“ä½œ ======
        startButton.addEventListener('click', ()=>{
            if (isRunning) {
                isRunning = false;
                cancelAnimationFrame(animationFrameId);
                startButton.textContent = 'ã‚¹ã‚¿ãƒ¼ãƒˆ';
                leaderIndicator.style.display = 'none';
            } else {
                if (winner) init(); // å‹è€…ãŒå‡ºã¦ã„ãŸã‚‰ãƒªã‚»ãƒƒãƒˆç›¸å½“
                isRunning = true;
                raceStartTime = Date.now();
                lastTs = 0;
                animationFrameId = requestAnimationFrame(updateCars);
                startButton.textContent = 'ã‚¹ãƒˆãƒƒãƒ—';
                leaderIndicator.style.display = 'block';
            }
        });

        resetButton.addEventListener('click', ()=>{
            isRunning = false;
            cancelAnimationFrame(animationFrameId);
            init();
            startButton.textContent = 'ã‚¹ã‚¿ãƒ¼ãƒˆ';
        });

        // èƒŒæ™¯ã®ç¬ã
        (function bgEffect(){
            if (Math.random()<0.02) {
                const x=Math.random()*window.innerWidth;
                const y=Math.random()*window.innerHeight;
                const star=document.createElement('div');
                star.style.position='fixed';
                star.style.left=`${x}px`;
                star.style.top=`${y}px`;
                star.style.width='2px';
                star.style.height='2px';
                star.style.background='#fff';
                star.style.borderRadius='50%';
                star.style.pointerEvents='none';
                star.style.zIndex='1';
                star.style.animation='twinkle 3s ease-in-out forwards';
                document.body.appendChild(star);
                setTimeout(()=>star.remove(),3000);
            }
            requestAnimationFrame(bgEffect);
        })();
        const styleTag=document.createElement('style');
        styleTag.textContent=`@keyframes twinkle { 0%,100% { opacity:0; transform:scale(0.5) } 50% { opacity:1; transform:scale(1) } }`;
        document.head.appendChild(styleTag);

        // èµ·å‹•
        init();
    });
    </script>
</body>
</html>
