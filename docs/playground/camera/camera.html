<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>バーコードリーダー</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/@mui/material/5.0.0-alpha.38/material-ui.min.css"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/17.0.2/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/17.0.2/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@mui/material@5.0.0-alpha.38/umd/material-ui.production.min.js"></script>
    <script src="https://unpkg.com/@ericblade/quagga2@1.7.4/dist/quagga.min.js"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;
        const { Button, Container, Typography, TextField, Paper } = MaterialUI;

        const BarcodeReader = () => {
            const [scanning, setScanning] = useState(false);
            const [continuousMode, setContinuousMode] = useState(true);
            const [history, setHistory] = useState([]);

            useEffect(() => {
                if (scanning) {
                    Quagga.init({
                        inputStream: {
                            name: "Live",
                            type: "LiveStream",
                            target: document.getElementById("my_quagga"),
                        },
                        decoder: {
                            readers: ["ean_reader"],
                        },
                    }, (err) => {
                        if (err) {
                            console.error(err);
                            return;
                        }
                        console.log("Initialization finished!!");
                        Quagga.start();
                    });

                    Quagga.onDetected(result => {
                        const code = result.codeResult.code;
                        const timestamp = new Date().toLocaleString();
                        setHistory(prevHistory => [...prevHistory, `No.${prevHistory.length + 1}: ${code} (読み取り時刻: ${timestamp})`]);
                        if (!continuousMode) {
                            alert(`読み取ったバーコード: ${code}`);
                            stopScanning();
                        }
                    });

                    Quagga.onProcessed(result => {
                        if (result && result.boxes) {
                            const ctx = Quagga.canvas.ctx.overlay;
                            ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                            result.boxes.forEach(box => {
                                Quagga.ImageDebug.drawPath(box, { x: 0, y: 0 }, ctx, { color: "blue", lineWidth: 2 });
                            });
                        }
                    });
                } else {
                    Quagga.stop();
                }

                return () => {
                    if (scanning) {
                        Quagga.stop();
                    }
                };
            }, [scanning]);

            const startScanning = () => {
                setScanning(true);
            };

            const stopScanning = () => {
                setScanning(false);
            };

            const toggleMode = () => {
                setContinuousMode(!continuousMode);
            };

            return (
                <Container>
                    <Typography variant="h4" align="center" gutterBottom>
                        QuaggaJS バーコードリーダー
                    </Typography>
                    <div id="my_quagga" style={{ width: '320px', height: '240px', position: 'relative', backgroundColor: 'silver' }}></div>
                    <Paper style={{ padding: '10px', margin: '10px 0' }}>
                        <Typography variant="h6">履歴</Typography>
                        <TextField
                            multiline
                            rows={4}
                            variant="outlined"
                            fullWidth
                            value={history.join('\n')}
                            inputProps={{ readOnly: true }}
                        />
                    </Paper>
                    <Button variant="contained" color="primary" onClick={startScanning} disabled={scanning}>
                        スキャン開始
                    </Button>
                    <Button variant="contained" color="secondary" onClick={stopScanning} disabled={!scanning}>
                        スキャン停止
                    </Button>
                    <Button variant="contained" onClick={toggleMode}>
                        {continuousMode ? "単発読み取り" : "連続読み取り"}
                    </Button>
                </Container>
            );
        };

        ReactDOM.render(<BarcodeReader />, document.getElementById("root"));
    </script>
</body>
</html>