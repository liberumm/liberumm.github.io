<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>バーコードリーダー</title>

    <!-- ReactとReactDOMをCDNから読み込む -->
    <script src="https://cdn.jsdelivr.net/npm/react@17/umd/react.development.js" crossorigin></script>
    <script src="https://cdn.jsdelivr.net/npm/react-dom@17/umd/react-dom.development.js" crossorigin></script>

    <!-- Babelを読み込み -->
    <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7/babel.min.js"></script>

    <!-- MUI CoreのCSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@mui/material@5.13.0/umd/material-ui.development.css">
    
    <!-- MUI CoreのJS -->
    <script src="https://cdn.jsdelivr.net/npm/@mui/material@5.13.0/umd/material-ui.development.js" crossorigin></script>
    
    <script src="https://unpkg.com/@ericblade/quagga2@1.7.4/dist/quagga.min.js"></script>
    <style>
        /* スタイルを定義 */
        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            background-color: #f0f0f0;
            padding: 0 10px; /* サイドのパディングを追加 */
        }
        #my_quagga {
            width: 100%; /* 幅を100%に設定 */
            max-width: 600px; /* 最大幅を600pxに設定 */
            height: 40vh; /* 高さをビューポートの40%に設定 */
            position: relative;
            background-color: silver;
            border-radius: 8px; /* 角を丸める */
        }
        .container {
            width: 100%;
            max-width: 600px; /* 最大幅を600pxに設定 */
            margin: 0 auto; /* 中央揃え */
        }
    </style>
</head>
<body>
    <div id="root"></div> <!-- Reactのルートコンテナ -->

    <script type="text/babel">
        const { useState, useEffect } = React;
        const { Button, Container, Typography, TextField, Paper } = MaterialUI;

        const BarcodeReader = () => {
            const [scanning, setScanning] = useState(false);
            const [continuousMode, setContinuousMode] = useState(true); // 初期は連続読み取りモード
            const [history, setHistory] = useState([]); // 読み取った履歴

            useEffect(() => {
                if (scanning) {
                    Quagga.init({
                        inputStream: {
                            name: "Live",
                            type: "LiveStream",
                            target: document.getElementById("my_quagga"), // 映像を表示する要素
                        },
                        decoder: {
                            readers: ["ean_reader"], // 認識するバーコードの種類
                        },
                    }, (err) => {
                        if (err) {
                            console.error(err); // エラーが発生した場合はログ出力
                            return;
                        }
                        console.log("Initialization finished!!");
                        Quagga.start(); // スキャン開始
                    });

                    // バーコードが検出された場合の処理
                    Quagga.onDetected(result => {
                        const code = result.codeResult.code; // 認識されたバーコードのコード
                        const timestamp = new Date().toLocaleString(); // 現在の日時を取得
                        setHistory(prevHistory => [...prevHistory, `No.${prevHistory.length + 1}: ${code} (読み取り時刻: ${timestamp})`]);
                        if (!continuousMode) {
                            alert(`読み取ったバーコード: ${code}`); // 単発読み取りの場合、アラート表示
                            stopScanning(); // スキャン停止
                        }
                    });

                    // 画像処理の際に呼ばれる
                    Quagga.onProcessed(result => {
                        if (result && result.boxes) {
                            const ctx = Quagga.canvas.ctx.overlay; // オーバーレイキャンバスのコンテキストを取得
                            ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height); // 前の描画をクリア
                            // 認識されたボックスを描画
                            result.boxes.forEach(box => {
                                Quagga.ImageDebug.drawPath(box, { x: 0, y: 0 }, ctx, { color: "blue", lineWidth: 2 });
                            });
                        }
                    });
                } else {
                    Quagga.stop(); // スキャンが停止された場合
                }

                // コンポーネントのクリーンアップ
                return () => {
                    if (scanning) {
                        Quagga.stop(); // コンポーネントがアンマウントされる際にスキャンを停止
                    }
                };
            }, [scanning]);

            // スキャン開始関数
            const startScanning = () => {
                setScanning(true); // スキャンを開始
            };

            // スキャン停止関数
            const stopScanning = () => {
                setScanning(false); // スキャンを停止
            };

            // モード切り替え関数
            const toggleMode = () => {
                setContinuousMode(!continuousMode); // モードを切り替える
            };

            return (
                <Container className="container">
                    <Typography variant="h4" align="center" gutterBottom>
                        QuaggaJS バーコードリーダー
                    </Typography>
                    <div id="my_quagga" style={{ width: '100%', height: '40vh', position: 'relative', backgroundColor: 'silver' }}></div>
                    <Paper style={{ padding: '10px', margin: '10px 0' }}>
                        <Typography variant="h6">履歴</Typography>
                        <TextField
                            multiline
                            rows={4}
                            variant="outlined"
                            fullWidth
                            value={history.join('\n')} // 履歴を表示
                            inputProps={{ readOnly: true }} // 読み取り専用に設定
                        />
                    </Paper>
                    <Button variant="contained" color="primary" onClick={startScanning} disabled={scanning}>
                        スキャン開始
                    </Button>
                    <Button variant="contained" color="secondary" onClick={stopScanning} disabled={!scanning}>
                        スキャン停止
                    </Button>
                    <Button variant="contained" onClick={toggleMode}>
                        {continuousMode ? "単発読み取り" : "連続読み取り"}
                    </Button>
                </Container>
            );
        };

        // ReactコンポーネントをDOMにレンダリング
        ReactDOM.render(<BarcodeReader />, document.getElementById("root"));
    </script>
</body>
</html>
