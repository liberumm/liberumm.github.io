<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="shortcut icon" href="./images/favicon.ico">
    <title>QuaggaJS with React and Material-UI</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@mui/material@5.13.0/umd/material-ui.development.css">
    <style>
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh; /* Full height */
            margin: 0;
            background-color: #333; /* Dark background for contrast */
        }
        #my_quagga {
            width: 100%; /* Responsive width */
            max-width: 320px; /* Max width for quagga */
            height: auto; /* Responsive height */
            margin: 5px; 
            position: relative;
            background-color: silver; /* Canvas background color */
        }
        #my_quagga video, #my_quagga canvas {
            width: 100%; 
            height: 100%; 
            position: absolute; 
            top: 0; 
            left: 0;
        }
        .error {
            color: red;
        }
        .history {
            margin-top: 20px;
            color: white;
            text-align: left;
            max-height: 150px; /* Limit height of history area */
            overflow-y: auto; /* Enable scrolling if too many items */
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/react@17/umd/react.development.js" crossorigin></script>
    <script src="https://cdn.jsdelivr.net/npm/react-dom@17/umd/react-dom.development.js" crossorigin></script>
    <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mui/material@5.13.0/umd/material-ui.development.js" crossorigin></script>
    <script src="//unpkg.com/@ericblade/quagga2@1.7.4/dist/quagga.min.js"></script>
    <script src="//cdn.jsdelivr.net/gh/mtaketani113/jquery-barcode@master/jquery-barcode.js"></script>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useEffect, useRef, useState } = React;
        const { Button, Container, Typography, Switch, Modal } = MaterialUI;

        function BarcodeScanner() {
            const quaggaRef = useRef(null);
            const [result, setResult] = useState("***"); // 認識したバーコードの値
            const [errorMessage, setErrorMessage] = useState(""); // エラーメッセージ
            const [history, setHistory] = useState([]); // バーコード認識履歴
            const [singleMode, setSingleMode] = useState(false); // 単発モードのフラグ
            const [modalOpen, setModalOpen] = useState(false); // モーダル表示のフラグ
            const [selectedHistory, setSelectedHistory] = useState(null); // 選択した履歴

            // コンポーネントのアンマウント時にQuaggaを停止
            useEffect(() => {
                return () => {
                    Quagga.stop();
                };
            }, []);

            // スキャナー開始
            const startScanner = () => {
                console.log("Start!!");
                setErrorMessage(""); // 以前のエラーをクリア

                // Quaggaの初期化
                Quagga.init({
                    inputStream: {
                        name: "Live",
                        type: "LiveStream",
                        target: quaggaRef.current
                    },
                    decoder: {
                        readers: ["ean_reader"] // 読み取るバーコードの形式
                    }
                }, (err) => {
                    if (err) {
                        console.log(err);
                        setErrorMessage("初期化エラー: " + err.message);
                        return;
                    }
                    console.log("Initialization finished!!");
                    Quagga.start(); // スキャン開始
                });

                // 読み取り処理
                Quagga.onProcessed((result) => {
                    if (result == null || typeof(result) !== "object" || result.boxes === undefined) return;
                    const ctx = Quagga.canvas.ctx.overlay;
                    const canvas = Quagga.canvas.dom.overlay;
                    ctx.clearRect(0, 0, parseInt(canvas.width), parseInt(canvas.height));
                    Quagga.ImageDebug.drawPath(result.box, 
                        { x: 0, y: 1 }, ctx, { color: "blue", lineWidth: 5 });
                });

                // 認識結果
                Quagga.onDetected((result) => {
                    console.log(result.codeResult.code);
                    setResult(result.codeResult.code); // 認識したバーコードの値を設定
                    const timestamp = new Date().toLocaleString(); // タイムスタンプを取得

                    // 履歴を追加（最大5件）
                    setHistory(prev => {
                        const newHistory = [...prev, { number: prev.length + 1, code: result.codeResult.code, timestamp }];
                        return newHistory.length > 5 ? newHistory.slice(1) : newHistory; // 5件を超えたら古い履歴を削除
                    });

                    // 単発読み込みモードの場合はモーダルを表示
                    if (singleMode) {
                        setSelectedHistory({ code: result.codeResult.code, timestamp }); // モーダル用のデータを設定
                        setModalOpen(true);
                        Quagga.stop(); // スキャンを停止
                    } else {
                        document.querySelector("#my_barcode div").barcode(result.codeResult.code, "ean13");
                    }
                });
            };

            // スキャナー停止
            const stopScanner = () => {
                console.log("Stop!!");
                Quagga.stop();
            };

            // モード切り替え
            const handleToggle = () => {
                setSingleMode(!singleMode);
            };

            // モーダルを閉じる
            const handleCloseModal = () => {
                setModalOpen(false);
            };

            // 履歴をタップした時の処理
            const handleHistoryClick = (item) => {
                setSelectedHistory(item);
                setModalOpen(true);
            };

            return (
                <Container style={{ textAlign: 'center', backgroundColor: 'gray', color: 'white', padding: '20px', borderRadius: '20px', maxWidth: '400px', width: '100%' }}>
                    <Typography variant="h4">= QuaggaJS =</Typography>
                    <div id="my_quagga" ref={quaggaRef} style={{ textAlign: 'center', width: '100%', maxWidth: '320px', height: '240px', backgroundColor: 'silver' }}></div>
                    <div>
                        <Button variant="contained" color="primary" onClick={startScanner}>Start</Button>
                        <Button variant="contained" color="secondary" onClick={stopScanner}>Stop</Button>
                        <div>
                            <Typography variant="body1" style={{ display: 'inline', marginRight: '10px' }}>
                                {singleMode ? '単発読み込みモード' : '連続読み込みモード'}
                            </Typography>
                            <Switch checked={singleMode} onChange={handleToggle} />
                        </div>
                    </div>
                    <div id="my_quagga" ref={quaggaRef}></div>
                    <Typography variant="h6" id="my_result">{result}</Typography>
                    <div id="my_barcode">
                        <div>***</div>
                    </div>
                    {errorMessage && <Typography variant="body1" className="error">{errorMessage}</Typography>}
                    <div className="history" onClick={() => handleHistoryClick(selectedHistory)}>
                        <Typography variant="h6">認識履歴</Typography>
                        <ul>
                            {history.map(item => (
                                <li key={item.number}>
                                    {item.number}: {item.code} (時刻: {item.timestamp})
                                </li>
                            ))}
                        </ul>
                    </div>
                    <Modal
                        open={modalOpen}
                        onClose={handleCloseModal}
                        aria-labelledby="modal-title"
                        aria-describedby="modal-description"
                    >
                        <Container style={{ backgroundColor: 'white', padding: '20px', borderRadius: '10px', maxWidth: '300px', margin: '100px auto', textAlign: 'center' }}>
                            <Typography id="modal-title" variant="h6">バーコードを認識しました</Typography>
                            <Typography id="modal-description" variant="body1">{selectedHistory ? `${selectedHistory.code} (時刻: ${selectedHistory.timestamp})` : ''}</Typography>
                            <Button onClick={handleCloseModal} variant="contained" color="primary" style={{ marginTop: '20px' }}>閉じる</Button>
                        </Container>
                    </Modal>
                </Container>
            );
        }

        ReactDOM.render(<BarcodeScanner />, document.getElementById('root'));
    </script>
</body>
</html>
