<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>PWA App Badge</title>
    <link rel="manifest" href="./manifest.json" />
    <!-- Materialize CSS (Material UIライクなスタイル) -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" rel="stylesheet">
    <!-- Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  </head>
  <body>
    <!-- AppBar (ナビゲーションバー) -->
    <nav>
      <div class="nav-wrapper">
        <a href="#" class="brand-logo center">My PWA App</a>
      </div>
    </nav>

    <main class="container" style="margin-top: 20px;">
      <div class="row">
        <div class="col s12">
          <h5>Notification Permission</h5>
          <!-- 通知状態をアイコン付きで表示 -->
          <p id="permission"></p>
        </div>
      </div>

      <div class="row">
        <!-- 各機能ボタン -->
        <div class="col s12 m4 l2">
          <button class="btn waves-effect waves-light push">Push</button>
        </div>
        <div class="col s12 m4 l2">
          <button class="btn waves-effect waves-light badge">Badge</button>
        </div>
        <div class="col s12 m4 l2">
          <button class="btn waves-effect waves-light clear">Clear</button>
        </div>
        <div class="col s12 m4 l2">
          <button class="btn waves-effect waves-light reload">Reload</button>
        </div>
        <div class="col s12 m4 l2">
          <button class="btn waves-effect waves-light default">Default</button>
        </div>
        <div class="col s12 m4 l2">
          <button class="btn waves-effect waves-light push-notification">Push Notification</button>
        </div>
        <div class="col s12 m4 l2">
          <button class="btn waves-effect waves-light vibration-notification">Vibration Notification</button>
        </div>
      </div>
    </main>

    <!-- Footer -->
    <footer class="page-footer">
      <div class="container">
        <div class="row">
          <div class="col s12">
            <h6 class="white-text">Footer Content</h6>
            <p class="grey-text text-lighten-4">ここにお好きな情報を記載できます。</p>
          </div>
        </div>
      </div>
      <div class="footer-copyright">
        <div class="container">
          © 2025 My PWA App
        </div>
      </div>
    </footer>

    <!-- Materialize JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
    <script type="module">
      // サービスワーカーの登録（HTTPSまたはlocalhostで動作）
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('./service-worker.js')
          .then(function(registration) {
            console.log('Service Worker registered with scope:', registration.scope);
          })
          .catch(function(error) {
            console.error('Service Worker registration failed:', error);
          });
      }

      document.addEventListener('DOMContentLoaded', () => {
        updatePermissionDisplay();
      });

      // 通知の許可状態をアイコン付きで更新する関数
      function updatePermissionDisplay() {
        if (!window.Notification) {
          document.getElementById('permission').innerHTML =
            '<i class="material-icons">error</i> Your browser does not support notifications.';
          return;
        }
        let permission = Notification.permission;
        let icon;
        if (permission === 'granted') {
          icon = 'notifications_active';
        } else if (permission === 'denied') {
          icon = 'notifications_off';
        } else {
          icon = 'notifications';
        }
        document.getElementById('permission').innerHTML =
          `<i class="material-icons">${icon}</i> Notification permission: ${permission}`;
      }

      // 各ボタンのイベントリスナー設定
      document.querySelector('.push').addEventListener('click', requestPermission);
      document.querySelector('.badge').addEventListener('click', () => {
        navigator.setAppBadge(Math.floor(Math.random() * 9) + 1);
      });
      document.querySelector('.clear').addEventListener('click', () => {
        navigator.setAppBadge(0);
      });
      document.querySelector('.reload').addEventListener('click', () => {
        location.reload();
      });
      document.querySelector('.default').addEventListener('click', resetDefault);
      document.querySelector('.push-notification').addEventListener('click', showPushNotification);
      document.querySelector('.vibration-notification').addEventListener('click', showNotification);

      // 通知許可をリクエストする
      function requestPermission() {
        if (!window.Notification) return;
        Notification.requestPermission().then(() => {
          updatePermissionDisplay();
        });
      }

      // バッジと通知表示を初期状態にリセット
      function resetDefault() {
        navigator.setAppBadge(0);
        updatePermissionDisplay();
      }

      // 通常のプッシュ通知を表示
      function showPushNotification() {
        if (!window.Notification) {
          alert('Your browser does not support notifications.');
          return;
        }
        if (Notification.permission === 'granted') {
          new Notification('Push Notification', {
            body: 'This is a push notification displayed from the app.'
          });
        } else {
          alert('Please allow notifications first.');
        }
      }

      // ユーザー提供の関数：バイブレーション付き通知をサービスワーカー経由で表示
      function showNotification() {
        Notification.requestPermission((result) => {
          if (result === "granted") {
            navigator.serviceWorker.ready.then((registration) => {
              registration.showNotification("バイブレーションの例", {
                body: "ブンブン! ブンブン!",
                icon: "../images/touch/chrome-touch-icon-192x192.png",
                vibrate: [200, 100, 200, 100, 200, 100, 200],
                tag: "vibration-sample",
              });
            });
          }
        });
      }
    </script>
  </body>
</html>