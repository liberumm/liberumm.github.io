<!DOCTYPE html>
<html>
<head>
  <title>React Leaflet with GSI Tiles</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <!-- osmtogeojson JS (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/osmtogeojson@3.0.0-beta.5/osmtogeojson.min.js"></script>

  <!-- turf.js for spatial operations -->
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

  <!-- SheetJS for Excel handling -->
  <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
  <!-- PapaParse for CSV handling -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.0/papaparse.min.js"></script>

  <style>
    body { 
      margin: 0; 
      padding: 0; 
      font-family: Arial, sans-serif;
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
    }

    /* 検索コントロールパネル */
    #controls {
      padding: 15px;
      background: #f9f9f9;
      border-bottom: 1px solid #ccc;
      z-index: 1000;
    }

    /* 地図エリア */
    #map {
      height: 50vh;
      width: 100%;
      position: relative;
      z-index: 1;
    }

    /* 半径コントロール */
    .radius-controls {
      padding: 10px;
      background: #f8f9f9;
      border-bottom: 1px solid #ccc;
    }

    /* タブとテーブルのコンテナ */
    .data-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .tab-container {
      background: #fff;
      border-bottom: 1px solid #ccc;
    }

    #dataEditor {
      flex: 1;
      overflow: auto;
    }

    body { margin: 0; padding: 0; font-family: Arial, sans-serif; }
    #map { width: 100%; height: 55vh; }
    #controls {
      width: 100%;
      height: 15vh;
      background: #f9f9f9;
      padding: 10px;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      border-bottom: 1px solid #ccc;
    }
    .input-group {
      margin: 5px 0;
      display: flex;
      align-items: center;
    }
    .input-group label {
      margin-right: 10px;
      font-weight: bold;
    }
    #addressInput, #latInput, #lonInput {
      width: 300px;
      padding: 8px;
      font-size: 16px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    #latInput, #lonInput {
      width: 140px;
    }
    #searchButton {
      padding: 8px 16px;
      margin-top: 10px;
      font-size: 16px;
      border: none;
      border-radius: 4px;
      background-color: #66c2a5;
      color: white;
      cursor: pointer;
    }
    #searchButton:hover {
      background-color: #559f8f;
    }
    #info {
      position: absolute;
      top: 60px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255, 255, 255, 0.9);
      padding: 10px;
      border-radius: 5px;
      z-index: 1000;
      font-size: 14px;
      display: none;
      max-width: 80%;
      word-wrap: break-word;
    }
    .radio-group {
      margin: 10px 0;
      display: flex;
      align-items: center;
    }
    .radio-group input {
      margin-right: 5px;
    }
    .loading {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(255, 255, 255, 0.9);
      padding: 20px;
      border-radius: 5px;
      z-index: 1000;
    }
    #resultStats {
      margin-top: 10px;
      font-size: 0.9em;
      color: #666;
    }
    .error {
      color: #d32f2f;
      background: #ffebee;
      padding: 10px;
      border-radius: 4px;
      margin-top: 10px;
    }
    #dataEditor {
      width: 100%;
      height: 30vh;
      background: #ffffff;
      padding: 10px;
      box-sizing: border-box;
      border-top: 1px solid #ccc;
    }
    .data-grid {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    .data-grid th, .data-grid td {
      border: 1px solid #ddd;
      padding: 4px;
      text-align: left;
      font-size: 12px;
    }
    .data-grid input {
      width: 90%;
      padding: 2px;
      font-size: 12px;
    }
    .data-grid th {
      background-color: #f5f5f5;
    }
    .data-actions {
      margin: 10px 0;
    }
    .data-actions button {
      margin-right: 10px;
      padding: 5px 10px;
      background-color: #66c2a5;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .delete-row {
      color: #d32f2f;
      cursor: pointer;
    }
    .search-address-btn {
      padding: 2px 4px;
      margin-left: 4px;
      background: #66c2a5;
      color: white;
      border: none;
      border-radius: 3px;
      cursor: pointer;
    }
    .data-grid tr:hover {
      background-color: #f5f5f5;
      cursor: pointer;
    }
    /* タブ用スタイル */
    .tab-container {
      width: 100%;
      margin-top: 10px;
    }
    
    .tab-buttons {
      display: flex;
      border-bottom: 1px solid #ccc;
    }
    
    .tab-button {
      padding: 10px 20px;
      border: none;
      background: none;
      cursor: pointer;
    }
    
    .tab-button.active {
      border-bottom: 2px solid #66c2a5;
      font-weight: bold;
    }
    
    .tab-content {
      display: none;
      padding: 15px;
    }
    
    .tab-content.active {
      display: block;
    }

    /* 統計情報表示の改善 */
    #statsContainer {
      position: fixed;
      top: 10px;
      right: 10px;
      background: rgba(255, 255, 255, 0.9);
      padding: 10px;
      border-radius: 5px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      z-index: 1000;
    }

    /* エクスポート/インポートボタン */
    .data-actions {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
    }

    .action-button {
      padding: 5px 10px;
      background: #66c2a5;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    .action-button:hover {
      background: #559f8f;
    }

    /* テーブル列幅の調整 */
    .data-grid th, .data-grid td {
      padding: 4px;
      font-size: 12px;
    }
    .data-grid th:nth-child(1), .data-grid td:nth-child(1) { width: 150px; } /* 名称 */
    .data-grid th:nth-child(2), .data-grid td:nth-child(2) { width: 100px; } /* 開始日 */
    .data-grid th:nth-child(3), .data-grid td:nth-child(3) { width: 100px; } /* 終了日 */
    .data-grid th:nth-child(4), .data-grid td:nth-child(4) { width: 80px; } /* 売上 */
    .data-grid th:nth-child(5), .data-grid td:nth-child(5) { width: 80px; } /* 客数 */
    .data-grid th:nth-child(6), .data-grid td:nth-child(6) { width: 80px; } /* 面積 */
    .data-grid th:nth-child(7), .data-grid td:nth-child(7) { width: 200px; } /* 住所 */
    .data-grid th:nth-child(8), .data-grid td:nth-child(8) { width: 90px; } /* 緯度 */
    .data-grid th:nth-child(9), .data-grid td:nth-child(9) { width: 90px; } /* 経度 */
    .data-grid th:nth-child(10), .data-grid td:nth-child(10) { width: 70px; } /* 半径1 */
    .data-grid th:nth-child(11), .data-grid td:nth-child(11) { width: 70px; } /* 半径2 */
    .data-grid th:nth-child(12), .data-grid td:nth-child(12) { width: 70px; } /* 半径3 */
    .data-grid th:nth-child(13), .data-grid td:nth-child(13) { width: 70px; } /* 色 */
    .data-grid th:nth-child(14), .data-grid td:nth-child(14) { width: 50px; } /* 操作 */

    /* マーカーポップアップのスタイル */
    .marker-popup {
      min-width: 300px;
    }
    .marker-popup h3 {
      margin: 0 0 10px 0;
      color: #333;
    }
    .marker-popup-content {
      margin-bottom: 10px;
    }
    .marker-popup-links {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }
    .marker-popup-links a {
      padding: 5px 10px;
      background: #66c2a5;
      color: white;
      text-decoration: none;
      border-radius: 3px;
    }
    .marker-popup-links a:hover {
      background: #559f8f;
    }

    /* スプレッドシート風テーブルスタイル */
    .data-grid {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
      background: white;
    }

    .data-grid th, .data-grid td {
      border: 1px solid #e0e0e0;
      padding: 6px;
      position: relative;
    }

    .data-grid th {
      background: #f5f5f5;
      font-weight: bold;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .data-grid tr:hover {
      background-color: #f8f9fa;
    }

    .data-grid input, .data-grid select {
      width: 100%;
      padding: 4px;
      border: none;
      background: transparent;
      font-size: 12px;
    }

    .data-grid input:focus, .data-grid select:focus {
      outline: none;
      background: #e8f0fe;
    }

    /* 色選択用のスタイル */
    .color-input-group {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .color-input-group input[type="color"] {
      width: 25px;
      height: 25px;
      padding: 0;
      border: none;
    }

    /* テーブルのヘッダー固定 */
    #dataEditor {
      overflow: auto;
      position: relative;
    }

    /* テーブルの列幅調整 */
    .data-grid th:nth-child(1), .data-grid td:nth-child(1) { min-width: 120px; } /* 名称 */
    .data-grid th:nth-child(2), .data-grid td:nth-child(2) { min-width: 100px; } /* 開始日 */
    .data-grid th:nth-child(3), .data-grid td:nth-child(3) { min-width: 100px; } /* 終了日 */
    .data-grid th:nth-child(4), .data-grid td:nth-child(4) { min-width: 80px; } /* 売上 */
    .data-grid th:nth-child(5), .data-grid td:nth-child(5) { min-width: 80px; } /* 客数 */
    .data-grid th:nth-child(6), .data-grid td:nth-child(6) { min-width: 80px; } /* 面積 */
    .data-grid th:nth-child(7), .data-grid td:nth-child(7) { min-width: 200px; } /* 住所 */
    .data-grid th:nth-child(8), .data-grid td:nth-child(8) { min-width: 90px; } /* 緯度 */
    .data-grid th:nth-child(9), .data-grid td:nth-child(9) { min-width: 90px; } /* 経度 */
    .data-grid th[data-radius], .data-grid td[data-radius] { min-width: 120px; } /* 半径+色 */

    .radius-controls {
      display: flex;
      gap: 20px;
      align-items: center;
      margin: 10px 0;
      padding: 10px;
      background: #f8f9fa;
      border-radius: 4px;
    }

    .radius-control-group {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .radius-control-group label {
      font-weight: bold;
      min-width: 60px;
    }

    .radius-control-group input[type="number"] {
      width: 80px;
      padding: 4px;
    }

    .radius-control-group input[type="color"] {
      width: 30px;
      height: 30px;
      padding: 0;
      border: none;
    }

    /* チェックボックスとボタン列のスタイル */
    .data-grid th:first-child,
    .data-grid td:first-child {
      width: 30px;
      text-align: center;
    }

    .data-grid th:nth-child(2),
    .data-grid td:nth-child(2) {
      width: 50px;
      text-align: center;
    }

    .center-map-btn {
      background: none;
      border: none;
      cursor: pointer;
      padding: 2px;
      font-size: 20px;
    }

    /* レスポンシブデザインの基本設定 */
    .container {
      display: grid;
      grid-template-rows: auto 1fr auto;
      height: 100vh;
      overflow: hidden;
    }

    /* コントロールパネルのスタイル更新 */
    #controls {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 1000;
      background: rgba(255, 255, 255, 0.9);
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      max-width: 400px;
      height: auto;
    }

    /* 地図とデータエディタのレイアウト */
    #map {
      height: 60vh;
      width: 100%;
      z-index: 1;
    }

    #dataEditor {
      height: 40vh;
      overflow: auto;
    }

    /* テーブル列幅の最適化 */
    .data-grid th, .data-grid td {
      padding: 6px;
      font-size: 12px;
    }
    .data-grid th:nth-child(1), .data-grid td:nth-child(1) { width: 30px; } /* チェックボックス */
    .data-grid th:nth-child(2), .data-grid td:nth-child(2) { width: 40px; } /* 表示ボタン */
    .data-grid th:nth-child(3), .data-grid td:nth-child(3) { width: 120px; } /* 名称 */
    .data-grid th:nth-child(4), .data-grid td:nth-child(4) { width: 90px; } /* 開始日 */
    .data-grid th:nth-child(5), .data-grid td:nth-child(5) { width: 90px; } /* 終了日 */
    .data-grid th:nth-child(6), .data-grid td:nth-child(6) { width: 70px; } /* 売上 */
    .data-grid th:nth-child(7), .data-grid td:nth-child(7) { width: 70px; } /* 客数 */
    .data-grid th:nth-child(8), .data-grid td:nth-child(8) { width: 70px; } /* 面積 */
    .data-grid th:nth-child(9), .data-grid td:nth-child(9) { width: 200px; } /* 住所 */
    
    /* 住所検索ボタンのスタイル */
    .address-search-group {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .address-search-btn {
      padding: 2px 8px;
      background: #66c2a5;
      color: white;
      border: none;
      border-radius: 3px;
      cursor: pointer;
      font-size: 12px;
    }

    /* テーブルのスタイル修正 */
    .data-grid {
      width: 100%;
      border-collapse: collapse;
      border: 1px solid #ddd;
    }

    .data-grid th, 
    .data-grid td {
      border: 1px solid #ddd;
      padding: 6px;
      vertical-align: middle;
    }

    .data-grid th {
      background-color: #f5f5f5;
      border-bottom: 2px solid #ddd;
    }

    .data-grid input {
      width: 100%;
      box-sizing: border-box;
      padding: 4px;
      border: none;
      background: transparent;
    }

    .data-grid tr:hover {
      background-color: #f8f9fa;
    }

    /* 住所検索グループのスタイル修正 */
    .address-search-group {
      display: flex;
      align-items: center;
      gap: 4px;
      width: 100%;
    }

    .address-search-group input {
      flex: 1;
      min-width: 0;
    }

    .address-search-btn {
      flex-shrink: 0;
      padding: 4px 8px;
      margin-left: 4px;
    }
  </style>
</head>
<body>
  <!-- 検索コントロール -->
  <div id="controls">
    <div class="radio-group">
      <input type="radio" id="searchByAddress" name="searchType" value="address" checked>
      <label for="searchByAddress">住所で検索</label>
      <input type="radio" id="searchByCoords" name="searchType" value="coords" style="margin-left: 20px;">
      <label for="searchByCoords">緯度経度で検索</label>
    </div>
    <div class="input-group" id="addressGroup">
      <label for="addressInput">住所:</label>
      <input type="text" id="addressInput" placeholder="住所を入力してください" />
    </div>
    <div class="input-group" id="coordsGroup" style="display: none;">
      <label for="latInput">緯度:</label>
      <input type="text" id="latInput" placeholder="例: 35.6871682" />
      <label for="lonInput" style="margin-left: 10px;">経度:</label>
      <input type="text" id="lonInput" placeholder="例: 139.710645" />
    </div>
    <button id="searchButton">検索</button>
    <div id="resultStats"></div>
  </div>

  <!-- 地図 -->
  <div id="map"></div>

  <!-- 半径コントロール -->
  <div class="radius-controls">
    <div class="radius-control-group">
      <label>半径1:</label>
      <input type="number" id="globalRadius1" value="500" min="0" max="5000">
      <input type="color" id="globalColor1" value="#66c2a5">
    </div>
    <div class="radius-control-group">
      <label>半径2:</label>
      <input type="number" id="globalRadius2" value="1000" min="0" max="5000">
      <input type="color" id="globalColor2" value="#fc8d62">
    </div>
    <div class="radius-control-group">
      <label>半径3:</label>
      <input type="number" id="globalRadius3" value="1500" min="0" max="5000">
      <input type="color" id="globalColor3" value="#8da0cb">
    </div>
    <button id="applyGlobalRadius" class="action-button">一括適用</button>
  </div>

  <!-- データ表示エリア -->
  <div class="data-container">
    <!-- タブ -->
    <div class="tab-container">
      <div class="tab-buttons">
        <button class="tab-button active" data-tab="plots">プロット地点</button>
        <button class="tab-button" data-tab="polygons">町丁目ポリゴン</button>
      </div>
    </div>

    <!-- テーブル -->
    <div id="dataEditor">
      <!-- タブコンテンツ -->
      <div id="plotsTab" class="tab-content active">
        <div class="data-actions">
          <button class="action-button" id="addPlotRow">新規追加</button>
          <button class="action-button" id="applyPlots">地図に反映</button>
          <button class="action-button" id="exportPlots">エクスポート</button>
          <input type="file" id="importPlots" accept=".csv,.xlsx" style="display: none;">
          <button class="action-button" onclick="document.getElementById('importPlots').click()">インポート</button>
        </div>
        <table class="data-grid">
          <thead>
            <tr>
              <th><input type="checkbox" id="selectAll"></th>
              <th>表示</th>
              <th>名称</th>
              <th>開始日</th>
              <th>終了日</th>
              <th>売上</th>
              <th>客数</th>
              <th>面積</th>
              <th>住所</th>
              <th>緯度</th>
              <th>経度</th>
              <th data-radius="1">半径1 & 色</th>
              <th data-radius="2">半径2 & 色</th>
              <th data-radius="3">半径3 & 色</th>
              <th>操作</th>
            </tr>
          </thead>
          <tbody id="plotsGrid"></tbody>
        </table>
      </div>
      
      <div id="polygonsTab" class="tab-content">
        <div class="data-actions">
          <button class="action-button" id="addPolygonRow">新規追加</button>
          <button class="action-button" id="applyPolygons">地図に反映</button>
          <button class="action-button" id="exportPolygons">エクスポート</button>
          <input type="file" id="importPolygons" accept=".csv,.xlsx" style="display: none;">
          <button class="action-button" onclick="document.getElementById('importPolygons').click()">インポート</button>
        </div>
        <table class="data-grid">
          <thead>
            <tr>
              <th>町丁目名</th>
              <th>ポリゴンデータ</th>
              <th>色</th>
              <th>操作</th>
            </tr>
          </thead>
          <tbody id="polygonsGrid"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- 統計情報表示用の要素 -->
  <div id="statsContainer" style="display: none;">
    <div id="polygonStats"></div>
  </div>

  <script>
    // 初期設定（渋谷）
    let centerLat = 35.6580;
    let centerLon = 139.7016;
    const radius = 1500; // 半径1500m

    // 初期ポイントのデータ
    const defaultPoint = {
      name: '渋谷駅',
      lat: 35.6580,
      lon: 139.7016,
      radius: 1500,
      color: '#66c2a5'
    };

    // 地図の初期化
    const map = L.map('map').setView([centerLat, centerLon], 14);

    // 背景地図：国土地理院の地理院地図
    L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="https://maps.gsi.go.jp/">国土地理院</a>'
    }).addTo(map);

    // 初期円の描画
    let searchCircle = L.circle([centerLat, centerLon], {
      radius: radius, // 半径1500m
      color: 'blue', // 境界線の色
      weight: 2,     // 境界線の太さ
      fillOpacity: 0.1 // 塗りつぶしの透明度
    }).addTo(map);

    // キャッシュを導入してAPI呼び出しを最適化
    const cache = new Map();
    
    // デバウンス関数
    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    // Overpass APIクエリを生成する関数を修正
    function generateOverpassQuery(lat, lon, radius) {
      return `
[out:json][timeout:25];
(
  way["boundary"="administrative"]["admin_level"~"^(8|9|10)$"](around:${radius},${lat},${lon});
  relation["boundary"="administrative"]["admin_level"~"^(8|9|10)$"](around:${radius},${lat},${lon});
);
out body;
>;
out skel qt;`;
    }

    const overpassApiUrl = 'https://overpass-api.de/api/interpreter';

    // 情報表示用要素
    const infoDiv = document.getElementById('info');

    // 検索した住所のマーカーを保持
    let addressMarker = null;

    // GeoJSONデータの描画を修正
    function renderGeoJSON(geojsonData) {
      // 既存のポリゴンレイヤーを削除
      if (polygonLayer && map.hasLayer(polygonLayer)) {
        map.removeLayer(polygonLayer);
      }

      // GeoJSONを地図に追加
      polygonLayer = L.geoJSON(geojsonData, {
        style: function(feature) {
          return {
            fillColor: '#66c2a5',
            fillOpacity: 0.3,
            color: '#1b7837',
            weight: 2
          };
        },
        onEachFeature: function(feature, layer) {
          const name = feature.properties?.tags?.name || '不明';
          const adminLevel = feature.properties?.tags?.admin_level || '不明';
          
          // ポップアップコンテンツを作成
          let popupContent = `
            <div class="marker-popup">
              <h3>${name}</h3>
              <p><strong>Admin Level:</strong> ${adminLevel}</p>
            </div>`;

          try {
            const centroid = turf.centroid(feature);
            const lat = centroid.geometry.coordinates[1].toFixed(6);
            const lon = centroid.geometry.coordinates[0].toFixed(6);
            popupContent += `
              <p><strong>中心点緯度:</strong> ${lat}</p>
              <p><strong>中心点経度:</strong> ${lon}</p>`;
          } catch (error) {
            console.error('セントロイド計算エラー:', error);
          }

          layer.bindPopup(popupContent);
        }
      }).addTo(map);

      // 統計情報を更新
      updateStats(geojsonData);
    }

    // Overpass APIからデータを取得する関数を修正
    async function fetchOverpassData(lat, lon, radius) {
      const cacheKey = `${lat},${lon},${radius}`;
      if (cache.has(cacheKey)) {
        return cache.get(cacheKey);
      }

      try {
        const query = generateOverpassQuery(lat, lon, radius);
        console.log('Overpass Query:', query); // デバッグ用

        const response = await fetch(overpassApiUrl, {
          method: 'POST',
          headers: {'Content-Type': 'application/x-www-form-urlencoded'},
          body: 'data=' + encodeURIComponent(query)
        });

        if (!response.ok) throw new Error('Network response was not ok');
        
        const data = await response.json();
        console.log('Overpass Response:', data); // デバッグ用
        
        const geojsonData = osmtogeojson(data);
        console.log('Converted GeoJSON:', geojsonData); // デバッグ用
        
        cache.set(cacheKey, geojsonData);
        return geojsonData;
      } catch (error) {
        console.error('Overpassデータ取得エラー:', error);
        throw new Error('データの取得に失敗しました: ' + error.message);
      }
    }

    // 国土地理院のジオコーディングAPIを使用して住所から緯度経度を取得する関数
    function geocodeAddressGSI(address) {
      // 国土地理院のジオコーディングAPIエンドポイント
      const gsiGeocoderUrl = `https://msearch.gsi.go.jp/address-search/AddressSearch?q=${encodeURIComponent(address)}`;

      console.log('GSI ジオコーディングリクエスト URL:', gsiGeocoderUrl); // デバッグログ

      return fetch(gsiGeocoderUrl)
        .then(response => {
          if (!response.ok) {
            throw new Error('Network response was not ok: ' + response.statusText);
          }
          return response.json();
        })
        .then(data => {
          // デバッグ用ログ
          console.log('取得したGSIジオコーディングデータ:', data);

          if (!data || data.length === 0) {
            throw new Error('住所が見つかりませんでした。');
          }

          // 「東京都」を含む結果を優先的にフィルタリング
          const tokyoResults = data.filter(result => {
            return result.address && result.address.includes('東京都');
          });

          let selectedResult;

          if (tokyoResults.length > 0) {
            // 「東京都」を含む最初の結果を選択
            selectedResult = tokyoResults[0];
          } else {
            // 「東京都」を含まない場合は最初の結果を使用
            selectedResult = data[0];
          }

          const coordinates = selectedResult.geometry.coordinates; // [経度, 緯度]

          // displayNameの取得方法を修正
          const displayName = selectedResult.address || address;

          console.log('ジオコーディング結果:', coordinates, displayName); // デバッグログ

          return {
            lat: coordinates[1],
            lon: coordinates[0],
            displayName: displayName
          };
        });
    }

    // 緯度経度を使用して地図を更新する関数
    const updateMapWithCoords = debounce(async (lat, lon, displayName = '指定座標') => {
      try {
        // 既存のレイヤーをクリア（カスタムレイヤーは維持）
        if (searchCircle) map.removeLayer(searchCircle);
        if (addressMarker) map.removeLayer(addressMarker);
        if (polygonLayer) map.removeLayer(polygonLayer);

        // 新しい表示要素を追加
        searchCircle = L.circle([lat, lon], {
          radius,
          color: 'blue',
          weight: 2,
          fillOpacity: 0.1
        }).addTo(map);

        addressMarker = L.marker([lat, lon])
          .bindPopup(`<b>検索結果:</b> ${displayName}<br><b>緯度:</b> ${lat.toFixed(6)}<br><b>経度:</b> ${lon.toFixed(6)}`)
          .addTo(map);

        // データ取得と描画
        const geojsonData = await fetchOverpassData(lat, lon, radius);
        renderGeoJSON(geojsonData);

        // 統計情報を更新
        updateStats(geojsonData);

        map.setView([lat, lon], 14);
      } catch (error) {
        showError(error.message);
      }
    }, 500);

    // 統計情報の更新
    function updateStats(geojsonData) {
      const stats = document.getElementById('polygonStats');
      const count = geojsonData.features.length;
      stats.innerHTML = `
        <strong>ポリゴン統計:</strong><br>
        取得: ${count}件<br>
        表示: ${count}件
      `;
      document.getElementById('statsContainer').style.display = 'block';
    }

    // エラー表示
    function showError(message) {
      const stats = document.getElementById('resultStats');
      stats.innerHTML = `<div class="error">${message}</div>`;
    }

    // イベントリスナーを最適化
    function initEventListeners() {
      document.getElementById('searchButton').addEventListener('click', handleSearch);
      
      ['addressInput', 'latInput', 'lonInput'].forEach(id => {
        document.getElementById(id).addEventListener('keypress', e => {
          if (e.key === 'Enter') handleSearch();
        });
      });

      // ラジオボタンの切り替え
      document.querySelectorAll('input[name="searchType"]').forEach(radio => {
        radio.addEventListener('change', () => {
          document.getElementById('addressGroup').style.display = 
            radio.value === 'address' ? 'flex' : 'none';
          document.getElementById('coordsGroup').style.display = 
            radio.value === 'coords' ? 'flex' : 'none';
        });
      });
    }

    // 検索ハンドラを統合
    async function handleSearch() {
      const searchType = document.querySelector('input[name="searchType"]:checked').value;
      
      try {
        if (searchType === 'address') {
          const address = document.getElementById('addressInput').value.trim();
          if (!address) throw new Error('住所を入力してください');
          
          const result = await geocodeAddressGSI(address);
          updateMapWithCoords(result.lat, result.lon, result.displayName);
          // 検索結果をプロット地点に追加（重複追加を防止）
          addSearchResultToPlots(result.lat, result.lon, result.displayName);
        } else {
          const lat = parseFloat(document.getElementById('latInput').value);
          const lon = parseFloat(document.getElementById('lonInput').value);
          
          if (isNaN(lat) || isNaN(lon)) throw new Error('有効な緯度経度を入力してください');
          if (lat < -90 || lat > 90) throw new Error('緯度は -90 から 90 の範囲で入力してください');
          if (lon < -180 || lon > 180) throw new Error('経度は -180 から 180 の範囲で入力してください');
          
          updateMapWithCoords(lat, lon);
          // 検索結果をプロット地点に追加
          addSearchResultToPlots(lat, lon, '座標指定地点');
        }
      } catch (error) {
        showError(error.message);
      }
    }

    // ファイル選択ハンドラ
    function handleFileSelect(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const firstSheetName = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[firstSheetName];
        const json = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

        // CSVファイルの場合
        if (file.type === 'text/csv') {
          Papa.parse(file, {
            complete: function(results) {
              console.log('CSVデータ:', results.data);
              // CSVデータの処理
            }
          });
        } else {
          console.log('Excelデータ:', json);
          // Excelデータの処理
        }
      };
      reader.readAsArrayBuffer(file);
    }

    // データ管理用の配列
    let customData = [];

    // 新規行の追加
    function addNewRow(data = null) {
      const row = document.createElement('tr');
      
      // チェックボックス列
      const checkboxTd = document.createElement('td');
      const checkbox = document.createElement('input');
      checkbox.type = 'checkbox';
      checkbox.className = 'row-selector';
      checkboxTd.appendChild(checkbox);
      row.appendChild(checkboxTd);

      // 地図中心表示ボタン列
      const centerBtnTd = document.createElement('td');
      const centerBtn = document.createElement('button');
      centerBtn.innerHTML = '📍';
      centerBtn.className = 'center-map-btn';
      centerBtn.onclick = async (e) => {
        e.stopPropagation();
        const lat = parseFloat(row.querySelector('.field-lat').value);
        const lon = parseFloat(row.querySelector('.field-lon').value);
        if (!isNaN(lat) && !isNaN(lon)) {
          map.setView([lat, lon], 14);
          await showPolygons(lat, lon); // ポリゴン表示を追加
        }
      };
      centerBtnTd.appendChild(centerBtn);
      row.appendChild(centerBtnTd);

      const fields = [
        { name: 'name', type: 'text' },
        { name: 'startDate', type: 'date' },
        { name: 'endDate', type: 'date' },
        { name: 'sales', type: 'number' },
        { name: 'customers', type: 'number' },
        { name: 'area', type: 'number' },
        { name: 'address', type: 'text' },
        { name: 'lat', type: 'number' },
        { name: 'lon', type: 'number' }
      ];

      // 基本フィールドの作成
      fields.forEach(field => {
        const td = document.createElement('td');
        const input = document.createElement('input');
        input.type = field.type;
        input.className = `field-${field.name}`;
        if (data && data[field.name]) {
          input.value = data[field.name];
        }
        td.appendChild(input);
        row.appendChild(td);
      });

      // 半径と色の入力グループを作成
      [1, 2, 3].forEach(i => {
        const td = document.createElement('td');
        td.setAttribute('data-radius', i);
        
        const group = document.createElement('div');
        group.className = 'color-input-group';

        const radiusInput = document.createElement('input');
        radiusInput.type = 'number';
        radiusInput.className = `field-radius${i}`;
        radiusInput.value = data ? data[`radius${i}`] || 500 * i : 500 * i;
        radiusInput.style.width = '50px';

        const colorInput = document.createElement('input');
        colorInput.type = 'color';
        colorInput.className = `field-color${i}`;
        colorInput.value = data ? data[`color${i}`] || getDefaultColor(i) : getDefaultColor(i);

        group.appendChild(radiusInput);
        group.appendChild(colorInput);
        td.appendChild(group);
        row.appendChild(td);
      });

      // 住所フィールドの作成を更新
      const addressTd = document.createElement('td');
      const addressGroup = document.createElement('div');
      addressGroup.className = 'address-search-group';
      
      const addressInput = document.createElement('input');
      addressInput.type = 'text';
      addressInput.className = 'field-address';
      if (data && data.address) {
        addressInput.value = data.address;
      }
      
      const searchBtn = document.createElement('button');
      searchBtn.textContent = '🔍';
      searchBtn.className = 'address-search-btn';
      searchBtn.onclick = async (e) => {
        e.preventDefault();
        e.stopPropagation();
        try {
          const addressInput = row.querySelector('.field-address');
          const nameInput = row.querySelector('.field-name');
          let searchText = '';
          
          // 住所フィールドを優先的に確認
          if (addressInput && addressInput.value.trim()) {
            searchText = addressInput.value.trim();
            console.log('住所での検索:', searchText);
          }
          // 住所が空の場合は名称フィールドを確認
          else if (nameInput && nameInput.value.trim()) {
            searchText = nameInput.value.trim();
            console.log('名称での検索:', searchText);
          }
          
          if (!searchText) {
            throw new Error('住所または名称を入力してください');
          }

          const result = await geocodeAddressGSI(searchText);
          console.log('検索結果:', result);

          // 緯度経度フィールドを更新
          const latInput = row.querySelector('.field-lat');
          const lonInput = row.querySelector('.field-lon');

          if (latInput && lonInput) {
            latInput.value = result.lat;
            lonInput.value = result.lon;

            // 住所が空の場合は取得した住所を設定
            if (!addressInput.value.trim()) {
              addressInput.value = result.displayName;
            }

            // 地図を更新
            map.setView([result.lat, result.lon], 14);
            await showPolygons(result.lat, result.lon);
            
            // 変更を地図に反映
            applyCustomData();

            // 成功メッセージを表示
            showSuccess(`検索成功: ${result.displayName}`);
          }
        } catch (error) {
          console.error('住所検索エラー:', error);
          showError(error.message);
        }
      };
      
      addressGroup.appendChild(addressInput);
      addressGroup.appendChild(searchBtn);
      addressTd.appendChild(addressGroup);
      row.appendChild(addressTd);

      // 削除ボタンの追加
      const actionTd = document.createElement('td');
      const deleteBtn = document.createElement('span');
      deleteBtn.innerHTML = '🗑️';
      deleteBtn.className = 'delete-row';
      deleteBtn.onclick = (e) => {
        e.stopPropagation();
        row.remove();
        applyCustomData();
      };
      actionTd.appendChild(deleteBtn);
      row.appendChild(actionTd);

      document.getElementById('plotsGrid').appendChild(row);
    }

    // デフォルトカラーを取得する関数
    function getDefaultColor(index) {
      const colors = ['#66c2a5', '#fc8d62', '#8da0cb'];
      return colors[index - 1] || '#66c2a5';
    }

    // データを地図に反映
    function applyCustomData() {
      // 既存のカスタムレイヤーとマーカーをクリア
      if (window.customLayers) {
        window.customLayers.forEach(layer => map.removeLayer(layer));
      }
      window.customLayers = [];
      
      if (!window.customLayers) {
        window.customLayers = [];
      }
      
      if (markers) {
        markers.forEach(marker => map.removeLayer(marker));
      }
      markers = [];

      const rows = document.querySelectorAll('#plotsGrid tr');
      const newData = [];
      
      rows.forEach(row => {
        try {
          const nameInput = row.querySelector('.field-name');
          const latInput = row.querySelector('.field-lat');
          const lonInput = row.querySelector('.field-lon');
          
          if (!nameInput || !latInput || !lonInput) {
            return; // 必要な要素が見つからない場合はスキップ
          }
          
          const lat = parseFloat(latInput.value);
          const lon = parseFloat(lonInput.value);
          
          if (isNaN(lat) || isNaN(lon)) {
            return; // 無効な座標の場合はスキップ
          }

          const data = {
            name: nameInput.value,
            lat: lat,
            lon: lon,
            address: row.querySelector('.field-address')?.value || '',
            startDate: row.querySelector('.field-startDate')?.value || '',
            endDate: row.querySelector('.field-endDate')?.value || '',
            sales: parseFloat(row.querySelector('.field-sales')?.value) || 0,
            customers: parseInt(row.querySelector('.field-customers')?.value) || 0,
            area: parseFloat(row.querySelector('.field-area')?.value) || 0
          };

          newData.push(data);

          // 円とマーカーの描画
          if (row.parentNode) { // 行が実際にテーブルに存在する場合のみ描画
            // 3つの円を描画
            [1, 2, 3].forEach(i => {
              const radiusInput = row.querySelector(`.field-radius${i}`);
              const colorInput = row.querySelector(`.field-color${i}`);
              
              if (radiusInput && colorInput) {
                const radius = parseInt(radiusInput.value);
                const color = colorInput.value;
                
                if (!isNaN(radius) && radius > 0) {
                  const circle = L.circle([lat, lon], {
                    radius: radius,
                    color: color,
                    fillColor: color,
                    fillOpacity: 0.2 - (i * 0.05)
                  }).addTo(map);
                  window.customLayers.push(circle);
                }
              }
            });

            // マーカーを追加
            const marker = createMarker(lat, lon, data);
            marker.addTo(map);
            markers.push(marker);
          }
        } catch (error) {
          console.error('行のデータ処理エラー:', error);
        }
      });
      
      customData = newData;
      console.log('Updated customData:', customData);
    }

    // マーカーの作成と追加
    function createMarker(lat, lon, data) {
      const marker = L.marker([lat, lon], {
        icon: L.divIcon({
          className: 'custom-marker',
          html: '📍',
          iconSize: [25, 25],
          iconAnchor: [12, 25]
        })
      });
      
      marker.on('click', async () => {
        // ポップアップコンテンツの作成
        const popupContent = `
          <div class="marker-popup">
            <h3>${data.name}</h3>
            <div class="marker-popup-content">
              <p><strong>住所:</strong> ${data.address || '未設定'}</p>
              <p><strong>緯度:</strong> ${lat}</p>
              <p><strong>経度:</strong> ${lon}</p>
              <p><strong>売上:</strong> ${data.sales ? data.sales.toLocaleString() : '未設定'}</p>
              <p><strong>客数:</strong> ${data.customers ? data.customers.toLocaleString() : '未設定'}</p>
              <p><strong>面積:</strong> ${data.area ? data.area + 'm²' : '未設定'}</p>
              <p><strong>期間:</strong> ${data.startDate || '未設定'} ～ ${data.endDate || '未設定'}</p>
            </div>
            <div class="marker-popup-links">
              <a href="https://www.google.com/maps/search/?api=1&query=${lat},${lon}" target="_blank">Google Mapで開く</a>
              <a href="#" onclick="showPolygons(${lat}, ${lon}); return false;">周辺ポリゴン表示</a>
            </div>
          </div>
        `;
        
        marker.bindPopup(popupContent).openPopup();
        
        // 周辺ポリゴンを取得して表示
        await showPolygons(lat, lon);
      });
      
      return marker;
    }

    // 周辺ポリゴンを表示する関数
    async function showPolygons(lat, lon) {
      try {
        console.log('Fetching polygons for:', lat, lon);
        const geojsonData = await fetchOverpassData(lat, lon, 1500);
        console.log('Received polygon data:', geojsonData);
        renderGeoJSON(geojsonData);
      } catch (error) {
        console.error('ポリゴン取得エラー:', error);
        showError('ポリゴンの取得に失敗しました: ' + error.message);
      }
    }

    // マップのダブルクリックイベントを設定
    map.on('dblclick', function(e) {
      const lat = e.latlng.lat.toFixed(6);
      const lng = e.latlng.lng.toFixed(6);
      
      addNewRow({
        name: '新規ポイント',
        lat: lat,
        lon: lng,
        radius1: document.getElementById('globalRadius1').value,
        radius2: document.getElementById('globalRadius2').value,
        radius3: document.getElementById('globalRadius3').value,
        color1: document.getElementById('globalColor1').value,
        color2: document.getElementById('globalColor2').value,
        color3: document.getElementById('globalColor3').value
      });
      
      applyCustomData();
    });

    // データ行選択時のイベント処理を更新
    function addRowClickHandler(row, data) {
      row.addEventListener('click', async () => {
        const lat = parseFloat(data.lat);
        const lon = parseFloat(data.lon);
        
        if (!isNaN(lat) && !isNaN(lon)) {
          map.setView([lat, lon], 14);
          await showPolygons(lat, lon);
          
          // 既存のマーカーを探して、クリックイベントをトリガー
          markers.forEach(marker => {
            if (marker.getLatLng().lat === lat && marker.getLatLng().lng === lon) {
              marker.fire('click');
            }
          });
        }
      });
    }

    // データのエクスポート処理
    function exportData(type, data) {
      const worksheet = XLSX.utils.json_to_sheet(data);
      const workbook = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(workbook, worksheet, 'Data');
      
      // Excel形式でエクスポート
      const excelBuffer = XLSX.write(workbook, { bookType: 'xlsx', type: 'array' });
      const blob = new Blob([excelBuffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `${type}_data.xlsx`;
      link.click();
    }

    // データのインポート処理
    function importData(file, type) {
      const reader = new FileReader();
      reader.onload = function(e) {
        if (file.name.endsWith('.csv')) {
          Papa.parse(file, {
            complete: function(results) {
              processImportedData(results.data, type);
            }
          });
        } else {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: 'array' });
          const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
          const jsonData = XLSX.utils.sheet_to_json(firstSheet);
          processImportedData(jsonData, type);
        }
      };
      reader.readAsArrayBuffer(file);
    }

    // イベントリスナーの追加
    document.getElementById('exportPlots').addEventListener('click', () => {
      exportData('plots', customData);
    });

    document.getElementById('exportPolygons').addEventListener('click', () => {
      exportData('polygons', polygonData);
    });

    document.getElementById('importPlots').addEventListener('change', (e) => {
      importData(e.target.files[0], 'plots');
    });

    document.getElementById('importPolygons').addEventListener('change', (e) => {
      importData(e.target.files[0], 'polygons');
    });

    // 検索結果をプロット地点テーブルに追加する関数
    function addSearchResultToPlots(lat, lon, displayName = '検索地点') {
      // プロットタブをアクティブにする
      document.querySelector('[data-tab="plots"]').click();
      
      // プロット地点として追加
      addNewRow({
        name: displayName,
        lat: lat,
        lon: lon,
        radius: '1500',
        color: '#66c2a5'
      });
      
      // テーブルに追加後、地図に反映
      applyCustomData();
    }

    // 初期化処理を更新
    async function initialize() {
      try {
        // 地図の初期表示
        await updateMapWithCoords(centerLat, centerLon, '渋谷駅');
        
        // プロット地点タブに渋谷駅を追加
        addNewRow(defaultPoint);
        
        // プロット地点を地図に反映
        applyCustomData();
        
        // イベントリスナーの初期化
        initEventListeners();
        initializeEventListeners();
      } catch (error) {
        console.error('初期化エラー:', error);
        showError(error.message);
      }
    }

    // イベントリスナーの追加を修正
    function initializeEventListeners() {
      // プロット関連のイベントリスナー
      const addRowButton = document.getElementById('addPlotRow');
      const applyButton = document.getElementById('applyPlots');
      
      if (addRowButton) {
        addRowButton.addEventListener('click', () => addNewRow());
      }
      
      if (applyButton) {
        applyButton.addEventListener('click', applyCustomData);
      }

      // マップクリックイベント
      map.on('click', function(e) {
        const lat = e.latlng.lat.toFixed(6);
        const lng = e.latlng.lng.toFixed(6);
        
        addNewRow({
          name: '新規ポイント',
          lat: lat,
          lon: lng,
          radius: '1500',
          color: '#66c2a5'
        });
      });
    }

    // DOMContentLoadedイベントで初期化を実行
    document.addEventListener('DOMContentLoaded', initialize);

    // イベントリスナーの初期化を一本化
    function initializeEventListeners() {
      // 検索関連
      const searchButton = document.getElementById('searchButton');
      if (searchButton) {
        searchButton.addEventListener('click', handleSearch);
      }

      // 入力フィールドのEnterキーイベント
      ['addressInput', 'latInput', 'lonInput'].forEach(id => {
        const element = document.getElementById(id);
        if (element) {
          element.addEventListener('keypress', e => {
            if (e.key === 'Enter') handleSearch();
          });
        }
      });

      // ラジオボタンの切り替え
      document.querySelectorAll('input[name="searchType"]').forEach(radio => {
        radio.addEventListener('change', () => {
          const addressGroup = document.getElementById('addressGroup');
          const coordsGroup = document.getElementById('coordsGroup');
          if (addressGroup && coordsGroup) {
            addressGroup.style.display = radio.value === 'address' ? 'flex' : 'none';
            coordsGroup.style.display = radio.value === 'coords' ? 'flex' : 'none';
          }
        });
      });

      // プロット関連
      const addPlotRowButton = document.getElementById('addPlotRow');
      const applyPlotsButton = document.getElementById('applyPlots');
      const exportPlotsButton = document.getElementById('exportPlots');
      const importPlotsInput = document.getElementById('importPlots');

      if (addPlotRowButton) {
        addPlotRowButton.addEventListener('click', () => addNewRow());
      }

      if (applyPlotsButton) {
        applyPlotsButton.addEventListener('click', applyCustomData);
      }

      if (exportPlotsButton) {
        exportPlotsButton.addEventListener('click', () => exportData('plots', customData));
      }

      if (importPlotsInput) {
        importPlotsInput.addEventListener('change', (e) => importData(e.target.files[0], 'plots'));
      }

      // ファイル入力
      const fileInput = document.getElementById('fileInput');
      if (fileInput) {
        fileInput.addEventListener('change', handleFileSelect);
      }

      // タブ切り替え
      document.querySelectorAll('.tab-button').forEach(button => {
        button.addEventListener('click', () => {
          document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
          document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
          
          button.classList.add('active');
          const tabId = `${button.dataset.tab}Tab`;
          const tabContent = document.getElementById(tabId);
          if (tabContent) {
            tabContent.classList.add('active');
          }
        });
      });

      // マップクリックイベント
      map.on('click', function(e) {
        const lat = e.latlng.lat.toFixed(6);
        const lng = e.latlng.lng.toFixed(6);
        
        addNewRow({
          name: '新規ポイント',
          lat: lat,
          lon: lng,
          radius: '1500',
          color: '#66c2a5'
        });
      });

      // 一括半径変更の適用
      document.getElementById('applyGlobalRadius').addEventListener('click', () => {
        const selectedRows = document.querySelectorAll('.row-selector:checked');
        selectedRows.forEach(checkbox => {
          const row = checkbox.closest('tr');
          [1, 2, 3].forEach(i => {
            const radiusInput = row.querySelector(`.field-radius${i}`);
            const colorInput = row.querySelector(`.field-color${i}`);
            if (radiusInput && colorInput) {
              radiusInput.value = document.getElementById(`globalRadius${i}`).value;
              colorInput.value = document.getElementById(`globalColor${i}`).value;
            }
          });
        });
        applyCustomData();
      });

      // 全選択チェックボックスの処理
      document.getElementById('selectAll').addEventListener('change', function() {
        const checkboxes = document.querySelectorAll('.row-selector');
        checkboxes.forEach(checkbox => {
          checkbox.checked = this.checked;
        });
      });

      // プロット地点の変更を監視
      document.getElementById('plotsGrid').addEventListener('input', (e) => {
        if (e.target.tagName === 'INPUT') {
          applyCustomData();
        }
      });
    }

    // 初期化時に必要なグローバル変数を確実に初期化
    window.customLayers = [];
    let markers = [];
    let polygonLayer = null;

    // エラーと成功メッセージの表示関数を追加
    function showSuccess(message) {
      const stats = document.getElementById('resultStats');
      stats.innerHTML = `<div class="success" style="color: green; background: #e8f5e9; padding: 10px; border-radius: 4px; margin-top: 10px;">${message}</div>`;
      setTimeout(() => {
        stats.innerHTML = '';
      }, 3000);
    }
  </script>
</body>
</html>
