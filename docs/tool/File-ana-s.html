<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <title>フォルダ容量分析ダッシュボード（シンプル版）</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      :root {
        color-scheme: light dark;
        --bg: #f5f5f7;
        --bg-card: #ffffff;
        --bg-card-dark: #1e1e1e;
        --text: #222;
        --text-muted: #666;
        --accent: #1976d2;
        --accent-soft: rgba(25, 118, 210, 0.1);
        --border: #ddd;
      }
      @media (prefers-color-scheme: dark) {
        :root {
          --bg: #121212;
          --bg-card: #1e1e1e;
          --bg-card-dark: #1e1e1e;
          --text: #f5f5f5;
          --text-muted: #aaa;
          --border: #333;
        }
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        background: var(--bg);
        color: var(--text);
      }

      header {
        position: sticky;
        top: 0;
        z-index: 10;
        background: linear-gradient(90deg, #1976d2, #2196f3);
        color: #fff;
        padding: 0.75rem 1.25rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.25);
        display: flex;
        align-items: center;
        gap: 0.75rem;
      }

      header h1 {
        font-size: 1.1rem;
        margin: 0;
        font-weight: 600;
      }

      header .spacer {
        flex: 1;
      }

      main {
        max-width: 1100px;
        margin: 0 auto;
        padding: 1rem;
      }

      .btn {
        appearance: none;
        border: none;
        border-radius: 999px;
        padding: 0.5rem 1.4rem;
        font-size: 0.95rem;
        font-weight: 600;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
        background: #fff;
        color: #1976d2;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.25);
      }

      .btn:disabled {
        opacity: 0.6;
        cursor: default;
        box-shadow: none;
      }

      .btn-secondary {
        background: transparent;
        border: 1px solid var(--border);
        color: var(--text);
        box-shadow: none;
      }

      .icon-folder {
        width: 18px;
        height: 18px;
        border-radius: 4px;
        background: #ffb74d;
        display: inline-block;
        position: relative;
      }
      .icon-folder::before {
        content: "";
        position: absolute;
        top: -4px;
        left: 2px;
        width: 60%;
        height: 4px;
        border-radius: 4px 4px 0 0;
        background: #ffa726;
      }

      .card {
        background: var(--bg-card);
        border-radius: 12px;
        padding: 1rem 1.2rem;
        border: 1px solid var(--border);
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
      }

      .card-muted {
        opacity: 0.7;
      }

      .grid-3 {
        display: grid;
        grid-template-columns: repeat(3, minmax(0, 1fr));
        gap: 0.75rem;
      }
      @media (max-width: 800px) {
        .grid-3 {
          grid-template-columns: repeat(2, minmax(0, 1fr));
        }
      }
      @media (max-width: 600px) {
        .grid-3 {
          grid-template-columns: minmax(0, 1fr);
        }
      }

      .summary-label {
        font-size: 0.75rem;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.04em;
        margin-bottom: 0.2rem;
      }

      .summary-value {
        font-size: 1.2rem;
        font-weight: 700;
      }

      .summary-sub {
        font-size: 0.8rem;
        color: var(--text-muted);
      }

      .section-title {
        margin: 1.4rem 0 0.5rem;
        font-size: 1rem;
        font-weight: 600;
      }

      .toolbar {
        display: flex;
        gap: 0.5rem;
        align-items: center;
        margin: 0.5rem 0 0.5rem;
        flex-wrap: wrap;
      }

      .input {
        border-radius: 999px;
        border: 1px solid var(--border);
        padding: 0.4rem 0.8rem;
        font-size: 0.9rem;
        min-width: 0;
      }

      .input[type="text"] {
        flex: 1;
      }

      .select {
        border-radius: 999px;
        border: 1px solid var(--border);
        padding: 0.4rem 0.8rem;
        font-size: 0.9rem;
        background: #fff;
      }

      @media (prefers-color-scheme: dark) {
        .select,
        .input[type="text"] {
          background: #1e1e1e;
          color: var(--text);
        }
      }

      .table-wrapper {
        margin-top: 0.5rem;
        border-radius: 12px;
        border: 1px solid var(--border);
        overflow: hidden;
        background: var(--bg-card);
      }

      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.85rem;
      }

      thead {
        background: rgba(0, 0, 0, 0.03);
      }

      th,
      td {
        padding: 0.4rem 0.6rem;
        text-align: left;
        border-bottom: 1px solid var(--border);
      }

      th {
        font-weight: 600;
        font-size: 0.8rem;
        white-space: nowrap;
        cursor: pointer;
        user-select: none;
      }

      tr:nth-child(even) td {
        background: rgba(0, 0, 0, 0.01);
      }

      .badge {
        display: inline-block;
        padding: 0.1rem 0.4rem;
        border-radius: 999px;
        font-size: 0.75rem;
        font-weight: 600;
        background: var(--accent-soft);
        color: var(--accent);
      }

      .chip {
        display: inline-block;
        border-radius: 999px;
        padding: 0.15rem 0.45rem;
        font-size: 0.75rem;
        border: 1px solid var(--border);
        color: var(--text-muted);
      }

      .chip-primary {
        border-color: var(--accent);
        color: var(--accent);
      }

      .muted {
        color: var(--text-muted);
      }

      .hidden {
        display: none !important;
      }

      .progress-text {
        font-size: 0.8rem;
        color: var(--text-muted);
        margin-top: 0.4rem;
      }

      .spinner {
        width: 16px;
        height: 16px;
        border-radius: 50%;
        border: 2px solid rgba(255, 255, 255, 0.4);
        border-top-color: #fff;
        animation: spin 0.8s linear infinite;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      .size-bar {
        position: relative;
        width: 100px;
        height: 6px;
        border-radius: 999px;
        background: rgba(0, 0, 0, 0.08);
        overflow: hidden;
      }
      .size-bar-fill {
        position: absolute;
        top: 0;
        left: 0;
        height: 100%;
        border-radius: 999px;
      }

      .pill {
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
        padding: 0.15rem 0.45rem;
        border-radius: 999px;
        background: rgba(0, 0, 0, 0.04);
        font-size: 0.75rem;
      }

      .ext-list {
        margin: 0.4rem 0 0;
        padding: 0;
        list-style: none;
        font-size: 0.8rem;
      }
      .ext-list li {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.1rem 0;
      }

      .clickable {
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <header>
      <span class="icon-folder"></span>
      <h1>フォルダ容量分析ダッシュボード（シンプル版）</h1>
      <div class="spacer"></div>
      <button id="pickBtn" class="btn">
        <span class="icon-folder"></span>
        <span>フォルダを選択</span>
      </button>
    </header>

    <main>
      <div id="welcome" class="card">
        <p style="margin:0 0 0.4rem;font-weight:600;">
          ローカルフォルダの容量をブラウザだけで分析します
        </p>
        <p class="muted" style="margin:0;font-size:0.85rem;">
          「フォルダを選択」ボタンから任意のフォルダを選ぶと、ファイルサイズを再帰的にスキャンして一覧表示します。
          データはブラウザ内でのみ処理され、外部には送信されません。
        </p>
      </div>

      <div id="statusArea" class="card" style="margin-top:0.75rem;">
        <div id="statusIdle">
          <span class="muted" style="font-size:0.85rem;">
            まだフォルダが選択されていません。
            上部の「フォルダを選択」ボタンから開始してください。
          </span>
        </div>
        <div id="statusScanning" class="hidden">
          <div style="display:flex;align-items:center;gap:0.6rem;">
            <div class="spinner"></div>
            <div>
              <div style="font-weight:600;font-size:0.9rem;">
                フォルダをスキャン中…
              </div>
              <div id="scanProgress" class="progress-text">
                0 ファイル処理済み
              </div>
              <div class="progress-text">
                大きなフォルダでは数十秒かかる場合があります。
              </div>
            </div>
          </div>
        </div>
        <div id="statusError" class="hidden">
          <span style="color:#d32f2f;font-size:0.9rem;font-weight:600;">
            フォルダの読み込みに失敗しました。権限やブラウザを確認して、もう一度お試しください。
          </span>
        </div>
      </div>

      <section id="summarySection" class="hidden">
        <h2 class="section-title">サマリー</h2>
        <div class="grid-3">
          <div class="card">
            <div class="summary-label">総容量</div>
            <div id="totalSizeText" class="summary-value">-</div>
            <div id="totalSizeSub" class="summary-sub">0 バイト</div>
          </div>
          <div class="card">
            <div class="summary-label">ファイル数</div>
            <div id="fileCountText" class="summary-value">-</div>
            <div class="summary-sub">
              <span id="extCountText" class="badge">- 種類の拡張子</span>
            </div>
          </div>
          <div class="card">
            <div class="summary-label">拡張子トップ3</div>
            <ul id="topExtList" class="ext-list"></ul>
          </div>
        </div>
      </section>

      <section id="listSection" class="hidden">
        <h2 class="section-title">ファイル一覧</h2>
        <div class="toolbar">
          <input
            id="searchInput"
            type="text"
            class="input"
            placeholder="ファイルパスに含まれる文字で絞り込み…"
          />
          <select id="extFilter" class="select">
            <option value="">すべての拡張子</option>
          </select>
          <button id="exportBtn" class="btn btn-secondary">
            CSVで保存
          </button>
        </div>
        <div class="table-wrapper">
          <table id="fileTable">
            <thead>
              <tr>
                <th data-sort="size">サイズ ▼</th>
                <th data-sort="path">パス</th>
                <th data-sort="ext">拡張子</th>
                <th>全体比</th>
              </tr>
            </thead>
            <tbody id="fileTableBody"></tbody>
          </table>
        </div>
        <div class="progress-text">
          <span id="visibleCount">0</span> / <span id="totalCount">0</span>
          ファイル表示中
        </div>
      </section>
    </main>

    <script>
      "use strict";

      // 状態
      let files = []; // { path, size, ext }
      let totalSize = 0;
      let extStats = []; // { ext, count, size }
      let currentSort = { key: "size", dir: "desc" };

      // 要素取得
      const pickBtn = document.getElementById("pickBtn");
      const statusIdle = document.getElementById("statusIdle");
      const statusScanning = document.getElementById("statusScanning");
      const statusError = document.getElementById("statusError");
      const scanProgressEl = document.getElementById("scanProgress");
      const summarySection = document.getElementById("summarySection");
      const listSection = document.getElementById("listSection");
      const totalSizeText = document.getElementById("totalSizeText");
      const totalSizeSub = document.getElementById("totalSizeSub");
      const fileCountText = document.getElementById("fileCountText");
      const extCountText = document.getElementById("extCountText");
      const topExtList = document.getElementById("topExtList");
      const searchInput = document.getElementById("searchInput");
      const extFilter = document.getElementById("extFilter");
      const fileTableBody = document.getElementById("fileTableBody");
      const visibleCount = document.getElementById("visibleCount");
      const totalCount = document.getElementById("totalCount");
      const fileTable = document.getElementById("fileTable");
      const exportBtn = document.getElementById("exportBtn");

      function formatSize(bytes) {
        if (!bytes) return "0 B";
        const k = 1024;
        const units = ["B", "KB", "MB", "GB", "TB"];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        const value = bytes / Math.pow(k, i);
        return value.toFixed(2) + " " + units[i];
      }

      function getExtension(path) {
        const idx = path.lastIndexOf(".");
        if (idx === -1) return "(no ext)";
        return path.slice(idx).toLowerCase();
      }

      function setStatus(mode) {
        statusIdle.classList.add("hidden");
        statusScanning.classList.add("hidden");
        statusError.classList.add("hidden");
        if (mode === "idle") statusIdle.classList.remove("hidden");
        if (mode === "scanning") statusScanning.classList.remove("hidden");
        if (mode === "error") statusError.classList.remove("hidden");
      }

      async function scanDirectory(dirHandle, path = "", onProgress) {
        let result = [];
        let count = 0;

        for await (const [name, handle] of dirHandle.entries()) {
          const fullPath = (path ? path + "/" : "") + name;
          if (handle.kind === "file") {
            try {
              const file = await handle.getFile();
              result.push({
                path: fullPath,
                size: file.size,
                ext: getExtension(fullPath)
              });
              count++;
              if (count % 10 === 0 && onProgress) {
                onProgress(count);
              }
            } catch (e) {
              console.warn("読めないファイル:", fullPath, e);
            }
          } else if (handle.kind === "directory") {
            const sub = await scanDirectory(handle, fullPath, onProgress);
            result = result.concat(sub);
          }
        }
        return result;
      }

      function buildExtStats(files) {
        const map = {};
        for (const f of files) {
          if (!map[f.ext]) map[f.ext] = { ext: f.ext, count: 0, size: 0 };
          map[f.ext].count++;
          map[f.ext].size += f.size;
        }
        return Object.values(map).sort((a, b) => b.size - a.size);
      }

      function updateSummary() {
        if (!files.length) return;

        totalSizeText.textContent = formatSize(totalSize);
        totalSizeSub.textContent = totalSize.toLocaleString() + " バイト";
        fileCountText.textContent = files.length.toLocaleString();
        extCountText.textContent =
          extStats.length + " 種類の拡張子";

        topExtList.innerHTML = "";
        extStats.slice(0, 3).forEach((e) => {
          const li = document.createElement("li");
          const left = document.createElement("span");
          left.textContent = e.ext;
          const right = document.createElement("span");
          const ratio = totalSize
            ? ((e.size / totalSize) * 100).toFixed(1)
            : "0.0";
          right.innerHTML =
            '<span class="chip chip-primary">' +
            formatSize(e.size) +
            "</span> " +
            '<span class="muted">' +
            ratio +
            "%</span>";
          li.appendChild(left);
          li.appendChild(right);
          topExtList.appendChild(li);
        });

        summarySection.classList.remove("hidden");
      }

      function populateExtFilter() {
        extFilter.innerHTML = "";
        const optAll = document.createElement("option");
        optAll.value = "";
        optAll.textContent = "すべての拡張子";
        extFilter.appendChild(optAll);

        extStats.forEach((e) => {
          const opt = document.createElement("option");
          opt.value = e.ext;
          opt.textContent =
            e.ext +
            " (" +
            e.count.toLocaleString() +
            "件, " +
            formatSize(e.size) +
            ")";
          extFilter.appendChild(opt);
        });
      }

      function sizeBarColor(size) {
        if (!totalSize) return "#90caf9";
        const ratio = size / totalSize;
        if (ratio > 0.1) return "#ef5350";
        if (ratio > 0.03) return "#ffb74d";
        if (ratio > 0.01) return "#81c784";
        return "#90caf9";
      }

      function renderTable() {
        const search = searchInput.value.trim().toLowerCase();
        const ext = extFilter.value;
        let filtered = files;

        if (search) {
          filtered = filtered.filter((f) =>
            f.path.toLowerCase().includes(search)
          );
        }
        if (ext) {
          filtered = filtered.filter((f) => f.ext === ext);
        }

        filtered = filtered.slice().sort((a, b) => {
          const dir = currentSort.dir === "asc" ? 1 : -1;
          if (currentSort.key === "size") {
            return dir * (a.size - b.size);
          }
          if (currentSort.key === "path") {
            return dir * a.path.localeCompare(b.path);
          }
          if (currentSort.key === "ext") {
            return dir * a.ext.localeCompare(b.ext);
          }
          return 0;
        });

        fileTableBody.innerHTML = "";
        const maxSize =
          filtered.length > 0
            ? filtered.reduce(
                (m, f) => (f.size > m ? f.size : m),
                0
              )
            : 1;

        for (const f of filtered) {
          const tr = document.createElement("tr");

          const tdSize = document.createElement("td");
          tdSize.textContent = formatSize(f.size);
          tdSize.style.whiteSpace = "nowrap";

          const tdPath = document.createElement("td");
          tdPath.textContent = f.path;

          const tdExt = document.createElement("td");
          tdExt.textContent = f.ext;

          const tdRatio = document.createElement("td");
          const ratio = totalSize ? (f.size / totalSize) * 100 : 0;
          const bar = document.createElement("div");
          bar.className = "size-bar";
          const fill = document.createElement("div");
          fill.className = "size-bar-fill";
          fill.style.width =
            Math.max((f.size / maxSize) * 100, 2) + "%";
          fill.style.backgroundColor = sizeBarColor(f.size);
          bar.appendChild(fill);
          const label = document.createElement("span");
          label.className = "muted";
          label.style.marginLeft = "0.3rem";
          label.textContent = ratio.toFixed(2) + "%";
          tdRatio.appendChild(bar);
          tdRatio.appendChild(label);

          tr.appendChild(tdSize);
          tr.appendChild(tdPath);
          tr.appendChild(tdExt);
          tr.appendChild(tdRatio);

          fileTableBody.appendChild(tr);
        }

        visibleCount.textContent = filtered.length.toLocaleString();
        totalCount.textContent = files.length.toLocaleString();
        listSection.classList.remove("hidden");
      }

      async function handlePickFolder() {
        if (!window.showDirectoryPicker) {
          alert(
            "この機能には File System Access API が必要です。\nChrome / Edge などの最新ブラウザで、https または localhost から開いてください。"
          );
          return;
        }

        try {
          pickBtn.disabled = true;
          setStatus("scanning");
          summarySection.classList.add("hidden");
          listSection.classList.add("hidden");
          files = [];
          totalSize = 0;
          extStats = [];
          scanProgressEl.textContent = "0 ファイル処理済み";

          const dirHandle = await window.showDirectoryPicker();
          const scanned = await scanDirectory(
            dirHandle,
            "",
            (count) => {
              scanProgressEl.textContent =
                count.toLocaleString() + " ファイル処理済み";
            }
          );

          files = scanned;
          totalSize = scanned.reduce((s, f) => s + f.size, 0);
          extStats = buildExtStats(files);

          setStatus("idle");
          updateSummary();
          populateExtFilter();
          renderTable();
        } catch (e) {
          console.error(e);
          setStatus("error");
        } finally {
          pickBtn.disabled = false;
        }
      }

      function handleSortClick(event) {
        const th = event.target.closest("th");
        if (!th) return;
        const key = th.getAttribute("data-sort");
        if (!key) return;

        if (currentSort.key === key) {
          currentSort.dir =
            currentSort.dir === "asc" ? "desc" : "asc";
        } else {
          currentSort.key = key;
          currentSort.dir = key === "path" ? "asc" : "desc";
        }

        const ths = fileTable.querySelectorAll("th");
        ths.forEach((t) => {
          const k = t.getAttribute("data-sort");
          if (!k) return;
          let label = t.textContent.replace(/▲|▼/g, "").trim();
          if (k === currentSort.key) {
            label += currentSort.dir === "asc" ? " ▲" : " ▼";
          }
          t.textContent = label;
        });

        renderTable();
      }

      function exportCsv() {
        if (!files.length) return;
        const search = searchInput.value.trim().toLowerCase();
        const ext = extFilter.value;
        let filtered = files;

        if (search) {
          filtered = filtered.filter((f) =>
            f.path.toLowerCase().includes(search)
          );
        }
        if (ext) {
          filtered = filtered.filter((f) => f.ext === ext);
        }

        let csv = "size,path,ext\n";
        for (const f of filtered) {
          const safePath = '"' + f.path.replace(/"/g, '""') + '"';
          csv += f.size + "," + safePath + "," + f.ext + "\n";
        }

        const blob = new Blob([csv], {
          type: "text/csv;charset=utf-8;"
        });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "folder-analysis.csv";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }

      // イベント登録
      pickBtn.addEventListener("click", handlePickFolder);
      searchInput.addEventListener("input", () => renderTable());
      extFilter.addEventListener("change", () => renderTable());
      fileTable.addEventListener("click", handleSortClick);
      exportBtn.addEventListener("click", exportCsv);
    </script>
  </body>
</html>
