<!DOCTYPE html>
<html>
<head>
  <title>React Leaflet with GSI Tiles</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <!-- osmtogeojson JS (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/osmtogeojson@3.0.0-beta.5/osmtogeojson.min.js"></script>

  <!-- turf.js for spatial operations -->
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

  <!-- SheetJS for Excel handling -->
  <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
  <!-- PapaParse for CSV handling -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.0/papaparse.min.js"></script>

  <style>
    body { margin: 0; padding: 0; font-family: Arial, sans-serif; }
    #map { width: 100%; height: 55vh; }
    #controls {
      width: 100%;
      height: 15vh;
      background: #f9f9f9;
      padding: 10px;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      border-bottom: 1px solid #ccc;
    }
    .input-group {
      margin: 5px 0;
      display: flex;
      align-items: center;
    }
    .input-group label {
      margin-right: 10px;
      font-weight: bold;
    }
    #addressInput, #latInput, #lonInput {
      width: 300px;
      padding: 8px;
      font-size: 16px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    #latInput, #lonInput {
      width: 140px;
    }
    #searchButton {
      padding: 8px 16px;
      margin-top: 10px;
      font-size: 16px;
      border: none;
      border-radius: 4px;
      background-color: #66c2a5;
      color: white;
      cursor: pointer;
    }
    #searchButton:hover {
      background-color: #559f8f;
    }
    #info {
      position: absolute;
      top: 60px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255, 255, 255, 0.9);
      padding: 10px;
      border-radius: 5px;
      z-index: 1000;
      font-size: 14px;
      display: none;
      max-width: 80%;
      word-wrap: break-word;
    }
    .radio-group {
      margin: 10px 0;
      display: flex;
      align-items: center;
    }
    .radio-group input {
      margin-right: 5px;
    }
    .loading {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(255, 255, 255, 0.9);
      padding: 20px;
      border-radius: 5px;
      z-index: 1000;
    }
    #resultStats {
      margin-top: 10px;
      font-size: 0.9em;
      color: #666;
    }
    .error {
      color: #d32f2f;
      background: #ffebee;
      padding: 10px;
      border-radius: 4px;
      margin-top: 10px;
    }
    #dataEditor {
      width: 100%;
      height: 30vh;
      background: #ffffff;
      padding: 10px;
      box-sizing: border-box;
      border-top: 1px solid #ccc;
    }
    .data-grid {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    .data-grid th, .data-grid td {
      border: 1px solid #ddd;
      padding: 4px;
      text-align: left;
      font-size: 12px;
    }
    .data-grid input {
      width: 90%;
      padding: 2px;
      font-size: 12px;
    }
    .data-grid th {
      background-color: #f5f5f5;
    }
    .data-actions {
      margin: 10px 0;
    }
    .data-actions button {
      margin-right: 10px;
      padding: 5px 10px;
      background-color: #66c2a5;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .delete-row {
      color: #d32f2f;
      cursor: pointer;
    }
    .search-address-btn {
      padding: 2px 4px;
      margin-left: 4px;
      background: #66c2a5;
      color: white;
      border: none;
      border-radius: 3px;
      cursor: pointer;
    }
    .data-grid tr:hover {
      background-color: #f5f5f5;
      cursor: pointer;
    }
    /* ã‚¿ãƒ–ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
    .tab-container {
      width: 100%;
      margin-top: 10px;
    }
    
    .tab-buttons {
      display: flex;
      border-bottom: 1px solid #ccc;
    }
    
    .tab-button {
      padding: 10px 20px;
      border: none;
      background: none;
      cursor: pointer;
    }
    
    .tab-button.active {
      border-bottom: 2px solid #66c2a5;
      font-weight: bold;
    }
    
    .tab-content {
      display: none;
      padding: 15px;
    }
    
    .tab-content.active {
      display: block;
    }

    /* çµ±è¨ˆæƒ…å ±è¡¨ç¤ºã®æ”¹å–„ */
    #statsContainer {
      position: fixed;
      top: 10px;
      right: 10px;
      background: rgba(255, 255, 255, 0.9);
      padding: 10px;
      border-radius: 5px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      z-index: 1000;
    }

    /* ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ/ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒœã‚¿ãƒ³ */
    .data-actions {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
    }

    .action-button {
      padding: 5px 10px;
      background: #66c2a5;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    .action-button:hover {
      background: #559f8f;
    }

    /* ãƒ†ãƒ¼ãƒ–ãƒ«åˆ—å¹…ã®èª¿æ•´ */
    .data-grid th, .data-grid td {
      padding: 4px;
      font-size: 12px;
    }
    .data-grid th:nth-child(1), .data-grid td:nth-child(1) { width: 150px; } /* åç§° */
    .data-grid th:nth-child(2), .data-grid td:nth-child(2) { width: 100px; } /* é–‹å§‹æ—¥ */
    .data-grid th:nth-child(3), .data-grid td:nth-child(3) { width: 100px; } /* çµ‚äº†æ—¥ */
    .data-grid th:nth-child(4), .data-grid td:nth-child(4) { width: 80px; } /* å£²ä¸Š */
    .data-grid th:nth-child(5), .data-grid td:nth-child(5) { width: 80px; } /* å®¢æ•° */
    .data-grid th:nth-child(6), .data-grid td:nth-child(6) { width: 80px; } /* é¢ç© */
    .data-grid th:nth-child(7), .data-grid td:nth-child(7) { width: 200px; } /* ä½æ‰€ */
    .data-grid th:nth-child(8), .data-grid td:nth-child(8) { width: 90px; } /* ç·¯åº¦ */
    .data-grid th:nth-child(9), .data-grid td:nth-child(9) { width: 90px; } /* çµŒåº¦ */
    .data-grid th:nth-child(10), .data-grid td:nth-child(10) { width: 70px; } /* åŠå¾„1 */
    .data-grid th:nth-child(11), .data-grid td:nth-child(11) { width: 70px; } /* åŠå¾„2 */
    .data-grid th:nth-child(12), .data-grid td:nth-child(12) { width: 70px; } /* åŠå¾„3 */
    .data-grid th:nth-child(13), .data-grid td:nth-child(13) { width: 70px; } /* è‰² */
    .data-grid th:nth-child(14), .data-grid td:nth-child(14) { width: 50px; } /* æ“ä½œ */

    /* ãƒãƒ¼ã‚«ãƒ¼ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .marker-popup {
      min-width: 300px;
    }
    .marker-popup h3 {
      margin: 0 0 10px 0;
      color: #333;
    }
    .marker-popup-content {
      margin-bottom: 10px;
    }
    .marker-popup-links {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }
    .marker-popup-links a {
      padding: 5px 10px;
      background: #66c2a5;
      color: white;
      text-decoration: none;
      border-radius: 3px;
    }
    .marker-popup-links a:hover {
      background: #559f8f;
    }
  </style>
</head>
<body>
  <div id="controls">
    <div class="radio-group">
      <input type="radio" id="searchByAddress" name="searchType" value="address" checked>
      <label for="searchByAddress">ä½æ‰€ã§æ¤œç´¢</label>
      <input type="radio" id="searchByCoords" name="searchType" value="coords" style="margin-left: 20px;">
      <label for="searchByCoords">ç·¯åº¦çµŒåº¦ã§æ¤œç´¢</label>
    </div>
    <div class="input-group" id="addressGroup">
      <label for="addressInput">ä½æ‰€:</label>
      <input type="text" id="addressInput" placeholder="ä½æ‰€ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„" />
    </div>
    <div class="input-group" id="coordsGroup" style="display: none;">
      <label for="latInput">ç·¯åº¦:</label>
      <input type="text" id="latInput" placeholder="ä¾‹: 35.6871682" />
      <label for="lonInput" style="margin-left: 10px;">çµŒåº¦:</label>
      <input type="text" id="lonInput" placeholder="ä¾‹: 139.710645" />
    </div>
    <button id="searchButton">æ¤œç´¢</button>
    <div id="resultStats"></div>
  </div>
  <div id="loading" class="loading" style="display: none;">ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­...</div>
  <div id="info">Loading data...</div>
  <div id="map"></div>
  <div id="dataEditor">
    <div class="tab-container">
      <div class="tab-buttons">
        <button class="tab-button active" data-tab="plots">ãƒ—ãƒ­ãƒƒãƒˆåœ°ç‚¹</button>
        <button class="tab-button" data-tab="polygons">ç”ºä¸ç›®ãƒãƒªã‚´ãƒ³</button>
      </div>
      
      <!-- ãƒ—ãƒ­ãƒƒãƒˆåœ°ç‚¹ã‚¿ãƒ– -->
      <div id="plotsTab" class="tab-content active">
        <div class="data-actions">
          <button class="action-button" id="addPlotRow">æ–°è¦è¿½åŠ </button>
          <button class="action-button" id="applyPlots">åœ°å›³ã«åæ˜ </button>
          <button class="action-button" id="exportPlots">ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
          <input type="file" id="importPlots" accept=".csv,.xlsx" style="display: none;">
          <button class="action-button" onclick="document.getElementById('importPlots').click()">ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
        </div>
        <table class="data-grid">
          <thead>
            <tr>
              <th>åç§°</th>
              <th>é–‹å§‹æ—¥</th>
              <th>çµ‚äº†æ—¥</th>
              <th>å£²ä¸Š</th>
              <th>å®¢æ•°</th>
              <th>é¢ç©</th>
              <th>ä½æ‰€</th>
              <th>ç·¯åº¦</th>
              <th>çµŒåº¦</th>
              <th>åŠå¾„1</th>
              <th>åŠå¾„2</th>
              <th>åŠå¾„3</th>
              <th>è‰²</th>
              <th>æ“ä½œ</th>
            </tr>
          </thead>
          <tbody id="plotsGrid"></tbody>
        </table>
      </div>
      
      <!-- ç”ºä¸ç›®ãƒãƒªã‚´ãƒ³ã‚¿ãƒ– -->
      <div id="polygonsTab" class="tab-content">
        <div class="data-actions">
          <button class="action-button" id="addPolygonRow">æ–°è¦è¿½åŠ </button>
          <button class="action-button" id="applyPolygons">åœ°å›³ã«åæ˜ </button>
          <button class="action-button" id="exportPolygons">ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
          <input type="file" id="importPolygons" accept=".csv,.xlsx" style="display: none;">
          <button class="action-button" onclick="document.getElementById('importPolygons').click()">ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
        </div>
        <table class="data-grid">
          <thead>
            <tr>
              <th>ç”ºä¸ç›®å</th>
              <th>ãƒãƒªã‚´ãƒ³ãƒ‡ãƒ¼ã‚¿</th>
              <th>è‰²</th>
              <th>æ“ä½œ</th>
            </tr>
          </thead>
          <tbody id="polygonsGrid"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- çµ±è¨ˆæƒ…å ±è¡¨ç¤ºç”¨ã®è¦ç´  -->
  <div id="statsContainer" style="display: none;">
    <div id="polygonStats"></div>
  </div>

  <script>
    // åˆæœŸè¨­å®šï¼ˆæ¸‹è°·ï¼‰
    let centerLat = 35.6580;
    let centerLon = 139.7016;
    const radius = 1500; // åŠå¾„1500m

    // åˆæœŸãƒã‚¤ãƒ³ãƒˆã®ãƒ‡ãƒ¼ã‚¿
    const defaultPoint = {
      name: 'æ¸‹è°·é§…',
      lat: 35.6580,
      lon: 139.7016,
      radius: 1500,
      color: '#66c2a5'
    };

    // åœ°å›³ã®åˆæœŸåŒ–
    const map = L.map('map').setView([centerLat, centerLon], 14);

    // èƒŒæ™¯åœ°å›³ï¼šå›½åœŸåœ°ç†é™¢ã®åœ°ç†é™¢åœ°å›³
    L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="https://maps.gsi.go.jp/">å›½åœŸåœ°ç†é™¢</a>'
    }).addTo(map);

    // åˆæœŸå††ã®æç”»
    let searchCircle = L.circle([centerLat, centerLon], {
      radius: radius, // åŠå¾„1500m
      color: 'blue', // å¢ƒç•Œç·šã®è‰²
      weight: 2,     // å¢ƒç•Œç·šã®å¤ªã•
      fillOpacity: 0.1 // å¡—ã‚Šã¤ã¶ã—ã®é€æ˜åº¦
    }).addTo(map);

    // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’å°å…¥ã—ã¦APIå‘¼ã³å‡ºã—ã‚’æœ€é©åŒ–
    const cache = new Map();
    
    // ãƒ‡ãƒã‚¦ãƒ³ã‚¹é–¢æ•°
    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    // Overpass APIã‚¯ã‚¨ãƒªã‚’ç”Ÿæˆã™ã‚‹é–¢æ•°
    function generateOverpassQuery(lat, lon, radius) {
      return `
[out:json][timeout:25];
(
  relation["admin_level"~"^(8|9|10)$"](around:${radius},${lat},${lon});
  way["admin_level"~"^(8|9|10)$"](around:${radius},${lat},${lon});
);
out geom;`;
    }

    const overpassApiUrl = 'https://overpass-api.de/api/interpreter';

    // æƒ…å ±è¡¨ç¤ºç”¨è¦ç´ 
    const infoDiv = document.getElementById('info');

    // ãƒãƒªã‚´ãƒ³ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®åˆæœŸåŒ–
    let polygonLayer = null;

    // æ¤œç´¢ã—ãŸä½æ‰€ã®ãƒãƒ¼ã‚«ãƒ¼ã‚’ä¿æŒ
    let addressMarker = null;

    // GeoJSONãƒ‡ãƒ¼ã‚¿ã®æç”»
    function renderGeoJSON(geojsonData) {
      // ãƒ‡ãƒãƒƒã‚°: å–å¾—ã—ãŸãƒãƒªã‚´ãƒ³ã®æ•°ã‚’è¡¨ç¤º
      console.log('å–å¾—ã—ãŸãƒãƒªã‚´ãƒ³ã®æ•°:', geojsonData.features.length);

      // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã‚’è§£é™¤ã—ã¦ã™ã¹ã¦ã®ãƒãƒªã‚´ãƒ³ã‚’è¡¨ç¤º
      const filteredFeatures = geojsonData.features;

      // ãƒ‡ãƒãƒƒã‚°: ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°å¾Œã®ãƒãƒªã‚´ãƒ³æ•°ã‚’è¡¨ç¤º
      console.log('è¡¨ç¤ºã•ã‚Œã‚‹ãƒãƒªã‚´ãƒ³ã®æ•°:', filteredFeatures.length);

      // æ—¢å­˜ã®ãƒãƒªã‚´ãƒ³ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’å‰Šé™¤
      if (polygonLayer && map.hasLayer(polygonLayer)) {
        map.removeLayer(polygonLayer);
      }

      // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã•ã‚ŒãŸãƒãƒªã‚´ãƒ³ã‚’GeoJSONã¨ã—ã¦ã¾ã¨ã‚ã‚‹
      const filteredGeoJSON = {
        type: "FeatureCollection",
        features: filteredFeatures
      };

      // GeoJSONã‚’åœ°å›³ã«è¿½åŠ 
      polygonLayer = L.geoJSON(filteredGeoJSON, {
        style: function(feature) {
          return {
            fillColor: '#66c2a5', // å¡—ã‚Šã¤ã¶ã—è‰²
            fillOpacity: 0.4,     // å¡—ã‚Šã¤ã¶ã—é€æ˜åº¦
            color: '#1b7837',     // å¢ƒç•Œç·šã®è‰²
            weight: 1.5           // å¢ƒç•Œç·šã®å¤ªã•
          };
        },
        onEachFeature: function(feature, layer) {
          const name = feature.properties && feature.properties.tags && feature.properties.tags.name
                       ? feature.properties.tags.name
                       : 'ä¸æ˜';
          const adminLevel = feature.properties && feature.properties.tags && feature.properties.tags.admin_level
                             ? feature.properties.tags.admin_level
                             : 'ä¸æ˜';
          let popupContent = `<b>ç”ºã¾ãŸã¯å­—:</b> ${name}<br><b>Admin Level:</b> ${adminLevel}`;
          
          // Turf.jsã‚’ä½¿ç”¨ã—ã¦ãƒãƒªã‚´ãƒ³ã®ã‚»ãƒ³ãƒˆãƒ­ã‚¤ãƒ‰ã‚’è¨ˆç®—
          try {
            const centroid = turf.centroid(feature);
            const centroidCoords = centroid.geometry.coordinates;
            const lat = centroidCoords[1].toFixed(6);
            const lon = centroidCoords[0].toFixed(6);
            popupContent += `<br><b>ã‚»ãƒ³ãƒˆãƒ­ã‚¤ãƒ‰ç·¯åº¦:</b> ${lat}<br><b>ã‚»ãƒ³ãƒˆãƒ­ã‚¤ãƒ‰çµŒåº¦:</b> ${lon}`;
          } catch (error) {
            console.error('ã‚»ãƒ³ãƒˆãƒ­ã‚¤ãƒ‰è¨ˆç®—ã‚¨ãƒ©ãƒ¼:', error, 'Feature:', feature);
            popupContent += `<br><b>ã‚»ãƒ³ãƒˆãƒ­ã‚¤ãƒ‰ç·¯åº¦:</b> ä¸æ˜<br><b>ã‚»ãƒ³ãƒˆãƒ­ã‚¤ãƒ‰çµŒåº¦:</b> ä¸æ˜`;
          }

          layer.bindPopup(popupContent);
        }
      }).addTo(map);
    }

    // Overpass APIã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹é–¢æ•°
    async function fetchOverpassData(lat, lon, radius) {
      const cacheKey = `${lat},${lon},${radius}`;
      if (cache.has(cacheKey)) {
        return cache.get(cacheKey);
      }

      const loading = document.getElementById('loading');
      loading.style.display = 'block';

      try {
        const response = await fetch(overpassApiUrl, {
          method: 'POST',
          headers: {'Content-Type': 'application/x-www-form-urlencoded'},
          body: 'data=' + encodeURIComponent(generateOverpassQuery(lat, lon, radius))
        });

        if (!response.ok) throw new Error('Network response was not ok');
        
        const data = await response.json();
        const geojsonData = osmtogeojson(data);
        cache.set(cacheKey, geojsonData);
        
        return geojsonData;
      } catch (error) {
        throw new Error('ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
      } finally {
        loading.style.display = 'none';
      }
    }

    // å›½åœŸåœ°ç†é™¢ã®ã‚¸ã‚ªã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°APIã‚’ä½¿ç”¨ã—ã¦ä½æ‰€ã‹ã‚‰ç·¯åº¦çµŒåº¦ã‚’å–å¾—ã™ã‚‹é–¢æ•°
    function geocodeAddressGSI(address) {
      // å›½åœŸåœ°ç†é™¢ã®ã‚¸ã‚ªã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
      const gsiGeocoderUrl = `https://msearch.gsi.go.jp/address-search/AddressSearch?q=${encodeURIComponent(address)}`;

      console.log('GSI ã‚¸ã‚ªã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒªã‚¯ã‚¨ã‚¹ãƒˆ URL:', gsiGeocoderUrl); // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°

      return fetch(gsiGeocoderUrl)
        .then(response => {
          if (!response.ok) {
            throw new Error('Network response was not ok: ' + response.statusText);
          }
          return response.json();
        })
        .then(data => {
          // ãƒ‡ãƒãƒƒã‚°ç”¨ãƒ­ã‚°
          console.log('å–å¾—ã—ãŸGSIã‚¸ã‚ªã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿:', data);

          if (!data || data.length === 0) {
            throw new Error('ä½æ‰€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚');
          }

          // ã€Œæ±äº¬éƒ½ã€ã‚’å«ã‚€çµæœã‚’å„ªå…ˆçš„ã«ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
          const tokyoResults = data.filter(result => {
            return result.address && result.address.includes('æ±äº¬éƒ½');
          });

          let selectedResult;

          if (tokyoResults.length > 0) {
            // ã€Œæ±äº¬éƒ½ã€ã‚’å«ã‚€æœ€åˆã®çµæœã‚’é¸æŠ
            selectedResult = tokyoResults[0];
          } else {
            // ã€Œæ±äº¬éƒ½ã€ã‚’å«ã¾ãªã„å ´åˆã¯æœ€åˆã®çµæœã‚’ä½¿ç”¨
            selectedResult = data[0];
          }

          const coordinates = selectedResult.geometry.coordinates; // [çµŒåº¦, ç·¯åº¦]

          // displayNameã®å–å¾—æ–¹æ³•ã‚’ä¿®æ­£
          const displayName = selectedResult.address || address;

          console.log('ã‚¸ã‚ªã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çµæœ:', coordinates, displayName); // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°

          return {
            lat: coordinates[1],
            lon: coordinates[0],
            displayName: displayName
          };
        });
    }

    // ç·¯åº¦çµŒåº¦ã‚’ä½¿ç”¨ã—ã¦åœ°å›³ã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
    const updateMapWithCoords = debounce(async (lat, lon, displayName = 'æŒ‡å®šåº§æ¨™') => {
      try {
        // æ—¢å­˜ã®ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’ã‚¯ãƒªã‚¢ï¼ˆã‚«ã‚¹ã‚¿ãƒ ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯ç¶­æŒï¼‰
        if (searchCircle) map.removeLayer(searchCircle);
        if (addressMarker) map.removeLayer(addressMarker);
        if (polygonLayer) map.removeLayer(polygonLayer);

        // æ–°ã—ã„è¡¨ç¤ºè¦ç´ ã‚’è¿½åŠ 
        searchCircle = L.circle([lat, lon], {
          radius,
          color: 'blue',
          weight: 2,
          fillOpacity: 0.1
        }).addTo(map);

        addressMarker = L.marker([lat, lon])
          .bindPopup(`<b>æ¤œç´¢çµæœ:</b> ${displayName}<br><b>ç·¯åº¦:</b> ${lat.toFixed(6)}<br><b>çµŒåº¦:</b> ${lon.toFixed(6)}`)
          .addTo(map);

        // ãƒ‡ãƒ¼ã‚¿å–å¾—ã¨æç”»
        const geojsonData = await fetchOverpassData(lat, lon, radius);
        renderGeoJSON(geojsonData);

        // çµ±è¨ˆæƒ…å ±ã‚’æ›´æ–°
        updateStats(geojsonData);

        map.setView([lat, lon], 14);
      } catch (error) {
        showError(error.message);
      }
    }, 500);

    // çµ±è¨ˆæƒ…å ±ã®æ›´æ–°
    function updateStats(geojsonData) {
      const stats = document.getElementById('polygonStats');
      const count = geojsonData.features.length;
      stats.innerHTML = `
        <strong>ãƒãƒªã‚´ãƒ³çµ±è¨ˆ:</strong><br>
        å–å¾—: ${count}ä»¶<br>
        è¡¨ç¤º: ${count}ä»¶
      `;
      document.getElementById('statsContainer').style.display = 'block';
    }

    // ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
    function showError(message) {
      const stats = document.getElementById('resultStats');
      stats.innerHTML = `<div class="error">${message}</div>`;
    }

    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’æœ€é©åŒ–
    function initEventListeners() {
      document.getElementById('searchButton').addEventListener('click', handleSearch);
      
      ['addressInput', 'latInput', 'lonInput'].forEach(id => {
        document.getElementById(id).addEventListener('keypress', e => {
          if (e.key === 'Enter') handleSearch();
        });
      });

      // ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã®åˆ‡ã‚Šæ›¿ãˆ
      document.querySelectorAll('input[name="searchType"]').forEach(radio => {
        radio.addEventListener('change', () => {
          document.getElementById('addressGroup').style.display = 
            radio.value === 'address' ? 'flex' : 'none';
          document.getElementById('coordsGroup').style.display = 
            radio.value === 'coords' ? 'flex' : 'none';
        });
      });
    }

    // æ¤œç´¢ãƒãƒ³ãƒ‰ãƒ©ã‚’çµ±åˆ
    async function handleSearch() {
      const searchType = document.querySelector('input[name="searchType"]:checked').value;
      
      try {
        if (searchType === 'address') {
          const address = document.getElementById('addressInput').value.trim();
          if (!address) throw new Error('ä½æ‰€ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
          
          const result = await geocodeAddressGSI(address);
          updateMapWithCoords(result.lat, result.lon, result.displayName);
          // æ¤œç´¢çµæœã‚’ãƒ—ãƒ­ãƒƒãƒˆåœ°ç‚¹ã«è¿½åŠ 
          addSearchResultToPlots(result.lat, result.lon, result.displayName);
        } else {
          const lat = parseFloat(document.getElementById('latInput').value);
          const lon = parseFloat(document.getElementById('lonInput').value);
          
          if (isNaN(lat) || isNaN(lon)) throw new Error('æœ‰åŠ¹ãªç·¯åº¦çµŒåº¦ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
          if (lat < -90 || lat > 90) throw new Error('ç·¯åº¦ã¯ -90 ã‹ã‚‰ 90 ã®ç¯„å›²ã§å…¥åŠ›ã—ã¦ãã ã•ã„');
          if (lon < -180 || lon > 180) throw new Error('çµŒåº¦ã¯ -180 ã‹ã‚‰ 180 ã®ç¯„å›²ã§å…¥åŠ›ã—ã¦ãã ã•ã„');
          
          updateMapWithCoords(lat, lon);
          // æ¤œç´¢çµæœã‚’ãƒ—ãƒ­ãƒƒãƒˆåœ°ç‚¹ã«è¿½åŠ 
          addSearchResultToPlots(lat, lon, 'åº§æ¨™æŒ‡å®šåœ°ç‚¹');
        }
      } catch (error) {
        showError(error.message);
      }
    }

    // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠãƒãƒ³ãƒ‰ãƒ©
    function handleFileSelect(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const firstSheetName = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[firstSheetName];
        const json = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

        // CSVãƒ•ã‚¡ã‚¤ãƒ«ã®å ´åˆ
        if (file.type === 'text/csv') {
          Papa.parse(file, {
            complete: function(results) {
              console.log('CSVãƒ‡ãƒ¼ã‚¿:', results.data);
              // CSVãƒ‡ãƒ¼ã‚¿ã®å‡¦ç†
            }
          });
        } else {
          console.log('Excelãƒ‡ãƒ¼ã‚¿:', json);
          // Excelãƒ‡ãƒ¼ã‚¿ã®å‡¦ç†
        }
      };
      reader.readAsArrayBuffer(file);
    }

    // ãƒ‡ãƒ¼ã‚¿ç®¡ç†ç”¨ã®é…åˆ—
    let customData = [];

    // æ–°è¦è¡Œã®è¿½åŠ 
    function addNewRow(data = null) {
      const row = document.createElement('tr');
      const fields = [
        { name: 'name', type: 'text' },
        { name: 'startDate', type: 'date' },
        { name: 'endDate', type: 'date' },
        { name: 'sales', type: 'number' },
        { name: 'customers', type: 'number' },
        { name: 'area', type: 'number' },
        { name: 'address', type: 'text' },
        { name: 'lat', type: 'number' },
        { name: 'lon', type: 'number' },
        { name: 'radius1', type: 'number' },
        { name: 'radius2', type: 'number' },
        { name: 'radius3', type: 'number' },
        { name: 'color', type: 'color' }
      ];
      
      fields.forEach(field => {
        const td = document.createElement('td');
        const input = document.createElement('input');
        input.type = field.type;
        input.className = `field-${field.name}`;
        
        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã®è¨­å®š
        if (data && data[field.name]) {
          input.value = data[field.name];
        } else {
          switch (field.name) {
            case 'radius1': input.value = '500'; break;
            case 'radius2': input.value = '1000'; break;
            case 'radius3': input.value = '1500'; break;
            case 'color': input.value = '#66c2a5'; break;
          }
        }
        
        td.appendChild(input);
        
        // ä½æ‰€ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å ´åˆã€æ¤œç´¢ãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
        if (field.name === 'address') {
          const searchBtn = document.createElement('button');
          searchBtn.textContent = 'ğŸ”';
          searchBtn.className = 'search-address-btn';
          searchBtn.onclick = async (e) => {
            e.stopPropagation(); // è¡Œã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’é˜²æ­¢
            const addressInput = td.querySelector('input');
            const nameInput = row.querySelector('.field-name');
            const address = addressInput.value.trim();
            const name = nameInput.value.trim();
            
            try {
              let result;
              if (address) {
                result = await geocodeAddressGSI(address);
              } else if (name) {
                result = await geocodeAddressGSI(name);
              } else {
                throw new Error('ä½æ‰€ã¾ãŸã¯åç§°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
              }
              
              // ç·¯åº¦çµŒåº¦ã‚’æ›´æ–°
              row.querySelector('.field-lat').value = result.lat;
              row.querySelector('.field-lon').value = result.lon;
              
              // åœ°å›³ã‚’æ›´æ–°
              updateMapWithCoords(result.lat, result.lon, result.displayName);
            } catch (error) {
              showError(error.message);
            }
          };
          td.appendChild(searchBtn);
        }
        
        row.appendChild(td);
      });
      
      // å‰Šé™¤ãƒœã‚¿ãƒ³ã®è¿½åŠ 
      const actionTd = document.createElement('td');
      const deleteBtn = document.createElement('span');
      deleteBtn.innerHTML = 'ğŸ—‘ï¸';
      deleteBtn.className = 'delete-row';
      deleteBtn.onclick = (e) => {
        e.stopPropagation(); // è¡Œã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’é˜²æ­¢
        row.remove();
        applyCustomData();
      };
      actionTd.appendChild(deleteBtn);
      row.appendChild(actionTd);
      
      // è¡Œã‚¯ãƒªãƒƒã‚¯æ™‚ã®ã‚¤ãƒ™ãƒ³ãƒˆ
      row.addEventListener('click', () => {
        const lat = parseFloat(row.querySelector('.field-lat').value);
        const lon = parseFloat(row.querySelector('.field-lon').value);
        const name = row.querySelector('.field-name').value;
        
        if (!isNaN(lat) && !isNaN(lon)) {
          map.setView([lat, lon], 14);
        }
      });
      
      document.getElementById('plotsGrid').appendChild(row);
    }

    // ãƒ‡ãƒ¼ã‚¿ã‚’åœ°å›³ã«åæ˜ 
    function applyCustomData() {
      // æ—¢å­˜ã®ã‚«ã‚¹ã‚¿ãƒ ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¨ãƒãƒ¼ã‚«ãƒ¼ã‚’ã‚¯ãƒªã‚¢
      if (window.customLayers) {
        window.customLayers.forEach(layer => map.removeLayer(layer));
      }
      window.customLayers = [];
      markers.forEach(marker => map.removeLayer(marker));
      markers = [];

      const rows = document.querySelectorAll('#plotsGrid tr');
      const newData = [];
      
      rows.forEach(row => {
        try {
          const data = {
            name: row.querySelector('.field-name').value,
            startDate: row.querySelector('.field-startDate').value,
            endDate: row.querySelector('.field-endDate').value,
            sales: parseFloat(row.querySelector('.field-sales').value),
            customers: parseInt(row.querySelector('.field-customers').value),
            area: parseFloat(row.querySelector('.field-area').value),
            address: row.querySelector('.field-address').value,
            lat: parseFloat(row.querySelector('.field-lat').value),
            lon: parseFloat(row.querySelector('.field-lon').value),
            radius1: parseInt(row.querySelector('.field-radius1').value),
            radius2: parseInt(row.querySelector('.field-radius2').value),
            radius3: parseInt(row.querySelector('.field-radius3').value),
            color: row.querySelector('.field-color').value
          };
          
          if (!isNaN(data.lat) && !isNaN(data.lon)) {
            newData.push(data);
            
            // 3ã¤ã®å††ã‚’æç”»
            [data.radius1, data.radius2, data.radius3].forEach((radius, index) => {
              if (!isNaN(radius) && radius > 0) {
                const circle = L.circle([data.lat, data.lon], {
                  radius: radius,
                  color: data.color,
                  fillColor: data.color,
                  fillOpacity: 0.2 - (index * 0.05)
                }).addTo(map);
                window.customLayers.push(circle);
              }
            });
            
            // ãƒãƒ¼ã‚«ãƒ¼ã‚’è¿½åŠ 
            const marker = createMarker(data.lat, data.lon, data);
            marker.addTo(map);
            markers.push(marker);
          }
        } catch (error) {
          console.error('è¡Œã®ãƒ‡ãƒ¼ã‚¿å‡¦ç†ã‚¨ãƒ©ãƒ¼:', error);
        }
      });
      
      customData = newData;
    }

    // ãƒãƒ¼ã‚«ãƒ¼ã‚’ç®¡ç†ã™ã‚‹é…åˆ—
    let markers = [];

    // ãƒãƒ¼ã‚«ãƒ¼ã®ä½œæˆã¨è¿½åŠ 
    function createMarker(lat, lon, data) {
      const marker = L.marker([lat, lon]);
      
      marker.on('click', async () => {
        // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®ä½œæˆ
        const popupContent = `
          <div class="marker-popup">
            <h3>${data.name}</h3>
            <div class="marker-popup-content">
              <p><strong>ä½æ‰€:</strong> ${data.address || 'æœªè¨­å®š'}</p>
              <p><strong>ç·¯åº¦:</strong> ${lat}</p>
              <p><strong>çµŒåº¦:</strong> ${lon}</p>
              <p><strong>å£²ä¸Š:</strong> ${data.sales ? data.sales.toLocaleString() : 'æœªè¨­å®š'}</p>
              <p><strong>å®¢æ•°:</strong> ${data.customers ? data.customers.toLocaleString() : 'æœªè¨­å®š'}</p>
              <p><strong>é¢ç©:</strong> ${data.area ? data.area + 'mÂ²' : 'æœªè¨­å®š'}</p>
              <p><strong>æœŸé–“:</strong> ${data.startDate || 'æœªè¨­å®š'} ï½ ${data.endDate || 'æœªè¨­å®š'}</p>
            </div>
            <div class="marker-popup-links">
              <a href="https://www.google.com/maps/search/?api=1&query=${lat},${lon}" target="_blank">Google Mapã§é–‹ã</a>
              <a href="#" onclick="showPolygons(${lat}, ${lon}); return false;">å‘¨è¾ºãƒãƒªã‚´ãƒ³è¡¨ç¤º</a>
            </div>
          </div>
        `;
        
        marker.bindPopup(popupContent).openPopup();
        
        // å‘¨è¾ºãƒãƒªã‚´ãƒ³ã‚’å–å¾—ã—ã¦è¡¨ç¤º
        await showPolygons(lat, lon);
      });
      
      return marker;
    }

    // å‘¨è¾ºãƒãƒªã‚´ãƒ³ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°
    async function showPolygons(lat, lon) {
      try {
        const geojsonData = await fetchOverpassData(lat, lon, 1500);
        renderGeoJSON(geojsonData);
      } catch (error) {
        console.error('ãƒãƒªã‚´ãƒ³å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
      }
    }

    // ãƒãƒƒãƒ—ã®ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¨­å®š
    map.on('dblclick', function(e) {
      const lat = e.latlng.lat.toFixed(6);
      const lng = e.latlng.lng.toFixed(6);
      
      addNewRow({
        name: 'æ–°è¦ãƒã‚¤ãƒ³ãƒˆ',
        lat: lat,
        lon: lng,
        radius1: '500',
        radius2: '1000',
        radius3: '1500',
        color: '#66c2a5'
      });
    });

    // ãƒ‡ãƒ¼ã‚¿è¡Œé¸æŠæ™‚ã®ã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†ã‚’æ›´æ–°
    function addRowClickHandler(row, data) {
      row.addEventListener('click', async () => {
        const lat = parseFloat(data.lat);
        const lon = parseFloat(data.lon);
        
        if (!isNaN(lat) && !isNaN(lon)) {
          map.setView([lat, lon], 14);
          await showPolygons(lat, lon);
          
          // æ—¢å­˜ã®ãƒãƒ¼ã‚«ãƒ¼ã‚’æ¢ã—ã¦ã€ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’ãƒˆãƒªã‚¬ãƒ¼
          markers.forEach(marker => {
            if (marker.getLatLng().lat === lat && marker.getLatLng().lng === lon) {
              marker.fire('click');
            }
          });
        }
      });
    }

    // ãƒ‡ãƒ¼ã‚¿ã®ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå‡¦ç†
    function exportData(type, data) {
      const worksheet = XLSX.utils.json_to_sheet(data);
      const workbook = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(workbook, worksheet, 'Data');
      
      // Excelå½¢å¼ã§ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
      const excelBuffer = XLSX.write(workbook, { bookType: 'xlsx', type: 'array' });
      const blob = new Blob([excelBuffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `${type}_data.xlsx`;
      link.click();
    }

    // ãƒ‡ãƒ¼ã‚¿ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆå‡¦ç†
    function importData(file, type) {
      const reader = new FileReader();
      reader.onload = function(e) {
        if (file.name.endsWith('.csv')) {
          Papa.parse(file, {
            complete: function(results) {
              processImportedData(results.data, type);
            }
          });
        } else {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: 'array' });
          const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
          const jsonData = XLSX.utils.sheet_to_json(firstSheet);
          processImportedData(jsonData, type);
        }
      };
      reader.readAsArrayBuffer(file);
    }

    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¿½åŠ 
    document.getElementById('exportPlots').addEventListener('click', () => {
      exportData('plots', customData);
    });

    document.getElementById('exportPolygons').addEventListener('click', () => {
      exportData('polygons', polygonData);
    });

    document.getElementById('importPlots').addEventListener('change', (e) => {
      importData(e.target.files[0], 'plots');
    });

    document.getElementById('importPolygons').addEventListener('change', (e) => {
      importData(e.target.files[0], 'polygons');
    });

    // æ¤œç´¢çµæœã‚’ãƒ—ãƒ­ãƒƒãƒˆåœ°ç‚¹ãƒ†ãƒ¼ãƒ–ãƒ«ã«è¿½åŠ ã™ã‚‹é–¢æ•°
    function addSearchResultToPlots(lat, lon, displayName = 'æ¤œç´¢åœ°ç‚¹') {
      // ãƒ—ãƒ­ãƒƒãƒˆã‚¿ãƒ–ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«ã™ã‚‹
      document.querySelector('[data-tab="plots"]').click();
      
      // ãƒ—ãƒ­ãƒƒãƒˆåœ°ç‚¹ã¨ã—ã¦è¿½åŠ 
      addNewRow({
        name: displayName,
        lat: lat,
        lon: lon,
        radius: '1500',
        color: '#66c2a5'
      });
      
      // ãƒ†ãƒ¼ãƒ–ãƒ«ã«è¿½åŠ å¾Œã€åœ°å›³ã«åæ˜ 
      applyCustomData();
    }

    // åˆæœŸåŒ–å‡¦ç†ã‚’æ›´æ–°
    async function initialize() {
      try {
        // åœ°å›³ã®åˆæœŸè¡¨ç¤º
        await updateMapWithCoords(centerLat, centerLon, 'æ¸‹è°·é§…');
        
        // ãƒ—ãƒ­ãƒƒãƒˆåœ°ç‚¹ã‚¿ãƒ–ã«æ¸‹è°·é§…ã‚’è¿½åŠ 
        addNewRow(defaultPoint);
        
        // ãƒ—ãƒ­ãƒƒãƒˆåœ°ç‚¹ã‚’åœ°å›³ã«åæ˜ 
        applyCustomData();
        
        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®åˆæœŸåŒ–
        initEventListeners();
        initializeEventListeners();
      } catch (error) {
        console.error('åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
        showError(error.message);
      }
    }

    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¿½åŠ ã‚’ä¿®æ­£
    function initializeEventListeners() {
      // ãƒ—ãƒ­ãƒƒãƒˆé–¢é€£ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
      const addRowButton = document.getElementById('addPlotRow');
      const applyButton = document.getElementById('applyPlots');
      
      if (addRowButton) {
        addRowButton.addEventListener('click', () => addNewRow());
      }
      
      if (applyButton) {
        applyButton.addEventListener('click', applyCustomData);
      }

      // ãƒãƒƒãƒ—ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
      map.on('click', function(e) {
        const lat = e.latlng.lat.toFixed(6);
        const lng = e.latlng.lng.toFixed(6);
        
        addNewRow({
          name: 'æ–°è¦ãƒã‚¤ãƒ³ãƒˆ',
          lat: lat,
          lon: lng,
          radius: '1500',
          color: '#66c2a5'
        });
      });
    }

    // DOMContentLoadedã‚¤ãƒ™ãƒ³ãƒˆã§åˆæœŸåŒ–ã‚’å®Ÿè¡Œ
    document.addEventListener('DOMContentLoaded', initialize);

    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®åˆæœŸåŒ–ã‚’ä¸€æœ¬åŒ–
    function initializeEventListeners() {
      // æ¤œç´¢é–¢é€£
      const searchButton = document.getElementById('searchButton');
      if (searchButton) {
        searchButton.addEventListener('click', handleSearch);
      }

      // å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®Enterã‚­ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆ
      ['addressInput', 'latInput', 'lonInput'].forEach(id => {
        const element = document.getElementById(id);
        if (element) {
          element.addEventListener('keypress', e => {
            if (e.key === 'Enter') handleSearch();
          });
        }
      });

      // ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã®åˆ‡ã‚Šæ›¿ãˆ
      document.querySelectorAll('input[name="searchType"]').forEach(radio => {
        radio.addEventListener('change', () => {
          const addressGroup = document.getElementById('addressGroup');
          const coordsGroup = document.getElementById('coordsGroup');
          if (addressGroup && coordsGroup) {
            addressGroup.style.display = radio.value === 'address' ? 'flex' : 'none';
            coordsGroup.style.display = radio.value === 'coords' ? 'flex' : 'none';
          }
        });
      });

      // ãƒ—ãƒ­ãƒƒãƒˆé–¢é€£
      const addPlotRowButton = document.getElementById('addPlotRow');
      const applyPlotsButton = document.getElementById('applyPlots');
      const exportPlotsButton = document.getElementById('exportPlots');
      const importPlotsInput = document.getElementById('importPlots');

      if (addPlotRowButton) {
        addPlotRowButton.addEventListener('click', () => addNewRow());
      }

      if (applyPlotsButton) {
        applyPlotsButton.addEventListener('click', applyCustomData);
      }

      if (exportPlotsButton) {
        exportPlotsButton.addEventListener('click', () => exportData('plots', customData));
      }

      if (importPlotsInput) {
        importPlotsInput.addEventListener('change', (e) => importData(e.target.files[0], 'plots'));
      }

      // ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ›
      const fileInput = document.getElementById('fileInput');
      if (fileInput) {
        fileInput.addEventListener('change', handleFileSelect);
      }

      // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
      document.querySelectorAll('.tab-button').forEach(button => {
        button.addEventListener('click', () => {
          document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
          document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
          
          button.classList.add('active');
          const tabId = `${button.dataset.tab}Tab`;
          const tabContent = document.getElementById(tabId);
          if (tabContent) {
            tabContent.classList.add('active');
          }
        });
      });

      // ãƒãƒƒãƒ—ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
      map.on('click', function(e) {
        const lat = e.latlng.lat.toFixed(6);
        const lng = e.latlng.lng.toFixed(6);
        
        addNewRow({
          name: 'æ–°è¦ãƒã‚¤ãƒ³ãƒˆ',
          lat: lat,
          lon: lng,
          radius: '1500',
          color: '#66c2a5'
        });
      });
    }
  </script>
</body>
</html>
