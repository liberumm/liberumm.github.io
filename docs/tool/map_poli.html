<!DOCTYPE html>
<html>
<head>
  <title>React Leaflet with GSI Tiles</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <!-- osmtogeojson JS (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/osmtogeojson@3.0.0-beta.5/osmtogeojson.min.js"></script>

  <!-- turf.js for spatial operations -->
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

  <!-- SheetJS for Excel handling -->
  <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
  <!-- PapaParse for CSV handling -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.0/papaparse.min.js"></script>

  <style>
    body { 
      margin: 0; 
      padding: 0; 
      font-family: Arial, sans-serif;
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
    }

    /* æ¤œç´¢ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ‘ãƒãƒ« */
    #controls {
      padding: 15px;
      background: #f9f9f9;
      border-bottom: 1px solid #ccc;
      z-index: 1000;
    }

    /* åœ°å›³ã‚¨ãƒªã‚¢ */
    #map {
      height: 50vh;
      width: 100%;
      position: relative;
      z-index: 1;
    }

    /* åŠå¾„ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« */
    .radius-controls {
      padding: 10px;
      background: #f8f9f9;
      border-bottom: 1px solid #ccc;
    }

    /* ã‚¿ãƒ–ã¨ãƒ†ãƒ¼ãƒ–ãƒ«ã®ã‚³ãƒ³ãƒ†ãƒŠ */
    .data-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .tab-container {
      background: #fff;
      border-bottom: 1px solid #ccc;
    }

    #dataEditor {
      flex: 1;
      overflow: auto;
    }

    body { margin: 0; padding: 0; font-family: Arial, sans-serif; }
    #map { width: 100%; height: 55vh; }
    #controls {
      width: 100%;
      height: 15vh;
      background: #f9f9f9;
      padding: 10px;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      border-bottom: 1px solid #ccc;
    }
    .input-group {
      margin: 5px 0;
      display: flex;
      align-items: center;
    }
    .input-group label {
      margin-right: 10px;
      font-weight: bold;
    }
    #addressInput, #latInput, #lonInput {
      width: 300px;
      padding: 8px;
      font-size: 16px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    #latInput, #lonInput {
      width: 140px;
    }
    #searchButton {
      padding: 8px 16px;
      margin-top: 10px;
      font-size: 16px;
      border: none;
      border-radius: 4px;
      background-color: #66c2a5;
      color: white;
      cursor: pointer;
    }
    #searchButton:hover {
      background-color: #559f8f;
    }
    #info {
      position: absolute;
      top: 60px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255, 255, 255, 0.9);
      padding: 10px;
      border-radius: 5px;
      z-index: 1000;
      font-size: 14px;
      display: none;
      max-width: 80%;
      word-wrap: break-word;
    }
    .radio-group {
      margin: 10px 0;
      display: flex;
      align-items: center;
    }
    .radio-group input {
      margin-right: 5px;
    }
    .loading {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(255, 255, 255, 0.9);
      padding: 20px;
      border-radius: 5px;
      z-index: 1000;
    }
    #resultStats {
      margin-top: 10px;
      font-size: 0.9em;
      color: #666;
    }
    .error {
      color: #d32f2f;
      background: #ffebee;
      padding: 10px;
      border-radius: 4px;
      margin-top: 10px;
    }
    #dataEditor {
      width: 100%;
      height: 30vh;
      background: #ffffff;
      padding: 10px;
      box-sizing: border-box;
      border-top: 1px solid #ccc;
    }
    .data-grid {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    .data-grid th, .data-grid td {
      border: 1px solid #ddd;
      padding: 4px;
      text-align: left;
      font-size: 12px;
    }
    .data-grid input {
      width: 90%;
      padding: 2px;
      font-size: 12px;
    }
    .data-grid th {
      background-color: #f5f5f5;
    }
    .data-actions {
      margin: 10px 0;
    }
    .data-actions button {
      margin-right: 10px;
      padding: 5px 10px;
      background-color: #66c2a5;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .delete-row {
      color: #d32f2f;
      cursor: pointer;
    }
    .search-address-btn {
      padding: 2px 4px;
      margin-left: 4px;
      background: #66c2a5;
      color: white;
      border: none;
      border-radius: 3px;
      cursor: pointer;
    }
    .data-grid tr:hover {
      background-color: #f5f5f5;
      cursor: pointer;
    }
    /* ã‚¿ãƒ–ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
    .tab-container {
      width: 100%;
      margin-top: 10px;
    }
    
    .tab-buttons {
      display: flex;
      border-bottom: 1px solid #ccc;
    }
    
    .tab-button {
      padding: 10px 20px;
      border: none;
      background: none;
      cursor: pointer;
    }
    
    .tab-button.active {
      border-bottom: 2px solid #66c2a5;
      font-weight: bold;
    }
    
    .tab-content {
      display: none;
      padding: 15px;
    }
    
    .tab-content.active {
      display: block;
    }

    /* çµ±è¨ˆæƒ…å ±è¡¨ç¤ºã®æ”¹å–„ */
    #statsContainer {
      position: fixed;
      top: 10px;
      right: 10px;
      background: rgba(255, 255, 255, 0.9);
      padding: 10px;
      border-radius: 5px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      z-index: 1000;
    }

    /* ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ/ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒœã‚¿ãƒ³ */
    .data-actions {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
    }

    .action-button {
      padding: 5px 10px;
      background: #66c2a5;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    .action-button:hover {
      background: #559f8f;
    }

    /* ãƒ†ãƒ¼ãƒ–ãƒ«åˆ—å¹…ã®èª¿æ•´ */
    .data-grid th, .data-grid td {
      padding: 4px;
      font-size: 12px;
    }
    .data-grid th:nth-child(1), .data-grid td:nth-child(1) { width: 150px; } /* åç§° */
    .data-grid th:nth-child(2), .data-grid td:nth-child(2) { width: 100px; } /* é–‹å§‹æ—¥ */
    .data-grid th:nth-child(3), .data-grid td:nth-child(3) { width: 100px; } /* çµ‚äº†æ—¥ */
    .data-grid th:nth-child(4), .data-grid td:nth-child(4) { width: 80px; } /* å£²ä¸Š */
    .data-grid th:nth-child(5), .data-grid td:nth-child(5) { width: 80px; } /* å®¢æ•° */
    .data-grid th:nth-child(6), .data-grid td:nth-child(6) { width: 80px; } /* é¢ç© */
    .data-grid th:nth-child(7), .data-grid td:nth-child(7) { width: 200px; } /* ä½æ‰€ */
    .data-grid th:nth-child(8), .data-grid td:nth-child(8) { width: 90px; } /* ç·¯åº¦ */
    .data-grid th:nth-child(9), .data-grid td:nth-child(9) { width: 90px; } /* çµŒåº¦ */
    .data-grid th:nth-child(10), .data-grid td:nth-child(10) { width: 70px; } /* åŠå¾„1 */
    .data-grid th:nth-child(11), .data-grid td:nth-child(11) { width: 70px; } /* åŠå¾„2 */
    .data-grid th:nth-child(12), .data-grid td:nth-child(12) { width: 70px; } /* åŠå¾„3 */
    .data-grid th:nth-child(13), .data-grid td:nth-child(13) { width: 70px; } /* è‰² */
    .data-grid th:nth-child(14), .data-grid td:nth-child(14) { width: 50px; } /* æ“ä½œ */

    /* ãƒãƒ¼ã‚«ãƒ¼ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .marker-popup {
      min-width: 300px;
    }
    .marker-popup h3 {
      margin: 0 0 10px 0;
      color: #333;
    }
    .marker-popup-content {
      margin-bottom: 10px;
    }
    .marker-popup-links {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }
    .marker-popup-links a {
      padding: 5px 10px;
      background: #66c2a5;
      color: white;
      text-decoration: none;
      border-radius: 3px;
    }
    .marker-popup-links a:hover {
      background: #559f8f;
    }

    /* ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆé¢¨ãƒ†ãƒ¼ãƒ–ãƒ«ã‚¹ã‚¿ã‚¤ãƒ« */
    .data-grid {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
      background: white;
    }

    .data-grid th, .data-grid td {
      border: 1px solid #e0e0e0;
      padding: 6px;
      position: relative;
    }

    .data-grid th {
      background: #f5f5f5;
      font-weight: bold;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .data-grid tr:hover {
      background-color: #f8f9fa;
    }

    .data-grid input, .data-grid select {
      width: 100%;
      padding: 4px;
      border: none;
      background: transparent;
      font-size: 12px;
    }

    .data-grid input:focus, .data-grid select:focus {
      outline: none;
      background: #e8f0fe;
    }

    /* è‰²é¸æŠç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .color-input-group {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .color-input-group input[type="color"] {
      width: 25px;
      height: 25px;
      padding: 0;
      border: none;
    }

    /* ãƒ†ãƒ¼ãƒ–ãƒ«ã®ãƒ˜ãƒƒãƒ€ãƒ¼å›ºå®š */
    #dataEditor {
      overflow: auto;
      position: relative;
    }

    /* ãƒ†ãƒ¼ãƒ–ãƒ«ã®åˆ—å¹…èª¿æ•´ */
    .data-grid th:nth-child(1), .data-grid td:nth-child(1) { min-width: 120px; } /* åç§° */
    .data-grid th:nth-child(2), .data-grid td:nth-child(2) { min-width: 100px; } /* é–‹å§‹æ—¥ */
    .data-grid th:nth-child(3), .data-grid td:nth-child(3) { min-width: 100px; } /* çµ‚äº†æ—¥ */
    .data-grid th:nth-child(4), .data-grid td:nth-child(4) { min-width: 80px; } /* å£²ä¸Š */
    .data-grid th:nth-child(5), .data-grid td:nth-child(5) { min-width: 80px; } /* å®¢æ•° */
    .data-grid th:nth-child(6), .data-grid td:nth-child(6) { min-width: 80px; } /* é¢ç© */
    .data-grid th:nth-child(7), .data-grid td:nth-child(7) { min-width: 200px; } /* ä½æ‰€ */
    .data-grid th:nth-child(8), .data-grid td:nth-child(8) { min-width: 90px; } /* ç·¯åº¦ */
    .data-grid th:nth-child(9), .data-grid td:nth-child(9) { min-width: 90px; } /* çµŒåº¦ */
    .data-grid th[data-radius], .data-grid td[data-radius] { min-width: 120px; } /* åŠå¾„+è‰² */

    .radius-controls {
      display: flex;
      gap: 20px;
      align-items: center;
      margin: 10px 0;
      padding: 10px;
      background: #f8f9fa;
      border-radius: 4px;
    }

    .radius-control-group {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .radius-control-group label {
      font-weight: bold;
      min-width: 60px;
    }

    .radius-control-group input[type="number"] {
      width: 80px;
      padding: 4px;
    }

    .radius-control-group input[type="color"] {
      width: 30px;
      height: 30px;
      padding: 0;
      border: none;
    }

    /* ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã¨ãƒœã‚¿ãƒ³åˆ—ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .data-grid th:first-child,
    .data-grid td:first-child {
      width: 30px;
      text-align: center;
    }

    .data-grid th:nth-child(2),
    .data-grid td:nth-child(2) {
      width: 50px;
      text-align: center;
    }

    .center-map-btn {
      background: none;
      border: none;
      cursor: pointer;
      padding: 2px;
      font-size: 20px;
    }

    /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãƒ‡ã‚¶ã‚¤ãƒ³ã®åŸºæœ¬è¨­å®š */
    .container {
      display: grid;
      grid-template-rows: auto 1fr auto;
      height: 100vh;
      overflow: hidden;
    }

    /* ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ‘ãƒãƒ«ã®ã‚¹ã‚¿ã‚¤ãƒ«æ›´æ–° */
    #controls {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 1000;
      background: rgba(255, 255, 255, 0.9);
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      max-width: 400px;
      height: auto;
    }

    /* åœ°å›³ã¨ãƒ‡ãƒ¼ã‚¿ã‚¨ãƒ‡ã‚£ã‚¿ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
    #map {
      height: 60vh;
      width: 100%;
      z-index: 1;
    }

    #dataEditor {
      height: 40vh;
      overflow: auto;
    }

    /* ãƒ†ãƒ¼ãƒ–ãƒ«åˆ—å¹…ã®æœ€é©åŒ– */
    .data-grid th, .data-grid td {
      padding: 6px;
      font-size: 12px;
    }
    .data-grid th:nth-child(1), .data-grid td:nth-child(1) { width: 30px; } /* ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ */
    .data-grid th:nth-child(2), .data-grid td:nth-child(2) { width: 40px; } /* è¡¨ç¤ºãƒœã‚¿ãƒ³ */
    .data-grid th:nth-child(3), .data-grid td:nth-child(3) { width: 120px; } /* åç§° */
    .data-grid th:nth-child(4), .data-grid td:nth-child(4) { width: 90px; } /* é–‹å§‹æ—¥ */
    .data-grid th:nth-child(5), .data-grid td:nth-child(5) { width: 90px; } /* çµ‚äº†æ—¥ */
    .data-grid th:nth-child(6), .data-grid td:nth-child(6) { width: 70px; } /* å£²ä¸Š */
    .data-grid th:nth-child(7), .data-grid td:nth-child(7) { width: 70px; } /* å®¢æ•° */
    .data-grid th:nth-child(8), .data-grid td:nth-child(8) { width: 70px; } /* é¢ç© */
    .data-grid th:nth-child(9), .data-grid td:nth-child(9) { width: 200px; } /* ä½æ‰€ */
    
    /* ä½æ‰€æ¤œç´¢ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .address-search-group {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .address-search-btn {
      padding: 2px 8px;
      background: #66c2a5;
      color: white;
      border: none;
      border-radius: 3px;
      cursor: pointer;
      font-size: 12px;
    }

    /* ãƒ†ãƒ¼ãƒ–ãƒ«ã®ã‚¹ã‚¿ã‚¤ãƒ«ä¿®æ­£ */
    .data-grid {
      width: 100%;
      border-collapse: collapse;
      border: 1px solid #ddd;
    }

    .data-grid th, 
    .data-grid td {
      border: 1px solid #ddd;
      padding: 6px;
      vertical-align: middle;
    }

    .data-grid th {
      background-color: #f5f5f5;
      border-bottom: 2px solid #ddd;
    }

    .data-grid input {
      width: 100%;
      box-sizing: border-box;
      padding: 4px;
      border: none;
      background: transparent;
    }

    .data-grid tr:hover {
      background-color: #f8f9fa;
    }

    /* ä½æ‰€æ¤œç´¢ã‚°ãƒ«ãƒ¼ãƒ—ã®ã‚¹ã‚¿ã‚¤ãƒ«ä¿®æ­£ */
    .address-search-group {
      display: flex;
      align-items: center;
      gap: 4px;
      width: 100%;
    }

    .address-search-group input {
      flex: 1;
      min-width: 0;
    }

    .address-search-btn {
      flex-shrink: 0;
      padding: 4px 8px;
      margin-left: 4px;
    }
  </style>
</head>
<body>
  <!-- æ¤œç´¢ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« -->
  <div id="controls">
    <div class="radio-group">
      <input type="radio" id="searchByAddress" name="searchType" value="address" checked>
      <label for="searchByAddress">ä½æ‰€ã§æ¤œç´¢</label>
      <input type="radio" id="searchByCoords" name="searchType" value="coords" style="margin-left: 20px;">
      <label for="searchByCoords">ç·¯åº¦çµŒåº¦ã§æ¤œç´¢</label>
    </div>
    <div class="input-group" id="addressGroup">
      <label for="addressInput">ä½æ‰€:</label>
      <input type="text" id="addressInput" placeholder="ä½æ‰€ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„" />
    </div>
    <div class="input-group" id="coordsGroup" style="display: none;">
      <label for="latInput">ç·¯åº¦:</label>
      <input type="text" id="latInput" placeholder="ä¾‹: 35.6871682" />
      <label for="lonInput" style="margin-left: 10px;">çµŒåº¦:</label>
      <input type="text" id="lonInput" placeholder="ä¾‹: 139.710645" />
    </div>
    <button id="searchButton">æ¤œç´¢</button>
    <div id="resultStats"></div>
  </div>

  <!-- åœ°å›³ -->
  <div id="map"></div>

  <!-- åŠå¾„ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« -->
  <div class="radius-controls">
    <div class="radius-control-group">
      <label>åŠå¾„1:</label>
      <input type="number" id="globalRadius1" value="500" min="0" max="5000">
      <input type="color" id="globalColor1" value="#66c2a5">
    </div>
    <div class="radius-control-group">
      <label>åŠå¾„2:</label>
      <input type="number" id="globalRadius2" value="1000" min="0" max="5000">
      <input type="color" id="globalColor2" value="#fc8d62">
    </div>
    <div class="radius-control-group">
      <label>åŠå¾„3:</label>
      <input type="number" id="globalRadius3" value="1500" min="0" max="5000">
      <input type="color" id="globalColor3" value="#8da0cb">
    </div>
    <button id="applyGlobalRadius" class="action-button">ä¸€æ‹¬é©ç”¨</button>
  </div>

  <!-- ãƒ‡ãƒ¼ã‚¿è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
  <div class="data-container">
    <!-- ã‚¿ãƒ– -->
    <div class="tab-container">
      <div class="tab-buttons">
        <button class="tab-button active" data-tab="plots">ãƒ—ãƒ­ãƒƒãƒˆåœ°ç‚¹</button>
        <button class="tab-button" data-tab="polygons">ç”ºä¸ç›®ãƒãƒªã‚´ãƒ³</button>
      </div>
    </div>

    <!-- ãƒ†ãƒ¼ãƒ–ãƒ« -->
    <div id="dataEditor">
      <!-- ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
      <div id="plotsTab" class="tab-content active">
        <div class="data-actions">
          <button class="action-button" id="addPlotRow">æ–°è¦è¿½åŠ </button>
          <button class="action-button" id="applyPlots">åœ°å›³ã«åæ˜ </button>
          <button class="action-button" id="exportPlots">ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
          <input type="file" id="importPlots" accept=".csv,.xlsx" style="display: none;">
          <button class="action-button" onclick="document.getElementById('importPlots').click()">ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
        </div>
        <table class="data-grid">
          <thead>
            <tr>
              <th><input type="checkbox" id="selectAll"></th>
              <th>è¡¨ç¤º</th>
              <th>åç§°</th>
              <th>é–‹å§‹æ—¥</th>
              <th>çµ‚äº†æ—¥</th>
              <th>å£²ä¸Š</th>
              <th>å®¢æ•°</th>
              <th>é¢ç©</th>
              <th>ä½æ‰€</th>
              <th>ç·¯åº¦</th>
              <th>çµŒåº¦</th>
              <th data-radius="1">åŠå¾„1 & è‰²</th>
              <th data-radius="2">åŠå¾„2 & è‰²</th>
              <th data-radius="3">åŠå¾„3 & è‰²</th>
              <th>æ“ä½œ</th>
            </tr>
          </thead>
          <tbody id="plotsGrid"></tbody>
        </table>
      </div>
      
      <div id="polygonsTab" class="tab-content">
        <div class="data-actions">
          <button class="action-button" id="addPolygonRow">æ–°è¦è¿½åŠ </button>
          <button class="action-button" id="applyPolygons">åœ°å›³ã«åæ˜ </button>
          <button class="action-button" id="exportPolygons">ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
          <input type="file" id="importPolygons" accept=".csv,.xlsx" style="display: none;">
          <button class="action-button" onclick="document.getElementById('importPolygons').click()">ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
        </div>
        <table class="data-grid">
          <thead>
            <tr>
              <th>ç”ºä¸ç›®å</th>
              <th>ãƒãƒªã‚´ãƒ³ãƒ‡ãƒ¼ã‚¿</th>
              <th>è‰²</th>
              <th>æ“ä½œ</th>
            </tr>
          </thead>
          <tbody id="polygonsGrid"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- çµ±è¨ˆæƒ…å ±è¡¨ç¤ºç”¨ã®è¦ç´  -->
  <div id="statsContainer" style="display: none;">
    <div id="polygonStats"></div>
  </div>

  <script>
    // åˆæœŸè¨­å®šï¼ˆæ¸‹è°·ï¼‰
    let centerLat = 35.6580;
    let centerLon = 139.7016;
    const radius = 1500; // åŠå¾„1500m

    // åˆæœŸãƒã‚¤ãƒ³ãƒˆã®ãƒ‡ãƒ¼ã‚¿
    const defaultPoint = {
      name: 'æ¸‹è°·é§…',
      lat: 35.6580,
      lon: 139.7016,
      radius: 1500,
      color: '#66c2a5'
    };

    // åœ°å›³ã®åˆæœŸåŒ–
    const map = L.map('map').setView([centerLat, centerLon], 14);

    // èƒŒæ™¯åœ°å›³ï¼šå›½åœŸåœ°ç†é™¢ã®åœ°ç†é™¢åœ°å›³
    L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="https://maps.gsi.go.jp/">å›½åœŸåœ°ç†é™¢</a>'
    }).addTo(map);

    // åˆæœŸå††ã®æç”»
    let searchCircle = L.circle([centerLat, centerLon], {
      radius: radius, // åŠå¾„1500m
      color: 'blue', // å¢ƒç•Œç·šã®è‰²
      weight: 2,     // å¢ƒç•Œç·šã®å¤ªã•
      fillOpacity: 0.1 // å¡—ã‚Šã¤ã¶ã—ã®é€æ˜åº¦
    }).addTo(map);

    // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’å°å…¥ã—ã¦APIå‘¼ã³å‡ºã—ã‚’æœ€é©åŒ–
    const cache = new Map();
    
    // ãƒ‡ãƒã‚¦ãƒ³ã‚¹é–¢æ•°
    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    // Overpass APIã‚¯ã‚¨ãƒªã‚’ç”Ÿæˆã™ã‚‹é–¢æ•°ã‚’ä¿®æ­£
    function generateOverpassQuery(lat, lon, radius) {
      return `
[out:json][timeout:25];
(
  way["boundary"="administrative"]["admin_level"~"^(8|9|10)$"](around:${radius},${lat},${lon});
  relation["boundary"="administrative"]["admin_level"~"^(8|9|10)$"](around:${radius},${lat},${lon});
);
out body;
>;
out skel qt;`;
    }

    const overpassApiUrl = 'https://overpass-api.de/api/interpreter';

    // æƒ…å ±è¡¨ç¤ºç”¨è¦ç´ 
    const infoDiv = document.getElementById('info');

    // æ¤œç´¢ã—ãŸä½æ‰€ã®ãƒãƒ¼ã‚«ãƒ¼ã‚’ä¿æŒ
    let addressMarker = null;

    // GeoJSONãƒ‡ãƒ¼ã‚¿ã®æç”»ã‚’ä¿®æ­£
    function renderGeoJSON(geojsonData) {
      // æ—¢å­˜ã®ãƒãƒªã‚´ãƒ³ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’å‰Šé™¤
      if (polygonLayer && map.hasLayer(polygonLayer)) {
        map.removeLayer(polygonLayer);
      }

      // GeoJSONã‚’åœ°å›³ã«è¿½åŠ 
      polygonLayer = L.geoJSON(geojsonData, {
        style: function(feature) {
          return {
            fillColor: '#66c2a5',
            fillOpacity: 0.3,
            color: '#1b7837',
            weight: 2
          };
        },
        onEachFeature: function(feature, layer) {
          const name = feature.properties?.tags?.name || 'ä¸æ˜';
          const adminLevel = feature.properties?.tags?.admin_level || 'ä¸æ˜';
          
          // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ä½œæˆ
          let popupContent = `
            <div class="marker-popup">
              <h3>${name}</h3>
              <p><strong>Admin Level:</strong> ${adminLevel}</p>
            </div>`;

          try {
            const centroid = turf.centroid(feature);
            const lat = centroid.geometry.coordinates[1].toFixed(6);
            const lon = centroid.geometry.coordinates[0].toFixed(6);
            popupContent += `
              <p><strong>ä¸­å¿ƒç‚¹ç·¯åº¦:</strong> ${lat}</p>
              <p><strong>ä¸­å¿ƒç‚¹çµŒåº¦:</strong> ${lon}</p>`;
          } catch (error) {
            console.error('ã‚»ãƒ³ãƒˆãƒ­ã‚¤ãƒ‰è¨ˆç®—ã‚¨ãƒ©ãƒ¼:', error);
          }

          layer.bindPopup(popupContent);
        }
      }).addTo(map);

      // çµ±è¨ˆæƒ…å ±ã‚’æ›´æ–°
      updateStats(geojsonData);
    }

    // Overpass APIã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹é–¢æ•°ã‚’ä¿®æ­£
    async function fetchOverpassData(lat, lon, radius) {
      const cacheKey = `${lat},${lon},${radius}`;
      if (cache.has(cacheKey)) {
        return cache.get(cacheKey);
      }

      try {
        const query = generateOverpassQuery(lat, lon, radius);
        console.log('Overpass Query:', query); // ãƒ‡ãƒãƒƒã‚°ç”¨

        const response = await fetch(overpassApiUrl, {
          method: 'POST',
          headers: {'Content-Type': 'application/x-www-form-urlencoded'},
          body: 'data=' + encodeURIComponent(query)
        });

        if (!response.ok) throw new Error('Network response was not ok');
        
        const data = await response.json();
        console.log('Overpass Response:', data); // ãƒ‡ãƒãƒƒã‚°ç”¨
        
        const geojsonData = osmtogeojson(data);
        console.log('Converted GeoJSON:', geojsonData); // ãƒ‡ãƒãƒƒã‚°ç”¨
        
        cache.set(cacheKey, geojsonData);
        return geojsonData;
      } catch (error) {
        console.error('Overpassãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
        throw new Error('ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
      }
    }

    // å›½åœŸåœ°ç†é™¢ã®ã‚¸ã‚ªã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°APIã‚’ä½¿ç”¨ã—ã¦ä½æ‰€ã‹ã‚‰ç·¯åº¦çµŒåº¦ã‚’å–å¾—ã™ã‚‹é–¢æ•°
    function geocodeAddressGSI(address) {
      // å›½åœŸåœ°ç†é™¢ã®ã‚¸ã‚ªã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
      const gsiGeocoderUrl = `https://msearch.gsi.go.jp/address-search/AddressSearch?q=${encodeURIComponent(address)}`;

      console.log('GSI ã‚¸ã‚ªã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒªã‚¯ã‚¨ã‚¹ãƒˆ URL:', gsiGeocoderUrl); // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°

      return fetch(gsiGeocoderUrl)
        .then(response => {
          if (!response.ok) {
            throw new Error('Network response was not ok: ' + response.statusText);
          }
          return response.json();
        })
        .then(data => {
          // ãƒ‡ãƒãƒƒã‚°ç”¨ãƒ­ã‚°
          console.log('å–å¾—ã—ãŸGSIã‚¸ã‚ªã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿:', data);

          if (!data || data.length === 0) {
            throw new Error('ä½æ‰€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚');
          }

          // ã€Œæ±äº¬éƒ½ã€ã‚’å«ã‚€çµæœã‚’å„ªå…ˆçš„ã«ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
          const tokyoResults = data.filter(result => {
            return result.address && result.address.includes('æ±äº¬éƒ½');
          });

          let selectedResult;

          if (tokyoResults.length > 0) {
            // ã€Œæ±äº¬éƒ½ã€ã‚’å«ã‚€æœ€åˆã®çµæœã‚’é¸æŠ
            selectedResult = tokyoResults[0];
          } else {
            // ã€Œæ±äº¬éƒ½ã€ã‚’å«ã¾ãªã„å ´åˆã¯æœ€åˆã®çµæœã‚’ä½¿ç”¨
            selectedResult = data[0];
          }

          const coordinates = selectedResult.geometry.coordinates; // [çµŒåº¦, ç·¯åº¦]

          // displayNameã®å–å¾—æ–¹æ³•ã‚’ä¿®æ­£
          const displayName = selectedResult.address || address;

          console.log('ã‚¸ã‚ªã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çµæœ:', coordinates, displayName); // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°

          return {
            lat: coordinates[1],
            lon: coordinates[0],
            displayName: displayName
          };
        });
    }

    // ç·¯åº¦çµŒåº¦ã‚’ä½¿ç”¨ã—ã¦åœ°å›³ã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
    const updateMapWithCoords = debounce(async (lat, lon, displayName = 'æŒ‡å®šåº§æ¨™') => {
      try {
        // æ—¢å­˜ã®ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’ã‚¯ãƒªã‚¢ï¼ˆã‚«ã‚¹ã‚¿ãƒ ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯ç¶­æŒï¼‰
        if (searchCircle) map.removeLayer(searchCircle);
        if (addressMarker) map.removeLayer(addressMarker);
        if (polygonLayer) map.removeLayer(polygonLayer);

        // æ–°ã—ã„è¡¨ç¤ºè¦ç´ ã‚’è¿½åŠ 
        searchCircle = L.circle([lat, lon], {
          radius,
          color: 'blue',
          weight: 2,
          fillOpacity: 0.1
        }).addTo(map);

        addressMarker = L.marker([lat, lon])
          .bindPopup(`<b>æ¤œç´¢çµæœ:</b> ${displayName}<br><b>ç·¯åº¦:</b> ${lat.toFixed(6)}<br><b>çµŒåº¦:</b> ${lon.toFixed(6)}`)
          .addTo(map);

        // ãƒ‡ãƒ¼ã‚¿å–å¾—ã¨æç”»
        const geojsonData = await fetchOverpassData(lat, lon, radius);
        renderGeoJSON(geojsonData);

        // çµ±è¨ˆæƒ…å ±ã‚’æ›´æ–°
        updateStats(geojsonData);

        map.setView([lat, lon], 14);
      } catch (error) {
        showError(error.message);
      }
    }, 500);

    // çµ±è¨ˆæƒ…å ±ã®æ›´æ–°
    function updateStats(geojsonData) {
      const stats = document.getElementById('polygonStats');
      const count = geojsonData.features.length;
      stats.innerHTML = `
        <strong>ãƒãƒªã‚´ãƒ³çµ±è¨ˆ:</strong><br>
        å–å¾—: ${count}ä»¶<br>
        è¡¨ç¤º: ${count}ä»¶
      `;
      document.getElementById('statsContainer').style.display = 'block';
    }

    // ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
    function showError(message) {
      const stats = document.getElementById('resultStats');
      stats.innerHTML = `<div class="error">${message}</div>`;
    }

    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’æœ€é©åŒ–
    function initEventListeners() {
      document.getElementById('searchButton').addEventListener('click', handleSearch);
      
      ['addressInput', 'latInput', 'lonInput'].forEach(id => {
        document.getElementById(id).addEventListener('keypress', e => {
          if (e.key === 'Enter') handleSearch();
        });
      });

      // ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã®åˆ‡ã‚Šæ›¿ãˆ
      document.querySelectorAll('input[name="searchType"]').forEach(radio => {
        radio.addEventListener('change', () => {
          document.getElementById('addressGroup').style.display = 
            radio.value === 'address' ? 'flex' : 'none';
          document.getElementById('coordsGroup').style.display = 
            radio.value === 'coords' ? 'flex' : 'none';
        });
      });
    }

    // æ¤œç´¢ãƒãƒ³ãƒ‰ãƒ©ã‚’çµ±åˆ
    async function handleSearch() {
      const searchType = document.querySelector('input[name="searchType"]:checked').value;
      
      try {
        if (searchType === 'address') {
          const address = document.getElementById('addressInput').value.trim();
          if (!address) throw new Error('ä½æ‰€ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
          
          const result = await geocodeAddressGSI(address);
          updateMapWithCoords(result.lat, result.lon, result.displayName);
          // æ¤œç´¢çµæœã‚’ãƒ—ãƒ­ãƒƒãƒˆåœ°ç‚¹ã«è¿½åŠ ï¼ˆé‡è¤‡è¿½åŠ ã‚’é˜²æ­¢ï¼‰
          addSearchResultToPlots(result.lat, result.lon, result.displayName);
        } else {
          const lat = parseFloat(document.getElementById('latInput').value);
          const lon = parseFloat(document.getElementById('lonInput').value);
          
          if (isNaN(lat) || isNaN(lon)) throw new Error('æœ‰åŠ¹ãªç·¯åº¦çµŒåº¦ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
          if (lat < -90 || lat > 90) throw new Error('ç·¯åº¦ã¯ -90 ã‹ã‚‰ 90 ã®ç¯„å›²ã§å…¥åŠ›ã—ã¦ãã ã•ã„');
          if (lon < -180 || lon > 180) throw new Error('çµŒåº¦ã¯ -180 ã‹ã‚‰ 180 ã®ç¯„å›²ã§å…¥åŠ›ã—ã¦ãã ã•ã„');
          
          updateMapWithCoords(lat, lon);
          // æ¤œç´¢çµæœã‚’ãƒ—ãƒ­ãƒƒãƒˆåœ°ç‚¹ã«è¿½åŠ 
          addSearchResultToPlots(lat, lon, 'åº§æ¨™æŒ‡å®šåœ°ç‚¹');
        }
      } catch (error) {
        showError(error.message);
      }
    }

    // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠãƒãƒ³ãƒ‰ãƒ©
    function handleFileSelect(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const firstSheetName = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[firstSheetName];
        const json = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

        // CSVãƒ•ã‚¡ã‚¤ãƒ«ã®å ´åˆ
        if (file.type === 'text/csv') {
          Papa.parse(file, {
            complete: function(results) {
              console.log('CSVãƒ‡ãƒ¼ã‚¿:', results.data);
              // CSVãƒ‡ãƒ¼ã‚¿ã®å‡¦ç†
            }
          });
        } else {
          console.log('Excelãƒ‡ãƒ¼ã‚¿:', json);
          // Excelãƒ‡ãƒ¼ã‚¿ã®å‡¦ç†
        }
      };
      reader.readAsArrayBuffer(file);
    }

    // ãƒ‡ãƒ¼ã‚¿ç®¡ç†ç”¨ã®é…åˆ—
    let customData = [];

    // æ–°è¦è¡Œã®è¿½åŠ 
    function addNewRow(data = null) {
      const row = document.createElement('tr');
      
      // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹åˆ—
      const checkboxTd = document.createElement('td');
      const checkbox = document.createElement('input');
      checkbox.type = 'checkbox';
      checkbox.className = 'row-selector';
      checkboxTd.appendChild(checkbox);
      row.appendChild(checkboxTd);

      // åœ°å›³ä¸­å¿ƒè¡¨ç¤ºãƒœã‚¿ãƒ³åˆ—
      const centerBtnTd = document.createElement('td');
      const centerBtn = document.createElement('button');
      centerBtn.innerHTML = 'ğŸ“';
      centerBtn.className = 'center-map-btn';
      centerBtn.onclick = async (e) => {
        e.stopPropagation();
        const lat = parseFloat(row.querySelector('.field-lat').value);
        const lon = parseFloat(row.querySelector('.field-lon').value);
        if (!isNaN(lat) && !isNaN(lon)) {
          map.setView([lat, lon], 14);
          await showPolygons(lat, lon); // ãƒãƒªã‚´ãƒ³è¡¨ç¤ºã‚’è¿½åŠ 
        }
      };
      centerBtnTd.appendChild(centerBtn);
      row.appendChild(centerBtnTd);

      const fields = [
        { name: 'name', type: 'text' },
        { name: 'startDate', type: 'date' },
        { name: 'endDate', type: 'date' },
        { name: 'sales', type: 'number' },
        { name: 'customers', type: 'number' },
        { name: 'area', type: 'number' },
        { name: 'address', type: 'text' },
        { name: 'lat', type: 'number' },
        { name: 'lon', type: 'number' }
      ];

      // åŸºæœ¬ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ä½œæˆ
      fields.forEach(field => {
        const td = document.createElement('td');
        const input = document.createElement('input');
        input.type = field.type;
        input.className = `field-${field.name}`;
        if (data && data[field.name]) {
          input.value = data[field.name];
        }
        td.appendChild(input);
        row.appendChild(td);
      });

      // åŠå¾„ã¨è‰²ã®å…¥åŠ›ã‚°ãƒ«ãƒ¼ãƒ—ã‚’ä½œæˆ
      [1, 2, 3].forEach(i => {
        const td = document.createElement('td');
        td.setAttribute('data-radius', i);
        
        const group = document.createElement('div');
        group.className = 'color-input-group';

        const radiusInput = document.createElement('input');
        radiusInput.type = 'number';
        radiusInput.className = `field-radius${i}`;
        radiusInput.value = data ? data[`radius${i}`] || 500 * i : 500 * i;
        radiusInput.style.width = '50px';

        const colorInput = document.createElement('input');
        colorInput.type = 'color';
        colorInput.className = `field-color${i}`;
        colorInput.value = data ? data[`color${i}`] || getDefaultColor(i) : getDefaultColor(i);

        group.appendChild(radiusInput);
        group.appendChild(colorInput);
        td.appendChild(group);
        row.appendChild(td);
      });

      // ä½æ‰€ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ä½œæˆã‚’æ›´æ–°
      const addressTd = document.createElement('td');
      const addressGroup = document.createElement('div');
      addressGroup.className = 'address-search-group';
      
      const addressInput = document.createElement('input');
      addressInput.type = 'text';
      addressInput.className = 'field-address';
      if (data && data.address) {
        addressInput.value = data.address;
      }
      
      const searchBtn = document.createElement('button');
      searchBtn.textContent = 'ğŸ”';
      searchBtn.className = 'address-search-btn';
      searchBtn.onclick = async (e) => {
        e.preventDefault();
        e.stopPropagation();
        try {
          const addressInput = row.querySelector('.field-address');
          const nameInput = row.querySelector('.field-name');
          let searchText = '';
          
          // ä½æ‰€ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å„ªå…ˆçš„ã«ç¢ºèª
          if (addressInput && addressInput.value.trim()) {
            searchText = addressInput.value.trim();
            console.log('ä½æ‰€ã§ã®æ¤œç´¢:', searchText);
          }
          // ä½æ‰€ãŒç©ºã®å ´åˆã¯åç§°ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ç¢ºèª
          else if (nameInput && nameInput.value.trim()) {
            searchText = nameInput.value.trim();
            console.log('åç§°ã§ã®æ¤œç´¢:', searchText);
          }
          
          if (!searchText) {
            throw new Error('ä½æ‰€ã¾ãŸã¯åç§°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
          }

          const result = await geocodeAddressGSI(searchText);
          console.log('æ¤œç´¢çµæœ:', result);

          // ç·¯åº¦çµŒåº¦ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’æ›´æ–°
          const latInput = row.querySelector('.field-lat');
          const lonInput = row.querySelector('.field-lon');

          if (latInput && lonInput) {
            latInput.value = result.lat;
            lonInput.value = result.lon;

            // ä½æ‰€ãŒç©ºã®å ´åˆã¯å–å¾—ã—ãŸä½æ‰€ã‚’è¨­å®š
            if (!addressInput.value.trim()) {
              addressInput.value = result.displayName;
            }

            // åœ°å›³ã‚’æ›´æ–°
            map.setView([result.lat, result.lon], 14);
            await showPolygons(result.lat, result.lon);
            
            // å¤‰æ›´ã‚’åœ°å›³ã«åæ˜ 
            applyCustomData();

            // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
            showSuccess(`æ¤œç´¢æˆåŠŸ: ${result.displayName}`);
          }
        } catch (error) {
          console.error('ä½æ‰€æ¤œç´¢ã‚¨ãƒ©ãƒ¼:', error);
          showError(error.message);
        }
      };
      
      addressGroup.appendChild(addressInput);
      addressGroup.appendChild(searchBtn);
      addressTd.appendChild(addressGroup);
      row.appendChild(addressTd);

      // å‰Šé™¤ãƒœã‚¿ãƒ³ã®è¿½åŠ 
      const actionTd = document.createElement('td');
      const deleteBtn = document.createElement('span');
      deleteBtn.innerHTML = 'ğŸ—‘ï¸';
      deleteBtn.className = 'delete-row';
      deleteBtn.onclick = (e) => {
        e.stopPropagation();
        row.remove();
        applyCustomData();
      };
      actionTd.appendChild(deleteBtn);
      row.appendChild(actionTd);

      document.getElementById('plotsGrid').appendChild(row);
    }

    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚«ãƒ©ãƒ¼ã‚’å–å¾—ã™ã‚‹é–¢æ•°
    function getDefaultColor(index) {
      const colors = ['#66c2a5', '#fc8d62', '#8da0cb'];
      return colors[index - 1] || '#66c2a5';
    }

    // ãƒ‡ãƒ¼ã‚¿ã‚’åœ°å›³ã«åæ˜ 
    function applyCustomData() {
      // æ—¢å­˜ã®ã‚«ã‚¹ã‚¿ãƒ ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¨ãƒãƒ¼ã‚«ãƒ¼ã‚’ã‚¯ãƒªã‚¢
      if (window.customLayers) {
        window.customLayers.forEach(layer => map.removeLayer(layer));
      }
      window.customLayers = [];
      
      if (!window.customLayers) {
        window.customLayers = [];
      }
      
      if (markers) {
        markers.forEach(marker => map.removeLayer(marker));
      }
      markers = [];

      const rows = document.querySelectorAll('#plotsGrid tr');
      const newData = [];
      
      rows.forEach(row => {
        try {
          const nameInput = row.querySelector('.field-name');
          const latInput = row.querySelector('.field-lat');
          const lonInput = row.querySelector('.field-lon');
          
          if (!nameInput || !latInput || !lonInput) {
            return; // å¿…è¦ãªè¦ç´ ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
          }
          
          const lat = parseFloat(latInput.value);
          const lon = parseFloat(lonInput.value);
          
          if (isNaN(lat) || isNaN(lon)) {
            return; // ç„¡åŠ¹ãªåº§æ¨™ã®å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
          }

          const data = {
            name: nameInput.value,
            lat: lat,
            lon: lon,
            address: row.querySelector('.field-address')?.value || '',
            startDate: row.querySelector('.field-startDate')?.value || '',
            endDate: row.querySelector('.field-endDate')?.value || '',
            sales: parseFloat(row.querySelector('.field-sales')?.value) || 0,
            customers: parseInt(row.querySelector('.field-customers')?.value) || 0,
            area: parseFloat(row.querySelector('.field-area')?.value) || 0
          };

          newData.push(data);

          // å††ã¨ãƒãƒ¼ã‚«ãƒ¼ã®æç”»
          if (row.parentNode) { // è¡ŒãŒå®Ÿéš›ã«ãƒ†ãƒ¼ãƒ–ãƒ«ã«å­˜åœ¨ã™ã‚‹å ´åˆã®ã¿æç”»
            // 3ã¤ã®å††ã‚’æç”»
            [1, 2, 3].forEach(i => {
              const radiusInput = row.querySelector(`.field-radius${i}`);
              const colorInput = row.querySelector(`.field-color${i}`);
              
              if (radiusInput && colorInput) {
                const radius = parseInt(radiusInput.value);
                const color = colorInput.value;
                
                if (!isNaN(radius) && radius > 0) {
                  const circle = L.circle([lat, lon], {
                    radius: radius,
                    color: color,
                    fillColor: color,
                    fillOpacity: 0.2 - (i * 0.05)
                  }).addTo(map);
                  window.customLayers.push(circle);
                }
              }
            });

            // ãƒãƒ¼ã‚«ãƒ¼ã‚’è¿½åŠ 
            const marker = createMarker(lat, lon, data);
            marker.addTo(map);
            markers.push(marker);
          }
        } catch (error) {
          console.error('è¡Œã®ãƒ‡ãƒ¼ã‚¿å‡¦ç†ã‚¨ãƒ©ãƒ¼:', error);
        }
      });
      
      customData = newData;
      console.log('Updated customData:', customData);
    }

    // ãƒãƒ¼ã‚«ãƒ¼ã®ä½œæˆã¨è¿½åŠ 
    function createMarker(lat, lon, data) {
      const marker = L.marker([lat, lon], {
        icon: L.divIcon({
          className: 'custom-marker',
          html: 'ğŸ“',
          iconSize: [25, 25],
          iconAnchor: [12, 25]
        })
      });
      
      marker.on('click', async () => {
        // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®ä½œæˆ
        const popupContent = `
          <div class="marker-popup">
            <h3>${data.name}</h3>
            <div class="marker-popup-content">
              <p><strong>ä½æ‰€:</strong> ${data.address || 'æœªè¨­å®š'}</p>
              <p><strong>ç·¯åº¦:</strong> ${lat}</p>
              <p><strong>çµŒåº¦:</strong> ${lon}</p>
              <p><strong>å£²ä¸Š:</strong> ${data.sales ? data.sales.toLocaleString() : 'æœªè¨­å®š'}</p>
              <p><strong>å®¢æ•°:</strong> ${data.customers ? data.customers.toLocaleString() : 'æœªè¨­å®š'}</p>
              <p><strong>é¢ç©:</strong> ${data.area ? data.area + 'mÂ²' : 'æœªè¨­å®š'}</p>
              <p><strong>æœŸé–“:</strong> ${data.startDate || 'æœªè¨­å®š'} ï½ ${data.endDate || 'æœªè¨­å®š'}</p>
            </div>
            <div class="marker-popup-links">
              <a href="https://www.google.com/maps/search/?api=1&query=${lat},${lon}" target="_blank">Google Mapã§é–‹ã</a>
              <a href="#" onclick="showPolygons(${lat}, ${lon}); return false;">å‘¨è¾ºãƒãƒªã‚´ãƒ³è¡¨ç¤º</a>
            </div>
          </div>
        `;
        
        marker.bindPopup(popupContent).openPopup();
        
        // å‘¨è¾ºãƒãƒªã‚´ãƒ³ã‚’å–å¾—ã—ã¦è¡¨ç¤º
        await showPolygons(lat, lon);
      });
      
      return marker;
    }

    // å‘¨è¾ºãƒãƒªã‚´ãƒ³ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°
    async function showPolygons(lat, lon) {
      try {
        console.log('Fetching polygons for:', lat, lon);
        const geojsonData = await fetchOverpassData(lat, lon, 1500);
        console.log('Received polygon data:', geojsonData);
        renderGeoJSON(geojsonData);
      } catch (error) {
        console.error('ãƒãƒªã‚´ãƒ³å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
        showError('ãƒãƒªã‚´ãƒ³ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
      }
    }

    // ãƒãƒƒãƒ—ã®ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¨­å®š
    map.on('dblclick', function(e) {
      const lat = e.latlng.lat.toFixed(6);
      const lng = e.latlng.lng.toFixed(6);
      
      addNewRow({
        name: 'æ–°è¦ãƒã‚¤ãƒ³ãƒˆ',
        lat: lat,
        lon: lng,
        radius1: document.getElementById('globalRadius1').value,
        radius2: document.getElementById('globalRadius2').value,
        radius3: document.getElementById('globalRadius3').value,
        color1: document.getElementById('globalColor1').value,
        color2: document.getElementById('globalColor2').value,
        color3: document.getElementById('globalColor3').value
      });
      
      applyCustomData();
    });

    // ãƒ‡ãƒ¼ã‚¿è¡Œé¸æŠæ™‚ã®ã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†ã‚’æ›´æ–°
    function addRowClickHandler(row, data) {
      row.addEventListener('click', async () => {
        const lat = parseFloat(data.lat);
        const lon = parseFloat(data.lon);
        
        if (!isNaN(lat) && !isNaN(lon)) {
          map.setView([lat, lon], 14);
          await showPolygons(lat, lon);
          
          // æ—¢å­˜ã®ãƒãƒ¼ã‚«ãƒ¼ã‚’æ¢ã—ã¦ã€ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’ãƒˆãƒªã‚¬ãƒ¼
          markers.forEach(marker => {
            if (marker.getLatLng().lat === lat && marker.getLatLng().lng === lon) {
              marker.fire('click');
            }
          });
        }
      });
    }

    // ãƒ‡ãƒ¼ã‚¿ã®ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå‡¦ç†
    function exportData(type, data) {
      const worksheet = XLSX.utils.json_to_sheet(data);
      const workbook = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(workbook, worksheet, 'Data');
      
      // Excelå½¢å¼ã§ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
      const excelBuffer = XLSX.write(workbook, { bookType: 'xlsx', type: 'array' });
      const blob = new Blob([excelBuffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `${type}_data.xlsx`;
      link.click();
    }

    // ãƒ‡ãƒ¼ã‚¿ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆå‡¦ç†
    function importData(file, type) {
      const reader = new FileReader();
      reader.onload = function(e) {
        if (file.name.endsWith('.csv')) {
          Papa.parse(file, {
            complete: function(results) {
              processImportedData(results.data, type);
            }
          });
        } else {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: 'array' });
          const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
          const jsonData = XLSX.utils.sheet_to_json(firstSheet);
          processImportedData(jsonData, type);
        }
      };
      reader.readAsArrayBuffer(file);
    }

    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¿½åŠ 
    document.getElementById('exportPlots').addEventListener('click', () => {
      exportData('plots', customData);
    });

    document.getElementById('exportPolygons').addEventListener('click', () => {
      exportData('polygons', polygonData);
    });

    document.getElementById('importPlots').addEventListener('change', (e) => {
      importData(e.target.files[0], 'plots');
    });

    document.getElementById('importPolygons').addEventListener('change', (e) => {
      importData(e.target.files[0], 'polygons');
    });

    // æ¤œç´¢çµæœã‚’ãƒ—ãƒ­ãƒƒãƒˆåœ°ç‚¹ãƒ†ãƒ¼ãƒ–ãƒ«ã«è¿½åŠ ã™ã‚‹é–¢æ•°
    function addSearchResultToPlots(lat, lon, displayName = 'æ¤œç´¢åœ°ç‚¹') {
      // ãƒ—ãƒ­ãƒƒãƒˆã‚¿ãƒ–ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«ã™ã‚‹
      document.querySelector('[data-tab="plots"]').click();
      
      // ãƒ—ãƒ­ãƒƒãƒˆåœ°ç‚¹ã¨ã—ã¦è¿½åŠ 
      addNewRow({
        name: displayName,
        lat: lat,
        lon: lon,
        radius: '1500',
        color: '#66c2a5'
      });
      
      // ãƒ†ãƒ¼ãƒ–ãƒ«ã«è¿½åŠ å¾Œã€åœ°å›³ã«åæ˜ 
      applyCustomData();
    }

    // åˆæœŸåŒ–å‡¦ç†ã‚’æ›´æ–°
    async function initialize() {
      try {
        // åœ°å›³ã®åˆæœŸè¡¨ç¤º
        await updateMapWithCoords(centerLat, centerLon, 'æ¸‹è°·é§…');
        
        // ãƒ—ãƒ­ãƒƒãƒˆåœ°ç‚¹ã‚¿ãƒ–ã«æ¸‹è°·é§…ã‚’è¿½åŠ 
        addNewRow(defaultPoint);
        
        // ãƒ—ãƒ­ãƒƒãƒˆåœ°ç‚¹ã‚’åœ°å›³ã«åæ˜ 
        applyCustomData();
        
        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®åˆæœŸåŒ–
        initEventListeners();
        initializeEventListeners();
      } catch (error) {
        console.error('åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
        showError(error.message);
      }
    }

    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¿½åŠ ã‚’ä¿®æ­£
    function initializeEventListeners() {
      // ãƒ—ãƒ­ãƒƒãƒˆé–¢é€£ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
      const addRowButton = document.getElementById('addPlotRow');
      const applyButton = document.getElementById('applyPlots');
      
      if (addRowButton) {
        addRowButton.addEventListener('click', () => addNewRow());
      }
      
      if (applyButton) {
        applyButton.addEventListener('click', applyCustomData);
      }

      // ãƒãƒƒãƒ—ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
      map.on('click', function(e) {
        const lat = e.latlng.lat.toFixed(6);
        const lng = e.latlng.lng.toFixed(6);
        
        addNewRow({
          name: 'æ–°è¦ãƒã‚¤ãƒ³ãƒˆ',
          lat: lat,
          lon: lng,
          radius: '1500',
          color: '#66c2a5'
        });
      });
    }

    // DOMContentLoadedã‚¤ãƒ™ãƒ³ãƒˆã§åˆæœŸåŒ–ã‚’å®Ÿè¡Œ
    document.addEventListener('DOMContentLoaded', initialize);

    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®åˆæœŸåŒ–ã‚’ä¸€æœ¬åŒ–
    function initializeEventListeners() {
      // æ¤œç´¢é–¢é€£
      const searchButton = document.getElementById('searchButton');
      if (searchButton) {
        searchButton.addEventListener('click', handleSearch);
      }

      // å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®Enterã‚­ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆ
      ['addressInput', 'latInput', 'lonInput'].forEach(id => {
        const element = document.getElementById(id);
        if (element) {
          element.addEventListener('keypress', e => {
            if (e.key === 'Enter') handleSearch();
          });
        }
      });

      // ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã®åˆ‡ã‚Šæ›¿ãˆ
      document.querySelectorAll('input[name="searchType"]').forEach(radio => {
        radio.addEventListener('change', () => {
          const addressGroup = document.getElementById('addressGroup');
          const coordsGroup = document.getElementById('coordsGroup');
          if (addressGroup && coordsGroup) {
            addressGroup.style.display = radio.value === 'address' ? 'flex' : 'none';
            coordsGroup.style.display = radio.value === 'coords' ? 'flex' : 'none';
          }
        });
      });

      // ãƒ—ãƒ­ãƒƒãƒˆé–¢é€£
      const addPlotRowButton = document.getElementById('addPlotRow');
      const applyPlotsButton = document.getElementById('applyPlots');
      const exportPlotsButton = document.getElementById('exportPlots');
      const importPlotsInput = document.getElementById('importPlots');

      if (addPlotRowButton) {
        addPlotRowButton.addEventListener('click', () => addNewRow());
      }

      if (applyPlotsButton) {
        applyPlotsButton.addEventListener('click', applyCustomData);
      }

      if (exportPlotsButton) {
        exportPlotsButton.addEventListener('click', () => exportData('plots', customData));
      }

      if (importPlotsInput) {
        importPlotsInput.addEventListener('change', (e) => importData(e.target.files[0], 'plots'));
      }

      // ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ›
      const fileInput = document.getElementById('fileInput');
      if (fileInput) {
        fileInput.addEventListener('change', handleFileSelect);
      }

      // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
      document.querySelectorAll('.tab-button').forEach(button => {
        button.addEventListener('click', () => {
          document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
          document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
          
          button.classList.add('active');
          const tabId = `${button.dataset.tab}Tab`;
          const tabContent = document.getElementById(tabId);
          if (tabContent) {
            tabContent.classList.add('active');
          }
        });
      });

      // ãƒãƒƒãƒ—ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
      map.on('click', function(e) {
        const lat = e.latlng.lat.toFixed(6);
        const lng = e.latlng.lng.toFixed(6);
        
        addNewRow({
          name: 'æ–°è¦ãƒã‚¤ãƒ³ãƒˆ',
          lat: lat,
          lon: lng,
          radius: '1500',
          color: '#66c2a5'
        });
      });

      // ä¸€æ‹¬åŠå¾„å¤‰æ›´ã®é©ç”¨
      document.getElementById('applyGlobalRadius').addEventListener('click', () => {
        const selectedRows = document.querySelectorAll('.row-selector:checked');
        selectedRows.forEach(checkbox => {
          const row = checkbox.closest('tr');
          [1, 2, 3].forEach(i => {
            const radiusInput = row.querySelector(`.field-radius${i}`);
            const colorInput = row.querySelector(`.field-color${i}`);
            if (radiusInput && colorInput) {
              radiusInput.value = document.getElementById(`globalRadius${i}`).value;
              colorInput.value = document.getElementById(`globalColor${i}`).value;
            }
          });
        });
        applyCustomData();
      });

      // å…¨é¸æŠãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®å‡¦ç†
      document.getElementById('selectAll').addEventListener('change', function() {
        const checkboxes = document.querySelectorAll('.row-selector');
        checkboxes.forEach(checkbox => {
          checkbox.checked = this.checked;
        });
      });

      // ãƒ—ãƒ­ãƒƒãƒˆåœ°ç‚¹ã®å¤‰æ›´ã‚’ç›£è¦–
      document.getElementById('plotsGrid').addEventListener('input', (e) => {
        if (e.target.tagName === 'INPUT') {
          applyCustomData();
        }
      });
    }

    // åˆæœŸåŒ–æ™‚ã«å¿…è¦ãªã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã‚’ç¢ºå®Ÿã«åˆæœŸåŒ–
    window.customLayers = [];
    let markers = [];
    let polygonLayer = null;

    // ã‚¨ãƒ©ãƒ¼ã¨æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®è¡¨ç¤ºé–¢æ•°ã‚’è¿½åŠ 
    function showSuccess(message) {
      const stats = document.getElementById('resultStats');
      stats.innerHTML = `<div class="success" style="color: green; background: #e8f5e9; padding: 10px; border-radius: 4px; margin-top: 10px;">${message}</div>`;
      setTimeout(() => {
        stats.innerHTML = '';
      }, 3000);
    }
  </script>
</body>
</html>
