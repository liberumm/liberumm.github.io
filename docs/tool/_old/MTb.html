<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ER図ベースのWebシステム</title>
    <!-- Google Fonts - Roboto -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto" />
    <!-- Google Fonts - Material Icons -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons" />
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            margin: 0;
            padding: 0;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- ReactとReactDOM -->
    <script src="https://cdn.jsdelivr.net/npm/react@18/umd/react.production.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/react-dom@18/umd/react-dom.production.min.js" crossorigin="anonymous"></script>

    <!-- Material-UI (MUI) v5 -->
    <script src="https://cdn.jsdelivr.net/npm/@mui/material@5.11.15/umd/material-ui.production.min.js" crossorigin="anonymous"></script>

    <!-- Babel for JSX -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.21.0/babel.min.js" crossorigin="anonymous"></script>

    <!-- Chart.js (Visualization用) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js" crossorigin="anonymous"></script>

    <!-- Reactコンポーネント -->
    <script type="text/babel">
        const {
            AppBar,
            Toolbar,
            Typography,
            Tabs,
            Tab,
            Box,
            Container,
            Paper,
            TextField,
            Button,
            Table,
            TableBody,
            TableCell,
            TableContainer,
            TableHead,
            TableRow,
            IconButton,
            Select,
            MenuItem,
            FormControl,
            InputLabel,
            Dialog,
            DialogActions,
            DialogContent,
            DialogTitle,
            Snackbar,
            Alert
        } = MaterialUI;

        // ヘルパー関数: localStorageからデータを取得
        const getData = (key) => {
            const data = localStorage.getItem(key);
            return data ? JSON.parse(data) : [];
        };

        // ヘルパー関数: localStorageにデータを保存
        const setData = (key, data) => {
            localStorage.setItem(key, JSON.stringify(data));
        };

        // サンプルデータの初期化
        function initializeSampleData() {
            if (!localStorage.getItem('structures')) {
                const sampleStructures = [
                    { StructureID: 1, Name: 'ユーザー' },
                    { StructureID: 2, Name: '製品' }
                ];
                setData('structures', sampleStructures);
            }

            if (!localStorage.getItem('fields')) {
                const sampleFields = [
                    { FieldID: 1, StructureID: 1, Name: '名前', Type: 'string' },
                    { FieldID: 2, StructureID: 1, Name: '年齢', Type: 'int' },
                    { FieldID: 3, StructureID: 2, Name: '製品名', Type: 'string' },
                    { FieldID: 4, StructureID: 2, Name: '価格', Type: 'int' }
                ];
                setData('fields', sampleFields);
            }

            if (!localStorage.getItem('records')) {
                const sampleRecords = [
                    { RecordID: 1, StructureID: 1, FieldValues: JSON.stringify({ 1: '山田太郎', 2: 30 }) },
                    { RecordID: 2, StructureID: 1, FieldValues: JSON.stringify({ 1: '鈴木花子', 2: 25 }) },
                    { RecordID: 3, StructureID: 2, FieldValues: JSON.stringify({ 3: 'ノートパソコン', 4: 120000 }) },
                    { RecordID: 4, StructureID: 2, FieldValues: JSON.stringify({ 3: 'スマートフォン', 4: 80000 }) }
                ];
                setData('records', sampleRecords);
            }

            if (!localStorage.getItem('visualizations')) {
                const sampleVisualizations = [
                    {
                        VisualizationID: 1,
                        StructureID: 1,
                        VisualizationType: 'bar',
                        Configuration: JSON.stringify({ title: 'ユーザー年齢分布' })
                    },
                    {
                        VisualizationID: 2,
                        StructureID: 2,
                        VisualizationType: 'pie',
                        Configuration: JSON.stringify({ title: '製品価格分布' })
                    }
                ];
                setData('visualizations', sampleVisualizations);
            }

            if (!localStorage.getItem('summaries')) {
                const sampleSummaries = [
                    {
                        SummaryID: 1,
                        StructureID: 1,
                        SummaryType: 'count',
                        SummaryData: JSON.stringify({ field: '名前' })
                    },
                    {
                        SummaryID: 2,
                        StructureID: 2,
                        SummaryType: 'sum',
                        SummaryData: JSON.stringify({ field: '価格' })
                    }
                ];
                setData('summaries', sampleSummaries);
            }
        }

        // アプリケーションのメインコンポーネント
        function App() {
            const [tab, setTab] = React.useState(0);
            const [snackbar, setSnackbar] = React.useState({ open: false, message: '', severity: 'success' });

            React.useEffect(() => {
                initializeSampleData();
            }, []);

            const handleTabChange = (event, newValue) => {
                setTab(newValue);
            };

            const showMessage = (message, severity = 'success') => {
                setSnackbar({ open: true, message, severity });
            };

            const handleCloseSnackbar = () => {
                setSnackbar({ ...snackbar, open: false });
            };

            return (
                <div>
                    <AppBar position="static">
                        <Toolbar>
                            <Typography variant="h6" component="div">
                                ER図ベースのWebシステム
                            </Typography>
                        </Toolbar>
                        <Tabs value={tab} onChange={handleTabChange} centered>
                            <Tab label="構造管理" />
                            <Tab label="フィールド管理" />
                            <Tab label="レコード管理" />
                            <Tab label="ビジュアル化" />
                            <Tab label="サマリー管理" />
                        </Tabs>
                    </AppBar>
                    <Container maxWidth="lg" sx={{ mt: 4, mb: 4 }}>
                        {tab === 0 && <StructureManager showMessage={showMessage} />}
                        {tab === 1 && <FieldManager showMessage={showMessage} />}
                        {tab === 2 && <RecordManager showMessage={showMessage} />}
                        {tab === 3 && <VisualizationManager showMessage={showMessage} />}
                        {tab === 4 && <SummaryManager showMessage={showMessage} />}
                    </Container>
                    <Snackbar open={snackbar.open} autoHideDuration={6000} onClose={handleCloseSnackbar}>
                        <Alert onClose={handleCloseSnackbar} severity={snackbar.severity} sx={{ width: '100%' }}>
                            {snackbar.message}
                        </Alert>
                    </Snackbar>
                </div>
            );
        }

        // 構造管理コンポーネント
        function StructureManager({ showMessage }) {
            const [structures, setStructures] = React.useState(getData('structures'));
            const [openDialog, setOpenDialog] = React.useState(false);
            const [currentStructure, setCurrentStructure] = React.useState({ StructureID: null, Name: '' });

            const handleOpenDialog = (structure = { StructureID: null, Name: '' }) => {
                setCurrentStructure(structure);
                setOpenDialog(true);
            };

            const handleCloseDialog = () => {
                setCurrentStructure({ StructureID: null, Name: '' });
                setOpenDialog(false);
            };

            const handleSave = () => {
                if (!currentStructure.Name.trim()) {
                    showMessage('名前を入力してください。', 'error');
                    return;
                }

                let updatedStructures;
                if (currentStructure.StructureID) {
                    // 更新
                    updatedStructures = structures.map(s => s.StructureID === currentStructure.StructureID ? currentStructure : s);
                    showMessage('構造を更新しました。');
                } else {
                    // 作成
                    const newID = structures.length ? Math.max(...structures.map(s => s.StructureID)) + 1 : 1;
                    currentStructure.StructureID = newID;
                    updatedStructures = [...structures, currentStructure];
                    showMessage('構造を作成しました。');
                }
                setStructures(updatedStructures);
                setData('structures', updatedStructures);
                handleCloseDialog();
            };

            const handleDelete = (id) => {
                if (!window.confirm('この構造を削除してもよろしいですか？')) return;
                const updatedStructures = structures.filter(s => s.StructureID !== id);
                setStructures(updatedStructures);
                setData('structures', updatedStructures);
                // 関連するデータの削除
                const fields = getData('fields').filter(f => f.StructureID !== id);
                setData('fields', fields);
                const records = getData('records').filter(r => r.StructureID !== id);
                setData('records', records);
                const visualizations = getData('visualizations').filter(v => v.StructureID !== id);
                setData('visualizations', visualizations);
                const summaries = getData('summaries').filter(s => s.StructureID !== id);
                setData('summaries', summaries);
                showMessage('構造と関連データを削除しました。', 'warning');
            };

            return (
                <div>
                    <Box display="flex" justifyContent="space-between" alignItems="center" mb={2}>
                        <Typography variant="h5">構造一覧</Typography>
                        <Button variant="contained" color="primary" onClick={() => handleOpenDialog()}>
                            新規作成
                        </Button>
                    </Box>
                    <TableContainer component={Paper}>
                        <Table>
                            <TableHead>
                                <TableRow>
                                    <TableCell>構造ID</TableCell>
                                    <TableCell>名前</TableCell>
                                    <TableCell align="right">アクション</TableCell>
                                </TableRow>
                            </TableHead>
                            <TableBody>
                                {structures.map((structure) => (
                                    <TableRow key={structure.StructureID}>
                                        <TableCell>{structure.StructureID}</TableCell>
                                        <TableCell>{structure.Name}</TableCell>
                                        <TableCell align="right">
                                            <IconButton color="primary" onClick={() => handleOpenDialog(structure)}>
                                                <span className="material-icons">edit</span>
                                            </IconButton>
                                            <IconButton color="error" onClick={() => handleDelete(structure.StructureID)}>
                                                <span className="material-icons">delete</span>
                                            </IconButton>
                                        </TableCell>
                                    </TableRow>
                                ))}
                                {structures.length === 0 && (
                                    <TableRow>
                                        <TableCell colSpan={3} align="center">データがありません。</TableCell>
                                    </TableRow>
                                )}
                            </TableBody>
                        </Table>
                    </TableContainer>

                    {/* ダイアログ */}
                    <Dialog open={openDialog} onClose={handleCloseDialog}>
                        <DialogTitle>{currentStructure.StructureID ? '構造を編集' : '構造を作成'}</DialogTitle>
                        <DialogContent>
                            <TextField
                                autoFocus
                                margin="dense"
                                label="名前"
                                type="text"
                                fullWidth
                                variant="standard"
                                value={currentStructure.Name}
                                onChange={(e) => setCurrentStructure({ ...currentStructure, Name: e.target.value })}
                                required
                            />
                        </DialogContent>
                        <DialogActions>
                            <Button onClick={handleCloseDialog}>キャンセル</Button>
                            <Button onClick={handleSave} variant="contained" color="primary">保存</Button>
                        </DialogActions>
                    </Dialog>
                </div>
            );
        }

        // フィールド管理コンポーネント
        function FieldManager({ showMessage }) {
            const [fields, setFields] = React.useState(getData('fields'));
            const [structures, setStructures] = React.useState(getData('structures'));
            const [openDialog, setOpenDialog] = React.useState(false);
            const [currentField, setCurrentField] = React.useState({ FieldID: null, StructureID: '', Name: '', Type: '' });

            const handleOpenDialog = (field = { FieldID: null, StructureID: '', Name: '', Type: '' }) => {
                setCurrentField(field);
                setOpenDialog(true);
            };

            const handleCloseDialog = () => {
                setCurrentField({ FieldID: null, StructureID: '', Name: '', Type: '' });
                setOpenDialog(false);
            };

            const handleSave = () => {
                if (!currentField.StructureID) {
                    showMessage('構造を選択してください。', 'error');
                    return;
                }
                if (!currentField.Name.trim()) {
                    showMessage('名前を入力してください。', 'error');
                    return;
                }
                if (!currentField.Type) {
                    showMessage('タイプを選択してください。', 'error');
                    return;
                }

                let updatedFields;
                if (currentField.FieldID) {
                    // 更新
                    updatedFields = fields.map(f => f.FieldID === currentField.FieldID ? currentField : f);
                    showMessage('フィールドを更新しました。');
                } else {
                    // 作成
                    const newID = fields.length ? Math.max(...fields.map(f => f.FieldID)) + 1 : 1;
                    currentField.FieldID = newID;
                    updatedFields = [...fields, currentField];
                    showMessage('フィールドを作成しました。');
                }
                setFields(updatedFields);
                setData('fields', updatedFields);
                handleCloseDialog();
            };

            const handleDelete = (id) => {
                if (!window.confirm('このフィールドを削除してもよろしいですか？')) return;
                const updatedFields = fields.filter(f => f.FieldID !== id);
                setFields(updatedFields);
                setData('fields', updatedFields);
                showMessage('フィールドを削除しました。', 'warning');
                // レコードのフィールド値を更新
                const records = getData('records').map(r => {
                    const fv = JSON.parse(r.FieldValues);
                    delete fv[id];
                    return { ...r, FieldValues: JSON.stringify(fv) };
                });
                setData('records', records);
            };

            return (
                <div>
                    <Box display="flex" justifyContent="space-between" alignItems="center" mb={2}>
                        <Typography variant="h5">フィールド一覧</Typography>
                        <Button variant="contained" color="primary" onClick={() => handleOpenDialog()}>
                            新規作成
                        </Button>
                    </Box>
                    <TableContainer component={Paper}>
                        <Table>
                            <TableHead>
                                <TableRow>
                                    <TableCell>フィールドID</TableCell>
                                    <TableCell>構造</TableCell>
                                    <TableCell>名前</TableCell>
                                    <TableCell>タイプ</TableCell>
                                    <TableCell align="right">アクション</TableCell>
                                </TableRow>
                            </TableHead>
                            <TableBody>
                                {fields.map((field) => {
                                    const structure = structures.find(s => s.StructureID === field.StructureID);
                                    return (
                                        <TableRow key={field.FieldID}>
                                            <TableCell>{field.FieldID}</TableCell>
                                            <TableCell>{structure ? structure.Name : 'N/A'}</TableCell>
                                            <TableCell>{field.Name}</TableCell>
                                            <TableCell>{field.Type}</TableCell>
                                            <TableCell align="right">
                                                <IconButton color="primary" onClick={() => handleOpenDialog(field)}>
                                                    <span className="material-icons">edit</span>
                                                </IconButton>
                                                <IconButton color="error" onClick={() => handleDelete(field.FieldID)}>
                                                    <span className="material-icons">delete</span>
                                                </IconButton>
                                            </TableCell>
                                        </TableRow>
                                    );
                                })}
                                {fields.length === 0 && (
                                    <TableRow>
                                        <TableCell colSpan={5} align="center">データがありません。</TableCell>
                                    </TableRow>
                                )}
                            </TableBody>
                        </Table>
                    </TableContainer>

                    {/* ダイアログ */}
                    <Dialog open={openDialog} onClose={handleCloseDialog}>
                        <DialogTitle>{currentField.FieldID ? 'フィールドを編集' : 'フィールドを作成'}</DialogTitle>
                        <DialogContent>
                            <FormControl fullWidth margin="dense">
                                <InputLabel id="structure-select-label">構造</InputLabel>
                                <Select
                                    labelId="structure-select-label"
                                    value={currentField.StructureID}
                                    label="構造"
                                    onChange={(e) => setCurrentField({ ...currentField, StructureID: e.target.value })}
                                    required
                                >
                                    {structures.map(s => (
                                        <MenuItem key={s.StructureID} value={s.StructureID}>{s.Name}</MenuItem>
                                    ))}
                                </Select>
                            </FormControl>
                            <TextField
                                margin="dense"
                                label="名前"
                                type="text"
                                fullWidth
                                variant="standard"
                                value={currentField.Name}
                                onChange={(e) => setCurrentField({ ...currentField, Name: e.target.value })}
                                required
                            />
                            <FormControl fullWidth margin="dense">
                                <InputLabel id="type-select-label">タイプ</InputLabel>
                                <Select
                                    labelId="type-select-label"
                                    value={currentField.Type}
                                    label="タイプ"
                                    onChange={(e) => setCurrentField({ ...currentField, Type: e.target.value })}
                                    required
                                >
                                    <MenuItem value="string">文字列</MenuItem>
                                    <MenuItem value="int">整数</MenuItem>
                                    <MenuItem value="boolean">ブール値</MenuItem>
                                    {/* 必要に応じて他のタイプを追加 */}
                                </Select>
                            </FormControl>
                        </DialogContent>
                        <DialogActions>
                            <Button onClick={handleCloseDialog}>キャンセル</Button>
                            <Button onClick={handleSave} variant="contained" color="primary">保存</Button>
                        </DialogActions>
                    </Dialog>
                </div>
            );
        }

        // レコード管理コンポーネント
        function RecordManager({ showMessage }) {
            const [records, setRecords] = React.useState(getData('records'));
            const [structures, setStructures] = React.useState(getData('structures'));
            const [fields, setFields] = React.useState(getData('fields'));
            const [openDialog, setOpenDialog] = React.useState(false);
            const [currentRecord, setCurrentRecord] = React.useState({ RecordID: null, StructureID: '', FieldValues: {} });
            const [dynamicFields, setDynamicFields] = React.useState([]);

            React.useEffect(() => {
                if (currentRecord.StructureID) {
                    const relatedFields = fields.filter(f => f.StructureID === currentRecord.StructureID);
                    setDynamicFields(relatedFields);
                } else {
                    setDynamicFields([]);
                }
            }, [currentRecord.StructureID, fields]);

            const handleOpenDialog = (record = { RecordID: null, StructureID: '', FieldValues: {} }) => {
                setCurrentRecord(record);
                setOpenDialog(true);
            };

            const handleCloseDialog = () => {
                setCurrentRecord({ RecordID: null, StructureID: '', FieldValues: {} });
                setOpenDialog(false);
            };

            const handleSave = () => {
                if (!currentRecord.StructureID) {
                    showMessage('構造を選択してください。', 'error');
                    return;
                }

                let updatedRecords;
                if (currentRecord.RecordID) {
                    // 更新
                    updatedRecords = records.map(r => r.RecordID === currentRecord.RecordID ? currentRecord : r);
                    showMessage('レコードを更新しました。');
                } else {
                    // 作成
                    const newID = records.length ? Math.max(...records.map(r => r.RecordID)) + 1 : 1;
                    currentRecord.RecordID = newID;
                    updatedRecords = [...records, currentRecord];
                    showMessage('レコードを作成しました。');
                }
                setRecords(updatedRecords);
                setData('records', updatedRecords);
                handleCloseDialog();
            };

            const handleDelete = (id) => {
                if (!window.confirm('このレコードを削除してもよろしいですか？')) return;
                const updatedRecords = records.filter(r => r.RecordID !== id);
                setRecords(updatedRecords);
                setData('records', updatedRecords);
                showMessage('レコードを削除しました。', 'warning');
            };

            const handleChangeFieldValue = (fieldID, value) => {
                setCurrentRecord({
                    ...currentRecord,
                    FieldValues: { ...currentRecord.FieldValues, [fieldID]: value }
                });
            };

            return (
                <div>
                    <Box display="flex" justifyContent="space-between" alignItems="center" mb={2}>
                        <Typography variant="h5">レコード一覧</Typography>
                        <Button variant="contained" color="primary" onClick={() => handleOpenDialog()}>
                            新規作成
                        </Button>
                    </Box>
                    <TableContainer component={Paper}>
                        <Table>
                            <TableHead>
                                <TableRow>
                                    <TableCell>レコードID</TableCell>
                                    <TableCell>構造</TableCell>
                                    <TableCell>フィールド値</TableCell>
                                    <TableCell align="right">アクション</TableCell>
                                </TableRow>
                            </TableHead>
                            <TableBody>
                                {records.map((record) => {
                                    const structure = structures.find(s => s.StructureID === record.StructureID);
                                    return (
                                        <TableRow key={record.RecordID}>
                                            <TableCell>{record.RecordID}</TableCell>
                                            <TableCell>{structure ? structure.Name : 'N/A'}</TableCell>
                                            <TableCell>
                                                <pre>{JSON.stringify(JSON.parse(record.FieldValues), null, 2)}</pre>
                                            </TableCell>
                                            <TableCell align="right">
                                                <IconButton color="primary" onClick={() => handleOpenDialog(record)}>
                                                    <span className="material-icons">edit</span>
                                                </IconButton>
                                                <IconButton color="error" onClick={() => handleDelete(record.RecordID)}>
                                                    <span className="material-icons">delete</span>
                                                </IconButton>
                                            </TableCell>
                                        </TableRow>
                                    );
                                })}
                                {records.length === 0 && (
                                    <TableRow>
                                        <TableCell colSpan={4} align="center">データがありません。</TableCell>
                                    </TableRow>
                                )}
                            </TableBody>
                        </Table>
                    </TableContainer>

                    {/* ダイアログ */}
                    <Dialog open={openDialog} onClose={handleCloseDialog} maxWidth="sm" fullWidth>
                        <DialogTitle>{currentRecord.RecordID ? 'レコードを編集' : 'レコードを作成'}</DialogTitle>
                        <DialogContent>
                            <FormControl fullWidth margin="dense">
                                <InputLabel id="structure-select-label">構造</InputLabel>
                                <Select
                                    labelId="structure-select-label"
                                    value={currentRecord.StructureID}
                                    label="構造"
                                    onChange={(e) => setCurrentRecord({ ...currentRecord, StructureID: e.target.value, FieldValues: {} })}
                                    required
                                >
                                    {structures.map(s => (
                                        <MenuItem key={s.StructureID} value={s.StructureID}>{s.Name}</MenuItem>
                                    ))}
                                </Select>
                            </FormControl>
                            {dynamicFields.map(field => (
                                <Box key={field.FieldID} mt={2}>
                                    <TextField
                                        label={field.Name}
                                        type={field.Type === 'int' ? 'number' : field.Type === 'boolean' ? 'text' : 'text'}
                                        fullWidth
                                        variant="standard"
                                        value={currentRecord.FieldValues[field.FieldID] || ''}
                                        onChange={(e) => handleChangeFieldValue(field.FieldID, e.target.value)}
                                        required
                                    />
                                </Box>
                            ))}
                        </DialogContent>
                        <DialogActions>
                            <Button onClick={handleCloseDialog}>キャンセル</Button>
                            <Button onClick={handleSave} variant="contained" color="primary">保存</Button>
                        </DialogActions>
                    </Dialog>
                </div>
            );
        }

        // ビジュアル化管理コンポーネント
        function VisualizationManager({ showMessage }) {
            const [visualizations, setVisualizations] = React.useState(getData('visualizations'));
            const [structures, setStructures] = React.useState(getData('structures'));
            const [fields, setFields] = React.useState(getData('fields'));
            const [records, setRecords] = React.useState(getData('records'));
            const [openDialog, setOpenDialog] = React.useState(false);
            const [currentViz, setCurrentViz] = React.useState({ VisualizationID: null, StructureID: '', VisualizationType: '', Configuration: '{}' });
            const chartRef = React.useRef(null);
            const [chartInstance, setChartInstance] = React.useState(null);

            const handleOpenDialog = (viz = { VisualizationID: null, StructureID: '', VisualizationType: '', Configuration: '{}' }) => {
                setCurrentViz(viz);
                setOpenDialog(true);
            };

            const handleCloseDialog = () => {
                setCurrentViz({ VisualizationID: null, StructureID: '', VisualizationType: '', Configuration: '{}' });
                setOpenDialog(false);
            };

            const handleSave = () => {
                if (!currentViz.StructureID || !currentViz.VisualizationType) {
                    showMessage('必要なフィールドを入力してください。', 'error');
                    return;
                }
                // Validate Configuration JSON
                try {
                    JSON.parse(currentViz.Configuration);
                } catch (e) {
                    showMessage('設定は有効なJSONでなければなりません。', 'error');
                    return;
                }

                let updatedVisualizations;
                if (currentViz.VisualizationID) {
                    // 更新
                    updatedVisualizations = visualizations.map(v => v.VisualizationID === currentViz.VisualizationID ? currentViz : v);
                    showMessage('ビジュアル化を更新しました。');
                } else {
                    // 作成
                    const newID = visualizations.length ? Math.max(...visualizations.map(v => v.VisualizationID)) + 1 : 1;
                    currentViz.VisualizationID = newID;
                    updatedVisualizations = [...visualizations, currentViz];
                    showMessage('ビジュアル化を作成しました。');
                }
                setVisualizations(updatedVisualizations);
                setData('visualizations', updatedVisualizations);
                handleCloseDialog();
            };

            const handleDelete = (id) => {
                if (!window.confirm('このビジュアル化を削除してもよろしいですか？')) return;
                const updatedVisualizations = visualizations.filter(v => v.VisualizationID !== id);
                setVisualizations(updatedVisualizations);
                setData('visualizations', updatedVisualizations);
                showMessage('ビジュアル化を削除しました。', 'warning');
            };

            const handleRender = (viz) => {
                // パース設定
                let config = {};
                try {
                    config = JSON.parse(viz.Configuration);
                } catch (e) {
                    showMessage('設定のJSONが無効です。', 'error');
                    return;
                }

                // データ準備
                const relatedFields = fields.filter(f => f.StructureID === viz.StructureID);
                const relatedRecords = records.filter(r => r.StructureID === viz.StructureID);
                const labels = relatedFields.map(f => f.Name);
                const data = relatedFields.map(f => {
                    if (viz.VisualizationType === 'bar' || viz.VisualizationType === 'line') {
                        // フィールドごとの値のカウント（単純な例）
                        return relatedRecords.filter(r => JSON.parse(r.FieldValues)[f.FieldID]).length;
                    }
                    if (viz.VisualizationType === 'pie') {
                        return relatedRecords.filter(r => JSON.parse(r.FieldValues)[f.FieldID]).length;
                    }
                    return 0;
                });

                // チャートタイプ
                let chartType = 'bar';
                if (viz.VisualizationType === 'line') chartType = 'line';
                if (viz.VisualizationType === 'pie') chartType = 'pie';

                // チャートデータ
                const chartData = {
                    labels: labels,
                    datasets: [{
                        label: config.title || 'ビジュアル化',
                        data: data,
                        backgroundColor: [
                            'rgba(255, 99, 132, 0.6)',
                            'rgba(54, 162, 235, 0.6)',
                            'rgba(255, 206, 86, 0.6)',
                            'rgba(75, 192, 192, 0.6)',
                            'rgba(153, 102, 255, 0.6)',
                            'rgba(255, 159, 64, 0.6)'
                        ],
                        borderColor: [
                            'rgba(255,99,132,1)',
                            'rgba(54, 162, 235, 1)',
                            'rgba(255, 206, 86, 1)',
                            'rgba(75, 192, 192, 1)',
                            'rgba(153, 102, 255, 1)',
                            'rgba(255, 159, 64, 1)'
                        ],
                        borderWidth: 1
                    }]
                };

                // チャートオプション
                const chartOptions = {
                    responsive: true,
                    plugins: {
                        title: {
                            display: !!config.title,
                            text: config.title || ''
                        }
                    }
                };

                // チャートの描画
                if (chartInstance) {
                    chartInstance.destroy();
                }
                const ctx = chartRef.current.getContext('2d');
                const newChart = new Chart(ctx, {
                    type: chartType,
                    data: chartData,
                    options: chartOptions
                });
                setChartInstance(newChart);
            };

            return (
                <div>
                    <Box display="flex" justifyContent="space-between" alignItems="center" mb={2}>
                        <Typography variant="h5">ビジュアル化一覧</Typography>
                        <Button variant="contained" color="primary" onClick={() => handleOpenDialog()}>
                            新規作成
                        </Button>
                    </Box>
                    <TableContainer component={Paper}>
                        <Table>
                            <TableHead>
                                <TableRow>
                                    <TableCell>ビジュアル化ID</TableCell>
                                    <TableCell>構造</TableCell>
                                    <TableCell>タイプ</TableCell>
                                    <TableCell>設定</TableCell>
                                    <TableCell align="right">アクション</TableCell>
                                </TableRow>
                            </TableHead>
                            <TableBody>
                                {visualizations.map((viz) => {
                                    const structure = structures.find(s => s.StructureID === viz.StructureID);
                                    return (
                                        <TableRow key={viz.VisualizationID}>
                                            <TableCell>{viz.VisualizationID}</TableCell>
                                            <TableCell>{structure ? structure.Name : 'N/A'}</TableCell>
                                            <TableCell>{viz.VisualizationType}</TableCell>
                                            <TableCell>
                                                <pre>{viz.Configuration}</pre>
                                            </TableCell>
                                            <TableCell align="right">
                                                <IconButton color="primary" onClick={() => handleOpenDialog(viz)}>
                                                    <span className="material-icons">edit</span>
                                                </IconButton>
                                                <IconButton color="error" onClick={() => handleDelete(viz.VisualizationID)}>
                                                    <span className="material-icons">delete</span>
                                                </IconButton>
                                                <Button variant="outlined" onClick={() => handleRender(viz)} sx={{ ml: 1 }}>
                                                    表示
                                                </Button>
                                            </TableCell>
                                        </TableRow>
                                    );
                                })}
                                {visualizations.length === 0 && (
                                    <TableRow>
                                        <TableCell colSpan={5} align="center">データがありません。</TableCell>
                                    </TableRow>
                                )}
                            </TableBody>
                        </Table>
                    </TableContainer>

                    {/* ダイアログ */}
                    <Dialog open={openDialog} onClose={handleCloseDialog} maxWidth="sm" fullWidth>
                        <DialogTitle>{currentViz.VisualizationID ? 'ビジュアル化を編集' : 'ビジュアル化を作成'}</DialogTitle>
                        <DialogContent>
                            <FormControl fullWidth margin="dense">
                                <InputLabel id="structure-select-label">構造</InputLabel>
                                <Select
                                    labelId="structure-select-label"
                                    value={currentViz.StructureID}
                                    label="構造"
                                    onChange={(e) => setCurrentViz({ ...currentViz, StructureID: e.target.value })}
                                    required
                                >
                                    {structures.map(s => (
                                        <MenuItem key={s.StructureID} value={s.StructureID}>{s.Name}</MenuItem>
                                    ))}
                                </Select>
                            </FormControl>
                            <FormControl fullWidth margin="dense">
                                <InputLabel id="type-select-label">タイプ</InputLabel>
                                <Select
                                    labelId="type-select-label"
                                    value={currentViz.VisualizationType}
                                    label="タイプ"
                                    onChange={(e) => setCurrentViz({ ...currentViz, VisualizationType: e.target.value })}
                                    required
                                >
                                    <MenuItem value="bar">棒グラフ</MenuItem>
                                    <MenuItem value="line">折れ線グラフ</MenuItem>
                                    <MenuItem value="pie">円グラフ</MenuItem>
                                    {/* 必要に応じて他のタイプを追加 */}
                                </Select>
                            </FormControl>
                            <TextField
                                margin="dense"
                                label="設定 (JSON)"
                                type="text"
                                fullWidth
                                variant="standard"
                                value={currentViz.Configuration}
                                onChange={(e) => setCurrentViz({ ...currentViz, Configuration: e.target.value })}
                                placeholder='例: {"title": "サンプルチャート"}'
                            />
                        </DialogContent>
                        <DialogActions>
                            <Button onClick={handleCloseDialog}>キャンセル</Button>
                            <Button onClick={handleSave} variant="contained" color="primary">保存</Button>
                        </DialogActions>
                    </Dialog>

                    {/* チャート表示エリア */}
                    <Box mt={4}>
                        <Typography variant="h6" gutterBottom>ビジュアル化結果</Typography>
                        <canvas ref={chartRef}></canvas>
                    </Box>
                </div>
            );
        }

        // サマリー管理コンポーネント
        function SummaryManager({ showMessage }) {
            const [summaries, setSummaries] = React.useState(getData('summaries'));
            const [structures, setStructures] = React.useState(getData('structures'));
            const [openDialog, setOpenDialog] = React.useState(false);
            const [currentSummary, setCurrentSummary] = React.useState({ SummaryID: null, StructureID: '', SummaryType: '', SummaryData: '{}' });

            const handleOpenDialog = (summary = { SummaryID: null, StructureID: '', SummaryType: '', SummaryData: '{}' }) => {
                setCurrentSummary(summary);
                setOpenDialog(true);
            };

            const handleCloseDialog = () => {
                setCurrentSummary({ SummaryID: null, StructureID: '', SummaryType: '', SummaryData: '{}' });
                setOpenDialog(false);
            };

            const handleSave = () => {
                if (!currentSummary.StructureID || !currentSummary.SummaryType) {
                    showMessage('必要なフィールドを入力してください。', 'error');
                    return;
                }
                // Validate SummaryData JSON
                try {
                    JSON.parse(currentSummary.SummaryData);
                } catch (e) {
                    showMessage('SummaryDataは有効なJSONでなければなりません。', 'error');
                    return;
                }

                let updatedSummaries;
                if (currentSummary.SummaryID) {
                    // 更新
                    updatedSummaries = summaries.map(s => s.SummaryID === currentSummary.SummaryID ? currentSummary : s);
                    showMessage('サマリーを更新しました。');
                } else {
                    // 作成
                    const newID = summaries.length ? Math.max(...summaries.map(s => s.SummaryID)) + 1 : 1;
                    currentSummary.SummaryID = newID;
                    updatedSummaries = [...summaries, currentSummary];
                    showMessage('サマリーを作成しました。');
                }
                setSummaries(updatedSummaries);
                setData('summaries', updatedSummaries);
                handleCloseDialog();
            };

            const handleDelete = (id) => {
                if (!window.confirm('このサマリーを削除してもよろしいですか？')) return;
                const updatedSummaries = summaries.filter(s => s.SummaryID !== id);
                setSummaries(updatedSummaries);
                setData('summaries', updatedSummaries);
                showMessage('サマリーを削除しました。', 'warning');
            };

            return (
                <div>
                    <Box display="flex" justifyContent="space-between" alignItems="center" mb={2}>
                        <Typography variant="h5">サマリー一覧</Typography>
                        <Button variant="contained" color="primary" onClick={() => handleOpenDialog()}>
                            新規作成
                        </Button>
                    </Box>
                    <TableContainer component={Paper}>
                        <Table>
                            <TableHead>
                                <TableRow>
                                    <TableCell>サマリーID</TableCell>
                                    <TableCell>構造</TableCell>
                                    <TableCell>タイプ</TableCell>
                                    <TableCell>サマリーデータ</TableCell>
                                    <TableCell align="right">アクション</TableCell>
                                </TableRow>
                            </TableHead>
                            <TableBody>
                                {summaries.map((summary) => {
                                    const structure = structures.find(s => s.StructureID === summary.StructureID);
                                    return (
                                        <TableRow key={summary.SummaryID}>
                                            <TableCell>{summary.SummaryID}</TableCell>
                                            <TableCell>{structure ? structure.Name : 'N/A'}</TableCell>
                                            <TableCell>{summary.SummaryType}</TableCell>
                                            <TableCell>
                                                <pre>{summary.SummaryData}</pre>
                                            </TableCell>
                                            <TableCell align="right">
                                                <IconButton color="primary" onClick={() => handleOpenDialog(summary)}>
                                                    <span className="material-icons">edit</span>
                                                </IconButton>
                                                <IconButton color="error" onClick={() => handleDelete(summary.SummaryID)}>
                                                    <span className="material-icons">delete</span>
                                                </IconButton>
                                            </TableCell>
                                        </TableRow>
                                    );
                                })}
                                {summaries.length === 0 && (
                                    <TableRow>
                                        <TableCell colSpan={5} align="center">データがありません。</TableCell>
                                    </TableRow>
                                )}
                            </TableBody>
                        </Table>
                    </TableContainer>

                    {/* ダイアログ */}
                    <Dialog open={openDialog} onClose={handleCloseDialog} maxWidth="sm" fullWidth>
                        <DialogTitle>{currentSummary.SummaryID ? 'サマリーを編集' : 'サマリーを作成'}</DialogTitle>
                        <DialogContent>
                            <FormControl fullWidth margin="dense">
                                <InputLabel id="structure-select-label">構造</InputLabel>
                                <Select
                                    labelId="structure-select-label"
                                    value={currentSummary.StructureID}
                                    label="構造"
                                    onChange={(e) => setCurrentSummary({ ...currentSummary, StructureID: e.target.value })}
                                    required
                                >
                                    {structures.map(s => (
                                        <MenuItem key={s.StructureID} value={s.StructureID}>{s.Name}</MenuItem>
                                    ))}
                                </Select>
                            </FormControl>
                            <FormControl fullWidth margin="dense">
                                <InputLabel id="summary-type-select-label">タイプ</InputLabel>
                                <Select
                                    labelId="summary-type-select-label"
                                    value={currentSummary.SummaryType}
                                    label="タイプ"
                                    onChange={(e) => setCurrentSummary({ ...currentSummary, SummaryType: e.target.value })}
                                    required
                                >
                                    <MenuItem value="count">カウント</MenuItem>
                                    <MenuItem value="average">平均</MenuItem>
                                    <MenuItem value="sum">合計</MenuItem>
                                    {/* 必要に応じて他のタイプを追加 */}
                                </Select>
                            </FormControl>
                            <TextField
                                margin="dense"
                                label="サマリーデータ (JSON)"
                                type="text"
                                fullWidth
                                variant="standard"
                                value={currentSummary.SummaryData}
                                onChange={(e) => setCurrentSummary({ ...currentSummary, SummaryData: e.target.value })}
                                placeholder='例: {"field": "1"}'
                            />
                        </DialogContent>
                        <DialogActions>
                            <Button onClick={handleCloseDialog}>キャンセル</Button>
                            <Button onClick={handleSave} variant="contained" color="primary">保存</Button>
                        </DialogActions>
                    </Dialog>
                </div>
            );
        }

        // メインレンダリング
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
